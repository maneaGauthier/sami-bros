<html>
<head>
<title>pefile.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
pefile.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; Tools for manipulating Portable Executable files. 
 
This can be used, for example, to extract a list of dependencies from an .exe 
or .dll file, or to add version information and an icon resource to it. &quot;&quot;&quot;</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">&quot;PEFile&quot;</span><span class="s2">]</span>

<span class="s4">from </span><span class="s1">struct </span><span class="s4">import </span><span class="s1">Struct</span><span class="s2">, </span><span class="s1">unpack</span><span class="s2">, </span><span class="s1">pack</span><span class="s2">, </span><span class="s1">pack_into</span>
<span class="s4">from </span><span class="s1">collections </span><span class="s4">import </span><span class="s1">namedtuple</span>
<span class="s4">from </span><span class="s1">array </span><span class="s4">import </span><span class="s1">array</span>
<span class="s4">import </span><span class="s1">time</span>
<span class="s4">from </span><span class="s1">io </span><span class="s4">import </span><span class="s1">BytesIO</span>
<span class="s4">import </span><span class="s1">sys</span>

<span class="s4">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">):</span>
    <span class="s1">unicode </span><span class="s2">= </span><span class="s1">str</span>
    <span class="s1">unichr </span><span class="s2">= </span><span class="s1">chr</span>

<span class="s6"># Define some internally used structures.</span>
<span class="s1">RVASize </span><span class="s2">= </span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s3">'RVASize'</span><span class="s2">, (</span><span class="s3">'addr'</span><span class="s2">, </span><span class="s3">'size'</span><span class="s2">))</span>
<span class="s1">impdirtab </span><span class="s2">= </span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s3">'impdirtab'</span><span class="s2">, (</span><span class="s3">'lookup'</span><span class="s2">, </span><span class="s3">'timdat'</span><span class="s2">, </span><span class="s3">'forward'</span><span class="s2">, </span><span class="s3">'name'</span><span class="s2">, </span><span class="s3">'impaddr'</span><span class="s2">))</span>
<span class="s1">expdirtab </span><span class="s2">= </span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s3">'expdirtab'</span><span class="s2">, (</span><span class="s3">'flags'</span><span class="s2">, </span><span class="s3">'timdat'</span><span class="s2">, </span><span class="s3">'majver'</span><span class="s2">, </span><span class="s3">'minver'</span><span class="s2">, </span><span class="s3">'name'</span><span class="s2">, </span><span class="s3">'ordinal_base'</span><span class="s2">, </span><span class="s3">'nentries'</span><span class="s2">, </span><span class="s3">'nnames'</span><span class="s2">, </span><span class="s3">'entries'</span><span class="s2">, </span><span class="s3">'names'</span><span class="s2">, </span><span class="s3">'ordinals'</span><span class="s2">))</span>


<span class="s4">def </span><span class="s1">_unpack_zstring</span><span class="s2">(</span><span class="s1">mem</span><span class="s2">, </span><span class="s1">offs</span><span class="s2">=</span><span class="s5">0</span><span class="s2">):</span>
    <span class="s0">&quot;Read a zero-terminated string from memory.&quot;</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">mem</span><span class="s2">[</span><span class="s1">offs</span><span class="s2">]</span>
    <span class="s1">str </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
    <span class="s4">while </span><span class="s1">c</span><span class="s2">:</span>
        <span class="s1">str </span><span class="s2">+= </span><span class="s1">chr</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">offs </span><span class="s2">+= </span><span class="s5">1</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">mem</span><span class="s2">[</span><span class="s1">offs</span><span class="s2">]</span>
    <span class="s4">return </span><span class="s1">str</span>

<span class="s4">def </span><span class="s1">_unpack_wstring</span><span class="s2">(</span><span class="s1">mem</span><span class="s2">, </span><span class="s1">offs</span><span class="s2">=</span><span class="s5">0</span><span class="s2">):</span>
    <span class="s0">&quot;Read a UCS-2 string from memory.&quot;</span>
    <span class="s1">name_len</span><span class="s2">, = </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;H'</span><span class="s2">, </span><span class="s1">mem</span><span class="s2">[</span><span class="s1">offs</span><span class="s2">:</span><span class="s1">offs</span><span class="s2">+</span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
    <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">name_len</span><span class="s2">):</span>
        <span class="s1">offs </span><span class="s2">+= </span><span class="s5">2</span>
        <span class="s1">name </span><span class="s2">+= </span><span class="s1">unichr</span><span class="s2">(*</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;H'</span><span class="s2">, </span><span class="s1">mem</span><span class="s2">[</span><span class="s1">offs</span><span class="s2">:</span><span class="s1">offs</span><span class="s2">+</span><span class="s5">2</span><span class="s2">]))</span>
    <span class="s4">return </span><span class="s1">name</span>

<span class="s4">def </span><span class="s1">_padded</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">boundary</span><span class="s2">):</span>
    <span class="s1">align </span><span class="s2">= </span><span class="s1">n </span><span class="s2">% </span><span class="s1">boundary</span>
    <span class="s4">if </span><span class="s1">align</span><span class="s2">:</span>
        <span class="s1">n </span><span class="s2">+= </span><span class="s1">boundary </span><span class="s2">- </span><span class="s1">align</span>
    <span class="s4">return </span><span class="s1">n</span>


<span class="s4">class </span><span class="s1">Section</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">_header </span><span class="s2">= </span><span class="s1">Struct</span><span class="s2">(</span><span class="s3">'&lt;8sIIIIIIHHI'</span><span class="s2">)</span>

    <span class="s1">modified </span><span class="s2">= </span><span class="s4">True</span>

    <span class="s4">def </span><span class="s1">read_header</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">):</span>
        <span class="s1">name</span><span class="s2">, </span><span class="s1">vsize</span><span class="s2">, </span><span class="s1">vaddr</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">scnptr</span><span class="s2">, </span><span class="s1">relptr</span><span class="s2">, </span><span class="s1">lnnoptr</span><span class="s2">, </span><span class="s1">nreloc</span><span class="s2">, </span><span class="s1">nlnno</span><span class="s2">, </span><span class="s1">flags </span><span class="s2">= </span><span class="s1">\</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_header</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">40</span><span class="s2">))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span><span class="s2">.</span><span class="s1">rstrip</span><span class="s2">(</span><span class="s7">b'</span><span class="s4">\x00</span><span class="s7">'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">vaddr </span><span class="s2">= </span><span class="s1">vaddr </span><span class="s6"># Base virtual address to map to.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">vsize </span><span class="s2">= </span><span class="s1">vsize</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">offset </span><span class="s2">= </span><span class="s1">scnptr </span><span class="s6"># Offset of the section in the file.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s1">size</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">flags </span><span class="s2">= </span><span class="s1">flags</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">modified </span><span class="s2">= </span><span class="s4">False</span>

    <span class="s4">def </span><span class="s1">write_header</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">):</span>
        <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_header</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vsize</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vaddr</span><span class="s2">,</span>
                                   <span class="s1">self</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">,</span>
                                   <span class="s1">self</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s3">&quot;&lt;section '%s' memory %x-%x&gt;&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vaddr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vaddr </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vsize</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__gt__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vaddr </span><span class="s2">&gt; </span><span class="s1">other</span><span class="s2">.</span><span class="s1">vaddr</span>

    <span class="s4">def </span><span class="s1">__lt__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vaddr </span><span class="s2">&lt; </span><span class="s1">other</span><span class="s2">.</span><span class="s1">vaddr</span>


<span class="s4">class </span><span class="s1">DataResource</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">&quot;&quot;&quot; A resource entry in the resource table. &quot;&quot;&quot;</span>

    <span class="s6"># Resource types.</span>
    <span class="s1">cursor </span><span class="s2">= </span><span class="s5">1</span>
    <span class="s1">bitmap </span><span class="s2">= </span><span class="s5">2</span>
    <span class="s1">icon </span><span class="s2">= </span><span class="s5">3</span>
    <span class="s1">menu </span><span class="s2">= </span><span class="s5">4</span>
    <span class="s1">dialog </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">string </span><span class="s2">= </span><span class="s5">6</span>
    <span class="s1">font_directory </span><span class="s2">= </span><span class="s5">7</span>
    <span class="s1">font </span><span class="s2">= </span><span class="s5">8</span>
    <span class="s1">accelerator </span><span class="s2">= </span><span class="s5">9</span>
    <span class="s1">rcdata </span><span class="s2">= </span><span class="s5">10</span>
    <span class="s1">message_table </span><span class="s2">= </span><span class="s5">11</span>
    <span class="s1">cursor_group </span><span class="s2">= </span><span class="s5">12</span>
    <span class="s1">icon_group </span><span class="s2">= </span><span class="s5">14</span>
    <span class="s1">version </span><span class="s2">= </span><span class="s5">16</span>
    <span class="s1">dlg_include </span><span class="s2">= </span><span class="s5">17</span>
    <span class="s1">plug_play </span><span class="s2">= </span><span class="s5">19</span>
    <span class="s1">vxd </span><span class="s2">= </span><span class="s5">20</span>
    <span class="s1">animated_cursor </span><span class="s2">= </span><span class="s5">21</span>
    <span class="s1">animated_icon </span><span class="s2">= </span><span class="s5">22</span>
    <span class="s1">html </span><span class="s2">= </span><span class="s5">23</span>
    <span class="s1">manifest </span><span class="s2">= </span><span class="s5">24</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_ident </span><span class="s2">= ()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">code_page </span><span class="s2">= </span><span class="s5">0</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s4">def </span><span class="s1">encoding</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_page </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s3">'ascii'</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s3">'cp%d' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_page</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">get_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>

    <span class="s4">def </span><span class="s1">get_text</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s3">'strict'</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">encoding</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">IconGroupResource</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">code_page </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">type </span><span class="s2">= </span><span class="s5">14</span>
    <span class="s1">_entry </span><span class="s2">= </span><span class="s1">Struct</span><span class="s2">(</span><span class="s3">'&lt;BBBxHHIH'</span><span class="s2">)</span>
    <span class="s1">Icon </span><span class="s2">= </span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s3">'Icon'</span><span class="s2">, (</span><span class="s3">'width'</span><span class="s2">, </span><span class="s3">'height'</span><span class="s2">, </span><span class="s3">'planes'</span><span class="s2">, </span><span class="s3">'bpp'</span><span class="s2">, </span><span class="s3">'size'</span><span class="s2">, </span><span class="s3">'id'</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">icons </span><span class="s2">= []</span>

    <span class="s4">def </span><span class="s1">add_icon</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">icons</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">Icon</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">get_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;HHH'</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">icons</span><span class="s2">)))</span>

        <span class="s4">for </span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">, </span><span class="s1">planes</span><span class="s2">, </span><span class="s1">bpp</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">id </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">icons</span><span class="s2">:</span>
            <span class="s1">colors </span><span class="s2">= </span><span class="s5">1 </span><span class="s2">&lt;&lt; (</span><span class="s1">planes </span><span class="s2">* </span><span class="s1">bpp</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">colors </span><span class="s2">&gt;= </span><span class="s5">256</span><span class="s2">:</span>
                <span class="s1">colors </span><span class="s2">= </span><span class="s5">0</span>
            <span class="s4">if </span><span class="s1">width </span><span class="s2">&gt;= </span><span class="s5">256</span><span class="s2">:</span>
                <span class="s1">width </span><span class="s2">= </span><span class="s5">0</span>
            <span class="s4">if </span><span class="s1">height </span><span class="s2">&gt;= </span><span class="s5">256</span><span class="s2">:</span>
                <span class="s1">height </span><span class="s2">= </span><span class="s5">0</span>
            <span class="s1">data </span><span class="s2">+= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_entry</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">, </span><span class="s1">colors</span><span class="s2">, </span><span class="s1">planes</span><span class="s2">, </span><span class="s1">bpp</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">id</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">data</span>

    <span class="s4">def </span><span class="s1">unpack_from</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">offs</span><span class="s2">=</span><span class="s5">0</span><span class="s2">):</span>
        <span class="s1">type</span><span class="s2">, </span><span class="s1">count </span><span class="s2">= </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;HH'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[</span><span class="s1">offs</span><span class="s2">+</span><span class="s5">2</span><span class="s2">:</span><span class="s1">offs</span><span class="s2">+</span><span class="s5">6</span><span class="s2">])</span>
        <span class="s1">offs </span><span class="s2">+= </span><span class="s5">6</span>
        <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">count</span><span class="s2">):</span>
            <span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">, </span><span class="s1">colors</span><span class="s2">, </span><span class="s1">planes</span><span class="s2">, </span><span class="s1">bpp</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">id </span><span class="s2">= </span><span class="s1">\</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_entry</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s1">offs</span><span class="s2">:</span><span class="s1">offs</span><span class="s2">+</span><span class="s5">14</span><span class="s2">])</span>
            <span class="s4">if </span><span class="s1">width </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s1">width </span><span class="s2">= </span><span class="s5">256</span>
            <span class="s4">if </span><span class="s1">height </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s1">height </span><span class="s2">= </span><span class="s5">256</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">icons</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">Icon</span><span class="s2">(</span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">, </span><span class="s1">planes</span><span class="s2">, </span><span class="s1">bpp</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">id</span><span class="s2">))</span>
            <span class="s1">offs </span><span class="s2">+= </span><span class="s5">14</span>


<span class="s4">class </span><span class="s1">VersionInfoResource</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">code_page </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">type </span><span class="s2">= </span><span class="s5">16</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">string_info </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">var_info </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">signature </span><span class="s2">= </span><span class="s5">0xFEEF04BD</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">struct_version </span><span class="s2">= </span><span class="s5">0x10000</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">file_version </span><span class="s2">= (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">product_version </span><span class="s2">= (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">file_flags_mask </span><span class="s2">= </span><span class="s5">0x3f</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">file_flags </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">file_os </span><span class="s2">= </span><span class="s5">0x40004 </span><span class="s6"># Windows NT</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">file_type </span><span class="s2">= </span><span class="s5">1 </span><span class="s6"># Application</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">file_subtype </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">file_date </span><span class="s2">= (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">get_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># The first part of the header is pretty much fixed - we'll go</span>
        <span class="s6"># back later to write the struct size.</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s7">b'</span><span class="s4">\x00\x00</span><span class="s7">4</span><span class="s4">\x00\x00\x00</span><span class="s7">V</span><span class="s4">\x00</span><span class="s7">S</span><span class="s4">\x00</span><span class="s7">_</span><span class="s4">\x00</span><span class="s7">V</span><span class="s4">\x00</span><span class="s7">E</span><span class="s4">\x00</span><span class="s7">R</span><span class="s4">\x00</span><span class="s7">S</span><span class="s4">\x00</span><span class="s7">I</span><span class="s4">\x00</span><span class="s7">O</span><span class="s4">\x00</span><span class="s7">N</span><span class="s4">\x00</span><span class="s7">_</span><span class="s4">\x00</span><span class="s7">I</span><span class="s4">\x00</span><span class="s7">N</span><span class="s4">\x00</span><span class="s7">F</span><span class="s4">\x00</span><span class="s7">O</span><span class="s4">\x00\x00\x00\x00\x00</span><span class="s7">'</span><span class="s2">)</span>
        <span class="s1">data </span><span class="s2">+= </span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;13I'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">signature</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">struct_version</span><span class="s2">,</span>
                             <span class="s1">self</span><span class="s2">.</span><span class="s1">file_version</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] | (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_version</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] &lt;&lt; </span><span class="s5">16</span><span class="s2">),</span>
                             <span class="s1">self</span><span class="s2">.</span><span class="s1">file_version</span><span class="s2">[</span><span class="s5">3</span><span class="s2">] | (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_version</span><span class="s2">[</span><span class="s5">2</span><span class="s2">] &lt;&lt; </span><span class="s5">16</span><span class="s2">),</span>
                             <span class="s1">self</span><span class="s2">.</span><span class="s1">product_version</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] | (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">product_version</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] &lt;&lt; </span><span class="s5">16</span><span class="s2">),</span>
                             <span class="s1">self</span><span class="s2">.</span><span class="s1">product_version</span><span class="s2">[</span><span class="s5">3</span><span class="s2">] | (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">product_version</span><span class="s2">[</span><span class="s5">2</span><span class="s2">] &lt;&lt; </span><span class="s5">16</span><span class="s2">),</span>
                             <span class="s1">self</span><span class="s2">.</span><span class="s1">file_flags_mask</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_flags</span><span class="s2">,</span>
                             <span class="s1">self</span><span class="s2">.</span><span class="s1">file_os</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_type</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_subtype</span><span class="s2">,</span>
                             <span class="s1">self</span><span class="s2">.</span><span class="s1">file_date</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_date</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_pack_info</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s3">'StringFileInfo'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">string_info</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_pack_info</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s3">'VarFileInfo'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">var_info</span><span class="s2">)</span>
        <span class="s1">data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">:</span><span class="s5">2</span><span class="s2">] = </span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;H'</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">))</span>
        <span class="s4">return </span><span class="s1">data</span>

    <span class="s4">def </span><span class="s1">_pack_info</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">):</span>
            <span class="s1">type </span><span class="s2">= </span><span class="s5">1</span>
            <span class="s1">value_length </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s4">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">) </span><span class="s4">or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">unicode</span><span class="s2">):</span>
            <span class="s1">type </span><span class="s2">= </span><span class="s5">1</span>
            <span class="s1">value_length </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) * </span><span class="s5">2 </span><span class="s2">+ </span><span class="s5">2</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">type </span><span class="s2">= </span><span class="s5">0</span>
            <span class="s1">value_length </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

        <span class="s1">data </span><span class="s2">+= </span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;HHH'</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">value_length</span><span class="s2">, </span><span class="s1">type</span><span class="s2">)</span>

        <span class="s4">for </span><span class="s1">c </span><span class="s4">in </span><span class="s1">key</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">+= </span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;H'</span><span class="s2">, </span><span class="s1">ord</span><span class="s2">(</span><span class="s1">c</span><span class="s2">))</span>
        <span class="s1">data </span><span class="s2">+= </span><span class="s7">b'</span><span class="s4">\x00\x00</span><span class="s7">'</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) &amp; </span><span class="s5">2</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">+= </span><span class="s7">b'</span><span class="s4">\x00\x00</span><span class="s7">'</span>
        <span class="s4">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) &amp; </span><span class="s5">3 </span><span class="s2">== </span><span class="s5">0</span>

        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">):</span>
            <span class="s4">for </span><span class="s1">key2</span><span class="s2">, </span><span class="s1">value2 </span><span class="s4">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">items</span><span class="s2">(), </span><span class="s1">key</span><span class="s2">=</span><span class="s4">lambda </span><span class="s1">x</span><span class="s2">:</span><span class="s1">x</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_pack_info</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">key2</span><span class="s2">, </span><span class="s1">value2</span><span class="s2">)</span>
        <span class="s4">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">) </span><span class="s4">or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">unicode</span><span class="s2">):</span>
            <span class="s4">for </span><span class="s1">c </span><span class="s4">in </span><span class="s1">value</span><span class="s2">:</span>
                <span class="s1">data </span><span class="s2">+= </span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;H'</span><span class="s2">, </span><span class="s1">ord</span><span class="s2">(</span><span class="s1">c</span><span class="s2">))</span>
            <span class="s1">data </span><span class="s2">+= </span><span class="s7">b'</span><span class="s4">\x00\x00</span><span class="s7">'</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">+= </span><span class="s1">value</span>
            <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) &amp; </span><span class="s5">1</span><span class="s2">:</span>
                <span class="s1">data </span><span class="s2">+= </span><span class="s7">b'</span><span class="s4">\x00</span><span class="s7">'</span>

        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) &amp; </span><span class="s5">2</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">+= </span><span class="s7">b'</span><span class="s4">\x00\x00</span><span class="s7">'</span>
        <span class="s4">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) &amp; </span><span class="s5">3 </span><span class="s2">== </span><span class="s5">0</span>

        <span class="s1">data</span><span class="s2">[</span><span class="s1">offset</span><span class="s2">:</span><span class="s1">offset</span><span class="s2">+</span><span class="s5">2</span><span class="s2">] = </span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;H'</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) - </span><span class="s1">offset</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">unpack_from</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s1">length</span><span class="s2">, </span><span class="s1">value_length </span><span class="s2">= </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;HH'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">:</span><span class="s5">4</span><span class="s2">])</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s5">40 </span><span class="s2">+ </span><span class="s1">value_length </span><span class="s2">+ (</span><span class="s1">value_length </span><span class="s2">&amp; </span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">dwords </span><span class="s2">= </span><span class="s1">array</span><span class="s2">(</span><span class="s3">'I'</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">):</span>
            <span class="s1">dwords</span><span class="s2">.</span><span class="s1">frombytes</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s5">40</span><span class="s2">:</span><span class="s1">offset</span><span class="s2">]))</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">dwords</span><span class="s2">.</span><span class="s1">fromstring</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s5">40</span><span class="s2">:</span><span class="s1">offset</span><span class="s2">]))</span>

        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">) &gt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">signature </span><span class="s2">= </span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">) &gt; </span><span class="s5">1</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">struct_version </span><span class="s2">= </span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">) &gt; </span><span class="s5">3</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">file_version </span><span class="s2">= </span><span class="s1">\</span>
               <span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">2</span><span class="s2">] &gt;&gt; </span><span class="s5">16</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">2</span><span class="s2">] &amp; </span><span class="s5">0xffff</span><span class="s2">),</span>
                <span class="s1">int</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">3</span><span class="s2">] &gt;&gt; </span><span class="s5">16</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">3</span><span class="s2">] &amp; </span><span class="s5">0xffff</span><span class="s2">))</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">) &gt; </span><span class="s5">5</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">product_version </span><span class="s2">= </span><span class="s1">\</span>
               <span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">4</span><span class="s2">] &gt;&gt; </span><span class="s5">16</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">4</span><span class="s2">] &amp; </span><span class="s5">0xffff</span><span class="s2">),</span>
                <span class="s1">int</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">5</span><span class="s2">] &gt;&gt; </span><span class="s5">16</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">5</span><span class="s2">] &amp; </span><span class="s5">0xffff</span><span class="s2">))</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">) &gt; </span><span class="s5">7</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">file_flags_mask </span><span class="s2">= </span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">6</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">file_flags </span><span class="s2">= </span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">7</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">) &gt; </span><span class="s5">8</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">file_os </span><span class="s2">= </span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">8</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">) &gt; </span><span class="s5">9</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">file_type </span><span class="s2">= </span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">9</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">) &gt; </span><span class="s5">10</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">file_subtype </span><span class="s2">= </span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">10</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dwords</span><span class="s2">) &gt; </span><span class="s5">12</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">file_date </span><span class="s2">= (</span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">11</span><span class="s2">], </span><span class="s1">dwords</span><span class="s2">[</span><span class="s5">12</span><span class="s2">])</span>

        <span class="s4">while </span><span class="s1">offset </span><span class="s2">&lt; </span><span class="s1">length</span><span class="s2">:</span>
            <span class="s1">offset </span><span class="s2">+= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_unpack_info</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'StringFileInfo'</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">string_info</span>
        <span class="s4">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'VarFileInfo'</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">var_info</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">KeyError</span><span class="s2">(</span><span class="s3">&quot;%s does not exist&quot; </span><span class="s2">% (</span><span class="s1">key</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">__contains__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">key </span><span class="s4">in </span><span class="s2">(</span><span class="s3">'StringFileInfo'</span><span class="s2">, </span><span class="s3">'VarFileInfo'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_unpack_info</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">):</span>
        <span class="s1">length</span><span class="s2">, </span><span class="s1">value_length</span><span class="s2">, </span><span class="s1">type </span><span class="s2">= </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;HHH'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[</span><span class="s1">offset</span><span class="s2">:</span><span class="s1">offset</span><span class="s2">+</span><span class="s5">6</span><span class="s2">])</span>
        <span class="s4">assert </span><span class="s1">length </span><span class="s2">&gt; </span><span class="s5">0</span>
        <span class="s1">end </span><span class="s2">= </span><span class="s1">offset </span><span class="s2">+ </span><span class="s1">length</span>
        <span class="s1">offset </span><span class="s2">+= </span><span class="s5">6</span>
        <span class="s1">key </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
        <span class="s1">c</span><span class="s2">, = </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;H'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[</span><span class="s1">offset</span><span class="s2">:</span><span class="s1">offset</span><span class="s2">+</span><span class="s5">2</span><span class="s2">])</span>
        <span class="s1">offset </span><span class="s2">+= </span><span class="s5">2</span>
        <span class="s4">while </span><span class="s1">c</span><span class="s2">:</span>
            <span class="s1">key </span><span class="s2">+= </span><span class="s1">unichr</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>
            <span class="s1">c</span><span class="s2">, = </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;H'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[</span><span class="s1">offset</span><span class="s2">:</span><span class="s1">offset</span><span class="s2">+</span><span class="s5">2</span><span class="s2">])</span>
            <span class="s1">offset </span><span class="s2">+= </span><span class="s5">2</span>

        <span class="s6"># Padding bytes to align value to 32-bit boundary.</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s1">_padded</span><span class="s2">(</span><span class="s1">offset</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">value_length </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s6"># It contains a value.</span>
            <span class="s4">if </span><span class="s1">type</span><span class="s2">:</span>
                <span class="s6"># It's a wchar array value.</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s3">u&quot;&quot;</span>
                <span class="s1">c</span><span class="s2">, = </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;H'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[</span><span class="s1">offset</span><span class="s2">:</span><span class="s1">offset</span><span class="s2">+</span><span class="s5">2</span><span class="s2">])</span>
                <span class="s1">offset </span><span class="s2">+= </span><span class="s5">2</span>
                <span class="s4">while </span><span class="s1">c</span><span class="s2">:</span>
                    <span class="s1">value </span><span class="s2">+= </span><span class="s1">unichr</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>
                    <span class="s1">c</span><span class="s2">, = </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;H'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[</span><span class="s1">offset</span><span class="s2">:</span><span class="s1">offset</span><span class="s2">+</span><span class="s5">2</span><span class="s2">])</span>
                    <span class="s1">offset </span><span class="s2">+= </span><span class="s5">2</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s6"># A binary value.</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s1">offset</span><span class="s2">:</span><span class="s1">offset</span><span class="s2">+</span><span class="s1">value_length</span><span class="s2">])</span>
                <span class="s1">offset </span><span class="s2">+= </span><span class="s1">value_length</span>
            <span class="s1">dict</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">value</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s6"># It contains sub-entries.</span>
            <span class="s4">if </span><span class="s1">key </span><span class="s4">not in </span><span class="s1">dict</span><span class="s2">:</span>
                <span class="s1">dict</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = {}</span>
            <span class="s1">subdict </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>
            <span class="s4">while </span><span class="s1">offset </span><span class="s2">&lt; </span><span class="s1">end</span><span class="s2">:</span>
                <span class="s1">offset </span><span class="s2">+= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_unpack_info</span><span class="s2">(</span><span class="s1">subdict</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>

        <span class="s6"># Padding bytes to pad value to 32-bit boundary.</span>
        <span class="s4">return </span><span class="s1">_padded</span><span class="s2">(</span><span class="s1">length</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">ResourceTable</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">&quot;&quot;&quot; A table in the resource directory. &quot;&quot;&quot;</span>

    <span class="s1">_header </span><span class="s2">= </span><span class="s1">Struct</span><span class="s2">(</span><span class="s3">'&lt;IIHHHH'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ident</span><span class="s2">=()):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">flags </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">timdat </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_name_leaves </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_id_leaves </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_ident </span><span class="s2">= </span><span class="s1">ident</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_strings_size </span><span class="s2">= </span><span class="s5">0 </span><span class="s6"># Amount of space occupied by table keys.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_descs_size </span><span class="s2">= </span><span class="s5">0</span>

    <span class="s4">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">int</span><span class="s2">):</span>
            <span class="s1">leaves </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id_leaves</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">leaves </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_name_leaves</span>

        <span class="s1">i </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s4">while </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">leaves</span><span class="s2">):</span>
            <span class="s1">idname</span><span class="s2">, </span><span class="s1">leaf </span><span class="s2">= </span><span class="s1">leaves</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s4">if </span><span class="s1">idname </span><span class="s2">&gt;= </span><span class="s1">key</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">key </span><span class="s2">== </span><span class="s1">idname</span><span class="s2">:</span>
                    <span class="s4">return </span><span class="s1">leaf</span>
                <span class="s4">break</span>
            <span class="s1">i </span><span class="s2">+= </span><span class="s5">1</span>
        <span class="s4">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">int</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_strings_size </span><span class="s2">+= </span><span class="s1">_padded</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">key</span><span class="s2">) * </span><span class="s5">2 </span><span class="s2">+ </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
        <span class="s1">leaf </span><span class="s2">= </span><span class="s1">ResourceTable</span><span class="s2">(</span><span class="s1">ident</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ident </span><span class="s2">+ (</span><span class="s1">key</span><span class="s2">,))</span>
        <span class="s1">leaves</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, (</span><span class="s1">key</span><span class="s2">, </span><span class="s1">leaf</span><span class="s2">))</span>
        <span class="s4">return </span><span class="s1">leaf</span>

    <span class="s4">def </span><span class="s1">__setitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Adds the given item to the table.  Maintains sort order. &quot;&quot;&quot;</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">int</span><span class="s2">):</span>
            <span class="s1">leaves </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id_leaves</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">leaves </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_name_leaves</span>

        <span class="s4">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ResourceTable</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_descs_size </span><span class="s2">+= </span><span class="s5">16</span>

        <span class="s1">value</span><span class="s2">.</span><span class="s1">_ident </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ident </span><span class="s2">+ (</span><span class="s1">key</span><span class="s2">,)</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s4">while </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">leaves</span><span class="s2">):</span>
            <span class="s1">idname</span><span class="s2">, </span><span class="s1">leaf </span><span class="s2">= </span><span class="s1">leaves</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s4">if </span><span class="s1">idname </span><span class="s2">&gt;= </span><span class="s1">key</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">key </span><span class="s2">== </span><span class="s1">idname</span><span class="s2">:</span>
                    <span class="s4">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">leaves</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s5">1</span><span class="s2">], </span><span class="s1">ResourceTable</span><span class="s2">):</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">_descs_size </span><span class="s2">-= </span><span class="s5">16</span>
                    <span class="s1">leaves</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = (</span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>
                    <span class="s4">return</span>
                <span class="s4">break</span>
            <span class="s1">i </span><span class="s2">+= </span><span class="s5">1</span>
        <span class="s4">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">int</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_strings_size </span><span class="s2">+= </span><span class="s1">_padded</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">key</span><span class="s2">) * </span><span class="s5">2 </span><span class="s2">+ </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
        <span class="s1">leaves</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, (</span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">__len__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_name_leaves</span><span class="s2">) + </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id_leaves</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__iter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">keys </span><span class="s2">= []</span>
        <span class="s4">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">leaf </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_name_leaves</span><span class="s2">:</span>
            <span class="s1">keys</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s4">for </span><span class="s1">id</span><span class="s2">, </span><span class="s1">leaf </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id_leaves</span><span class="s2">:</span>
            <span class="s1">keys</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">id</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">iter</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">items</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_name_leaves </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id_leaves</span>

    <span class="s4">def </span><span class="s1">count_resources</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot;Counts all of the resources.&quot;&quot;&quot;</span>
        <span class="s1">count </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s4">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">leaf </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_name_leaves </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id_leaves</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">leaf</span><span class="s2">, </span><span class="s1">ResourceTable</span><span class="s2">):</span>
                <span class="s1">count </span><span class="s2">+= </span><span class="s1">leaf</span><span class="s2">.</span><span class="s1">count_resources</span><span class="s2">()</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">count </span><span class="s2">+= </span><span class="s5">1</span>
        <span class="s4">return </span><span class="s1">count</span>

    <span class="s4">def </span><span class="s1">get_nested_tables</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot;Returns all tables in this table and subtables.&quot;&quot;&quot;</span>
        <span class="s6"># First we yield child tables, then nested tables.  This is the</span>
        <span class="s6"># order in which pack_into assumes the tables will be written.</span>
        <span class="s4">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">leaf </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_name_leaves </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id_leaves</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">leaf</span><span class="s2">, </span><span class="s1">ResourceTable</span><span class="s2">):</span>
                <span class="s4">yield </span><span class="s1">leaf</span>

        <span class="s4">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">leaf </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_name_leaves </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id_leaves</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">leaf</span><span class="s2">, </span><span class="s1">ResourceTable</span><span class="s2">):</span>
                <span class="s4">for </span><span class="s1">table </span><span class="s4">in </span><span class="s1">leaf</span><span class="s2">.</span><span class="s1">get_nested_tables</span><span class="s2">():</span>
                    <span class="s4">yield </span><span class="s1">table</span>

    <span class="s4">def </span><span class="s1">pack_header</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">offs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_header</span><span class="s2">.</span><span class="s1">pack_into</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offs</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">timdat</span><span class="s2">,</span>
                               <span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">[</span><span class="s5">1</span><span class="s2">],</span>
                               <span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_name_leaves</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id_leaves</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">unpack_from</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">mem</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">offs</span><span class="s2">=</span><span class="s5">0</span><span class="s2">):</span>
        <span class="s1">start </span><span class="s2">= </span><span class="s1">addr </span><span class="s2">+ </span><span class="s1">offs</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">timdat</span><span class="s2">, </span><span class="s1">majver</span><span class="s2">, </span><span class="s1">minver</span><span class="s2">, </span><span class="s1">nnames</span><span class="s2">, </span><span class="s1">nids </span><span class="s2">= </span><span class="s1">\</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_header</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s1">mem</span><span class="s2">[</span><span class="s1">start</span><span class="s2">:</span><span class="s1">start</span><span class="s2">+</span><span class="s5">16</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= (</span><span class="s1">majver</span><span class="s2">, </span><span class="s1">minver</span><span class="s2">)</span>
        <span class="s1">start </span><span class="s2">+= </span><span class="s5">16</span>

        <span class="s6"># Subtables/entries specified by string name.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_name_leaves </span><span class="s2">= []</span>
        <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">nnames</span><span class="s2">):</span>
            <span class="s1">name_p</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;II'</span><span class="s2">, </span><span class="s1">mem</span><span class="s2">[</span><span class="s1">start</span><span class="s2">:</span><span class="s1">start</span><span class="s2">+</span><span class="s5">8</span><span class="s2">])</span>
            <span class="s4">if </span><span class="s1">name_p </span><span class="s2">&amp; </span><span class="s5">0x80000000</span><span class="s2">:</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">_unpack_wstring</span><span class="s2">(</span><span class="s1">mem</span><span class="s2">, </span><span class="s1">addr </span><span class="s2">+ (</span><span class="s1">name_p </span><span class="s2">&amp; </span><span class="s5">0x7fffffff</span><span class="s2">))</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s6"># Not sure what to do with this; I don't have a file with this.</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">name_p</span><span class="s2">)</span>

            <span class="s4">if </span><span class="s1">data </span><span class="s2">&amp; </span><span class="s5">0x80000000</span><span class="s2">:</span>
                <span class="s1">entry </span><span class="s2">= </span><span class="s1">ResourceTable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ident </span><span class="s2">+ (</span><span class="s1">name</span><span class="s2">,))</span>
                <span class="s1">entry</span><span class="s2">.</span><span class="s1">unpack_from</span><span class="s2">(</span><span class="s1">mem</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">, </span><span class="s1">data </span><span class="s2">&amp; </span><span class="s5">0x7fffffff</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">entry </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_unpack_data_entry</span><span class="s2">(</span><span class="s1">mem</span><span class="s2">, </span><span class="s1">addr </span><span class="s2">+ </span><span class="s1">data</span><span class="s2">, </span><span class="s1">ident</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ident</span><span class="s2">+(</span><span class="s1">name</span><span class="s2">,))</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_descs_size </span><span class="s2">+= </span><span class="s5">16</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_name_leaves</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">name</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_strings_size </span><span class="s2">+= </span><span class="s1">_padded</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">name</span><span class="s2">) * </span><span class="s5">2 </span><span class="s2">+ </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
            <span class="s1">start </span><span class="s2">+= </span><span class="s5">8</span>

        <span class="s6"># Subtables/entries specified by integer ID.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_id_leaves </span><span class="s2">= []</span>
        <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">nids</span><span class="s2">):</span>
            <span class="s1">id</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;II'</span><span class="s2">, </span><span class="s1">mem</span><span class="s2">[</span><span class="s1">start</span><span class="s2">:</span><span class="s1">start</span><span class="s2">+</span><span class="s5">8</span><span class="s2">])</span>
            <span class="s4">if </span><span class="s1">data </span><span class="s2">&amp; </span><span class="s5">0x80000000</span><span class="s2">:</span>
                <span class="s1">entry </span><span class="s2">= </span><span class="s1">ResourceTable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ident </span><span class="s2">+ (</span><span class="s1">id</span><span class="s2">,))</span>
                <span class="s1">entry</span><span class="s2">.</span><span class="s1">unpack_from</span><span class="s2">(</span><span class="s1">mem</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">, </span><span class="s1">data </span><span class="s2">&amp; </span><span class="s5">0x7fffffff</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">entry </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_unpack_data_entry</span><span class="s2">(</span><span class="s1">mem</span><span class="s2">, </span><span class="s1">addr </span><span class="s2">+ </span><span class="s1">data</span><span class="s2">, </span><span class="s1">ident</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ident</span><span class="s2">+(</span><span class="s1">id</span><span class="s2">,))</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_descs_size </span><span class="s2">+= </span><span class="s5">16</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_id_leaves</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">id</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">))</span>
            <span class="s1">start </span><span class="s2">+= </span><span class="s5">8</span>

    <span class="s4">def </span><span class="s1">_unpack_data_entry</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">mem</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">, </span><span class="s1">ident</span><span class="s2">):</span>
        <span class="s1">rva</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">code_page </span><span class="s2">= </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;III'</span><span class="s2">, </span><span class="s1">mem</span><span class="s2">[</span><span class="s1">addr</span><span class="s2">:</span><span class="s1">addr</span><span class="s2">+</span><span class="s5">12</span><span class="s2">])</span>
        <span class="s1">type</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">lang </span><span class="s2">= </span><span class="s1">ident</span>
        <span class="s6">#print(&quot;%s/%s/%s: %s [%s]&quot; % (type, name, lang, size, code_page))</span>

        <span class="s1">data </span><span class="s2">= </span><span class="s1">mem</span><span class="s2">[</span><span class="s1">rva</span><span class="s2">:</span><span class="s1">rva</span><span class="s2">+</span><span class="s1">size</span><span class="s2">]</span>

        <span class="s4">if </span><span class="s1">type </span><span class="s2">== </span><span class="s1">VersionInfoResource</span><span class="s2">.</span><span class="s1">type</span><span class="s2">:</span>
            <span class="s1">entry </span><span class="s2">= </span><span class="s1">VersionInfoResource</span><span class="s2">()</span>
            <span class="s1">entry</span><span class="s2">.</span><span class="s1">unpack_from</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s4">elif </span><span class="s1">type </span><span class="s2">== </span><span class="s1">IconGroupResource</span><span class="s2">.</span><span class="s1">type</span><span class="s2">:</span>
            <span class="s1">entry </span><span class="s2">= </span><span class="s1">IconGroupResource</span><span class="s2">()</span>
            <span class="s1">entry</span><span class="s2">.</span><span class="s1">unpack_from</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">entry </span><span class="s2">= </span><span class="s1">DataResource</span><span class="s2">()</span>
            <span class="s1">entry</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">data</span>
            <span class="s1">entry</span><span class="s2">.</span><span class="s1">code_page </span><span class="s2">= </span><span class="s1">code_page</span>


<span class="s4">class </span><span class="s1">PEFile</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>

    <span class="s1">imports </span><span class="s2">= ()</span>

    <span class="s4">def </span><span class="s1">open</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s3">'r'</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s3">'b' </span><span class="s4">not in </span><span class="s1">mode</span><span class="s2">:</span>
            <span class="s1">mode </span><span class="s2">+= </span><span class="s3">'b'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fp </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fp</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">close</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fp</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Reads a PE file from the given file object, which must be opened 
        in binary mode. &quot;&quot;&quot;</span>

        <span class="s6"># Read position of header.</span>
        <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s5">0x3c</span><span class="s2">)</span>
        <span class="s1">offset</span><span class="s2">, = </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;I'</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">4</span><span class="s2">))</span>

        <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">4</span><span class="s2">) != </span><span class="s7">b'PE</span><span class="s4">\0\0</span><span class="s7">'</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;Invalid PE file.&quot;</span><span class="s2">)</span>

        <span class="s6"># Read the COFF header.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">, </span><span class="s1">nscns</span><span class="s2">, </span><span class="s1">timdat</span><span class="s2">, </span><span class="s1">symptr</span><span class="s2">, </span><span class="s1">nsyms</span><span class="s2">, </span><span class="s1">opthdr</span><span class="s2">, </span><span class="s1">flags </span><span class="s2">= </span><span class="s1">\</span>
            <span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;HHIIIHH'</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">20</span><span class="s2">))</span>

        <span class="s4">if </span><span class="s1">nscns </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;No sections found.&quot;</span><span class="s2">)</span>

        <span class="s4">if not </span><span class="s1">opthdr</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;No opthdr found.&quot;</span><span class="s2">)</span>

        <span class="s6"># Read part of the opthdr.</span>
        <span class="s1">magic</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_size</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">initialized_size</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">uninitialized_size </span><span class="s2">= </span><span class="s1">\</span>
            <span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;HxxIII'</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">16</span><span class="s2">))</span>

        <span class="s6"># Read alignments.</span>
        <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s5">16</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">section_alignment</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_alignment </span><span class="s2">= </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;II'</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">8</span><span class="s2">))</span>

        <span class="s6"># Read header/image sizes.</span>
        <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s5">16</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">image_size</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">header_size </span><span class="s2">= </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;II'</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">8</span><span class="s2">))</span>

        <span class="s4">if </span><span class="s1">magic </span><span class="s2">== </span><span class="s5">0x010b</span><span class="s2">: </span><span class="s6"># 32-bit.</span>
            <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s5">28</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
        <span class="s4">elif </span><span class="s1">magic </span><span class="s2">== </span><span class="s5">0x20B</span><span class="s2">: </span><span class="s6"># 64-bit.</span>
            <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s5">44</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;unknown type 0x%x&quot; </span><span class="s2">% (</span><span class="s1">magic</span><span class="s2">))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">rva_offset </span><span class="s2">= </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">()</span>
        <span class="s1">numrvas</span><span class="s2">, = </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;I'</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">4</span><span class="s2">))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">exp_rva </span><span class="s2">= </span><span class="s1">RVASize</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">imp_rva </span><span class="s2">= </span><span class="s1">RVASize</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">res_rva </span><span class="s2">= </span><span class="s1">RVASize</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>

        <span class="s6"># Locate the relevant tables in memory.</span>
        <span class="s4">if </span><span class="s1">numrvas </span><span class="s2">&gt;= </span><span class="s5">1</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">exp_rva </span><span class="s2">= </span><span class="s1">RVASize</span><span class="s2">(*</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;II'</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">8</span><span class="s2">)))</span>
        <span class="s4">if </span><span class="s1">numrvas </span><span class="s2">&gt;= </span><span class="s5">2</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">imp_rva </span><span class="s2">= </span><span class="s1">RVASize</span><span class="s2">(*</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;II'</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">8</span><span class="s2">)))</span>
        <span class="s4">if </span><span class="s1">numrvas </span><span class="s2">&gt;= </span><span class="s5">3</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">res_rva </span><span class="s2">= </span><span class="s1">RVASize</span><span class="s2">(*</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;II'</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">8</span><span class="s2">)))</span>

        <span class="s6"># Skip the rest of the tables.</span>
        <span class="s4">if </span><span class="s1">numrvas </span><span class="s2">&gt;= </span><span class="s5">4</span><span class="s2">:</span>
            <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">((</span><span class="s1">numrvas </span><span class="s2">- </span><span class="s5">3</span><span class="s2">) * </span><span class="s5">8</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>

        <span class="s6"># Loop through the sections to find the ones containing our tables.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sections </span><span class="s2">= []</span>
        <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">nscns</span><span class="s2">):</span>
            <span class="s1">section </span><span class="s2">= </span><span class="s1">Section</span><span class="s2">()</span>
            <span class="s1">section</span><span class="s2">.</span><span class="s1">read_header</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sections</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">section</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">sections</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">()</span>

        <span class="s6"># Read the sections into some kind of virtual memory.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">vmem </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sections</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">].</span><span class="s1">vaddr </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sections</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">].</span><span class="s1">size</span><span class="s2">)</span>
        <span class="s1">memview </span><span class="s2">= </span><span class="s1">memoryview</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">)</span>

        <span class="s4">for </span><span class="s1">section </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sections</span><span class="s2">:</span>
            <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">section</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">)</span>
            <span class="s1">fp</span><span class="s2">.</span><span class="s1">readinto</span><span class="s2">(</span><span class="s1">memview</span><span class="s2">[</span><span class="s1">section</span><span class="s2">.</span><span class="s1">vaddr</span><span class="s2">:</span><span class="s1">section</span><span class="s2">.</span><span class="s1">vaddr</span><span class="s2">+</span><span class="s1">section</span><span class="s2">.</span><span class="s1">size</span><span class="s2">])</span>

        <span class="s6"># Read the import table.</span>
        <span class="s1">start </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">imp_rva</span><span class="s2">.</span><span class="s1">addr</span>
        <span class="s1">dir </span><span class="s2">= </span><span class="s1">impdirtab</span><span class="s2">(*</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;IIIII'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">[</span><span class="s1">start</span><span class="s2">:</span><span class="s1">start</span><span class="s2">+</span><span class="s5">20</span><span class="s2">]))</span>

        <span class="s1">imports </span><span class="s2">= []</span>
        <span class="s4">while </span><span class="s1">dir</span><span class="s2">.</span><span class="s1">name </span><span class="s4">and </span><span class="s1">dir</span><span class="s2">.</span><span class="s1">lookup</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">_unpack_zstring</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">, </span><span class="s1">dir</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">imports</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

            <span class="s1">start </span><span class="s2">+= </span><span class="s5">20</span>
            <span class="s1">dir </span><span class="s2">= </span><span class="s1">impdirtab</span><span class="s2">(*</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;IIIII'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">[</span><span class="s1">start</span><span class="s2">:</span><span class="s1">start</span><span class="s2">+</span><span class="s5">20</span><span class="s2">]))</span>

        <span class="s6"># Make it a tuple to indicate we don't support modifying it for now.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">imports </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">imports</span><span class="s2">)</span>

        <span class="s6"># Read the resource tables from the .rsrc section.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">resources </span><span class="s2">= </span><span class="s1">ResourceTable</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">res_rva</span><span class="s2">.</span><span class="s1">addr </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">res_rva</span><span class="s2">.</span><span class="s1">size</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">resources</span><span class="s2">.</span><span class="s1">unpack_from</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">res_rva</span><span class="s2">.</span><span class="s1">addr</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_mark_address_modified</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rva</span><span class="s2">):</span>
        <span class="s4">for </span><span class="s1">section </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sections</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">rva </span><span class="s2">&gt;= </span><span class="s1">section</span><span class="s2">.</span><span class="s1">vaddr </span><span class="s4">and </span><span class="s1">rva </span><span class="s2">- </span><span class="s1">section</span><span class="s2">.</span><span class="s1">vaddr </span><span class="s2">&lt;= </span><span class="s1">section</span><span class="s2">.</span><span class="s1">size</span><span class="s2">:</span>
                <span class="s1">section</span><span class="s2">.</span><span class="s1">modified </span><span class="s2">= </span><span class="s4">True</span>

    <span class="s4">def </span><span class="s1">rename_export</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">old_name</span><span class="s2">, </span><span class="s1">new_name</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Renames a symbol in the export table. &quot;&quot;&quot;</span>

        <span class="s4">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">new_name</span><span class="s2">) &lt;= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">old_name</span><span class="s2">)</span>

        <span class="s1">new_name </span><span class="s2">= </span><span class="s1">new_name</span><span class="s2">.</span><span class="s1">ljust</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">old_name</span><span class="s2">) + </span><span class="s5">1</span><span class="s2">, </span><span class="s3">'</span><span class="s4">\0</span><span class="s3">'</span><span class="s2">).</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">'ascii'</span><span class="s2">)</span>

        <span class="s1">start </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exp_rva</span><span class="s2">.</span><span class="s1">addr</span>
        <span class="s1">expdir </span><span class="s2">= </span><span class="s1">expdirtab</span><span class="s2">(*</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;IIHHIIIIIII'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">[</span><span class="s1">start</span><span class="s2">:</span><span class="s1">start</span><span class="s2">+</span><span class="s5">40</span><span class="s2">]))</span>
        <span class="s4">if </span><span class="s1">expdir</span><span class="s2">.</span><span class="s1">nnames </span><span class="s2">== </span><span class="s5">0 </span><span class="s4">or </span><span class="s1">expdir</span><span class="s2">.</span><span class="s1">ordinals </span><span class="s2">== </span><span class="s5">0 </span><span class="s4">or </span><span class="s1">expdir</span><span class="s2">.</span><span class="s1">names </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">return False</span>

        <span class="s1">nptr </span><span class="s2">= </span><span class="s1">expdir</span><span class="s2">.</span><span class="s1">names</span>
        <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">expdir</span><span class="s2">.</span><span class="s1">nnames</span><span class="s2">):</span>
            <span class="s1">name_rva</span><span class="s2">, = </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;I'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">[</span><span class="s1">nptr</span><span class="s2">:</span><span class="s1">nptr</span><span class="s2">+</span><span class="s5">4</span><span class="s2">])</span>
            <span class="s4">if </span><span class="s1">name_rva </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">_unpack_zstring</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">, </span><span class="s1">name_rva</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">name </span><span class="s2">== </span><span class="s1">old_name</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">[</span><span class="s1">name_rva</span><span class="s2">:</span><span class="s1">name_rva</span><span class="s2">+</span><span class="s1">len</span><span class="s2">(</span><span class="s1">new_name</span><span class="s2">)] = </span><span class="s1">new_name</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_mark_address_modified</span><span class="s2">(</span><span class="s1">name_rva</span><span class="s2">)</span>
                    <span class="s4">return True</span>
            <span class="s1">nptr </span><span class="s2">+= </span><span class="s5">4</span>

        <span class="s4">return False</span>

    <span class="s4">def </span><span class="s1">get_export_address</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">symbol_name</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Finds the virtual address for a named export symbol. &quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">symbol_name</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">):</span>
            <span class="s1">symbol_name </span><span class="s2">= </span><span class="s1">symbol_name</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s3">'ascii'</span><span class="s2">)</span>

        <span class="s1">start </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exp_rva</span><span class="s2">.</span><span class="s1">addr</span>
        <span class="s1">expdir </span><span class="s2">= </span><span class="s1">expdirtab</span><span class="s2">(*</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;IIHHIIIIIII'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">[</span><span class="s1">start</span><span class="s2">:</span><span class="s1">start</span><span class="s2">+</span><span class="s5">40</span><span class="s2">]))</span>
        <span class="s4">if </span><span class="s1">expdir</span><span class="s2">.</span><span class="s1">nnames </span><span class="s2">== </span><span class="s5">0 </span><span class="s4">or </span><span class="s1">expdir</span><span class="s2">.</span><span class="s1">ordinals </span><span class="s2">== </span><span class="s5">0 </span><span class="s4">or </span><span class="s1">expdir</span><span class="s2">.</span><span class="s1">names </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">return None</span>

        <span class="s1">nptr </span><span class="s2">= </span><span class="s1">expdir</span><span class="s2">.</span><span class="s1">names</span>
        <span class="s1">optr </span><span class="s2">= </span><span class="s1">expdir</span><span class="s2">.</span><span class="s1">ordinals</span>
        <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">expdir</span><span class="s2">.</span><span class="s1">nnames</span><span class="s2">):</span>
            <span class="s1">name_rva</span><span class="s2">, = </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;I'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">[</span><span class="s1">nptr</span><span class="s2">:</span><span class="s1">nptr</span><span class="s2">+</span><span class="s5">4</span><span class="s2">])</span>
            <span class="s1">ordinal</span><span class="s2">, = </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;H'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">[</span><span class="s1">optr</span><span class="s2">:</span><span class="s1">optr</span><span class="s2">+</span><span class="s5">2</span><span class="s2">])</span>
            <span class="s4">if </span><span class="s1">name_rva </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">_unpack_zstring</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">, </span><span class="s1">name_rva</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">name </span><span class="s2">== </span><span class="s1">symbol_name</span><span class="s2">:</span>
                    <span class="s4">assert </span><span class="s1">ordinal </span><span class="s2">&gt;= </span><span class="s5">0 </span><span class="s4">and </span><span class="s1">ordinal </span><span class="s2">&lt; </span><span class="s1">expdir</span><span class="s2">.</span><span class="s1">nentries</span>
                    <span class="s1">start </span><span class="s2">= </span><span class="s1">expdir</span><span class="s2">.</span><span class="s1">entries </span><span class="s2">+ </span><span class="s5">4 </span><span class="s2">* </span><span class="s1">ordinal</span>
                    <span class="s1">addr</span><span class="s2">, = </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;I'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">[</span><span class="s1">start</span><span class="s2">:</span><span class="s1">start</span><span class="s2">+</span><span class="s5">4</span><span class="s2">])</span>
                    <span class="s4">return </span><span class="s1">addr</span>
            <span class="s1">nptr </span><span class="s2">+= </span><span class="s5">4</span>
            <span class="s1">optr </span><span class="s2">+= </span><span class="s5">2</span>

    <span class="s4">def </span><span class="s1">get_address_offset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Turns an address into a offset relative to the file beginning. &quot;&quot;&quot;</span>

        <span class="s1">section </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_address_section</span><span class="s2">(</span><span class="s1">addr</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">section </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s2">(</span><span class="s1">addr </span><span class="s2">- </span><span class="s1">section</span><span class="s2">.</span><span class="s1">vaddr</span><span class="s2">) + </span><span class="s1">section</span><span class="s2">.</span><span class="s1">offset</span>

    <span class="s4">def </span><span class="s1">get_address_section</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Returns the section that this virtual address belongs to. &quot;&quot;&quot;</span>

        <span class="s4">for </span><span class="s1">section </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sections</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">addr </span><span class="s2">&gt;= </span><span class="s1">section</span><span class="s2">.</span><span class="s1">vaddr </span><span class="s4">and </span><span class="s1">addr </span><span class="s2">&lt; </span><span class="s1">section</span><span class="s2">.</span><span class="s1">vaddr </span><span class="s2">+ </span><span class="s1">section</span><span class="s2">.</span><span class="s1">size</span><span class="s2">:</span>
                <span class="s4">return </span><span class="s1">section</span>

    <span class="s4">def </span><span class="s1">add_icon</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">icon</span><span class="s2">, </span><span class="s1">ordinal</span><span class="s2">=</span><span class="s5">2</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Adds an icon resource from the given Icon object.  Requires 
        calling add_resource_section() afterwards. &quot;&quot;&quot;</span>

        <span class="s1">group </span><span class="s2">= </span><span class="s1">IconGroupResource</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">resources</span><span class="s2">[</span><span class="s1">group</span><span class="s2">.</span><span class="s1">type</span><span class="s2">][</span><span class="s1">ordinal</span><span class="s2">][</span><span class="s5">1033</span><span class="s2">] = </span><span class="s1">group</span>

        <span class="s1">images </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">icon</span><span class="s2">.</span><span class="s1">images</span><span class="s2">.</span><span class="s1">items</span><span class="s2">(), </span><span class="s1">key</span><span class="s2">=</span><span class="s4">lambda </span><span class="s1">x</span><span class="s2">:-</span><span class="s1">x</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
        <span class="s1">id </span><span class="s2">= </span><span class="s5">1</span>

        <span class="s6"># Write 8-bpp image headers for sizes under 256x256.</span>
        <span class="s4">for </span><span class="s1">size</span><span class="s2">, </span><span class="s1">image </span><span class="s4">in </span><span class="s1">images</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">size </span><span class="s2">&gt;= </span><span class="s5">256</span><span class="s2">:</span>
                <span class="s4">continue</span>

            <span class="s1">xorsize </span><span class="s2">= </span><span class="s1">size</span>
            <span class="s4">if </span><span class="s1">xorsize </span><span class="s2">% </span><span class="s5">4 </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s1">xorsize </span><span class="s2">+= </span><span class="s5">4 </span><span class="s2">- (</span><span class="s1">xorsize </span><span class="s2">% </span><span class="s5">4</span><span class="s2">)</span>
            <span class="s1">andsize </span><span class="s2">= (</span><span class="s1">size </span><span class="s2">+ </span><span class="s5">7</span><span class="s2">) &gt;&gt; </span><span class="s5">3</span>
            <span class="s4">if </span><span class="s1">andsize </span><span class="s2">% </span><span class="s5">4 </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s1">andsize </span><span class="s2">+= </span><span class="s5">4 </span><span class="s2">- (</span><span class="s1">andsize </span><span class="s2">% </span><span class="s5">4</span><span class="s2">)</span>
            <span class="s1">datasize </span><span class="s2">= </span><span class="s5">40 </span><span class="s2">+ </span><span class="s5">256 </span><span class="s2">* </span><span class="s5">4 </span><span class="s2">+ (</span><span class="s1">xorsize </span><span class="s2">+ </span><span class="s1">andsize</span><span class="s2">) * </span><span class="s1">size</span>
            <span class="s1">group</span><span class="s2">.</span><span class="s1">add_icon</span><span class="s2">(</span><span class="s1">size</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s1">datasize</span><span class="s2">, </span><span class="s1">id</span><span class="s2">)</span>

            <span class="s1">buf </span><span class="s2">= </span><span class="s1">BytesIO</span><span class="s2">()</span>
            <span class="s1">icon</span><span class="s2">.</span><span class="s1">_write_bitmap</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">image</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s5">8</span><span class="s2">)</span>

            <span class="s1">res </span><span class="s2">= </span><span class="s1">DataResource</span><span class="s2">()</span>
            <span class="s1">res</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">buf</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">resources</span><span class="s2">[</span><span class="s5">3</span><span class="s2">][</span><span class="s1">id</span><span class="s2">][</span><span class="s5">1033</span><span class="s2">] = </span><span class="s1">res</span>
            <span class="s1">id </span><span class="s2">+= </span><span class="s5">1</span>

        <span class="s6"># And now the 24/32 bpp versions.</span>
        <span class="s4">for </span><span class="s1">size</span><span class="s2">, </span><span class="s1">image </span><span class="s4">in </span><span class="s1">images</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">256</span><span class="s2">:</span>
                <span class="s4">continue</span>

            <span class="s6"># Calculate the size so we can write the offset within the file.</span>
            <span class="s4">if </span><span class="s1">image</span><span class="s2">.</span><span class="s1">hasAlpha</span><span class="s2">():</span>
                <span class="s1">bpp </span><span class="s2">= </span><span class="s5">32</span>
                <span class="s1">xorsize </span><span class="s2">= </span><span class="s1">size </span><span class="s2">* </span><span class="s5">4</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">bpp </span><span class="s2">= </span><span class="s5">24</span>
                <span class="s1">xorsize </span><span class="s2">= </span><span class="s1">size </span><span class="s2">* </span><span class="s5">3 </span><span class="s2">+ (-(</span><span class="s1">size </span><span class="s2">* </span><span class="s5">3</span><span class="s2">) &amp; </span><span class="s5">3</span><span class="s2">)</span>
            <span class="s1">andsize </span><span class="s2">= (</span><span class="s1">size </span><span class="s2">+ </span><span class="s5">7</span><span class="s2">) &gt;&gt; </span><span class="s5">3</span>
            <span class="s4">if </span><span class="s1">andsize </span><span class="s2">% </span><span class="s5">4 </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s1">andsize </span><span class="s2">+= </span><span class="s5">4 </span><span class="s2">- (</span><span class="s1">andsize </span><span class="s2">% </span><span class="s5">4</span><span class="s2">)</span>
            <span class="s1">datasize </span><span class="s2">= </span><span class="s5">40 </span><span class="s2">+ (</span><span class="s1">xorsize </span><span class="s2">+ </span><span class="s1">andsize</span><span class="s2">) * </span><span class="s1">size</span>

            <span class="s1">buf </span><span class="s2">= </span><span class="s1">BytesIO</span><span class="s2">()</span>
            <span class="s1">icon</span><span class="s2">.</span><span class="s1">_write_bitmap</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">image</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">bpp</span><span class="s2">)</span>

            <span class="s1">res </span><span class="s2">= </span><span class="s1">DataResource</span><span class="s2">()</span>
            <span class="s1">res</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">buf</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">resources</span><span class="s2">[</span><span class="s5">3</span><span class="s2">][</span><span class="s1">id</span><span class="s2">][</span><span class="s5">1033</span><span class="s2">] = </span><span class="s1">res</span>
            <span class="s1">group</span><span class="s2">.</span><span class="s1">add_icon</span><span class="s2">(</span><span class="s1">size</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">bpp</span><span class="s2">, </span><span class="s1">datasize</span><span class="s2">, </span><span class="s1">id</span><span class="s2">)</span>
            <span class="s1">id </span><span class="s2">+= </span><span class="s5">1</span>

    <span class="s4">def </span><span class="s1">add_section</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Adds a new section with the given name, flags and data.  The 
        virtual address space is automatically resized to fit the new data. 
 
        Returns the newly created Section object. &quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">unicode</span><span class="s2">):</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">name</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">'ascii'</span><span class="s2">)</span>

        <span class="s1">section </span><span class="s2">= </span><span class="s1">Section</span><span class="s2">()</span>
        <span class="s1">section</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">section</span><span class="s2">.</span><span class="s1">flags </span><span class="s2">= </span><span class="s1">flags</span>

        <span class="s6"># Put it at the end of all the other sections.</span>
        <span class="s1">section</span><span class="s2">.</span><span class="s1">offset </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s4">for </span><span class="s1">s </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sections</span><span class="s2">:</span>
            <span class="s1">section</span><span class="s2">.</span><span class="s1">offset </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">section</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">, </span><span class="s1">s</span><span class="s2">.</span><span class="s1">offset </span><span class="s2">+ </span><span class="s1">s</span><span class="s2">.</span><span class="s1">size</span><span class="s2">)</span>

        <span class="s6"># Align the offset.</span>
        <span class="s1">section</span><span class="s2">.</span><span class="s1">offset </span><span class="s2">= </span><span class="s1">_padded</span><span class="s2">(</span><span class="s1">section</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_alignment</span><span class="s2">)</span>

        <span class="s6"># Find a place to put it in the virtual address space.</span>
        <span class="s1">section</span><span class="s2">.</span><span class="s1">vaddr </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">)</span>
        <span class="s1">align </span><span class="s2">= </span><span class="s1">section</span><span class="s2">.</span><span class="s1">vaddr </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">section_alignment</span>
        <span class="s4">if </span><span class="s1">align</span><span class="s2">:</span>
            <span class="s1">pad </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">section_alignment </span><span class="s2">- </span><span class="s1">align</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">vmem </span><span class="s2">+= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s1">pad</span><span class="s2">)</span>
            <span class="s1">section</span><span class="s2">.</span><span class="s1">vaddr </span><span class="s2">+= </span><span class="s1">pad</span>

        <span class="s1">section</span><span class="s2">.</span><span class="s1">vsize </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">section</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s1">_padded</span><span class="s2">(</span><span class="s1">section</span><span class="s2">.</span><span class="s1">vsize</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_alignment</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">vmem </span><span class="s2">+= </span><span class="s1">data</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sections</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">section</span><span class="s2">)</span>

        <span class="s6"># Update the size tallies from the opthdr.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">image_size </span><span class="s2">+= </span><span class="s1">_padded</span><span class="s2">(</span><span class="s1">section</span><span class="s2">.</span><span class="s1">vsize</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">section_alignment</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">flags </span><span class="s2">&amp; </span><span class="s5">0x20</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">code_size </span><span class="s2">+= </span><span class="s1">section</span><span class="s2">.</span><span class="s1">size</span>
        <span class="s4">if </span><span class="s1">flags </span><span class="s2">&amp; </span><span class="s5">0x40</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">initialized_size </span><span class="s2">+= </span><span class="s1">section</span><span class="s2">.</span><span class="s1">size</span>
        <span class="s4">if </span><span class="s1">flags </span><span class="s2">&amp; </span><span class="s5">0x80</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">uninitialized_size </span><span class="s2">+= </span><span class="s1">section</span><span class="s2">.</span><span class="s1">size</span>

        <span class="s4">return </span><span class="s1">section</span>

    <span class="s4">def </span><span class="s1">add_version_info</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file_ver</span><span class="s2">, </span><span class="s1">product_ver</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">lang</span><span class="s2">=</span><span class="s5">1033</span><span class="s2">, </span><span class="s1">codepage</span><span class="s2">=</span><span class="s5">1200</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Adds a version info resource to the file. &quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s3">&quot;FileVersion&quot; </span><span class="s4">not in </span><span class="s1">data</span><span class="s2">:</span>
            <span class="s1">data</span><span class="s2">[</span><span class="s3">&quot;FileVersion&quot;</span><span class="s2">] = </span><span class="s3">'.'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">file_ver</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s3">&quot;ProductVersion&quot; </span><span class="s4">not in </span><span class="s1">data</span><span class="s2">:</span>
            <span class="s1">data</span><span class="s2">[</span><span class="s3">&quot;ProductVersion&quot;</span><span class="s2">] = </span><span class="s3">'.'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">product_ver</span><span class="s2">)</span>

        <span class="s4">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">file_ver</span><span class="s2">) == </span><span class="s5">4</span>
        <span class="s4">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">product_ver</span><span class="s2">) == </span><span class="s5">4</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">VersionInfoResource</span><span class="s2">()</span>
        <span class="s1">res</span><span class="s2">.</span><span class="s1">file_version </span><span class="s2">= </span><span class="s1">file_ver</span>
        <span class="s1">res</span><span class="s2">.</span><span class="s1">product_version </span><span class="s2">= </span><span class="s1">product_ver</span>
        <span class="s1">res</span><span class="s2">.</span><span class="s1">string_info </span><span class="s2">= {</span>
            <span class="s3">&quot;%04x%04x&quot; </span><span class="s2">% (</span><span class="s1">lang</span><span class="s2">, </span><span class="s1">codepage</span><span class="s2">): </span><span class="s1">data</span>
        <span class="s2">}</span>
        <span class="s1">res</span><span class="s2">.</span><span class="s1">var_info </span><span class="s2">= {</span>
            <span class="s3">&quot;Translation&quot;</span><span class="s2">: </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">&quot;&lt;HH&quot;</span><span class="s2">, </span><span class="s1">lang</span><span class="s2">, </span><span class="s1">codepage</span><span class="s2">))</span>
        <span class="s2">}</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">resources</span><span class="s2">[</span><span class="s5">16</span><span class="s2">][</span><span class="s5">1</span><span class="s2">][</span><span class="s1">lang</span><span class="s2">] = </span><span class="s1">res</span>

    <span class="s4">def </span><span class="s1">add_resource_section</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Adds a resource section to the file containing the resources that 
        were previously added via add_icon et al.  Assumes the file does not 
        contain a resource section yet. &quot;&quot;&quot;</span>

        <span class="s6"># Calculate how much space to reserve.</span>
        <span class="s1">tables </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">resources</span><span class="s2">] + </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">resources</span><span class="s2">.</span><span class="s1">get_nested_tables</span><span class="s2">())</span>
        <span class="s1">table_size </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">string_size </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">desc_size </span><span class="s2">= </span><span class="s5">16 </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">resources</span><span class="s2">.</span><span class="s1">count_resources</span><span class="s2">()</span>

        <span class="s4">for </span><span class="s1">table </span><span class="s4">in </span><span class="s1">tables</span><span class="s2">:</span>
            <span class="s1">table</span><span class="s2">.</span><span class="s1">_offset </span><span class="s2">= </span><span class="s1">table_size</span>
            <span class="s1">table_size </span><span class="s2">+= </span><span class="s5">16 </span><span class="s2">+ </span><span class="s5">8 </span><span class="s2">* </span><span class="s1">len</span><span class="s2">(</span><span class="s1">table</span><span class="s2">)</span>
            <span class="s1">string_size </span><span class="s2">+= </span><span class="s1">table</span><span class="s2">.</span><span class="s1">_strings_size</span>
            <span class="s1">desc_size </span><span class="s2">+= </span><span class="s1">table</span><span class="s2">.</span><span class="s1">_descs_size</span>

        <span class="s6"># Now write the actual data.</span>
        <span class="s1">tbl_offs </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">str_offs </span><span class="s2">= </span><span class="s1">table_size</span>
        <span class="s1">desc_offs </span><span class="s2">= </span><span class="s1">str_offs </span><span class="s2">+ </span><span class="s1">string_size</span>
        <span class="s1">data_offs </span><span class="s2">= </span><span class="s1">desc_offs </span><span class="s2">+ </span><span class="s1">desc_size</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s1">data_offs</span><span class="s2">)</span>
        <span class="s1">data_addr </span><span class="s2">= </span><span class="s1">_padded</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">section_alignment</span><span class="s2">) + </span><span class="s1">data_offs</span>

        <span class="s4">for </span><span class="s1">table </span><span class="s4">in </span><span class="s1">tables</span><span class="s2">:</span>
            <span class="s1">table</span><span class="s2">.</span><span class="s1">pack_header</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">tbl_offs</span><span class="s2">)</span>

            <span class="s1">tbl_offs </span><span class="s2">+= </span><span class="s5">16</span>

            <span class="s4">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">leaf </span><span class="s4">in </span><span class="s1">table</span><span class="s2">.</span><span class="s1">_name_leaves</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">leaf</span><span class="s2">, </span><span class="s1">ResourceTable</span><span class="s2">):</span>
                    <span class="s1">pack_into</span><span class="s2">(</span><span class="s3">'&lt;II'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">tbl_offs</span><span class="s2">, </span><span class="s1">str_offs </span><span class="s2">| </span><span class="s5">0x80000000</span><span class="s2">, </span><span class="s1">leaf</span><span class="s2">.</span><span class="s1">_offset </span><span class="s2">| </span><span class="s5">0x80000000</span><span class="s2">)</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">pack_into</span><span class="s2">(</span><span class="s3">'&lt;II'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">tbl_offs</span><span class="s2">, </span><span class="s1">str_offs </span><span class="s2">| </span><span class="s5">0x80000000</span><span class="s2">, </span><span class="s1">desc_offs</span><span class="s2">)</span>
                    <span class="s1">resdata </span><span class="s2">= </span><span class="s1">leaf</span><span class="s2">.</span><span class="s1">get_data</span><span class="s2">()</span>
                    <span class="s1">pack_into</span><span class="s2">(</span><span class="s3">'&lt;IIII'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">desc_offs</span><span class="s2">, </span><span class="s1">data_addr</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">resdata</span><span class="s2">), </span><span class="s1">leaf</span><span class="s2">.</span><span class="s1">code_page</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
                    <span class="s1">data </span><span class="s2">+= </span><span class="s1">resdata</span>
                    <span class="s1">desc_offs </span><span class="s2">+= </span><span class="s5">16</span>
                    <span class="s1">data_addr </span><span class="s2">+= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">resdata</span><span class="s2">)</span>
                    <span class="s1">align </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">resdata</span><span class="s2">) &amp; </span><span class="s5">3</span>
                    <span class="s4">if </span><span class="s1">align</span><span class="s2">:</span>
                        <span class="s1">data </span><span class="s2">+= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s5">4 </span><span class="s2">- </span><span class="s1">align</span><span class="s2">)</span>
                        <span class="s1">data_addr </span><span class="s2">+= </span><span class="s5">4 </span><span class="s2">- </span><span class="s1">align</span>
                <span class="s1">tbl_offs </span><span class="s2">+= </span><span class="s5">8</span>

                <span class="s6"># Pack the name into the string table.</span>
                <span class="s1">pack_into</span><span class="s2">(</span><span class="s3">'&lt;H'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">str_offs</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">name</span><span class="s2">))</span>
                <span class="s1">str_offs </span><span class="s2">+= </span><span class="s5">2</span>
                <span class="s4">for </span><span class="s1">c </span><span class="s4">in </span><span class="s1">name</span><span class="s2">:</span>
                    <span class="s1">pack_into</span><span class="s2">(</span><span class="s3">'&lt;H'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">str_offs</span><span class="s2">, </span><span class="s1">ord</span><span class="s2">(</span><span class="s1">c</span><span class="s2">))</span>
                    <span class="s1">str_offs </span><span class="s2">+= </span><span class="s5">2</span>
                <span class="s1">str_offs </span><span class="s2">= </span><span class="s1">_padded</span><span class="s2">(</span><span class="s1">str_offs</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>

            <span class="s4">for </span><span class="s1">id</span><span class="s2">, </span><span class="s1">leaf </span><span class="s4">in </span><span class="s1">table</span><span class="s2">.</span><span class="s1">_id_leaves</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">leaf</span><span class="s2">, </span><span class="s1">ResourceTable</span><span class="s2">):</span>
                    <span class="s1">pack_into</span><span class="s2">(</span><span class="s3">'&lt;II'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">tbl_offs</span><span class="s2">, </span><span class="s1">id</span><span class="s2">, </span><span class="s1">leaf</span><span class="s2">.</span><span class="s1">_offset </span><span class="s2">| </span><span class="s5">0x80000000</span><span class="s2">)</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">pack_into</span><span class="s2">(</span><span class="s3">'&lt;II'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">tbl_offs</span><span class="s2">, </span><span class="s1">id</span><span class="s2">, </span><span class="s1">desc_offs</span><span class="s2">)</span>
                    <span class="s1">resdata </span><span class="s2">= </span><span class="s1">leaf</span><span class="s2">.</span><span class="s1">get_data</span><span class="s2">()</span>
                    <span class="s1">pack_into</span><span class="s2">(</span><span class="s3">'&lt;IIII'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">desc_offs</span><span class="s2">, </span><span class="s1">data_addr</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">resdata</span><span class="s2">), </span><span class="s1">leaf</span><span class="s2">.</span><span class="s1">code_page</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
                    <span class="s1">data </span><span class="s2">+= </span><span class="s1">resdata</span>
                    <span class="s1">desc_offs </span><span class="s2">+= </span><span class="s5">16</span>
                    <span class="s1">data_addr </span><span class="s2">+= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">resdata</span><span class="s2">)</span>
                    <span class="s1">align </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">resdata</span><span class="s2">) &amp; </span><span class="s5">3</span>
                    <span class="s4">if </span><span class="s1">align</span><span class="s2">:</span>
                        <span class="s1">data </span><span class="s2">+= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s5">4 </span><span class="s2">- </span><span class="s1">align</span><span class="s2">)</span>
                        <span class="s1">data_addr </span><span class="s2">+= </span><span class="s5">4 </span><span class="s2">- </span><span class="s1">align</span>
                <span class="s1">tbl_offs </span><span class="s2">+= </span><span class="s5">8</span>

        <span class="s1">flags </span><span class="s2">= </span><span class="s5">0x40000040 </span><span class="s6"># readable, contains initialized data</span>
        <span class="s1">section </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">add_section</span><span class="s2">(</span><span class="s3">'.rsrc'</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">res_rva </span><span class="s2">= </span><span class="s1">RVASize</span><span class="s2">(</span><span class="s1">section</span><span class="s2">.</span><span class="s1">vaddr</span><span class="s2">, </span><span class="s1">section</span><span class="s2">.</span><span class="s1">vsize</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">write_changes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Assuming the file was opened in read-write mode, writes back the 
        changes made via this class to the .exe file. &quot;&quot;&quot;</span>

        <span class="s1">fp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fp</span>
        <span class="s6"># Read position of header.</span>
        <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s5">0x3c</span><span class="s2">)</span>
        <span class="s1">offset</span><span class="s2">, = </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;I'</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">4</span><span class="s2">))</span>

        <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">4</span><span class="s2">) != </span><span class="s7">b'PE</span><span class="s4">\0\0</span><span class="s7">'</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;Invalid PE file.&quot;</span><span class="s2">)</span>

        <span class="s6"># Sync read/write pointer.  Necessary before write.  Bug in Python?</span>
        <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">())</span>

        <span class="s6"># Rewrite the first part of the COFF header.</span>
        <span class="s1">timdat </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">time</span><span class="s2">.</span><span class="s1">time</span><span class="s2">())</span>
        <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;HHI'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sections</span><span class="s2">), </span><span class="s1">timdat</span><span class="s2">))</span>

        <span class="s6"># Write calculated init and uninitialised sizes to the opthdr.</span>
        <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s5">16</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;III'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_size</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">initialized_size</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">uninitialized_size</span><span class="s2">))</span>

        <span class="s6"># Same for the image and header size.</span>
        <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s5">40</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;II'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">image_size</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">header_size</span><span class="s2">))</span>

        <span class="s6"># Write the modified RVA table.</span>
        <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rva_offset</span><span class="s2">)</span>
        <span class="s1">numrvas</span><span class="s2">, = </span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&lt;I'</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">4</span><span class="s2">))</span>
        <span class="s4">assert </span><span class="s1">numrvas </span><span class="s2">&gt;= </span><span class="s5">3</span>

        <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rva_offset </span><span class="s2">+ </span><span class="s5">4</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">numrvas </span><span class="s2">&gt;= </span><span class="s5">1</span><span class="s2">:</span>
            <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;II'</span><span class="s2">, *</span><span class="s1">self</span><span class="s2">.</span><span class="s1">exp_rva</span><span class="s2">))</span>
        <span class="s4">if </span><span class="s1">numrvas </span><span class="s2">&gt;= </span><span class="s5">2</span><span class="s2">:</span>
            <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;II'</span><span class="s2">, *</span><span class="s1">self</span><span class="s2">.</span><span class="s1">imp_rva</span><span class="s2">))</span>
        <span class="s4">if </span><span class="s1">numrvas </span><span class="s2">&gt;= </span><span class="s5">3</span><span class="s2">:</span>
            <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;II'</span><span class="s2">, *</span><span class="s1">self</span><span class="s2">.</span><span class="s1">res_rva</span><span class="s2">))</span>

        <span class="s6"># Skip the rest of the tables.</span>
        <span class="s4">if </span><span class="s1">numrvas </span><span class="s2">&gt;= </span><span class="s5">4</span><span class="s2">:</span>
            <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">((</span><span class="s1">numrvas </span><span class="s2">- </span><span class="s5">3</span><span class="s2">) * </span><span class="s5">8</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>

        <span class="s6"># Write the modified section headers.</span>
        <span class="s4">for </span><span class="s1">section </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sections</span><span class="s2">:</span>
            <span class="s1">section</span><span class="s2">.</span><span class="s1">write_header</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">)</span>
            <span class="s4">assert </span><span class="s1">fp</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">() &lt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">header_size</span>

        <span class="s6"># Write the section data of modified sections.</span>
        <span class="s4">for </span><span class="s1">section </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sections</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">section</span><span class="s2">.</span><span class="s1">modified</span><span class="s2">:</span>
                <span class="s4">continue</span>

            <span class="s1">fp</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">section</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">)</span>
            <span class="s1">size </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">section</span><span class="s2">.</span><span class="s1">vsize</span><span class="s2">, </span><span class="s1">section</span><span class="s2">.</span><span class="s1">size</span><span class="s2">)</span>
            <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">vmem</span><span class="s2">[</span><span class="s1">section</span><span class="s2">.</span><span class="s1">vaddr</span><span class="s2">:</span><span class="s1">section</span><span class="s2">.</span><span class="s1">vaddr</span><span class="s2">+</span><span class="s1">size</span><span class="s2">])</span>

            <span class="s1">pad </span><span class="s2">= </span><span class="s1">section</span><span class="s2">.</span><span class="s1">size </span><span class="s2">- </span><span class="s1">size</span>
            <span class="s4">assert </span><span class="s1">pad </span><span class="s2">&gt;= </span><span class="s5">0</span>
            <span class="s4">if </span><span class="s1">pad </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">bytearray</span><span class="s2">(</span><span class="s1">pad</span><span class="s2">))</span>

            <span class="s1">section</span><span class="s2">.</span><span class="s1">modified </span><span class="s2">= </span><span class="s4">False</span>
</pre>
</body>
</html>