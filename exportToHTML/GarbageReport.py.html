<html>
<head>
<title>GarbageReport.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
GarbageReport.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Contains utility classes for debugging memory leaks.&quot;&quot;&quot;</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">'FakeObject'</span><span class="s2">, </span><span class="s3">'_createGarbage'</span><span class="s2">, </span><span class="s3">'GarbageReport'</span><span class="s2">, </span><span class="s3">'GarbageLogger'</span><span class="s2">]</span>

<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">directnotify</span><span class="s2">.</span><span class="s1">DirectNotifyGlobal </span><span class="s4">import </span><span class="s1">directNotify</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase</span><span class="s2">.</span><span class="s1">PythonUtil </span><span class="s4">import </span><span class="s1">fastRepr</span><span class="s2">, </span><span class="s1">AlphabetCounter</span><span class="s2">, </span><span class="s1">itype</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase</span><span class="s2">.</span><span class="s1">Job </span><span class="s4">import </span><span class="s1">Job</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase</span><span class="s2">.</span><span class="s1">JobManagerGlobal </span><span class="s4">import </span><span class="s1">jobMgr</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase</span><span class="s2">.</span><span class="s1">MessengerGlobal </span><span class="s4">import </span><span class="s1">messenger</span>
<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s1">ConfigVariableBool</span>
<span class="s4">import </span><span class="s1">gc</span>
<span class="s4">import </span><span class="s1">sys</span>

<span class="s1">GarbageCycleCountAnnounceEvent </span><span class="s2">= </span><span class="s3">'announceGarbageCycleDesc2num'</span>

<span class="s4">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">):</span>
    <span class="s1">xrange </span><span class="s2">= </span><span class="s1">range</span>

<span class="s4">class </span><span class="s1">FakeObject</span><span class="s2">:</span>
    <span class="s4">pass</span>

<span class="s4">class </span><span class="s1">FakeDelObject</span><span class="s2">:</span>
    <span class="s4">def </span><span class="s1">__del__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">pass</span>

<span class="s4">def </span><span class="s1">_createGarbage</span><span class="s2">(</span><span class="s1">num</span><span class="s2">=</span><span class="s5">1</span><span class="s2">):</span>
    <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">num</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">FakeObject</span><span class="s2">()</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">FakeObject</span><span class="s2">()</span>
        <span class="s1">a</span><span class="s2">.</span><span class="s1">other </span><span class="s2">= </span><span class="s1">b</span>
        <span class="s1">b</span><span class="s2">.</span><span class="s1">other </span><span class="s2">= </span><span class="s1">a</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">FakeDelObject</span><span class="s2">()</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">FakeDelObject</span><span class="s2">()</span>
        <span class="s1">a</span><span class="s2">.</span><span class="s1">other </span><span class="s2">= </span><span class="s1">b</span>
        <span class="s1">b</span><span class="s2">.</span><span class="s1">other </span><span class="s2">= </span><span class="s1">a</span>

<span class="s4">class </span><span class="s1">GarbageReport</span><span class="s2">(</span><span class="s1">Job</span><span class="s2">):</span>
    <span class="s0">&quot;&quot;&quot;Detects leaked Python objects (via gc.collect()) and reports on garbage 
    items, garbage-to-garbage references, and garbage cycles. 
    If you just want to dump the report to the log, use GarbageLogger.&quot;&quot;&quot;</span>
    <span class="s1">notify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s3">&quot;GarbageReport&quot;</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">log</span><span class="s2">=</span><span class="s4">True</span><span class="s2">, </span><span class="s1">verbose</span><span class="s2">=</span><span class="s4">False</span><span class="s2">, </span><span class="s1">fullReport</span><span class="s2">=</span><span class="s4">False</span><span class="s2">, </span><span class="s1">findCycles</span><span class="s2">=</span><span class="s4">True</span><span class="s2">,</span>
                 <span class="s1">threaded</span><span class="s2">=</span><span class="s4">False</span><span class="s2">, </span><span class="s1">doneCallback</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">autoDestroy</span><span class="s2">=</span><span class="s4">False</span><span class="s2">, </span><span class="s1">priority</span><span class="s2">=</span><span class="s4">None</span><span class="s2">,</span>
                 <span class="s1">safeMode</span><span class="s2">=</span><span class="s4">False</span><span class="s2">, </span><span class="s1">delOnly</span><span class="s2">=</span><span class="s4">False</span><span class="s2">, </span><span class="s1">collect</span><span class="s2">=</span><span class="s4">True</span><span class="s2">):</span>
        <span class="s6"># if autoDestroy is True, GarbageReport will self-destroy after logging</span>
        <span class="s6"># if false, caller is responsible for calling destroy()</span>
        <span class="s6"># if threaded is True, processing will be performed over multiple frames</span>
        <span class="s6"># if collect is False, we assume that the caller just did a collect and the results</span>
        <span class="s6"># are still in gc.garbage</span>
        <span class="s1">Job</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s6"># stick the arguments onto a ScratchPad so we can delete them all at once</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_args </span><span class="s2">= </span><span class="s1">ScratchPad</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">, </span><span class="s1">log</span><span class="s2">=</span><span class="s1">log</span><span class="s2">, </span><span class="s1">verbose</span><span class="s2">=</span><span class="s1">verbose</span><span class="s2">, </span><span class="s1">fullReport</span><span class="s2">=</span><span class="s1">fullReport</span><span class="s2">,</span>
                                <span class="s1">findCycles</span><span class="s2">=</span><span class="s1">findCycles</span><span class="s2">, </span><span class="s1">doneCallback</span><span class="s2">=</span><span class="s1">doneCallback</span><span class="s2">,</span>
                                <span class="s1">autoDestroy</span><span class="s2">=</span><span class="s1">autoDestroy</span><span class="s2">, </span><span class="s1">safeMode</span><span class="s2">=</span><span class="s1">safeMode</span><span class="s2">, </span><span class="s1">delOnly</span><span class="s2">=</span><span class="s1">delOnly</span><span class="s2">,</span>
                                <span class="s1">collect</span><span class="s2">=</span><span class="s1">collect</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">priority </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">setPriority</span><span class="s2">(</span><span class="s1">priority</span><span class="s2">)</span>
        <span class="s1">jobMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">threaded</span><span class="s2">:</span>
            <span class="s1">jobMgr</span><span class="s2">.</span><span class="s1">finish</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">run</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># do the garbage collection</span>
        <span class="s1">oldFlags </span><span class="s2">= </span><span class="s1">gc</span><span class="s2">.</span><span class="s1">get_debug</span><span class="s2">()</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">delOnly</span><span class="s2">:</span>
            <span class="s6"># do a collect without SAVEALL, to identify the instances that are involved in</span>
            <span class="s6"># cycles with instances that define __del__</span>
            <span class="s6"># cycles that do not involve any instances that define __del__ are cleaned up</span>
            <span class="s6"># automatically by Python, but they also appear in gc.garbage when SAVEALL is set</span>
            <span class="s1">gc</span><span class="s2">.</span><span class="s1">set_debug</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">collect</span><span class="s2">:</span>
                <span class="s1">gc</span><span class="s2">.</span><span class="s1">collect</span><span class="s2">()</span>
            <span class="s1">garbageInstances </span><span class="s2">= </span><span class="s1">gc</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[:]</span>
            <span class="s4">del </span><span class="s1">gc</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[:]</span>
            <span class="s6"># only yield if there's more time-consuming work to do,</span>
            <span class="s6"># if there's no garbage, give instant feedback</span>
            <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">garbageInstances</span><span class="s2">) &gt; </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s4">yield None</span>
            <span class="s6"># don't repr the garbage list if we don't have to</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">getDebug</span><span class="s2">():</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">'garbageInstances == %s' </span><span class="s2">% </span><span class="s1">fastRepr</span><span class="s2">(</span><span class="s1">garbageInstances</span><span class="s2">))</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">numGarbageInstances </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">garbageInstances</span><span class="s2">)</span>
            <span class="s6"># grab the ids of the garbage instances (objects with __del__)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">garbageInstanceIds </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
            <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">garbageInstances</span><span class="s2">)):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">garbageInstanceIds</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">id</span><span class="s2">(</span><span class="s1">garbageInstances</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]))</span>
                <span class="s4">if not </span><span class="s2">(</span><span class="s1">i </span><span class="s2">% </span><span class="s5">20</span><span class="s2">):</span>
                    <span class="s4">yield None</span>
            <span class="s6"># then release the list of instances so that it doesn't interfere with the gc.collect() below</span>
            <span class="s4">del </span><span class="s1">garbageInstances</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">garbageInstanceIds </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>

        <span class="s6"># do a SAVEALL pass so that we have all of the objects involved in legitimate garbage cycles</span>
        <span class="s6"># without SAVEALL, gc.garbage only contains objects with __del__ methods</span>
        <span class="s1">gc</span><span class="s2">.</span><span class="s1">set_debug</span><span class="s2">(</span><span class="s1">gc</span><span class="s2">.</span><span class="s1">DEBUG_SAVEALL</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">collect</span><span class="s2">:</span>
            <span class="s1">gc</span><span class="s2">.</span><span class="s1">collect</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">garbage </span><span class="s2">= </span><span class="s1">gc</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[:]</span>
        <span class="s4">del </span><span class="s1">gc</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[:]</span>
        <span class="s6"># only yield if there's more time-consuming work to do,</span>
        <span class="s6"># if there's no garbage, give instant feedback</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">) &gt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">yield None</span>
        <span class="s6"># don't repr the garbage list if we don't have to</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">getDebug</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">'self.garbage == %s' </span><span class="s2">% </span><span class="s1">fastRepr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">))</span>
        <span class="s1">gc</span><span class="s2">.</span><span class="s1">set_debug</span><span class="s2">(</span><span class="s1">oldFlags</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">numGarbage </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">)</span>
        <span class="s6"># only yield if there's more time-consuming work to do,</span>
        <span class="s6"># if there's no garbage, give instant feedback</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">numGarbage </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">yield None</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">verbose</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">'found %s garbage items' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">numGarbage</span><span class="s2">)</span>

        <span class="s3">&quot;&quot;&quot; spammy 
        # print the types of the garbage first, in case the repr of an object 
        # causes a crash 
        if self.numGarbage &gt; 0: 
            self.notify.info('TYPES ONLY (this is only needed if a crash occurs before GarbageReport finishes):') 
            for result in printNumberedTypesGen(self.garbage): 
                yield None 
                &quot;&quot;&quot;</span>

        <span class="s6"># Py obj id -&gt; garbage list index</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2index </span><span class="s2">= {}</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">referrersByReference </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">referrersByNumber </span><span class="s2">= {}</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">referentsByReference </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">referentsByNumber </span><span class="s2">= {}</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2garbageInfo </span><span class="s2">= {}</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">cycles </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cyclesBySyntax </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">uniqueCycleSets </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cycleIds </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>

        <span class="s6"># make the id-&gt;index table to speed up the next steps</span>
        <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">numGarbage</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2index</span><span class="s2">[</span><span class="s1">id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])] = </span><span class="s1">i</span>
            <span class="s4">if not </span><span class="s2">(</span><span class="s1">i </span><span class="s2">% </span><span class="s5">20</span><span class="s2">):</span>
                <span class="s4">yield None</span>

        <span class="s6"># grab the referrers (pointing to garbage)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">fullReport </span><span class="s4">and </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">numGarbage </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">):</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">verbose</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">'getting referrers...'</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">numGarbage</span><span class="s2">):</span>
                <span class="s4">yield None</span>
                <span class="s4">for </span><span class="s1">result </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_getReferrers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]):</span>
                    <span class="s4">yield None</span>
                <span class="s1">byNum</span><span class="s2">, </span><span class="s1">byRef </span><span class="s2">= </span><span class="s1">result</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">referrersByNumber</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">byNum</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">referrersByReference</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">byRef</span>

        <span class="s6"># grab the referents (pointed to by garbage)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">numGarbage </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">verbose</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">'getting referents...'</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">numGarbage</span><span class="s2">):</span>
                <span class="s4">yield None</span>
                <span class="s4">for </span><span class="s1">result </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_getReferents</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]):</span>
                    <span class="s4">yield None</span>
                <span class="s1">byNum</span><span class="s2">, </span><span class="s1">byRef </span><span class="s2">= </span><span class="s1">result</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">referentsByNumber</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">byNum</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">referentsByReference</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">byRef</span>

        <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">numGarbage</span><span class="s2">):</span>
            <span class="s4">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s3">'_garbageInfo'</span><span class="s2">) </span><span class="s4">and </span><span class="s1">callable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">_garbageInfo</span><span class="s2">):</span>
                <span class="s4">try</span><span class="s2">:</span>
                    <span class="s1">info </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">_garbageInfo</span><span class="s2">()</span>
                <span class="s4">except </span><span class="s1">Exception </span><span class="s4">as </span><span class="s1">e</span><span class="s2">:</span>
                    <span class="s1">info </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2garbageInfo</span><span class="s2">[</span><span class="s1">id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])] = </span><span class="s1">info</span>
                <span class="s4">yield None</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s4">if not </span><span class="s2">(</span><span class="s1">i </span><span class="s2">% </span><span class="s5">20</span><span class="s2">):</span>
                    <span class="s4">yield None</span>

        <span class="s6"># find the cycles</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">findCycles </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">numGarbage </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">verbose</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">'calculating cycles...'</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">numGarbage</span><span class="s2">):</span>
                <span class="s4">yield None</span>
                <span class="s4">for </span><span class="s1">newCycles </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_getCycles</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">uniqueCycleSets</span><span class="s2">):</span>
                    <span class="s4">yield None</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cycles</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">newCycles</span><span class="s2">)</span>
                <span class="s6"># create a representation of the cycle in human-readable form</span>
                <span class="s1">newCyclesBySyntax </span><span class="s2">= []</span>
                <span class="s4">for </span><span class="s1">cycle </span><span class="s4">in </span><span class="s1">newCycles</span><span class="s2">:</span>
                    <span class="s1">cycleBySyntax </span><span class="s2">= </span><span class="s3">''</span>
                    <span class="s1">objs </span><span class="s2">= []</span>
                    <span class="s6"># leave off the last index, it's a repeat of the first index</span>
                    <span class="s4">for </span><span class="s1">index </span><span class="s4">in </span><span class="s1">cycle</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">]:</span>
                        <span class="s1">objs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[</span><span class="s1">index</span><span class="s2">])</span>
                        <span class="s4">yield None</span>
                    <span class="s6"># make the list repeat so we can safely iterate off the end</span>
                    <span class="s1">numObjs </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">objs</span><span class="s2">) - </span><span class="s5">1</span>
                    <span class="s1">objs</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">objs</span><span class="s2">)</span>

                    <span class="s6"># state variables for our loop below</span>
                    <span class="s1">numToSkip </span><span class="s2">= </span><span class="s5">0</span>
                    <span class="s1">objAlreadyRepresented </span><span class="s2">= </span><span class="s4">False</span>

                    <span class="s6"># if cycle starts off with an instance dict, start with the instance instead</span>
                    <span class="s1">startIndex </span><span class="s2">= </span><span class="s5">0</span>
                    <span class="s6"># + 1 to include a reference back to the first object</span>
                    <span class="s1">endIndex </span><span class="s2">= </span><span class="s1">numObjs </span><span class="s2">+ </span><span class="s5">1</span>
                    <span class="s4">if </span><span class="s1">type</span><span class="s2">(</span><span class="s1">objs</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]) </span><span class="s4">is </span><span class="s1">dict </span><span class="s4">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">objs</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">], </span><span class="s3">'__dict__'</span><span class="s2">):</span>
                        <span class="s1">startIndex </span><span class="s2">-= </span><span class="s5">1</span>
                        <span class="s1">endIndex </span><span class="s2">-= </span><span class="s5">1</span>

                    <span class="s4">for </span><span class="s1">index </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">startIndex</span><span class="s2">, </span><span class="s1">endIndex</span><span class="s2">):</span>
                        <span class="s4">if </span><span class="s1">numToSkip</span><span class="s2">:</span>
                            <span class="s1">numToSkip </span><span class="s2">-= </span><span class="s5">1</span>
                            <span class="s4">continue</span>
                        <span class="s1">obj </span><span class="s2">= </span><span class="s1">objs</span><span class="s2">[</span><span class="s1">index</span><span class="s2">]</span>
                        <span class="s4">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">'__dict__'</span><span class="s2">):</span>
                            <span class="s4">if not </span><span class="s1">objAlreadyRepresented</span><span class="s2">:</span>
                                <span class="s1">cycleBySyntax </span><span class="s2">+= </span><span class="s3">'%s' </span><span class="s2">% </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span>
                            <span class="s1">cycleBySyntax </span><span class="s2">+= </span><span class="s3">'.'</span>
                            <span class="s6"># skip past the instance dict and get the member obj</span>
                            <span class="s1">numToSkip </span><span class="s2">+= </span><span class="s5">1</span>
                            <span class="s1">member </span><span class="s2">= </span><span class="s1">objs</span><span class="s2">[</span><span class="s1">index</span><span class="s2">+</span><span class="s5">2</span><span class="s2">]</span>
                            <span class="s4">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s4">in </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                                <span class="s4">if </span><span class="s1">value </span><span class="s4">is </span><span class="s1">member</span><span class="s2">:</span>
                                    <span class="s4">break</span>
                                <span class="s4">yield None</span>
                            <span class="s4">else</span><span class="s2">:</span>
                                <span class="s1">key </span><span class="s2">= </span><span class="s3">'&lt;unknown member name&gt;'</span>
                            <span class="s1">cycleBySyntax </span><span class="s2">+= </span><span class="s3">'%s' </span><span class="s2">% </span><span class="s1">key</span>
                            <span class="s1">objAlreadyRepresented </span><span class="s2">= </span><span class="s4">True</span>
                        <span class="s4">elif </span><span class="s1">type</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">) </span><span class="s4">is </span><span class="s1">dict</span><span class="s2">:</span>
                            <span class="s1">cycleBySyntax </span><span class="s2">+= </span><span class="s3">'{'</span>
                            <span class="s6"># get object referred to by dict</span>
                            <span class="s1">val </span><span class="s2">= </span><span class="s1">objs</span><span class="s2">[</span><span class="s1">index</span><span class="s2">+</span><span class="s5">1</span><span class="s2">]</span>
                            <span class="s4">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s4">in </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                                <span class="s4">if </span><span class="s1">value </span><span class="s4">is </span><span class="s1">val</span><span class="s2">:</span>
                                    <span class="s4">break</span>
                                <span class="s4">yield None</span>
                            <span class="s4">else</span><span class="s2">:</span>
                                <span class="s1">key </span><span class="s2">= </span><span class="s3">'&lt;unknown key&gt;'</span>
                            <span class="s1">cycleBySyntax </span><span class="s2">+= </span><span class="s3">'%s}' </span><span class="s2">% </span><span class="s1">fastRepr</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
                            <span class="s1">objAlreadyRepresented </span><span class="s2">= </span><span class="s4">True</span>
                        <span class="s4">elif </span><span class="s1">type</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">) </span><span class="s4">in </span><span class="s2">(</span><span class="s1">tuple</span><span class="s2">, </span><span class="s1">list</span><span class="s2">):</span>
                            <span class="s1">brackets </span><span class="s2">= {</span>
                                <span class="s1">tuple</span><span class="s2">: </span><span class="s3">'()'</span><span class="s2">,</span>
                                <span class="s1">list</span><span class="s2">: </span><span class="s3">'[]'</span><span class="s2">,</span>
                                <span class="s2">}[</span><span class="s1">type</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)]</span>
                            <span class="s6"># get object being referenced by container</span>
                            <span class="s1">nextObj </span><span class="s2">= </span><span class="s1">objs</span><span class="s2">[</span><span class="s1">index</span><span class="s2">+</span><span class="s5">1</span><span class="s2">]</span>
                            <span class="s1">cycleBySyntax </span><span class="s2">+= </span><span class="s1">brackets</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
                            <span class="s4">for </span><span class="s1">index </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)):</span>
                                <span class="s4">if </span><span class="s1">obj</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] </span><span class="s4">is </span><span class="s1">nextObj</span><span class="s2">:</span>
                                    <span class="s1">index </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">index</span><span class="s2">)</span>
                                    <span class="s4">break</span>
                                <span class="s4">yield None</span>
                            <span class="s4">else</span><span class="s2">:</span>
                                <span class="s1">index </span><span class="s2">= </span><span class="s3">'&lt;unknown index&gt;'</span>
                            <span class="s1">cycleBySyntax </span><span class="s2">+= </span><span class="s3">'%s%s' </span><span class="s2">% (</span><span class="s1">index</span><span class="s2">, </span><span class="s1">brackets</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>
                            <span class="s1">objAlreadyRepresented </span><span class="s2">= </span><span class="s4">True</span>
                        <span class="s4">else</span><span class="s2">:</span>
                            <span class="s1">cycleBySyntax </span><span class="s2">+= </span><span class="s3">'%s --&gt; ' </span><span class="s2">% </span><span class="s1">itype</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
                            <span class="s1">objAlreadyRepresented </span><span class="s2">= </span><span class="s4">False</span>
                    <span class="s1">newCyclesBySyntax</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">cycleBySyntax</span><span class="s2">)</span>
                    <span class="s4">yield None</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cyclesBySyntax</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">newCyclesBySyntax</span><span class="s2">)</span>
                <span class="s6"># if we're not doing a full report, add this cycle's IDs to the master set</span>
                <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">fullReport</span><span class="s2">:</span>
                    <span class="s4">for </span><span class="s1">cycle </span><span class="s4">in </span><span class="s1">newCycles</span><span class="s2">:</span>
                        <span class="s4">yield None</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">cycleIds</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">cycle</span><span class="s2">))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">numCycles </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cycles</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">findCycles</span><span class="s2">:</span>
            <span class="s1">s </span><span class="s2">= [</span><span class="s3">'===== GarbageReport: </span><span class="s4">\'</span><span class="s3">%s</span><span class="s4">\' </span><span class="s3">(%s %s) =====' </span><span class="s2">% (</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">numCycles</span><span class="s2">,</span>
                <span class="s2">(</span><span class="s3">'cycle' </span><span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">numCycles </span><span class="s2">== </span><span class="s5">1 </span><span class="s4">else </span><span class="s3">'cycles'</span><span class="s2">))]</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">s </span><span class="s2">= [</span><span class="s3">'===== GarbageReport: </span><span class="s4">\'</span><span class="s3">%s</span><span class="s4">\' </span><span class="s3">=====' </span><span class="s2">% (</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)]</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">numGarbage </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s6"># make a list of the ids we will actually be printing</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">fullReport</span><span class="s2">:</span>
                <span class="s1">garbageIndices </span><span class="s2">= </span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">numGarbage</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">garbageIndices </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cycleIds</span><span class="s2">)</span>
                <span class="s1">garbageIndices</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">()</span>
            <span class="s1">numGarbage </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">garbageIndices</span><span class="s2">)</span>

            <span class="s6"># log each individual item with a number in front of it</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">fullReport</span><span class="s2">:</span>
                <span class="s1">abbrev </span><span class="s2">= </span><span class="s3">'(abbreviated) '</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">abbrev </span><span class="s2">= </span><span class="s3">''</span>
            <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'===== Garbage Items %s=====' </span><span class="s2">% </span><span class="s1">abbrev</span><span class="s2">)</span>
            <span class="s1">digits </span><span class="s2">= </span><span class="s5">0</span>
            <span class="s1">n </span><span class="s2">= </span><span class="s1">numGarbage</span>
            <span class="s4">while </span><span class="s1">n </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s4">yield None</span>
                <span class="s1">digits </span><span class="s2">+= </span><span class="s5">1</span>
                <span class="s1">n </span><span class="s2">= </span><span class="s1">n </span><span class="s2">// </span><span class="s5">10</span>
            <span class="s1">digits </span><span class="s2">= </span><span class="s1">digits</span>
            <span class="s1">format </span><span class="s2">= </span><span class="s3">'%0' </span><span class="s2">+ </span><span class="s3">'%s' </span><span class="s2">% </span><span class="s1">digits </span><span class="s2">+ </span><span class="s3">'i:%s </span><span class="s4">\t</span><span class="s3">%s'</span>

            <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">numGarbage</span><span class="s2">):</span>
                <span class="s4">yield None</span>
                <span class="s1">idx </span><span class="s2">= </span><span class="s1">garbageIndices</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">safeMode</span><span class="s2">:</span>
                    <span class="s6"># in safe mode, don't try to repr any of the objects</span>
                    <span class="s1">objStr </span><span class="s2">= </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">itype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]))</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">objStr </span><span class="s2">= </span><span class="s1">fastRepr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">])</span>
                <span class="s1">maxLen </span><span class="s2">= </span><span class="s5">5000</span>
                <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">objStr</span><span class="s2">) &gt; </span><span class="s1">maxLen</span><span class="s2">:</span>
                    <span class="s1">snip </span><span class="s2">= </span><span class="s3">'&lt;SNIP&gt;'</span>
                    <span class="s1">objStr </span><span class="s2">= </span><span class="s3">'%s%s' </span><span class="s2">% (</span><span class="s1">objStr</span><span class="s2">[:(</span><span class="s1">maxLen</span><span class="s2">-</span><span class="s1">len</span><span class="s2">(</span><span class="s1">snip</span><span class="s2">))], </span><span class="s1">snip</span><span class="s2">)</span>
                <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">format </span><span class="s2">% (</span><span class="s1">idx</span><span class="s2">, </span><span class="s1">itype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]), </span><span class="s1">objStr</span><span class="s2">))</span>

            <span class="s6"># also log the types of the objects</span>
            <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'===== Garbage Item Types %s=====' </span><span class="s2">% </span><span class="s1">abbrev</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">numGarbage</span><span class="s2">):</span>
                <span class="s4">yield None</span>
                <span class="s1">idx </span><span class="s2">= </span><span class="s1">garbageIndices</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
                <span class="s1">objStr </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">deeptype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]))</span>
                <span class="s1">maxLen </span><span class="s2">= </span><span class="s5">5000</span>
                <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">objStr</span><span class="s2">) &gt; </span><span class="s1">maxLen</span><span class="s2">:</span>
                    <span class="s1">snip </span><span class="s2">= </span><span class="s3">'&lt;SNIP&gt;'</span>
                    <span class="s1">objStr </span><span class="s2">= </span><span class="s3">'%s%s' </span><span class="s2">% (</span><span class="s1">objStr</span><span class="s2">[:(</span><span class="s1">maxLen</span><span class="s2">-</span><span class="s1">len</span><span class="s2">(</span><span class="s1">snip</span><span class="s2">))], </span><span class="s1">snip</span><span class="s2">)</span>
                <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">format </span><span class="s2">% (</span><span class="s1">idx</span><span class="s2">, </span><span class="s1">itype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]), </span><span class="s1">objStr</span><span class="s2">))</span>

            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">findCycles</span><span class="s2">:</span>
                <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'===== Garbage Cycles (Garbage Item Numbers) ====='</span><span class="s2">)</span>
                <span class="s1">ac </span><span class="s2">= </span><span class="s1">AlphabetCounter</span><span class="s2">()</span>
                <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">numCycles</span><span class="s2">):</span>
                    <span class="s4">yield None</span>
                    <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'%s:%s' </span><span class="s2">% (</span><span class="s1">ac</span><span class="s2">.</span><span class="s1">next</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cycles</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]))</span>

            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">findCycles</span><span class="s2">:</span>
                <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'===== Garbage Cycles (Python Syntax) ====='</span><span class="s2">)</span>
                <span class="s1">ac </span><span class="s2">= </span><span class="s1">AlphabetCounter</span><span class="s2">()</span>
                <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cyclesBySyntax</span><span class="s2">)):</span>
                    <span class="s4">yield None</span>
                    <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'%s:%s' </span><span class="s2">% (</span><span class="s1">ac</span><span class="s2">.</span><span class="s1">next</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cyclesBySyntax</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]))</span>

            <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2garbageInfo</span><span class="s2">):</span>
                <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'===== Garbage Custom Info ====='</span><span class="s2">)</span>
                <span class="s1">ac </span><span class="s2">= </span><span class="s1">AlphabetCounter</span><span class="s2">()</span>
                <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cyclesBySyntax</span><span class="s2">)):</span>
                    <span class="s4">yield None</span>
                    <span class="s1">counter </span><span class="s2">= </span><span class="s1">ac</span><span class="s2">.</span><span class="s1">next</span><span class="s2">()</span>
                    <span class="s1">_id </span><span class="s2">= </span><span class="s1">id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
                    <span class="s4">if </span><span class="s1">_id </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2garbageInfo</span><span class="s2">:</span>
                        <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'%s:%s' </span><span class="s2">% (</span><span class="s1">counter</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2garbageInfo</span><span class="s2">[</span><span class="s1">_id</span><span class="s2">]))</span>

            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">fullReport</span><span class="s2">:</span>
                <span class="s1">format </span><span class="s2">= </span><span class="s3">'%0' </span><span class="s2">+ </span><span class="s3">'%s' </span><span class="s2">% </span><span class="s1">digits </span><span class="s2">+ </span><span class="s3">'i:%s'</span>
                <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'===== Referrers By Number (what is referring to garbage item?) ====='</span><span class="s2">)</span>
                <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">numGarbage</span><span class="s2">):</span>
                    <span class="s4">yield None</span>
                    <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">format </span><span class="s2">% (</span><span class="s1">i</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">referrersByNumber</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]))</span>
                <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'===== Referents By Number (what is garbage item referring to?) ====='</span><span class="s2">)</span>
                <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">numGarbage</span><span class="s2">):</span>
                    <span class="s4">yield None</span>
                    <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">format </span><span class="s2">% (</span><span class="s1">i</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">referentsByNumber</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]))</span>
                <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'===== Referrers (what is referring to garbage item?) ====='</span><span class="s2">)</span>
                <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">numGarbage</span><span class="s2">):</span>
                    <span class="s4">yield None</span>
                    <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">format </span><span class="s2">% (</span><span class="s1">i</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">referrersByReference</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]))</span>
                <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'===== Referents (what is garbage item referring to?) ====='</span><span class="s2">)</span>
                <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">numGarbage</span><span class="s2">):</span>
                    <span class="s4">yield None</span>
                    <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">format </span><span class="s2">% (</span><span class="s1">i</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">referentsByReference</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_report </span><span class="s2">= </span><span class="s1">s</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">log</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">printingBegin</span><span class="s2">()</span>
            <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_report</span><span class="s2">)):</span>
                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">numGarbage </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
                    <span class="s4">yield None</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_report</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">'===== Garbage Report Done ====='</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">printingEnd</span><span class="s2">()</span>

        <span class="s4">yield </span><span class="s1">Job</span><span class="s2">.</span><span class="s1">Done</span>

    <span class="s4">def </span><span class="s1">finished</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">doneCallback</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">doneCallback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">autoDestroy</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">#print 'GarbageReport.destroy'</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span>
        <span class="s6"># don't get rid of these, we might need them</span>
        <span class="s6">#del self.numGarbage</span>
        <span class="s6">#del self.numCycles</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">referrersByReference</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">referrersByNumber</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">referentsByReference</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">referentsByNumber</span>
        <span class="s4">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'cycles'</span><span class="s2">):</span>
            <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cycles</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_report</span>
        <span class="s4">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'_reportStr'</span><span class="s2">):</span>
            <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_reportStr</span>
        <span class="s1">Job</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">getNumCycles</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># if the job hasn't run yet, we don't have a numCycles yet</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">numCycles</span>

    <span class="s4">def </span><span class="s1">getDesc2numDict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># dict of python-syntax leak -&gt; number of that type of leak</span>
        <span class="s1">desc2num </span><span class="s2">= {}</span>
        <span class="s4">for </span><span class="s1">cycleBySyntax </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cyclesBySyntax</span><span class="s2">:</span>
            <span class="s1">desc2num</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">cycleBySyntax</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
            <span class="s1">desc2num</span><span class="s2">[</span><span class="s1">cycleBySyntax</span><span class="s2">] += </span><span class="s5">1</span>
        <span class="s4">return </span><span class="s1">desc2num</span>

    <span class="s4">def </span><span class="s1">getGarbage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span>

    <span class="s4">def </span><span class="s1">getReport</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'_reportStr'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_reportStr </span><span class="s2">= </span><span class="s3">''</span>
            <span class="s4">for </span><span class="s1">str </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_report</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_reportStr </span><span class="s2">+= </span><span class="s3">'</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">+ </span><span class="s1">str</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_reportStr</span>

    <span class="s4">def </span><span class="s1">_getReferrers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s6"># referrers (pointing to garbage)</span>
        <span class="s6"># returns two lists, first by index into gc.garbage, second by</span>
        <span class="s6"># direct reference</span>
        <span class="s4">yield None</span>
        <span class="s1">byRef </span><span class="s2">= </span><span class="s1">gc</span><span class="s2">.</span><span class="s1">get_referrers</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s4">yield None</span>
        <span class="s6"># look to see if each referrer is another garbage item</span>
        <span class="s1">byNum </span><span class="s2">= []</span>
        <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">byRef</span><span class="s2">)):</span>
            <span class="s4">if not </span><span class="s2">(</span><span class="s1">i </span><span class="s2">% </span><span class="s5">20</span><span class="s2">):</span>
                <span class="s4">yield None</span>
            <span class="s1">referrer </span><span class="s2">= </span><span class="s1">byRef</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s1">num </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2index</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">id</span><span class="s2">(</span><span class="s1">referrer</span><span class="s2">), </span><span class="s4">None</span><span class="s2">)</span>
            <span class="s1">byNum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">num</span><span class="s2">)</span>
        <span class="s4">yield </span><span class="s1">byNum</span><span class="s2">, </span><span class="s1">byRef</span>

    <span class="s4">def </span><span class="s1">_getReferents</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s6"># referents (pointed to by garbage)</span>
        <span class="s6"># returns two lists, first by index into gc.garbage, second by</span>
        <span class="s6"># direct reference</span>
        <span class="s4">yield None</span>
        <span class="s1">byRef </span><span class="s2">= </span><span class="s1">gc</span><span class="s2">.</span><span class="s1">get_referents</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s4">yield None</span>
        <span class="s6"># look to see if each referent is another garbage item</span>
        <span class="s1">byNum </span><span class="s2">= []</span>
        <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">byRef</span><span class="s2">)):</span>
            <span class="s4">if not </span><span class="s2">(</span><span class="s1">i </span><span class="s2">% </span><span class="s5">20</span><span class="s2">):</span>
                <span class="s4">yield None</span>
            <span class="s1">referent </span><span class="s2">= </span><span class="s1">byRef</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s1">num </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2index</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">id</span><span class="s2">(</span><span class="s1">referent</span><span class="s2">), </span><span class="s4">None</span><span class="s2">)</span>
            <span class="s1">byNum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">num</span><span class="s2">)</span>
        <span class="s4">yield </span><span class="s1">byNum</span><span class="s2">, </span><span class="s1">byRef</span>

    <span class="s4">def </span><span class="s1">_getNormalizedCycle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cycle</span><span class="s2">):</span>
        <span class="s6"># returns a representation of a cycle (list of indices) that will be</span>
        <span class="s6"># reliably derived from a unique cycle regardless of ordering</span>
        <span class="s6"># this lets us detect duplicate cycles that appear different because of</span>
        <span class="s6"># which element appears first</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">cycle</span><span class="s2">) == </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">cycle</span>
        <span class="s1">min </span><span class="s2">= </span><span class="s5">1</span><span class="s2">&lt;&lt;</span><span class="s5">30</span>
        <span class="s1">minIndex </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">cycle</span><span class="s2">)):</span>
            <span class="s1">elem </span><span class="s2">= </span><span class="s1">cycle</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s4">if </span><span class="s1">elem </span><span class="s2">&lt; </span><span class="s1">min</span><span class="s2">:</span>
                <span class="s1">min </span><span class="s2">= </span><span class="s1">elem</span>
                <span class="s1">minIndex </span><span class="s2">= </span><span class="s1">i</span>
        <span class="s4">return </span><span class="s1">cycle</span><span class="s2">[</span><span class="s1">minIndex</span><span class="s2">:] + </span><span class="s1">cycle</span><span class="s2">[:</span><span class="s1">minIndex</span><span class="s2">]</span>

    <span class="s4">def </span><span class="s1">_getCycles</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">uniqueCycleSets</span><span class="s2">=</span><span class="s4">None</span><span class="s2">):</span>
        <span class="s6"># detect garbage cycles for a particular item of garbage</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debugCall</span><span class="s2">()</span>
        <span class="s6"># returns list of lists, sublists are garbage reference cycles</span>
        <span class="s1">cycles </span><span class="s2">= []</span>
        <span class="s6"># this lets us eliminate duplicate cycles</span>
        <span class="s4">if </span><span class="s1">uniqueCycleSets </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">uniqueCycleSets </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s1">stateStack </span><span class="s2">= </span><span class="s1">Stack</span><span class="s2">()</span>
        <span class="s1">rootId </span><span class="s2">= </span><span class="s1">index</span>
        <span class="s6"># check if the root object is one of the garbage instances (has __del__)</span>
        <span class="s1">objId </span><span class="s2">= </span><span class="s1">id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[</span><span class="s1">rootId</span><span class="s2">])</span>
        <span class="s1">numDelInstances </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">objId </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbageInstanceIds</span><span class="s2">)</span>
        <span class="s1">stateStack</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(([</span><span class="s1">rootId</span><span class="s2">], </span><span class="s1">rootId</span><span class="s2">, </span><span class="s1">numDelInstances</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
        <span class="s4">while True</span><span class="s2">:</span>
            <span class="s4">yield None</span>
            <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">stateStack</span><span class="s2">) == </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s4">break</span>
            <span class="s1">candidateCycle</span><span class="s2">, </span><span class="s1">curId</span><span class="s2">, </span><span class="s1">numDelInstances</span><span class="s2">, </span><span class="s1">resumeIndex </span><span class="s2">= </span><span class="s1">stateStack</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">getDebug</span><span class="s2">():</span>
                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">delOnly</span><span class="s2">:</span>
                    <span class="s1">print</span><span class="s2">(</span><span class="s3">'restart: %s root=%s cur=%s numDelInstances=%s resume=%s' </span><span class="s2">% (</span>
                        <span class="s1">candidateCycle</span><span class="s2">, </span><span class="s1">rootId</span><span class="s2">, </span><span class="s1">curId</span><span class="s2">, </span><span class="s1">numDelInstances</span><span class="s2">, </span><span class="s1">resumeIndex</span><span class="s2">))</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">print</span><span class="s2">(</span><span class="s3">'restart: %s root=%s cur=%s resume=%s' </span><span class="s2">% (</span>
                        <span class="s1">candidateCycle</span><span class="s2">, </span><span class="s1">rootId</span><span class="s2">, </span><span class="s1">curId</span><span class="s2">, </span><span class="s1">resumeIndex</span><span class="s2">))</span>
            <span class="s4">for </span><span class="s1">index </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">resumeIndex</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">referentsByNumber</span><span class="s2">[</span><span class="s1">curId</span><span class="s2">])):</span>
                <span class="s4">yield None</span>
                <span class="s1">refId </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">referentsByNumber</span><span class="s2">[</span><span class="s1">curId</span><span class="s2">][</span><span class="s1">index</span><span class="s2">]</span>
                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">getDebug</span><span class="s2">():</span>
                    <span class="s1">print</span><span class="s2">(</span><span class="s3">'       : %s -&gt; %s' </span><span class="s2">% (</span><span class="s1">curId</span><span class="s2">, </span><span class="s1">refId</span><span class="s2">))</span>
                <span class="s4">if </span><span class="s1">refId </span><span class="s2">== </span><span class="s1">rootId</span><span class="s2">:</span>
                    <span class="s6"># we found a cycle! mark it down and move on to the next refId</span>
                    <span class="s1">normCandidateCycle </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_getNormalizedCycle</span><span class="s2">(</span><span class="s1">candidateCycle</span><span class="s2">)</span>
                    <span class="s1">normCandidateCycleTuple </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">normCandidateCycle</span><span class="s2">)</span>
                    <span class="s4">if not </span><span class="s1">normCandidateCycleTuple </span><span class="s4">in </span><span class="s1">uniqueCycleSets</span><span class="s2">:</span>
                        <span class="s6"># cycles with no instances that define __del__ will be</span>
                        <span class="s6"># cleaned up by Python</span>
                        <span class="s4">if </span><span class="s2">(</span><span class="s4">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">delOnly</span><span class="s2">) </span><span class="s4">or </span><span class="s1">numDelInstances </span><span class="s2">&gt;= </span><span class="s5">1</span><span class="s2">:</span>
                            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">getDebug</span><span class="s2">():</span>
                                <span class="s1">print</span><span class="s2">(</span><span class="s3">'  FOUND: '</span><span class="s2">, </span><span class="s1">normCandidateCycle </span><span class="s2">+ [</span><span class="s1">normCandidateCycle</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],])</span>
                            <span class="s1">cycles</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">normCandidateCycle </span><span class="s2">+ [</span><span class="s1">normCandidateCycle</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],])</span>
                            <span class="s1">uniqueCycleSets</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">normCandidateCycleTuple</span><span class="s2">)</span>
                <span class="s4">elif </span><span class="s1">refId </span><span class="s4">in </span><span class="s1">candidateCycle</span><span class="s2">:</span>
                    <span class="s4">pass</span>
                <span class="s4">elif </span><span class="s1">refId </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s6"># check if this object is one of the garbage instances (has __del__)</span>
                    <span class="s1">objId </span><span class="s2">= </span><span class="s1">id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">[</span><span class="s1">refId</span><span class="s2">])</span>
                    <span class="s1">numDelInstances </span><span class="s2">+= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">objId </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">garbageInstanceIds</span><span class="s2">)</span>
                    <span class="s6"># this refId does not complete a cycle. Mark down</span>
                    <span class="s6"># where we are in this list of referents, then</span>
                    <span class="s6"># start looking through the referents of the new refId</span>
                    <span class="s1">stateStack</span><span class="s2">.</span><span class="s1">push</span><span class="s2">((</span><span class="s1">list</span><span class="s2">(</span><span class="s1">candidateCycle</span><span class="s2">), </span><span class="s1">curId</span><span class="s2">, </span><span class="s1">numDelInstances</span><span class="s2">, </span><span class="s1">index</span><span class="s2">+</span><span class="s5">1</span><span class="s2">))</span>
                    <span class="s1">stateStack</span><span class="s2">.</span><span class="s1">push</span><span class="s2">((</span><span class="s1">list</span><span class="s2">(</span><span class="s1">candidateCycle</span><span class="s2">) + [</span><span class="s1">refId</span><span class="s2">], </span><span class="s1">refId</span><span class="s2">, </span><span class="s1">numDelInstances</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
                    <span class="s4">break</span>
        <span class="s4">yield </span><span class="s1">cycles</span>

<span class="s4">class </span><span class="s1">GarbageLogger</span><span class="s2">(</span><span class="s1">GarbageReport</span><span class="s2">):</span>
    <span class="s0">&quot;&quot;&quot;If you just want to log the current garbage to the log file, make 
    one of these. It automatically destroys itself after logging&quot;&quot;&quot;</span>
    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kArgs</span><span class="s2">):</span>
        <span class="s1">kArgs</span><span class="s2">[</span><span class="s3">'log'</span><span class="s2">] = </span><span class="s4">True</span>
        <span class="s1">kArgs</span><span class="s2">[</span><span class="s3">'autoDestroy'</span><span class="s2">] = </span><span class="s4">True</span>
        <span class="s1">GarbageReport</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kArgs</span><span class="s2">)</span>

<span class="s4">class </span><span class="s1">_CFGLGlobals</span><span class="s2">:</span>
    <span class="s6"># for checkForGarbageLeaks</span>
    <span class="s1">LastNumGarbage </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">LastNumCycles </span><span class="s2">= </span><span class="s5">0</span>

<span class="s4">def </span><span class="s1">checkForGarbageLeaks</span><span class="s2">():</span>
    <span class="s1">gc</span><span class="s2">.</span><span class="s1">collect</span><span class="s2">()</span>
    <span class="s1">numGarbage </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">gc</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">)</span>
    <span class="s4">if </span><span class="s1">numGarbage </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s4">and </span><span class="s1">ConfigVariableBool</span><span class="s2">(</span><span class="s3">'auto-garbage-logging'</span><span class="s2">, </span><span class="s4">False</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s2">(</span><span class="s1">numGarbage </span><span class="s2">!= </span><span class="s1">_CFGLGlobals</span><span class="s2">.</span><span class="s1">LastNumGarbage</span><span class="s2">):</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
            <span class="s1">gr </span><span class="s2">= </span><span class="s1">GarbageReport</span><span class="s2">(</span><span class="s3">'found garbage'</span><span class="s2">, </span><span class="s1">threaded</span><span class="s2">=</span><span class="s4">False</span><span class="s2">, </span><span class="s1">collect</span><span class="s2">=</span><span class="s4">False</span><span class="s2">)</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
            <span class="s1">_CFGLGlobals</span><span class="s2">.</span><span class="s1">LastNumGarbage </span><span class="s2">= </span><span class="s1">numGarbage</span>
            <span class="s1">_CFGLGlobals</span><span class="s2">.</span><span class="s1">LastNumCycles </span><span class="s2">= </span><span class="s1">gr</span><span class="s2">.</span><span class="s1">getNumCycles</span><span class="s2">()</span>
            <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">GarbageCycleCountAnnounceEvent</span><span class="s2">, [</span><span class="s1">gr</span><span class="s2">.</span><span class="s1">getDesc2numDict</span><span class="s2">()])</span>
            <span class="s1">gr</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
        <span class="s1">notify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s3">&quot;GarbageDetect&quot;</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">ConfigVariableBool</span><span class="s2">(</span><span class="s3">'allow-garbage-cycles'</span><span class="s2">, </span><span class="s4">True</span><span class="s2">):</span>
            <span class="s1">func </span><span class="s2">= </span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">func </span><span class="s2">= </span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span>
        <span class="s1">func</span><span class="s2">(</span><span class="s3">'%s garbage cycles found, see info above' </span><span class="s2">% </span><span class="s1">_CFGLGlobals</span><span class="s2">.</span><span class="s1">LastNumCycles</span><span class="s2">)</span>
    <span class="s4">return </span><span class="s1">numGarbage</span>

<span class="s4">def </span><span class="s1">b_checkForGarbageLeaks</span><span class="s2">(</span><span class="s1">wantReply</span><span class="s2">=</span><span class="s4">False</span><span class="s2">):</span>
    <span class="s4">if not </span><span class="s1">__dev__</span><span class="s2">:</span>
        <span class="s4">return </span><span class="s5">0</span>
    <span class="s6"># does a garbage collect on the client and the AI</span>
    <span class="s6"># returns number of client garbage leaks</span>
    <span class="s6"># logs leak info and terminates (if configured to do so)</span>
    <span class="s4">try</span><span class="s2">:</span>
        <span class="s6"># if this is the client, tell the AI to check for leaks too</span>
        <span class="s1">base</span><span class="s2">.</span><span class="s1">cr</span><span class="s2">.</span><span class="s1">timeManager</span>
    <span class="s4">except</span><span class="s2">:</span>
        <span class="s4">pass</span>
    <span class="s4">else</span><span class="s2">:</span>
        <span class="s4">if </span><span class="s1">base</span><span class="s2">.</span><span class="s1">cr</span><span class="s2">.</span><span class="s1">timeManager</span><span class="s2">:</span>
            <span class="s1">base</span><span class="s2">.</span><span class="s1">cr</span><span class="s2">.</span><span class="s1">timeManager</span><span class="s2">.</span><span class="s1">d_checkForGarbageLeaks</span><span class="s2">(</span><span class="s1">wantReply</span><span class="s2">=</span><span class="s1">wantReply</span><span class="s2">)</span>
    <span class="s4">return </span><span class="s1">checkForGarbageLeaks</span><span class="s2">()</span>
</pre>
</body>
</html>