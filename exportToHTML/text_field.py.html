<html>
<head>
<title>text_field.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
text_field.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">ursina </span><span class="s0">import </span><span class="s1">Entity</span><span class="s2">, </span><span class="s1">camera</span><span class="s2">, </span><span class="s1">Text</span><span class="s2">, </span><span class="s1">Vec2</span><span class="s2">, </span><span class="s1">mouse</span><span class="s2">, </span><span class="s1">color</span><span class="s2">, </span><span class="s1">floor</span><span class="s2">, </span><span class="s1">clamp</span><span class="s2">, </span><span class="s1">time</span><span class="s2">, </span><span class="s1">held_keys</span><span class="s2">, </span><span class="s1">destroy</span>
<span class="s0">import </span><span class="s1">pyperclip</span>

<span class="s0">from </span><span class="s1">ursina</span><span class="s2">.</span><span class="s1">string_utilities </span><span class="s0">import </span><span class="s1">multireplace</span>
<span class="s3"># from tree_view import TreeView</span>


<span class="s0">class </span><span class="s1">TextField</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">max_lines</span><span class="s2">=</span><span class="s4">64</span><span class="s2">, </span><span class="s1">line_height</span><span class="s2">=</span><span class="s4">1.1</span><span class="s2">, </span><span class="s1">character_limit</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">camera</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">, </span><span class="s1">x</span><span class="s2">=-</span><span class="s4">.5</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s4">.4</span><span class="s2">, </span><span class="s1">ignore_paused</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">font </span><span class="s2">= </span><span class="s5">'VeraMono.ttf'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">line_height </span><span class="s2">= </span><span class="s1">line_height</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">max_lines </span><span class="s2">= </span><span class="s1">max_lines</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">character_limit </span><span class="s2">= </span><span class="s1">character_limit</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_parent </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text_entity </span><span class="s2">= </span><span class="s1">Text</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_parent</span><span class="s2">, </span><span class="s1">start_tag</span><span class="s2">=</span><span class="s5">'☾'</span><span class="s2">, </span><span class="s1">end_tag</span><span class="s2">=</span><span class="s5">'☽'</span><span class="s2">, </span><span class="s1">font</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">font</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s5">''</span><span class="s2">, </span><span class="s1">line_height</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">line_height</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">, </span><span class="s4">.5</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">line_numbers </span><span class="s2">= </span><span class="s1">Text</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_parent</span><span class="s2">, </span><span class="s1">font</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">font</span><span class="s2">, </span><span class="s1">line_height</span><span class="s2">=</span><span class="s1">line_height</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s5">'0'</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">x</span><span class="s2">=-</span><span class="s4">.04</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">gray</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">character_width </span><span class="s2">= </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">get_width</span><span class="s2">(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">font</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">font</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor_parent </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_parent</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">character_width</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">*</span><span class="s1">Text</span><span class="s2">.</span><span class="s1">size</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">line_height</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s5">'text_field_cursor'</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor_parent</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s5">'cube'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">cyan</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">, -</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">scale</span><span class="s2">=(</span><span class="s4">.1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">blink</span><span class="s2">(</span><span class="s1">duration</span><span class="s2">=</span><span class="s4">1.2</span><span class="s2">, </span><span class="s1">loop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bg </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s5">'text_field_bg'</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s5">'quad'</span><span class="s2">, </span><span class="s1">double_sided</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">dark_gray</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">z</span><span class="s2">=</span><span class="s4">0.005</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=(</span><span class="s4">120</span><span class="s2">, </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">size</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_lines</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">line_height</span><span class="s2">), </span><span class="s1">collider</span><span class="s2">=</span><span class="s5">'box'</span><span class="s2">, </span><span class="s1">visible</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">selection_parent </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s5">'text_field_selection_parent'</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor_parent</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">register_mouse_input </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">world_space_mouse </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">triple_click_delay </span><span class="s2">= </span><span class="s4">0.3</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_last_double_click </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_amount </span><span class="s2">= </span><span class="s4">2</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_prev_scroll </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">active </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">highlight_color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">color</span><span class="s2">(</span><span class="s4">120</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">.1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s5">''</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">delimiters </span><span class="s2">= </span><span class="s5">' .,!?;:(){}[]&lt;&gt;</span><span class="s0">\'\&quot;</span><span class="s5">@#$%^&amp;*+=-</span><span class="s0">\\</span><span class="s5">|/`~'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">replacements </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">on_undo </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">on_redo </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">on_value_changed </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts </span><span class="s2">= {</span>
            <span class="s5">'newline'</span><span class="s2">:          (</span><span class="s5">'enter'</span><span class="s2">, </span><span class="s5">'enter hold'</span><span class="s2">),</span>
            <span class="s5">'erase'</span><span class="s2">:            (</span><span class="s5">'backspace'</span><span class="s2">, </span><span class="s5">'backspace hold'</span><span class="s2">),</span>
            <span class="s5">'erase_word'</span><span class="s2">:       (</span><span class="s5">'ctrl+backspace'</span><span class="s2">, </span><span class="s5">'ctrl+backspace hold'</span><span class="s2">),</span>
            <span class="s5">'delete_line'</span><span class="s2">:      (</span><span class="s5">'ctrl+shift+k'</span><span class="s2">,),</span>
            <span class="s5">'duplicate_line'</span><span class="s2">:   (</span><span class="s5">'ctrl+shift+d'</span><span class="s2">,),</span>
            <span class="s5">'undo'</span><span class="s2">:             (</span><span class="s5">'ctrl+z'</span><span class="s2">, </span><span class="s5">'ctrl+z hold'</span><span class="s2">),</span>
            <span class="s5">'redo'</span><span class="s2">:             (</span><span class="s5">'ctrl+y'</span><span class="s2">, </span><span class="s5">'ctrl+y hold'</span><span class="s2">, </span><span class="s5">'ctrl+shift+z'</span><span class="s2">, </span><span class="s5">'ctrl+shift+z hold'</span><span class="s2">),</span>
            <span class="s3"># 'save':             ('ctrl+s',),</span>
            <span class="s3"># 'save_as':          ('ctrl+shift+s',),</span>
            <span class="s5">'indent'</span><span class="s2">:           (</span><span class="s5">'tab'</span><span class="s2">,),</span>
            <span class="s5">'dedent'</span><span class="s2">:           (</span><span class="s5">'shift+tab'</span><span class="s2">,),</span>
            <span class="s5">'move_line_down'</span><span class="s2">:   (</span><span class="s5">'ctrl+down arrow'</span><span class="s2">, </span><span class="s5">'ctrl+down arrow hold'</span><span class="s2">),</span>
            <span class="s5">'move_line_up'</span><span class="s2">:     (</span><span class="s5">'ctrl+up arrow'</span><span class="s2">, </span><span class="s5">'ctrl+up arrow hold'</span><span class="s2">),</span>
            <span class="s5">'scroll_up'</span><span class="s2">:        (</span><span class="s5">'scroll up'</span><span class="s2">,),</span>
            <span class="s5">'scroll_down'</span><span class="s2">:      (</span><span class="s5">'scroll down'</span><span class="s2">,),</span>
            <span class="s5">'cut'</span><span class="s2">:              (</span><span class="s5">'ctrl+x'</span><span class="s2">,),</span>
            <span class="s5">'copy'</span><span class="s2">:             (</span><span class="s5">'ctrl+c'</span><span class="s2">,),</span>
            <span class="s5">'paste'</span><span class="s2">:            (</span><span class="s5">'ctrl+v'</span><span class="s2">,),</span>
            <span class="s5">'select_all'</span><span class="s2">:       (</span><span class="s5">'ctrl+a'</span><span class="s2">,),</span>
            <span class="s5">'select_word'</span><span class="s2">:      (</span><span class="s5">'double click'</span><span class="s2">,),</span>
            <span class="s5">'select_line'</span><span class="s2">:      (</span><span class="s5">'triple click'</span><span class="s2">,),</span>
            <span class="s3"># 'toggle_comment':   ('ctrl+alt+c',),</span>
            <span class="s3"># 'find':             ('ctrl+f',),</span>
            <span class="s5">'move_operations' </span><span class="s2">: {</span>
                <span class="s5">'move_left'</span><span class="s2">:                (</span><span class="s5">'left arrow'</span><span class="s2">, </span><span class="s5">'left arrow hold'</span><span class="s2">, </span><span class="s5">'shift+left arrow'</span><span class="s2">, </span><span class="s5">'shift+left arrow hold'</span><span class="s2">),</span>
                <span class="s5">'move_right'</span><span class="s2">:               (</span><span class="s5">'right arrow'</span><span class="s2">, </span><span class="s5">'right arrow hold'</span><span class="s2">, </span><span class="s5">'shift+right arrow'</span><span class="s2">, </span><span class="s5">'shift+right arrow hold'</span><span class="s2">),</span>
                <span class="s5">'move_up'</span><span class="s2">:                  (</span><span class="s5">'up arrow'</span><span class="s2">, </span><span class="s5">'up arrow hold'</span><span class="s2">, </span><span class="s5">'shift+up arrow'</span><span class="s2">, </span><span class="s5">'shift+up arrow hold'</span><span class="s2">),</span>
                <span class="s5">'move_down'</span><span class="s2">:                (</span><span class="s5">'down arrow'</span><span class="s2">, </span><span class="s5">'down arrow hold'</span><span class="s2">, </span><span class="s5">'shift+down arrow'</span><span class="s2">, </span><span class="s5">'shift+down arrow hold'</span><span class="s2">),</span>
                <span class="s5">'move_to_end_of_word' </span><span class="s2">:     (</span><span class="s5">'ctrl+right arrow'</span><span class="s2">, </span><span class="s5">'ctrl+right arrow hold'</span><span class="s2">, </span><span class="s5">'ctrl+shift+right arrow'</span><span class="s2">, </span><span class="s5">'ctrl+shift+right arrow hold'</span><span class="s2">),</span>
                <span class="s5">'move_to_start_of_word' </span><span class="s2">:   (</span><span class="s5">'ctrl+left arrow'</span><span class="s2">, </span><span class="s5">'ctrl+left arrow hold'</span><span class="s2">, </span><span class="s5">'ctrl+shift+left arrow'</span><span class="s2">, </span><span class="s5">'ctrl+shift+left arrow hold'</span><span class="s2">),</span>
            <span class="s2">},</span>

            <span class="s3"># 'select_word_left': ('ctrl+shift+left arrow', 'ctrl+shift+left arrow hold'),</span>
            <span class="s3"># 'select_word_right': ('ctrl+shift+right arrow', 'ctrl+shift+right arrow hold'),</span>
        <span class="s2">}</span>
        <span class="s0">def </span><span class="s1">middle_click_input</span><span class="s2">(</span><span class="s1">key</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">register_mouse_input</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s5">'middle mouse down'</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">middle_click_scroller</span><span class="s2">.</span><span class="s1">start_y </span><span class="s2">= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">y</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_original_scroll_amount </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_amount</span>
                <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s5">'middle mouse up' </span><span class="s0">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s5">'_original_scroll_amount'</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">middle_click_scroller</span><span class="s2">.</span><span class="s1">start_y </span><span class="s2">= </span><span class="s0">None</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_amount </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_original_scroll_amount</span>

        <span class="s0">def </span><span class="s1">middle_click_update</span><span class="s2">():</span>
            <span class="s0">if not </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">middle </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">middle_click_scroller</span><span class="s2">.</span><span class="s1">start_y </span><span class="s2">== </span><span class="s0">None</span><span class="s2">:</span>
                <span class="s0">return</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">middle_click_scroller</span><span class="s2">.</span><span class="s1">t </span><span class="s2">+= </span><span class="s1">time</span><span class="s2">.</span><span class="s1">dt</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">middle_click_scroller</span><span class="s2">.</span><span class="s1">t </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">middle_click_scroller</span><span class="s2">.</span><span class="s1">update_rate</span><span class="s2">:</span>
                <span class="s0">return</span>

            <span class="s3"># self.middle_click_scroller.update_rate = 1-mouse.delta_drag[0]</span>
            <span class="s3"># print('-aaaaaaaaaaa', 1-mouse.delta_drag[0])</span>
            <span class="s1">dist </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">y </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">middle_click_scroller</span><span class="s2">.</span><span class="s1">start_y</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_amount </span><span class="s2">= </span><span class="s4">1</span>
            <span class="s0">if </span><span class="s1">dist </span><span class="s2">&gt; </span><span class="s4">.1</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_amount </span><span class="s2">= </span><span class="s4">4</span>
            <span class="s0">elif </span><span class="s1">dist </span><span class="s2">&gt; </span><span class="s4">.2</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_amount </span><span class="s2">= </span><span class="s4">6</span>
            <span class="s3"># elif dist &gt; .4:</span>
            <span class="s3">#     self.scroll_amount = 12</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">middle_click_scroller</span><span class="s2">.</span><span class="s1">t </span><span class="s2">= </span><span class="s4">0</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">register_mouse_input</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">y </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">middle_click_scroller</span><span class="s2">.</span><span class="s1">start_y</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">input</span><span class="s2">(</span><span class="s5">'scroll down'</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">y </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">middle_click_scroller</span><span class="s2">.</span><span class="s1">start_y</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">input</span><span class="s2">(</span><span class="s5">'scroll up'</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">middle_click_scroller </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">start_y</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">input</span><span class="s2">=</span><span class="s1">middle_click_input</span><span class="s2">, </span><span class="s1">update</span><span class="s2">=</span><span class="s1">middle_click_update</span><span class="s2">, </span><span class="s1">t</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">update_rate</span><span class="s2">=</span><span class="s4">.05</span><span class="s2">)</span>


        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">setattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_prev_text </span><span class="s2">= </span><span class="s5">''</span>



    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">active</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_active</span>

    <span class="s2">@</span><span class="s1">active</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">active</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_active </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s1">value</span>

        <span class="s0">if not </span><span class="s1">value</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">draw_selection</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">add_text</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">move_cursor</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">rerender</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">character_limit </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">) &gt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">character_limit</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">lines </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">)</span>
        <span class="s1">l </span><span class="s2">= </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">]</span>
        <span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">] =  </span><span class="s1">l</span><span class="s2">[:</span><span class="s1">x</span><span class="s2">] + </span><span class="s1">s </span><span class="s2">+ </span><span class="s1">l</span><span class="s2">[</span><span class="s1">x</span><span class="s2">:]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_append_undo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">move_cursor</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">+= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">rerender</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_append_undo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">text</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">clear_redo </span><span class="s2">= </span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">clear_redo</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">on_redo</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">on_undo</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">text</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>


    <span class="s0">def </span><span class="s1">move_line</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">line_index</span><span class="s2">, </span><span class="s1">delta</span><span class="s2">, </span><span class="s1">move_cursor</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">start_y</span><span class="s2">, </span><span class="s1">end_y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">Y</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">!= [</span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)]:</span>
            <span class="s1">start_y </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">y</span><span class="s2">)</span>
            <span class="s1">end_y </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">lines </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">)</span>
        <span class="s3"># lines[line_index], lines[line_index+delta] = lines[line_index+delta], lines[line_index]</span>
        <span class="s3"># start = []</span>
        <span class="s3"># if start_y-1 &gt; 0:</span>

        <span class="s3">#     start = lines[:int(start_y-1)]</span>

        <span class="s1">middle </span><span class="s2">= </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">start_y</span><span class="s2">:</span><span class="s1">end_y</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s0">del </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">start_y</span><span class="s2">:</span><span class="s1">end_y</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">l </span><span class="s0">in </span><span class="s1">middle</span><span class="s2">[::</span><span class="s1">delta</span><span class="s2">]:</span>
            <span class="s1">lines</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">start_y</span><span class="s2">+</span><span class="s1">delta</span><span class="s2">, </span><span class="s1">l</span><span class="s2">)</span>
        <span class="s3"># end = lines[start_y+1:]</span>

        <span class="s3"># [print(e) for e in middle]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">+= </span><span class="s1">delta </span><span class="s2">* </span><span class="s1">move_cursor</span>
        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">y </span><span class="s2">+= </span><span class="s1">delta</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">draw_selection</span><span class="s2">()</span>

        <span class="s3"># if delta == 1:</span>
        <span class="s3">#     _ = start.pop()</span>
        <span class="s3">#     end.insert(0, _)</span>
        <span class="s3"># elif delta == -1:</span>
        <span class="s3">#     _ = end.pop(0)</span>
        <span class="s3">#     start.append(_)</span>
        <span class="s3">#</span>
        <span class="s3"># lines = start + middle + end</span>
        <span class="s3">#</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_append_undo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)</span>
        <span class="s3"># print('moved line')</span>


    <span class="s0">def </span><span class="s1">erase</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rerender</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s3"># if not self.selection or self.selection[0] == self.selection[1]:</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">x</span><span class="s2">+</span><span class="s1">y </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s1">lines </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">)</span>
        <span class="s1">l </span><span class="s2">= </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">]</span>
        <span class="s3"># delete \n and go to line above</span>
        <span class="s0">if </span><span class="s1">x </span><span class="s2">== </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">y </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s1">new_x </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">-</span><span class="s4">1</span><span class="s2">])</span>
            <span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">-</span><span class="s4">1</span><span class="s2">] += </span><span class="s1">l</span>
            <span class="s1">lines</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">new_x</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">-= </span><span class="s4">1</span>
        <span class="s3"># delete tab</span>
        <span class="s0">elif </span><span class="s1">l</span><span class="s2">[:</span><span class="s1">x</span><span class="s2">].</span><span class="s1">lstrip</span><span class="s2">() == </span><span class="s5">'' </span><span class="s0">and </span><span class="s1">x </span><span class="s2">&gt;=</span><span class="s4">4</span><span class="s2">:</span>
            <span class="s1">l </span><span class="s2">= </span><span class="s1">l</span><span class="s2">[</span><span class="s4">4</span><span class="s2">:]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">-= </span><span class="s4">4</span>
            <span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">] = </span><span class="s1">l</span>
        <span class="s3"># normal erase</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">removed </span><span class="s2">= </span><span class="s1">l</span><span class="s2">[</span><span class="s1">x</span><span class="s2">-</span><span class="s4">1</span><span class="s2">]</span>

            <span class="s1">l </span><span class="s2">= </span><span class="s1">l</span><span class="s2">[:</span><span class="s1">x</span><span class="s2">-</span><span class="s4">1</span><span class="s2">] + </span><span class="s1">l</span><span class="s2">[</span><span class="s1">x</span><span class="s2">:]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">-= </span><span class="s4">1</span>

            <span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">] = </span><span class="s1">l</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_append_undo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>

        <span class="s3"># else:   # delete selected</span>
        <span class="s3">#     self.delete_selected()</span>
        <span class="s3">#     lines = self.text.split('\n')</span>
        <span class="s3">#</span>
        <span class="s3">#     start_y = int(self.selection[0][1])</span>
        <span class="s3">#     end_y = int(self.selection[1][1])</span>
        <span class="s3">#</span>
        <span class="s3">#     if start_y == end_y:    # one line</span>
        <span class="s3">#         l = lines[start_y]</span>
        <span class="s3">#         start_x, end_x = int(self.selection[0][0]), int(self.selection[1][0])</span>
        <span class="s3">#         l = l[:start_x] + l[end_x:]</span>
        <span class="s3">#         lines[start_y] = l</span>
        <span class="s3">#         self.selection = (self.selection[0], self.selection[0])</span>
        <span class="s3">#         self.cursor.position = self.selection[0][0]</span>
                <span class="s3"># self.selection = None</span>
                <span class="s3"># self.selection[0][0],start_y),</span>
                <span class="s3"># ignore=True, scale_x=self.selection[1][0]-self.selection[0][0])</span>
            <span class="s3"># for y in range(int(self.selection[0][1]), int(self.selection[1][1])):</span>
            <span class="s3">#     lines.pop(y)</span>




        <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">rerender</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_ordered_selection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s0">return None</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">][</span><span class="s4">1</span><span class="s2">] &lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">] </span><span class="s0">or </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">][</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">] </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">][</span><span class="s4">0</span><span class="s2">] &lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">0</span><span class="s2">]):</span>
            <span class="s0">return </span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]]</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span>


    <span class="s0">def </span><span class="s1">delete_selected</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]:</span>
            <span class="s0">return</span>

        <span class="s1">sel </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ordered_selection</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= </span><span class="s1">sel</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">start_y </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">sel</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">end_y </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">sel</span><span class="s2">[</span><span class="s4">1</span><span class="s2">][</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">lines </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">)</span>

        <span class="s1">lines</span><span class="s2">[</span><span class="s1">start_y</span><span class="s2">] = </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">start_y</span><span class="s2">][:</span><span class="s1">int</span><span class="s2">(</span><span class="s1">sel</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">0</span><span class="s2">])] + </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">end_y</span><span class="s2">][</span><span class="s1">int</span><span class="s2">(</span><span class="s1">sel</span><span class="s2">[</span><span class="s4">1</span><span class="s2">][</span><span class="s4">0</span><span class="s2">]):]</span>
        <span class="s0">del </span><span class="s1">lines</span><span class="s2">[(</span><span class="s1">start_y </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">) : (</span><span class="s1">end_y </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_append_undo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">y</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)]</span>
        <span class="s3"># self._append_undo(self.text, y, x)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">draw_selection</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">get_selected</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]:</span>
            <span class="s0">return None</span>

        <span class="s1">sel </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ordered_selection</span><span class="s2">()</span>
        <span class="s1">start_y </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">sel</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">end_y </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">sel</span><span class="s2">[</span><span class="s4">1</span><span class="s2">][</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">lines </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">)</span>

        <span class="s1">selected_text </span><span class="s2">= </span><span class="s5">''</span>
        <span class="s3"># selected_text = lines[start_y][]</span>

        <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">start_y</span><span class="s2">, </span><span class="s1">end_y</span><span class="s2">+</span><span class="s4">1</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">y </span><span class="s2">&gt; </span><span class="s1">start_y</span><span class="s2">:</span>
                <span class="s1">selected_text </span><span class="s2">+= </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span>
            <span class="s1">selected_text </span><span class="s2">+= </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">][(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">sel</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">0</span><span class="s2">]) </span><span class="s0">if </span><span class="s1">y </span><span class="s2">== </span><span class="s1">start_y </span><span class="s0">else </span><span class="s4">0</span><span class="s2">) : (</span><span class="s1">int</span><span class="s2">(</span><span class="s1">sel</span><span class="s2">[</span><span class="s4">1</span><span class="s2">][</span><span class="s4">0</span><span class="s2">]) </span><span class="s0">if </span><span class="s1">y </span><span class="s2">== </span><span class="s1">end_y </span><span class="s0">else </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">])) ]</span>

        <span class="s0">return </span><span class="s1">selected_text</span>


    <span class="s0">def </span><span class="s1">get_mouse_position_unclamped</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">world_space_mouse</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">point</span><span class="s2">:</span>
                <span class="s1">x </span><span class="s2">= </span><span class="s1">round</span><span class="s2">(</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">point</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] * </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">scale_x</span><span class="s2">)</span>
                <span class="s1">y </span><span class="s2">= </span><span class="s1">floor</span><span class="s2">(</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">point</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] * </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">scale_y</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">x </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x</span><span class="s2">)</span>
                <span class="s1">y </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">y</span><span class="s2">)</span>

        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">mpos </span><span class="s2">= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">position</span>
            <span class="s1">mpos</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">mpos</span><span class="s2">.</span><span class="s1">x </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">world_scale_x </span><span class="s2">* </span><span class="s1">camera</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">.</span><span class="s1">world_scale_x</span>
            <span class="s1">mpos</span><span class="s2">.</span><span class="s1">y </span><span class="s2">= </span><span class="s1">mpos</span><span class="s2">.</span><span class="s1">y </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">world_scale_y </span><span class="s2">* </span><span class="s1">camera</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">.</span><span class="s1">world_scale_y</span>
            <span class="s1">mpos </span><span class="s2">+= </span><span class="s1">camera</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">)</span>

            <span class="s1">x </span><span class="s2">= </span><span class="s1">round</span><span class="s2">(</span><span class="s1">mpos</span><span class="s2">.</span><span class="s1">x </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor_parent</span><span class="s2">.</span><span class="s1">scale_x</span><span class="s2">)</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">floor</span><span class="s2">(</span><span class="s1">mpos</span><span class="s2">.</span><span class="s1">y </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor_parent</span><span class="s2">.</span><span class="s1">scale_y</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


    <span class="s0">def </span><span class="s1">get_mouse_position</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_mouse_position_unclamped</span><span class="s2">()</span>

        <span class="s1">lines </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">clamp</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">) - </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">clamp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">]))</span>

        <span class="s0">return </span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s3"># print('-------------', key)</span>
        <span class="s1">text</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">on_undo</span><span class="s2">, </span><span class="s1">add_text</span><span class="s2">, </span><span class="s1">erase </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_undo</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">add_text</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">erase</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">register_mouse_input </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">hovered </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s5">'left mouse up'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">active </span><span class="s2">= </span><span class="s0">True</span>

        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">register_mouse_input </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">hovered </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s5">'left mouse down'</span><span class="s2">:    </span><span class="s3"># clicked outside</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">active </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">active</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">hovered_entity </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'scroll_down'</span><span class="s2">]:</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_lines </span><span class="s2">&lt; </span><span class="s4">9999</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s2">&lt; </span><span class="s4">9999</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s2">= </span><span class="s1">clamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll</span><span class="s2">+</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_amount</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">9999</span><span class="s2">)</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s2">= </span><span class="s1">clamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll</span><span class="s2">+</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_amount</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">9999</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_parent</span><span class="s2">.</span><span class="s1">y </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s2">* </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">size </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">line_height</span><span class="s2">)</span>
                <span class="s0">return</span>

            <span class="s0">elif </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'scroll_up'</span><span class="s2">]:</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_lines </span><span class="s2">&lt; </span><span class="s4">9999</span><span class="s2">:</span>
                    <span class="s3"># if self.scroll &gt; 0:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s2">= </span><span class="s1">clamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll</span><span class="s2">-</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_amount</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">9999</span><span class="s2">)</span>
                    <span class="s3"># self.y = .4-.025</span>
                    <span class="s3"># self.animate('y', .4, duration=.045, curve=curve.linear)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s2">= </span><span class="s1">clamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll</span><span class="s2">-</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_amount</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">9999</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_parent</span><span class="s2">.</span><span class="s1">y </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s2">* </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">size </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">line_height</span><span class="s2">)</span>
                <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s5">'double click'</span><span class="s2">:</span>
            <span class="s1">t </span><span class="s2">= </span><span class="s1">time</span><span class="s2">.</span><span class="s1">time</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">t </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_last_double_click </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">triple_click_delay</span><span class="s2">:</span>
                <span class="s1">key </span><span class="s2">= </span><span class="s5">'triple click'</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_last_double_click </span><span class="s2">= </span><span class="s1">t</span>

        <span class="s3"># key = f'{&quot;ctrl&quot; if held_keys[&quot;control&quot;]} + {key}'</span>
        <span class="s1">ctrl</span><span class="s2">, </span><span class="s1">shift</span><span class="s2">, </span><span class="s1">alt </span><span class="s2">= </span><span class="s5">''</span><span class="s2">, </span><span class="s5">''</span><span class="s2">, </span><span class="s5">''</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s5">'control'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">key </span><span class="s2">!= </span><span class="s5">'control'</span><span class="s2">:</span>
            <span class="s1">ctrl </span><span class="s2">= </span><span class="s5">'ctrl+'</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s5">'shift'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">key </span><span class="s2">!= </span><span class="s5">'shift'</span><span class="s2">:</span>
            <span class="s1">shift </span><span class="s2">= </span><span class="s5">'shift+'</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s5">'alt'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">key </span><span class="s2">!= </span><span class="s5">'alt'</span><span class="s2">:</span>
            <span class="s1">alt </span><span class="s2">= </span><span class="s5">'alt+'</span>

        <span class="s1">key </span><span class="s2">= </span><span class="s1">ctrl</span><span class="s2">+</span><span class="s1">shift</span><span class="s2">+</span><span class="s1">alt</span><span class="s2">+</span><span class="s1">key</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">lines </span><span class="s2">= </span><span class="s1">text</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">)</span>
        <span class="s1">l </span><span class="s2">= </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">]</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'move_operations'</span><span class="s2">][</span><span class="s5">'move_up'</span><span class="s2">]:</span>
            <span class="s0">if </span><span class="s1">y </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">-= </span><span class="s4">1</span>
                <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">-</span><span class="s4">1</span><span class="s2">]))</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'move_operations'</span><span class="s2">][</span><span class="s5">'move_down'</span><span class="s2">]:</span>
            <span class="s0">if </span><span class="s1">y </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)-</span><span class="s4">1</span><span class="s2">:</span>
                <span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">+= </span><span class="s4">1</span>
                <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]))</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'move_operations'</span><span class="s2">][</span><span class="s5">'move_right'</span><span class="s2">]:</span>
            <span class="s0">if </span><span class="s1">x </span><span class="s2">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">l</span><span class="s2">) </span><span class="s0">and </span><span class="s1">y </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)-</span><span class="s4">1</span><span class="s2">:        </span><span class="s3"># end of line, move to beginning of next</span>
                <span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">+= </span><span class="s4">1</span>
                <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s4">0</span>
            <span class="s0">elif </span><span class="s1">x </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">l</span><span class="s2">):</span>
                <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">+= </span><span class="s4">1</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'move_operations'</span><span class="s2">][</span><span class="s5">'move_left'</span><span class="s2">]:</span>
            <span class="s0">if </span><span class="s1">x </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">-= </span><span class="s4">1</span>
            <span class="s0">elif </span><span class="s1">y </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:                                 </span><span class="s3"># move to end of line above</span>
                <span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">-= </span><span class="s4">1</span>
                <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">-</span><span class="s4">1</span><span class="s2">])</span>


        <span class="s1">delimiters </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">delimiters</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'move_operations'</span><span class="s2">][</span><span class="s5">'move_to_start_of_word'</span><span class="s2">]:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">move_to_start_of_word</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">x </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">l</span><span class="s2">) </span><span class="s0">and </span><span class="s2">(</span><span class="s1">l</span><span class="s2">[</span><span class="s1">x</span><span class="s2">] </span><span class="s0">in </span><span class="s1">delimiters </span><span class="s0">or </span><span class="s1">x </span><span class="s2">== </span><span class="s4">0</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">move_to_start_of_word</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s5">'shift'</span><span class="s2">]:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">position</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">draw_selection</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'move_operations'</span><span class="s2">][</span><span class="s5">'move_to_end_of_word'</span><span class="s2">]:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">move_to_end_of_word</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">x </span><span class="s2">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">l</span><span class="s2">) </span><span class="s0">or </span><span class="s1">l</span><span class="s2">[</span><span class="s1">x</span><span class="s2">] </span><span class="s0">in </span><span class="s1">delimiters</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">move_to_end_of_word</span><span class="s2">()</span>

        <span class="s1">moved_cursor </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">for </span><span class="s1">move </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'move_operations'</span><span class="s2">]:</span>
            <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'move_operations'</span><span class="s2">][</span><span class="s1">move</span><span class="s2">]:</span>
                <span class="s1">moved_cursor </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s0">if not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s5">'shift'</span><span class="s2">]:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">Vec2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">X</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">Y</span><span class="s2">), </span><span class="s1">Vec2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">X</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">Y</span><span class="s2">)]</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">draw_selection</span><span class="s2">()</span>
                <span class="s0">break</span>

        <span class="s0">if </span><span class="s1">moved_cursor </span><span class="s0">and </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s5">'shift'</span><span class="s2">]:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">position</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">draw_selection</span><span class="s2">()</span>


        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'newline'</span><span class="s2">] </span><span class="s0">and </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_lines</span><span class="s2">-</span><span class="s4">1 </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_lines </span><span class="s2">== </span><span class="s4">9999</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">delete_selected</span><span class="s2">()</span>

            <span class="s0">if </span><span class="s1">l</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s5">'class '</span><span class="s2">) </span><span class="s0">and not </span><span class="s1">l</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s5">':'</span><span class="s2">):</span>
                <span class="s1">add_text</span><span class="s2">(</span><span class="s5">':'</span><span class="s2">, </span><span class="s1">rerender</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">l</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s5">'def '</span><span class="s2">) </span><span class="s0">and not </span><span class="s1">l</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s5">':'</span><span class="s2">):</span>
                <span class="s1">add_text</span><span class="s2">(</span><span class="s5">':'</span><span class="s2">, </span><span class="s1">rerender</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

            <span class="s1">add_text</span><span class="s2">(</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">, </span><span class="s1">rerender</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">l</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">() == </span><span class="s5">''</span><span class="s2">:</span>
                <span class="s1">indent </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">l</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">indent </span><span class="s2">= </span><span class="s4">0</span>
                <span class="s0">if </span><span class="s1">l</span><span class="s2">.</span><span class="s1">lstrip</span><span class="s2">().</span><span class="s1">startswith</span><span class="s2">(</span><span class="s5">'class '</span><span class="s2">) </span><span class="s0">or </span><span class="s1">l</span><span class="s2">.</span><span class="s1">lstrip</span><span class="s2">().</span><span class="s1">startswith</span><span class="s2">(</span><span class="s5">'def '</span><span class="s2">):</span>
                    <span class="s1">indent </span><span class="s2">+= </span><span class="s4">4</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">+= </span><span class="s4">1</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s4">0</span>
            <span class="s1">add_text</span><span class="s2">(</span><span class="s5">' '</span><span class="s2">*</span><span class="s1">indent</span><span class="s2">)</span>
            <span class="s0">return</span>
            <span class="s3"># self.cursor.x = indent</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'indent'</span><span class="s2">]:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]:</span>
                <span class="s1">add_text</span><span class="s2">(</span><span class="s5">' '</span><span class="s2">*</span><span class="s4">4</span><span class="s2">, </span><span class="s1">move_cursor</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                <span class="s0">return</span>

            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">]), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">][</span><span class="s4">1</span><span class="s2">])+</span><span class="s4">1</span><span class="s2">):</span>
                    <span class="s3"># print('indent', y)</span>
                    <span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">] = (</span><span class="s5">' '</span><span class="s2">*</span><span class="s4">4</span><span class="s2">) + </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">]</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">+= </span><span class="s4">4</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_append_undo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>
                <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'dedent'</span><span class="s2">]:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]:</span>
                <span class="s0">if </span><span class="s1">l</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s5">' '</span><span class="s2">*</span><span class="s4">4</span><span class="s2">):</span>
                    <span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">] = </span><span class="s1">l</span><span class="s2">[</span><span class="s4">4</span><span class="s2">:]</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">]), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">][</span><span class="s4">1</span><span class="s2">])+</span><span class="s4">1</span><span class="s2">):</span>
                    <span class="s1">l </span><span class="s2">= </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">]</span>
                    <span class="s0">if </span><span class="s1">l</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s5">' '</span><span class="s2">*</span><span class="s4">4</span><span class="s2">):</span>
                        <span class="s3"># print('dedent')</span>
                        <span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">] = </span><span class="s1">l</span><span class="s2">[</span><span class="s4">4</span><span class="s2">:]</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">- </span><span class="s4">4</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_append_undo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'erase'</span><span class="s2">]:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]:</span>
                <span class="s1">erase</span><span class="s2">()</span>
                <span class="s0">return</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">delete_selected</span><span class="s2">()</span>
                <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'erase_word'</span><span class="s2">]:</span>
            <span class="s3"># print('delete word')</span>
            <span class="s0">if </span><span class="s1">x </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s1">erase</span><span class="s2">()</span>
                <span class="s0">return</span>

            <span class="s0">if </span><span class="s5">' ' </span><span class="s0">not in </span><span class="s1">l</span><span class="s2">:</span>
                <span class="s1">l </span><span class="s2">= </span><span class="s1">l</span><span class="s2">[</span><span class="s1">x</span><span class="s2">:]</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s4">0</span>

            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">removed </span><span class="s2">= </span><span class="s5">''</span>
                <span class="s1">beginning </span><span class="s2">= </span><span class="s1">l</span><span class="s2">[:</span><span class="s1">x</span><span class="s2">]</span>


                <span class="s0">if </span><span class="s1">beginning</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s5">'  '</span><span class="s2">): </span><span class="s3"># delete whitespace</span>
                    <span class="s1">beginning </span><span class="s2">= </span><span class="s1">beginning</span><span class="s2">.</span><span class="s1">rstrip</span><span class="s2">()</span>
                    <span class="s1">removed </span><span class="s2">= </span><span class="s5">' ' </span><span class="s2">* (</span><span class="s1">x</span><span class="s2">-</span><span class="s1">len</span><span class="s2">(</span><span class="s1">beginning</span><span class="s2">))</span>

                <span class="s0">for </span><span class="s1">delimiter </span><span class="s0">in </span><span class="s2">(</span><span class="s5">'.'</span><span class="s2">, </span><span class="s5">'</span><span class="s0">\'</span><span class="s5">'</span><span class="s2">, </span><span class="s5">'</span><span class="s0">\&quot;</span><span class="s5">'</span><span class="s2">, </span><span class="s5">'('</span><span class="s2">, </span><span class="s5">'&quot;'</span><span class="s2">, </span><span class="s5">'</span><span class="s0">\'</span><span class="s5">'</span><span class="s2">):</span>
                    <span class="s1">beginning </span><span class="s2">= </span><span class="s1">beginning</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">delimiter</span><span class="s2">, </span><span class="s5">' '</span><span class="s2">)</span>

                <span class="s0">if </span><span class="s5">' ' </span><span class="s0">not in </span><span class="s1">beginning</span><span class="s2">: </span><span class="s3"># first word of the line</span>
                    <span class="s1">beginning </span><span class="s2">= </span><span class="s5">''</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">beginning </span><span class="s2">= </span><span class="s1">beginning</span><span class="s2">.</span><span class="s1">rstrip</span><span class="s2">().</span><span class="s1">rsplit</span><span class="s2">(</span><span class="s5">' '</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">]</span>

                <span class="s1">removed </span><span class="s2">= </span><span class="s1">l</span><span class="s2">[</span><span class="s1">len</span><span class="s2">(</span><span class="s1">beginning</span><span class="s2">):</span><span class="s1">x</span><span class="s2">]</span>

                <span class="s1">l </span><span class="s2">= </span><span class="s1">beginning </span><span class="s2">+ </span><span class="s1">l</span><span class="s2">[</span><span class="s1">x</span><span class="s2">:]</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">-= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">removed</span><span class="s2">)</span>

            <span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">] = </span><span class="s1">l</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_append_undo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'move_line_down'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_lines</span><span class="s2">:</span>
            <span class="s3"># print('move down')</span>
            <span class="s0">if </span><span class="s1">y</span><span class="s2">+</span><span class="s4">1 </span><span class="s2">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">): </span><span class="s3"># if at last line</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">move_line</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'move_line_up'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">y </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">move_line</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'undo'</span><span class="s2">]:</span>
            <span class="s0">if not </span><span class="s1">on_undo</span><span class="s2">:</span>
                <span class="s0">return</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">on_redo</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s1">on_undo</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">][</span><span class="s4">0</span><span class="s2">]</span>
            <span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">= </span><span class="s1">on_undo</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">][</span><span class="s4">1</span><span class="s2">]</span>
            <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">on_undo</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">][</span><span class="s4">2</span><span class="s2">]</span>
            <span class="s1">on_undo</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'redo'</span><span class="s2">]:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_redo</span><span class="s2">:</span>
                <span class="s0">return</span>

            <span class="s1">on_undo</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_redo</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">][</span><span class="s4">0</span><span class="s2">]</span>
            <span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_redo</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">][</span><span class="s4">1</span><span class="s2">]</span>
            <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_redo</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">][</span><span class="s4">2</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">on_redo</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'delete_line'</span><span class="s2">]:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_append_undo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
            <span class="s1">lines</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">y </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s4">0</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">-</span><span class="s4">1</span><span class="s2">])</span>

            <span class="s0">if </span><span class="s1">y </span><span class="s2">&gt;= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">) </span><span class="s0">and </span><span class="s1">y </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">-= </span><span class="s4">1</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'duplicate_line'</span><span class="s2">]:</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">) &lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_lines</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_append_undo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
                <span class="s1">lines</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">])</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)</span>
                <span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">+= </span><span class="s4">1</span>


        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'select_word'</span><span class="s2">]:</span>
            <span class="s0">if </span><span class="s1">x </span><span class="s2">&gt;= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">l</span><span class="s2">):</span>
                <span class="s0">return</span>

            <span class="s0">for </span><span class="s1">start_x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">):    </span><span class="s3"># go left until end of word</span>
                <span class="s0">if </span><span class="s1">l</span><span class="s2">[</span><span class="s1">start_x</span><span class="s2">] </span><span class="s0">in </span><span class="s1">delimiters</span><span class="s2">:</span>
                    <span class="s0">break</span>
            <span class="s0">if </span><span class="s1">start_x </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s1">start_x </span><span class="s2">+= </span><span class="s4">1</span>

            <span class="s0">for </span><span class="s1">end_x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">l</span><span class="s2">)):</span>
                <span class="s0">if </span><span class="s1">l</span><span class="s2">[</span><span class="s1">end_x</span><span class="s2">] </span><span class="s0">in </span><span class="s1">delimiters</span><span class="s2">:</span>
                    <span class="s0">break</span>
            <span class="s0">if </span><span class="s1">end_x </span><span class="s2">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">l</span><span class="s2">)-</span><span class="s4">1</span><span class="s2">:</span>
                <span class="s1">end_x </span><span class="s2">+= </span><span class="s4">1</span>


            <span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">Vec2</span><span class="s2">(</span><span class="s1">start_x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">Vec2</span><span class="s2">(</span><span class="s1">end_x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">draw_selection</span><span class="s2">()</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'select_line'</span><span class="s2">]:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">Vec2</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">]), </span><span class="s1">y</span><span class="s2">)]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">draw_selection</span><span class="s2">()</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'copy'</span><span class="s2">]:</span><span class="s3"># TODO</span>
            <span class="s1">selectedText </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_selected</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">selectedText</span><span class="s2">:</span>
                <span class="s1">pyperclip</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">selectedText</span><span class="s2">)</span>
                <span class="s3"># print('-----copy:', selectedText)</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'paste'</span><span class="s2">]:</span><span class="s3"># TODO</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">delete_selected</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">add_text</span><span class="s2">(</span><span class="s1">pyperclip</span><span class="s2">.</span><span class="s1">paste</span><span class="s2">())</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'cut'</span><span class="s2">]:</span><span class="s3"># TODO</span>
            <span class="s1">selectedText </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_selected</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">selectedText</span><span class="s2">:</span>
                <span class="s1">pyperclip</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">selectedText</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">delete_selected</span><span class="s2">()</span>
                <span class="s3"># print('-----cut:', selectedText)</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s5">'select_all'</span><span class="s2">]:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">select_all</span><span class="s2">()</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">register_mouse_input</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s5">'left mouse down' </span><span class="s0">and </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">hovered_entity </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bg </span><span class="s0">and </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">point </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">cursor</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_mouse_position</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">position</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">position</span><span class="s2">]</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">draw_selection</span><span class="s2">()</span>

            <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s5">'left mouse up'</span><span class="s2">:</span>
                    <span class="s1">cursor</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_mouse_position</span><span class="s2">()</span>

                    <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">position</span>



    <span class="s0">def </span><span class="s1">move_to_start_of_word</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">lines </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">)</span>
        <span class="s1">l </span><span class="s2">= </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">]</span>
        <span class="s1">delimiters </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">delimiters</span>

        <span class="s0">if </span><span class="s1">x </span><span class="s2">== </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">y </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s0">pass</span>

        <span class="s0">elif </span><span class="s1">x </span><span class="s2">== </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">y </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:                        </span><span class="s3"># move to end of line above</span>
            <span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">-= </span><span class="s4">1</span>
            <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">-</span><span class="s4">1</span><span class="s2">])</span>

        <span class="s0">elif </span><span class="s1">l</span><span class="s2">[</span><span class="s1">x</span><span class="s2">-</span><span class="s4">1</span><span class="s2">] </span><span class="s0">not in </span><span class="s1">delimiters</span><span class="s2">:              </span><span class="s3"># move left to closest delimiter</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">x</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">l</span><span class="s2">[</span><span class="s1">x</span><span class="s2">] </span><span class="s0">in </span><span class="s1">delimiters</span><span class="s2">:</span>
                    <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">+</span><span class="s4">1</span>
                    <span class="s0">return</span>
            <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s0">else</span><span class="s2">:                                       </span><span class="s3"># move left to closest word</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">x</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">l</span><span class="s2">[</span><span class="s1">x</span><span class="s2">] </span><span class="s0">not in </span><span class="s1">delimiters</span><span class="s2">:</span>
                    <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">+</span><span class="s4">1</span>
                    <span class="s0">return</span>
            <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s4">0</span>

    <span class="s0">def </span><span class="s1">move_to_end_of_word</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">x</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">lines </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">)</span>
        <span class="s1">l </span><span class="s2">= </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">]</span>
        <span class="s1">delimiters </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">delimiters</span>

        <span class="s0">if </span><span class="s1">x </span><span class="s2">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">l</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">y </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)-</span><span class="s4">1</span><span class="s2">:        </span><span class="s3"># end of line, move to beginning of next</span>
                <span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">+= </span><span class="s4">1</span>
                <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s4">0</span>
            <span class="s0">return</span>

        <span class="s0">elif </span><span class="s1">l</span><span class="s2">[</span><span class="s1">x</span><span class="s2">] </span><span class="s0">not in </span><span class="s1">delimiters</span><span class="s2">:                </span><span class="s3"># move right to closest delimiter</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">l</span><span class="s2">)):</span>
                <span class="s0">if </span><span class="s1">l</span><span class="s2">[</span><span class="s1">x</span><span class="s2">] </span><span class="s0">in </span><span class="s1">delimiters</span><span class="s2">:</span>
                    <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">x</span>
                    <span class="s0">return</span>
            <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">l</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:                                       </span><span class="s3"># move right to closest word</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">l</span><span class="s2">)):</span>
                <span class="s0">if </span><span class="s1">l</span><span class="s2">[</span><span class="s1">x</span><span class="s2">] </span><span class="s0">not in </span><span class="s1">delimiters</span><span class="s2">:</span>
                    <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">x</span>
                    <span class="s0">return</span>
            <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">l</span><span class="s2">)</span>


    <span class="s0">def </span><span class="s1">text_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s1">cursor</span><span class="s2">, </span><span class="s1">add_text </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">add_text</span>

        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">active</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s5">'shift'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s5">'alt'</span><span class="s2">]:</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:  </span><span class="s3"># delete selected text</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">delete_selected</span><span class="s2">()</span>

        <span class="s1">add_text</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s5">'('</span><span class="s2">:</span>
            <span class="s1">add_text</span><span class="s2">(</span><span class="s5">')'</span><span class="s2">)</span>
            <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">-= </span><span class="s4">1</span>
        <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s5">'['</span><span class="s2">:</span>
            <span class="s1">add_text</span><span class="s2">(</span><span class="s5">']'</span><span class="s2">)</span>
            <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">-= </span><span class="s4">1</span>
        <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s5">'{'</span><span class="s2">:</span>
            <span class="s1">add_text</span><span class="s2">(</span><span class="s5">'}'</span><span class="s2">)</span>
            <span class="s1">cursor</span><span class="s2">.</span><span class="s1">x </span><span class="s2">-= </span><span class="s4">1</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">render</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">lines </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_lines </span><span class="s2">&lt; </span><span class="s4">9999</span><span class="s2">:</span>
            <span class="s1">text </span><span class="s2">= </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s2">+ </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_lines </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll</span><span class="s2">])</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">text </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span>

        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">, </span><span class="s5">'raw_text'</span><span class="s2">) </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_prev_text </span><span class="s2">!= </span><span class="s1">text </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_prev_scroll</span><span class="s2">:</span>
            <span class="s3"># print(self.scroll)</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">replacements</span><span class="s2">:</span>
                <span class="s1">_lines </span><span class="s2">= </span><span class="s1">text</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">_lines</span><span class="s2">)):</span>
                    <span class="s0">if </span><span class="s1">_lines</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">lstrip</span><span class="s2">().</span><span class="s1">startswith</span><span class="s2">(</span><span class="s5">'#'</span><span class="s2">):</span>
                        <span class="s1">_lines</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s5">f'☾gray☽</span><span class="s0">{</span><span class="s1">lines</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span><span class="s0">}</span><span class="s5">☾default☽'</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">_lines</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">multireplace</span><span class="s2">(</span><span class="s1">_lines</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">replacements</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">_lines</span><span class="s2">)</span>

                <span class="s3"># self.text_entity.text = multireplace(text, self.replacements)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s1">text</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">line_numbers</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= (</span><span class="s5">'     </span><span class="s0">\n</span><span class="s5">'</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll</span><span class="s2">) + </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s1">str</span><span class="s2">(</span><span class="s1">e </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll</span><span class="s2">).</span><span class="s1">rjust</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s5">' '</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">min</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_lines</span><span class="s2">))])</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">_prev_text </span><span class="s2">= </span><span class="s1">text</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_prev_scroll </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_parent</span><span class="s2">.</span><span class="s1">y </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s2">* </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">size </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">line_height</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">visible </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">&gt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">y </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_lines</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">draw_selection</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_value_changed</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">on_value_changed</span><span class="s2">()</span>



    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">active </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">register_mouse_input </span><span class="s0">and </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">left </span><span class="s0">and </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">moving</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_mouse_position</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">position</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">draw_selection</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">select_all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">lines </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">lines</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">Vec2</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">) - </span><span class="s4">1</span><span class="s2">)]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">draw_selection</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">draw_selection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># print(self.selection)</span>
        <span class="s2">[</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">c</span><span class="s2">) </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection_parent</span><span class="s2">.</span><span class="s1">children</span><span class="s2">]</span>

        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]:</span>
            <span class="s0">return</span>

        <span class="s1">sel </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ordered_selection</span><span class="s2">()</span>
        <span class="s3"># print('---', self.selection, self.scroll)</span>

        <span class="s1">start_y </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">sel</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">end_y </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">sel</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">lines </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">start_y </span><span class="s2">== </span><span class="s1">end_y</span><span class="s2">:</span>
            <span class="s1">e </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection_parent</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s5">'quad'</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,-</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">color</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">highlight_color</span><span class="s2">, </span><span class="s1">double_sided</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">ignore</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s1">start_y</span><span class="s2">)</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">sel</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">x</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">scale_x </span><span class="s2">= </span><span class="s1">sel</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">x </span><span class="s2">- </span><span class="s1">sel</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">x</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s3"># first line</span>
            <span class="s0">if </span><span class="s1">start_y </span><span class="s2">&gt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s0">and </span><span class="s1">start_y </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll</span><span class="s2">+</span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_lines</span><span class="s2">:</span>
                <span class="s1">e </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection_parent</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s5">'quad'</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">, -</span><span class="s4">.5</span><span class="s2">),</span>
                <span class="s1">color</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">highlight_color</span><span class="s2">, </span><span class="s1">double_sided</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">position</span><span class="s2">=(</span><span class="s1">sel</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">x</span><span class="s2">,</span><span class="s1">start_y</span><span class="s2">), </span><span class="s1">ignore</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">scale_x </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">[</span><span class="s1">start_y</span><span class="s2">]) - </span><span class="s1">sel</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">x</span>

            <span class="s3"># middle lines</span>
            <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">max</span><span class="s2">(</span><span class="s1">start_y</span><span class="s2">+</span><span class="s4">1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll</span><span class="s2">), </span><span class="s1">min</span><span class="s2">(</span><span class="s1">end_y</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll</span><span class="s2">+</span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_lines</span><span class="s2">)):</span>
                <span class="s1">e </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection_parent</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s5">'quad'</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">, -</span><span class="s4">.5</span><span class="s2">),</span>
                    <span class="s1">color</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">highlight_color</span><span class="s2">, </span><span class="s1">double_sided</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">position</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">,</span><span class="s1">y</span><span class="s2">), </span><span class="s1">ignore</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">scale_x</span><span class="s2">=</span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">[</span><span class="s1">y</span><span class="s2">]))</span>

            <span class="s3"># last line</span>
            <span class="s0">if </span><span class="s1">end_y </span><span class="s2">&gt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s0">and </span><span class="s1">end_y </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll</span><span class="s2">+</span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_lines</span><span class="s2">:</span>
                <span class="s1">e </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection_parent</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s5">'quad'</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">, -</span><span class="s4">.5</span><span class="s2">),</span>
                <span class="s1">color</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">highlight_color</span><span class="s2">, </span><span class="s1">double_sided</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">position</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">,</span><span class="s1">end_y</span><span class="s2">), </span><span class="s1">ignore</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">scale_x </span><span class="s2">= </span><span class="s1">sel</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">x</span>

        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection_parent</span><span class="s2">.</span><span class="s1">children</span><span class="s2">:</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">y </span><span class="s2">&gt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll </span><span class="s0">and </span><span class="s1">e</span><span class="s2">.</span><span class="s1">y </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll</span><span class="s2">+</span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_lines</span>


<span class="s0">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s5">'__main__'</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">ursina </span><span class="s0">import </span><span class="s1">Ursina</span><span class="s2">, </span><span class="s1">window</span><span class="s2">, </span><span class="s1">Button</span>
    <span class="s1">app </span><span class="s2">= </span><span class="s1">Ursina</span><span class="s2">(</span><span class="s1">vsync</span><span class="s2">=</span><span class="s4">60</span><span class="s2">)</span>

    <span class="s3"># camera.orthographic = True</span>
    <span class="s3"># camera.fov = 1</span>
    <span class="s3"># window.size = window.fullscreen_size</span>
    <span class="s3"># window.x = 200</span>

    <span class="s1">window</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">color</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">.1</span><span class="s2">)</span>
    <span class="s1">Button</span><span class="s2">.</span><span class="s1">default_color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">_20</span>
    <span class="s1">window</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">_25</span>

    <span class="s3"># Text.size = 1/window.fullscreen_size[1]*16</span>
    <span class="s3"># Text.default_font = 'consola.ttf'</span>
    <span class="s3"># Text.default_resolution = 16*2</span>
    <span class="s3"># TreeView()</span>
    <span class="s1">te </span><span class="s2">= </span><span class="s1">TextField</span><span class="s2">(</span><span class="s1">max_lines</span><span class="s2">=</span><span class="s4">50</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">register_mouse_input </span><span class="s2">= </span><span class="s0">True</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s5">'1234'</span><span class="s2">)</span>
    <span class="s3">#te = TextField(max_lines=300, scale=1, register_mouse_input = True, scroll_size = (50,3))</span>
    <span class="s3"># te.line_numbers.enabled = True</span>
    <span class="s3"># for name in color.color_names:</span>
    <span class="s3">#     if name == 'black':</span>
    <span class="s3">#         continue</span>
    <span class="s3">#     te.replacements[f' {name}'] = f'☾{name}☽ {name}☾default☽'</span>
    <span class="s3"># te.replacements = {</span>
    <span class="s3">#     'class ':    '☾orange☽class ☾default☽',</span>
    <span class="s3">#     'def ':      '☾azure☽def ☾default☽',</span>
    <span class="s3">#     '__init__':  '☾cyan☽__init__☾default☽',</span>
    <span class="s3">#     'Entity':    '☾lime☽Entity☾default☽',</span>
    <span class="s3">#     'self.':     '☾orange☽self☾default☽.',</span>
    <span class="s3">#     '(self)':     '(☾orange☽self☾default☽)',</span>
    <span class="s3">#     'self,':     '☾orange☽self☾default☽,',</span>
    <span class="s3">#     '    ':      '☾dark_gray☽----☾default☽',</span>
    <span class="s3">#     }</span>
    <span class="s3">#</span>
    <span class="s0">from </span><span class="s1">textwrap </span><span class="s0">import </span><span class="s1">dedent</span>
    <span class="s1">te</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s1">dedent</span><span class="s2">(</span><span class="s5">''' 
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. 
        Aliquam sapien tellus, venenatis sit amet ante et, malesuada porta risus. 
        Etiam et mi luctus, viverra urna at, maximus eros. Sed dictum faucibus purus, 
        nec rutrum ipsum condimentum in. Mauris iaculis arcu nec justo rutrum euismod. 
        Suspendisse dolor tortor, congue id erat sit amet, sollicitudin facilisis velit. 
        Aliquam sapien tellus, venenatis sit amet ante et, malesuada porta risus. 
        Etiam et mi luctus, viverra urna at, maximus eros. Sed dictum faucibus purus, 
        nec rutrum ipsum condimentum in. Mauris iaculis arcu nec justo rutrum euismod. 
        Suspendisse dolor tortor, congue id erat sit amet, sollicitudin facilisis velit. 
        '''</span><span class="s2">*</span><span class="s4">30</span>
        <span class="s2">)[</span><span class="s4">1</span><span class="s2">:]</span>
    <span class="s1">te</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>

    <span class="s1">app</span><span class="s2">.</span><span class="s1">run</span><span class="s2">()</span>
</pre>
</body>
</html>