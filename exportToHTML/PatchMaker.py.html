<html>
<head>
<title>PatchMaker.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
PatchMaker.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
.. deprecated:: 1.10.0 
   The p3d packaging system has been replaced with the new setuptools-based 
   system.  See the :ref:`distribution` manual section. 
&quot;&quot;&quot;</span>
<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">&quot;PatchMaker&quot;</span><span class="s2">]</span>

<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">p3d</span><span class="s2">.</span><span class="s1">FileSpec </span><span class="s4">import </span><span class="s1">FileSpec</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">p3d</span><span class="s2">.</span><span class="s1">SeqValue </span><span class="s4">import </span><span class="s1">SeqValue</span>
<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s2">*</span>
<span class="s4">import </span><span class="s1">copy</span>

<span class="s4">class </span><span class="s1">PatchMaker</span><span class="s2">:</span>
    <span class="s0">&quot;&quot;&quot; This class will operate on an existing package install 
    directory, as generated by the Packager, and create patchfiles 
    between versions as needed.  It is also used at runtime, to apply 
    the downloaded patches. &quot;&quot;&quot;</span>

    <span class="s4">class </span><span class="s1">PackageVersion</span><span class="s2">:</span>
        <span class="s0">&quot;&quot;&quot; A specific patch version of a package.  This is not just 
        the package's &quot;version&quot; string; it also corresponds to the 
        particular patch version, which increments independently of 
        the &quot;version&quot;. &quot;&quot;&quot;</span>

        <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">file</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">= </span><span class="s1">packageName</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">= </span><span class="s1">platform</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s1">version</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl </span><span class="s2">= </span><span class="s1">hostUrl</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">file </span><span class="s2">= </span><span class="s1">file</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">printName </span><span class="s2">= </span><span class="s4">None</span>

            <span class="s5"># The Package object that produces this version, if this</span>
            <span class="s5"># is the current, base, or top form, respectively.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageCurrent </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageBase </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageTop </span><span class="s2">= </span><span class="s4">None</span>

            <span class="s5"># A list of patchfiles that can produce this version.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">fromPatches </span><span class="s2">= []</span>

            <span class="s5"># A list of patchfiles that can start from this version.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">toPatches </span><span class="s2">= []</span>

            <span class="s5"># A temporary file for re-creating the archive file for</span>
            <span class="s5"># this version.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tempFile </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s4">def </span><span class="s1">cleanup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tempFile</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tempFile</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>

        <span class="s4">def </span><span class="s1">getPatchChain</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">startPv</span><span class="s2">, </span><span class="s1">alreadyVisited </span><span class="s2">= []):</span>
            <span class="s0">&quot;&quot;&quot; Returns a list of patches that, when applied in 
            sequence to the indicated PackageVersion object, will 
            produce this PackageVersion object.  Returns None if no 
            chain can be found. &quot;&quot;&quot;</span>

            <span class="s4">if </span><span class="s1">self </span><span class="s4">is </span><span class="s1">startPv</span><span class="s2">:</span>
                <span class="s5"># We're already here.  A zero-length patch chain is</span>
                <span class="s5"># therefore the answer.</span>
                <span class="s4">return </span><span class="s2">[]</span>
            <span class="s4">if </span><span class="s1">self </span><span class="s4">in </span><span class="s1">alreadyVisited</span><span class="s2">:</span>
                <span class="s5"># We've already been here; this is a loop.  Avoid</span>
                <span class="s5"># infinite recursion.</span>
                <span class="s4">return None</span>

            <span class="s1">alreadyVisited </span><span class="s2">= </span><span class="s1">alreadyVisited</span><span class="s2">[:]</span>
            <span class="s1">alreadyVisited</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

            <span class="s1">bestPatchChain </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s4">for </span><span class="s1">patchfile </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fromPatches</span><span class="s2">:</span>
                <span class="s1">fromPv </span><span class="s2">= </span><span class="s1">patchfile</span><span class="s2">.</span><span class="s1">fromPv</span>
                <span class="s1">patchChain </span><span class="s2">= </span><span class="s1">fromPv</span><span class="s2">.</span><span class="s1">getPatchChain</span><span class="s2">(</span><span class="s1">startPv</span><span class="s2">, </span><span class="s1">alreadyVisited</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">patchChain </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s5"># There's a path through this patchfile.</span>
                    <span class="s1">patchChain </span><span class="s2">= </span><span class="s1">patchChain </span><span class="s2">+ [</span><span class="s1">patchfile</span><span class="s2">]</span>
                    <span class="s4">if </span><span class="s1">bestPatchChain </span><span class="s4">is None or </span><span class="s1">len</span><span class="s2">(</span><span class="s1">patchChain</span><span class="s2">) &lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">bestPatchChain</span><span class="s2">):</span>
                        <span class="s1">bestPatchChain </span><span class="s2">= </span><span class="s1">patchChain</span>

            <span class="s5"># Return the shortest path found, or None if there were no</span>
            <span class="s5"># paths found.</span>
            <span class="s4">return </span><span class="s1">bestPatchChain</span>

        <span class="s4">def </span><span class="s1">getRecreateFilePlan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alreadyVisited </span><span class="s2">= []):</span>
            <span class="s0">&quot;&quot;&quot; Returns the tuple (startFile, startPv, plan), 
            describing how to recreate the archive file for this 
            version.  startFile and startPv is the Filename and 
            packageVersion of the file to start with, and plan is a 
            list of tuples (patchfile, pv), listing the patches to 
            apply in sequence, and the packageVersion object 
            associated with each patch.  Returns (None, None, None) if 
            there is no way to recreate this archive file.  &quot;&quot;&quot;</span>

            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tempFile</span><span class="s2">:</span>
                <span class="s4">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tempFile</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, [])</span>

            <span class="s4">if </span><span class="s1">self </span><span class="s4">in </span><span class="s1">alreadyVisited</span><span class="s2">:</span>
                <span class="s5"># We've already been here; this is a loop.  Avoid</span>
                <span class="s5"># infinite recursion.</span>
                <span class="s4">return </span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s4">None</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>

            <span class="s1">alreadyVisited </span><span class="s2">= </span><span class="s1">alreadyVisited</span><span class="s2">[:]</span>
            <span class="s1">alreadyVisited</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageCurrent</span><span class="s2">:</span>
                <span class="s5"># This PackageVersion instance represents the current</span>
                <span class="s5"># version of some package.</span>
                <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageCurrent</span>
                <span class="s4">return </span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">compressedFilename</span><span class="s2">), </span><span class="s1">self</span><span class="s2">, [])</span>

            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageBase</span><span class="s2">:</span>
                <span class="s5"># This PackageVersion instance represents the base</span>
                <span class="s5"># (oldest) version of some package.</span>
                <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageBase</span>
                <span class="s4">return </span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">baseFile</span><span class="s2">.</span><span class="s1">filename  </span><span class="s2">+ </span><span class="s3">'.pz'</span><span class="s2">), </span><span class="s1">self</span><span class="s2">, [])</span>

            <span class="s5"># We'll need to re-create the file.</span>
            <span class="s1">bestPlan </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">bestStartFile </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">bestStartPv </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s4">for </span><span class="s1">patchfile </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fromPatches</span><span class="s2">:</span>
                <span class="s1">fromPv </span><span class="s2">= </span><span class="s1">patchfile</span><span class="s2">.</span><span class="s1">fromPv</span>
                <span class="s1">startFile</span><span class="s2">, </span><span class="s1">startPv</span><span class="s2">, </span><span class="s1">plan </span><span class="s2">= </span><span class="s1">fromPv</span><span class="s2">.</span><span class="s1">getRecreateFilePlan</span><span class="s2">(</span><span class="s1">alreadyVisited</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">plan </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s5"># There's a path through this patchfile.</span>
                    <span class="s1">plan </span><span class="s2">= </span><span class="s1">plan </span><span class="s2">+ [(</span><span class="s1">patchfile</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)]</span>
                    <span class="s4">if </span><span class="s1">bestPlan </span><span class="s4">is None or </span><span class="s1">len</span><span class="s2">(</span><span class="s1">plan</span><span class="s2">) &lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">bestPlan</span><span class="s2">):</span>
                        <span class="s1">bestPlan </span><span class="s2">= </span><span class="s1">plan</span>
                        <span class="s1">bestStartFile </span><span class="s2">= </span><span class="s1">startFile</span>
                        <span class="s1">bestStartPv </span><span class="s2">= </span><span class="s1">startPv</span>

            <span class="s5"># Return the shortest path found, or None if there were no</span>
            <span class="s5"># paths found.</span>
            <span class="s4">return </span><span class="s2">(</span><span class="s1">bestStartFile</span><span class="s2">, </span><span class="s1">bestStartPv</span><span class="s2">, </span><span class="s1">bestPlan</span><span class="s2">)</span>

        <span class="s4">def </span><span class="s1">getFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Returns the Filename of the archive file associated 
            with this version.  If the file doesn't actually exist on 
            disk, a temporary file will be created.  Returns None if 
            the file can't be recreated. &quot;&quot;&quot;</span>

            <span class="s1">startFile</span><span class="s2">, </span><span class="s1">startPv</span><span class="s2">, </span><span class="s1">plan </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getRecreateFilePlan</span><span class="s2">()</span>

            <span class="s4">if </span><span class="s1">startFile</span><span class="s2">.</span><span class="s1">getExtension</span><span class="s2">() </span><span class="s4">in </span><span class="s2">(</span><span class="s3">'pz'</span><span class="s2">, </span><span class="s3">'gz'</span><span class="s2">):</span>
                <span class="s5"># If the starting file is compressed, we have to</span>
                <span class="s5"># decompress it first.</span>
                <span class="s4">assert </span><span class="s1">startPv</span><span class="s2">.</span><span class="s1">tempFile </span><span class="s4">is None</span>
                <span class="s1">startPv</span><span class="s2">.</span><span class="s1">tempFile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s3">'patch_'</span><span class="s2">)</span>
                <span class="s4">if not </span><span class="s1">decompressFile</span><span class="s2">(</span><span class="s1">startFile</span><span class="s2">, </span><span class="s1">startPv</span><span class="s2">.</span><span class="s1">tempFile</span><span class="s2">):</span>
                    <span class="s5"># Failure trying to decompress the file.</span>
                    <span class="s4">return None</span>
                <span class="s1">startFile </span><span class="s2">= </span><span class="s1">startPv</span><span class="s2">.</span><span class="s1">tempFile</span>

            <span class="s4">if not </span><span class="s1">plan</span><span class="s2">:</span>
                <span class="s5"># If plan is a zero-length list, we're already</span>
                <span class="s5"># here--return startFile.  If plan is None, there's no</span>
                <span class="s5"># solution, and startFile is None.  In either case, we</span>
                <span class="s5"># can return startFile.</span>
                <span class="s4">return </span><span class="s1">startFile</span>

            <span class="s5"># If plan is a non-empty list, we have to walk the list to</span>
            <span class="s5"># apply the patch plan.</span>
            <span class="s1">prevFile </span><span class="s2">= </span><span class="s1">startFile</span>
            <span class="s4">for </span><span class="s1">patchfile</span><span class="s2">, </span><span class="s1">pv </span><span class="s4">in </span><span class="s1">plan</span><span class="s2">:</span>
                <span class="s1">fromPv </span><span class="s2">= </span><span class="s1">patchfile</span><span class="s2">.</span><span class="s1">fromPv</span>
                <span class="s1">patchFilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">patchfile</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">patchfile</span><span class="s2">.</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">applyPatch</span><span class="s2">(</span><span class="s1">prevFile</span><span class="s2">, </span><span class="s1">patchFilename</span><span class="s2">)</span>
                <span class="s4">if not </span><span class="s1">result</span><span class="s2">:</span>
                    <span class="s5"># Failure trying to re-create the file.</span>
                    <span class="s4">return None</span>

                <span class="s1">pv</span><span class="s2">.</span><span class="s1">tempFile </span><span class="s2">= </span><span class="s1">result</span>
                <span class="s1">prevFile </span><span class="s2">= </span><span class="s1">result</span>

            <span class="s5"># Successfully patched.</span>
            <span class="s4">assert </span><span class="s1">pv </span><span class="s4">is </span><span class="s1">self </span><span class="s4">and </span><span class="s1">prevFile </span><span class="s4">is </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tempFile</span>
            <span class="s4">return </span><span class="s1">prevFile</span>

        <span class="s4">def </span><span class="s1">applyPatch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">origFile</span><span class="s2">, </span><span class="s1">patchFilename</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Applies the named patch to the indicated original 
            file, storing the results in a temporary file, and returns 
            that temporary Filename.  Returns None on failure. &quot;&quot;&quot;</span>

            <span class="s1">result </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s3">'patch_'</span><span class="s2">)</span>
            <span class="s1">p </span><span class="s2">= </span><span class="s1">Patchfile</span><span class="s2">()</span>
            <span class="s4">if not </span><span class="s1">p</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">patchFilename</span><span class="s2">, </span><span class="s1">origFile</span><span class="s2">, </span><span class="s1">result</span><span class="s2">):</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Internal patching failed: %s&quot; </span><span class="s2">% (</span><span class="s1">patchFilename</span><span class="s2">))</span>
                <span class="s4">return None</span>

            <span class="s4">return </span><span class="s1">result</span>

        <span class="s4">def </span><span class="s1">getNext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">package</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Gets the next patch in the chain towards this 
            package. &quot;&quot;&quot;</span>
            <span class="s4">for </span><span class="s1">patch </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">toPatches</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">patch</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">== </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName </span><span class="s4">and </span><span class="s1">\</span>
                   <span class="s1">patch</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform </span><span class="s4">and </span><span class="s1">\</span>
                   <span class="s1">patch</span><span class="s2">.</span><span class="s1">version </span><span class="s2">== </span><span class="s1">package</span><span class="s2">.</span><span class="s1">version </span><span class="s4">and </span><span class="s1">\</span>
                   <span class="s1">patch</span><span class="s2">.</span><span class="s1">hostUrl </span><span class="s2">== </span><span class="s1">package</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">:</span>
                    <span class="s4">return </span><span class="s1">patch</span><span class="s2">.</span><span class="s1">toPv</span>

            <span class="s4">return None</span>

    <span class="s4">class </span><span class="s1">Patchfile</span><span class="s2">:</span>
        <span class="s0">&quot;&quot;&quot; A single patchfile for a package. &quot;&quot;&quot;</span>

        <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">package</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">package </span><span class="s2">= </span><span class="s1">package</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">version</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl </span><span class="s2">= </span><span class="s4">None</span>

            <span class="s5"># FileSpec for the patchfile itself</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">file </span><span class="s2">= </span><span class="s4">None</span>

            <span class="s5"># FileSpec for the package file that the patch is applied to</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sourceFile </span><span class="s2">= </span><span class="s4">None</span>

            <span class="s5"># FileSpec for the package file that the patch generates</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">targetFile </span><span class="s2">= </span><span class="s4">None</span>

            <span class="s5"># The PackageVersion corresponding to our sourceFile</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">fromPv </span><span class="s2">= </span><span class="s4">None</span>

            <span class="s5"># The PackageVersion corresponding to our targetFile</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">toPv </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s4">def </span><span class="s1">getSourceKey</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Returns the key for locating the package that this 
            patchfile can be applied to. &quot;&quot;&quot;</span>
            <span class="s4">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sourceFile</span><span class="s2">)</span>

        <span class="s4">def </span><span class="s1">getTargetKey</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Returns the key for locating the package that this 
            patchfile will generate. &quot;&quot;&quot;</span>
            <span class="s4">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">targetFile</span><span class="s2">)</span>

        <span class="s4">def </span><span class="s1">fromFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">patchFilename</span><span class="s2">, </span><span class="s1">sourceFile</span><span class="s2">, </span><span class="s1">targetFile</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Creates the data structures from an existing patchfile 
            on disk. &quot;&quot;&quot;</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">file </span><span class="s2">= </span><span class="s1">FileSpec</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">file</span><span class="s2">.</span><span class="s1">fromFile</span><span class="s2">(</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">patchFilename</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sourceFile </span><span class="s2">= </span><span class="s1">sourceFile</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">targetFile </span><span class="s2">= </span><span class="s1">targetFile</span>

        <span class="s4">def </span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xpatch</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Reads the data structures from an xml file. &quot;&quot;&quot;</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">= </span><span class="s1">xpatch</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">) </span><span class="s4">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">= </span><span class="s1">xpatch</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'platform'</span><span class="s2">) </span><span class="s4">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s1">xpatch</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'version'</span><span class="s2">) </span><span class="s4">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl </span><span class="s2">= </span><span class="s1">xpatch</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'host'</span><span class="s2">) </span><span class="s4">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">file </span><span class="s2">= </span><span class="s1">FileSpec</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">file</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xpatch</span><span class="s2">)</span>

            <span class="s1">xsource </span><span class="s2">= </span><span class="s1">xpatch</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'source'</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">xsource</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">sourceFile </span><span class="s2">= </span><span class="s1">FileSpec</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">sourceFile</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xsource</span><span class="s2">)</span>

            <span class="s1">xtarget </span><span class="s2">= </span><span class="s1">xpatch</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'target'</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">xtarget</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">targetFile </span><span class="s2">= </span><span class="s1">FileSpec</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">targetFile</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xtarget</span><span class="s2">)</span>

        <span class="s4">def </span><span class="s1">makeXml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">package</span><span class="s2">):</span>
            <span class="s1">xpatch </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'patch'</span><span class="s2">)</span>

            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">!= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">:</span>
                <span class="s1">xpatch</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">!= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">:</span>
                <span class="s1">xpatch</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'platform'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">!= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">version</span><span class="s2">:</span>
                <span class="s1">xpatch</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'version'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl </span><span class="s2">!= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">:</span>
                <span class="s1">xpatch</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'host'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">file</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xpatch</span><span class="s2">)</span>

            <span class="s1">xsource </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'source'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sourceFile</span><span class="s2">.</span><span class="s1">storeMiniXml</span><span class="s2">(</span><span class="s1">xsource</span><span class="s2">)</span>
            <span class="s1">xpatch</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xsource</span><span class="s2">)</span>

            <span class="s1">xtarget </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'target'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">targetFile</span><span class="s2">.</span><span class="s1">storeMiniXml</span><span class="s2">(</span><span class="s1">xtarget</span><span class="s2">)</span>
            <span class="s1">xpatch</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xtarget</span><span class="s2">)</span>

            <span class="s4">return </span><span class="s1">xpatch</span>

    <span class="s4">class </span><span class="s1">Package</span><span class="s2">:</span>
        <span class="s0">&quot;&quot;&quot; This is a particular package.  This contains all of the 
        information needed to reconstruct the package's desc file. &quot;&quot;&quot;</span>

        <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageDesc</span><span class="s2">, </span><span class="s1">patchMaker</span><span class="s2">, </span><span class="s1">xpackage </span><span class="s2">= </span><span class="s4">None</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">patchMaker</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">, </span><span class="s1">packageDesc</span><span class="s2">.</span><span class="s1">getDirname</span><span class="s2">())</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageDesc </span><span class="s2">= </span><span class="s1">packageDesc</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">patchMaker </span><span class="s2">= </span><span class="s1">patchMaker</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">contentsDocPackage </span><span class="s2">= </span><span class="s1">xpackage</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">patchVersion </span><span class="s2">= </span><span class="s6">1</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPv </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">basePv </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">topPv </span><span class="s2">= </span><span class="s4">None</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">currentFile </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">baseFile </span><span class="s2">= </span><span class="s4">None</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">doc </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anyChanges </span><span class="s2">= </span><span class="s4">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">patches </span><span class="s2">= []</span>

        <span class="s4">def </span><span class="s1">getCurrentKey</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Returns the key to locate the current version of this 
            package. &quot;&quot;&quot;</span>

            <span class="s4">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentFile</span><span class="s2">)</span>

        <span class="s4">def </span><span class="s1">getBaseKey</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Returns the key to locate the &quot;base&quot; or oldest version 
            of this package. &quot;&quot;&quot;</span>

            <span class="s4">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">baseFile</span><span class="s2">)</span>

        <span class="s4">def </span><span class="s1">getTopKey</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Returns the key to locate the &quot;top&quot; or newest version 
            of this package. &quot;&quot;&quot;</span>

            <span class="s4">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">topFile</span><span class="s2">)</span>

        <span class="s4">def </span><span class="s1">getGenericKey</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fileSpec</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Returns the key that has the indicated hash. &quot;&quot;&quot;</span>
            <span class="s4">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">fileSpec</span><span class="s2">)</span>

        <span class="s4">def </span><span class="s1">readDescFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">doProcessing </span><span class="s2">= </span><span class="s4">False</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Reads the existing package.xml file and stores it in 
            this class for later rewriting.  if doProcessing is true, 
            it may massage the file and the directory contents in 
            preparation for building patches.  Returns true on 
            success, false on failure. &quot;&quot;&quot;</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">anyChanges </span><span class="s2">= </span><span class="s4">False</span>

            <span class="s1">packageDescFullpath </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">patchMaker</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageDesc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">doc </span><span class="s2">= </span><span class="s1">TiXmlDocument</span><span class="s2">(</span><span class="s1">packageDescFullpath</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">doc</span><span class="s2">.</span><span class="s1">LoadFile</span><span class="s2">():</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Couldn't read %s&quot; </span><span class="s2">% (</span><span class="s1">packageDescFullpath</span><span class="s2">))</span>
                <span class="s4">return False</span>

            <span class="s1">xpackage </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">doc</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'package'</span><span class="s2">)</span>
            <span class="s4">if not </span><span class="s1">xpackage</span><span class="s2">:</span>
                <span class="s4">return False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'platform'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'version'</span><span class="s2">)</span>

            <span class="s5"># All packages we defined in-line are assigned to the</span>
            <span class="s5"># &quot;none&quot; host.  TODO: support patching from packages on</span>
            <span class="s5"># other hosts, which means we'll need to fill in a value</span>
            <span class="s5"># here for those hosts.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl </span><span class="s2">= </span><span class="s4">None</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">currentFile </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">baseFile </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">topFile </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">compressedFilename </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">compressedFile </span><span class="s2">= </span><span class="s4">None</span>

            <span class="s5"># Assume there are changes for this version, until we</span>
            <span class="s5"># discover that there aren't.</span>
            <span class="s1">isNewVersion </span><span class="s2">= </span><span class="s4">True</span>

            <span class="s5"># Get the actual current version.</span>
            <span class="s1">xarchive </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'uncompressed_archive'</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">xarchive</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">currentFile </span><span class="s2">= </span><span class="s1">FileSpec</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">currentFile</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xarchive</span><span class="s2">)</span>

            <span class="s5"># Get the top_version--the top (newest) of the patch</span>
            <span class="s5"># chain.</span>
            <span class="s1">xarchive </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'top_version'</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">xarchive</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">topFile </span><span class="s2">= </span><span class="s1">FileSpec</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">topFile</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xarchive</span><span class="s2">)</span>

                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">topFile</span><span class="s2">.</span><span class="s1">hash </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentFile</span><span class="s2">.</span><span class="s1">hash</span><span class="s2">:</span>
                    <span class="s5"># No new version this pass.</span>
                    <span class="s1">isNewVersion </span><span class="s2">= </span><span class="s4">False</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s5"># There's a new version this pass.  Update it.</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">anyChanges </span><span class="s2">= </span><span class="s4">True</span>

            <span class="s4">else</span><span class="s2">:</span>
                <span class="s5"># If there isn't a top_version yet, we have to make</span>
                <span class="s5"># one, by duplicating the currentFile.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">topFile </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentFile</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">anyChanges </span><span class="s2">= </span><span class="s4">True</span>

            <span class="s5"># Get the current patch version.  If we have a</span>
            <span class="s5"># patch_version attribute, it refers to this particular</span>
            <span class="s5"># instance of the file, and that is the current patch</span>
            <span class="s5"># version number.  If we only have a last_patch_version</span>
            <span class="s5"># attribute, it means a patch has not yet been built for</span>
            <span class="s5"># this particular instance, and that number is the</span>
            <span class="s5"># previous version's patch version number.</span>
            <span class="s1">patchVersion </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'patch_version'</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">patchVersion</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">patchVersion </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">patchVersion</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">patchVersion </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'last_patch_version'</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">patchVersion</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">patchVersion </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">patchVersion</span><span class="s2">)</span>
                    <span class="s4">if </span><span class="s1">isNewVersion</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">patchVersion </span><span class="s2">+= </span><span class="s6">1</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">anyChanges </span><span class="s2">= </span><span class="s4">True</span>

            <span class="s5"># Put the patchVersion in the compressed filename, for</span>
            <span class="s5"># cache-busting.  This means when the version changes, its</span>
            <span class="s5"># URL will also change, guaranteeing that users will</span>
            <span class="s5"># download the latest version, and not some stale cache</span>
            <span class="s5"># file.</span>
            <span class="s1">xcompressed </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'compressed_archive'</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">xcompressed</span><span class="s2">:</span>
                <span class="s1">compressedFile </span><span class="s2">= </span><span class="s1">FileSpec</span><span class="s2">()</span>
                <span class="s1">compressedFile</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xcompressed</span><span class="s2">)</span>

                <span class="s1">oldCompressedFilename </span><span class="s2">= </span><span class="s1">compressedFile</span><span class="s2">.</span><span class="s1">filename</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">compressedFilename </span><span class="s2">= </span><span class="s1">oldCompressedFilename</span>

                <span class="s4">if </span><span class="s1">doProcessing</span><span class="s2">:</span>
                    <span class="s1">newCompressedFilename </span><span class="s2">= </span><span class="s3">'%s.%s.pz' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentFile</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">patchVersion</span><span class="s2">)</span>
                    <span class="s4">if </span><span class="s1">newCompressedFilename </span><span class="s2">!= </span><span class="s1">oldCompressedFilename</span><span class="s2">:</span>
                        <span class="s1">oldCompressedPathname </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">oldCompressedFilename</span><span class="s2">)</span>
                        <span class="s1">newCompressedPathname </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">newCompressedFilename</span><span class="s2">)</span>
                        <span class="s4">if </span><span class="s1">oldCompressedPathname</span><span class="s2">.</span><span class="s1">renameTo</span><span class="s2">(</span><span class="s1">newCompressedPathname</span><span class="s2">):</span>
                            <span class="s1">compressedFile</span><span class="s2">.</span><span class="s1">fromFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">newCompressedFilename</span><span class="s2">)</span>
                            <span class="s1">compressedFile</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xcompressed</span><span class="s2">)</span>

                        <span class="s1">self</span><span class="s2">.</span><span class="s1">compressedFilename </span><span class="s2">= </span><span class="s1">newCompressedFilename</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">anyChanges </span><span class="s2">= </span><span class="s4">True</span>

            <span class="s5"># Get the base_version--the bottom (oldest) of the patch</span>
            <span class="s5"># chain.</span>
            <span class="s1">xarchive </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'base_version'</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">xarchive</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">baseFile </span><span class="s2">= </span><span class="s1">FileSpec</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">baseFile</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xarchive</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s5"># If there isn't a base_version yet, we have to make</span>
                <span class="s5"># one, by duplicating the currentFile.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">baseFile </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentFile</span><span class="s2">)</span>

                <span class="s5"># Note that the we only store the compressed version</span>
                <span class="s5"># of base_filename on disk, but we store the md5 of</span>
                <span class="s5"># the uncompressed version in the xml file.  To</span>
                <span class="s5"># emphasize this, we name it without the .pz extension</span>
                <span class="s5"># in the xml file, even though the compressed file on</span>
                <span class="s5"># disk actually has a .pz extension.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">baseFile</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">+= </span><span class="s3">'.base'</span>

                <span class="s5"># Also duplicate the (compressed) file itself.</span>
                <span class="s4">if </span><span class="s1">doProcessing </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compressedFilename</span><span class="s2">:</span>
                    <span class="s1">fromPathname </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compressedFilename</span><span class="s2">)</span>
                    <span class="s1">toPathname </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">baseFile</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">+ </span><span class="s3">'.pz'</span><span class="s2">)</span>
                    <span class="s1">fromPathname</span><span class="s2">.</span><span class="s1">copyTo</span><span class="s2">(</span><span class="s1">toPathname</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">anyChanges </span><span class="s2">= </span><span class="s4">True</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">patches </span><span class="s2">= []</span>
            <span class="s1">xpatch </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'patch'</span><span class="s2">)</span>
            <span class="s4">while </span><span class="s1">xpatch</span><span class="s2">:</span>
                <span class="s1">patchfile </span><span class="s2">= </span><span class="s1">PatchMaker</span><span class="s2">.</span><span class="s1">Patchfile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
                <span class="s1">patchfile</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xpatch</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">patchfile</span><span class="s2">)</span>
                <span class="s1">xpatch </span><span class="s2">= </span><span class="s1">xpatch</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s3">'patch'</span><span class="s2">)</span>

            <span class="s4">return True</span>

        <span class="s4">def </span><span class="s1">writeDescFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Rewrites the desc file with the new patch 
            information. &quot;&quot;&quot;</span>

            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">anyChanges</span><span class="s2">:</span>
                <span class="s5"># No need to rewrite.</span>
                <span class="s4">return</span>

            <span class="s1">xpackage </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">doc</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'package'</span><span class="s2">)</span>
            <span class="s4">if not </span><span class="s1">xpackage</span><span class="s2">:</span>
                <span class="s4">return</span>

            <span class="s1">packageSeq </span><span class="s2">= </span><span class="s1">SeqValue</span><span class="s2">()</span>
            <span class="s1">packageSeq</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">, </span><span class="s3">'seq'</span><span class="s2">)</span>
            <span class="s1">packageSeq </span><span class="s2">+= </span><span class="s6">1</span>
            <span class="s1">packageSeq</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">, </span><span class="s3">'seq'</span><span class="s2">)</span>

            <span class="s5"># Remove all of the old patch entries from the desc file</span>
            <span class="s5"># we read earlier.</span>
            <span class="s1">xremove </span><span class="s2">= []</span>
            <span class="s4">for </span><span class="s1">value </span><span class="s4">in </span><span class="s2">[</span><span class="s3">'base_version'</span><span class="s2">, </span><span class="s3">'top_version'</span><span class="s2">, </span><span class="s3">'patch'</span><span class="s2">]:</span>
                <span class="s1">xpatch </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
                <span class="s4">while </span><span class="s1">xpatch</span><span class="s2">:</span>
                    <span class="s1">xremove</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">xpatch</span><span class="s2">)</span>
                    <span class="s1">xpatch </span><span class="s2">= </span><span class="s1">xpatch</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

            <span class="s4">for </span><span class="s1">xelement </span><span class="s4">in </span><span class="s1">xremove</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">RemoveChild</span><span class="s2">(</span><span class="s1">xelement</span><span class="s2">)</span>

            <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">RemoveAttribute</span><span class="s2">(</span><span class="s3">'last_patch_version'</span><span class="s2">)</span>

            <span class="s5"># Now replace them with the current patch information.</span>
            <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'patch_version'</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">patchVersion</span><span class="s2">))</span>

            <span class="s1">xarchive </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'base_version'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">baseFile</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xarchive</span><span class="s2">)</span>
            <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xarchive</span><span class="s2">)</span>

            <span class="s5"># The current version is now the top version.</span>
            <span class="s1">xarchive </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'top_version'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">currentFile</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xarchive</span><span class="s2">)</span>
            <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xarchive</span><span class="s2">)</span>

            <span class="s4">for </span><span class="s1">patchfile </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">patches</span><span class="s2">:</span>
                <span class="s1">xpatch </span><span class="s2">= </span><span class="s1">patchfile</span><span class="s2">.</span><span class="s1">makeXml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xpatch</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">doc</span><span class="s2">.</span><span class="s1">SaveFile</span><span class="s2">()</span>

            <span class="s5"># Also copy the seq to the import desc file, for</span>
            <span class="s5"># documentation purposes.</span>

            <span class="s1">importDescFilename </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageDesc</span><span class="s2">)[:-</span><span class="s6">3</span><span class="s2">] + </span><span class="s3">'import.xml'</span>
            <span class="s1">importDescFullpath </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">patchMaker</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">, </span><span class="s1">importDescFilename</span><span class="s2">)</span>
            <span class="s1">doc </span><span class="s2">= </span><span class="s1">TiXmlDocument</span><span class="s2">(</span><span class="s1">importDescFullpath</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
            <span class="s4">if </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">LoadFile</span><span class="s2">():</span>
                <span class="s1">xpackage </span><span class="s2">= </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'package'</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">xpackage</span><span class="s2">:</span>
                    <span class="s1">packageSeq</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">, </span><span class="s3">'seq'</span><span class="s2">)</span>
                    <span class="s1">doc</span><span class="s2">.</span><span class="s1">SaveFile</span><span class="s2">()</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Couldn't read %s&quot; </span><span class="s2">% (</span><span class="s1">importDescFullpath</span><span class="s2">))</span>

            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">contentsDocPackage</span><span class="s2">:</span>
                <span class="s5"># Now that we've rewritten the xml file, we have to</span>
                <span class="s5"># change the contents.xml file that references it to</span>
                <span class="s5"># indicate the new file hash.</span>
                <span class="s1">fileSpec </span><span class="s2">= </span><span class="s1">FileSpec</span><span class="s2">()</span>
                <span class="s1">fileSpec</span><span class="s2">.</span><span class="s1">fromFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">patchMaker</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageDesc</span><span class="s2">)</span>
                <span class="s1">fileSpec</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">contentsDocPackage</span><span class="s2">)</span>

                <span class="s5"># Also important to update the import.xml hash.</span>
                <span class="s1">ximport </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">contentsDocPackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'import'</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">ximport</span><span class="s2">:</span>
                    <span class="s1">fileSpec </span><span class="s2">= </span><span class="s1">FileSpec</span><span class="s2">()</span>
                    <span class="s1">fileSpec</span><span class="s2">.</span><span class="s1">fromFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">patchMaker</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">, </span><span class="s1">importDescFilename</span><span class="s2">)</span>
                    <span class="s1">fileSpec</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">ximport</span><span class="s2">)</span>

                <span class="s5"># Also copy the package seq value into the</span>
                <span class="s5"># contents.xml file, mainly for documentation purposes</span>
                <span class="s5"># (the authoritative seq value is within the desc</span>
                <span class="s5"># file).</span>
                <span class="s1">packageSeq</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">contentsDocPackage</span><span class="s2">, </span><span class="s3">'seq'</span><span class="s2">)</span>


    <span class="s5"># PatchMaker constructor.</span>
    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">installDir</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">installDir </span><span class="s2">= </span><span class="s1">installDir</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">packageVersions </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">packages </span><span class="s2">= []</span>

    <span class="s4">def </span><span class="s1">buildPatches</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageNames </span><span class="s2">= </span><span class="s4">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Makes the patches required in a particular directory 
        structure on disk.  If packageNames is None, this makes 
        patches for all packages; otherwise, it should be a list of 
        package name strings, limiting the set of packages that are 
        processed. &quot;&quot;&quot;</span>

        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">readContentsFile</span><span class="s2">():</span>
            <span class="s4">return False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">buildPatchChains</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">packageNames </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">processAllPackages</span><span class="s2">()</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">processSomePackages</span><span class="s2">(</span><span class="s1">packageNames</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">writeContentsFile</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cleanup</span><span class="s2">()</span>
        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">cleanup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Should be called on exit to remove temporary files and 
        such created during processing. &quot;&quot;&quot;</span>

        <span class="s4">for </span><span class="s1">pv </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageVersions</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
            <span class="s1">pv</span><span class="s2">.</span><span class="s1">cleanup</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">getPatchChainToCurrent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">descFilename</span><span class="s2">, </span><span class="s1">fileSpec</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Reads the package defined in the indicated desc file, and 
        constructs a patch chain from the version represented by 
        fileSpec to the current version of this package, if possible. 
        Returns the patch chain if successful, or None otherwise. &quot;&quot;&quot;</span>

        <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">readPackageDescFile</span><span class="s2">(</span><span class="s1">descFilename</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">package</span><span class="s2">:</span>
            <span class="s4">return None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">buildPatchChains</span><span class="s2">()</span>
        <span class="s1">fromPv </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getPackageVersion</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">getGenericKey</span><span class="s2">(</span><span class="s1">fileSpec</span><span class="s2">))</span>
        <span class="s1">toPv </span><span class="s2">= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">currentPv</span>

        <span class="s1">patchChain </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">if </span><span class="s1">toPv </span><span class="s4">and </span><span class="s1">fromPv</span><span class="s2">:</span>
            <span class="s1">patchChain </span><span class="s2">= </span><span class="s1">toPv</span><span class="s2">.</span><span class="s1">getPatchChain</span><span class="s2">(</span><span class="s1">fromPv</span><span class="s2">)</span>

        <span class="s4">return </span><span class="s1">patchChain</span>

    <span class="s4">def </span><span class="s1">readPackageDescFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">descFilename</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Reads a desc file associated with a particular package, 
        and adds the package to self.packages.  Returns the Package 
        object, or None on failure. &quot;&quot;&quot;</span>

        <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">Package</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">descFilename</span><span class="s2">), </span><span class="s1">self</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">readDescFile</span><span class="s2">(</span><span class="s1">doProcessing </span><span class="s2">= </span><span class="s4">False</span><span class="s2">):</span>
            <span class="s4">return None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">package</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">package</span>

    <span class="s4">def </span><span class="s1">readContentsFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Reads the contents.xml file at the beginning of 
        processing. &quot;&quot;&quot;</span>

        <span class="s1">contentsFilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">, </span><span class="s3">'contents.xml'</span><span class="s2">)</span>
        <span class="s1">doc </span><span class="s2">= </span><span class="s1">TiXmlDocument</span><span class="s2">(</span><span class="s1">contentsFilename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s4">if not </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">LoadFile</span><span class="s2">():</span>
            <span class="s5"># Couldn't read file.</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;couldn't read %s&quot; </span><span class="s2">% (</span><span class="s1">contentsFilename</span><span class="s2">))</span>
            <span class="s4">return False</span>

        <span class="s1">xcontents </span><span class="s2">= </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'contents'</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">xcontents</span><span class="s2">:</span>
            <span class="s1">contentsSeq </span><span class="s2">= </span><span class="s1">SeqValue</span><span class="s2">()</span>
            <span class="s1">contentsSeq</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xcontents</span><span class="s2">)</span>
            <span class="s1">contentsSeq </span><span class="s2">+= </span><span class="s6">1</span>
            <span class="s1">contentsSeq</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xcontents</span><span class="s2">)</span>

            <span class="s1">xpackage </span><span class="s2">= </span><span class="s1">xcontents</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'package'</span><span class="s2">)</span>
            <span class="s4">while </span><span class="s1">xpackage</span><span class="s2">:</span>
                <span class="s1">solo </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'solo'</span><span class="s2">)</span>
                <span class="s1">solo </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">solo </span><span class="s4">or </span><span class="s3">'0'</span><span class="s2">)</span>
                <span class="s1">filename </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'filename'</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">filename </span><span class="s4">and not </span><span class="s1">solo</span><span class="s2">:</span>
                    <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
                    <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">Package</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">xpackage</span><span class="s2">)</span>
                    <span class="s1">package</span><span class="s2">.</span><span class="s1">readDescFile</span><span class="s2">(</span><span class="s1">doProcessing </span><span class="s2">= </span><span class="s4">True</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">package</span><span class="s2">)</span>

                <span class="s1">xpackage </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s3">'package'</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">contentsDoc </span><span class="s2">= </span><span class="s1">doc</span>

        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">writeContentsFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Writes the contents.xml file at the end of processing. &quot;&quot;&quot;</span>

        <span class="s5"># We also have to write the desc file for all packages that</span>
        <span class="s5"># might need it, because we might have changed some of them on</span>
        <span class="s5"># read.</span>
        <span class="s4">for </span><span class="s1">package </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">:</span>
            <span class="s1">package</span><span class="s2">.</span><span class="s1">writeDescFile</span><span class="s2">()</span>

        <span class="s5"># The above writeDescFile() call should also update each</span>
        <span class="s5"># package's element within the contents.xml document, so all</span>
        <span class="s5"># we have to do now is write out the document.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">contentsDoc</span><span class="s2">.</span><span class="s1">SaveFile</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">getPackageVersion</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Returns a shared PackageVersion object for the indicated 
        key. &quot;&quot;&quot;</span>

        <span class="s1">packageName</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">file </span><span class="s2">= </span><span class="s1">key</span>

        <span class="s5"># We actually key on the hash, not the FileSpec itself.</span>
        <span class="s1">k </span><span class="s2">= (</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">file</span><span class="s2">.</span><span class="s1">hash</span><span class="s2">)</span>
        <span class="s1">pv </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageVersions</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">pv</span><span class="s2">:</span>
            <span class="s1">pv </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">PackageVersion</span><span class="s2">(*</span><span class="s1">key</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageVersions</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] = </span><span class="s1">pv</span>
        <span class="s4">return </span><span class="s1">pv</span>

    <span class="s4">def </span><span class="s1">buildPatchChains</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Builds up the chains of PackageVersions and the patchfiles 
        that connect them. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">patchFilenames </span><span class="s2">= {}</span>

        <span class="s4">for </span><span class="s1">package </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">baseFile</span><span class="s2">:</span>
                <span class="s5"># This package doesn't have any versions yet.</span>
                <span class="s4">continue</span>

            <span class="s1">currentPv </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getPackageVersion</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">getCurrentKey</span><span class="s2">())</span>
            <span class="s1">package</span><span class="s2">.</span><span class="s1">currentPv </span><span class="s2">= </span><span class="s1">currentPv</span>
            <span class="s1">currentPv</span><span class="s2">.</span><span class="s1">packageCurrent </span><span class="s2">= </span><span class="s1">package</span>
            <span class="s1">currentPv</span><span class="s2">.</span><span class="s1">printName </span><span class="s2">= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">currentFile</span><span class="s2">.</span><span class="s1">filename</span>

            <span class="s1">basePv </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getPackageVersion</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">getBaseKey</span><span class="s2">())</span>
            <span class="s1">package</span><span class="s2">.</span><span class="s1">basePv </span><span class="s2">= </span><span class="s1">basePv</span>
            <span class="s1">basePv</span><span class="s2">.</span><span class="s1">packageBase </span><span class="s2">= </span><span class="s1">package</span>
            <span class="s1">basePv</span><span class="s2">.</span><span class="s1">printName </span><span class="s2">= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">baseFile</span><span class="s2">.</span><span class="s1">filename</span>

            <span class="s1">topPv </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getPackageVersion</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">getTopKey</span><span class="s2">())</span>
            <span class="s1">package</span><span class="s2">.</span><span class="s1">topPv </span><span class="s2">= </span><span class="s1">topPv</span>
            <span class="s1">topPv</span><span class="s2">.</span><span class="s1">packageTop </span><span class="s2">= </span><span class="s1">package</span>

            <span class="s4">for </span><span class="s1">patchfile </span><span class="s4">in </span><span class="s1">package</span><span class="s2">.</span><span class="s1">patches</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">recordPatchfile</span><span class="s2">(</span><span class="s1">patchfile</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">recordPatchfile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">patchfile</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Adds the indicated patchfile to the patch chains. &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">patchFilenames</span><span class="s2">[</span><span class="s1">patchfile</span><span class="s2">.</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">] = </span><span class="s1">patchfile</span>

        <span class="s1">fromPv </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getPackageVersion</span><span class="s2">(</span><span class="s1">patchfile</span><span class="s2">.</span><span class="s1">getSourceKey</span><span class="s2">())</span>
        <span class="s1">patchfile</span><span class="s2">.</span><span class="s1">fromPv </span><span class="s2">= </span><span class="s1">fromPv</span>
        <span class="s1">fromPv</span><span class="s2">.</span><span class="s1">toPatches</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">patchfile</span><span class="s2">)</span>

        <span class="s1">toPv </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getPackageVersion</span><span class="s2">(</span><span class="s1">patchfile</span><span class="s2">.</span><span class="s1">getTargetKey</span><span class="s2">())</span>
        <span class="s1">patchfile</span><span class="s2">.</span><span class="s1">toPv </span><span class="s2">= </span><span class="s1">toPv</span>
        <span class="s1">toPv</span><span class="s2">.</span><span class="s1">fromPatches</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">patchfile</span><span class="s2">)</span>
        <span class="s1">toPv</span><span class="s2">.</span><span class="s1">printName </span><span class="s2">= </span><span class="s1">patchfile</span><span class="s2">.</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span>

    <span class="s4">def </span><span class="s1">processSomePackages</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageNames</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Builds missing patches only for the named packages. &quot;&quot;&quot;</span>

        <span class="s1">remainingNames </span><span class="s2">= </span><span class="s1">packageNames</span><span class="s2">[:]</span>
        <span class="s4">for </span><span class="s1">package </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName </span><span class="s4">in </span><span class="s1">packageNames</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">processPackage</span><span class="s2">(</span><span class="s1">package</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName </span><span class="s4">in </span><span class="s1">remainingNames</span><span class="s2">:</span>
                <span class="s1">remainingNames</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">remainingNames</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Unknown packages: %s&quot; </span><span class="s2">% (</span><span class="s1">remainingNames</span><span class="s2">,))</span>

    <span class="s4">def </span><span class="s1">processAllPackages</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Walks through the list of packages, and builds missing 
        patches for each one. &quot;&quot;&quot;</span>

        <span class="s4">for </span><span class="s1">package </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">processPackage</span><span class="s2">(</span><span class="s1">package</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">processPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">package</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Builds missing patches for the indicated package. &quot;&quot;&quot;</span>

        <span class="s4">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">baseFile</span><span class="s2">:</span>
            <span class="s5"># No versions.</span>
            <span class="s4">return</span>

        <span class="s5"># What's the current version on the top of the tree?</span>
        <span class="s1">topPv </span><span class="s2">= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">topPv</span>
        <span class="s1">currentPv </span><span class="s2">= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">currentPv</span>

        <span class="s4">if </span><span class="s1">topPv </span><span class="s2">!= </span><span class="s1">currentPv</span><span class="s2">:</span>
            <span class="s5"># They're different, so build a new patch.</span>
            <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">currentFile</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">+ </span><span class="s3">'.%s.patch' </span><span class="s2">% (</span><span class="s1">package</span><span class="s2">.</span><span class="s1">patchVersion</span><span class="s2">))</span>
            <span class="s4">assert </span><span class="s1">filename </span><span class="s4">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">patchFilenames</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buildPatch</span><span class="s2">(</span><span class="s1">topPv</span><span class="s2">, </span><span class="s1">currentPv</span><span class="s2">, </span><span class="s1">package</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">):</span>
                <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;Couldn't build patch.&quot;</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">buildPatch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">v1</span><span class="s2">, </span><span class="s1">v2</span><span class="s2">, </span><span class="s1">package</span><span class="s2">, </span><span class="s1">patchFilename</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Builds a patch from PackageVersion v1 to PackageVersion 
        v2, and stores it in patchFilename.pz.  Returns true on 
        success, false on failure.&quot;&quot;&quot;</span>

        <span class="s1">pathname </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">patchFilename</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buildPatchFile</span><span class="s2">(</span><span class="s1">v1</span><span class="s2">.</span><span class="s1">getFile</span><span class="s2">(), </span><span class="s1">v2</span><span class="s2">.</span><span class="s1">getFile</span><span class="s2">(), </span><span class="s1">pathname</span><span class="s2">,</span>
                                   <span class="s1">v1</span><span class="s2">.</span><span class="s1">printName</span><span class="s2">, </span><span class="s1">v2</span><span class="s2">.</span><span class="s1">printName</span><span class="s2">):</span>
            <span class="s4">return False</span>

        <span class="s1">compressedPathname </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">pathname </span><span class="s2">+ </span><span class="s3">'.pz'</span><span class="s2">)</span>
        <span class="s1">compressedPathname</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>
        <span class="s4">if not </span><span class="s1">compressFile</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">compressedPathname</span><span class="s2">, </span><span class="s6">9</span><span class="s2">):</span>
            <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;Couldn't compress patch.&quot;</span><span class="s2">)</span>
        <span class="s1">pathname</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>

        <span class="s1">patchfile </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">Patchfile</span><span class="s2">(</span><span class="s1">package</span><span class="s2">)</span>
        <span class="s1">patchfile</span><span class="s2">.</span><span class="s1">fromFile</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">patchFilename </span><span class="s2">+ </span><span class="s3">'.pz'</span><span class="s2">,</span>
                           <span class="s1">v1</span><span class="s2">.</span><span class="s1">file</span><span class="s2">, </span><span class="s1">v2</span><span class="s2">.</span><span class="s1">file</span><span class="s2">)</span>
        <span class="s1">package</span><span class="s2">.</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">patchfile</span><span class="s2">)</span>
        <span class="s1">package</span><span class="s2">.</span><span class="s1">anyChanges </span><span class="s2">= </span><span class="s4">True</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">recordPatchfile</span><span class="s2">(</span><span class="s1">patchfile</span><span class="s2">)</span>

        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">buildPatchFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">origFilename</span><span class="s2">, </span><span class="s1">newFilename</span><span class="s2">, </span><span class="s1">patchFilename</span><span class="s2">,</span>
                       <span class="s1">printOrigName</span><span class="s2">, </span><span class="s1">printNewName</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Creates a patch file from origFilename to newFilename, 
        storing the result in patchFilename.  Returns true on success, 
        false on failure. &quot;&quot;&quot;</span>

        <span class="s4">if not </span><span class="s1">origFilename</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">():</span>
            <span class="s5"># No original version to patch from.</span>
            <span class="s4">return False</span>

        <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Building patch from %s to %s&quot; </span><span class="s2">% (</span><span class="s1">printOrigName</span><span class="s2">, </span><span class="s1">printNewName</span><span class="s2">))</span>
        <span class="s1">patchFilename</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">Patchfile</span><span class="s2">()  </span><span class="s5"># The C++ class</span>
        <span class="s4">if </span><span class="s1">p</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">origFilename</span><span class="s2">, </span><span class="s1">newFilename</span><span class="s2">, </span><span class="s1">patchFilename</span><span class="s2">):</span>
            <span class="s4">return True</span>

        <span class="s5"># Unable to build a patch for some reason.</span>
        <span class="s1">patchFilename</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>
        <span class="s4">return False</span>
</pre>
</body>
</html>