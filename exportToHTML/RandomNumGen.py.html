<html>
<head>
<title>RandomNumGen.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
RandomNumGen.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;RandomNumGen module: contains the RandomNumGen class&quot;&quot;&quot;</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">'randHash'</span><span class="s2">, </span><span class="s3">'RandomNumGen'</span><span class="s2">]</span>

<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">directnotify </span><span class="s4">import </span><span class="s1">DirectNotifyGlobal</span>
<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s1">Mersenne</span>

<span class="s4">def </span><span class="s1">randHash</span><span class="s2">(</span><span class="s1">num</span><span class="s2">):</span>
    <span class="s0">&quot;&quot;&quot; this returns a random 16-bit integer, given a seed integer. 
    It will always return the same output given the same input. 
    This is useful for repeatably mapping numbers with predictable 
    bit patterns (i.e. doIds or zoneIds) to numbers with random bit patterns 
    &quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">RandomNumGen</span><span class="s2">(</span><span class="s1">num</span><span class="s2">)</span>
    <span class="s4">return </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">&lt;&lt;</span><span class="s5">16</span><span class="s2">) - </span><span class="s5">1</span><span class="s2">)</span>

<span class="s4">class </span><span class="s1">RandomNumGen</span><span class="s2">:</span>
    <span class="s1">notify </span><span class="s2">= </span><span class="s1">\</span>
      <span class="s1">DirectNotifyGlobal</span><span class="s2">.</span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s3">&quot;RandomNumGen&quot;</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot;seed must be an integer or another RandomNumGen&quot;&quot;&quot;</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">, </span><span class="s1">RandomNumGen</span><span class="s2">):</span>
            <span class="s6"># seed this rng with the other rng</span>
            <span class="s1">rng </span><span class="s2">= </span><span class="s1">seed</span>
            <span class="s1">seed </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1 </span><span class="s2">&lt;&lt; </span><span class="s5">16</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;seed: &quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">))</span>
        <span class="s1">seed </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">Mersenne</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__rng </span><span class="s2">= </span><span class="s1">rng</span>

    <span class="s4">def </span><span class="s1">__rand</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">N</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot;returns integer in [0..N)&quot;&quot;&quot;</span>
        <span class="s3">&quot;&quot;&quot; 
        # using modulus biases the numbers a little bit 
        # the bias is worse for larger values of N 
        return self.__rng.getUint31() % N 
        &quot;&quot;&quot;</span>

        <span class="s6"># this technique produces an even distribution.</span>
        <span class="s6"># random.py would solve this problem like so:</span>
        <span class="s6"># where:</span>
        <span class="s6">#   M=randomly generated number</span>
        <span class="s6">#   O=1 greater than the maximum value of M</span>
        <span class="s6"># return int(float(M)*(float(N)/float(O))) # M*(N/O)</span>
        <span class="s6">#</span>
        <span class="s6"># that generally works fine, except that it relies</span>
        <span class="s6"># on floating-point numbers, which are not guaranteed</span>
        <span class="s6"># to produce identical results on different machines.</span>
        <span class="s6">#</span>
        <span class="s6"># for our purposes, we need an entirely-integer approach,</span>
        <span class="s6"># since integer operations *are* guaranteed to produce</span>
        <span class="s6"># identical results on different machines.</span>
        <span class="s6">#</span>
        <span class="s6"># SO, we take the equation M*(N/O) and change the order of</span>
        <span class="s6"># operations to (M*N)/O.</span>
        <span class="s6">#</span>
        <span class="s6"># this requires that we have the ability to hold the result of</span>
        <span class="s6"># M*N. Luckily, Python has support for large integers. One</span>
        <span class="s6"># alternative would be to limit the RNG to a 16-bit range,</span>
        <span class="s6"># in which case we could do this math down in C++; but 16 bits</span>
        <span class="s6"># really doesn't provide a large enough range (0..65535).</span>
        <span class="s6"># Finally, since our O happens to be a power of two (0x80000000),</span>
        <span class="s6"># we can replace the divide with a shift.</span>
        <span class="s6"># boo-ya</span>

        <span class="s6"># the maximum for N ought to be 0x80000000, but Python treats</span>
        <span class="s6"># that as a negative number.</span>
        <span class="s4">assert </span><span class="s1">N </span><span class="s2">&gt;= </span><span class="s5">0</span>
        <span class="s4">assert </span><span class="s1">N </span><span class="s2">&lt;= </span><span class="s5">0x7fffffff</span>

        <span class="s4">return </span><span class="s1">int</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__rng</span><span class="s2">.</span><span class="s1">getUint31</span><span class="s2">() * </span><span class="s1">N</span><span class="s2">) &gt;&gt; </span><span class="s5">31</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">choice</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">seq</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot;returns a random element from seq&quot;&quot;&quot;</span>
        <span class="s4">return </span><span class="s1">seq</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__rand</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">seq</span><span class="s2">))]</span>

    <span class="s4">def </span><span class="s1">shuffle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot;randomly shuffles x in-place&quot;&quot;&quot;</span>
        <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) - </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">):</span>
            <span class="s6"># pick an element in x[:i+1] with which to exchange x[i]</span>
            <span class="s1">j </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__rand</span><span class="s2">(</span><span class="s1">i</span><span class="s2">+</span><span class="s5">1</span><span class="s2">))</span>
            <span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] = </span><span class="s1">x</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>

    <span class="s4">def </span><span class="s1">randrange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">step</span><span class="s2">=</span><span class="s5">1</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot;randrange([start,] stop[, step]) 
        same as choice(range(start, stop[, step])) without construction 
        of a list&quot;&quot;&quot;</span>
        <span class="s6">## this was lifted from Python2.2's random.py</span>
        <span class="s6"># This code is a bit messy to make it fast for the</span>
        <span class="s6"># common case while still doing adequate error checking</span>
        <span class="s1">istart </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">start</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">istart </span><span class="s2">!= </span><span class="s1">start</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;non-integer arg 1 for randrange()&quot;</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">stop </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">istart </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__rand</span><span class="s2">(</span><span class="s1">istart</span><span class="s2">)</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;empty range for randrange()&quot;</span><span class="s2">)</span>
        <span class="s1">istop </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">stop</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">istop </span><span class="s2">!= </span><span class="s1">stop</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;non-integer stop for randrange()&quot;</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">step </span><span class="s2">== </span><span class="s5">1</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">istart </span><span class="s2">&lt; </span><span class="s1">istop</span><span class="s2">:</span>
                <span class="s4">return </span><span class="s1">istart </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__rand</span><span class="s2">(</span><span class="s1">istop </span><span class="s2">- </span><span class="s1">istart</span><span class="s2">)</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;empty range for randrange()&quot;</span><span class="s2">)</span>
        <span class="s1">istep </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">step</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">istep </span><span class="s2">!= </span><span class="s1">step</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;non-integer step for randrange()&quot;</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">istep </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">n </span><span class="s2">= (</span><span class="s1">istop </span><span class="s2">- </span><span class="s1">istart </span><span class="s2">+ </span><span class="s1">istep </span><span class="s2">- </span><span class="s5">1</span><span class="s2">) / </span><span class="s1">istep</span>
        <span class="s4">elif </span><span class="s1">istep </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">n </span><span class="s2">= (</span><span class="s1">istop </span><span class="s2">- </span><span class="s1">istart </span><span class="s2">+ </span><span class="s1">istep </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / </span><span class="s1">istep</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;zero step for randrange()&quot;</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">n </span><span class="s2">&lt;= </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;empty range for randrange()&quot;</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">istart </span><span class="s2">+ </span><span class="s1">istep</span><span class="s2">*</span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__rand</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">randint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot;returns integer in [a, b]&quot;&quot;&quot;</span>
        <span class="s4">assert </span><span class="s1">a </span><span class="s2">&lt;= </span><span class="s1">b</span>
        <span class="s1">range </span><span class="s2">= </span><span class="s1">b</span><span class="s2">-</span><span class="s1">a</span><span class="s2">+</span><span class="s5">1</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__rand</span><span class="s2">(</span><span class="s1">range</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">a</span><span class="s2">+</span><span class="s1">r</span>

    <span class="s6"># since floats are involved, I would recommend not trusting</span>
    <span class="s6"># this function for important decision points where remote</span>
    <span class="s6"># synchronicity is critical</span>
    <span class="s4">def </span><span class="s1">random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot;returns random float in [0.0, 1.0)&quot;&quot;&quot;</span>
        <span class="s4">return </span><span class="s1">float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__rng</span><span class="s2">.</span><span class="s1">getUint31</span><span class="s2">()) / </span><span class="s1">float</span><span class="s2">(</span><span class="s5">1 </span><span class="s2">&lt;&lt; </span><span class="s5">31</span><span class="s2">)</span>
</pre>
</body>
</html>