<html>
<head>
<title>FileAssociation.nsh</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #bcbec4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
FileAssociation.nsh</font>
</center></td></tr></table>
<pre><span class="s0">/*</span>
<span class="s0">_____________________________________________________________________________</span>
 
                       <span class="s0">File Association</span>
<span class="s0">_____________________________________________________________________________</span>
 
 <span class="s0">Based on code taken from http://nsis.sourceforge.net/File_Association </span>
 
 <span class="s0">Usage in script:</span>
 <span class="s0">1. !include &quot;FileAssociation.nsh&quot;</span>
 <span class="s0">2. [Section|Function]</span>
      <span class="s0">${FileAssociationFunction} &quot;Param1&quot; &quot;Param2&quot; &quot;...&quot; $var</span>
    <span class="s0">[SectionEnd|FunctionEnd]</span>
 
 <span class="s0">FileAssociationFunction=[RegisterExtension|UnRegisterExtension]</span>
 
<span class="s0">_____________________________________________________________________________</span>
 
 <span class="s0">${RegisterExtension} &quot;[executable]&quot; &quot;[extension]&quot; &quot;[description]&quot;</span>
 
<span class="s0">&quot;[executable]&quot;     ; executable which opens the file format</span>
                   <span class="s0">;</span>
<span class="s0">&quot;[extension]&quot;      ; extension, which represents the file format to open</span>
                   <span class="s0">;</span>
<span class="s0">&quot;[description]&quot;    ; description for the extension. This will be display in Windows Explorer.</span>
                   <span class="s0">;</span>
 
 
 <span class="s0">${UnRegisterExtension} &quot;[extension]&quot; &quot;[description]&quot;</span>
 
<span class="s0">&quot;[extension]&quot;      ; extension, which represents the file format to open</span>
                   <span class="s0">;</span>
<span class="s0">&quot;[description]&quot;    ; description for the extension. This will be display in Windows Explorer.</span>
                   <span class="s0">;</span>
 
<span class="s0">_____________________________________________________________________________</span>
 
                         <span class="s0">Macros</span>
<span class="s0">_____________________________________________________________________________</span>
 
 <span class="s0">Change log window verbosity (default: 3=no script)</span>
 
 <span class="s0">Example:</span>
 <span class="s0">!include &quot;FileAssociation.nsh&quot;</span>
 <span class="s0">!insertmacro RegisterExtension</span>
 <span class="s0">${FileAssociation_VERBOSE} 4   # all verbosity</span>
 <span class="s0">!insertmacro UnRegisterExtension</span>
 <span class="s0">${FileAssociation_VERBOSE} 3   # no script</span>
<span class="s0">*/</span>
 
 
<span class="s0">!ifndef FileAssociation_INCLUDED</span>
<span class="s0">!define FileAssociation_INCLUDED</span>
 
<span class="s0">!include Util.nsh</span>
 
<span class="s0">!verbose push</span>
<span class="s0">!verbose 3</span>
<span class="s0">!ifndef _FileAssociation_VERBOSE</span>
  <span class="s0">!define _FileAssociation_VERBOSE 3</span>
<span class="s0">!endif</span>
<span class="s0">!verbose ${_FileAssociation_VERBOSE}</span>
<span class="s0">!define FileAssociation_VERBOSE `!insertmacro FileAssociation_VERBOSE`</span>
<span class="s0">!verbose pop</span>
 
<span class="s0">!macro FileAssociation_VERBOSE _VERBOSE</span>
  <span class="s0">!verbose push</span>
  <span class="s0">!verbose 3</span>
  <span class="s0">!undef _FileAssociation_VERBOSE</span>
  <span class="s0">!define _FileAssociation_VERBOSE ${_VERBOSE}</span>
  <span class="s0">!verbose pop</span>
<span class="s0">!macroend</span>
 
 
 
<span class="s0">!macro RegisterExtensionCall _EXECUTABLE _EXTENSION _DESCRIPTION</span>
  <span class="s0">!verbose push</span>
  <span class="s0">!verbose ${_FileAssociation_VERBOSE}</span>
  <span class="s0">Push `${_DESCRIPTION}`</span>
  <span class="s0">Push `${_EXTENSION}`</span>
  <span class="s0">Push `${_EXECUTABLE}`</span>
  <span class="s0">${CallArtificialFunction} RegisterExtension_</span>
  <span class="s0">!verbose pop</span>
<span class="s0">!macroend</span>
 
<span class="s0">!macro UnRegisterExtensionCall _EXTENSION _DESCRIPTION</span>
  <span class="s0">!verbose push</span>
  <span class="s0">!verbose ${_FileAssociation_VERBOSE}</span>
  <span class="s0">Push `${_EXTENSION}`</span>
  <span class="s0">Push `${_DESCRIPTION}`</span>
  <span class="s0">${CallArtificialFunction} UnRegisterExtension_</span>
  <span class="s0">!verbose pop</span>
<span class="s0">!macroend</span>
 
 
 
<span class="s0">!define RegisterExtension `!insertmacro RegisterExtensionCall`</span>
<span class="s0">!define un.RegisterExtension `!insertmacro RegisterExtensionCall`</span>
 
<span class="s0">!macro RegisterExtension</span>
<span class="s0">!macroend</span>
 
<span class="s0">!macro un.RegisterExtension</span>
<span class="s0">!macroend</span>
 
<span class="s0">!macro RegisterExtension_</span>
  <span class="s0">!verbose push</span>
  <span class="s0">!verbose ${_FileAssociation_VERBOSE}</span>
 
  <span class="s0">Exch $R2 ;exe</span>
  <span class="s0">Exch</span>
  <span class="s0">Exch $R1 ;ext</span>
  <span class="s0">Exch</span>
  <span class="s0">Exch 2</span>
  <span class="s0">Exch $R0 ;desc</span>
  <span class="s0">Exch 2</span>
  <span class="s0">Push $0</span>
  <span class="s0">Push $1</span>
 
  <span class="s0">ReadRegStr $1 HKCR $R1 &quot;&quot;  ; read current file association</span>
  <span class="s0">StrCmp &quot;$1&quot; &quot;&quot; NoBackup  ; is it empty</span>
  <span class="s0">StrCmp &quot;$1&quot; &quot;$R0&quot; NoBackup  ; is it our own</span>
    <span class="s0">WriteRegStr HKCR $R1 &quot;backup_val&quot; &quot;$1&quot;  ; backup current value</span>
<span class="s0">NoBackup:</span>
  <span class="s0">WriteRegStr HKCR $R1 &quot;&quot; &quot;$R0&quot;  ; set our file association</span>
 
  <span class="s0">ReadRegStr $0 HKCR $R0 &quot;&quot;</span>
  <span class="s0">StrCmp $0 &quot;&quot; 0 Skip</span>
    <span class="s0">WriteRegStr HKCR &quot;$R0&quot; &quot;&quot; &quot;$R0&quot;</span>
    <span class="s0">WriteRegStr HKCR &quot;$R0\shell&quot; &quot;&quot; &quot;open&quot;</span>
    <span class="s0">WriteRegStr HKCR &quot;$R0\DefaultIcon&quot; &quot;&quot; &quot;$R2,0&quot;</span>
<span class="s0">Skip:</span>
  <span class="s0">WriteRegStr HKCR &quot;$R0\shell\open\command&quot; &quot;&quot; '&quot;$R2&quot; &quot;%1&quot;'</span>
  <span class="s0">WriteRegStr HKCR &quot;$R0\shell\edit&quot; &quot;&quot; &quot;Edit $R0&quot;</span>
  <span class="s0">WriteRegStr HKCR &quot;$R0\shell\edit\command&quot; &quot;&quot; '&quot;$R2&quot; &quot;%1&quot;'</span>
 
  <span class="s0">Pop $1</span>
  <span class="s0">Pop $0</span>
  <span class="s0">Pop $R2</span>
  <span class="s0">Pop $R1</span>
  <span class="s0">Pop $R0</span>
 
  <span class="s0">!verbose pop</span>
<span class="s0">!macroend</span>
 
 
 
<span class="s0">!define UnRegisterExtension `!insertmacro UnRegisterExtensionCall`</span>
<span class="s0">!define un.UnRegisterExtension `!insertmacro UnRegisterExtensionCall`</span>
 
<span class="s0">!macro UnRegisterExtension</span>
<span class="s0">!macroend</span>
 
<span class="s0">!macro un.UnRegisterExtension</span>
<span class="s0">!macroend</span>
 
<span class="s0">!macro UnRegisterExtension_</span>
  <span class="s0">!verbose push</span>
  <span class="s0">!verbose ${_FileAssociation_VERBOSE}</span>
 
  <span class="s0">Exch $R1 ;desc</span>
  <span class="s0">Exch</span>
  <span class="s0">Exch $R0 ;ext</span>
  <span class="s0">Exch</span>
  <span class="s0">Push $0</span>
  <span class="s0">Push $1</span>
 
  <span class="s0">ReadRegStr $1 HKCR $R0 &quot;&quot;</span>
  <span class="s0">StrCmp $1 $R1 0 NoOwn ; only do this if we own it</span>
  <span class="s0">ReadRegStr $1 HKCR $R0 &quot;backup_val&quot;</span>
  <span class="s0">StrCmp $1 &quot;&quot; 0 Restore ; if backup=&quot;&quot; then delete the whole key</span>
  <span class="s0">DeleteRegKey HKCR $R0</span>
  <span class="s0">Goto NoOwn</span>
 
<span class="s0">Restore:</span>
  <span class="s0">WriteRegStr HKCR $R0 &quot;&quot; $1</span>
  <span class="s0">DeleteRegValue HKCR $R0 &quot;backup_val&quot;</span>
  <span class="s0">DeleteRegKey HKCR $R1 ;Delete key with association name settings</span>
 
<span class="s0">NoOwn:</span>
 
  <span class="s0">Pop $1</span>
  <span class="s0">Pop $0</span>
  <span class="s0">Pop $R1</span>
  <span class="s0">Pop $R0</span>
 
  <span class="s0">!verbose pop</span>
<span class="s0">!macroend</span>
 
<span class="s0">!endif # !FileAssociation_INCLUDED</span>
</pre>
</body>
</html>