<html>
<head>
<title>PhasedObject.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
PhasedObject.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">directnotify</span><span class="s2">.</span><span class="s1">DirectNotifyGlobal </span><span class="s0">import </span><span class="s2">*</span>

<span class="s0">class </span><span class="s1">PhasedObject</span><span class="s2">:</span>
    <span class="s3">&quot;&quot;&quot; 
    This class is governs the loading and unloading of successive 
    phases in an ordered and automatic manner. 
 
    An object can only have one phase at any given moment. At the 
    completion of setPhase() the current and all previous phases are 
    guaranteed to be loaded, while all later phases are guaranteed 
    to be unloaded. 
 
    In order to define a phase, simply define the functions: 
    loadPhase&lt;#&gt; and unloadPhase&lt;#&gt; where # corresponds to the number 
    of the phase to be defined and # &gt;= 0. 
 
    You also have the ability to define alias for phases so that 
    your function definitions are more descriptive.  The way to do 
    this is to provide an aliasMap to __init__().  The aliasMap is 
    of the form {'alias':#, ...}. You can then call setPhase() with 
    this alias as well. 
 
    So for example, if you wanted to alias phase 0 to 'Far' you 
    would define loadPhaseFar() and unloadPhaseFar(). Upon calling 
    setPhase(0), setPhase('Far'), setPhase(&lt;any phase greater than 0&gt;), 
    or setPhase(&lt;any alias greater than 'Far'&gt;), loadPhaseFar() will 
    be invoked. 
 
    For a skeleton example class, see the AnfaPhasedObject class 
    definition lower in this file. 
    &quot;&quot;&quot;</span>
    <span class="s1">notify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s4">&quot;PhasedObject&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">aliasMap </span><span class="s2">= {}):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">phase </span><span class="s2">= -</span><span class="s5">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">phaseAliasMap </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">aliasPhaseMap </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__phasing </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s0">for </span><span class="s1">alias</span><span class="s2">,</span><span class="s1">phase </span><span class="s0">in </span><span class="s1">list</span><span class="s2">(</span><span class="s1">aliasMap</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">setAlias</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s4">'PhasedObject(%s)' </span><span class="s2">% </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">aliasPhaseMap</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">outStr </span><span class="s2">= </span><span class="s1">PhasedObject</span><span class="s2">.</span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">outStr </span><span class="s2">+= </span><span class="s4">' in phase </span><span class="s0">\'</span><span class="s4">%s</span><span class="s0">\'</span><span class="s4">' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getPhase</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">outStr</span>

    <span class="s0">def </span><span class="s1">setAlias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">phase</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot; 
        Map an alias to a phase number. 
 
        phase must be &gt;= 0 and alias must be a string 
        of characters suitable for python variable names. 
 
        The mapping must be one-to-one. 
        &quot;&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">,</span><span class="s1">int</span><span class="s2">) </span><span class="s0">and </span><span class="s1">phase </span><span class="s2">&gt;= </span><span class="s5">0</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">alias</span><span class="s2">,</span><span class="s1">str</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">phaseAliasMap</span><span class="s2">[</span><span class="s1">phase</span><span class="s2">] = </span><span class="s1">alias</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">aliasPhaseMap</span><span class="s2">[</span><span class="s1">alias</span><span class="s2">] = </span><span class="s1">phase</span>

    <span class="s0">def </span><span class="s1">getPhaseAlias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">phase</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot; 
        Returns the alias of a phase number, if it exists. 
        Otherwise, returns the phase number. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phaseAliasMap</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">, </span><span class="s1">phase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getAliasPhase</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot; 
        Returns the phase number of an alias, if it exists. 
        Otherwise, returns the alias. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aliasPhaseMap</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">alias</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getPhase</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot; 
        Returns the current phase (or alias, if defined) 
        this object is currently in. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getPhaseAlias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">setPhase</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">aPhase</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot; 
        aPhase can be either a phase number or a predefined alias. 
 
        Will invoke a sequence of loadPhase*() or unloadPhase*() 
        functions corresponding to the difference between the current 
        phase and aPhase, starting at the current phase. 
        &quot;&quot;&quot;</span>
        <span class="s0">assert not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__phasing</span><span class="s2">, </span><span class="s4">'Already phasing. Cannot setPhase() while phasing in progress.'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__phasing </span><span class="s2">= </span><span class="s0">True</span>

        <span class="s1">phase </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aliasPhaseMap</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">aPhase</span><span class="s2">,</span><span class="s1">aPhase</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">,</span><span class="s1">int</span><span class="s2">), </span><span class="s4">'Phase alias </span><span class="s0">\'</span><span class="s4">%s</span><span class="s0">\' </span><span class="s4">not found' </span><span class="s2">% </span><span class="s1">aPhase</span>
        <span class="s0">assert </span><span class="s1">phase </span><span class="s2">&gt;= -</span><span class="s5">1</span><span class="s2">, </span><span class="s4">'Invalid phase number </span><span class="s0">\'</span><span class="s4">%s</span><span class="s0">\'</span><span class="s4">' </span><span class="s2">% </span><span class="s1">phase</span>

        <span class="s0">if </span><span class="s1">phase </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">phase </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">, </span><span class="s1">phase </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__loadPhase</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">phase </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">, </span><span class="s1">phase</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__unloadPhase</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__phasing </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">cleanup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot; 
        Will force the unloading, in correct order, of all currently 
        loaded phases. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phase </span><span class="s2">&gt;= </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">setPhase</span><span class="s2">(-</span><span class="s5">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__loadPhase</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">phase</span><span class="s2">):</span>
        <span class="s1">aPhase </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phaseAliasMap</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">,</span><span class="s1">phase</span><span class="s2">)</span>
        <span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">'loadPhase%s' </span><span class="s2">% </span><span class="s1">aPhase</span><span class="s2">,</span>
                <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__phaseNotFound</span><span class="s2">(</span><span class="s4">'load'</span><span class="s2">,</span><span class="s1">aPhase</span><span class="s2">))()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">phase </span><span class="s2">= </span><span class="s1">phase</span>

    <span class="s0">def </span><span class="s1">__unloadPhase</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">phase</span><span class="s2">):</span>
        <span class="s1">aPhase </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phaseAliasMap</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">,</span><span class="s1">phase</span><span class="s2">)</span>
        <span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">'unloadPhase%s' </span><span class="s2">% </span><span class="s1">aPhase</span><span class="s2">,</span>
                <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__phaseNotFound</span><span class="s2">(</span><span class="s4">'unload'</span><span class="s2">,</span><span class="s1">aPhase</span><span class="s2">))()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">phase </span><span class="s2">= (</span><span class="s1">phase </span><span class="s2">- </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__phaseNotFound</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">aPhase</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s4">'%s%s() not found!</span><span class="s0">\n</span><span class="s4">' </span><span class="s2">% (</span><span class="s1">mode</span><span class="s2">,</span><span class="s1">aPhase</span><span class="s2">))</span>

<span class="s0">if __debug__</span><span class="s2">:</span>
    <span class="s0">class </span><span class="s1">AnfaPhasedObject</span><span class="s2">(</span><span class="s1">PhasedObject</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot; 
        This is an example class to demonstrate the concept of 
        alias mapping for PhasedObjects. 
 
        As the distance between an observer and this object closes, 
        we would set the phase level succesively higher, with an initial 
        phase of 'Away' being set in __init__: 
 
        setPhase('Far') -&gt; invokes loadPhaseFar() 
        setPhase('Near') -&gt; invokes loadPhaseNear() 
 
        Now let's say the objects start moving away from each other: 
 
        setPhase('Far') -&gt; invokes unloadPhaseNear() 
        setPhase('Away') -&gt; invokes unloadPhaseFar() 
 
        Now one object teleports to the other: 
 
        setPhase('At') -&gt; invokes loadPhase('Far'), 
                          then    loadPhase('Near'), 
                          then    loadPhase('At') 
 
        Now the phased object is destroyed, we must clean it up 
        before removal: 
 
        cleanup() -&gt; invokes unloadPhase('At') 
                     then    unloadPhase('Near') 
                     then    unloadPhase('Far') 
                     then    unloadPhase('Away') 
        &quot;&quot;&quot;</span>
        <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">PhasedObject</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, {</span><span class="s4">'At'</span><span class="s2">:</span><span class="s5">3</span><span class="s2">, </span><span class="s4">'Near'</span><span class="s2">:</span><span class="s5">2</span><span class="s2">, </span><span class="s4">'Far'</span><span class="s2">:</span><span class="s5">1</span><span class="s2">, </span><span class="s4">'Away'</span><span class="s2">:</span><span class="s5">0</span><span class="s2">})</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">setPhase</span><span class="s2">(</span><span class="s4">'Away'</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">loadPhaseAway</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s4">'loading Away'</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">unloadPhaseAway</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s4">'unloading Away'</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">loadPhaseFar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s4">'loading Far'</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">unloadPhaseFar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s4">'unloading Far'</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">loadPhaseNear</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s4">'loading Near'</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">unloadPhaseNear</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s4">'unloading Near'</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">loadPhaseAt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s4">'loading At'</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">unloadPhaseAt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s4">'unloading At'</span><span class="s2">)</span>

</pre>
</body>
</html>