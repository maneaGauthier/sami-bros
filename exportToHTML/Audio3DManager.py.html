<html>
<head>
<title>Audio3DManager.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Audio3DManager.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Contains the Audio3DManager class.&quot;&quot;&quot;</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">'Audio3DManager'</span><span class="s2">]</span>

<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s1">Vec3</span><span class="s2">, </span><span class="s1">VBase3</span><span class="s2">, </span><span class="s1">WeakNodePath</span><span class="s2">, </span><span class="s1">ClockObject</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">task</span><span class="s2">.</span><span class="s1">TaskManagerGlobal </span><span class="s4">import </span><span class="s1">Task</span><span class="s2">, </span><span class="s1">taskMgr</span>
<span class="s5">#</span>
<span class="s4">class </span><span class="s1">Audio3DManager</span><span class="s2">:</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">audio_manager</span><span class="s2">, </span><span class="s1">listener_target </span><span class="s2">= </span><span class="s4">None</span><span class="s2">, </span><span class="s1">root </span><span class="s2">= </span><span class="s4">None</span><span class="s2">,</span>
                 <span class="s1">taskPriority </span><span class="s2">= </span><span class="s6">51</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">audio_manager </span><span class="s2">= </span><span class="s1">audio_manager</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">listener_target </span><span class="s2">= </span><span class="s1">listener_target</span>

        <span class="s4">if </span><span class="s2">(</span><span class="s1">root</span><span class="s2">==</span><span class="s4">None</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">root </span><span class="s2">= </span><span class="s1">render</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">root </span><span class="s2">= </span><span class="s1">root</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">vel_dict </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">listener_vel </span><span class="s2">= </span><span class="s1">VBase3</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>

        <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">update</span><span class="s2">, </span><span class="s3">&quot;Audio3DManager-updateTask&quot;</span><span class="s2">, </span><span class="s1">taskPriority</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">loadSfx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Use Audio3DManager.loadSfx to load a sound with 3D positioning enabled 
        &quot;&quot;&quot;</span>
        <span class="s1">sound </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">if </span><span class="s2">(</span><span class="s1">name</span><span class="s2">):</span>
            <span class="s1">sound</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">audio_manager</span><span class="s2">.</span><span class="s1">getSound</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">sound</span>

    <span class="s4">def </span><span class="s1">setDistanceFactor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">factor</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Control the scale that sets the distance units for 3D spacialized audio. 
        Default is 1.0 which is adjust in panda to be meters. 
        When you change this, don't forget that this effects the scale of setSoundMinDistance 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">audio_manager</span><span class="s2">.</span><span class="s1">audio3dSetDistanceFactor</span><span class="s2">(</span><span class="s1">factor</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">getDistanceFactor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Control the scale that sets the distance units for 3D spacialized audio. 
        Default is 1.0 which is adjust in panda to be meters. 
        &quot;&quot;&quot;</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">audio_manager</span><span class="s2">.</span><span class="s1">audio3dGetDistanceFactor</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">setDopplerFactor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">factor</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Control the presence of the Doppler effect. Default is 1.0 
        Exaggerated Doppler, use &gt;1.0 
        Diminshed Doppler, use &lt;1.0 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">audio_manager</span><span class="s2">.</span><span class="s1">audio3dSetDopplerFactor</span><span class="s2">(</span><span class="s1">factor</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">getDopplerFactor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Control the presence of the Doppler effect. Default is 1.0 
        Exaggerated Doppler, use &gt;1.0 
        Diminshed Doppler, use &lt;1.0 
        &quot;&quot;&quot;</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">audio_manager</span><span class="s2">.</span><span class="s1">audio3dGetDopplerFactor</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">setDropOffFactor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">factor</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Exaggerate or diminish the effect of distance on sound. Default is 1.0 
        Valid range is 0 to 10 
        Faster drop off, use &gt;1.0 
        Slower drop off, use &lt;1.0 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">audio_manager</span><span class="s2">.</span><span class="s1">audio3dSetDropOffFactor</span><span class="s2">(</span><span class="s1">factor</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">getDropOffFactor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Exaggerate or diminish the effect of distance on sound. Default is 1.0 
        Valid range is 0 to 10 
        Faster drop off, use &gt;1.0 
        Slower drop off, use &lt;1.0 
        &quot;&quot;&quot;</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">audio_manager</span><span class="s2">.</span><span class="s1">audio3dGetDropOffFactor</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">setSoundMinDistance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sound</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Controls the distance (in units) that this sound begins to fall off. 
        Also affects the rate it falls off. 
        Default is 3.28 (in feet, this is 1 meter) 
        Don't forget to change this when you change the DistanceFactor 
        &quot;&quot;&quot;</span>
        <span class="s1">sound</span><span class="s2">.</span><span class="s1">set3dMinDistance</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">getSoundMinDistance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sound</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Controls the distance (in units) that this sound begins to fall off. 
        Also affects the rate it falls off. 
        Default is 3.28 (in feet, this is 1 meter) 
        &quot;&quot;&quot;</span>
        <span class="s4">return </span><span class="s1">sound</span><span class="s2">.</span><span class="s1">get3dMinDistance</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">setSoundMaxDistance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sound</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Controls the maximum distance (in units) that this sound stops falling off. 
        The sound does not stop at that point, it just doesn't get any quieter. 
        You should rarely need to adjust this. 
        Default is 1000000000.0 
        &quot;&quot;&quot;</span>
        <span class="s1">sound</span><span class="s2">.</span><span class="s1">set3dMaxDistance</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">getSoundMaxDistance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sound</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Controls the maximum distance (in units) that this sound stops falling off. 
        The sound does not stop at that point, it just doesn't get any quieter. 
        You should rarely need to adjust this. 
        Default is 1000000000.0 
        &quot;&quot;&quot;</span>
        <span class="s4">return </span><span class="s1">sound</span><span class="s2">.</span><span class="s1">get3dMaxDistance</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">setSoundVelocity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sound</span><span class="s2">, </span><span class="s1">velocity</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Set the velocity vector (in units/sec) of the sound, for calculating doppler shift. 
        This is relative to the sound root (probably render). 
        Default: VBase3(0, 0, 0) 
        &quot;&quot;&quot;</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">velocity</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">) </span><span class="s4">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">velocity</span><span class="s2">) == </span><span class="s6">3</span><span class="s2">:</span>
            <span class="s1">velocity </span><span class="s2">= </span><span class="s1">VBase3</span><span class="s2">(*</span><span class="s1">velocity</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">velocity</span><span class="s2">, </span><span class="s1">VBase3</span><span class="s2">):</span>
            <span class="s4">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">&quot;Invalid argument 1, expected &lt;VBase3&gt;&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">vel_dict</span><span class="s2">[</span><span class="s1">sound</span><span class="s2">] = </span><span class="s1">velocity</span>

    <span class="s4">def </span><span class="s1">setSoundVelocityAuto</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sound</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        If velocity is set to auto, the velocity will be determined by the 
        previous position of the object the sound is attached to and the frame dt. 
        Make sure if you use this method that you remember to clear the previous 
        transformation between frames. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">vel_dict</span><span class="s2">[</span><span class="s1">sound</span><span class="s2">]=</span><span class="s4">None</span>

    <span class="s4">def </span><span class="s1">getSoundVelocity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sound</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Get the velocity of the sound. 
        &quot;&quot;&quot;</span>
        <span class="s4">if </span><span class="s1">sound </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vel_dict</span><span class="s2">:</span>
            <span class="s1">vel </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vel_dict</span><span class="s2">[</span><span class="s1">sound</span><span class="s2">]</span>
            <span class="s4">if </span><span class="s1">vel </span><span class="s4">is not None</span><span class="s2">:</span>
                <span class="s4">return </span><span class="s1">vel</span>

            <span class="s4">for </span><span class="s1">known_object </span><span class="s4">in </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()):</span>
                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">[</span><span class="s1">known_object</span><span class="s2">].</span><span class="s1">count</span><span class="s2">(</span><span class="s1">sound</span><span class="s2">):</span>
                    <span class="s1">node_path </span><span class="s2">= </span><span class="s1">known_object</span><span class="s2">.</span><span class="s1">getNodePath</span><span class="s2">()</span>
                    <span class="s4">if not </span><span class="s1">node_path</span><span class="s2">:</span>
                        <span class="s5"># The node has been deleted.</span>
                        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">[</span><span class="s1">known_object</span><span class="s2">]</span>
                        <span class="s4">continue</span>

                    <span class="s1">clock </span><span class="s2">= </span><span class="s1">ClockObject</span><span class="s2">.</span><span class="s1">getGlobalClock</span><span class="s2">()</span>
                    <span class="s4">return </span><span class="s1">node_path</span><span class="s2">.</span><span class="s1">getPosDelta</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">) / </span><span class="s1">clock</span><span class="s2">.</span><span class="s1">getDt</span><span class="s2">()</span>

        <span class="s4">return </span><span class="s1">VBase3</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">setListenerVelocity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">velocity</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Set the velocity vector (in units/sec) of the listener, for calculating doppler shift. 
        This is relative to the sound root (probably render). 
        Default: VBase3(0, 0, 0) 
        &quot;&quot;&quot;</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">velocity</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">) </span><span class="s4">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">velocity</span><span class="s2">) == </span><span class="s6">3</span><span class="s2">:</span>
            <span class="s1">velocity </span><span class="s2">= </span><span class="s1">VBase3</span><span class="s2">(*</span><span class="s1">velocity</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">velocity</span><span class="s2">, </span><span class="s1">VBase3</span><span class="s2">):</span>
            <span class="s4">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">&quot;Invalid argument 0, expected &lt;VBase3&gt;&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">listener_vel </span><span class="s2">= </span><span class="s1">velocity</span>

    <span class="s4">def </span><span class="s1">setListenerVelocityAuto</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        If velocity is set to auto, the velocity will be determined by the 
        previous position of the object the listener is attached to and the frame dt. 
        Make sure if you use this method that you remember to clear the previous 
        transformation between frames. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">listener_vel </span><span class="s2">= </span><span class="s4">None</span>

    <span class="s4">def </span><span class="s1">getListenerVelocity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Get the velocity of the listener. 
        &quot;&quot;&quot;</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">listener_vel </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">listener_vel</span>
        <span class="s4">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">listener_target </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">clock </span><span class="s2">= </span><span class="s1">ClockObject</span><span class="s2">.</span><span class="s1">getGlobalClock</span><span class="s2">()</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">listener_target</span><span class="s2">.</span><span class="s1">getPosDelta</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">) / </span><span class="s1">clock</span><span class="s2">.</span><span class="s1">getDt</span><span class="s2">()</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">VBase3</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">attachSoundToObject</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sound</span><span class="s2">, </span><span class="s1">object</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Sound will come from the location of the object it is attached to. 
        If the object is deleted, the sound will automatically be removed. 
        &quot;&quot;&quot;</span>
        <span class="s5"># sound is an AudioSound</span>
        <span class="s5"># object is any Panda object with coordinates</span>
        <span class="s4">for </span><span class="s1">known_object </span><span class="s4">in </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()):</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">[</span><span class="s1">known_object</span><span class="s2">].</span><span class="s1">count</span><span class="s2">(</span><span class="s1">sound</span><span class="s2">):</span>
                <span class="s5"># This sound is already attached to something</span>
                <span class="s5">#return 0</span>
                <span class="s5"># detach sound</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">[</span><span class="s1">known_object</span><span class="s2">].</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">sound</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">[</span><span class="s1">known_object</span><span class="s2">]) == </span><span class="s6">0</span><span class="s2">:</span>
                    <span class="s5"># if there are no other sounds, don't track</span>
                    <span class="s5"># the object any more</span>
                    <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">[</span><span class="s1">known_object</span><span class="s2">]</span>

        <span class="s4">if </span><span class="s1">object </span><span class="s4">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">[</span><span class="s1">WeakNodePath</span><span class="s2">(</span><span class="s1">object</span><span class="s2">)] = []</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">[</span><span class="s1">object</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">sound</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s6">1</span>


    <span class="s4">def </span><span class="s1">detachSound</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sound</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        sound will no longer have it's 3D position updated 
        &quot;&quot;&quot;</span>
        <span class="s4">for </span><span class="s1">known_object </span><span class="s4">in </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()):</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">[</span><span class="s1">known_object</span><span class="s2">].</span><span class="s1">count</span><span class="s2">(</span><span class="s1">sound</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">[</span><span class="s1">known_object</span><span class="s2">].</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">sound</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">[</span><span class="s1">known_object</span><span class="s2">]) == </span><span class="s6">0</span><span class="s2">:</span>
                    <span class="s5"># if there are no other sounds, don't track</span>
                    <span class="s5"># the object any more</span>
                    <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">[</span><span class="s1">known_object</span><span class="s2">]</span>
                <span class="s4">return </span><span class="s6">1</span>
        <span class="s4">return </span><span class="s6">0</span>


    <span class="s4">def </span><span class="s1">getSoundsOnObject</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">object</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        returns a list of sounds attached to an object 
        &quot;&quot;&quot;</span>
        <span class="s4">if </span><span class="s1">object </span><span class="s4">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s2">[]</span>
        <span class="s1">sound_list </span><span class="s2">= []</span>
        <span class="s1">sound_list</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">[</span><span class="s1">object</span><span class="s2">])</span>
        <span class="s4">return </span><span class="s1">sound_list</span>


    <span class="s4">def </span><span class="s1">attachListener</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">object</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Sounds will be heard relative to this object. Should probably be the camera. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">listener_target </span><span class="s2">= </span><span class="s1">object</span>
        <span class="s4">return </span><span class="s6">1</span>


    <span class="s4">def </span><span class="s1">detachListener</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Sounds will be heard relative to the root, probably render. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">listener_target </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">return </span><span class="s6">1</span>


    <span class="s4">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">task</span><span class="s2">=</span><span class="s4">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Updates position of sounds in the 3D audio system. Will be called automatically 
        in a task. 
        &quot;&quot;&quot;</span>
        <span class="s5"># Update the positions of all sounds based on the objects</span>
        <span class="s5"># to which they are attached</span>

        <span class="s5"># The audio manager is not active so do nothing</span>
        <span class="s4">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">audio_manager</span><span class="s2">, </span><span class="s3">&quot;getActive&quot;</span><span class="s2">):</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">audio_manager</span><span class="s2">.</span><span class="s1">getActive</span><span class="s2">()==</span><span class="s6">0</span><span class="s2">:</span>
                <span class="s4">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>

        <span class="s4">for </span><span class="s1">known_object</span><span class="s2">, </span><span class="s1">sounds </span><span class="s4">in </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()):</span>
            <span class="s1">node_path </span><span class="s2">= </span><span class="s1">known_object</span><span class="s2">.</span><span class="s1">getNodePath</span><span class="s2">()</span>
            <span class="s4">if not </span><span class="s1">node_path</span><span class="s2">:</span>
                <span class="s5"># The node has been deleted.</span>
                <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">[</span><span class="s1">known_object</span><span class="s2">]</span>
                <span class="s4">continue</span>

            <span class="s1">pos </span><span class="s2">= </span><span class="s1">node_path</span><span class="s2">.</span><span class="s1">getPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">)</span>

            <span class="s4">for </span><span class="s1">sound </span><span class="s4">in </span><span class="s1">sounds</span><span class="s2">:</span>
                <span class="s1">vel </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getSoundVelocity</span><span class="s2">(</span><span class="s1">sound</span><span class="s2">)</span>
                <span class="s1">sound</span><span class="s2">.</span><span class="s1">set3dAttributes</span><span class="s2">(</span><span class="s1">pos</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">pos</span><span class="s2">[</span><span class="s6">1</span><span class="s2">], </span><span class="s1">pos</span><span class="s2">[</span><span class="s6">2</span><span class="s2">], </span><span class="s1">vel</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">vel</span><span class="s2">[</span><span class="s6">1</span><span class="s2">], </span><span class="s1">vel</span><span class="s2">[</span><span class="s6">2</span><span class="s2">])</span>

        <span class="s5"># Update the position of the listener based on the object</span>
        <span class="s5"># to which it is attached</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">listener_target</span><span class="s2">:</span>
            <span class="s1">pos </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">listener_target</span><span class="s2">.</span><span class="s1">getPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">)</span>
            <span class="s1">forward </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">getRelativeVector</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">listener_target</span><span class="s2">, </span><span class="s1">Vec3</span><span class="s2">.</span><span class="s1">forward</span><span class="s2">())</span>
            <span class="s1">up </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">getRelativeVector</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">listener_target</span><span class="s2">, </span><span class="s1">Vec3</span><span class="s2">.</span><span class="s1">up</span><span class="s2">())</span>
            <span class="s1">vel </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getListenerVelocity</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">audio_manager</span><span class="s2">.</span><span class="s1">audio3dSetListenerAttributes</span><span class="s2">(</span><span class="s1">pos</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">pos</span><span class="s2">[</span><span class="s6">1</span><span class="s2">], </span><span class="s1">pos</span><span class="s2">[</span><span class="s6">2</span><span class="s2">], </span><span class="s1">vel</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">vel</span><span class="s2">[</span><span class="s6">1</span><span class="s2">], </span><span class="s1">vel</span><span class="s2">[</span><span class="s6">2</span><span class="s2">], </span><span class="s1">forward</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">forward</span><span class="s2">[</span><span class="s6">1</span><span class="s2">], </span><span class="s1">forward</span><span class="s2">[</span><span class="s6">2</span><span class="s2">], </span><span class="s1">up</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">up</span><span class="s2">[</span><span class="s6">1</span><span class="s2">], </span><span class="s1">up</span><span class="s2">[</span><span class="s6">2</span><span class="s2">])</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">audio_manager</span><span class="s2">.</span><span class="s1">audio3dSetListenerAttributes</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>

    <span class="s4">def </span><span class="s1">disable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Detaches any existing sounds and removes the update task 
        &quot;&quot;&quot;</span>
        <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">&quot;Audio3DManager-updateTask&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">detachListener</span><span class="s2">()</span>
        <span class="s4">for </span><span class="s1">object </span><span class="s4">in </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()):</span>
            <span class="s4">for </span><span class="s1">sound </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sound_dict</span><span class="s2">[</span><span class="s1">object</span><span class="s2">]:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">detachSound</span><span class="s2">(</span><span class="s1">sound</span><span class="s2">)</span>

    <span class="s5">#snake_case alias:</span>
    <span class="s1">get_doppler_factor </span><span class="s2">= </span><span class="s1">getDopplerFactor</span>
    <span class="s1">set_listener_velocity_auto </span><span class="s2">= </span><span class="s1">setListenerVelocityAuto</span>
    <span class="s1">attach_listener </span><span class="s2">= </span><span class="s1">attachListener</span>
    <span class="s1">set_distance_factor </span><span class="s2">= </span><span class="s1">setDistanceFactor</span>
    <span class="s1">attach_sound_to_object </span><span class="s2">= </span><span class="s1">attachSoundToObject</span>
    <span class="s1">get_drop_off_factor </span><span class="s2">= </span><span class="s1">getDropOffFactor</span>
    <span class="s1">set_doppler_factor </span><span class="s2">= </span><span class="s1">setDopplerFactor</span>
    <span class="s1">get_sounds_on_object </span><span class="s2">= </span><span class="s1">getSoundsOnObject</span>
    <span class="s1">set_sound_velocity_auto </span><span class="s2">= </span><span class="s1">setSoundVelocityAuto</span>
    <span class="s1">get_sound_max_distance </span><span class="s2">= </span><span class="s1">getSoundMaxDistance</span>
    <span class="s1">load_sfx </span><span class="s2">= </span><span class="s1">loadSfx</span>
    <span class="s1">get_distance_factor </span><span class="s2">= </span><span class="s1">getDistanceFactor</span>
    <span class="s1">set_listener_velocity </span><span class="s2">= </span><span class="s1">setListenerVelocity</span>
    <span class="s1">set_sound_max_distance </span><span class="s2">= </span><span class="s1">setSoundMaxDistance</span>
    <span class="s1">get_sound_velocity </span><span class="s2">= </span><span class="s1">getSoundVelocity</span>
    <span class="s1">get_listener_velocity </span><span class="s2">= </span><span class="s1">getListenerVelocity</span>
    <span class="s1">set_sound_velocity </span><span class="s2">= </span><span class="s1">setSoundVelocity</span>
    <span class="s1">set_sound_min_distance </span><span class="s2">= </span><span class="s1">setSoundMinDistance</span>
    <span class="s1">get_sound_min_distance </span><span class="s2">= </span><span class="s1">getSoundMinDistance</span>
    <span class="s1">detach_listener </span><span class="s2">= </span><span class="s1">detachListener</span>
    <span class="s1">set_drop_off_factor </span><span class="s2">= </span><span class="s1">setDropOffFactor</span>
    <span class="s1">detach_sound </span><span class="s2">= </span><span class="s1">detachSound</span>

</pre>
</body>
</html>