<html>
<head>
<title>DeploymentTools.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
DeploymentTools.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; This module is used to build a graphical installer 
or a standalone executable from a p3d file. It will try 
to build for as many platforms as possible. 
 
.. deprecated:: 1.10.0 
   The p3d packaging system has been replaced with the new setuptools-based 
   system.  See the :ref:`distribution` manual section. 
&quot;&quot;&quot;</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">&quot;Standalone&quot;</span><span class="s2">, </span><span class="s3">&quot;Installer&quot;</span><span class="s2">]</span>

<span class="s4">import </span><span class="s1">os</span><span class="s2">, </span><span class="s1">sys</span><span class="s2">, </span><span class="s1">subprocess</span><span class="s2">, </span><span class="s1">tarfile</span><span class="s2">, </span><span class="s1">shutil</span><span class="s2">, </span><span class="s1">time</span><span class="s2">, </span><span class="s1">zipfile</span><span class="s2">, </span><span class="s1">socket</span><span class="s2">, </span><span class="s1">getpass</span><span class="s2">, </span><span class="s1">struct</span>
<span class="s4">import </span><span class="s1">gzip</span><span class="s2">, </span><span class="s1">plistlib</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">directnotify</span><span class="s2">.</span><span class="s1">DirectNotifyGlobal </span><span class="s4">import </span><span class="s2">*</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase</span><span class="s2">.</span><span class="s1">AppRunnerGlobal </span><span class="s4">import </span><span class="s1">appRunner</span>
<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s1">PandaSystem</span><span class="s2">, </span><span class="s1">Filename</span><span class="s2">, </span><span class="s1">VirtualFileSystem</span><span class="s2">, </span><span class="s1">Multifile</span>
<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s1">TiXmlDocument</span><span class="s2">, </span><span class="s1">TiXmlDeclaration</span><span class="s2">, </span><span class="s1">TiXmlElement</span><span class="s2">, </span><span class="s1">readXmlStream</span>
<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s1">PNMImage</span><span class="s2">, </span><span class="s1">PNMFileTypeRegistry</span><span class="s2">, </span><span class="s1">StringStream</span>
<span class="s4">from </span><span class="s1">panda3d </span><span class="s4">import </span><span class="s1">core</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">stdpy</span><span class="s2">.</span><span class="s1">file </span><span class="s4">import </span><span class="s2">*</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">p3d</span><span class="s2">.</span><span class="s1">HostInfo </span><span class="s4">import </span><span class="s1">HostInfo</span>
<span class="s5"># This is important for some reason</span>
<span class="s4">import </span><span class="s1">encodings</span>

<span class="s4">try</span><span class="s2">:</span>
    <span class="s4">import </span><span class="s1">pwd</span>
<span class="s4">except </span><span class="s1">ImportError</span><span class="s2">:</span>
    <span class="s1">pwd </span><span class="s2">= </span><span class="s4">None</span>

<span class="s4">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s6">3</span><span class="s2">, </span><span class="s6">0</span><span class="s2">):</span>
    <span class="s1">xrange </span><span class="s2">= </span><span class="s1">range</span>
    <span class="s4">from </span><span class="s1">io </span><span class="s4">import </span><span class="s1">BytesIO</span><span class="s2">, </span><span class="s1">TextIOWrapper</span>
<span class="s4">else</span><span class="s2">:</span>
    <span class="s4">from </span><span class="s1">io </span><span class="s4">import </span><span class="s1">BytesIO</span>
    <span class="s4">from </span><span class="s1">StringIO </span><span class="s4">import </span><span class="s1">StringIO</span>

<span class="s5"># Make sure this matches with the magic in p3dEmbedMain.cxx.</span>
<span class="s1">P3DEMBED_MAGIC </span><span class="s2">= </span><span class="s6">0xFF3D3D00</span>

<span class="s5"># This filter function is used when creating</span>
<span class="s5"># an archive that should be owned by root.</span>
<span class="s4">def </span><span class="s1">archiveFilter</span><span class="s2">(</span><span class="s1">info</span><span class="s2">):</span>
    <span class="s1">basename </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">(</span><span class="s1">info</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
    <span class="s4">if </span><span class="s1">basename </span><span class="s4">in </span><span class="s2">[</span><span class="s3">&quot;.DS_Store&quot;</span><span class="s2">, </span><span class="s3">&quot;Thumbs.db&quot;</span><span class="s2">]:</span>
        <span class="s4">return None</span>

    <span class="s1">info</span><span class="s2">.</span><span class="s1">uid </span><span class="s2">= </span><span class="s1">info</span><span class="s2">.</span><span class="s1">gid </span><span class="s2">= </span><span class="s6">0</span>
    <span class="s1">info</span><span class="s2">.</span><span class="s1">uname </span><span class="s2">= </span><span class="s1">info</span><span class="s2">.</span><span class="s1">gname </span><span class="s2">= </span><span class="s3">&quot;root&quot;</span>

    <span class="s5"># All files without an extension get mode 0755,</span>
    <span class="s5"># all other files are chmodded to 0644.</span>
    <span class="s5"># Somewhat hacky, but it's the only way</span>
    <span class="s5"># permissions can work on a Windows box.</span>
    <span class="s4">if </span><span class="s1">info</span><span class="s2">.</span><span class="s1">type </span><span class="s2">!= </span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">DIRTYPE </span><span class="s4">and </span><span class="s3">'.' </span><span class="s4">in </span><span class="s1">info</span><span class="s2">.</span><span class="s1">name</span><span class="s2">.</span><span class="s1">rsplit</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)[-</span><span class="s6">1</span><span class="s2">]:</span>
        <span class="s1">info</span><span class="s2">.</span><span class="s1">mode </span><span class="s2">= </span><span class="s6">0o644</span>
    <span class="s4">else</span><span class="s2">:</span>
        <span class="s1">info</span><span class="s2">.</span><span class="s1">mode </span><span class="s2">= </span><span class="s6">0o755</span>

    <span class="s4">return </span><span class="s1">info</span>

<span class="s5"># Hack to make all files in a tar file owned by root.</span>
<span class="s5"># The tarfile module doesn't have filter functionality until Python 2.7.</span>
<span class="s5"># Yay duck typing!</span>
<span class="s4">class </span><span class="s1">TarInfoRoot</span><span class="s2">(</span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">TarInfo</span><span class="s2">):</span>
    <span class="s1">uid </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s4">lambda </span><span class="s1">self</span><span class="s2">: </span><span class="s6">0</span><span class="s2">, </span><span class="s4">lambda </span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">: </span><span class="s4">None</span><span class="s2">)</span>
    <span class="s1">gid </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s4">lambda </span><span class="s1">self</span><span class="s2">: </span><span class="s6">0</span><span class="s2">, </span><span class="s4">lambda </span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">: </span><span class="s4">None</span><span class="s2">)</span>
    <span class="s1">uname </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s4">lambda </span><span class="s1">self</span><span class="s2">: </span><span class="s3">&quot;root&quot;</span><span class="s2">, </span><span class="s4">lambda </span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">: </span><span class="s4">None</span><span class="s2">)</span>
    <span class="s1">gname </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s4">lambda </span><span class="s1">self</span><span class="s2">: </span><span class="s3">&quot;root&quot;</span><span class="s2">, </span><span class="s4">lambda </span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">: </span><span class="s4">None</span><span class="s2">)</span>
    <span class="s1">mode </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s4">lambda </span><span class="s1">self</span><span class="s2">: </span><span class="s6">0o644 </span><span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">type </span><span class="s2">!= </span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">DIRTYPE </span><span class="s4">and </span><span class="s1">\</span>
                    <span class="s3">'.' </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">.</span><span class="s1">rsplit</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)[-</span><span class="s6">1</span><span class="s2">] </span><span class="s4">else </span><span class="s6">0o755</span><span class="s2">,</span>
                    <span class="s4">lambda </span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">: </span><span class="s4">None</span><span class="s2">)</span>

<span class="s5"># On OSX, the root group is named &quot;wheel&quot;.</span>
<span class="s4">class </span><span class="s1">TarInfoRootOSX</span><span class="s2">(</span><span class="s1">TarInfoRoot</span><span class="s2">):</span>
    <span class="s1">gname </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s4">lambda </span><span class="s1">self</span><span class="s2">: </span><span class="s3">&quot;wheel&quot;</span><span class="s2">, </span><span class="s4">lambda </span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">: </span><span class="s4">None</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">Standalone</span><span class="s2">:</span>
    <span class="s0">&quot;&quot;&quot; This class creates a standalone executable from a given .p3d file. &quot;&quot;&quot;</span>
    <span class="s1">notify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s3">&quot;Standalone&quot;</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">p3dfile</span><span class="s2">, </span><span class="s1">tokens </span><span class="s2">= {}):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dfile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">p3dfile</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basename </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dfile</span><span class="s2">.</span><span class="s1">getBasenameWoExtension</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tokens </span><span class="s2">= </span><span class="s1">tokens</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">tempDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">) + </span><span class="s3">&quot;/&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tempDir</span><span class="s2">.</span><span class="s1">makeDir</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">host </span><span class="s2">= </span><span class="s1">HostInfo</span><span class="s2">(</span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageHostUrl</span><span class="s2">(), </span><span class="s1">appRunner </span><span class="s2">= </span><span class="s1">appRunner</span><span class="s2">, </span><span class="s1">hostDir </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tempDir</span><span class="s2">, </span><span class="s1">asMirror </span><span class="s2">= </span><span class="s4">False</span><span class="s2">, </span><span class="s1">perPlatform </span><span class="s2">= </span><span class="s4">True</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">http </span><span class="s2">= </span><span class="s1">core</span><span class="s2">.</span><span class="s1">HTTPClient</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">hasContentsFile</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">readContentsFile</span><span class="s2">():</span>
                <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">downloadContentsFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
                    <span class="s1">Standalone</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;couldn't read host&quot;</span><span class="s2">)</span>
                    <span class="s4">return</span>

    <span class="s4">def </span><span class="s1">__del__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">appRunner</span><span class="s2">.</span><span class="s1">rmtree</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tempDir</span><span class="s2">)</span>
        <span class="s4">except</span><span class="s2">:</span>
            <span class="s4">try</span><span class="s2">: </span><span class="s1">shutil</span><span class="s2">.</span><span class="s1">rmtree</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tempDir</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
            <span class="s4">except</span><span class="s2">: </span><span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">buildAll</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">outputDir </span><span class="s2">= </span><span class="s3">&quot;.&quot;</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Builds standalone executables for every known platform, 
        into the specified output directory. &quot;&quot;&quot;</span>

        <span class="s1">platforms </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s4">for </span><span class="s1">package </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">getPackages</span><span class="s2">(</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;p3dembed&quot;</span><span class="s2">):</span>
            <span class="s1">platforms</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">platforms</span><span class="s2">) == </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">Standalone</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;No platforms found to build for!&quot;</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s3">'win32' </span><span class="s4">in </span><span class="s1">platforms </span><span class="s4">and </span><span class="s3">'win_i386' </span><span class="s4">in </span><span class="s1">platforms</span><span class="s2">:</span>
            <span class="s1">platforms</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">'win32'</span><span class="s2">)</span>

        <span class="s1">outputDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">outputDir </span><span class="s2">+ </span><span class="s3">&quot;/&quot;</span><span class="s2">)</span>
        <span class="s1">outputDir</span><span class="s2">.</span><span class="s1">makeDir</span><span class="s2">()</span>
        <span class="s4">for </span><span class="s1">platform </span><span class="s4">in </span><span class="s1">platforms</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;win&quot;</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">outputDir</span><span class="s2">, </span><span class="s1">platform </span><span class="s2">+ </span><span class="s3">&quot;/&quot; </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">basename </span><span class="s2">+ </span><span class="s3">&quot;.exe&quot;</span><span class="s2">), </span><span class="s1">platform</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">outputDir</span><span class="s2">, </span><span class="s1">platform </span><span class="s2">+ </span><span class="s3">&quot;/&quot; </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">), </span><span class="s1">platform</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">output</span><span class="s2">, </span><span class="s1">platform </span><span class="s2">= </span><span class="s4">None</span><span class="s2">, </span><span class="s1">extraTokens </span><span class="s2">= {}):</span>
        <span class="s0">&quot;&quot;&quot; Builds a standalone executable and stores it into the path 
        indicated by the 'output' argument. You can specify to build for 
        a different platform by altering the 'platform' argument. &quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s1">platform </span><span class="s2">== </span><span class="s4">None</span><span class="s2">:</span>
            <span class="s1">platform </span><span class="s2">= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPlatform</span><span class="s2">()</span>

        <span class="s1">vfs </span><span class="s2">= </span><span class="s1">VirtualFileSystem</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>

        <span class="s4">for </span><span class="s1">package </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">getPackages</span><span class="s2">(</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;p3dembed&quot;</span><span class="s2">, </span><span class="s1">platform </span><span class="s2">= </span><span class="s1">platform</span><span class="s2">):</span>
            <span class="s4">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">downloadDescFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
                <span class="s1">Standalone</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;  -&gt; %s failed for platform %s&quot; </span><span class="s2">% (</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">))</span>
                <span class="s4">continue</span>
            <span class="s4">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">downloadPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
                <span class="s1">Standalone</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;  -&gt; %s failed for platform %s&quot; </span><span class="s2">% (</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">))</span>
                <span class="s4">continue</span>

            <span class="s5"># Figure out where p3dembed might be now.</span>
            <span class="s4">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;win&quot;</span><span class="s2">):</span>
                <span class="s5"># Use p3dembedw unless console_environment was set.</span>
                <span class="s1">cEnv </span><span class="s2">= </span><span class="s1">extraTokens</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;console_environment&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tokens</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;console_environment&quot;</span><span class="s2">, </span><span class="s6">0</span><span class="s2">))</span>
                <span class="s4">if </span><span class="s1">cEnv </span><span class="s2">!= </span><span class="s3">&quot;&quot; </span><span class="s4">and </span><span class="s1">int</span><span class="s2">(</span><span class="s1">cEnv</span><span class="s2">) != </span><span class="s6">0</span><span class="s2">:</span>
                    <span class="s1">p3dembed </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostDir</span><span class="s2">, </span><span class="s3">&quot;p3dembed/%s/p3dembed.exe&quot; </span><span class="s2">% </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">p3dembed </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostDir</span><span class="s2">, </span><span class="s3">&quot;p3dembed/%s/p3dembedw.exe&quot; </span><span class="s2">% </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>
                    <span class="s5"># Fallback for older p3dembed versions</span>
                    <span class="s4">if not </span><span class="s1">vfs</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">p3dembed</span><span class="s2">):</span>
                        <span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostDir</span><span class="s2">, </span><span class="s3">&quot;p3dembed/%s/p3dembed.exe&quot; </span><span class="s2">% </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">p3dembed </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostDir</span><span class="s2">, </span><span class="s3">&quot;p3dembed/%s/p3dembed&quot; </span><span class="s2">% </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>

            <span class="s4">if not </span><span class="s1">vfs</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">p3dembed</span><span class="s2">):</span>
                <span class="s1">Standalone</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;  -&gt; %s failed for platform %s&quot; </span><span class="s2">% (</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">))</span>
                <span class="s4">continue</span>

            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">embed</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s1">p3dembed</span><span class="s2">, </span><span class="s1">extraTokens</span><span class="s2">)</span>

        <span class="s1">Standalone</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Failed to build standalone for platform %s&quot; </span><span class="s2">% </span><span class="s1">platform</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">embed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">output</span><span class="s2">, </span><span class="s1">p3dembed</span><span class="s2">, </span><span class="s1">extraTokens </span><span class="s2">= {}):</span>
        <span class="s0">&quot;&quot;&quot; Embeds the p3d file into the provided p3dembed executable. 
        This function is not really useful - use build() or buildAll() instead. &quot;&quot;&quot;</span>

        <span class="s5"># Load the p3dembed data into memory</span>
        <span class="s1">size </span><span class="s2">= </span><span class="s1">p3dembed</span><span class="s2">.</span><span class="s1">getFileSize</span><span class="s2">()</span>
        <span class="s1">p3dembed_data </span><span class="s2">= </span><span class="s1">VirtualFileSystem</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">().</span><span class="s1">readFile</span><span class="s2">(</span><span class="s1">p3dembed</span><span class="s2">, </span><span class="s4">True</span><span class="s2">)</span>
        <span class="s4">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">p3dembed_data</span><span class="s2">) == </span><span class="s1">size</span>

        <span class="s5"># Find the magic size string and replace it with the real size,</span>
        <span class="s5"># regardless of the endianness of the p3dembed executable.</span>
        <span class="s1">p3dembed_data </span><span class="s2">= </span><span class="s1">p3dembed_data</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&gt;I'</span><span class="s2">, </span><span class="s1">P3DEMBED_MAGIC</span><span class="s2">),</span>
                                              <span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&gt;I'</span><span class="s2">, </span><span class="s1">size</span><span class="s2">))</span>
        <span class="s1">p3dembed_data </span><span class="s2">= </span><span class="s1">p3dembed_data</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;I'</span><span class="s2">, </span><span class="s1">P3DEMBED_MAGIC</span><span class="s2">),</span>
                                              <span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;I'</span><span class="s2">, </span><span class="s1">size</span><span class="s2">))</span>

        <span class="s5"># Write the output file</span>
        <span class="s1">Standalone</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Creating %s...&quot; </span><span class="s2">% </span><span class="s1">output</span><span class="s2">)</span>
        <span class="s1">output</span><span class="s2">.</span><span class="s1">makeDir</span><span class="s2">()</span>
        <span class="s1">ohandle </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">output</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">&quot;wb&quot;</span><span class="s2">)</span>
        <span class="s1">ohandle</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">p3dembed_data</span><span class="s2">)</span>

        <span class="s5"># Write out the tokens. Set log_basename to the basename by default</span>
        <span class="s1">tokens </span><span class="s2">= {</span><span class="s3">&quot;log_basename&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">}</span>
        <span class="s1">tokens</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tokens</span><span class="s2">)</span>
        <span class="s1">tokens</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">extraTokens</span><span class="s2">)</span>
        <span class="s4">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s4">in </span><span class="s1">tokens</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">ohandle</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s4">\0</span><span class="s7">&quot;</span><span class="s2">)</span>
            <span class="s1">ohandle</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">key</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">'ascii'</span><span class="s2">))</span>
            <span class="s1">ohandle</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;=&quot;</span><span class="s2">)</span>
            <span class="s1">ohandle</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">())</span>
        <span class="s1">ohandle</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s4">\0\0</span><span class="s7">&quot;</span><span class="s2">)</span>

        <span class="s5"># Buffer the p3d file to the output file. 1 MB buffer size.</span>
        <span class="s1">phandle </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dfile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">&quot;rb&quot;</span><span class="s2">)</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">phandle</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s6">1024 </span><span class="s2">* </span><span class="s6">1024</span><span class="s2">)</span>
        <span class="s4">while </span><span class="s1">len</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">) != </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">ohandle</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
            <span class="s1">buf </span><span class="s2">= </span><span class="s1">phandle</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s6">1024 </span><span class="s2">* </span><span class="s6">1024</span><span class="s2">)</span>
        <span class="s1">ohandle</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s1">phandle</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s1">os</span><span class="s2">.</span><span class="s1">chmod</span><span class="s2">(</span><span class="s1">output</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s6">0o755</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">getExtraFiles</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Returns a list of extra files that will need to be included 
        with the standalone executable in order for it to run, such as 
        dependent libraries. The returned paths are full absolute paths. &quot;&quot;&quot;</span>

        <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">getPackages</span><span class="s2">(</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;p3dembed&quot;</span><span class="s2">, </span><span class="s1">platform </span><span class="s2">= </span><span class="s1">platform</span><span class="s2">)[</span><span class="s6">0</span><span class="s2">]</span>

        <span class="s4">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">downloadDescFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
            <span class="s1">Standalone</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;  -&gt; %s failed for platform %s&quot; </span><span class="s2">% (</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">))</span>
            <span class="s4">return </span><span class="s2">[]</span>
        <span class="s4">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">downloadPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
            <span class="s1">Standalone</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;  -&gt; %s failed for platform %s&quot; </span><span class="s2">% (</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">))</span>
            <span class="s4">return </span><span class="s2">[]</span>

        <span class="s1">filenames </span><span class="s2">= []</span>
        <span class="s1">vfs </span><span class="s2">= </span><span class="s1">VirtualFileSystem</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>
        <span class="s4">for </span><span class="s1">e </span><span class="s4">in </span><span class="s1">package</span><span class="s2">.</span><span class="s1">extracts</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">e</span><span class="s2">.</span><span class="s1">basename </span><span class="s4">not in </span><span class="s2">[</span><span class="s3">&quot;p3dembed&quot;</span><span class="s2">, </span><span class="s3">&quot;p3dembed.exe&quot;</span><span class="s2">, </span><span class="s3">&quot;p3dembed.exe.manifest&quot;</span><span class="s2">, </span><span class="s3">&quot;p3dembedw.exe&quot;</span><span class="s2">, </span><span class="s3">&quot;p3dembedw.exe.manifest&quot;</span><span class="s2">]:</span>
                <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">getPackageDir</span><span class="s2">(), </span><span class="s1">e</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>
                <span class="s1">filename</span><span class="s2">.</span><span class="s1">makeAbsolute</span><span class="s2">()</span>
                <span class="s4">if </span><span class="s1">vfs</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">):</span>
                    <span class="s1">filenames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">Standalone</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;%s mentioned in xml, but does not exist&quot; </span><span class="s2">% </span><span class="s1">e</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>

        <span class="s4">return </span><span class="s1">filenames</span>


<span class="s4">class </span><span class="s1">PackageTree</span><span class="s2">:</span>
    <span class="s0">&quot;&quot;&quot; A class used internally to build a temporary package 
    tree for inclusion into an installer. &quot;&quot;&quot;</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">, </span><span class="s1">hostDir</span><span class="s2">, </span><span class="s1">hostUrl</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">= </span><span class="s1">platform</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">hosts </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">packages </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl </span><span class="s2">= </span><span class="s1">hostUrl</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">hostDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">hostDir</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">hostDir</span><span class="s2">.</span><span class="s1">makeDir</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">http </span><span class="s2">= </span><span class="s1">core</span><span class="s2">.</span><span class="s1">HTTPClient</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">getHost</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">hostUrl</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">hostUrl </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">[</span><span class="s1">hostUrl</span><span class="s2">]</span>

        <span class="s1">host </span><span class="s2">= </span><span class="s1">HostInfo</span><span class="s2">(</span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">appRunner </span><span class="s2">= </span><span class="s1">appRunner</span><span class="s2">, </span><span class="s1">hostDir </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostDir</span><span class="s2">, </span><span class="s1">asMirror </span><span class="s2">= </span><span class="s4">False</span><span class="s2">, </span><span class="s1">perPlatform </span><span class="s2">= </span><span class="s4">True</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">host</span><span class="s2">.</span><span class="s1">hasContentsFile</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">host</span><span class="s2">.</span><span class="s1">readContentsFile</span><span class="s2">():</span>
                <span class="s4">if not </span><span class="s1">host</span><span class="s2">.</span><span class="s1">downloadContentsFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
                    <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;couldn't read host %s&quot; </span><span class="s2">% </span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">)</span>
                    <span class="s4">return None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">[</span><span class="s1">hostUrl</span><span class="s2">] = </span><span class="s1">host</span>
        <span class="s4">return </span><span class="s1">host</span>

    <span class="s4">def </span><span class="s1">installPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">hostUrl </span><span class="s2">= </span><span class="s4">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Installs the named package into the tree. &quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s1">hostUrl </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">hostUrl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl</span>

        <span class="s1">pkgIdent </span><span class="s2">= (</span><span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">pkgIdent </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">[</span><span class="s1">pkgIdent</span><span class="s2">]</span>

        <span class="s1">package </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s5"># Always try the super host first, if any.</span>
        <span class="s4">if </span><span class="s1">appRunner </span><span class="s4">and </span><span class="s1">appRunner</span><span class="s2">.</span><span class="s1">superMirrorUrl</span><span class="s2">:</span>
            <span class="s1">superHost </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getHost</span><span class="s2">(</span><span class="s1">appRunner</span><span class="s2">.</span><span class="s1">superMirrorUrl</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">:</span>
                <span class="s1">package </span><span class="s2">= </span><span class="s1">superHost</span><span class="s2">.</span><span class="s1">getPackage</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>
            <span class="s4">if not </span><span class="s1">package</span><span class="s2">:</span>
                <span class="s1">package </span><span class="s2">= </span><span class="s1">superHost</span><span class="s2">.</span><span class="s1">getPackage</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">)</span>

        <span class="s4">if not </span><span class="s1">package</span><span class="s2">:</span>
            <span class="s1">host </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getHost</span><span class="s2">(</span><span class="s1">hostUrl</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">:</span>
                <span class="s1">package </span><span class="s2">= </span><span class="s1">host</span><span class="s2">.</span><span class="s1">getPackage</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>
            <span class="s4">if not </span><span class="s1">package</span><span class="s2">:</span>
                <span class="s1">package </span><span class="s2">= </span><span class="s1">host</span><span class="s2">.</span><span class="s1">getPackage</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">)</span>

        <span class="s4">if not </span><span class="s1">package</span><span class="s2">:</span>
            <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Package %s %s for %s not known on %s&quot; </span><span class="s2">% (</span>
                <span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">, </span><span class="s1">hostUrl</span><span class="s2">))</span>
            <span class="s4">return</span>

        <span class="s1">package</span><span class="s2">.</span><span class="s1">installed </span><span class="s2">= </span><span class="s4">True </span><span class="s5"># Hack not to let it unnecessarily install itself</span>
        <span class="s4">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">downloadDescFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
            <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;  -&gt; %s failed for platform %s&quot; </span><span class="s2">% (</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">))</span>
            <span class="s4">return</span>
        <span class="s4">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">downloadPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
            <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;  -&gt; %s failed for platform %s&quot; </span><span class="s2">% (</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">))</span>
            <span class="s4">return</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">[</span><span class="s1">pkgIdent</span><span class="s2">] = </span><span class="s1">package</span>

        <span class="s5"># Check for any dependencies.</span>
        <span class="s4">for </span><span class="s1">rname</span><span class="s2">, </span><span class="s1">rversion</span><span class="s2">, </span><span class="s1">rhost </span><span class="s4">in </span><span class="s1">package</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">installPackage</span><span class="s2">(</span><span class="s1">rname</span><span class="s2">, </span><span class="s1">rversion</span><span class="s2">, </span><span class="s1">rhost</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">)</span>

        <span class="s4">return </span><span class="s1">package</span>


<span class="s4">class </span><span class="s1">Icon</span><span class="s2">:</span>
    <span class="s0">&quot;&quot;&quot; This class is used to create an icon for various platforms. &quot;&quot;&quot;</span>
    <span class="s1">notify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s3">&quot;Icon&quot;</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">images </span><span class="s2">= {}</span>

    <span class="s4">def </span><span class="s1">addImage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">image</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Adds an image to the icon.  Returns False on failure, True on success. 
        Only one image per size can be loaded, and the image size must be square. &quot;&quot;&quot;</span>

        <span class="s4">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">image</span><span class="s2">, </span><span class="s1">PNMImage</span><span class="s2">):</span>
            <span class="s1">fn </span><span class="s2">= </span><span class="s1">image</span>
            <span class="s4">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">Filename</span><span class="s2">):</span>
                <span class="s1">fn </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>

            <span class="s1">image </span><span class="s2">= </span><span class="s1">PNMImage</span><span class="s2">()</span>
            <span class="s4">if not </span><span class="s1">image</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">):</span>
                <span class="s1">Icon</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Image '%s' could not be read&quot; </span><span class="s2">% </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">())</span>
                <span class="s4">return False</span>

        <span class="s4">if </span><span class="s1">image</span><span class="s2">.</span><span class="s1">getXSize</span><span class="s2">() != </span><span class="s1">image</span><span class="s2">.</span><span class="s1">getYSize</span><span class="s2">():</span>
            <span class="s1">Icon</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Ignoring image without square size&quot;</span><span class="s2">)</span>
            <span class="s4">return False</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">images</span><span class="s2">[</span><span class="s1">image</span><span class="s2">.</span><span class="s1">getXSize</span><span class="s2">()] = </span><span class="s1">image</span>

        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">generateMissingImages</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Generates image sizes that should be present but aren't by scaling 
        from the next higher size. &quot;&quot;&quot;</span>

        <span class="s4">for </span><span class="s1">required_size </span><span class="s4">in </span><span class="s2">(</span><span class="s6">256</span><span class="s2">, </span><span class="s6">128</span><span class="s2">, </span><span class="s6">48</span><span class="s2">, </span><span class="s6">32</span><span class="s2">, </span><span class="s6">16</span><span class="s2">):</span>
            <span class="s4">if </span><span class="s1">required_size </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">images</span><span class="s2">:</span>
                <span class="s4">continue</span>

            <span class="s1">sizes </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">images</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
            <span class="s4">if </span><span class="s1">required_size </span><span class="s2">* </span><span class="s6">2 </span><span class="s4">in </span><span class="s1">sizes</span><span class="s2">:</span>
                <span class="s1">from_size </span><span class="s2">= </span><span class="s1">required_size </span><span class="s2">* </span><span class="s6">2</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">from_size </span><span class="s2">= </span><span class="s6">0</span>
                <span class="s4">for </span><span class="s1">from_size </span><span class="s4">in </span><span class="s1">sizes</span><span class="s2">:</span>
                    <span class="s4">if </span><span class="s1">from_size </span><span class="s2">&gt; </span><span class="s1">required_size</span><span class="s2">:</span>
                        <span class="s4">break</span>

            <span class="s4">if </span><span class="s1">from_size </span><span class="s2">&gt; </span><span class="s1">required_size</span><span class="s2">:</span>
                <span class="s1">Icon</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Generating %dx%d icon by scaling down %dx%d image&quot; </span><span class="s2">% (</span><span class="s1">required_size</span><span class="s2">, </span><span class="s1">required_size</span><span class="s2">, </span><span class="s1">from_size</span><span class="s2">, </span><span class="s1">from_size</span><span class="s2">))</span>

                <span class="s1">image </span><span class="s2">= </span><span class="s1">PNMImage</span><span class="s2">(</span><span class="s1">required_size</span><span class="s2">, </span><span class="s1">required_size</span><span class="s2">)</span>
                <span class="s1">image</span><span class="s2">.</span><span class="s1">setColorType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">images</span><span class="s2">[</span><span class="s1">from_size</span><span class="s2">].</span><span class="s1">getColorType</span><span class="s2">())</span>
                <span class="s1">image</span><span class="s2">.</span><span class="s1">quickFilterFrom</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">images</span><span class="s2">[</span><span class="s1">from_size</span><span class="s2">])</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">images</span><span class="s2">[</span><span class="s1">required_size</span><span class="s2">] = </span><span class="s1">image</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">Icon</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Cannot generate %dx%d icon; no higher resolution image available&quot; </span><span class="s2">% (</span><span class="s1">required_size</span><span class="s2">, </span><span class="s1">required_size</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">_write_bitmap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">, </span><span class="s1">image</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">bpp</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Writes the bitmap header and data of an .ico file. &quot;&quot;&quot;</span>

        <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;IiiHHIIiiII'</span><span class="s2">, </span><span class="s6">40</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">size </span><span class="s2">* </span><span class="s6">2</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s1">bpp</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">))</span>

        <span class="s5"># XOR mask</span>
        <span class="s4">if </span><span class="s1">bpp </span><span class="s2">== </span><span class="s6">24</span><span class="s2">:</span>
            <span class="s5"># Align rows to 4-byte boundary</span>
            <span class="s1">rowalign </span><span class="s2">= </span><span class="s7">b'</span><span class="s4">\0</span><span class="s7">' </span><span class="s2">* (-(</span><span class="s1">size </span><span class="s2">* </span><span class="s6">3</span><span class="s2">) &amp; </span><span class="s6">3</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">y </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">size</span><span class="s2">):</span>
                <span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">size</span><span class="s2">):</span>
                    <span class="s1">r</span><span class="s2">, </span><span class="s1">g</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">image</span><span class="s2">.</span><span class="s1">getXel</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">size </span><span class="s2">- </span><span class="s1">y </span><span class="s2">- </span><span class="s6">1</span><span class="s2">)</span>
                    <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;BBB'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">b </span><span class="s2">* </span><span class="s6">255</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">g </span><span class="s2">* </span><span class="s6">255</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">r </span><span class="s2">* </span><span class="s6">255</span><span class="s2">)))</span>
                <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">rowalign</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">bpp </span><span class="s2">== </span><span class="s6">32</span><span class="s2">:</span>
            <span class="s4">for </span><span class="s1">y </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">size</span><span class="s2">):</span>
                <span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">size</span><span class="s2">):</span>
                    <span class="s1">r</span><span class="s2">, </span><span class="s1">g</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">image</span><span class="s2">.</span><span class="s1">getXelA</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">size </span><span class="s2">- </span><span class="s1">y </span><span class="s2">- </span><span class="s6">1</span><span class="s2">)</span>
                    <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;BBBB'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">b </span><span class="s2">* </span><span class="s6">255</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">g </span><span class="s2">* </span><span class="s6">255</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">r </span><span class="s2">* </span><span class="s6">255</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">a </span><span class="s2">* </span><span class="s6">255</span><span class="s2">)))</span>

        <span class="s4">elif </span><span class="s1">bpp </span><span class="s2">== </span><span class="s6">8</span><span class="s2">:</span>
            <span class="s5"># We'll have to generate a palette of 256 colors.</span>
            <span class="s1">hist </span><span class="s2">= </span><span class="s1">PNMImage</span><span class="s2">.</span><span class="s1">Histogram</span><span class="s2">()</span>
            <span class="s1">image2 </span><span class="s2">= </span><span class="s1">PNMImage</span><span class="s2">(</span><span class="s1">image</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">image2</span><span class="s2">.</span><span class="s1">hasAlpha</span><span class="s2">():</span>
                <span class="s1">image2</span><span class="s2">.</span><span class="s1">premultiplyAlpha</span><span class="s2">()</span>
                <span class="s1">image2</span><span class="s2">.</span><span class="s1">removeAlpha</span><span class="s2">()</span>
            <span class="s1">image2</span><span class="s2">.</span><span class="s1">quantize</span><span class="s2">(</span><span class="s6">256</span><span class="s2">)</span>
            <span class="s1">image2</span><span class="s2">.</span><span class="s1">make_histogram</span><span class="s2">(</span><span class="s1">hist</span><span class="s2">)</span>
            <span class="s1">colors </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">hist</span><span class="s2">.</span><span class="s1">get_pixels</span><span class="s2">())</span>
            <span class="s4">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">colors</span><span class="s2">) &lt;= </span><span class="s6">256</span>

            <span class="s5"># Write the palette.</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s6">0</span>
            <span class="s4">while </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s6">256 </span><span class="s4">and </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">colors</span><span class="s2">):</span>
                <span class="s1">r</span><span class="s2">, </span><span class="s1">g</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">colors</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
                <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;BBBB'</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">g</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s6">0</span><span class="s2">))</span>
                <span class="s1">i </span><span class="s2">+= </span><span class="s6">1</span>
            <span class="s4">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s6">256</span><span class="s2">:</span>
                <span class="s5"># Fill the rest with zeroes.</span>
                <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b'</span><span class="s4">\x00</span><span class="s7">' </span><span class="s2">* (</span><span class="s6">4 </span><span class="s2">* (</span><span class="s6">256 </span><span class="s2">- </span><span class="s1">i</span><span class="s2">)))</span>

            <span class="s5"># Write indices.  Align rows to 4-byte boundary.</span>
            <span class="s1">rowalign </span><span class="s2">= </span><span class="s7">b'</span><span class="s4">\0</span><span class="s7">' </span><span class="s2">* (-</span><span class="s1">size </span><span class="s2">&amp; </span><span class="s6">3</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">y </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">size</span><span class="s2">):</span>
                <span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">size</span><span class="s2">):</span>
                    <span class="s1">pixel </span><span class="s2">= </span><span class="s1">image2</span><span class="s2">.</span><span class="s1">get_pixel</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">size </span><span class="s2">- </span><span class="s1">y </span><span class="s2">- </span><span class="s6">1</span><span class="s2">)</span>
                    <span class="s1">index </span><span class="s2">= </span><span class="s1">colors</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">pixel</span><span class="s2">)</span>
                    <span class="s4">if </span><span class="s1">index </span><span class="s2">&gt;= </span><span class="s6">256</span><span class="s2">:</span>
                        <span class="s5"># Find closest pixel instead.</span>
                        <span class="s1">index </span><span class="s2">= </span><span class="s1">closest_indices</span><span class="s2">[</span><span class="s1">index </span><span class="s2">- </span><span class="s6">256</span><span class="s2">]</span>
                    <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;B'</span><span class="s2">, </span><span class="s1">index</span><span class="s2">))</span>
                <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">rowalign</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;Invalid bpp %d&quot; </span><span class="s2">% (</span><span class="s1">bpp</span><span class="s2">))</span>

        <span class="s5"># Create an AND mask, aligned to 4-byte boundary</span>
        <span class="s4">if </span><span class="s1">image</span><span class="s2">.</span><span class="s1">hasAlpha</span><span class="s2">() </span><span class="s4">and </span><span class="s1">bpp </span><span class="s2">&lt;= </span><span class="s6">8</span><span class="s2">:</span>
            <span class="s1">rowalign </span><span class="s2">= </span><span class="s7">b'</span><span class="s4">\0</span><span class="s7">' </span><span class="s2">* (-((</span><span class="s1">size </span><span class="s2">+ </span><span class="s6">7</span><span class="s2">) &gt;&gt; </span><span class="s6">3</span><span class="s2">) &amp; </span><span class="s6">3</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">y </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">size</span><span class="s2">):</span>
                <span class="s1">mask </span><span class="s2">= </span><span class="s6">0</span>
                <span class="s1">num_bits </span><span class="s2">= </span><span class="s6">7</span>
                <span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">size</span><span class="s2">):</span>
                    <span class="s1">a </span><span class="s2">= </span><span class="s1">image</span><span class="s2">.</span><span class="s1">get_alpha_val</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">size </span><span class="s2">- </span><span class="s1">y </span><span class="s2">- </span><span class="s6">1</span><span class="s2">)</span>
                    <span class="s4">if </span><span class="s1">a </span><span class="s2">&lt;= </span><span class="s6">1</span><span class="s2">:</span>
                        <span class="s1">mask </span><span class="s2">|= (</span><span class="s6">1 </span><span class="s2">&lt;&lt; </span><span class="s1">num_bits</span><span class="s2">)</span>
                    <span class="s1">num_bits </span><span class="s2">-= </span><span class="s6">1</span>
                    <span class="s4">if </span><span class="s1">num_bits </span><span class="s2">&lt; </span><span class="s6">0</span><span class="s2">:</span>
                        <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;B'</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">))</span>
                        <span class="s1">mask </span><span class="s2">= </span><span class="s6">0</span>
                        <span class="s1">num_bits </span><span class="s2">= </span><span class="s6">7</span>
                <span class="s4">if </span><span class="s1">num_bits </span><span class="s2">&lt; </span><span class="s6">7</span><span class="s2">:</span>
                    <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;B'</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">))</span>
                <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">rowalign</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">andsize </span><span class="s2">= (</span><span class="s1">size </span><span class="s2">+ </span><span class="s6">7</span><span class="s2">) &gt;&gt; </span><span class="s6">3</span>
            <span class="s4">if </span><span class="s1">andsize </span><span class="s2">% </span><span class="s6">4 </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s1">andsize </span><span class="s2">+= </span><span class="s6">4 </span><span class="s2">- (</span><span class="s1">andsize </span><span class="s2">% </span><span class="s6">4</span><span class="s2">)</span>
            <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b'</span><span class="s4">\x00</span><span class="s7">' </span><span class="s2">* (</span><span class="s1">andsize </span><span class="s2">* </span><span class="s1">size</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">makeICO</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Writes the images to a Windows ICO file.  Returns True on success. &quot;&quot;&quot;</span>

        <span class="s4">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">Filename</span><span class="s2">):</span>
            <span class="s1">fn </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>

        <span class="s5"># ICO files only support resolutions up to 256x256.</span>
        <span class="s1">count </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s4">for </span><span class="s1">size </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">images</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">():</span>
            <span class="s4">if </span><span class="s1">size </span><span class="s2">&lt; </span><span class="s6">256</span><span class="s2">:</span>
                <span class="s1">count </span><span class="s2">+= </span><span class="s6">1</span>
            <span class="s4">if </span><span class="s1">size </span><span class="s2">&lt;= </span><span class="s6">256</span><span class="s2">:</span>
                <span class="s1">count </span><span class="s2">+= </span><span class="s6">1</span>
        <span class="s1">dataoffs </span><span class="s2">= </span><span class="s6">6 </span><span class="s2">+ </span><span class="s1">count </span><span class="s2">* </span><span class="s6">16</span>

        <span class="s1">ico </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s3">'wb'</span><span class="s2">)</span>
        <span class="s1">ico</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;HHH'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s1">count</span><span class="s2">))</span>

        <span class="s5"># Write 8-bpp image headers for sizes under 256x256.</span>
        <span class="s4">for </span><span class="s1">size</span><span class="s2">, </span><span class="s1">image </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">images</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s4">if </span><span class="s1">size </span><span class="s2">&gt;= </span><span class="s6">256</span><span class="s2">:</span>
                <span class="s4">continue</span>
            <span class="s1">ico</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;BB'</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">size</span><span class="s2">))</span>

            <span class="s5"># Calculate row sizes</span>
            <span class="s1">xorsize </span><span class="s2">= </span><span class="s1">size</span>
            <span class="s4">if </span><span class="s1">xorsize </span><span class="s2">% </span><span class="s6">4 </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s1">xorsize </span><span class="s2">+= </span><span class="s6">4 </span><span class="s2">- (</span><span class="s1">xorsize </span><span class="s2">% </span><span class="s6">4</span><span class="s2">)</span>
            <span class="s1">andsize </span><span class="s2">= (</span><span class="s1">size </span><span class="s2">+ </span><span class="s6">7</span><span class="s2">) &gt;&gt; </span><span class="s6">3</span>
            <span class="s4">if </span><span class="s1">andsize </span><span class="s2">% </span><span class="s6">4 </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s1">andsize </span><span class="s2">+= </span><span class="s6">4 </span><span class="s2">- (</span><span class="s1">andsize </span><span class="s2">% </span><span class="s6">4</span><span class="s2">)</span>
            <span class="s1">datasize </span><span class="s2">= </span><span class="s6">40 </span><span class="s2">+ </span><span class="s6">256 </span><span class="s2">* </span><span class="s6">4 </span><span class="s2">+ (</span><span class="s1">xorsize </span><span class="s2">+ </span><span class="s1">andsize</span><span class="s2">) * </span><span class="s1">size</span>

            <span class="s1">ico</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;BBHHII'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">8</span><span class="s2">, </span><span class="s1">datasize</span><span class="s2">, </span><span class="s1">dataoffs</span><span class="s2">))</span>
            <span class="s1">dataoffs </span><span class="s2">+= </span><span class="s1">datasize</span>

        <span class="s5"># Write 24/32-bpp image headers.</span>
        <span class="s4">for </span><span class="s1">size</span><span class="s2">, </span><span class="s1">image </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">images</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s4">if </span><span class="s1">size </span><span class="s2">&gt; </span><span class="s6">256</span><span class="s2">:</span>
                <span class="s4">continue</span>
            <span class="s4">elif </span><span class="s1">size </span><span class="s2">== </span><span class="s6">256</span><span class="s2">:</span>
                <span class="s1">ico</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b'</span><span class="s4">\0\0</span><span class="s7">'</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">ico</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;BB'</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">size</span><span class="s2">))</span>

            <span class="s5"># Calculate the size so we can write the offset within the file.</span>
            <span class="s4">if </span><span class="s1">image</span><span class="s2">.</span><span class="s1">hasAlpha</span><span class="s2">():</span>
                <span class="s1">bpp </span><span class="s2">= </span><span class="s6">32</span>
                <span class="s1">xorsize </span><span class="s2">= </span><span class="s1">size </span><span class="s2">* </span><span class="s6">4</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">bpp </span><span class="s2">= </span><span class="s6">24</span>
                <span class="s1">xorsize </span><span class="s2">= </span><span class="s1">size </span><span class="s2">* </span><span class="s6">3 </span><span class="s2">+ (-(</span><span class="s1">size </span><span class="s2">* </span><span class="s6">3</span><span class="s2">) &amp; </span><span class="s6">3</span><span class="s2">)</span>
            <span class="s1">andsize </span><span class="s2">= (</span><span class="s1">size </span><span class="s2">+ </span><span class="s6">7</span><span class="s2">) &gt;&gt; </span><span class="s6">3</span>
            <span class="s4">if </span><span class="s1">andsize </span><span class="s2">% </span><span class="s6">4 </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s1">andsize </span><span class="s2">+= </span><span class="s6">4 </span><span class="s2">- (</span><span class="s1">andsize </span><span class="s2">% </span><span class="s6">4</span><span class="s2">)</span>
            <span class="s1">datasize </span><span class="s2">= </span><span class="s6">40 </span><span class="s2">+ (</span><span class="s1">xorsize </span><span class="s2">+ </span><span class="s1">andsize</span><span class="s2">) * </span><span class="s1">size</span>

            <span class="s1">ico</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;BBHHII'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s1">bpp</span><span class="s2">, </span><span class="s1">datasize</span><span class="s2">, </span><span class="s1">dataoffs</span><span class="s2">))</span>
            <span class="s1">dataoffs </span><span class="s2">+= </span><span class="s1">datasize</span>

        <span class="s5"># Now write the actual icon bitmap data.</span>
        <span class="s4">for </span><span class="s1">size</span><span class="s2">, </span><span class="s1">image </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">images</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s4">if </span><span class="s1">size </span><span class="s2">&lt; </span><span class="s6">256</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_write_bitmap</span><span class="s2">(</span><span class="s1">ico</span><span class="s2">, </span><span class="s1">image</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s6">8</span><span class="s2">)</span>

        <span class="s4">for </span><span class="s1">size</span><span class="s2">, </span><span class="s1">image </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">images</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s4">if </span><span class="s1">size </span><span class="s2">&lt;= </span><span class="s6">256</span><span class="s2">:</span>
                <span class="s1">bpp </span><span class="s2">= </span><span class="s6">32 </span><span class="s4">if </span><span class="s1">image</span><span class="s2">.</span><span class="s1">hasAlpha</span><span class="s2">() </span><span class="s4">else </span><span class="s6">24</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_write_bitmap</span><span class="s2">(</span><span class="s1">ico</span><span class="s2">, </span><span class="s1">image</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">bpp</span><span class="s2">)</span>

        <span class="s4">assert </span><span class="s1">ico</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">() == </span><span class="s1">dataoffs</span>
        <span class="s1">ico</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">makeICNS</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Writes the images to an Apple ICNS file.  Returns True on success. &quot;&quot;&quot;</span>

        <span class="s4">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">Filename</span><span class="s2">):</span>
            <span class="s1">fn </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>

        <span class="s1">icns </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s3">'wb'</span><span class="s2">)</span>
        <span class="s1">icns</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b'icns</span><span class="s4">\0\0\0\0</span><span class="s7">'</span><span class="s2">)</span>

        <span class="s1">icon_types </span><span class="s2">= {</span><span class="s6">16</span><span class="s2">: </span><span class="s7">b'is32'</span><span class="s2">, </span><span class="s6">32</span><span class="s2">: </span><span class="s7">b'il32'</span><span class="s2">, </span><span class="s6">48</span><span class="s2">: </span><span class="s7">b'ih32'</span><span class="s2">, </span><span class="s6">128</span><span class="s2">: </span><span class="s7">b'it32'</span><span class="s2">}</span>
        <span class="s1">mask_types </span><span class="s2">= {</span><span class="s6">16</span><span class="s2">: </span><span class="s7">b's8mk'</span><span class="s2">, </span><span class="s6">32</span><span class="s2">: </span><span class="s7">b'l8mk'</span><span class="s2">, </span><span class="s6">48</span><span class="s2">: </span><span class="s7">b'h8mk'</span><span class="s2">, </span><span class="s6">128</span><span class="s2">: </span><span class="s7">b't8mk'</span><span class="s2">}</span>
        <span class="s1">png_types </span><span class="s2">= {</span><span class="s6">256</span><span class="s2">: </span><span class="s7">b'ic08'</span><span class="s2">, </span><span class="s6">512</span><span class="s2">: </span><span class="s7">b'ic09'</span><span class="s2">, </span><span class="s6">1024</span><span class="s2">: </span><span class="s7">b'ic10'</span><span class="s2">}</span>

        <span class="s1">pngtype </span><span class="s2">= </span><span class="s1">PNMFileTypeRegistry</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">().</span><span class="s1">getTypeFromExtension</span><span class="s2">(</span><span class="s3">&quot;png&quot;</span><span class="s2">)</span>

        <span class="s4">for </span><span class="s1">size</span><span class="s2">, </span><span class="s1">image </span><span class="s4">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">images</span><span class="s2">.</span><span class="s1">items</span><span class="s2">(), </span><span class="s1">key</span><span class="s2">=</span><span class="s4">lambda </span><span class="s1">item</span><span class="s2">:</span><span class="s1">item</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]):</span>
            <span class="s4">if </span><span class="s1">size </span><span class="s4">in </span><span class="s1">png_types </span><span class="s4">and </span><span class="s1">pngtype </span><span class="s4">is not None</span><span class="s2">:</span>
                <span class="s1">stream </span><span class="s2">= </span><span class="s1">StringStream</span><span class="s2">()</span>
                <span class="s1">image</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">pngtype</span><span class="s2">)</span>
                <span class="s1">pngdata </span><span class="s2">= </span><span class="s1">stream</span><span class="s2">.</span><span class="s1">data</span>

                <span class="s1">icns</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">png_types</span><span class="s2">[</span><span class="s1">size</span><span class="s2">])</span>
                <span class="s1">icns</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&gt;I'</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">pngdata</span><span class="s2">)))</span>
                <span class="s1">icns</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">pngdata</span><span class="s2">)</span>

            <span class="s4">elif </span><span class="s1">size </span><span class="s4">in </span><span class="s1">icon_types</span><span class="s2">:</span>
                <span class="s5"># If it has an alpha channel, we write out a mask too.</span>
                <span class="s4">if </span><span class="s1">image</span><span class="s2">.</span><span class="s1">hasAlpha</span><span class="s2">():</span>
                    <span class="s1">icns</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">mask_types</span><span class="s2">[</span><span class="s1">size</span><span class="s2">])</span>
                    <span class="s1">icns</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&gt;I'</span><span class="s2">, </span><span class="s1">size </span><span class="s2">* </span><span class="s1">size </span><span class="s2">+ </span><span class="s6">8</span><span class="s2">))</span>

                    <span class="s4">for </span><span class="s1">y </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">size</span><span class="s2">):</span>
                        <span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">size</span><span class="s2">):</span>
                            <span class="s1">icns</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&lt;B'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">image</span><span class="s2">.</span><span class="s1">getAlpha</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) * </span><span class="s6">255</span><span class="s2">)))</span>

                <span class="s1">icns</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">icon_types</span><span class="s2">[</span><span class="s1">size</span><span class="s2">])</span>
                <span class="s1">icns</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&gt;I'</span><span class="s2">, </span><span class="s1">size </span><span class="s2">* </span><span class="s1">size </span><span class="s2">* </span><span class="s6">4 </span><span class="s2">+ </span><span class="s6">8</span><span class="s2">))</span>

                <span class="s4">for </span><span class="s1">y </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">size</span><span class="s2">):</span>
                    <span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">size</span><span class="s2">):</span>
                        <span class="s1">r</span><span class="s2">, </span><span class="s1">g</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">image</span><span class="s2">.</span><span class="s1">getXel</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
                        <span class="s1">icns</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&gt;BBBB'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">r </span><span class="s2">* </span><span class="s6">255</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">g </span><span class="s2">* </span><span class="s6">255</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">b </span><span class="s2">* </span><span class="s6">255</span><span class="s2">)))</span>

        <span class="s1">length </span><span class="s2">= </span><span class="s1">icns</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">()</span>
        <span class="s1">icns</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s6">4</span><span class="s2">)</span>
        <span class="s1">icns</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&gt;I'</span><span class="s2">, </span><span class="s1">length</span><span class="s2">))</span>
        <span class="s1">icns</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s4">return True</span>


<span class="s4">class </span><span class="s1">Installer</span><span class="s2">:</span>
    <span class="s0">&quot;&quot;&quot; This class creates a (graphical) installer from a given .p3d file. &quot;&quot;&quot;</span>
    <span class="s1">notify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s3">&quot;Installer&quot;</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">p3dfile</span><span class="s2">, </span><span class="s1">shortname</span><span class="s2">, </span><span class="s1">fullname</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">tokens </span><span class="s2">= {}):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dFilename </span><span class="s2">= </span><span class="s1">p3dfile</span>
        <span class="s4">if not </span><span class="s1">shortname</span><span class="s2">:</span>
            <span class="s1">shortname </span><span class="s2">= </span><span class="s1">p3dfile</span><span class="s2">.</span><span class="s1">getBasenameWoExtension</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">shortname </span><span class="s2">= </span><span class="s1">shortname</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fullname </span><span class="s2">= </span><span class="s1">fullname</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">version</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">includeRequires </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">offerRun </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">offerDesktopShortcut </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">licensename </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">licensefile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">authorid </span><span class="s2">= </span><span class="s3">&quot;org.panda3d&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">authorname </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;DEBFULLNAME&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">authoremail </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;DEBEMAIL&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">icon </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s5"># Try to determine a default author name ourselves.</span>
        <span class="s1">uname </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">if </span><span class="s1">pwd </span><span class="s4">is not None and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">os</span><span class="s2">, </span><span class="s3">'getuid'</span><span class="s2">):</span>
            <span class="s1">uinfo </span><span class="s2">= </span><span class="s1">pwd</span><span class="s2">.</span><span class="s1">getpwuid</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">getuid</span><span class="s2">())</span>
            <span class="s4">if </span><span class="s1">uinfo</span><span class="s2">:</span>
                <span class="s1">uname </span><span class="s2">= </span><span class="s1">uinfo</span><span class="s2">.</span><span class="s1">pw_name</span>
                <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">authorname</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">authorname </span><span class="s2">= </span><span class="s1">\</span>
                        <span class="s1">uinfo</span><span class="s2">.</span><span class="s1">pw_gecos</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">','</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)[</span><span class="s6">0</span><span class="s2">]</span>

        <span class="s5"># Fallbacks in case that didn't work or wasn't supported.</span>
        <span class="s4">if not </span><span class="s1">uname</span><span class="s2">:</span>
            <span class="s1">uname </span><span class="s2">= </span><span class="s1">getpass</span><span class="s2">.</span><span class="s1">getuser</span><span class="s2">()</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">authorname</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">authorname </span><span class="s2">= </span><span class="s1">uname</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">authoremail </span><span class="s4">and </span><span class="s3">' ' </span><span class="s4">not in </span><span class="s1">uname</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">authoremail </span><span class="s2">= </span><span class="s3">&quot;%s@%s&quot; </span><span class="s2">% (</span><span class="s1">uname</span><span class="s2">, </span><span class="s1">socket</span><span class="s2">.</span><span class="s1">gethostname</span><span class="s2">())</span>

        <span class="s5"># Load the p3d file to read out the required packages</span>
        <span class="s1">mf </span><span class="s2">= </span><span class="s1">Multifile</span><span class="s2">()</span>
        <span class="s4">if not </span><span class="s1">mf</span><span class="s2">.</span><span class="s1">openRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dFilename</span><span class="s2">):</span>
            <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Not a Panda3D application: %s&quot; </span><span class="s2">% (</span><span class="s1">p3dfile</span><span class="s2">))</span>
            <span class="s4">return</span>

        <span class="s5"># Now load the p3dInfo file.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">requires </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">extracts </span><span class="s2">= []</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">mf</span><span class="s2">.</span><span class="s1">findSubfile</span><span class="s2">(</span><span class="s3">'p3d_info.xml'</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">i </span><span class="s2">&gt;= </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">stream </span><span class="s2">= </span><span class="s1">mf</span><span class="s2">.</span><span class="s1">openReadSubfile</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
            <span class="s1">p3dInfo </span><span class="s2">= </span><span class="s1">readXmlStream</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">)</span>
            <span class="s1">mf</span><span class="s2">.</span><span class="s1">closeReadSubfile</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">p3dInfo</span><span class="s2">:</span>
                <span class="s1">p3dPackage </span><span class="s2">= </span><span class="s1">p3dInfo</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'package'</span><span class="s2">)</span>
                <span class="s1">p3dHost </span><span class="s2">= </span><span class="s1">p3dPackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'host'</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">p3dHost</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'url'</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl </span><span class="s2">= </span><span class="s1">p3dHost</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'url'</span><span class="s2">)</span>
                <span class="s1">p3dRequires </span><span class="s2">= </span><span class="s1">p3dPackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'requires'</span><span class="s2">)</span>
                <span class="s4">while </span><span class="s1">p3dRequires</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span>
                        <span class="s1">p3dRequires</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">),</span>
                        <span class="s1">p3dRequires</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'version'</span><span class="s2">),</span>
                        <span class="s1">p3dRequires</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'host'</span><span class="s2">)))</span>
                    <span class="s1">p3dRequires </span><span class="s2">= </span><span class="s1">p3dRequires</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s3">'requires'</span><span class="s2">)</span>

                <span class="s1">p3dExtract </span><span class="s2">= </span><span class="s1">p3dPackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'extract'</span><span class="s2">)</span>
                <span class="s4">while </span><span class="s1">p3dExtract</span><span class="s2">:</span>
                    <span class="s1">filename </span><span class="s2">= </span><span class="s1">p3dExtract</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'filename'</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">extracts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
                    <span class="s1">p3dExtract </span><span class="s2">= </span><span class="s1">p3dExtract</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s3">'extract'</span><span class="s2">)</span>

                <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">:</span>
                    <span class="s1">p3dConfig </span><span class="s2">= </span><span class="s1">p3dPackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'config'</span><span class="s2">)</span>
                    <span class="s4">if </span><span class="s1">p3dConfig</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">fullname </span><span class="s2">= </span><span class="s1">p3dConfig</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'display_name'</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;No p3d_info.xml was found in .p3d archive.&quot;</span><span class="s2">)</span>

        <span class="s1">mf</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl </span><span class="s2">= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageHostUrl</span><span class="s2">()</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">standalone</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostUrl</span>
            <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;No host URL was specified by .p3d archive.  Falling back to %s&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">))</span>

        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">fullname </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">tempDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">) + </span><span class="s3">&quot;/&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tempDir</span><span class="s2">.</span><span class="s1">makeDir</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__tempRoots </span><span class="s2">= {}</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extracts</span><span class="s2">:</span>
            <span class="s5"># Copy .p3d to a temporary file so we can remove the extracts.</span>
            <span class="s1">p3dfile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tempDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dFilename</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">())</span>
            <span class="s1">shutil</span><span class="s2">.</span><span class="s1">copyfile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dFilename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s1">p3dfile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
            <span class="s1">mf </span><span class="s2">= </span><span class="s1">Multifile</span><span class="s2">()</span>
            <span class="s4">if not </span><span class="s1">mf</span><span class="s2">.</span><span class="s1">openReadWrite</span><span class="s2">(</span><span class="s1">p3dfile</span><span class="s2">):</span>
                <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Failure to open %s for writing.&quot; </span><span class="s2">% (</span><span class="s1">p3dfile</span><span class="s2">))</span>

            <span class="s5"># We don't really need this silly thing when embedding, anyway.</span>
            <span class="s1">mf</span><span class="s2">.</span><span class="s1">setHeaderPrefix</span><span class="s2">(</span><span class="s3">&quot;&quot;</span><span class="s2">)</span>

            <span class="s4">for </span><span class="s1">fn </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extracts</span><span class="s2">:</span>
                <span class="s4">if not </span><span class="s1">mf</span><span class="s2">.</span><span class="s1">removeSubfile</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">):</span>
                    <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Failure to remove %s from multifile.&quot; </span><span class="s2">% (</span><span class="s1">p3dfile</span><span class="s2">))</span>

            <span class="s1">mf</span><span class="s2">.</span><span class="s1">repack</span><span class="s2">()</span>
            <span class="s1">mf</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">standalone </span><span class="s2">= </span><span class="s1">Standalone</span><span class="s2">(</span><span class="s1">p3dfile</span><span class="s2">, </span><span class="s1">tokens</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__del__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">appRunner</span><span class="s2">.</span><span class="s1">rmtree</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tempDir</span><span class="s2">)</span>
        <span class="s4">except</span><span class="s2">:</span>
            <span class="s4">try</span><span class="s2">: </span><span class="s1">shutil</span><span class="s2">.</span><span class="s1">rmtree</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tempDir</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
            <span class="s4">except</span><span class="s2">: </span><span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">installPackagesInto</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">hostDir</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Installs the packages required by the .p3d file into 
        the specified directory, for the given platform. &quot;&quot;&quot;</span>

        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">includeRequires</span><span class="s2">:</span>
            <span class="s4">return</span>

        <span class="s5"># Write out the extracts from the original .p3d.</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extracts</span><span class="s2">:</span>
            <span class="s1">mf </span><span class="s2">= </span><span class="s1">Multifile</span><span class="s2">()</span>
            <span class="s4">if not </span><span class="s1">mf</span><span class="s2">.</span><span class="s1">openRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dFilename</span><span class="s2">):</span>
                <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Failed to open .p3d archive: %s&quot; </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">))</span>

            <span class="s4">for </span><span class="s1">filename </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extracts</span><span class="s2">:</span>
                <span class="s1">i </span><span class="s2">= </span><span class="s1">mf</span><span class="s2">.</span><span class="s1">findSubfile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s6">0</span><span class="s2">:</span>
                    <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Cannot find extract in .p3d archive: %s&quot; </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">))</span>
                    <span class="s4">continue</span>

                <span class="s4">if not </span><span class="s1">mf</span><span class="s2">.</span><span class="s1">extractSubfile</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">hostDir</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">)):</span>
                    <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Failed to extract file from .p3d archive: %s&quot; </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">))</span>
            <span class="s1">mf</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s1">pkgTree </span><span class="s2">= </span><span class="s1">PackageTree</span><span class="s2">(</span><span class="s1">platform</span><span class="s2">, </span><span class="s1">hostDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">)</span>
        <span class="s1">pkgTree</span><span class="s2">.</span><span class="s1">installPackage</span><span class="s2">(</span><span class="s3">&quot;images&quot;</span><span class="s2">, </span><span class="s4">None</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">standalone</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">)</span>

        <span class="s4">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">hostUrl </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">:</span>
            <span class="s1">pkgTree</span><span class="s2">.</span><span class="s1">installPackage</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">hostUrl</span><span class="s2">)</span>

        <span class="s5"># Remove the extracted files from the compressed archive, to save space.</span>
        <span class="s1">vfs </span><span class="s2">= </span><span class="s1">VirtualFileSystem</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>
        <span class="s4">for </span><span class="s1">package </span><span class="s4">in </span><span class="s1">pkgTree</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
            <span class="s4">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">uncompressedArchive</span><span class="s2">:</span>
                <span class="s1">archive </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">getPackageDir</span><span class="s2">(), </span><span class="s1">package</span><span class="s2">.</span><span class="s1">uncompressedArchive</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>
                <span class="s4">if not </span><span class="s1">archive</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">():</span>
                    <span class="s4">continue</span>

                <span class="s1">mf </span><span class="s2">= </span><span class="s1">Multifile</span><span class="s2">()</span>
                <span class="s5"># Make sure that it isn't mounted before altering it, just to be safe</span>
                <span class="s1">vfs</span><span class="s2">.</span><span class="s1">unmount</span><span class="s2">(</span><span class="s1">archive</span><span class="s2">)</span>
                <span class="s1">os</span><span class="s2">.</span><span class="s1">chmod</span><span class="s2">(</span><span class="s1">archive</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s6">0o644</span><span class="s2">)</span>
                <span class="s4">if not </span><span class="s1">mf</span><span class="s2">.</span><span class="s1">openReadWrite</span><span class="s2">(</span><span class="s1">archive</span><span class="s2">):</span>
                    <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Failed to open archive %s&quot; </span><span class="s2">% (</span><span class="s1">archive</span><span class="s2">))</span>
                    <span class="s4">continue</span>

                <span class="s5"># We don't iterate over getNumSubfiles because we're</span>
                <span class="s5"># removing subfiles while we're iterating over them.</span>
                <span class="s1">subfiles </span><span class="s2">= </span><span class="s1">mf</span><span class="s2">.</span><span class="s1">getSubfileNames</span><span class="s2">()</span>
                <span class="s4">for </span><span class="s1">subfile </span><span class="s4">in </span><span class="s1">subfiles</span><span class="s2">:</span>
                    <span class="s5"># We do *NOT* call vfs.exists here in case the package is mounted.</span>
                    <span class="s4">if </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">getPackageDir</span><span class="s2">(), </span><span class="s1">subfile</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">():</span>
                        <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;Removing already-extracted %s from multifile&quot; </span><span class="s2">% (</span><span class="s1">subfile</span><span class="s2">))</span>
                        <span class="s1">mf</span><span class="s2">.</span><span class="s1">removeSubfile</span><span class="s2">(</span><span class="s1">subfile</span><span class="s2">)</span>

                <span class="s5"># This seems essential for mf.close() not to crash later.</span>
                <span class="s1">mf</span><span class="s2">.</span><span class="s1">repack</span><span class="s2">()</span>

                <span class="s5"># If we have no subfiles left, we can just remove the multifile.</span>
                <span class="s5">#XXX rdb: it seems that removing it causes trouble, so let's not.</span>
                <span class="s5">#if mf.getNumSubfiles() == 0:</span>
                <span class="s5">#    Installer.notify.info(&quot;Removing empty archive %s&quot; % (package.uncompressedArchive.filename))</span>
                <span class="s5">#    mf.close()</span>
                <span class="s5">#    archive.unlink()</span>
                <span class="s5">#else:</span>
                <span class="s1">mf</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
                <span class="s4">try</span><span class="s2">: </span><span class="s1">os</span><span class="s2">.</span><span class="s1">chmod</span><span class="s2">(</span><span class="s1">archive</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s6">0o444</span><span class="s2">)</span>
                <span class="s4">except</span><span class="s2">: </span><span class="s4">pass</span>

        <span class="s5"># Write out our own contents.xml file.</span>
        <span class="s1">doc </span><span class="s2">= </span><span class="s1">TiXmlDocument</span><span class="s2">()</span>
        <span class="s1">decl </span><span class="s2">= </span><span class="s1">TiXmlDeclaration</span><span class="s2">(</span><span class="s3">&quot;1.0&quot;</span><span class="s2">, </span><span class="s3">&quot;utf-8&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
        <span class="s1">doc</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">decl</span><span class="s2">)</span>

        <span class="s1">xcontents </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">&quot;contents&quot;</span><span class="s2">)</span>
        <span class="s4">for </span><span class="s1">package </span><span class="s4">in </span><span class="s1">pkgTree</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
            <span class="s1">xpackage </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'package'</span><span class="s2">)</span>
            <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">)</span>

            <span class="s1">filename </span><span class="s2">= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">+ </span><span class="s3">&quot;/&quot;</span>

            <span class="s4">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageVersion</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'version'</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageVersion</span><span class="s2">)</span>
                <span class="s1">filename </span><span class="s2">+= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageVersion </span><span class="s2">+ </span><span class="s3">&quot;/&quot;</span>

            <span class="s4">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'platform'</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>
                <span class="s1">filename </span><span class="s2">+= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">+ </span><span class="s3">&quot;/&quot;</span>
                <span class="s4">assert </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s1">platform</span>

            <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'per_platform'</span><span class="s2">, </span><span class="s3">'1'</span><span class="s2">)</span>

            <span class="s1">filename </span><span class="s2">+= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">descFileBasename</span>
            <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'filename'</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">)</span>
            <span class="s1">xcontents</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">)</span>

        <span class="s1">doc</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xcontents</span><span class="s2">)</span>
        <span class="s1">doc</span><span class="s2">.</span><span class="s1">SaveFile</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">hostDir</span><span class="s2">, </span><span class="s3">&quot;contents.xml&quot;</span><span class="s2">).</span><span class="s1">toOsSpecific</span><span class="s2">())</span>

    <span class="s4">def </span><span class="s1">buildAll</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">outputDir </span><span class="s2">= </span><span class="s3">&quot;.&quot;</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Creates a (graphical) installer for every known platform. 
        Call this after you have set the desired parameters. &quot;&quot;&quot;</span>

        <span class="s1">platforms </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s4">for </span><span class="s1">package </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">standalone</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">getPackages</span><span class="s2">(</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;p3dembed&quot;</span><span class="s2">):</span>
            <span class="s1">platforms</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">platforms</span><span class="s2">) == </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;No platforms found to build for!&quot;</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s3">'win32' </span><span class="s4">in </span><span class="s1">platforms </span><span class="s4">and </span><span class="s3">'win_i386' </span><span class="s4">in </span><span class="s1">platforms</span><span class="s2">:</span>
            <span class="s1">platforms</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">'win32'</span><span class="s2">)</span>

        <span class="s1">outputDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">outputDir </span><span class="s2">+ </span><span class="s3">&quot;/&quot;</span><span class="s2">)</span>
        <span class="s1">outputDir</span><span class="s2">.</span><span class="s1">makeDir</span><span class="s2">()</span>
        <span class="s4">for </span><span class="s1">platform </span><span class="s4">in </span><span class="s1">platforms</span><span class="s2">:</span>
            <span class="s1">output </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">outputDir</span><span class="s2">, </span><span class="s1">platform </span><span class="s2">+ </span><span class="s3">&quot;/&quot;</span><span class="s2">)</span>
            <span class="s1">output</span><span class="s2">.</span><span class="s1">makeDir</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">output</span><span class="s2">, </span><span class="s1">platform </span><span class="s2">= </span><span class="s4">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Builds (graphical) installers and stores it into the path 
        indicated by the 'output' argument. You can specify to build for 
        a different platform by altering the 'platform' argument. 
        If 'output' is a directory, the installer will be stored in it. &quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s1">platform </span><span class="s2">== </span><span class="s4">None</span><span class="s2">:</span>
            <span class="s1">platform </span><span class="s2">= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPlatform</span><span class="s2">()</span>

        <span class="s4">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;win&quot;</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">buildNSIS</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">)</span>
            <span class="s4">return</span>
        <span class="s4">elif </span><span class="s3">&quot;_&quot; </span><span class="s4">in </span><span class="s1">platform</span><span class="s2">:</span>
            <span class="s1">osname</span><span class="s2">, </span><span class="s1">arch </span><span class="s2">= </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;_&quot;</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">osname </span><span class="s2">== </span><span class="s3">&quot;linux&quot;</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">buildDEB</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">buildArch</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">)</span>
                <span class="s4">return</span>
            <span class="s4">elif </span><span class="s1">osname </span><span class="s2">== </span><span class="s3">&quot;osx&quot;</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">buildPKG</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">)</span>
                <span class="s4">return</span>
        <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Ignoring unknown platform &quot; </span><span class="s2">+ </span><span class="s1">platform</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__buildTempLinux</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Builds a filesystem for Linux.  Used so that buildDEB, 
        buildRPM and buildArch can share the same temp directory. &quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s1">platform </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__tempRoots</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__tempRoots</span><span class="s2">[</span><span class="s1">platform</span><span class="s2">]</span>

        <span class="s1">tempdir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tempDir</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">)</span>
        <span class="s1">tempdir</span><span class="s2">.</span><span class="s1">makeDir</span><span class="s2">()</span>

        <span class="s1">Filename</span><span class="s2">(</span><span class="s1">tempdir</span><span class="s2">, </span><span class="s3">&quot;usr/bin/&quot;</span><span class="s2">).</span><span class="s1">makeDir</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">includeRequires</span><span class="s2">:</span>
            <span class="s1">extraTokens </span><span class="s2">= {</span><span class="s3">&quot;host_dir&quot; </span><span class="s2">: </span><span class="s3">&quot;/usr/lib/&quot; </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">(),</span>
                           <span class="s3">&quot;start_dir&quot; </span><span class="s2">: </span><span class="s3">&quot;/usr/lib/&quot; </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()}</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">extraTokens </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">standalone</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">tempdir</span><span class="s2">, </span><span class="s3">&quot;usr/bin/&quot; </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()), </span><span class="s1">platform</span><span class="s2">, </span><span class="s1">extraTokens</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">licensefile</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">():</span>
            <span class="s1">Filename</span><span class="s2">(</span><span class="s1">tempdir</span><span class="s2">, </span><span class="s3">&quot;usr/share/doc/%s/&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()).</span><span class="s1">makeDir</span><span class="s2">()</span>
            <span class="s1">shutil</span><span class="s2">.</span><span class="s1">copyfile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">licensefile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">tempdir</span><span class="s2">, </span><span class="s3">&quot;usr/share/doc/%s/copyright&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()).</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
            <span class="s1">shutil</span><span class="s2">.</span><span class="s1">copyfile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">licensefile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">tempdir</span><span class="s2">, </span><span class="s3">&quot;usr/share/doc/%s/LICENSE&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()).</span><span class="s1">toOsSpecific</span><span class="s2">())</span>

        <span class="s5"># Add an image file to /usr/share/pixmaps/</span>
        <span class="s1">iconFile </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">icon </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">iconImage </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s4">if </span><span class="s6">48 </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">icon</span><span class="s2">.</span><span class="s1">images</span><span class="s2">:</span>
                <span class="s1">iconImage </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">icon</span><span class="s2">.</span><span class="s1">images</span><span class="s2">[</span><span class="s6">48</span><span class="s2">]</span>
            <span class="s4">elif </span><span class="s6">64 </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">icon</span><span class="s2">.</span><span class="s1">images</span><span class="s2">:</span>
                <span class="s1">iconImage </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">icon</span><span class="s2">.</span><span class="s1">images</span><span class="s2">[</span><span class="s6">64</span><span class="s2">]</span>
            <span class="s4">elif </span><span class="s6">32 </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">icon</span><span class="s2">.</span><span class="s1">images</span><span class="s2">:</span>
                <span class="s1">iconImage </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">icon</span><span class="s2">.</span><span class="s1">images</span><span class="s2">[</span><span class="s6">32</span><span class="s2">]</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;No suitable icon image for Linux provided, should preferably be 48x48 in size&quot;</span><span class="s2">)</span>

            <span class="s4">if </span><span class="s1">iconImage </span><span class="s4">is not None</span><span class="s2">:</span>
                <span class="s1">iconFile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">tempdir</span><span class="s2">, </span><span class="s3">&quot;usr/share/pixmaps/%s.png&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">)</span>
                <span class="s1">iconFile</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>
                <span class="s1">iconFile</span><span class="s2">.</span><span class="s1">makeDir</span><span class="s2">()</span>
                <span class="s4">if not </span><span class="s1">iconImage</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">iconFile</span><span class="s2">):</span>
                    <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Failed to write icon file for Linux&quot;</span><span class="s2">)</span>
                    <span class="s1">iconFile</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>
                    <span class="s1">iconFile </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s5"># Write a .desktop file to /usr/share/applications/</span>
        <span class="s1">desktopFile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">tempdir</span><span class="s2">, </span><span class="s3">&quot;usr/share/applications/%s.desktop&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">())</span>
        <span class="s1">desktopFile</span><span class="s2">.</span><span class="s1">setText</span><span class="s2">()</span>
        <span class="s1">desktopFile</span><span class="s2">.</span><span class="s1">makeDir</span><span class="s2">()</span>
        <span class="s1">desktop </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">desktopFile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">'w'</span><span class="s2">)</span>
        <span class="s1">desktop</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;[Desktop Entry]</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s2">)</span>
        <span class="s1">desktop</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;Name=%s</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">)</span>
        <span class="s1">desktop</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;Exec=%s</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">())</span>
        <span class="s4">if </span><span class="s1">iconFile </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">desktop</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;Icon=%s</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% </span><span class="s1">iconFile</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">())</span>

        <span class="s5"># Set the &quot;Terminal&quot; option based on whether or not a console env is requested</span>
        <span class="s1">cEnv </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">standalone</span><span class="s2">.</span><span class="s1">tokens</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;console_environment&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">cEnv </span><span class="s2">== </span><span class="s3">&quot;&quot; </span><span class="s4">or </span><span class="s1">int</span><span class="s2">(</span><span class="s1">cEnv</span><span class="s2">) == </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">desktop</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;Terminal=false</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">desktop</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;Terminal=true</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s2">)</span>

        <span class="s1">desktop</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;Type=Application</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s2">)</span>
        <span class="s1">desktop</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">includeRequires </span><span class="s4">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extracts</span><span class="s2">:</span>
            <span class="s1">hostDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">tempdir</span><span class="s2">, </span><span class="s3">&quot;usr/lib/%s/&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">())</span>
            <span class="s1">hostDir</span><span class="s2">.</span><span class="s1">makeDir</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">installPackagesInto</span><span class="s2">(</span><span class="s1">hostDir</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">)</span>

        <span class="s1">totsize </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s4">for </span><span class="s1">root</span><span class="s2">, </span><span class="s1">dirs</span><span class="s2">, </span><span class="s1">files </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">os_walk</span><span class="s2">(</span><span class="s1">tempdir</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()):</span>
            <span class="s4">for </span><span class="s1">name </span><span class="s4">in </span><span class="s1">files</span><span class="s2">:</span>
                <span class="s1">totsize </span><span class="s2">+= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">getsize</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">root</span><span class="s2">, </span><span class="s1">name</span><span class="s2">))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__tempRoots</span><span class="s2">[</span><span class="s1">platform</span><span class="s2">] = (</span><span class="s1">tempdir</span><span class="s2">, </span><span class="s1">totsize</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__tempRoots</span><span class="s2">[</span><span class="s1">platform</span><span class="s2">]</span>

    <span class="s4">def </span><span class="s1">buildDEB</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">output</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Builds a .deb archive and stores it in the path indicated 
        by the 'output' argument. It will be built for the architecture 
        specified by the 'arch' argument. 
        If 'output' is a directory, the deb file will be stored in it. &quot;&quot;&quot;</span>

        <span class="s1">arch </span><span class="s2">= </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">rsplit</span><span class="s2">(</span><span class="s3">&quot;_&quot;</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)[-</span><span class="s6">1</span><span class="s2">]</span>
        <span class="s1">output </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">output</span><span class="s2">.</span><span class="s1">isDirectory</span><span class="s2">():</span>
            <span class="s1">output </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s3">&quot;%s_%s_%s.deb&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">, </span><span class="s1">arch</span><span class="s2">))</span>
        <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Creating %s...&quot; </span><span class="s2">% </span><span class="s1">output</span><span class="s2">)</span>
        <span class="s1">modtime </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">time</span><span class="s2">.</span><span class="s1">time</span><span class="s2">())</span>

        <span class="s5"># Create a temporary directory and write the launcher and dependencies to it.</span>
        <span class="s1">tempdir</span><span class="s2">, </span><span class="s1">totsize </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__buildTempLinux</span><span class="s2">(</span><span class="s1">platform</span><span class="s2">)</span>

        <span class="s5"># Create a control file in memory.</span>
        <span class="s1">controlfile </span><span class="s2">= </span><span class="s1">BytesIO</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s6">3</span><span class="s2">, </span><span class="s6">0</span><span class="s2">):</span>
            <span class="s1">cout </span><span class="s2">= </span><span class="s1">TextIOWrapper</span><span class="s2">(</span><span class="s1">controlfile</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">'utf-8'</span><span class="s2">, </span><span class="s1">newline</span><span class="s2">=</span><span class="s3">''</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">cout </span><span class="s2">= </span><span class="s1">StringIO</span><span class="s2">()</span>

        <span class="s1">cout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;Package: %s</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">())</span>
        <span class="s1">cout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;Version: %s</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>
        <span class="s1">cout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;Maintainer: %s &lt;%s&gt;</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">authorname</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">authoremail</span><span class="s2">))</span>
        <span class="s1">cout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;Section: games</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s2">)</span>
        <span class="s1">cout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;Priority: optional</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s2">)</span>
        <span class="s1">cout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;Architecture: %s</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% </span><span class="s1">arch</span><span class="s2">)</span>
        <span class="s1">cout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;Installed-Size: %d</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% -(-</span><span class="s1">totsize </span><span class="s2">// </span><span class="s6">1024</span><span class="s2">))</span>
        <span class="s1">cout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;Description: %s</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">)</span>
        <span class="s1">cout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;Depends: libc6, libgcc1, libstdc++6, libx11-6</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s2">)</span>
        <span class="s1">cout</span><span class="s2">.</span><span class="s1">flush</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&lt; (</span><span class="s6">3</span><span class="s2">, </span><span class="s6">0</span><span class="s2">):</span>
            <span class="s1">controlfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">cout</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">().</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">'utf-8'</span><span class="s2">))</span>

        <span class="s1">controlinfo </span><span class="s2">= </span><span class="s1">TarInfoRoot</span><span class="s2">(</span><span class="s3">&quot;control&quot;</span><span class="s2">)</span>
        <span class="s1">controlinfo</span><span class="s2">.</span><span class="s1">mtime </span><span class="s2">= </span><span class="s1">modtime</span>
        <span class="s1">controlinfo</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s1">controlfile</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">()</span>
        <span class="s1">controlfile</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>

        <span class="s5"># Open the deb file and write to it. It's actually</span>
        <span class="s5"># just an AR file, which is very easy to make.</span>
        <span class="s4">if </span><span class="s1">output</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">():</span>
            <span class="s1">output</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>
        <span class="s1">debfile </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">output</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">&quot;wb&quot;</span><span class="s2">)</span>
        <span class="s1">debfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;!&lt;arch&gt;</span><span class="s4">\x0A</span><span class="s7">&quot;</span><span class="s2">)</span>
        <span class="s1">pad_mtime </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">modtime</span><span class="s2">).</span><span class="s1">encode</span><span class="s2">().</span><span class="s1">ljust</span><span class="s2">(</span><span class="s6">12</span><span class="s2">, </span><span class="s7">b' '</span><span class="s2">)</span>

        <span class="s5"># The first entry is a special file that marks it a .deb.</span>
        <span class="s1">debfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;debian-binary   &quot;</span><span class="s2">)</span>
        <span class="s1">debfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">pad_mtime</span><span class="s2">)</span>
        <span class="s1">debfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;0     0     100644  4         </span><span class="s4">\x60\x0A</span><span class="s7">&quot;</span><span class="s2">)</span>
        <span class="s1">debfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;2.0</span><span class="s4">\x0A</span><span class="s7">&quot;</span><span class="s2">)</span>

        <span class="s5"># Write the control.tar.gz to the archive.  We'll leave the</span>
        <span class="s5"># size 0 for now, and go back and fill it in later.</span>
        <span class="s1">debfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;control.tar.gz  &quot;</span><span class="s2">)</span>
        <span class="s1">debfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">pad_mtime</span><span class="s2">)</span>
        <span class="s1">debfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;0     0     100644  0         </span><span class="s4">\x60\x0A</span><span class="s7">&quot;</span><span class="s2">)</span>
        <span class="s1">ctaroffs </span><span class="s2">= </span><span class="s1">debfile</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">()</span>
        <span class="s1">ctarfile </span><span class="s2">= </span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s3">&quot;control.tar.gz&quot;</span><span class="s2">, </span><span class="s3">&quot;w:gz&quot;</span><span class="s2">, </span><span class="s1">debfile</span><span class="s2">, </span><span class="s1">tarinfo </span><span class="s2">= </span><span class="s1">TarInfoRoot</span><span class="s2">)</span>
        <span class="s1">ctarfile</span><span class="s2">.</span><span class="s1">addfile</span><span class="s2">(</span><span class="s1">controlinfo</span><span class="s2">, </span><span class="s1">controlfile</span><span class="s2">)</span>
        <span class="s1">ctarfile</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s1">ctarsize </span><span class="s2">= </span><span class="s1">debfile</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">() - </span><span class="s1">ctaroffs</span>
        <span class="s4">if </span><span class="s2">(</span><span class="s1">ctarsize </span><span class="s2">&amp; </span><span class="s6">1</span><span class="s2">): </span><span class="s1">debfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s4">\x0A</span><span class="s7">&quot;</span><span class="s2">)</span>

        <span class="s5"># Write the data.tar.gz to the archive.  Again, leave size 0.</span>
        <span class="s1">debfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;data.tar.gz     &quot;</span><span class="s2">)</span>
        <span class="s1">debfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">pad_mtime</span><span class="s2">)</span>
        <span class="s1">debfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;0     0     100644  0         </span><span class="s4">\x60\x0A</span><span class="s7">&quot;</span><span class="s2">)</span>
        <span class="s1">dtaroffs </span><span class="s2">= </span><span class="s1">debfile</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">()</span>
        <span class="s1">dtarfile </span><span class="s2">= </span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s3">&quot;data.tar.gz&quot;</span><span class="s2">, </span><span class="s3">&quot;w:gz&quot;</span><span class="s2">, </span><span class="s1">debfile</span><span class="s2">, </span><span class="s1">tarinfo </span><span class="s2">= </span><span class="s1">TarInfoRoot</span><span class="s2">)</span>
        <span class="s1">dtarfile</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">tempdir</span><span class="s2">, </span><span class="s3">&quot;usr&quot;</span><span class="s2">).</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">&quot;/usr&quot;</span><span class="s2">)</span>
        <span class="s1">dtarfile</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s1">dtarsize </span><span class="s2">= </span><span class="s1">debfile</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">() - </span><span class="s1">dtaroffs</span>
        <span class="s4">if </span><span class="s2">(</span><span class="s1">dtarsize </span><span class="s2">&amp; </span><span class="s6">1</span><span class="s2">): </span><span class="s1">debfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s4">\x0A</span><span class="s7">&quot;</span><span class="s2">)</span>

        <span class="s5"># Write the correct sizes of the archives.</span>
        <span class="s1">debfile</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">ctaroffs </span><span class="s2">- </span><span class="s6">12</span><span class="s2">)</span>
        <span class="s1">debfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">ctarsize</span><span class="s2">).</span><span class="s1">encode</span><span class="s2">().</span><span class="s1">ljust</span><span class="s2">(</span><span class="s6">10</span><span class="s2">, </span><span class="s7">b' '</span><span class="s2">))</span>
        <span class="s1">debfile</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">dtaroffs </span><span class="s2">- </span><span class="s6">12</span><span class="s2">)</span>
        <span class="s1">debfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">dtarsize</span><span class="s2">).</span><span class="s1">encode</span><span class="s2">().</span><span class="s1">ljust</span><span class="s2">(</span><span class="s6">10</span><span class="s2">, </span><span class="s7">b' '</span><span class="s2">))</span>

        <span class="s1">debfile</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s4">return </span><span class="s1">output</span>

    <span class="s4">def </span><span class="s1">buildArch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">output</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Builds an ArchLinux package and stores it in the path 
        indicated by the 'output' argument. It will be built for the 
        architecture specified by the 'arch' argument. 
        If 'output' is a directory, the deb file will be stored in it. &quot;&quot;&quot;</span>

        <span class="s1">arch </span><span class="s2">= </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">rsplit</span><span class="s2">(</span><span class="s3">&quot;_&quot;</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)[-</span><span class="s6">1</span><span class="s2">]</span>
        <span class="s4">assert </span><span class="s1">arch </span><span class="s4">in </span><span class="s2">(</span><span class="s3">&quot;i386&quot;</span><span class="s2">, </span><span class="s3">&quot;amd64&quot;</span><span class="s2">)</span>
        <span class="s1">arch </span><span class="s2">= {</span><span class="s3">&quot;i386&quot; </span><span class="s2">: </span><span class="s3">&quot;i686&quot;</span><span class="s2">, </span><span class="s3">&quot;amd64&quot; </span><span class="s2">: </span><span class="s3">&quot;x86_64&quot;</span><span class="s2">}[</span><span class="s1">arch</span><span class="s2">]</span>
        <span class="s1">pkgver </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">+ </span><span class="s3">&quot;-1&quot;</span>

        <span class="s1">output </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">output</span><span class="s2">.</span><span class="s1">isDirectory</span><span class="s2">():</span>
            <span class="s1">output </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s3">&quot;%s-%s-%s.pkg.tar.gz&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">(), </span><span class="s1">pkgver</span><span class="s2">, </span><span class="s1">arch</span><span class="s2">))</span>
        <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Creating %s...&quot; </span><span class="s2">% </span><span class="s1">output</span><span class="s2">)</span>
        <span class="s1">modtime </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">time</span><span class="s2">.</span><span class="s1">time</span><span class="s2">())</span>

        <span class="s5"># Create a temporary directory and write the launcher and dependencies to it.</span>
        <span class="s1">tempdir</span><span class="s2">, </span><span class="s1">totsize </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__buildTempLinux</span><span class="s2">(</span><span class="s1">platform</span><span class="s2">)</span>

        <span class="s5"># Create a pkginfo file in memory.</span>
        <span class="s1">pkginfo </span><span class="s2">= </span><span class="s1">BytesIO</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s6">3</span><span class="s2">, </span><span class="s6">0</span><span class="s2">):</span>
            <span class="s1">pout </span><span class="s2">= </span><span class="s1">TextIOWrapper</span><span class="s2">(</span><span class="s1">pkginfo</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">'utf-8'</span><span class="s2">, </span><span class="s1">newline</span><span class="s2">=</span><span class="s3">''</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">pout </span><span class="s2">= </span><span class="s1">StringIO</span><span class="s2">()</span>

        <span class="s1">pout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;# Generated using pdeploy</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s2">)</span>
        <span class="s1">pout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;# %s</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% </span><span class="s1">time</span><span class="s2">.</span><span class="s1">ctime</span><span class="s2">(</span><span class="s1">modtime</span><span class="s2">))</span>
        <span class="s1">pout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;pkgname = %s</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">())</span>
        <span class="s1">pout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;pkgver = %s</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% </span><span class="s1">pkgver</span><span class="s2">)</span>
        <span class="s1">pout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;pkgdesc = %s</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">)</span>
        <span class="s1">pout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;builddate = %s</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% </span><span class="s1">modtime</span><span class="s2">)</span>
        <span class="s1">pout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;packager = %s &lt;%s&gt;</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">authorname</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">authoremail</span><span class="s2">))</span>
        <span class="s1">pout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;size = %d</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% </span><span class="s1">totsize</span><span class="s2">)</span>
        <span class="s1">pout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;arch = %s</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% </span><span class="s1">arch</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">licensename </span><span class="s2">!= </span><span class="s3">&quot;&quot;</span><span class="s2">:</span>
            <span class="s1">pout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;license = %s</span><span class="s4">\n</span><span class="s3">&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">licensename</span><span class="s2">)</span>
        <span class="s1">pout</span><span class="s2">.</span><span class="s1">flush</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&lt; (</span><span class="s6">3</span><span class="s2">, </span><span class="s6">0</span><span class="s2">):</span>
            <span class="s1">pkginfo</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">pout</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">().</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">'utf-8'</span><span class="s2">))</span>

        <span class="s1">pkginfoinfo </span><span class="s2">= </span><span class="s1">TarInfoRoot</span><span class="s2">(</span><span class="s3">&quot;.PKGINFO&quot;</span><span class="s2">)</span>
        <span class="s1">pkginfoinfo</span><span class="s2">.</span><span class="s1">mtime </span><span class="s2">= </span><span class="s1">modtime</span>
        <span class="s1">pkginfoinfo</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s1">pkginfo</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">()</span>
        <span class="s1">pkginfo</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>

        <span class="s5"># Create the actual package now.</span>
        <span class="s1">pkgfile </span><span class="s2">= </span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">output</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">&quot;w:gz&quot;</span><span class="s2">, </span><span class="s1">tarinfo </span><span class="s2">= </span><span class="s1">TarInfoRoot</span><span class="s2">)</span>
        <span class="s1">pkgfile</span><span class="s2">.</span><span class="s1">addfile</span><span class="s2">(</span><span class="s1">pkginfoinfo</span><span class="s2">, </span><span class="s1">pkginfo</span><span class="s2">)</span>
        <span class="s1">pkgfile</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">tempdir</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">&quot;/&quot;</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">licensefile</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">():</span>
            <span class="s1">pkgfile</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">licensefile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">&quot;/usr/share/licenses/%s/LICENSE&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">())</span>
        <span class="s1">pkgfile</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s4">return </span><span class="s1">output</span>

    <span class="s4">def </span><span class="s1">buildAPP</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">output</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">):</span>

        <span class="s1">output </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">output</span><span class="s2">.</span><span class="s1">isDirectory</span><span class="s2">() </span><span class="s4">and </span><span class="s1">output</span><span class="s2">.</span><span class="s1">getExtension</span><span class="s2">() != </span><span class="s3">'app'</span><span class="s2">:</span>
            <span class="s1">output </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s3">&quot;%s.app&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">)</span>
        <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Creating %s...&quot; </span><span class="s2">% </span><span class="s1">output</span><span class="s2">)</span>

        <span class="s5"># Create the executable for the application bundle</span>
        <span class="s1">exefile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s3">&quot;Contents/MacOS/&quot; </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">)</span>
        <span class="s1">exefile</span><span class="s2">.</span><span class="s1">makeDir</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">includeRequires</span><span class="s2">:</span>
            <span class="s1">extraTokens </span><span class="s2">= {</span><span class="s3">&quot;host_dir&quot;</span><span class="s2">: </span><span class="s3">&quot;../Resources&quot;</span><span class="s2">, </span><span class="s3">&quot;start_dir&quot;</span><span class="s2">: </span><span class="s3">&quot;../Resources&quot;</span><span class="s2">}</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">extraTokens </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">standalone</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">exefile</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">, </span><span class="s1">extraTokens</span><span class="s2">)</span>
        <span class="s1">hostDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s3">&quot;Contents/Resources/&quot;</span><span class="s2">)</span>
        <span class="s1">hostDir</span><span class="s2">.</span><span class="s1">makeDir</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">installPackagesInto</span><span class="s2">(</span><span class="s1">hostDir</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">)</span>

        <span class="s1">hasIcon </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">icon </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Generating %s.icns...&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">)</span>
            <span class="s1">hasIcon </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">icon</span><span class="s2">.</span><span class="s1">makeICNS</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">hostDir</span><span class="s2">, </span><span class="s3">&quot;%s.icns&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">))</span>

        <span class="s5"># Create the application plist file using Python's plistlib module.</span>
        <span class="s1">plist </span><span class="s2">= {</span>
            <span class="s3">'CFBundleDevelopmentRegion'</span><span class="s2">: </span><span class="s3">'English'</span><span class="s2">,</span>
            <span class="s3">'CFBundleDisplayName'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">,</span>
            <span class="s3">'CFBundleExecutable'</span><span class="s2">: </span><span class="s1">exefile</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">(),</span>
            <span class="s3">'CFBundleIdentifier'</span><span class="s2">: </span><span class="s3">'%s.%s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">author</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">),</span>
            <span class="s3">'CFBundleInfoDictionaryVersion'</span><span class="s2">: </span><span class="s3">'6.0'</span><span class="s2">,</span>
            <span class="s3">'CFBundleName'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">,</span>
            <span class="s3">'CFBundlePackageType'</span><span class="s2">: </span><span class="s3">'APPL'</span><span class="s2">,</span>
            <span class="s3">'CFBundleShortVersionString'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">,</span>
            <span class="s3">'CFBundleVersion'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">,</span>
            <span class="s3">'LSHasLocalizedDisplayName'</span><span class="s2">: </span><span class="s4">False</span><span class="s2">,</span>
            <span class="s3">'NSAppleScriptEnabled'</span><span class="s2">: </span><span class="s4">False</span><span class="s2">,</span>
            <span class="s3">'NSPrincipalClass'</span><span class="s2">: </span><span class="s3">'NSApplication'</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s4">if </span><span class="s1">hasIcon</span><span class="s2">:</span>
            <span class="s1">plist</span><span class="s2">[</span><span class="s3">'CFBundleIconFile'</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname </span><span class="s2">+ </span><span class="s3">'.icns'</span>

        <span class="s1">plistlib</span><span class="s2">.</span><span class="s1">writePlist</span><span class="s2">(</span><span class="s1">plist</span><span class="s2">, </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s3">&quot;Contents/Info.plist&quot;</span><span class="s2">).</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s4">return </span><span class="s1">output</span>

    <span class="s4">def </span><span class="s1">buildPKG</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">output</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">):</span>
        <span class="s1">appfn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buildAPP</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">)</span>
        <span class="s1">appname </span><span class="s2">= </span><span class="s3">&quot;/Applications/&quot; </span><span class="s2">+ </span><span class="s1">appfn</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">()</span>
        <span class="s1">output </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">output</span><span class="s2">.</span><span class="s1">isDirectory</span><span class="s2">():</span>
            <span class="s1">output </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s3">&quot;%s %s.pkg&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">))</span>
        <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Creating %s...&quot; </span><span class="s2">% </span><span class="s1">output</span><span class="s2">)</span>

        <span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s3">&quot;Contents/Resources/en.lproj/&quot;</span><span class="s2">).</span><span class="s1">makeDir</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">licensefile</span><span class="s2">:</span>
            <span class="s1">shutil</span><span class="s2">.</span><span class="s1">copyfile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">licensefile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s3">&quot;Contents/Resources/License.txt&quot;</span><span class="s2">).</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s1">pkginfo </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s3">&quot;Contents/PkgInfo&quot;</span><span class="s2">).</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">&quot;w&quot;</span><span class="s2">)</span>
        <span class="s1">pkginfo</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;pmkrpkg1&quot;</span><span class="s2">)</span>
        <span class="s1">pkginfo</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s1">pkginfo </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s3">&quot;Contents/Resources/package_version&quot;</span><span class="s2">).</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">&quot;w&quot;</span><span class="s2">)</span>
        <span class="s1">pkginfo</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;major: 1</span><span class="s4">\n</span><span class="s3">minor: 9&quot;</span><span class="s2">)</span>
        <span class="s1">pkginfo</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s5"># Although it might make more sense to use Python's plistlib here,</span>
        <span class="s5"># it is not available on non-OSX systems before Python 2.6.</span>
        <span class="s1">plist </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s3">&quot;Contents/Info.plist&quot;</span><span class="s2">).</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">&quot;w&quot;</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;plist version=&quot;1.0&quot;&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;dict&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;CFBundleIdentifier&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;string&gt;%s.pkg.%s&lt;/string&gt;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">authorid</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">))</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;CFBundleShortVersionString&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;string&gt;%s&lt;/string&gt;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;IFMajorVersion&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;integer&gt;1&lt;/integer&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;IFMinorVersion&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;integer&gt;9&lt;/integer&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;IFPkgFlagAllowBackRev&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;false/&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;IFPkgFlagAuthorizationAction&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;string&gt;RootAuthorization&lt;/string&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;IFPkgFlagDefaultLocation&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;string&gt;/&lt;/string&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;IFPkgFlagFollowLinks&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;true/&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;IFPkgFlagIsRequired&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;false/&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;IFPkgFlagOverwritePermissions&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;false/&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;IFPkgFlagRelocatable&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;false/&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;IFPkgFlagRestartAction&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;string&gt;None&lt;/string&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;IFPkgFlagRootVolumeOnly&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;true/&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;IFPkgFlagUpdateInstalledLanguages&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;false/&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;IFPkgFormatVersion&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;real&gt;0.10000000149011612&lt;/real&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;IFPkgPathMappings&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;dict&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t\t</span><span class="s3">&lt;key&gt;%s&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">appname</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t\t</span><span class="s3">&lt;string&gt;{pkmk-token-2}&lt;/string&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;/dict&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;/dict&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;/plist&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s1">plist </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s3">&quot;Contents/Resources/TokenDefinitions.plist&quot;</span><span class="s2">).</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">&quot;w&quot;</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;plist version=&quot;1.0&quot;&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;dict&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;pkmk-token-2&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;array&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t\t</span><span class="s3">&lt;dict&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t\t\t</span><span class="s3">&lt;key&gt;identifier&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t\t\t</span><span class="s3">&lt;string&gt;%s.%s&lt;/string&gt;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">authorid</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">))</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t\t\t</span><span class="s3">&lt;key&gt;path&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t\t\t</span><span class="s3">&lt;string&gt;%s&lt;/string&gt;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">appname</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t\t\t</span><span class="s3">&lt;key&gt;searchPlugin&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t\t\t</span><span class="s3">&lt;string&gt;CommonAppSearch&lt;/string&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t\t</span><span class="s3">&lt;/dict&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;/array&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;/dict&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;/plist&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s1">plist </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s3">&quot;Contents/Resources/en.lproj/Description.plist&quot;</span><span class="s2">).</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">&quot;w&quot;</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;plist version=&quot;1.0&quot;&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;dict&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;IFPkgDescriptionDescription&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;string&gt;&lt;/string&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;key&gt;IFPkgDescriptionTitle&lt;/key&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">&lt;string&gt;%s&lt;/string&gt;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;/dict&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'&lt;/plist&gt;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">plist</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s5"># OS X El Capitan no longer accepts .pax archives - it must be a CPIO archive named .pax.</span>
        <span class="s1">archive </span><span class="s2">= </span><span class="s1">gzip</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s3">&quot;Contents/Archive.pax.gz&quot;</span><span class="s2">).</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">'wb'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__ino </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__writeCPIO</span><span class="s2">(</span><span class="s1">archive</span><span class="s2">, </span><span class="s1">appfn</span><span class="s2">, </span><span class="s1">appname</span><span class="s2">)</span>
        <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;0707070000000000000000000000000000000000010000000000000000000001300000000000TRAILER!!!</span><span class="s4">\0</span><span class="s7">&quot;</span><span class="s2">)</span>
        <span class="s1">archive</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s5"># Put the .pkg into a zipfile</span>
        <span class="s1">zip_fn </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">.</span><span class="s1">getDirname</span><span class="s2">(), </span><span class="s3">&quot;%s %s.pkg.zip&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">))</span>
        <span class="s1">dir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">.</span><span class="s1">getDirname</span><span class="s2">())</span>
        <span class="s1">dir</span><span class="s2">.</span><span class="s1">makeAbsolute</span><span class="s2">()</span>
        <span class="s1">zip </span><span class="s2">= </span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s1">zip_fn</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">'w'</span><span class="s2">)</span>
        <span class="s4">for </span><span class="s1">root</span><span class="s2">, </span><span class="s1">dirs</span><span class="s2">, </span><span class="s1">files </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">os_walk</span><span class="s2">(</span><span class="s1">output</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()):</span>
            <span class="s4">for </span><span class="s1">name </span><span class="s4">in </span><span class="s1">files</span><span class="s2">:</span>
                <span class="s1">file </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">root</span><span class="s2">, </span><span class="s1">name</span><span class="s2">))</span>
                <span class="s1">file</span><span class="s2">.</span><span class="s1">makeAbsolute</span><span class="s2">()</span>
                <span class="s1">file</span><span class="s2">.</span><span class="s1">makeRelativeTo</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">)</span>
                <span class="s1">zip</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">root</span><span class="s2">, </span><span class="s1">name</span><span class="s2">), </span><span class="s1">str</span><span class="s2">(</span><span class="s1">file</span><span class="s2">))</span>
        <span class="s1">zip</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s4">return </span><span class="s1">output</span>

    <span class="s4">def </span><span class="s1">__writeCPIO</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">archive</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Adds the given fn under the given name to the CPIO archive. &quot;&quot;&quot;</span>

        <span class="s1">st </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">lstat</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>

        <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;070707&quot;</span><span class="s2">) </span><span class="s5"># magic</span>
        <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;000000&quot;</span><span class="s2">) </span><span class="s5"># dev</span>

        <span class="s5"># Synthesize an inode number, different for each entry.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__ino </span><span class="s2">+= </span><span class="s6">1</span>
        <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;%06o&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__ino</span><span class="s2">))</span>

        <span class="s5"># Determine based on the type which mode to write.</span>
        <span class="s4">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">islink</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()):</span>
            <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;%06o&quot; </span><span class="s2">% (</span><span class="s1">st</span><span class="s2">.</span><span class="s1">st_mode</span><span class="s2">))</span>
            <span class="s1">target </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">readlink</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()).</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">'utf-8'</span><span class="s2">)</span>
            <span class="s1">size </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">target</span><span class="s2">)</span>
        <span class="s4">elif </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()):</span>
            <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;040755&quot;</span><span class="s2">)</span>
            <span class="s1">size </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s4">elif not </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">getExtension</span><span class="s2">():  </span><span class="s5"># Binary file?</span>
            <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;100755&quot;</span><span class="s2">)</span>
            <span class="s1">size </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">st_size</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;100644&quot;</span><span class="s2">)</span>
            <span class="s1">size </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">st_size</span>

        <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;000000&quot;</span><span class="s2">) </span><span class="s5"># uid (root)</span>
        <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;000000&quot;</span><span class="s2">) </span><span class="s5"># gid (wheel)</span>
        <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;%06o&quot; </span><span class="s2">% (</span><span class="s1">st</span><span class="s2">.</span><span class="s1">st_nlink</span><span class="s2">))</span>
        <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;000000&quot;</span><span class="s2">) </span><span class="s5"># rdev</span>
        <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;%011o&quot; </span><span class="s2">% (</span><span class="s1">st</span><span class="s2">.</span><span class="s1">st_mtime</span><span class="s2">))</span>
        <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;%06o&quot; </span><span class="s2">% (</span><span class="s1">len</span><span class="s2">(</span><span class="s1">name</span><span class="s2">) + </span><span class="s6">1</span><span class="s2">))</span>
        <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;%011o&quot; </span><span class="s2">% (</span><span class="s1">size</span><span class="s2">))</span>

        <span class="s5"># Write the filename, plus terminating NUL byte.</span>
        <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">name</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">'utf-8'</span><span class="s2">))</span>
        <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s4">\0</span><span class="s7">&quot;</span><span class="s2">)</span>

        <span class="s5"># Copy the file data to the archive.</span>
        <span class="s4">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">islink</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()):</span>
            <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">target</span><span class="s2">)</span>
        <span class="s4">elif </span><span class="s1">size</span><span class="s2">:</span>
            <span class="s1">handle </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">'rb'</span><span class="s2">)</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">handle</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s6">1024 </span><span class="s2">* </span><span class="s6">1024</span><span class="s2">)</span>
            <span class="s4">while </span><span class="s1">data</span><span class="s2">:</span>
                <span class="s1">archive</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
                <span class="s1">data </span><span class="s2">= </span><span class="s1">handle</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s6">1024 </span><span class="s2">* </span><span class="s6">1024</span><span class="s2">)</span>
            <span class="s1">handle</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s5"># If this is a directory, recurse.</span>
        <span class="s4">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()):</span>
            <span class="s4">for </span><span class="s1">child </span><span class="s4">in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">listdir</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__writeCPIO</span><span class="s2">(</span><span class="s1">archive</span><span class="s2">, </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">child</span><span class="s2">), </span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;/&quot; </span><span class="s2">+ </span><span class="s1">child</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">buildNSIS</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">output</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">):</span>
        <span class="s5"># Check if we have makensis first</span>
        <span class="s1">makensis </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">if </span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;win&quot;</span><span class="s2">)):</span>
            <span class="s1">syspath </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">defpath</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;;&quot;</span><span class="s2">) + </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">[</span><span class="s3">&quot;PATH&quot;</span><span class="s2">].</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;;&quot;</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">p </span><span class="s4">in </span><span class="s1">set</span><span class="s2">(</span><span class="s1">syspath</span><span class="s2">):</span>
                <span class="s1">p1 </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s3">&quot;makensis.exe&quot;</span><span class="s2">)</span>
                <span class="s1">p2 </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">p</span><span class="s2">), </span><span class="s3">&quot;nsis&quot;</span><span class="s2">, </span><span class="s3">&quot;makensis.exe&quot;</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">p1</span><span class="s2">):</span>
                    <span class="s1">makensis </span><span class="s2">= </span><span class="s1">p1</span>
                    <span class="s4">break</span>
                <span class="s4">elif </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">p2</span><span class="s2">):</span>
                    <span class="s1">makensis </span><span class="s2">= </span><span class="s1">p2</span>
                    <span class="s4">break</span>
            <span class="s4">if not </span><span class="s1">makensis</span><span class="s2">:</span>
                <span class="s4">import </span><span class="s1">pandac</span>
                <span class="s1">makensis </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">pandac</span><span class="s2">.</span><span class="s1">__file__</span><span class="s2">))</span>
                <span class="s1">makensis </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">makensis</span><span class="s2">, </span><span class="s3">&quot;nsis&quot;</span><span class="s2">, </span><span class="s3">&quot;makensis.exe&quot;</span><span class="s2">)</span>
                <span class="s4">if not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">makensis</span><span class="s2">): </span><span class="s1">makensis </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">for </span><span class="s1">p </span><span class="s4">in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">defpath</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;:&quot;</span><span class="s2">) + </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">[</span><span class="s3">&quot;PATH&quot;</span><span class="s2">].</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;:&quot;</span><span class="s2">):</span>
                <span class="s4">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s3">&quot;makensis&quot;</span><span class="s2">)):</span>
                    <span class="s1">makensis </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s3">&quot;makensis&quot;</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">makensis </span><span class="s2">== </span><span class="s4">None</span><span class="s2">:</span>
            <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Makensis utility not found, no Windows installer will be built!&quot;</span><span class="s2">)</span>
            <span class="s4">return None</span>

        <span class="s1">output </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">output</span><span class="s2">.</span><span class="s1">isDirectory</span><span class="s2">():</span>
            <span class="s1">output </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s3">&quot;%s %s.exe&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">))</span>
        <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Creating %s...&quot; </span><span class="s2">% </span><span class="s1">output</span><span class="s2">)</span>
        <span class="s1">output</span><span class="s2">.</span><span class="s1">makeAbsolute</span><span class="s2">()</span>
        <span class="s1">extrafiles </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">standalone</span><span class="s2">.</span><span class="s1">getExtraFiles</span><span class="s2">(</span><span class="s1">platform</span><span class="s2">)</span>

        <span class="s1">exefile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">getTempDirectory</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname </span><span class="s2">+ </span><span class="s3">&quot;.exe&quot;</span><span class="s2">)</span>
        <span class="s1">exefile</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">includeRequires</span><span class="s2">:</span>
            <span class="s1">extraTokens </span><span class="s2">= {</span><span class="s3">&quot;host_dir&quot;</span><span class="s2">: </span><span class="s3">&quot;.&quot;</span><span class="s2">, </span><span class="s3">&quot;start_dir&quot;</span><span class="s2">: </span><span class="s3">&quot;.&quot;</span><span class="s2">}</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">extraTokens </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">standalone</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">exefile</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">, </span><span class="s1">extraTokens</span><span class="s2">)</span>

        <span class="s5"># Temporary directory to store the hostdir in</span>
        <span class="s1">hostDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tempDir</span><span class="s2">, </span><span class="s1">platform </span><span class="s2">+ </span><span class="s3">&quot;/&quot;</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">hostDir</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">():</span>
            <span class="s1">hostDir</span><span class="s2">.</span><span class="s1">makeDir</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">installPackagesInto</span><span class="s2">(</span><span class="s1">hostDir</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">)</span>

        <span class="s5"># See if we can generate an icon</span>
        <span class="s1">icofile </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">icon </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">icofile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">getTempDirectory</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname </span><span class="s2">+ </span><span class="s3">&quot;.ico&quot;</span><span class="s2">)</span>
            <span class="s1">icofile</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>
            <span class="s1">Installer</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Generating %s.ico...&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">)</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">icon</span><span class="s2">.</span><span class="s1">makeICO</span><span class="s2">(</span><span class="s1">icofile</span><span class="s2">):</span>
                <span class="s1">icofile </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s5"># Create the .nsi installer script</span>
        <span class="s1">nsifile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">getTempDirectory</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname </span><span class="s2">+ </span><span class="s3">&quot;.nsi&quot;</span><span class="s2">)</span>
        <span class="s1">nsifile</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>
        <span class="s1">nsi </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">nsifile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">&quot;w&quot;</span><span class="s2">)</span>

        <span class="s5"># Some global info</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'Name &quot;%s&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'OutFile &quot;%s&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">output</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s4">if </span><span class="s1">platform </span><span class="s2">== </span><span class="s3">'win_amd64'</span><span class="s2">:</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'InstallDir &quot;$PROGRAMFILES64</span><span class="s4">\\</span><span class="s3">%s&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'InstallDir &quot;$PROGRAMFILES</span><span class="s4">\\</span><span class="s3">%s&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'SetCompress auto</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'SetCompressor lzma</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'ShowInstDetails nevershow</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'ShowUninstDetails nevershow</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'InstType &quot;Typical&quot;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>

        <span class="s5"># Tell Vista that we require admin rights</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'RequestExecutionLevel admin</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">offerRun</span><span class="s2">:</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'Function launch</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  ExecShell &quot;open&quot; &quot;$INSTDIR</span><span class="s4">\\</span><span class="s3">%s.exe&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">)</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'FunctionEnd</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">offerDesktopShortcut</span><span class="s2">:</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'Function desktopshortcut</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">icofile </span><span class="s4">is None</span><span class="s2">:</span>
                <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  CreateShortcut &quot;$DESKTOP</span><span class="s4">\\</span><span class="s3">%s.lnk&quot; &quot;$INSTDIR</span><span class="s4">\\</span><span class="s3">%s.exe&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">))</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  CreateShortcut &quot;$DESKTOP</span><span class="s4">\\</span><span class="s3">%s.lnk&quot; &quot;$INSTDIR</span><span class="s4">\\</span><span class="s3">%s.exe&quot; &quot;&quot; &quot;$INSTDIR</span><span class="s4">\\</span><span class="s3">%s.ico&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">))</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'FunctionEnd</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>

        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!include &quot;MUI2.nsh&quot;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!define MUI_ABORTWARNING</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">offerRun</span><span class="s2">:</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!define MUI_FINISHPAGE_RUN</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!define MUI_FINISHPAGE_RUN_NOTCHECKED</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!define MUI_FINISHPAGE_RUN_FUNCTION launch</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!define MUI_FINISHPAGE_RUN_TEXT &quot;Run %s&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">offerDesktopShortcut</span><span class="s2">:</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!define MUI_FINISHPAGE_SHOWREADME &quot;&quot;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!define MUI_FINISHPAGE_SHOWREADME_NOTCHECKED</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!define MUI_FINISHPAGE_SHOWREADME_TEXT &quot;Create Desktop Shortcut&quot;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!define MUI_FINISHPAGE_SHOWREADME_FUNCTION desktopshortcut</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'Var StartMenuFolder</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!insertmacro MUI_PAGE_WELCOME</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">licensefile</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">():</span>
            <span class="s1">abs </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">licensefile</span><span class="s2">)</span>
            <span class="s1">abs</span><span class="s2">.</span><span class="s1">makeAbsolute</span><span class="s2">()</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!insertmacro MUI_PAGE_LICENSE &quot;%s&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">abs</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!insertmacro MUI_PAGE_DIRECTORY</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!insertmacro MUI_PAGE_STARTMENU Application $StartMenuFolder</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!insertmacro MUI_PAGE_INSTFILES</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!insertmacro MUI_PAGE_FINISH</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!insertmacro MUI_UNPAGE_WELCOME</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!insertmacro MUI_UNPAGE_CONFIRM</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!insertmacro MUI_UNPAGE_INSTFILES</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!insertmacro MUI_UNPAGE_FINISH</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'!insertmacro MUI_LANGUAGE &quot;English&quot;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>

        <span class="s5"># This section defines the installer.</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'Section &quot;&quot; SecCore</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  SetOutPath &quot;$INSTDIR&quot;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  File &quot;%s&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">exefile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s4">if </span><span class="s1">icofile </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  File &quot;%s&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">icofile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s4">for </span><span class="s1">f </span><span class="s4">in </span><span class="s1">extrafiles</span><span class="s2">:</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  File &quot;%s&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">f</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s1">curdir </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
        <span class="s4">for </span><span class="s1">root</span><span class="s2">, </span><span class="s1">dirs</span><span class="s2">, </span><span class="s1">files </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">os_walk</span><span class="s2">(</span><span class="s1">hostDir</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()):</span>
            <span class="s4">for </span><span class="s1">name </span><span class="s4">in </span><span class="s1">files</span><span class="s2">:</span>
                <span class="s1">basefile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">root</span><span class="s2">, </span><span class="s1">name</span><span class="s2">))</span>
                <span class="s1">file </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">basefile</span><span class="s2">)</span>
                <span class="s1">file</span><span class="s2">.</span><span class="s1">makeAbsolute</span><span class="s2">()</span>
                <span class="s1">file</span><span class="s2">.</span><span class="s1">makeRelativeTo</span><span class="s2">(</span><span class="s1">hostDir</span><span class="s2">)</span>
                <span class="s1">outdir </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">getDirname</span><span class="s2">().</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">, </span><span class="s3">'</span><span class="s4">\\</span><span class="s3">'</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">curdir </span><span class="s2">!= </span><span class="s1">outdir</span><span class="s2">:</span>
                    <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  SetOutPath &quot;$INSTDIR</span><span class="s4">\\</span><span class="s3">%s&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">outdir</span><span class="s2">)</span>
                    <span class="s1">curdir </span><span class="s2">= </span><span class="s1">outdir</span>
                <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  File &quot;%s&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% (</span><span class="s1">basefile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()))</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  SetOutPath &quot;$INSTDIR&quot;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  WriteUninstaller &quot;$INSTDIR</span><span class="s4">\\</span><span class="s3">Uninstall.exe&quot;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  ; Start menu items</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  !insertmacro MUI_STARTMENU_WRITE_BEGIN Application</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'    CreateDirectory &quot;$SMPROGRAMS</span><span class="s4">\\</span><span class="s3">$StartMenuFolder&quot;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">icofile </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'    CreateShortCut &quot;$SMPROGRAMS</span><span class="s4">\\</span><span class="s3">$StartMenuFolder</span><span class="s4">\\</span><span class="s3">%s.lnk&quot; &quot;$INSTDIR</span><span class="s4">\\</span><span class="s3">%s.exe&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">))</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'    CreateShortCut &quot;$SMPROGRAMS</span><span class="s4">\\</span><span class="s3">$StartMenuFolder</span><span class="s4">\\</span><span class="s3">%s.lnk&quot; &quot;$INSTDIR</span><span class="s4">\\</span><span class="s3">%s.exe&quot; &quot;&quot; &quot;$INSTDIR</span><span class="s4">\\</span><span class="s3">%s.ico&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">))</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'    CreateShortCut &quot;$SMPROGRAMS</span><span class="s4">\\</span><span class="s3">$StartMenuFolder</span><span class="s4">\\</span><span class="s3">Uninstall.lnk&quot; &quot;$INSTDIR</span><span class="s4">\\</span><span class="s3">Uninstall.exe&quot;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  !insertmacro MUI_STARTMENU_WRITE_END</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'SectionEnd</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>

        <span class="s5"># This section defines the uninstaller.</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'Section Uninstall</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  Delete &quot;$INSTDIR</span><span class="s4">\\</span><span class="s3">%s.exe&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">icofile </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  Delete &quot;$INSTDIR</span><span class="s4">\\</span><span class="s3">%s.ico&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortname</span><span class="s2">)</span>
        <span class="s4">for </span><span class="s1">f </span><span class="s4">in </span><span class="s1">extrafiles</span><span class="s2">:</span>
            <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  Delete &quot;%s&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">f</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">())</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  Delete &quot;$INSTDIR</span><span class="s4">\\</span><span class="s3">Uninstall.exe&quot;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  RMDir /r &quot;$INSTDIR&quot;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  ; Desktop icon</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  Delete &quot;$DESKTOP</span><span class="s4">\\</span><span class="s3">%s.lnk&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  ; Start menu items</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  !insertmacro MUI_STARTMENU_GETFOLDER Application $StartMenuFolder</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  Delete &quot;$SMPROGRAMS</span><span class="s4">\\</span><span class="s3">$StartMenuFolder</span><span class="s4">\\</span><span class="s3">%s.lnk&quot;</span><span class="s4">\n</span><span class="s3">' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullname</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  Delete &quot;$SMPROGRAMS</span><span class="s4">\\</span><span class="s3">$StartMenuFolder</span><span class="s4">\\</span><span class="s3">Uninstall.lnk&quot;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'  RMDir &quot;$SMPROGRAMS</span><span class="s4">\\</span><span class="s3">$StartMenuFolder&quot;</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'SectionEnd</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">nsi</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s1">cmd </span><span class="s2">= [</span><span class="s1">makensis</span><span class="s2">]</span>
        <span class="s4">for </span><span class="s1">o </span><span class="s4">in </span><span class="s2">[</span><span class="s3">&quot;V2&quot;</span><span class="s2">]:</span>
            <span class="s4">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;win&quot;</span><span class="s2">):</span>
                <span class="s1">cmd</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;/&quot; </span><span class="s2">+ </span><span class="s1">o</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">cmd</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;-&quot; </span><span class="s2">+ </span><span class="s1">o</span><span class="s2">)</span>
        <span class="s1">cmd</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">nsifile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">)</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">retcode </span><span class="s2">= </span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">shell </span><span class="s2">= </span><span class="s4">False</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">retcode </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Failure invoking NSIS command.&quot;</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">nsifile</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>
        <span class="s4">except </span><span class="s1">OSError</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Unable to invoke NSIS command.&quot;</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">icofile </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">icofile</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>

        <span class="s4">return </span><span class="s1">output</span>

    <span class="s4">def </span><span class="s1">os_walk</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">top</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Re-implements os.walk().  For some reason the built-in 
        definition is failing on Windows when this is run within a p3d 
        environment!? &quot;&quot;&quot;</span>

        <span class="s1">dirnames </span><span class="s2">= []</span>
        <span class="s1">filenames </span><span class="s2">= []</span>

        <span class="s1">dirlist </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">listdir</span><span class="s2">(</span><span class="s1">top</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">dirlist</span><span class="s2">:</span>
            <span class="s4">for </span><span class="s1">file </span><span class="s4">in </span><span class="s1">dirlist</span><span class="s2">:</span>
                <span class="s1">path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">top</span><span class="s2">, </span><span class="s1">file</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
                    <span class="s1">dirnames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">filenames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>

        <span class="s4">yield </span><span class="s2">(</span><span class="s1">top</span><span class="s2">, </span><span class="s1">dirnames</span><span class="s2">, </span><span class="s1">filenames</span><span class="s2">)</span>

        <span class="s4">for </span><span class="s1">dir </span><span class="s4">in </span><span class="s1">dirnames</span><span class="s2">:</span>
            <span class="s1">next </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">top</span><span class="s2">, </span><span class="s1">dir</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">tuple </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">os_walk</span><span class="s2">(</span><span class="s1">next</span><span class="s2">):</span>
                <span class="s4">yield </span><span class="s1">tuple</span>
</pre>
</body>
</html>