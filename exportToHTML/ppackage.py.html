<html>
<head>
<title>ppackage.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ppackage.py</font>
</center></td></tr></table>
<pre><span class="s0">#! /usr/bin/env python</span>

<span class="s1">usageText </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
This script can be used to produce a Panda3D downloadable &quot;package&quot;, 
which may contain arbitrary files--for instance, Python code, bam 
files, and/or compiled DLL's--and which may be downloaded by 
application code to extend an application at runtime. 
 
In addition to packages, this script can also be used to build 
standalone p3d applications, that is, packaged Python code in a p3d 
file, for execution by the Panda3D plugin or runtime.  (But also see 
packp3d, which is designed to be a simpler interface for building 
applications.) 
 
This command will build p3d files that reference Panda3D %(version)s, 
from host %(host)s . 
 
This script is actually a wrapper around Panda's Packager.py, which 
can be invoked directly by Python code that requires a programmatic 
interface to building packages. 
 
Usage: 
 
  %(prog)s [opts] package.pdef [packageName1 .. packageNameN] 
 
Parameters: 
 
  package.pdef 
    The config file that describes the contents of the package file(s) 
    to be built, in excruciating detail.  See the Panda3D manual for 
    the syntax of this file. 
 
  packageName1 .. packageNameN 
    Specify the names of the package(s) you wish to build out of the 
    package.pdef file.  This allows you to build only a subset of the 
    packages defined in this file.  If you omit these parameters, all 
    packages are built, and packages that cannot be built are silently 
    ignored. 
 
Options: 
 
  -i install_dir 
     The full path to a local directory to copy the 
     ready-to-be-published files into.  This directory structure may 
     contain multiple different packages from multiple different 
     invocations of this script.  It is the user's responsibility to 
     copy this directory structure to a server, which will have the 
     URL specified by the packager.setHost() call appearing within the 
     pdef file. 
 
  -p 
     Automatically build patches against previous versions after 
     generating the results.  Patches are difference files that users 
     can download when updating a package, in lieu of redownloading 
     the whole package; this happens automatically if patches are 
     present.  You should generally build patches when you are 
     committing to a final, public-facing release.  Patches are 
     usually a good idea, but generating a patch for each internal 
     test build may needlessly generate a lot of small, inefficient 
     patch files instead of a few larger ones.  You can also generate 
     patches after the fact, by running ppatcher on the install 
     directory. 
 
  -s search_dir 
     Additional directories to search for previously-built packages. 
     This option may be repeated as necessary.  These directories may 
     also be specified with the pdef-path Config.prc variable. 
 
  -S file.crt[,chain.crt[,file.key[,</span><span class="s4">\&quot;</span><span class="s3">password</span><span class="s4">\&quot;</span><span class="s3">]]] 
     Signs any resulting p3d file(s) with the indicated certificate. 
     You may specify the signing certificate, the optional 
     authorization chain, and the private key in three different 
     files, or they may all be combined in the first file.  If the 
     private key is encrypted, the password will be required to 
     decrypt it. 
 
  -D 
     Sets the allow_python_dev flag in any applications built with 
     this command.  This enables additional runtime debug operations, 
     particularly the -i option to the panda3d command, which enables 
     a live Python prompt within the application's environment. 
     Setting this flag may be useful to develop an application 
     initially, but should not be set on an application intended for 
     deployment. 
 
  -N 
     If this option is set, Packager will not try to compile any Python 
     files to .pyc or .pyo, instead storing the original source files. 
 
  -u 
     On the Mac OSX platform, this means that Panda was built with 
     universal binaries, and the package should be built that way as 
     well (that is, a version of the the package should be created for 
     each supported architecture).  On other platforms, this option 
     does nothing.  This is therefore safe to apply in all cases, if 
     you wish to take advantage of universal binaries.  This is 
     equivalent to &quot;-P osx_i386 -P osx_amd64&quot; on Mac platforms. 
 
  -P platform 
     Specify the platform to masquerade as.  The default is whatever 
     platform Panda has been built for.  You can use this on Mac OSX 
     in order to build packages for an alternate architecture if you 
     have built Panda with universal binaries; you may repeat this 
     option for each architecture you wish to support.  For other 
     platforms, it is probably a mistake to set this.  However, see 
     the option -u. 
 
  -R sysroot 
     Specify the sysroot that these files were compiled against.  This 
     will shadow the system shared libraries, so that alternate 
     versions are used instead of the system versions.  If any program 
     references a library, say /usr/lib/libfoo.so, and 
     /sysroot/usr/lib/libfoo.so exists instead, that file will be used 
     instead of the system library.  This is particularly useful for 
     cross-compilation.  At the moment, this is supported only on OSX. 
 
  -H 
     Treats a packager.setHost() call in the pdef file as if it were 
     merely a call to packager.addHost().  This allows producing a 
     package for an alternate host than its normally configured host, 
     which is sometimes useful in development. 
 
  -a suffix 
     Appends the given suffix to the p3d filename, before the extension. 
     This is useful when the same packages are compiled several times 
     but using different settings, and you want to mark those packages 
     as such.  This only applies to .p3d packages, not to other types 
     of packages! 
 
  -v 
     Emit a warning for any file not recognized by the dir() command 
     (indicating there may be a need for addExtensions(...)). 
 
  -h 
     Display this help 
&quot;&quot;&quot;</span>

<span class="s4">import </span><span class="s1">sys</span>
<span class="s4">import </span><span class="s1">getopt</span>
<span class="s4">import </span><span class="s1">os</span>

<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">p3d </span><span class="s4">import </span><span class="s1">Packager</span>
<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s2">*</span>

<span class="s4">def </span><span class="s1">usage</span><span class="s2">(</span><span class="s1">code</span><span class="s2">, </span><span class="s1">msg </span><span class="s2">= </span><span class="s3">''</span><span class="s2">):</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">stderr</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">usageText </span><span class="s2">% {</span>
        <span class="s3">'version' </span><span class="s2">: </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageVersionString</span><span class="s2">(),</span>
        <span class="s3">'host' </span><span class="s2">: </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageHostUrl</span><span class="s2">(),</span>
        <span class="s3">'prog' </span><span class="s2">: </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])[</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s2">})</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">stderr</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">msg </span><span class="s2">+ </span><span class="s3">'</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s1">code</span><span class="s2">)</span>

<span class="s1">installDir </span><span class="s2">= </span><span class="s4">None</span>
<span class="s1">buildPatches </span><span class="s2">= </span><span class="s4">False</span>
<span class="s1">installSearch </span><span class="s2">= []</span>
<span class="s1">signParams </span><span class="s2">= []</span>
<span class="s1">allowPythonDev </span><span class="s2">= </span><span class="s4">False</span>
<span class="s1">storePythonSource </span><span class="s2">= </span><span class="s4">False</span>
<span class="s1">universalBinaries </span><span class="s2">= </span><span class="s4">False</span>
<span class="s1">systemRoot </span><span class="s2">= </span><span class="s4">None</span>
<span class="s1">ignoreSetHost </span><span class="s2">= </span><span class="s4">False</span>
<span class="s1">verbosePrint </span><span class="s2">= </span><span class="s4">False</span>
<span class="s1">p3dSuffix </span><span class="s2">= </span><span class="s3">''</span>
<span class="s1">platforms </span><span class="s2">= []</span>

<span class="s4">try</span><span class="s2">:</span>
    <span class="s1">opts</span><span class="s2">, </span><span class="s1">args </span><span class="s2">= </span><span class="s1">getopt</span><span class="s2">.</span><span class="s1">getopt</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s3">'i:ps:S:DNuP:R:Ha:hv'</span><span class="s2">)</span>
<span class="s4">except </span><span class="s1">getopt</span><span class="s2">.</span><span class="s1">error </span><span class="s4">as </span><span class="s1">msg</span><span class="s2">:</span>
    <span class="s1">usage</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>

<span class="s4">for </span><span class="s1">opt</span><span class="s2">, </span><span class="s1">arg </span><span class="s4">in </span><span class="s1">opts</span><span class="s2">:</span>
    <span class="s4">if </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-i'</span><span class="s2">:</span>
        <span class="s1">installDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-p'</span><span class="s2">:</span>
        <span class="s1">buildPatches </span><span class="s2">= </span><span class="s4">True</span>
    <span class="s4">elif </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-s'</span><span class="s2">:</span>
        <span class="s1">installSearch</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">))</span>
    <span class="s4">elif </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-S'</span><span class="s2">:</span>
        <span class="s1">tokens </span><span class="s2">= </span><span class="s1">arg</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">','</span><span class="s2">)</span>
        <span class="s4">while </span><span class="s1">len</span><span class="s2">(</span><span class="s1">tokens</span><span class="s2">) &lt; </span><span class="s5">4</span><span class="s2">:</span>
            <span class="s1">tokens</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">''</span><span class="s2">)</span>
        <span class="s1">certificate</span><span class="s2">, </span><span class="s1">chain</span><span class="s2">, </span><span class="s1">pkey</span><span class="s2">, </span><span class="s1">password </span><span class="s2">= </span><span class="s1">tokens</span><span class="s2">[:</span><span class="s5">4</span><span class="s2">]</span>
        <span class="s1">signParams</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">certificate</span><span class="s2">),</span>
                           <span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">chain</span><span class="s2">),</span>
                           <span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">pkey</span><span class="s2">),</span>
                           <span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">password</span><span class="s2">)))</span>
    <span class="s4">elif </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-D'</span><span class="s2">:</span>
        <span class="s1">allowPythonDev </span><span class="s2">= </span><span class="s4">True</span>
    <span class="s4">elif </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-N'</span><span class="s2">:</span>
        <span class="s1">storePythonSource </span><span class="s2">= </span><span class="s4">True</span>
    <span class="s4">elif </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-u'</span><span class="s2">:</span>
        <span class="s1">universalBinaries </span><span class="s2">= </span><span class="s4">True</span>
    <span class="s4">elif </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-P'</span><span class="s2">:</span>
        <span class="s1">platforms</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-R'</span><span class="s2">:</span>
        <span class="s1">systemRoot </span><span class="s2">= </span><span class="s1">arg</span>
    <span class="s4">elif </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-H'</span><span class="s2">:</span>
        <span class="s1">ignoreSetHost </span><span class="s2">= </span><span class="s4">True</span>
    <span class="s4">elif </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-a'</span><span class="s2">:</span>
        <span class="s1">p3dSuffix </span><span class="s2">= </span><span class="s1">arg</span>

    <span class="s4">elif </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-v'</span><span class="s2">:</span>
        <span class="s1">verbosePrint </span><span class="s2">= </span><span class="s4">True</span>

    <span class="s4">elif </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-h'</span><span class="s2">:</span>
        <span class="s1">usage</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s4">else</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">'illegal option: ' </span><span class="s2">+ </span><span class="s1">arg</span><span class="s2">)</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>

<span class="s4">if not </span><span class="s1">args</span><span class="s2">:</span>
    <span class="s1">usage</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>

<span class="s1">packageDef </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
<span class="s1">packageNames </span><span class="s2">= </span><span class="s4">None</span>
<span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) &gt; </span><span class="s5">1</span><span class="s2">:</span>
    <span class="s1">packageNames </span><span class="s2">= </span><span class="s1">args</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:]</span>

<span class="s0"># Add the directory containing the pdef file itself to sys.path, to</span>
<span class="s0"># help the Packager locate modules where a pathname isn't specified.</span>
<span class="s1">dirname </span><span class="s2">= </span><span class="s1">packageDef</span><span class="s2">.</span><span class="s1">getDirname</span><span class="s2">()</span>
<span class="s4">if </span><span class="s1">dirname</span><span class="s2">:</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">).</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
<span class="s4">else</span><span class="s2">:</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">)</span>

<span class="s4">if </span><span class="s1">universalBinaries</span><span class="s2">:</span>
    <span class="s4">if </span><span class="s1">platforms</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\n</span><span class="s3">You may not specify both -u and -P.</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s4">if </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPlatform</span><span class="s2">().</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'osx_'</span><span class="s2">):</span>
        <span class="s1">platforms </span><span class="s2">= [</span><span class="s3">'osx_i386'</span><span class="s2">, </span><span class="s3">'osx_amd64'</span><span class="s2">]</span>

<span class="s4">if not </span><span class="s1">platforms</span><span class="s2">:</span>
    <span class="s1">platforms </span><span class="s2">= [</span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPlatform</span><span class="s2">()]</span>

<span class="s4">for </span><span class="s1">platform </span><span class="s4">in </span><span class="s1">platforms</span><span class="s2">:</span>
    <span class="s1">packager </span><span class="s2">= </span><span class="s1">Packager</span><span class="s2">.</span><span class="s1">Packager</span><span class="s2">(</span><span class="s1">platform </span><span class="s2">= </span><span class="s1">platform</span><span class="s2">)</span>
    <span class="s1">packager</span><span class="s2">.</span><span class="s1">installDir </span><span class="s2">= </span><span class="s1">installDir</span>
    <span class="s1">packager</span><span class="s2">.</span><span class="s1">installSearch </span><span class="s2">= </span><span class="s1">installSearch </span><span class="s2">+ </span><span class="s1">packager</span><span class="s2">.</span><span class="s1">installSearch</span>
    <span class="s4">if </span><span class="s1">installDir </span><span class="s4">is not None</span><span class="s2">:</span>
        <span class="s1">packager</span><span class="s2">.</span><span class="s1">installSearch </span><span class="s2">= [</span><span class="s1">installDir</span><span class="s2">] + </span><span class="s1">packager</span><span class="s2">.</span><span class="s1">installSearch</span>
    <span class="s1">packager</span><span class="s2">.</span><span class="s1">signParams </span><span class="s2">= </span><span class="s1">signParams</span>
    <span class="s1">packager</span><span class="s2">.</span><span class="s1">allowPythonDev </span><span class="s2">= </span><span class="s1">allowPythonDev</span>
    <span class="s1">packager</span><span class="s2">.</span><span class="s1">storePythonSource </span><span class="s2">= </span><span class="s1">storePythonSource</span>
    <span class="s1">packager</span><span class="s2">.</span><span class="s1">systemRoot </span><span class="s2">= </span><span class="s1">systemRoot</span>
    <span class="s1">packager</span><span class="s2">.</span><span class="s1">ignoreSetHost </span><span class="s2">= </span><span class="s1">ignoreSetHost</span>
    <span class="s1">packager</span><span class="s2">.</span><span class="s1">verbosePrint </span><span class="s2">= </span><span class="s1">verbosePrint</span>
    <span class="s1">packager</span><span class="s2">.</span><span class="s1">p3dSuffix </span><span class="s2">= </span><span class="s1">p3dSuffix</span>

    <span class="s4">try</span><span class="s2">:</span>
        <span class="s1">packager</span><span class="s2">.</span><span class="s1">setup</span><span class="s2">()</span>
        <span class="s1">packages </span><span class="s2">= </span><span class="s1">packager</span><span class="s2">.</span><span class="s1">readPackageDef</span><span class="s2">(</span><span class="s1">packageDef</span><span class="s2">, </span><span class="s1">packageNames </span><span class="s2">= </span><span class="s1">packageNames</span><span class="s2">)</span>
        <span class="s1">packager</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">buildPatches</span><span class="s2">:</span>
            <span class="s1">packager</span><span class="s2">.</span><span class="s1">buildPatches</span><span class="s2">(</span><span class="s1">packages</span><span class="s2">)</span>

    <span class="s4">except </span><span class="s1">Packager</span><span class="s2">.</span><span class="s1">PackagerError</span><span class="s2">:</span>
        <span class="s0"># Just print the error message and exit gracefully.</span>
        <span class="s1">inst </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">exc_info</span><span class="s2">()[</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>

<span class="s0"># An explicit call to exit() is required to exit the program, when</span>
<span class="s0"># this module is packaged in a p3d file.</span>
<span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
</pre>
</body>
</html>