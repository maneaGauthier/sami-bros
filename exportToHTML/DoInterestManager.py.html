<html>
<head>
<title>DoInterestManager.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
DoInterestManager.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
The DoInterestManager keeps track of which parent/zones that we currently 
have interest in.  When you want to &quot;look&quot; into a zone you add an interest 
to that zone.  When you want to get rid of, or ignore, the objects in that 
zone, remove interest in that zone. 
 
p.s. A great deal of this code is just code moved from ClientRepository.py. 
&quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s1">panda3d</span><span class="s3">.</span><span class="s1">core </span><span class="s2">import </span><span class="s3">*</span>
<span class="s2">from </span><span class="s1">panda3d</span><span class="s3">.</span><span class="s1">direct </span><span class="s2">import </span><span class="s3">*</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">MsgTypes </span><span class="s2">import </span><span class="s3">*</span>
<span class="s2">from </span><span class="s1">direct</span><span class="s3">.</span><span class="s1">showbase</span><span class="s3">.</span><span class="s1">PythonUtil </span><span class="s2">import </span><span class="s3">*</span>
<span class="s2">from </span><span class="s1">direct</span><span class="s3">.</span><span class="s1">showbase </span><span class="s2">import </span><span class="s1">DirectObject</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">PyDatagram </span><span class="s2">import </span><span class="s1">PyDatagram</span>
<span class="s2">from </span><span class="s1">direct</span><span class="s3">.</span><span class="s1">directnotify</span><span class="s3">.</span><span class="s1">DirectNotifyGlobal </span><span class="s2">import </span><span class="s1">directNotify</span>
<span class="s2">import </span><span class="s1">types</span>
<span class="s2">from </span><span class="s1">direct</span><span class="s3">.</span><span class="s1">showbase</span><span class="s3">.</span><span class="s1">PythonUtil </span><span class="s2">import </span><span class="s1">report</span>

<span class="s2">class </span><span class="s1">InterestState</span><span class="s3">:</span>
    <span class="s1">StateActive </span><span class="s3">= </span><span class="s4">'Active'</span>
    <span class="s1">StatePendingDel </span><span class="s3">= </span><span class="s4">'PendingDel'</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">desc</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">context</span><span class="s3">, </span><span class="s1">event</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneIdList</span><span class="s3">,</span>
                 <span class="s1">eventCounter</span><span class="s3">, </span><span class="s1">auto</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">desc </span><span class="s3">= </span><span class="s1">desc</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">state </span><span class="s3">= </span><span class="s1">state</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">context </span><span class="s3">= </span><span class="s1">context</span>
        <span class="s5"># We must be ready to keep track of multiple events. If somebody</span>
        <span class="s5"># requested an interest to be removed and we get a second request</span>
        <span class="s5"># for removal of the same interest before we get a response for the</span>
        <span class="s5"># first interest removal, we now have two parts of the codebase</span>
        <span class="s5"># waiting for a response on the removal of a single interest.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">events </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">eventCounter </span><span class="s3">= </span><span class="s1">eventCounter</span>
        <span class="s2">if </span><span class="s1">event</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">addEvent</span><span class="s3">(</span><span class="s1">event</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">parentId </span><span class="s3">= </span><span class="s1">parentId</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">zoneIdList </span><span class="s3">= </span><span class="s1">zoneIdList</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">auto </span><span class="s3">= </span><span class="s1">auto</span>
    <span class="s2">def </span><span class="s1">addEvent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">event</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">events</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">event</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">eventCounter</span><span class="s3">.</span><span class="s1">num </span><span class="s3">+= </span><span class="s6">1</span>
    <span class="s2">def </span><span class="s1">getEvents</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">events</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">clearEvents</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">eventCounter</span><span class="s3">.</span><span class="s1">num </span><span class="s3">-= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">events</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">eventCounter</span><span class="s3">.</span><span class="s1">num </span><span class="s3">&gt;= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">events </span><span class="s3">= []</span>
    <span class="s2">def </span><span class="s1">sendEvents</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">event </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">events</span><span class="s3">:</span>
            <span class="s1">messenger</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">event</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">clearEvents</span><span class="s3">()</span>
    <span class="s2">def </span><span class="s1">setDesc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">desc</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">desc </span><span class="s3">= </span><span class="s1">desc</span>
    <span class="s2">def </span><span class="s1">isPendingDelete</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">state </span><span class="s3">== </span><span class="s1">InterestState</span><span class="s3">.</span><span class="s1">StatePendingDel</span>
    <span class="s2">def </span><span class="s1">__repr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s4">'InterestState(desc=%s, state=%s, context=%s, event=%s, parentId=%s, zoneIdList=%s)' </span><span class="s3">% (</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">desc</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">state</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">context</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">events</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">zoneIdList</span><span class="s3">)</span>

<span class="s2">class </span><span class="s1">InterestHandle</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;This class helps to ensure that valid handles get passed in to DoInterestManager funcs&quot;&quot;&quot;</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">id</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_id </span><span class="s3">= </span><span class="s1">id</span>
    <span class="s2">def </span><span class="s1">asInt</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_id</span>
    <span class="s2">def </span><span class="s1">__eq__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) == </span><span class="s1">type</span><span class="s3">(</span><span class="s1">other</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_id </span><span class="s3">== </span><span class="s1">other</span><span class="s3">.</span><span class="s1">_id</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_id </span><span class="s3">== </span><span class="s1">other</span>
    <span class="s2">def </span><span class="s1">__repr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s4">'%s(%s)' </span><span class="s3">% (</span><span class="s1">self</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_id</span><span class="s3">)</span>

<span class="s5"># context value for interest changes that have no complete event</span>
<span class="s1">NO_CONTEXT </span><span class="s3">= </span><span class="s6">0</span>

<span class="s2">class </span><span class="s1">DoInterestManager</span><span class="s3">(</span><span class="s1">DirectObject</span><span class="s3">.</span><span class="s1">DirectObject</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Top level Interest Manager 
    &quot;&quot;&quot;</span>
    <span class="s1">notify </span><span class="s3">= </span><span class="s1">directNotify</span><span class="s3">.</span><span class="s1">newCategory</span><span class="s3">(</span><span class="s4">&quot;DoInterestManager&quot;</span><span class="s3">)</span>
    <span class="s1">InterestDebug </span><span class="s3">= </span><span class="s1">ConfigVariableBool</span><span class="s3">(</span><span class="s4">'interest-debug'</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>

    <span class="s5"># 'handle' is a number that represents a single interest set that the</span>
    <span class="s5"># client has requested; the interest set may be modified</span>
    <span class="s1">_HandleSerialNum </span><span class="s3">= </span><span class="s6">0</span>
    <span class="s5"># high bit is reserved for server interests</span>
    <span class="s1">_HandleMask </span><span class="s3">= </span><span class="s6">0x7FFF</span>

    <span class="s5"># 'context' refers to a single request to change an interest set</span>
    <span class="s1">_ContextIdSerialNum </span><span class="s3">= </span><span class="s6">100</span>
    <span class="s1">_ContextIdMask </span><span class="s3">= </span><span class="s6">0x3FFFFFFF </span><span class="s5"># avoid making Python create a long</span>

    <span class="s1">_interests </span><span class="s3">= {}</span>
    <span class="s2">if __debug__</span><span class="s3">:</span>
        <span class="s1">_debug_interestHistory </span><span class="s3">= []</span>
        <span class="s1">_debug_maxDescriptionLen </span><span class="s3">= </span><span class="s6">40</span>

    <span class="s1">_SerialGen </span><span class="s3">= </span><span class="s1">SerialNumGen</span><span class="s3">()</span>
    <span class="s1">_SerialNum </span><span class="s3">= </span><span class="s1">serialNum</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debugCall</span><span class="s3">()</span>
        <span class="s1">DirectObject</span><span class="s3">.</span><span class="s1">DirectObject</span><span class="s3">.</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_addInterestEvent </span><span class="s3">= </span><span class="s1">uniqueName</span><span class="s3">(</span><span class="s4">'DoInterestManager-Add'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_removeInterestEvent </span><span class="s3">= </span><span class="s1">uniqueName</span><span class="s3">(</span><span class="s4">'DoInterestManager-Remove'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_noNewInterests </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_completeDelayedCallback </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s5"># keep track of request contexts that have not completed</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_completeEventCount </span><span class="s3">= </span><span class="s1">ScratchPad</span><span class="s3">(</span><span class="s1">num</span><span class="s3">=</span><span class="s6">0</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_allInterestsCompleteCallbacks </span><span class="s3">= []</span>

    <span class="s2">def </span><span class="s1">__verbose</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">InterestDebug</span><span class="s3">.</span><span class="s1">getValue</span><span class="s3">() </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getVerbose</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_getAnonymousEvent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">desc</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s4">'anonymous-%s-%s' </span><span class="s3">% (</span><span class="s1">desc</span><span class="s3">, </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_SerialGen</span><span class="s3">.</span><span class="s1">next</span><span class="s3">())</span>

    <span class="s2">def </span><span class="s1">setNoNewInterests</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">flag</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_noNewInterests </span><span class="s3">= </span><span class="s1">flag</span>

    <span class="s2">def </span><span class="s1">noNewInterests</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_noNewInterests</span>

    <span class="s2">def </span><span class="s1">setAllInterestsCompleteCallback</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">callback</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s3">((</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_completeEventCount</span><span class="s3">.</span><span class="s1">num </span><span class="s3">== </span><span class="s6">0</span><span class="s3">) </span><span class="s2">and</span>
            <span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_completeDelayedCallback </span><span class="s2">is None</span><span class="s3">)):</span>
            <span class="s1">callback</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_allInterestsCompleteCallbacks</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">callback</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">getAllInterestsCompleteEvent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s4">'allInterestsComplete-%s' </span><span class="s3">% </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_SerialNum</span>

    <span class="s2">def </span><span class="s1">resetInterestStateForConnectionLoss</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">.</span><span class="s1">clear</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_completeEventCount </span><span class="s3">= </span><span class="s1">ScratchPad</span><span class="s3">(</span><span class="s1">num</span><span class="s3">=</span><span class="s6">0</span><span class="s3">)</span>
        <span class="s2">if __debug__</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_addDebugInterestHistory</span><span class="s3">(</span><span class="s4">&quot;RESET&quot;</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, [])</span>

    <span class="s2">def </span><span class="s1">isValidInterestHandle</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">handle</span><span class="s3">):</span>
        <span class="s5"># pass in a handle (or anything else) and this will return true if it is</span>
        <span class="s5"># still a valid interest handle</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">, </span><span class="s1">InterestHandle</span><span class="s3">):</span>
            <span class="s2">return False</span>
        <span class="s2">return </span><span class="s1">handle</span><span class="s3">.</span><span class="s1">asInt</span><span class="s3">() </span><span class="s2">in </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span>

    <span class="s2">def </span><span class="s1">updateInterestDescription</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">handle</span><span class="s3">, </span><span class="s1">desc</span><span class="s3">):</span>
        <span class="s1">iState </span><span class="s3">= </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">.</span><span class="s1">asInt</span><span class="s3">())</span>
        <span class="s2">if </span><span class="s1">iState</span><span class="s3">:</span>
            <span class="s1">iState</span><span class="s3">.</span><span class="s1">setDesc</span><span class="s3">(</span><span class="s1">desc</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">addInterest</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneIdList</span><span class="s3">, </span><span class="s1">description</span><span class="s3">, </span><span class="s1">event</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Look into a (set of) zone(s). 
        &quot;&quot;&quot;</span>
        <span class="s2">assert </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debugCall</span><span class="s3">()</span>
        <span class="s1">handle </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getNextHandle</span><span class="s3">()</span>
        <span class="s5"># print 'base.cr.addInterest(',description,',',handle,'):',globalClock.getFrameCount()</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_noNewInterests</span><span class="s3">:</span>
            <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span>
                <span class="s4">&quot;addInterest: addingInterests on delete: %s&quot; </span><span class="s3">% (</span><span class="s1">handle</span><span class="s3">))</span>
            <span class="s2">return</span>

        <span class="s5"># make sure we've got parenting rules set in the DC</span>
        <span class="s2">if </span><span class="s1">parentId </span><span class="s2">not in </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">getGameDoId</span><span class="s3">(),):</span>
            <span class="s1">parent </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getDo</span><span class="s3">(</span><span class="s1">parentId</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">parent</span><span class="s3">:</span>
                <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span>
                    <span class="s4">'addInterest: attempting to add interest under unknown object %s' </span><span class="s3">% </span><span class="s1">parentId</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if not </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">hasParentingRules</span><span class="s3">():</span>
                    <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span>
                        <span class="s4">'addInterest: no setParentingRules defined in the DC for object %s (%s)'</span>
                        <span class="s4">'' </span><span class="s3">% (</span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">))</span>



        <span class="s2">if </span><span class="s1">event</span><span class="s3">:</span>
            <span class="s1">contextId </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getNextContextId</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">contextId </span><span class="s3">= </span><span class="s6">0</span>
            <span class="s5"># event = self._getAnonymousEvent('addInterest')</span>

        <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">] = </span><span class="s1">InterestState</span><span class="s3">(</span>
            <span class="s1">description</span><span class="s3">, </span><span class="s1">InterestState</span><span class="s3">.</span><span class="s1">StateActive</span><span class="s3">, </span><span class="s1">contextId</span><span class="s3">, </span><span class="s1">event</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneIdList</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_completeEventCount</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__verbose</span><span class="s3">():</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">'CR::INTEREST.addInterest(handle=%s, parentId=%s, zoneIdList=%s, description=%s, event=%s)' </span><span class="s3">% (</span>
                <span class="s1">handle</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneIdList</span><span class="s3">, </span><span class="s1">description</span><span class="s3">, </span><span class="s1">event</span><span class="s3">))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_sendAddInterest</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">, </span><span class="s1">contextId</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneIdList</span><span class="s3">, </span><span class="s1">description</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">event</span><span class="s3">:</span>
            <span class="s1">messenger</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getAddInterestEvent</span><span class="s3">(), [</span><span class="s1">event</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">printInterestsIfDebug</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">InterestHandle</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">addAutoInterest</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneIdList</span><span class="s3">, </span><span class="s1">description</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Look into a (set of) zone(s). 
        &quot;&quot;&quot;</span>
        <span class="s2">assert </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debugCall</span><span class="s3">()</span>
        <span class="s1">handle </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getNextHandle</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_noNewInterests</span><span class="s3">:</span>
            <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span>
                <span class="s4">&quot;addInterest: addingInterests on delete: %s&quot; </span><span class="s3">% (</span><span class="s1">handle</span><span class="s3">))</span>
            <span class="s2">return</span>

        <span class="s5"># make sure we've got parenting rules set in the DC</span>
        <span class="s2">if </span><span class="s1">parentId </span><span class="s2">not in </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">getGameDoId</span><span class="s3">(),):</span>
            <span class="s1">parent </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getDo</span><span class="s3">(</span><span class="s1">parentId</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">parent</span><span class="s3">:</span>
                <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span>
                    <span class="s4">'addInterest: attempting to add interest under unknown object %s' </span><span class="s3">% </span><span class="s1">parentId</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if not </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">hasParentingRules</span><span class="s3">():</span>
                    <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span>
                        <span class="s4">'addInterest: no setParentingRules defined in the DC for object %s (%s)'</span>
                        <span class="s4">'' </span><span class="s3">% (</span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">))</span>

        <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">] = </span><span class="s1">InterestState</span><span class="s3">(</span>
            <span class="s1">description</span><span class="s3">, </span><span class="s1">InterestState</span><span class="s3">.</span><span class="s1">StateActive</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneIdList</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_completeEventCount</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__verbose</span><span class="s3">():</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">'CR::INTEREST.addInterest(handle=%s, parentId=%s, zoneIdList=%s, description=%s)' </span><span class="s3">% (</span>
                <span class="s1">handle</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneIdList</span><span class="s3">, </span><span class="s1">description</span><span class="s3">))</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">printInterestsIfDebug</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">InterestHandle</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">removeInterest</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">handle</span><span class="s3">, </span><span class="s1">event </span><span class="s3">= </span><span class="s2">None</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Stop looking in a (set of) zone(s) 
        &quot;&quot;&quot;</span>
        <span class="s5"># print 'base.cr.removeInterest(',handle,'):',globalClock.getFrameCount()</span>

        <span class="s2">assert </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debugCall</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">, </span><span class="s1">InterestHandle</span><span class="s3">)</span>
        <span class="s1">existed </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s2">if not </span><span class="s1">event</span><span class="s3">:</span>
            <span class="s1">event </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getAnonymousEvent</span><span class="s3">(</span><span class="s4">'removeInterest'</span><span class="s3">)</span>
        <span class="s1">handle </span><span class="s3">= </span><span class="s1">handle</span><span class="s3">.</span><span class="s1">asInt</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">handle </span><span class="s2">in </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">:</span>
            <span class="s1">existed </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s1">intState </span><span class="s3">= </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">event</span><span class="s3">:</span>
                <span class="s1">messenger</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getRemoveInterestEvent</span><span class="s3">(),</span>
                               <span class="s3">[</span><span class="s1">event</span><span class="s3">, </span><span class="s1">intState</span><span class="s3">.</span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">intState</span><span class="s3">.</span><span class="s1">zoneIdList</span><span class="s3">])</span>
            <span class="s2">if </span><span class="s1">intState</span><span class="s3">.</span><span class="s1">isPendingDelete</span><span class="s3">():</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span>
                    <span class="s4">'removeInterest: interest %s already pending removal' </span><span class="s3">%</span>
                    <span class="s1">handle</span><span class="s3">)</span>
                <span class="s5"># this interest is already pending delete, so let's just tack this</span>
                <span class="s5"># callback onto the list</span>
                <span class="s2">if </span><span class="s1">event </span><span class="s2">is not None</span><span class="s3">:</span>
                    <span class="s1">intState</span><span class="s3">.</span><span class="s1">addEvent</span><span class="s3">(</span><span class="s1">event</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">intState</span><span class="s3">.</span><span class="s1">events</span><span class="s3">) &gt; </span><span class="s6">0</span><span class="s3">:</span>
                    <span class="s5"># we're not pending a removal, but we have outstanding events?</span>
                    <span class="s5"># probably we are waiting for an add/alter complete.</span>
                    <span class="s5"># should we send those events now?</span>
                    <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span><span class="s4">'removeInterest: abandoning events: %s' </span><span class="s3">%</span>
                                               <span class="s1">intState</span><span class="s3">.</span><span class="s1">events</span><span class="s3">)</span>
                    <span class="s1">intState</span><span class="s3">.</span><span class="s1">clearEvents</span><span class="s3">()</span>
                <span class="s1">intState</span><span class="s3">.</span><span class="s1">state </span><span class="s3">= </span><span class="s1">InterestState</span><span class="s3">.</span><span class="s1">StatePendingDel</span>
                <span class="s1">contextId </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getNextContextId</span><span class="s3">()</span>
                <span class="s1">intState</span><span class="s3">.</span><span class="s1">context </span><span class="s3">= </span><span class="s1">contextId</span>
                <span class="s2">if </span><span class="s1">event</span><span class="s3">:</span>
                    <span class="s1">intState</span><span class="s3">.</span><span class="s1">addEvent</span><span class="s3">(</span><span class="s1">event</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_sendRemoveInterest</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">, </span><span class="s1">contextId</span><span class="s3">)</span>
                <span class="s2">if not </span><span class="s1">event</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_considerRemoveInterest</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__verbose</span><span class="s3">():</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">'CR::INTEREST.removeInterest(handle=%s, event=%s)' </span><span class="s3">% (</span>
                        <span class="s1">handle</span><span class="s3">, </span><span class="s1">event</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span>
                <span class="s4">&quot;removeInterest: handle not found: %s&quot; </span><span class="s3">% (</span><span class="s1">handle</span><span class="s3">))</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">printInterestsIfDebug</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">existed</span>

    <span class="s2">def </span><span class="s1">removeAutoInterest</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">handle</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Stop looking in a (set of) zone(s) 
        &quot;&quot;&quot;</span>
        <span class="s2">assert </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debugCall</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">, </span><span class="s1">InterestHandle</span><span class="s3">)</span>
        <span class="s1">existed </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">handle </span><span class="s3">= </span><span class="s1">handle</span><span class="s3">.</span><span class="s1">asInt</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">handle </span><span class="s2">in </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">:</span>
            <span class="s1">existed </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s1">intState </span><span class="s3">= </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">intState</span><span class="s3">.</span><span class="s1">isPendingDelete</span><span class="s3">():</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span>
                    <span class="s4">'removeInterest: interest %s already pending removal' </span><span class="s3">%</span>
                    <span class="s1">handle</span><span class="s3">)</span>
                <span class="s5"># this interest is already pending delete, so let's just tack this</span>
                <span class="s5"># callback onto the list</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">intState</span><span class="s3">.</span><span class="s1">events</span><span class="s3">) &gt; </span><span class="s6">0</span><span class="s3">:</span>
                    <span class="s5"># we're not pending a removal, but we have outstanding events?</span>
                    <span class="s5"># probably we are waiting for an add/alter complete.</span>
                    <span class="s5"># should we send those events now?</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span><span class="s4">'removeInterest: abandoning events: %s' </span><span class="s3">%</span>
                                        <span class="s1">intState</span><span class="s3">.</span><span class="s1">events</span><span class="s3">)</span>
                    <span class="s1">intState</span><span class="s3">.</span><span class="s1">clearEvents</span><span class="s3">()</span>
                <span class="s1">intState</span><span class="s3">.</span><span class="s1">state </span><span class="s3">= </span><span class="s1">InterestState</span><span class="s3">.</span><span class="s1">StatePendingDel</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_considerRemoveInterest</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__verbose</span><span class="s3">():</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">'CR::INTEREST.removeAutoInterest(handle=%s)' </span><span class="s3">% (</span><span class="s1">handle</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span>
                <span class="s4">&quot;removeInterest: handle not found: %s&quot; </span><span class="s3">% (</span><span class="s1">handle</span><span class="s3">))</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">printInterestsIfDebug</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">existed</span>

    <span class="s3">@</span><span class="s1">report</span><span class="s3">(</span><span class="s1">types </span><span class="s3">= [</span><span class="s4">'args'</span><span class="s3">], </span><span class="s1">dConfigParam </span><span class="s3">= </span><span class="s4">'guildmgr'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">removeAIInterest</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">handle</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        handle is NOT an InterestHandle.  It's just a bare integer representing an 
        AI opened interest. We're making the client close down this interest since 
        the AI has trouble removing interests(that its opened) when the avatar goes 
        offline.  See GuildManager(UD) for how it's being used. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_sendRemoveAIInterest</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">alterInterest</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">handle</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneIdList</span><span class="s3">, </span><span class="s1">description</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
                      <span class="s1">event</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Removes old interests and adds new interests. 
 
        Note that when an interest is changed, only the most recent 
        change's event will be triggered. Previous events are abandoned. 
        If this is a problem, consider opening multiple interests. 
        &quot;&quot;&quot;</span>
        <span class="s2">assert </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debugCall</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">, </span><span class="s1">InterestHandle</span><span class="s3">)</span>
        <span class="s5">#assert not self._noNewInterests</span>
        <span class="s1">handle </span><span class="s3">= </span><span class="s1">handle</span><span class="s3">.</span><span class="s1">asInt</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_noNewInterests</span><span class="s3">:</span>
            <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span>
                <span class="s4">&quot;alterInterest: addingInterests on delete: %s&quot; </span><span class="s3">% (</span><span class="s1">handle</span><span class="s3">))</span>
            <span class="s2">return</span>

        <span class="s1">exists </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s2">if </span><span class="s1">event </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">event </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getAnonymousEvent</span><span class="s3">(</span><span class="s4">'alterInterest'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">handle </span><span class="s2">in </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">description </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">].</span><span class="s1">desc </span><span class="s3">= </span><span class="s1">description</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">description </span><span class="s3">= </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">].</span><span class="s1">desc</span>

            <span class="s5"># are we overriding an existing change?</span>
            <span class="s2">if </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">].</span><span class="s1">context </span><span class="s3">!= </span><span class="s1">NO_CONTEXT</span><span class="s3">:</span>
                <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">].</span><span class="s1">clearEvents</span><span class="s3">()</span>

            <span class="s1">contextId </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getNextContextId</span><span class="s3">()</span>
            <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">].</span><span class="s1">context </span><span class="s3">= </span><span class="s1">contextId</span>
            <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">].</span><span class="s1">parentId </span><span class="s3">= </span><span class="s1">parentId</span>
            <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">].</span><span class="s1">zoneIdList </span><span class="s3">= </span><span class="s1">zoneIdList</span>
            <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">].</span><span class="s1">addEvent</span><span class="s3">(</span><span class="s1">event</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__verbose</span><span class="s3">():</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">'CR::INTEREST.alterInterest(handle=%s, parentId=%s, zoneIdList=%s, description=%s, event=%s)' </span><span class="s3">% (</span>
                    <span class="s1">handle</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneIdList</span><span class="s3">, </span><span class="s1">description</span><span class="s3">, </span><span class="s1">event</span><span class="s3">))</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_sendAddInterest</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">, </span><span class="s1">contextId</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneIdList</span><span class="s3">, </span><span class="s1">description</span><span class="s3">, </span><span class="s1">action</span><span class="s3">=</span><span class="s4">'modify'</span><span class="s3">)</span>
            <span class="s1">exists </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">printInterestsIfDebug</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span>
                <span class="s4">&quot;alterInterest: handle not found: %s&quot; </span><span class="s3">% (</span><span class="s1">handle</span><span class="s3">))</span>
        <span class="s2">return </span><span class="s1">exists</span>

    <span class="s2">def </span><span class="s1">openAutoInterests</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s4">'_autoInterestHandle'</span><span class="s3">):</span>
            <span class="s5"># must be multiple inheritance</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'openAutoInterests(%s): interests already open' </span><span class="s3">% </span><span class="s1">obj</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">)</span>
            <span class="s2">return</span>
        <span class="s1">autoInterests </span><span class="s3">= </span><span class="s1">obj</span><span class="s3">.</span><span class="s1">getAutoInterests</span><span class="s3">()</span>
        <span class="s1">obj</span><span class="s3">.</span><span class="s1">_autoInterestHandle </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">if not </span><span class="s1">len</span><span class="s3">(</span><span class="s1">autoInterests</span><span class="s3">):</span>
            <span class="s2">return</span>
        <span class="s1">obj</span><span class="s3">.</span><span class="s1">_autoInterestHandle </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">addAutoInterest</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">.</span><span class="s1">doId</span><span class="s3">, </span><span class="s1">autoInterests</span><span class="s3">, </span><span class="s4">'%s-autoInterest' </span><span class="s3">% </span><span class="s1">obj</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">closeAutoInterests</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s4">'_autoInterestHandle'</span><span class="s3">):</span>
            <span class="s5"># must be multiple inheritance</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'closeAutoInterests(%s): interests already closed' </span><span class="s3">% </span><span class="s1">obj</span><span class="s3">)</span>
            <span class="s2">return</span>
        <span class="s2">if </span><span class="s1">obj</span><span class="s3">.</span><span class="s1">_autoInterestHandle </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">removeAutoInterest</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">.</span><span class="s1">_autoInterestHandle</span><span class="s3">)</span>
        <span class="s2">del </span><span class="s1">obj</span><span class="s3">.</span><span class="s1">_autoInterestHandle</span>

    <span class="s5"># events for InterestWatcher</span>
    <span class="s2">def </span><span class="s1">_getAddInterestEvent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_addInterestEvent</span>
    <span class="s2">def </span><span class="s1">_getRemoveInterestEvent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_removeInterestEvent</span>

    <span class="s2">def </span><span class="s1">_getInterestState</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">handle</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">_getNextHandle</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">handle </span><span class="s3">= </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_HandleSerialNum</span>
        <span class="s2">while True</span><span class="s3">:</span>
            <span class="s1">handle </span><span class="s3">= (</span><span class="s1">handle </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">) &amp; </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_HandleMask</span>
            <span class="s5"># skip handles that are already in use</span>
            <span class="s2">if </span><span class="s1">handle </span><span class="s2">not in </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">:</span>
                <span class="s2">break</span>
            <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span>
                <span class="s4">'interest %s already in use' </span><span class="s3">% </span><span class="s1">handle</span><span class="s3">)</span>
        <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_HandleSerialNum </span><span class="s3">= </span><span class="s1">handle</span>
        <span class="s2">return </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_HandleSerialNum</span>
    <span class="s2">def </span><span class="s1">_getNextContextId</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">contextId </span><span class="s3">= </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_ContextIdSerialNum</span>
        <span class="s2">while True</span><span class="s3">:</span>
            <span class="s1">contextId </span><span class="s3">= (</span><span class="s1">contextId </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">) &amp; </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_ContextIdMask</span>
            <span class="s5"># skip over the 'no context' id</span>
            <span class="s2">if </span><span class="s1">contextId </span><span class="s3">!= </span><span class="s1">NO_CONTEXT</span><span class="s3">:</span>
                <span class="s2">break</span>
        <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_ContextIdSerialNum </span><span class="s3">= </span><span class="s1">contextId</span>
        <span class="s2">return </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_ContextIdSerialNum</span>

    <span class="s2">def </span><span class="s1">_considerRemoveInterest</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">handle</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Consider whether we should cull the interest set. 
        &quot;&quot;&quot;</span>
        <span class="s2">assert </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debugCall</span><span class="s3">()</span>

        <span class="s2">if </span><span class="s1">handle </span><span class="s2">in </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">].</span><span class="s1">isPendingDelete</span><span class="s3">():</span>
                <span class="s5"># make sure there is no pending event for this interest</span>
                <span class="s2">if </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">].</span><span class="s1">context </span><span class="s3">== </span><span class="s1">NO_CONTEXT</span><span class="s3">:</span>
                    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">].</span><span class="s1">events</span><span class="s3">) == </span><span class="s6">0</span>
                    <span class="s2">del </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">]</span>

    <span class="s2">if __debug__</span><span class="s3">:</span>
        <span class="s2">def </span><span class="s1">printInterestsIfDebug</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">getDebug</span><span class="s3">():</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">printInterests</span><span class="s3">()</span>
            <span class="s2">return </span><span class="s6">1 </span><span class="s5"># for assert</span>

        <span class="s2">def </span><span class="s1">_addDebugInterestHistory</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">action</span><span class="s3">, </span><span class="s1">description</span><span class="s3">, </span><span class="s1">handle</span><span class="s3">,</span>
                                     <span class="s1">contextId</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneIdList</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">description </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">description </span><span class="s3">= </span><span class="s4">''</span>
            <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_debug_interestHistory</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
                <span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">description</span><span class="s3">, </span><span class="s1">handle</span><span class="s3">, </span><span class="s1">contextId</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneIdList</span><span class="s3">))</span>
            <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_debug_maxDescriptionLen </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span>
                <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_debug_maxDescriptionLen</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">description</span><span class="s3">))</span>

        <span class="s2">def </span><span class="s1">printInterestHistory</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;***************** Interest History *************&quot;</span><span class="s3">)</span>
            <span class="s1">format </span><span class="s3">= </span><span class="s4">'%9s %' </span><span class="s3">+ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_debug_maxDescriptionLen</span><span class="s3">) + </span><span class="s4">'s %6s %6s %9s %s'</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">format </span><span class="s3">% (</span>
                <span class="s4">&quot;Action&quot;</span><span class="s3">, </span><span class="s4">&quot;Description&quot;</span><span class="s3">, </span><span class="s4">&quot;Handle&quot;</span><span class="s3">, </span><span class="s4">&quot;Context&quot;</span><span class="s3">, </span><span class="s4">&quot;ParentId&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;ZoneIdList&quot;</span><span class="s3">))</span>
            <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_debug_interestHistory</span><span class="s3">:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s1">format </span><span class="s3">% </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">i</span><span class="s3">))</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;Note: interests with a Context of 0 do not get&quot; </span><span class="s1">\</span>
                <span class="s4">&quot; done/finished notices.&quot;</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">printInterestSets</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;******************* Interest Sets **************&quot;</span><span class="s3">)</span>
            <span class="s1">format </span><span class="s3">= </span><span class="s4">'%6s %' </span><span class="s3">+ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_debug_maxDescriptionLen</span><span class="s3">) + </span><span class="s4">'s %11s %11s %8s %8s %8s'</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">format </span><span class="s3">% (</span>
                <span class="s4">&quot;Handle&quot;</span><span class="s3">, </span><span class="s4">&quot;Description&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;ParentId&quot;</span><span class="s3">, </span><span class="s4">&quot;ZoneIdList&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;State&quot;</span><span class="s3">, </span><span class="s4">&quot;Context&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;Event&quot;</span><span class="s3">))</span>
            <span class="s2">for </span><span class="s1">id</span><span class="s3">, </span><span class="s1">state </span><span class="s2">in </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">state</span><span class="s3">.</span><span class="s1">events</span><span class="s3">) == </span><span class="s6">0</span><span class="s3">:</span>
                    <span class="s1">event </span><span class="s3">= </span><span class="s4">''</span>
                <span class="s2">elif </span><span class="s1">len</span><span class="s3">(</span><span class="s1">state</span><span class="s3">.</span><span class="s1">events</span><span class="s3">) == </span><span class="s6">1</span><span class="s3">:</span>
                    <span class="s1">event </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">events</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">event </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">events</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s1">format </span><span class="s3">% (</span><span class="s1">id</span><span class="s3">, </span><span class="s1">state</span><span class="s3">.</span><span class="s1">desc</span><span class="s3">,</span>
                                <span class="s1">state</span><span class="s3">.</span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">state</span><span class="s3">.</span><span class="s1">zoneIdList</span><span class="s3">,</span>
                                <span class="s1">state</span><span class="s3">.</span><span class="s1">state</span><span class="s3">, </span><span class="s1">state</span><span class="s3">.</span><span class="s1">context</span><span class="s3">,</span>
                                <span class="s1">event</span><span class="s3">))</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;************************************************&quot;</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">printInterests</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">printInterestHistory</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">printInterestSets</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_sendAddInterest</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">handle</span><span class="s3">, </span><span class="s1">contextId</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneIdList</span><span class="s3">, </span><span class="s1">description</span><span class="s3">,</span>
                         <span class="s1">action</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Part of the new otp-server code. 
 
        handle is a client-side created number that refers to 
                a set of interests.  The same handle number doesn't 
                necessarily have any relationship to the same handle 
                on another client. 
        &quot;&quot;&quot;</span>
        <span class="s2">assert </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debugCall</span><span class="s3">()</span>
        <span class="s2">if __debug__</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">zoneIdList</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
                <span class="s1">zoneIdList</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">action </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">action </span><span class="s3">= </span><span class="s4">'add'</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_addDebugInterestHistory</span><span class="s3">(</span>
                <span class="s1">action</span><span class="s3">, </span><span class="s1">description</span><span class="s3">, </span><span class="s1">handle</span><span class="s3">, </span><span class="s1">contextId</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneIdList</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">parentId </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span>
                <span class="s4">'trying to set interest to invalid parent: %s' </span><span class="s3">% </span><span class="s1">parentId</span><span class="s3">)</span>
        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">PyDatagram</span><span class="s3">()</span>
        <span class="s5"># Add message type</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">zoneIdList</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
            <span class="s1">vzl </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">zoneIdList</span><span class="s3">)</span>
            <span class="s1">vzl</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">()</span>
            <span class="s1">uniqueElements</span><span class="s3">(</span><span class="s1">vzl</span><span class="s3">)</span>
            <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint16</span><span class="s3">(</span><span class="s1">CLIENT_ADD_INTEREST_MULTIPLE</span><span class="s3">)</span>
            <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint32</span><span class="s3">(</span><span class="s1">contextId</span><span class="s3">)</span>
            <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint16</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">)</span>
            <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint32</span><span class="s3">(</span><span class="s1">parentId</span><span class="s3">)</span>
            <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint16</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">vzl</span><span class="s3">))</span>
            <span class="s2">for </span><span class="s1">zone </span><span class="s2">in </span><span class="s1">vzl</span><span class="s3">:</span>
                <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint32</span><span class="s3">(</span><span class="s1">zone</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint16</span><span class="s3">(</span><span class="s1">CLIENT_ADD_INTEREST</span><span class="s3">)</span>
            <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint32</span><span class="s3">(</span><span class="s1">contextId</span><span class="s3">)</span>
            <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint16</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">)</span>
            <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint32</span><span class="s3">(</span><span class="s1">parentId</span><span class="s3">)</span>
            <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint32</span><span class="s3">(</span><span class="s1">zoneIdList</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_sendRemoveInterest</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">handle</span><span class="s3">, </span><span class="s1">contextId</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        handle is a client-side created number that refers to 
                a set of interests.  The same handle number doesn't 
                necessarily have any relationship to the same handle 
                on another client. 
        &quot;&quot;&quot;</span>
        <span class="s2">assert </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debugCall</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">handle </span><span class="s2">in </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span>
        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">PyDatagram</span><span class="s3">()</span>
        <span class="s5"># Add message type</span>
        <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint16</span><span class="s3">(</span><span class="s1">CLIENT_REMOVE_INTEREST</span><span class="s3">)</span>
        <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint32</span><span class="s3">(</span><span class="s1">contextId</span><span class="s3">)</span>
        <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint16</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">)</span>
        <span class="s2">if __debug__</span><span class="s3">:</span>
            <span class="s1">state </span><span class="s3">= </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">]</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_addDebugInterestHistory</span><span class="s3">(</span>
                <span class="s4">&quot;remove&quot;</span><span class="s3">, </span><span class="s1">state</span><span class="s3">.</span><span class="s1">desc</span><span class="s3">, </span><span class="s1">handle</span><span class="s3">, </span><span class="s1">contextId</span><span class="s3">,</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">state</span><span class="s3">.</span><span class="s1">zoneIdList</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_sendRemoveAIInterest</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">handle</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        handle is a bare int, NOT an InterestHandle.  Use this to 
        close an AI opened interest. 
        &quot;&quot;&quot;</span>
        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">PyDatagram</span><span class="s3">()</span>
        <span class="s5"># Add message type</span>
        <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint16</span><span class="s3">(</span><span class="s1">CLIENT_REMOVE_INTEREST</span><span class="s3">)</span>
        <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint16</span><span class="s3">((</span><span class="s6">1</span><span class="s3">&lt;&lt;</span><span class="s6">15</span><span class="s3">) + </span><span class="s1">handle</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">cleanupWaitAllInterestsComplete</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_completeDelayedCallback </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_completeDelayedCallback</span><span class="s3">.</span><span class="s1">destroy</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_completeDelayedCallback </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">queueAllInterestsCompleteEvent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">frames</span><span class="s3">=</span><span class="s6">5</span><span class="s3">):</span>
        <span class="s5"># wait for N frames, if no new interests, send out all-done event</span>
        <span class="s5"># calling this is OK even if there are no pending interest completes</span>
        <span class="s2">def </span><span class="s1">checkMoreInterests</span><span class="s3">():</span>
            <span class="s5"># if there are new interests, cancel this delayed callback, another</span>
            <span class="s5"># will automatically be scheduled when all interests complete</span>
            <span class="s5"># print 'checkMoreInterests(',self._completeEventCount.num,'):',globalClock.getFrameCount()</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_completeEventCount</span><span class="s3">.</span><span class="s1">num </span><span class="s3">&gt; </span><span class="s6">0</span>
        <span class="s2">def </span><span class="s1">sendEvent</span><span class="s3">():</span>
            <span class="s1">messenger</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">getAllInterestsCompleteEvent</span><span class="s3">())</span>
            <span class="s2">for </span><span class="s1">callback </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_allInterestsCompleteCallbacks</span><span class="s3">:</span>
                <span class="s1">callback</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_allInterestsCompleteCallbacks </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cleanupWaitAllInterestsComplete</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_completeDelayedCallback </span><span class="s3">= </span><span class="s1">FrameDelayedCall</span><span class="s3">(</span>
            <span class="s4">'waitForAllInterestCompletes'</span><span class="s3">,</span>
            <span class="s1">callback</span><span class="s3">=</span><span class="s1">sendEvent</span><span class="s3">,</span>
            <span class="s1">frames</span><span class="s3">=</span><span class="s1">frames</span><span class="s3">,</span>
            <span class="s1">cancelFunc</span><span class="s3">=</span><span class="s1">checkMoreInterests</span><span class="s3">)</span>
        <span class="s1">checkMoreInterests </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">sendEvent </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">handleInterestDoneMessage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">di</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        This handles the interest done messages and may dispatch an event 
        &quot;&quot;&quot;</span>
        <span class="s2">assert </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debugCall</span><span class="s3">()</span>
        <span class="s1">contextId </span><span class="s3">= </span><span class="s1">di</span><span class="s3">.</span><span class="s1">getUint32</span><span class="s3">()</span>
        <span class="s1">handle </span><span class="s3">= </span><span class="s1">di</span><span class="s3">.</span><span class="s1">getUint16</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__verbose</span><span class="s3">():</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">'CR::INTEREST.interestDone(handle=%s)' </span><span class="s3">% </span><span class="s1">handle</span><span class="s3">)</span>
        <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span>
            <span class="s4">&quot;handleInterestDoneMessage--&gt; Received handle %s, context %s&quot; </span><span class="s3">% (</span>
            <span class="s1">handle</span><span class="s3">, </span><span class="s1">contextId</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">handle </span><span class="s2">in </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">:</span>
            <span class="s1">eventsToSend </span><span class="s3">= []</span>
            <span class="s5"># if the context matches, send out the event</span>
            <span class="s2">if </span><span class="s1">contextId </span><span class="s3">== </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">].</span><span class="s1">context</span><span class="s3">:</span>
                <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">].</span><span class="s1">context </span><span class="s3">= </span><span class="s1">NO_CONTEXT</span>
                <span class="s5"># the event handlers may call back into the interest manager. Send out</span>
                <span class="s5"># the events after we're once again in a stable state.</span>
                <span class="s5">#DoInterestManager._interests[handle].sendEvents()</span>
                <span class="s1">eventsToSend </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">].</span><span class="s1">getEvents</span><span class="s3">())</span>
                <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">].</span><span class="s1">clearEvents</span><span class="s3">()</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span>
                    <span class="s4">&quot;handleInterestDoneMessage--&gt; handle: %s: Expecting context %s, got %s&quot; </span><span class="s3">% (</span>
                    <span class="s1">handle</span><span class="s3">, </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">].</span><span class="s1">context</span><span class="s3">, </span><span class="s1">contextId</span><span class="s3">))</span>
            <span class="s2">if __debug__</span><span class="s3">:</span>
                <span class="s1">state </span><span class="s3">= </span><span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">_interests</span><span class="s3">[</span><span class="s1">handle</span><span class="s3">]</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_addDebugInterestHistory</span><span class="s3">(</span>
                    <span class="s4">&quot;finished&quot;</span><span class="s3">, </span><span class="s1">state</span><span class="s3">.</span><span class="s1">desc</span><span class="s3">, </span><span class="s1">handle</span><span class="s3">, </span><span class="s1">contextId</span><span class="s3">, </span><span class="s1">state</span><span class="s3">.</span><span class="s1">parentId</span><span class="s3">,</span>
                    <span class="s1">state</span><span class="s3">.</span><span class="s1">zoneIdList</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_considerRemoveInterest</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">event </span><span class="s2">in </span><span class="s1">eventsToSend</span><span class="s3">:</span>
                <span class="s1">messenger</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">event</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">DoInterestManager</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span>
                <span class="s4">&quot;handleInterestDoneMessage: handle not found: %s&quot; </span><span class="s3">% (</span><span class="s1">handle</span><span class="s3">))</span>
        <span class="s5"># if there are no more outstanding interest-completes, send out global all-done event</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_completeEventCount</span><span class="s3">.</span><span class="s1">num </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">queueAllInterestsCompleteEvent</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">printInterestsIfDebug</span><span class="s3">()</span>

<span class="s2">if __debug__</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">unittest</span>

    <span class="s2">class </span><span class="s1">AsyncTestCase</span><span class="s3">(</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">TestCase</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">setCompleted</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_async_completed </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s2">def </span><span class="s1">isCompleted</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s4">'_async_completed'</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">class </span><span class="s1">AsyncTestSuite</span><span class="s3">(</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">TestSuite</span><span class="s3">):</span>
        <span class="s2">pass</span>

    <span class="s2">class </span><span class="s1">AsyncTestLoader</span><span class="s3">(</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">TestLoader</span><span class="s3">):</span>
        <span class="s1">suiteClass </span><span class="s3">= </span><span class="s1">AsyncTestSuite</span>

    <span class="s2">class </span><span class="s1">AsyncTextTestRunner</span><span class="s3">(</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">TextTestRunner</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">run</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">testCase</span><span class="s3">):</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_makeResult</span><span class="s3">()</span>
            <span class="s1">startTime </span><span class="s3">= </span><span class="s1">time</span><span class="s3">.</span><span class="s1">time</span><span class="s3">()</span>
            <span class="s1">test</span><span class="s3">(</span><span class="s1">result</span><span class="s3">)</span>
            <span class="s1">stopTime </span><span class="s3">= </span><span class="s1">time</span><span class="s3">.</span><span class="s1">time</span><span class="s3">()</span>
            <span class="s1">timeTaken </span><span class="s3">= </span><span class="s1">stopTime </span><span class="s3">- </span><span class="s1">startTime</span>
            <span class="s1">result</span><span class="s3">.</span><span class="s1">printErrors</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">writeln</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">separator2</span><span class="s3">)</span>
            <span class="s1">run </span><span class="s3">= </span><span class="s1">result</span><span class="s3">.</span><span class="s1">testsRun</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">writeln</span><span class="s3">(</span><span class="s4">&quot;Ran %d test%s in %.3fs&quot; </span><span class="s3">%</span>
                                <span class="s3">(</span><span class="s1">run</span><span class="s3">, </span><span class="s1">run </span><span class="s3">!= </span><span class="s6">1 </span><span class="s2">and </span><span class="s4">&quot;s&quot; </span><span class="s2">or </span><span class="s4">&quot;&quot;</span><span class="s3">, </span><span class="s1">timeTaken</span><span class="s3">))</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">writeln</span><span class="s3">()</span>
            <span class="s2">if not </span><span class="s1">result</span><span class="s3">.</span><span class="s1">wasSuccessful</span><span class="s3">():</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">&quot;FAILED (&quot;</span><span class="s3">)</span>
                <span class="s1">failed</span><span class="s3">, </span><span class="s1">errored </span><span class="s3">= </span><span class="s1">map</span><span class="s3">(</span><span class="s1">len</span><span class="s3">, (</span><span class="s1">result</span><span class="s3">.</span><span class="s1">failures</span><span class="s3">, </span><span class="s1">result</span><span class="s3">.</span><span class="s1">errors</span><span class="s3">))</span>
                <span class="s2">if </span><span class="s1">failed</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">&quot;failures=%d&quot; </span><span class="s3">% </span><span class="s1">failed</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">errored</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">failed</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">&quot;, &quot;</span><span class="s3">)</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">&quot;errors=%d&quot; </span><span class="s3">% </span><span class="s1">errored</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">writeln</span><span class="s3">(</span><span class="s4">&quot;)&quot;</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">writeln</span><span class="s3">(</span><span class="s4">&quot;OK&quot;</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">result</span>

    <span class="s2">class </span><span class="s1">TestInterestAddRemove</span><span class="s3">(</span><span class="s1">AsyncTestCase</span><span class="s3">, </span><span class="s1">DirectObject</span><span class="s3">.</span><span class="s1">DirectObject</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">testInterestAdd</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s1">event </span><span class="s3">= </span><span class="s1">uniqueName</span><span class="s3">(</span><span class="s4">'InterestAdd'</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">acceptOnce</span><span class="s3">(</span><span class="s1">event</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">gotInterestAddResponse</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">handle </span><span class="s3">= </span><span class="s1">base</span><span class="s3">.</span><span class="s1">cr</span><span class="s3">.</span><span class="s1">addInterest</span><span class="s3">(</span><span class="s1">base</span><span class="s3">.</span><span class="s1">cr</span><span class="s3">.</span><span class="s1">GameGlobalsId</span><span class="s3">, </span><span class="s6">100</span><span class="s3">, </span><span class="s4">'TestInterest'</span><span class="s3">, </span><span class="s1">event</span><span class="s3">=</span><span class="s1">event</span><span class="s3">)</span>
        <span class="s2">def </span><span class="s1">gotInterestAddResponse</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s1">event </span><span class="s3">= </span><span class="s1">uniqueName</span><span class="s3">(</span><span class="s4">'InterestRemove'</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">acceptOnce</span><span class="s3">(</span><span class="s1">event</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">gotInterestRemoveResponse</span><span class="s3">)</span>
            <span class="s1">base</span><span class="s3">.</span><span class="s1">cr</span><span class="s3">.</span><span class="s1">removeInterest</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">handle</span><span class="s3">, </span><span class="s1">event</span><span class="s3">=</span><span class="s1">event</span><span class="s3">)</span>
        <span class="s2">def </span><span class="s1">gotInterestRemoveResponse</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">setCompleted</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">runTests</span><span class="s3">():</span>
        <span class="s1">suite </span><span class="s3">= </span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">makeSuite</span><span class="s3">(</span><span class="s1">TestInterestAddRemove</span><span class="s3">)</span>
        <span class="s1">unittest</span><span class="s3">.</span><span class="s1">AsyncTextTestRunner</span><span class="s3">(</span><span class="s1">verbosity</span><span class="s3">=</span><span class="s6">2</span><span class="s3">).</span><span class="s1">run</span><span class="s3">(</span><span class="s1">suite</span><span class="s3">)</span>
</pre>
</body>
</html>