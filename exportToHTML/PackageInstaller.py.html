<html>
<head>
<title>PackageInstaller.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
PackageInstaller.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
.. deprecated:: 1.10.0 
   The p3d packaging system has been replaced with the new setuptools-based 
   system.  See the :ref:`distribution` manual section. 
&quot;&quot;&quot;</span>
<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">&quot;PackageInstaller&quot;</span><span class="s2">]</span>

<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase</span><span class="s2">.</span><span class="s1">DirectObject </span><span class="s4">import </span><span class="s1">DirectObject</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">stdpy</span><span class="s2">.</span><span class="s1">threading </span><span class="s4">import </span><span class="s1">Lock</span><span class="s2">, </span><span class="s1">RLock</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase</span><span class="s2">.</span><span class="s1">MessengerGlobal </span><span class="s4">import </span><span class="s1">messenger</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">task</span><span class="s2">.</span><span class="s1">TaskManagerGlobal </span><span class="s4">import </span><span class="s1">taskMgr</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">p3d</span><span class="s2">.</span><span class="s1">PackageInfo </span><span class="s4">import </span><span class="s1">PackageInfo</span>
<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s1">TPLow</span><span class="s2">, </span><span class="s1">PStatCollector</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">directnotify</span><span class="s2">.</span><span class="s1">DirectNotifyGlobal </span><span class="s4">import </span><span class="s1">directNotify</span>

<span class="s4">class </span><span class="s1">PackageInstaller</span><span class="s2">(</span><span class="s1">DirectObject</span><span class="s2">):</span>

    <span class="s0">&quot;&quot;&quot; This class is used in a p3d runtime environment to manage the 
    asynchronous download and installation of packages.  If you just 
    want to install a package synchronously, see 
    appRunner.installPackage() for a simpler interface. 
 
    To use this class, you should subclass from it and override any of 
    the six callback methods: downloadStarted(), packageStarted(), 
    packageProgress(), downloadProgress(), packageFinished(), 
    downloadFinished(). 
 
    Also see DWBPackageInstaller, which does exactly this, to add a 
    DirectWaitBar GUI. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">notify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s3">&quot;PackageInstaller&quot;</span><span class="s2">)</span>

    <span class="s1">globalLock </span><span class="s2">= </span><span class="s1">Lock</span><span class="s2">()</span>
    <span class="s1">nextUniqueId </span><span class="s2">= </span><span class="s5">1</span>

    <span class="s6"># This is a chain of state values progressing forward in time.</span>
    <span class="s1">S_initial </span><span class="s2">= </span><span class="s5">0    </span><span class="s6"># addPackage() calls are being made</span>
    <span class="s1">S_ready </span><span class="s2">= </span><span class="s5">1      </span><span class="s6"># donePackages() has been called</span>
    <span class="s1">S_started </span><span class="s2">= </span><span class="s5">2    </span><span class="s6"># download has started</span>
    <span class="s1">S_done </span><span class="s2">= </span><span class="s5">3       </span><span class="s6"># download is over</span>

    <span class="s4">class </span><span class="s1">PendingPackage</span><span class="s2">:</span>
        <span class="s0">&quot;&quot;&quot; This class describes a package added to the installer for 
        download. &quot;&quot;&quot;</span>

        <span class="s1">notify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s3">&quot;PendingPackage&quot;</span><span class="s2">)</span>

        <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">host</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">= </span><span class="s1">packageName</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s1">version</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">host </span><span class="s2">= </span><span class="s1">host</span>

            <span class="s6"># This will be filled in properly by checkDescFile() or</span>
            <span class="s6"># getDescFile(); in the meantime, set a placeholder.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">package </span><span class="s2">= </span><span class="s1">PackageInfo</span><span class="s2">(</span><span class="s1">host</span><span class="s2">, </span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">version</span><span class="s2">)</span>

            <span class="s6"># Set true when the package has finished downloading,</span>
            <span class="s6"># either successfully or unsuccessfully.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">done </span><span class="s2">= </span><span class="s4">False</span>

            <span class="s6"># Set true or false when self.done has been set.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">success </span><span class="s2">= </span><span class="s4">False</span>

            <span class="s6"># Set true when the packageFinished() callback has been</span>
            <span class="s6"># delivered.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notified </span><span class="s2">= </span><span class="s4">False</span>

            <span class="s6"># These are used to ensure the callbacks only get</span>
            <span class="s6"># delivered once for a particular package.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">calledPackageStarted </span><span class="s2">= </span><span class="s4">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">calledPackageFinished </span><span class="s2">= </span><span class="s4">False</span>

            <span class="s6"># This is the amount of stuff we have to process to</span>
            <span class="s6"># install this package, and the amount of stuff we have</span>
            <span class="s6"># processed so far.  &quot;Stuff&quot; includes bytes downloaded,</span>
            <span class="s6"># bytes uncompressed, and bytes extracted; and each of</span>
            <span class="s6"># which is weighted differently into one grand total.  So,</span>
            <span class="s6"># the total doesn't really represent bytes; it's a</span>
            <span class="s6"># unitless number, which means something only as a ratio</span>
            <span class="s6"># to other packages.  Filled in by checkDescFile() or</span>
            <span class="s6"># getDescFile().</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadEffort </span><span class="s2">= </span><span class="s5">0</span>

            <span class="s6"># Similar, but this is the theoretical effort if the</span>
            <span class="s6"># package were already downloaded.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">prevDownloadedEffort </span><span class="s2">= </span><span class="s5">0</span>

        <span class="s4">def </span><span class="s1">__cmp__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pp</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Python comparision function.  This makes all 
            PendingPackages withe same (packageName, version, host) 
            combination be deemed equivalent. &quot;&quot;&quot;</span>
            <span class="s4">return </span><span class="s1">cmp</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">),</span>
                       <span class="s2">(</span><span class="s1">pp</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">version</span><span class="s2">, </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">host</span><span class="s2">))</span>

        <span class="s4">def </span><span class="s1">getProgress</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Returns the download progress of this package in the 
            range 0..1. &quot;&quot;&quot;</span>

            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">downloadProgress</span>

        <span class="s4">def </span><span class="s1">checkDescFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Returns true if the desc file is already downloaded 
            and good, or false if it needs to be downloaded. &quot;&quot;&quot;</span>

            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">hasCurrentContentsFile</span><span class="s2">():</span>
                <span class="s6"># If the contents file isn't ready yet, we can't check</span>
                <span class="s6"># the desc file yet.</span>
                <span class="s4">return False</span>

            <span class="s6"># All right, get the package info now.</span>
            <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">getPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s4">if not </span><span class="s1">package</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Package %s %s not known on %s&quot; </span><span class="s2">% (</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">))</span>
                <span class="s4">return False</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">package </span><span class="s2">= </span><span class="s1">package</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">checkStatus</span><span class="s2">()</span>

            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">hasDescFile</span><span class="s2">:</span>
                <span class="s4">return False</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadEffort </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">getDownloadEffort</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">prevDownloadEffort </span><span class="s2">= </span><span class="s5">0</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">downloadEffort </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">prevDownloadedEffort </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">getPrevDownloadedEffort</span><span class="s2">()</span>

            <span class="s4">return True</span>


        <span class="s4">def </span><span class="s1">getDescFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">http</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Synchronously downloads the desc files required for 
            the package. &quot;&quot;&quot;</span>

            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">downloadContentsFile</span><span class="s2">(</span><span class="s1">http</span><span class="s2">):</span>
                <span class="s4">return False</span>

            <span class="s6"># All right, get the package info now.</span>
            <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">getPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s4">if not </span><span class="s1">package</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Package %s %s not known on %s&quot; </span><span class="s2">% (</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">))</span>
                <span class="s4">return False</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">package </span><span class="s2">= </span><span class="s1">package</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">downloadDescFile</span><span class="s2">(</span><span class="s1">http</span><span class="s2">):</span>
                <span class="s4">return False</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">checkStatus</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadEffort </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">getDownloadEffort</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">prevDownloadEffort </span><span class="s2">= </span><span class="s5">0</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">downloadEffort </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">prevDownloadedEffort </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">getPrevDownloadedEffort</span><span class="s2">()</span>

            <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">appRunner</span><span class="s2">, </span><span class="s1">taskChain </span><span class="s2">= </span><span class="s3">'default'</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">globalLock</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">uniqueId </span><span class="s2">= </span><span class="s1">PackageInstaller</span><span class="s2">.</span><span class="s1">nextUniqueId</span>
            <span class="s1">PackageInstaller</span><span class="s2">.</span><span class="s1">nextUniqueId </span><span class="s2">+= </span><span class="s5">1</span>
        <span class="s4">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">globalLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner </span><span class="s2">= </span><span class="s1">appRunner</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">taskChain </span><span class="s2">= </span><span class="s1">taskChain</span>

        <span class="s6"># If we're to be running on an asynchronous task chain, and</span>
        <span class="s6"># the task chain hasn't yet been set up already, create the</span>
        <span class="s6"># default parameters now.</span>
        <span class="s4">if </span><span class="s1">taskChain </span><span class="s2">!= </span><span class="s3">'default' </span><span class="s4">and not </span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">hasTaskChain</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">taskChain</span><span class="s2">):</span>
            <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">setupTaskChain</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">taskChain</span><span class="s2">, </span><span class="s1">numThreads </span><span class="s2">= </span><span class="s5">1</span><span class="s2">,</span>
                                   <span class="s1">threadPriority </span><span class="s2">= </span><span class="s1">TPLow</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">callbackLock </span><span class="s2">= </span><span class="s1">Lock</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">calledDownloadStarted </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">calledDownloadFinished </span><span class="s2">= </span><span class="s4">False</span>

        <span class="s6"># A list of all packages that have been added to the</span>
        <span class="s6"># installer.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock </span><span class="s2">= </span><span class="s1">RLock</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">packages </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">S_initial</span>

        <span class="s6"># A list of packages that are waiting for their desc files.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">needsDescFile </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">descFileTask </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s6"># A list of packages that are waiting to be downloaded and</span>
        <span class="s6"># installed.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">needsDownload </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadTask </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s6"># A list of packages that were already done at the time they</span>
        <span class="s6"># were passed to addPackage().</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">earlyDone </span><span class="s2">= []</span>

        <span class="s6"># A list of packages that have been successfully installed, or</span>
        <span class="s6"># packages that have failed.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">done </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">failed </span><span class="s2">= []</span>

        <span class="s6"># This task is spawned on the default task chain, to update</span>
        <span class="s6"># the status during the download.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">progressTask </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">(</span><span class="s3">'PackageInstaller-%s-allHaveDesc' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">uniqueId</span><span class="s2">,</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">__allHaveDesc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">(</span><span class="s3">'PackageInstaller-%s-packageStarted' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">uniqueId</span><span class="s2">,</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">__packageStarted</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">(</span><span class="s3">'PackageInstaller-%s-packageDone' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">uniqueId</span><span class="s2">,</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">__packageDone</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Interrupts all pending downloads.  No further callbacks 
        will be made. &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cleanup</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">cleanup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Interrupts all pending downloads.  No further callbacks 
        will be made. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">descFileTask</span><span class="s2">:</span>
                <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">descFileTask</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">descFileTask </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">downloadTask</span><span class="s2">:</span>
                <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">downloadTask</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadTask </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">progressTask</span><span class="s2">:</span>
            <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">progressTask</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">progressTask </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreAll</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">addPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">version </span><span class="s2">= </span><span class="s4">None</span><span class="s2">, </span><span class="s1">hostUrl </span><span class="s2">= </span><span class="s4">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Adds the named package to the list of packages to be 
        downloaded.  Call donePackages() to finish the list. &quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">S_initial</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'addPackage called after donePackages'</span><span class="s2">)</span>

        <span class="s1">host </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner</span><span class="s2">.</span><span class="s1">getHostWithAlt</span><span class="s2">(</span><span class="s1">hostUrl</span><span class="s2">)</span>
        <span class="s1">pp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">PendingPackage</span><span class="s2">(</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">host</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__internalAddPackage</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">)</span>
        <span class="s4">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">__internalAddPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pp</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Adds the indicated &quot;pending package&quot; to the appropriate 
        list(s) for downloading and installing.  Assumes packageLock 
        is already held.&quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s1">pp </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">:</span>
            <span class="s6"># Already added.</span>
            <span class="s4">return</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">)</span>

        <span class="s6"># We always add the package to needsDescFile, even if we</span>
        <span class="s6"># already have its desc file; this guarantees that packages</span>
        <span class="s6"># are downloaded in the order they are added.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">needsDescFile</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">descFileTask</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">descFileTask </span><span class="s2">= </span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__getDescFileTask</span><span class="s2">, </span><span class="s3">'getDescFile'</span><span class="s2">,</span>
                <span class="s1">taskChain </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">taskChain</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">donePackages</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; After calling addPackage() for each package to be 
        installed, call donePackages() to mark the end of the list. 
        This is necessary to determine what the complete set of 
        packages is (and therefore how large the total download size 
        is).  None of the low-level callbacks will be made before this 
        call. &quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">S_initial</span><span class="s2">:</span>
            <span class="s6"># We've already been here.</span>
            <span class="s4">return</span>

        <span class="s6"># Throw the messages for packages that were already done</span>
        <span class="s6"># before we started.</span>
        <span class="s4">for </span><span class="s1">pp </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">earlyDone</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__donePackage</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">, </span><span class="s4">True</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">earlyDone </span><span class="s2">= []</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">S_initial</span><span class="s2">:</span>
                <span class="s4">return</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">S_ready</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">needsDescFile</span><span class="s2">:</span>
                <span class="s6"># All package desc files are already available; so begin.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__prepareToStart</span><span class="s2">()</span>
        <span class="s4">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">:</span>
            <span class="s6"># Trivial no-op.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__callDownloadFinished</span><span class="s2">(</span><span class="s4">True</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">downloadStarted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This callback is made at some point after donePackages() 
        is called; at the time of this callback, the total download 
        size is known, and we can sensibly report progress through the 
        whole. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;downloadStarted&quot;</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">packageStarted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">package</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This callback is made for each package between 
        downloadStarted() and downloadFinished() to indicate the start 
        of a new package. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;packageStarted: %s&quot; </span><span class="s2">% (</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">packageProgress</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">package</span><span class="s2">, </span><span class="s1">progress</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This callback is made repeatedly between packageStarted() 
        and packageFinished() to update the current progress on the 
        indicated package only.  The progress value ranges from 0 
        (beginning) to 1 (complete). &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;packageProgress: %s %s&quot; </span><span class="s2">% (</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">progress</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">downloadProgress</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">overallProgress</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This callback is made repeatedly between downloadStarted() 
        and downloadFinished() to update the current progress through 
        all packages.  The progress value ranges from 0 (beginning) to 
        1 (complete). &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;downloadProgress: %s&quot; </span><span class="s2">% (</span><span class="s1">overallProgress</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">packageFinished</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">package</span><span class="s2">, </span><span class="s1">success</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This callback is made for each package between 
        downloadStarted() and downloadFinished() to indicate that a 
        package has finished downloading.  If success is true, there 
        were no problems and the package is now installed. 
 
        If this package did not require downloading (because it was 
        already downloaded), this callback will be made immediately, 
        *without* a corresponding call to packageStarted(), and may 
        even be made before downloadStarted(). &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;packageFinished: %s %s&quot; </span><span class="s2">% (</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">success</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">downloadFinished</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">success</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This callback is made when all of the packages have been 
        downloaded and installed (or there has been some failure).  If 
        all packages where successfully installed, success is True. 
 
        If there were no packages that required downloading, this 
        callback will be made immediately, *without* a corresponding 
        call to downloadStarted(). &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;downloadFinished: %s&quot; </span><span class="s2">% (</span><span class="s1">success</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">__prepareToStart</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This is called internally when transitioning from S_ready 
        to S_started.  It sets up whatever initial values are 
        needed.  Assumes self.packageLock is held.  Returns False if 
        there were no packages to download, and the state was 
        therefore transitioned immediately to S_done. &quot;&quot;&quot;</span>

        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">needsDownload</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">S_done</span>
            <span class="s4">return False</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">S_started</span>

        <span class="s4">assert not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">downloadTask</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadTask </span><span class="s2">= </span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__downloadPackageTask</span><span class="s2">, </span><span class="s3">'downloadPackage'</span><span class="s2">,</span>
            <span class="s1">taskChain </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">taskChain</span><span class="s2">)</span>

        <span class="s4">assert not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">progressTask</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">progressTask </span><span class="s2">= </span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__progressTask</span><span class="s2">, </span><span class="s3">'packageProgress'</span><span class="s2">)</span>

        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">__allHaveDesc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This method is called internally when all of the pending 
        packages have their desc info. &quot;&quot;&quot;</span>
        <span class="s1">working </span><span class="s2">= </span><span class="s4">True</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">S_ready</span><span class="s2">:</span>
                <span class="s6"># We've already called donePackages(), so move on now.</span>
                <span class="s1">working </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__prepareToStart</span><span class="s2">()</span>
        <span class="s4">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

        <span class="s4">if not </span><span class="s1">working</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__callDownloadFinished</span><span class="s2">(</span><span class="s4">True</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__packageStarted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pp</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This method is called when a single package is beginning 
        to download. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__callDownloadStarted</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__callPackageStarted</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__packageDone</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pp</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This method is called when a single package has been 
        downloaded and installed, or has failed. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__callPackageFinished</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">, </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">success</span><span class="s2">)</span>
        <span class="s1">pp</span><span class="s2">.</span><span class="s1">notified </span><span class="s2">= </span><span class="s4">True</span>

        <span class="s6"># See if there are more packages to go.</span>
        <span class="s1">success </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s1">allDone </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s4">for </span><span class="s1">pp </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">notified</span><span class="s2">:</span>
                    <span class="s1">success </span><span class="s2">= </span><span class="s1">success </span><span class="s4">and </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">success</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">allDone </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s4">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

        <span class="s4">if </span><span class="s1">allDone</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__callDownloadFinished</span><span class="s2">(</span><span class="s1">success</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__callPackageStarted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pp</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Calls the packageStarted() callback for a particular 
        package if it has not already been called, being careful to 
        avoid race conditions. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">callbackLock</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">calledPackageStarted</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageStarted</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">.</span><span class="s1">package</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageProgress</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">.</span><span class="s1">package</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
                <span class="s1">pp</span><span class="s2">.</span><span class="s1">calledPackageStarted </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s4">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">callbackLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">__callPackageFinished</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pp</span><span class="s2">, </span><span class="s1">success</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Calls the packageFinished() callback for a paricular 
        package if it has not already been called, being careful to 
        avoid race conditions. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">callbackLock</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">calledPackageFinished</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">success</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">packageProgress</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">.</span><span class="s1">package</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageFinished</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">.</span><span class="s1">package</span><span class="s2">, </span><span class="s1">success</span><span class="s2">)</span>
                <span class="s1">pp</span><span class="s2">.</span><span class="s1">calledPackageFinished </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s4">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">callbackLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">__callDownloadStarted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Calls the downloadStarted() callback if it has not already 
        been called, being careful to avoid race conditions. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">callbackLock</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">calledDownloadStarted</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadStarted</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadProgress</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">calledDownloadStarted </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s4">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">callbackLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">__callDownloadFinished</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">success</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Calls the downloadFinished() callback if it has not 
        already been called, being careful to avoid race 
        conditions. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">callbackLock</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">calledDownloadFinished</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">success</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadProgress</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadFinished</span><span class="s2">(</span><span class="s1">success</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">calledDownloadFinished </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s4">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">callbackLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">__getDescFileTask</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">task</span><span class="s2">):</span>

        <span class="s0">&quot;&quot;&quot; This task runs on the aysynchronous task chain; each pass, 
        it extracts one package from self.needsDescFile and downloads 
        its desc file.  On success, it adds the package to 
        self.needsDownload. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s6"># If we've finished all of the packages that need desc</span>
            <span class="s6"># files, stop the task.</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">needsDescFile</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">descFileTask </span><span class="s2">= </span><span class="s4">None</span>

                <span class="s1">eventName </span><span class="s2">= </span><span class="s3">'PackageInstaller-%s-allHaveDesc' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">uniqueId</span>
                <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">eventName</span><span class="s2">, </span><span class="s1">taskChain </span><span class="s2">= </span><span class="s3">'default'</span><span class="s2">)</span>

                <span class="s4">return </span><span class="s1">task</span><span class="s2">.</span><span class="s1">done</span>
            <span class="s1">pp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">needsDescFile</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
            <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">needsDescFile</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s4">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

        <span class="s6"># Now serve this one package.</span>
        <span class="s4">if not </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">checkDescFile</span><span class="s2">():</span>
            <span class="s4">if not </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">getDescFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__donePackage</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">, </span><span class="s4">False</span><span class="s2">)</span>
                <span class="s4">return </span><span class="s1">task</span><span class="s2">.</span><span class="s1">cont</span>

        <span class="s6"># This package is now ready to be downloaded.  We always add</span>
        <span class="s6"># it to needsDownload, even if it's already downloaded, to</span>
        <span class="s6"># guarantee ordering of packages.</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s6"># Also add any packages required by this one.</span>
            <span class="s4">for </span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">host </span><span class="s4">in </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">:</span>
                <span class="s1">pp2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">PendingPackage</span><span class="s2">(</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">host</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__internalAddPackage</span><span class="s2">(</span><span class="s1">pp2</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">needsDownload</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">)</span>
        <span class="s4">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

        <span class="s4">return </span><span class="s1">task</span><span class="s2">.</span><span class="s1">cont</span>

    <span class="s4">def </span><span class="s1">__downloadPackageTask</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">task</span><span class="s2">):</span>

        <span class="s0">&quot;&quot;&quot; This task runs on the aysynchronous task chain; each pass, 
        it extracts one package from self.needsDownload and downloads 
        it. &quot;&quot;&quot;</span>

        <span class="s4">while True</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
            <span class="s4">try</span><span class="s2">:</span>
                <span class="s6"># If we're done downloading, stop the task.</span>
                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">S_done </span><span class="s4">or not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">needsDownload</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadTask </span><span class="s2">= </span><span class="s4">None</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>
                    <span class="s4">yield </span><span class="s1">task</span><span class="s2">.</span><span class="s1">done; </span><span class="s4">return</span>

                <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">S_started</span>
                <span class="s1">pp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">needsDownload</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
                <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">needsDownload</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
            <span class="s4">except</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>
                <span class="s4">raise</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

            <span class="s6"># Now serve this one package.</span>
            <span class="s1">eventName </span><span class="s2">= </span><span class="s3">'PackageInstaller-%s-packageStarted' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">uniqueId</span>
            <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">eventName</span><span class="s2">, [</span><span class="s1">pp</span><span class="s2">], </span><span class="s1">taskChain </span><span class="s2">= </span><span class="s3">'default'</span><span class="s2">)</span>

            <span class="s4">if not </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">hasPackage</span><span class="s2">:</span>
                <span class="s4">for </span><span class="s1">token </span><span class="s4">in </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">downloadPackageGenerator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
                    <span class="s4">if </span><span class="s1">token </span><span class="s2">== </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">stepContinue</span><span class="s2">:</span>
                        <span class="s4">yield </span><span class="s1">task</span><span class="s2">.</span><span class="s1">cont</span>
                    <span class="s4">else</span><span class="s2">:</span>
                        <span class="s4">break</span>

                <span class="s4">if </span><span class="s1">token </span><span class="s2">!= </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">stepComplete</span><span class="s2">:</span>
                    <span class="s1">pc </span><span class="s2">= </span><span class="s1">PStatCollector</span><span class="s2">(</span><span class="s3">':App:PackageInstaller:donePackage:%s' </span><span class="s2">% (</span><span class="s1">pp</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">))</span>
                    <span class="s1">pc</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">__donePackage</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">, </span><span class="s4">False</span><span class="s2">)</span>
                    <span class="s1">pc</span><span class="s2">.</span><span class="s1">stop</span><span class="s2">()</span>
                    <span class="s4">yield </span><span class="s1">task</span><span class="s2">.</span><span class="s1">cont</span>
                    <span class="s4">continue</span>

            <span class="s6"># Successfully downloaded and installed.</span>
            <span class="s1">pc </span><span class="s2">= </span><span class="s1">PStatCollector</span><span class="s2">(</span><span class="s3">':App:PackageInstaller:donePackage:%s' </span><span class="s2">% (</span><span class="s1">pp</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">))</span>
            <span class="s1">pc</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__donePackage</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">, </span><span class="s4">True</span><span class="s2">)</span>
            <span class="s1">pc</span><span class="s2">.</span><span class="s1">stop</span><span class="s2">()</span>

            <span class="s6"># Continue the loop without yielding, so we pick up the</span>
            <span class="s6"># next package within this same frame.</span>

    <span class="s4">def </span><span class="s1">__donePackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pp</span><span class="s2">, </span><span class="s1">success</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Marks the indicated package as done, either successfully 
        or otherwise. &quot;&quot;&quot;</span>
        <span class="s4">assert not </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">done</span>

        <span class="s4">if </span><span class="s1">success</span><span class="s2">:</span>
            <span class="s1">pc </span><span class="s2">= </span><span class="s1">PStatCollector</span><span class="s2">(</span><span class="s3">':App:PackageInstaller:install:%s' </span><span class="s2">% (</span><span class="s1">pp</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">))</span>
            <span class="s1">pc</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>
            <span class="s1">pp</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">installPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner</span><span class="s2">)</span>
            <span class="s1">pc</span><span class="s2">.</span><span class="s1">stop</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">pp</span><span class="s2">.</span><span class="s1">done </span><span class="s2">= </span><span class="s4">True</span>
            <span class="s1">pp</span><span class="s2">.</span><span class="s1">success </span><span class="s2">= </span><span class="s1">success</span>
            <span class="s4">if </span><span class="s1">success</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">done</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">failed</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">)</span>
        <span class="s4">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

        <span class="s1">eventName </span><span class="s2">= </span><span class="s3">'PackageInstaller-%s-packageDone' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">uniqueId</span>
        <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">eventName</span><span class="s2">, [</span><span class="s1">pp</span><span class="s2">], </span><span class="s1">taskChain </span><span class="s2">= </span><span class="s3">'default'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__progressTask</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">task</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">callbackLock</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">calledDownloadStarted</span><span class="s2">:</span>
                <span class="s6"># We haven't yet officially started the download.</span>
                <span class="s4">return </span><span class="s1">task</span><span class="s2">.</span><span class="s1">cont</span>

            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">calledDownloadFinished</span><span class="s2">:</span>
                <span class="s6"># We've officially ended the download.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">progressTask </span><span class="s2">= </span><span class="s4">None</span>
                <span class="s4">return </span><span class="s1">task</span><span class="s2">.</span><span class="s1">done</span>

            <span class="s1">downloadEffort </span><span class="s2">= </span><span class="s5">0</span>
            <span class="s1">currentDownloadSize </span><span class="s2">= </span><span class="s5">0</span>
            <span class="s4">for </span><span class="s1">pp </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">:</span>
                <span class="s1">downloadEffort </span><span class="s2">+= </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">downloadEffort </span><span class="s2">+ </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">prevDownloadedEffort</span>
                <span class="s1">packageProgress </span><span class="s2">= </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">getProgress</span><span class="s2">()</span>
                <span class="s1">currentDownloadSize </span><span class="s2">+= </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">downloadEffort </span><span class="s2">* </span><span class="s1">packageProgress </span><span class="s2">+ </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">prevDownloadedEffort</span>
                <span class="s4">if </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">calledPackageStarted </span><span class="s4">and not </span><span class="s1">pp</span><span class="s2">.</span><span class="s1">calledPackageFinished</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">packageProgress</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">.</span><span class="s1">package</span><span class="s2">, </span><span class="s1">packageProgress</span><span class="s2">)</span>

            <span class="s4">if not </span><span class="s1">downloadEffort</span><span class="s2">:</span>
                <span class="s1">progress </span><span class="s2">= </span><span class="s5">1</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">progress </span><span class="s2">= </span><span class="s1">float</span><span class="s2">(</span><span class="s1">currentDownloadSize</span><span class="s2">) / </span><span class="s1">float</span><span class="s2">(</span><span class="s1">downloadEffort</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadProgress</span><span class="s2">(</span><span class="s1">progress</span><span class="s2">)</span>

        <span class="s4">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">callbackLock</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

        <span class="s4">return </span><span class="s1">task</span><span class="s2">.</span><span class="s1">cont</span>

</pre>
</body>
</html>