<html>
<head>
<title>DistributedSmoothNode.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
DistributedSmoothNode.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;DistributedSmoothNode module: contains the DistributedSmoothNode class&quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s1">panda3d</span><span class="s3">.</span><span class="s1">core </span><span class="s2">import </span><span class="s3">*</span>
<span class="s2">from </span><span class="s1">panda3d</span><span class="s3">.</span><span class="s1">direct </span><span class="s2">import </span><span class="s3">*</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">ClockDelta </span><span class="s2">import </span><span class="s3">*</span>
<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">DistributedNode</span>
<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">DistributedSmoothNodeBase</span>
<span class="s2">from </span><span class="s1">direct</span><span class="s3">.</span><span class="s1">task</span><span class="s3">.</span><span class="s1">Task </span><span class="s2">import </span><span class="s1">cont</span>
<span class="s2">from </span><span class="s1">direct</span><span class="s3">.</span><span class="s1">showbase </span><span class="s2">import </span><span class="s1">DConfig </span><span class="s2">as </span><span class="s1">config</span>

<span class="s4"># This number defines our tolerance for out-of-sync telemetry packets.</span>
<span class="s4"># If a packet appears to have originated from more than MaxFuture</span>
<span class="s4"># seconds in the future, assume we're out of sync with the other</span>
<span class="s4"># avatar and suggest a resync for both.</span>
<span class="s1">MaxFuture </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">GetFloat</span><span class="s3">(</span><span class="s5">&quot;smooth-max-future&quot;</span><span class="s3">, </span><span class="s6">0.2</span><span class="s3">)</span>

<span class="s4"># How frequently can we suggest a resynchronize with another client?</span>
<span class="s1">MinSuggestResync </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">GetFloat</span><span class="s3">(</span><span class="s5">&quot;smooth-min-suggest-resync&quot;</span><span class="s3">, </span><span class="s6">15</span><span class="s3">)</span>

<span class="s4"># These flags indicate whether global smoothing and/or prediction is</span>
<span class="s4"># allowed or disallowed.</span>
<span class="s1">EnableSmoothing </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">GetBool</span><span class="s3">(</span><span class="s5">&quot;smooth-enable-smoothing&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
<span class="s1">EnablePrediction </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">GetBool</span><span class="s3">(</span><span class="s5">&quot;smooth-enable-prediction&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>

<span class="s4"># These values represent the amount of time, in seconds, to delay the</span>
<span class="s4"># apparent position of other avatars, when non-predictive and</span>
<span class="s4"># predictive smoothing is in effect, respectively.  This is in</span>
<span class="s4"># addition to the automatic delay of the observed average latency from</span>
<span class="s4"># each avatar, which is intended to compensate for relative clock</span>
<span class="s4"># skew.</span>
<span class="s1">Lag </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">GetDouble</span><span class="s3">(</span><span class="s5">&quot;smooth-lag&quot;</span><span class="s3">, </span><span class="s6">0.2</span><span class="s3">)</span>
<span class="s1">PredictionLag </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">GetDouble</span><span class="s3">(</span><span class="s5">&quot;smooth-prediction-lag&quot;</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">)</span>


<span class="s1">GlobalSmoothing </span><span class="s3">= </span><span class="s6">0</span>
<span class="s1">GlobalPrediction </span><span class="s3">= </span><span class="s6">0</span>
<span class="s2">def </span><span class="s1">globalActivateSmoothing</span><span class="s3">(</span><span class="s1">smoothing</span><span class="s3">, </span><span class="s1">prediction</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; Globally activates or deactivates smoothing and prediction on 
    all DistributedSmoothNodes currently in existence, or yet to be 
    generated. &quot;&quot;&quot;</span>

    <span class="s2">global </span><span class="s1">GlobalSmoothing</span><span class="s3">, </span><span class="s1">GlobalPrediction</span>
    <span class="s1">GlobalSmoothing </span><span class="s3">= </span><span class="s1">smoothing</span>
    <span class="s1">GlobalPrediction </span><span class="s3">= </span><span class="s1">prediction</span>

    <span class="s2">for </span><span class="s1">obj </span><span class="s2">in </span><span class="s1">base</span><span class="s3">.</span><span class="s1">cr</span><span class="s3">.</span><span class="s1">getAllOfType</span><span class="s3">(</span><span class="s1">DistributedSmoothNode</span><span class="s3">):</span>
        <span class="s1">obj</span><span class="s3">.</span><span class="s1">activateSmoothing</span><span class="s3">(</span><span class="s1">smoothing</span><span class="s3">, </span><span class="s1">prediction</span><span class="s3">)</span>

<span class="s4"># For historical reasons, we temporarily define</span>
<span class="s4"># DistributedSmoothNode.activateSmoothing() to be the global function.</span>
<span class="s4"># We'll remove this soon, so it won't get confused with the instance</span>
<span class="s4"># method, below.</span>
<span class="s1">activateSmoothing </span><span class="s3">= </span><span class="s1">globalActivateSmoothing</span>


<span class="s2">class </span><span class="s1">DistributedSmoothNode</span><span class="s3">(</span><span class="s1">DistributedNode</span><span class="s3">.</span><span class="s1">DistributedNode</span><span class="s3">,</span>
                            <span class="s1">DistributedSmoothNodeBase</span><span class="s3">.</span><span class="s1">DistributedSmoothNodeBase</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    This specializes DistributedNode to add functionality to smooth 
    motion over time, via the SmoothMover C++ object defined in 
    DIRECT. 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">cr</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">DistributedSmoothNode_initialized</span>
        <span class="s2">except</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">DistributedSmoothNode_initialized </span><span class="s3">= </span><span class="s6">1</span>
            <span class="s1">DistributedNode</span><span class="s3">.</span><span class="s1">DistributedNode</span><span class="s3">.</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">cr</span><span class="s3">)</span>
            <span class="s1">DistributedSmoothNodeBase</span><span class="s3">.</span><span class="s1">DistributedSmoothNodeBase</span><span class="s3">.</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">smoothStarted </span><span class="s3">= </span><span class="s6">0</span>

            <span class="s4"># Set this True to assert that the local process has</span>
            <span class="s4"># complete authority over the position of this object when</span>
            <span class="s4"># smoothing is not in effect.  When this is True, position</span>
            <span class="s4"># reports received over the wire will not be applied to</span>
            <span class="s4"># this node's position, unless those position reports are</span>
            <span class="s4"># received between startSmooth() and endSmooth().</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">localControl </span><span class="s3">= </span><span class="s2">False</span>

            <span class="s4"># flag set when we receive a stop message</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">stopped </span><span class="s3">= </span><span class="s2">False</span>

    <span class="s2">def </span><span class="s1">generate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother </span><span class="s3">= </span><span class="s1">SmoothMover</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoothStarted </span><span class="s3">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">lastSuggestResync </span><span class="s3">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_smoothWrtReparents </span><span class="s3">= </span><span class="s2">False</span>

        <span class="s1">DistributedNode</span><span class="s3">.</span><span class="s1">DistributedNode</span><span class="s3">.</span><span class="s1">generate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s1">DistributedSmoothNodeBase</span><span class="s3">.</span><span class="s1">DistributedSmoothNodeBase</span><span class="s3">.</span><span class="s1">generate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cnode</span><span class="s3">.</span><span class="s1">setRepository</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">cr</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">activateSmoothing</span><span class="s3">(</span><span class="s1">GlobalSmoothing</span><span class="s3">, </span><span class="s1">GlobalPrediction</span><span class="s3">)</span>

        <span class="s4"># clear stopped flag for re-generate</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">stopped </span><span class="s3">= </span><span class="s2">False</span>

    <span class="s2">def </span><span class="s1">disable</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">DistributedSmoothNodeBase</span><span class="s3">.</span><span class="s1">DistributedSmoothNodeBase</span><span class="s3">.</span><span class="s1">disable</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s1">DistributedNode</span><span class="s3">.</span><span class="s1">DistributedNode</span><span class="s3">.</span><span class="s1">disable</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s2">del </span><span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span>

    <span class="s2">def </span><span class="s1">delete</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">DistributedSmoothNodeBase</span><span class="s3">.</span><span class="s1">DistributedSmoothNodeBase</span><span class="s3">.</span><span class="s1">delete</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s1">DistributedNode</span><span class="s3">.</span><span class="s1">DistributedNode</span><span class="s3">.</span><span class="s1">delete</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>

    <span class="s4">### Methods to handle computing and updating of the smoothed</span>
    <span class="s4">### position.</span>

    <span class="s2">def </span><span class="s1">smoothPosition</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        This function updates the position of the node to its computed 
        smoothed position.  This may be overridden by a derived class 
        to specialize the behavior. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">computeAndApplySmoothPosHpr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">self</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">doSmoothTask</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">task</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoothPosition</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">cont</span>

    <span class="s2">def </span><span class="s1">wantsSmoothing</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># Override this function to return 0 if this particular kind</span>
        <span class="s4"># of smooth node doesn't really want to be smoothed.</span>
        <span class="s2">return </span><span class="s6">1</span>

    <span class="s2">def </span><span class="s1">startSmooth</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        This function starts the task that ensures the node is 
        positioned correctly every frame.  However, while the task is 
        running, you won't be able to lerp the node or directly 
        position it. 
        &quot;&quot;&quot;</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wantsSmoothing</span><span class="s3">() </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">isDisabled</span><span class="s3">() </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">isLocal</span><span class="s3">():</span>
            <span class="s2">return</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">smoothStarted</span><span class="s3">:</span>
            <span class="s1">taskName </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">taskName</span><span class="s3">(</span><span class="s5">&quot;smooth&quot;</span><span class="s3">)</span>
            <span class="s1">taskMgr</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">taskName</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">reloadPosition</span><span class="s3">()</span>
            <span class="s1">taskMgr</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">doSmoothTask</span><span class="s3">, </span><span class="s1">taskName</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">smoothStarted </span><span class="s3">= </span><span class="s6">1</span>

    <span class="s2">def </span><span class="s1">stopSmooth</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        This function stops the task spawned by startSmooth(), and 
        allows show code to move the node around directly. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">smoothStarted</span><span class="s3">:</span>
            <span class="s1">taskName </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">taskName</span><span class="s3">(</span><span class="s5">&quot;smooth&quot;</span><span class="s3">)</span>
            <span class="s1">taskMgr</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">taskName</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">forceToTruePosition</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">smoothStarted </span><span class="s3">= </span><span class="s6">0</span>

    <span class="s2">def </span><span class="s1">setSmoothWrtReparents</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">flag</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_smoothWrtReparents </span><span class="s3">= </span><span class="s1">flag</span>
    <span class="s2">def </span><span class="s1">getSmoothWrtReparents</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_smoothWrtReparents</span>

    <span class="s2">def </span><span class="s1">forceToTruePosition</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        This forces the node to reposition itself to its latest known 
        position.  This may result in a pop as the node skips the last 
        of its lerp points. 
        &quot;&quot;&quot;</span>
        <span class="s4">#printStack()</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s2">not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">isLocal</span><span class="s3">()) </span><span class="s2">and </span><span class="s1">\</span>
           <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">getLatestPosition</span><span class="s3">():</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">applySmoothPosHpr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">self</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">clearPositions</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">reloadPosition</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        This function re-reads the position from the node itself and 
        clears any old position reports for the node.  This should be 
        used whenever show code bangs on the node position and expects 
        it to stick. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">clearPositions</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setPosHpr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">getPos</span><span class="s3">(), </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getHpr</span><span class="s3">())</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setPhonyTimestamp</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">markPosition</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_checkResume</span><span class="s3">(</span><span class="s1">self</span><span class="s3">,</span><span class="s1">timestamp</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Determine if we were previously stopped and now need to 
        resume movement by making sure any old stored positions 
        reflect the node's current position 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">stopped</span><span class="s3">):</span>
            <span class="s1">currTime </span><span class="s3">= </span><span class="s1">globalClock</span><span class="s3">.</span><span class="s1">getFrameTime</span><span class="s3">()</span>
            <span class="s1">now </span><span class="s3">= </span><span class="s1">currTime </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">getExpectedBroadcastPeriod</span><span class="s3">()</span>
            <span class="s1">last </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">getMostRecentTimestamp</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">now </span><span class="s3">&gt; </span><span class="s1">last</span><span class="s3">):</span>
                <span class="s4"># only set a new timestamp postion if we still have</span>
                <span class="s4"># a position being smoothed to (so we don't interrupt</span>
                <span class="s4"># any current smoothing and only do this if the object</span>
                <span class="s4"># is actually locally stopped)</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">timestamp </span><span class="s3">== </span><span class="s2">None</span><span class="s3">):</span>
                    <span class="s4"># no timestamp, use current time</span>
                    <span class="s1">local </span><span class="s3">= </span><span class="s6">0.0</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">local </span><span class="s3">= </span><span class="s1">globalClockDelta</span><span class="s3">.</span><span class="s1">networkToLocalTime</span><span class="s3">(</span>
                        <span class="s1">timestamp</span><span class="s3">, </span><span class="s1">currTime</span><span class="s3">)</span>

                <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setPhonyTimestamp</span><span class="s3">(</span><span class="s1">local</span><span class="s3">,</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">markPosition</span><span class="s3">()</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">stopped </span><span class="s3">= </span><span class="s2">False</span>

    <span class="s4"># distributed set pos and hpr functions</span>
    <span class="s4"># 'send' versions are inherited from DistributedSmoothNodeBase</span>
    <span class="s2">def </span><span class="s1">setSmStop</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">timestamp</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentTLive</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">stopped </span><span class="s3">= </span><span class="s2">True</span>
    <span class="s2">def </span><span class="s1">setSmH</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">h</span><span class="s3">, </span><span class="s1">timestamp</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_checkResume</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentH</span><span class="s3">(</span><span class="s1">h</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentTLive</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setSmZ</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">timestamp</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_checkResume</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentZ</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentTLive</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setSmXY</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">timestamp</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_checkResume</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentX</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentY</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentTLive</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setSmXZ</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">timestamp</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_checkResume</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentX</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentZ</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentTLive</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setSmPos</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">timestamp</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_checkResume</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentX</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentY</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentZ</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentTLive</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setSmHpr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">h</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">r</span><span class="s3">, </span><span class="s1">timestamp</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_checkResume</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentH</span><span class="s3">(</span><span class="s1">h</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentP</span><span class="s3">(</span><span class="s1">p</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentR</span><span class="s3">(</span><span class="s1">r</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentTLive</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setSmXYH</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">h</span><span class="s3">, </span><span class="s1">timestamp</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_checkResume</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentX</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentY</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentH</span><span class="s3">(</span><span class="s1">h</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentTLive</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setSmXYZH</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">h</span><span class="s3">, </span><span class="s1">timestamp</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_checkResume</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentX</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentY</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentZ</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentH</span><span class="s3">(</span><span class="s1">h</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentTLive</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setSmPosHpr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">h</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">r</span><span class="s3">, </span><span class="s1">timestamp</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_checkResume</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentX</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentY</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentZ</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentH</span><span class="s3">(</span><span class="s1">h</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentP</span><span class="s3">(</span><span class="s1">p</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentR</span><span class="s3">(</span><span class="s1">r</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentTLive</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">setSmPosHprL</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">l</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">h</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">r</span><span class="s3">, </span><span class="s1">timestamp</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_checkResume</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentL</span><span class="s3">(</span><span class="s1">l</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentX</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentY</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentZ</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentH</span><span class="s3">(</span><span class="s1">h</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentP</span><span class="s3">(</span><span class="s1">p</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentR</span><span class="s3">(</span><span class="s1">r</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setComponentTLive</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">)</span>

    <span class="s4">### component set pos and hpr functions ###</span>

    <span class="s4">### These are the component functions that are invoked</span>
    <span class="s4">### remotely by the above composite functions.</span>

    <span class="s3">@</span><span class="s1">report</span><span class="s3">(</span><span class="s1">types </span><span class="s3">= [</span><span class="s5">'args'</span><span class="s3">], </span><span class="s1">dConfigParam </span><span class="s3">= </span><span class="s5">'smoothnode'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setComponentX</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setX</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">report</span><span class="s3">(</span><span class="s1">types </span><span class="s3">= [</span><span class="s5">'args'</span><span class="s3">], </span><span class="s1">dConfigParam </span><span class="s3">= </span><span class="s5">'smoothnode'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setComponentY</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setY</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">report</span><span class="s3">(</span><span class="s1">types </span><span class="s3">= [</span><span class="s5">'args'</span><span class="s3">], </span><span class="s1">dConfigParam </span><span class="s3">= </span><span class="s5">'smoothnode'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setComponentZ</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setZ</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">report</span><span class="s3">(</span><span class="s1">types </span><span class="s3">= [</span><span class="s5">'args'</span><span class="s3">], </span><span class="s1">dConfigParam </span><span class="s3">= </span><span class="s5">'smoothnode'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setComponentH</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">h</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setH</span><span class="s3">(</span><span class="s1">h</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">report</span><span class="s3">(</span><span class="s1">types </span><span class="s3">= [</span><span class="s5">'args'</span><span class="s3">], </span><span class="s1">dConfigParam </span><span class="s3">= </span><span class="s5">'smoothnode'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setComponentP</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">p</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setP</span><span class="s3">(</span><span class="s1">p</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">report</span><span class="s3">(</span><span class="s1">types </span><span class="s3">= [</span><span class="s5">'args'</span><span class="s3">], </span><span class="s1">dConfigParam </span><span class="s3">= </span><span class="s5">'smoothnode'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setComponentR</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">r</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setR</span><span class="s3">(</span><span class="s1">r</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">report</span><span class="s3">(</span><span class="s1">types </span><span class="s3">= [</span><span class="s5">'args'</span><span class="s3">], </span><span class="s1">dConfigParam </span><span class="s3">= </span><span class="s5">'smoothnode'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setComponentL</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">l</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">l </span><span class="s3">!= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">zoneId</span><span class="s3">):</span>
            <span class="s4"># only perform set location if location is different</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">setLocation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">parentId</span><span class="s3">,</span><span class="s1">l</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">report</span><span class="s3">(</span><span class="s1">types </span><span class="s3">= [</span><span class="s5">'args'</span><span class="s3">], </span><span class="s1">dConfigParam </span><span class="s3">= </span><span class="s5">'smoothnode'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setComponentT</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">timestamp</span><span class="s3">):</span>
        <span class="s4"># This is a little bit hacky.  If *this* function is called,</span>
        <span class="s4"># it must have been called directly by the server, for</span>
        <span class="s4"># instance to update the values previously set for some avatar</span>
        <span class="s4"># that was already into the zone as we entered.  (A live</span>
        <span class="s4"># update would have gone through the function called</span>
        <span class="s4"># setComponentTLive, below.)</span>

        <span class="s4"># Since we know this update came through the server, it may</span>
        <span class="s4"># reflect very old data.  Thus, we can't accurately decode the</span>
        <span class="s4"># network timestamp (since the network time encoding can only</span>
        <span class="s4"># represent a time up to about 5 minutes in the past), but we</span>
        <span class="s4"># don't really need to know the timestamp anyway.  We'll just</span>
        <span class="s4"># arbitrarily place it at right now.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setPhonyTimestamp</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">clearPositions</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">markPosition</span><span class="s3">()</span>

        <span class="s4"># mark position only takes most recent position sent over the wire</span>
        <span class="s4"># and applies it to the smoother's sample points, but we still</span>
        <span class="s4"># need to make sure and apply that position to the actual node</span>
        <span class="s4"># path</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">forceToTruePosition</span><span class="s3">()</span>

    <span class="s3">@</span><span class="s1">report</span><span class="s3">(</span><span class="s1">types </span><span class="s3">= [</span><span class="s5">'args'</span><span class="s3">], </span><span class="s1">dConfigParam </span><span class="s3">= </span><span class="s5">'smoothnode'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">setComponentTLive</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">timestamp</span><span class="s3">):</span>
        <span class="s4"># This is the variant of setComponentT() that will be called</span>
        <span class="s4"># whenever we receive a live update directly from the other</span>
        <span class="s4"># client.  This is because the component functions, above,</span>
        <span class="s4"># call this function explicitly instead of setComponentT().</span>

        <span class="s4">#print 'setComponentTLive: %s' % timestamp</span>

        <span class="s2">if </span><span class="s1">timestamp </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s4"># if no timestamp, re-use the most recent timestamp to keep things</span>
            <span class="s4"># from getting out of order</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">hasMostRecentTimestamp</span><span class="s3">():</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setTimestamp</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">getMostRecentTimestamp</span><span class="s3">())</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s4"># no most-recent timestamp, use current time</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setPhonyTimestamp</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">markPosition</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">now </span><span class="s3">= </span><span class="s1">globalClock</span><span class="s3">.</span><span class="s1">getFrameTime</span><span class="s3">()</span>
            <span class="s1">local </span><span class="s3">= </span><span class="s1">globalClockDelta</span><span class="s3">.</span><span class="s1">networkToLocalTime</span><span class="s3">(</span><span class="s1">timestamp</span><span class="s3">, </span><span class="s1">now</span><span class="s3">)</span>
            <span class="s1">realTime </span><span class="s3">= </span><span class="s1">globalClock</span><span class="s3">.</span><span class="s1">getRealTime</span><span class="s3">()</span>
            <span class="s1">chug </span><span class="s3">= </span><span class="s1">realTime </span><span class="s3">- </span><span class="s1">now</span>

            <span class="s4"># Sanity check the timestamp from the other avatar.  It should</span>
            <span class="s4"># be just slightly in the past, but it might be off by as much</span>
            <span class="s4"># as this frame's amount of time forward or back.</span>
            <span class="s1">howFarFuture </span><span class="s3">= </span><span class="s1">local </span><span class="s3">- </span><span class="s1">now</span>
            <span class="s2">if </span><span class="s1">howFarFuture </span><span class="s3">- </span><span class="s1">chug </span><span class="s3">&gt;= </span><span class="s1">MaxFuture</span><span class="s3">:</span>
                <span class="s4"># Too far off; advise the other client of our clock information.</span>
                <span class="s2">if </span><span class="s1">globalClockDelta</span><span class="s3">.</span><span class="s1">getUncertainty</span><span class="s3">() != </span><span class="s2">None and </span><span class="s1">\</span>
                   <span class="s1">realTime </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">lastSuggestResync </span><span class="s3">&gt;= </span><span class="s1">MinSuggestResync </span><span class="s2">and </span><span class="s1">\</span>
                   <span class="s1">hasattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">cr</span><span class="s3">, </span><span class="s5">'localAvatarDoId'</span><span class="s3">):</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">lastSuggestResync </span><span class="s3">= </span><span class="s1">realTime</span>
                    <span class="s1">timestampB </span><span class="s3">= </span><span class="s1">globalClockDelta</span><span class="s3">.</span><span class="s1">localToNetworkTime</span><span class="s3">(</span><span class="s1">realTime</span><span class="s3">)</span>
                    <span class="s1">serverTime </span><span class="s3">= </span><span class="s1">realTime </span><span class="s3">- </span><span class="s1">globalClockDelta</span><span class="s3">.</span><span class="s1">getDelta</span><span class="s3">()</span>
                    <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span>
                        <span class="s5">&quot;Suggesting resync for %s, with discrepency %s; local time is %s and server time is %s.&quot; </span><span class="s3">% (</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">doId</span><span class="s3">, </span><span class="s1">howFarFuture </span><span class="s3">- </span><span class="s1">chug</span><span class="s3">,</span>
                        <span class="s1">realTime</span><span class="s3">, </span><span class="s1">serverTime</span><span class="s3">))</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">d_suggestResync</span><span class="s3">(</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">cr</span><span class="s3">.</span><span class="s1">localAvatarDoId</span><span class="s3">, </span><span class="s1">timestamp</span><span class="s3">,</span>
                        <span class="s1">timestampB</span><span class="s3">, </span><span class="s1">serverTime</span><span class="s3">,</span>
                        <span class="s1">globalClockDelta</span><span class="s3">.</span><span class="s1">getUncertainty</span><span class="s3">())</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setTimestamp</span><span class="s3">(</span><span class="s1">local</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">markPosition</span><span class="s3">()</span>

        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">localControl </span><span class="s2">and not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">smoothStarted </span><span class="s2">and </span><span class="s1">\</span>
           <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">getLatestPosition</span><span class="s3">():</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">applySmoothPosHpr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">self</span><span class="s3">)</span>

    <span class="s4"># These are all required by the CMU server, which requires get* to</span>
    <span class="s4"># match set* in more cases than the Disney server does.</span>
    <span class="s2">def </span><span class="s1">getComponentL</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">zoneId</span>
    <span class="s2">def </span><span class="s1">getComponentX</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getX</span><span class="s3">()</span>
    <span class="s2">def </span><span class="s1">getComponentY</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getY</span><span class="s3">()</span>
    <span class="s2">def </span><span class="s1">getComponentZ</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getZ</span><span class="s3">()</span>
    <span class="s2">def </span><span class="s1">getComponentH</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getH</span><span class="s3">()</span>
    <span class="s2">def </span><span class="s1">getComponentP</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getP</span><span class="s3">()</span>
    <span class="s2">def </span><span class="s1">getComponentR</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getR</span><span class="s3">()</span>
    <span class="s2">def </span><span class="s1">getComponentT</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s6">0</span>

    <span class="s3">@</span><span class="s1">report</span><span class="s3">(</span><span class="s1">types </span><span class="s3">= [</span><span class="s5">'args'</span><span class="s3">], </span><span class="s1">dConfigParam </span><span class="s3">= </span><span class="s5">'smoothnode'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">clearSmoothing</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">bogus </span><span class="s3">= </span><span class="s2">None</span><span class="s3">):</span>
        <span class="s4"># Call this to invalidate all the old position reports</span>
        <span class="s4"># (e.g. just before popping to a new position).</span>
        <span class="s4">#printStack()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">clearPositions</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)</span>


    <span class="s3">@</span><span class="s1">report</span><span class="s3">(</span><span class="s1">types </span><span class="s3">= [</span><span class="s5">'args'</span><span class="s3">], </span><span class="s1">dConfigParam </span><span class="s3">= </span><span class="s5">'smoothnode'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">wrtReparentTo</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">parent</span><span class="s3">):</span>
        <span class="s4"># We override this NodePath method to force it to</span>
        <span class="s4"># automatically reset the smoothing position when we call it.</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">smoothStarted</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_smoothWrtReparents</span><span class="s3">:</span>
                <span class="s4">#print self.getParent(), parent, self.getParent().getPos(parent)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">handleWrtReparent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">getParent</span><span class="s3">(), </span><span class="s1">parent</span><span class="s3">)</span>
                <span class="s1">NodePath</span><span class="s3">.</span><span class="s1">wrtReparentTo</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">parent</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">forceToTruePosition</span><span class="s3">()</span>
                <span class="s1">NodePath</span><span class="s3">.</span><span class="s1">wrtReparentTo</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">parent</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">reloadPosition</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">NodePath</span><span class="s3">.</span><span class="s1">wrtReparentTo</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">parent</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">report</span><span class="s3">(</span><span class="s1">types </span><span class="s3">= [</span><span class="s5">'args'</span><span class="s3">], </span><span class="s1">dConfigParam </span><span class="s3">= </span><span class="s5">'smoothnode'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">d_setParent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">parentToken</span><span class="s3">):</span>
        <span class="s4"># We override this DistributedNode method to force a full position</span>
        <span class="s4"># update immediately after the distributed setParent is sent.</span>
        <span class="s4"># See ParentMgr.py for an explanation.</span>
        <span class="s1">DistributedNode</span><span class="s3">.</span><span class="s1">DistributedNode</span><span class="s3">.</span><span class="s1">d_setParent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">parentToken</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">forceToTruePosition</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sendCurrentPosition</span><span class="s3">()</span>

    <span class="s4">### Monitor clock sync ###</span>

    <span class="s2">def </span><span class="s1">d_suggestResync</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">avId</span><span class="s3">, </span><span class="s1">timestampA</span><span class="s3">, </span><span class="s1">timestampB</span><span class="s3">,</span>
                        <span class="s1">serverTime</span><span class="s3">, </span><span class="s1">uncertainty</span><span class="s3">):</span>
        <span class="s1">serverTimeSec </span><span class="s3">= </span><span class="s1">math</span><span class="s3">.</span><span class="s1">floor</span><span class="s3">(</span><span class="s1">serverTime</span><span class="s3">)</span>
        <span class="s1">serverTimeUSec </span><span class="s3">= (</span><span class="s1">serverTime </span><span class="s3">- </span><span class="s1">serverTimeSec</span><span class="s3">) * </span><span class="s6">10000.0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sendUpdate</span><span class="s3">(</span><span class="s5">&quot;suggestResync&quot;</span><span class="s3">, [</span><span class="s1">avId</span><span class="s3">, </span><span class="s1">timestampA</span><span class="s3">, </span><span class="s1">timestampB</span><span class="s3">,</span>
                                          <span class="s1">serverTimeSec</span><span class="s3">, </span><span class="s1">serverTimeUSec</span><span class="s3">,</span>
                                          <span class="s1">uncertainty</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">suggestResync</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">avId</span><span class="s3">, </span><span class="s1">timestampA</span><span class="s3">, </span><span class="s1">timestampB</span><span class="s3">,</span>
                      <span class="s1">serverTimeSec</span><span class="s3">, </span><span class="s1">serverTimeUSec</span><span class="s3">, </span><span class="s1">uncertainty</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        This message is sent from one client to another when the other 
        client receives a timestamp from this client that is so far 
        out of date as to suggest that one or both clients needs to 
        resynchronize their clock information. 
        &quot;&quot;&quot;</span>
        <span class="s1">serverTime </span><span class="s3">= </span><span class="s1">float</span><span class="s3">(</span><span class="s1">serverTimeSec</span><span class="s3">) + </span><span class="s1">float</span><span class="s3">(</span><span class="s1">serverTimeUSec</span><span class="s3">) / </span><span class="s6">10000.0</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">peerToPeerResync</span><span class="s3">(</span>
            <span class="s1">avId</span><span class="s3">, </span><span class="s1">timestampA</span><span class="s3">, </span><span class="s1">serverTime</span><span class="s3">, </span><span class="s1">uncertainty</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">result </span><span class="s3">&gt;= </span><span class="s6">0 </span><span class="s2">and </span><span class="s1">\</span>
           <span class="s1">globalClockDelta</span><span class="s3">.</span><span class="s1">getUncertainty</span><span class="s3">() != </span><span class="s2">None</span><span class="s3">:</span>
            <span class="s1">other </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cr</span><span class="s3">.</span><span class="s1">doId2do</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">avId</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s2">not </span><span class="s1">other</span><span class="s3">):</span>
                <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span>
                    <span class="s5">&quot;Warning: couldn't find the avatar %d&quot; </span><span class="s3">% (</span><span class="s1">avId</span><span class="s3">))</span>
            <span class="s2">elif </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">other</span><span class="s3">, </span><span class="s5">&quot;d_returnResync&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">\</span>
                 <span class="s1">hasattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">cr</span><span class="s3">, </span><span class="s5">'localAvatarDoId'</span><span class="s3">):</span>
                <span class="s1">realTime </span><span class="s3">= </span><span class="s1">globalClock</span><span class="s3">.</span><span class="s1">getRealTime</span><span class="s3">()</span>
                <span class="s1">serverTime </span><span class="s3">= </span><span class="s1">realTime </span><span class="s3">- </span><span class="s1">globalClockDelta</span><span class="s3">.</span><span class="s1">getDelta</span><span class="s3">()</span>
                <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span>
                    <span class="s5">&quot;Returning resync for %s; local time is %s and server time is %s.&quot; </span><span class="s3">% (</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">doId</span><span class="s3">, </span><span class="s1">realTime</span><span class="s3">, </span><span class="s1">serverTime</span><span class="s3">))</span>
                <span class="s1">other</span><span class="s3">.</span><span class="s1">d_returnResync</span><span class="s3">(</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">cr</span><span class="s3">.</span><span class="s1">localAvatarDoId</span><span class="s3">, </span><span class="s1">timestampB</span><span class="s3">,</span>
                    <span class="s1">serverTime</span><span class="s3">,</span>
                    <span class="s1">globalClockDelta</span><span class="s3">.</span><span class="s1">getUncertainty</span><span class="s3">())</span>


    <span class="s2">def </span><span class="s1">d_returnResync</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">avId</span><span class="s3">, </span><span class="s1">timestampB</span><span class="s3">, </span><span class="s1">serverTime</span><span class="s3">, </span><span class="s1">uncertainty</span><span class="s3">):</span>
        <span class="s1">serverTimeSec </span><span class="s3">= </span><span class="s1">math</span><span class="s3">.</span><span class="s1">floor</span><span class="s3">(</span><span class="s1">serverTime</span><span class="s3">)</span>
        <span class="s1">serverTimeUSec </span><span class="s3">= (</span><span class="s1">serverTime </span><span class="s3">- </span><span class="s1">serverTimeSec</span><span class="s3">) * </span><span class="s6">10000.0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sendUpdate</span><span class="s3">(</span><span class="s5">&quot;returnResync&quot;</span><span class="s3">, [</span>
            <span class="s1">avId</span><span class="s3">, </span><span class="s1">timestampB</span><span class="s3">, </span><span class="s1">serverTimeSec</span><span class="s3">, </span><span class="s1">serverTimeUSec</span><span class="s3">, </span><span class="s1">uncertainty</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">returnResync</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">avId</span><span class="s3">, </span><span class="s1">timestampB</span><span class="s3">, </span><span class="s1">serverTimeSec</span><span class="s3">, </span><span class="s1">serverTimeUSec</span><span class="s3">,</span>
            <span class="s1">uncertainty</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        A reply sent by a client whom we recently sent suggestResync 
        to, this reports the client's new delta information so we can 
        adjust our clock as well. 
        &quot;&quot;&quot;</span>
        <span class="s1">serverTime </span><span class="s3">= </span><span class="s1">float</span><span class="s3">(</span><span class="s1">serverTimeSec</span><span class="s3">) + </span><span class="s1">float</span><span class="s3">(</span><span class="s1">serverTimeUSec</span><span class="s3">) / </span><span class="s6">10000.0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">peerToPeerResync</span><span class="s3">(</span><span class="s1">avId</span><span class="s3">, </span><span class="s1">timestampB</span><span class="s3">, </span><span class="s1">serverTime</span><span class="s3">, </span><span class="s1">uncertainty</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">peerToPeerResync</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">avId</span><span class="s3">, </span><span class="s1">timestamp</span><span class="s3">, </span><span class="s1">serverTime</span><span class="s3">, </span><span class="s1">uncertainty</span><span class="s3">):</span>
        <span class="s1">gotSync </span><span class="s3">= </span><span class="s1">globalClockDelta</span><span class="s3">.</span><span class="s1">peerToPeerResync</span><span class="s3">(</span>
            <span class="s1">avId</span><span class="s3">, </span><span class="s1">timestamp</span><span class="s3">, </span><span class="s1">serverTime</span><span class="s3">, </span><span class="s1">uncertainty</span><span class="s3">)</span>

        <span class="s4"># If we didn't get anything useful from the other client,</span>
        <span class="s4"># maybe our clock is just completely hosed.  Go ask the AI.</span>
        <span class="s2">if not </span><span class="s1">gotSync</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cr</span><span class="s3">.</span><span class="s1">timeManager </span><span class="s3">!= </span><span class="s2">None</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">cr</span><span class="s3">.</span><span class="s1">timeManager</span><span class="s3">.</span><span class="s1">synchronize</span><span class="s3">(</span><span class="s5">&quot;suggested by %d&quot; </span><span class="s3">% (</span><span class="s1">avId</span><span class="s3">))</span>

        <span class="s2">return </span><span class="s1">gotSync</span>

    <span class="s2">def </span><span class="s1">activateSmoothing</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">smoothing</span><span class="s3">, </span><span class="s1">prediction</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Enables or disables the smoothing of other avatars' motion. 
        This used to be a global flag, but now it is specific to each 
        avatar instance.  However, see globalActivateSmoothing() in 
        this module. 
 
        If smoothing is off, no kind of smoothing will be performed, 
        regardless of the setting of prediction. 
 
        This is not necessarily predictive smoothing; if predictive 
        smoothing is off, avatars will be lagged by a certain factor 
        to achieve smooth motion.  Otherwise, if predictive smoothing 
        is on, avatars will be drawn as nearly as possible in their 
        current position, by extrapolating from old position reports. 
 
        This assumes you have a client repository that knows its 
        localAvatarDoId -- stored in self.cr.localAvatarDoId 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">smoothing </span><span class="s2">and </span><span class="s1">EnableSmoothing</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">prediction </span><span class="s2">and </span><span class="s1">EnablePrediction</span><span class="s3">:</span>
                <span class="s4"># Prediction and smoothing.</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setSmoothMode</span><span class="s3">(</span><span class="s1">SmoothMover</span><span class="s3">.</span><span class="s1">SMOn</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setPredictionMode</span><span class="s3">(</span><span class="s1">SmoothMover</span><span class="s3">.</span><span class="s1">PMOn</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setDelay</span><span class="s3">(</span><span class="s1">PredictionLag</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s4"># Smoothing, but no prediction.</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setSmoothMode</span><span class="s3">(</span><span class="s1">SmoothMover</span><span class="s3">.</span><span class="s1">SMOn</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setPredictionMode</span><span class="s3">(</span><span class="s1">SmoothMover</span><span class="s3">.</span><span class="s1">PMOff</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setDelay</span><span class="s3">(</span><span class="s1">Lag</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s4"># No smoothing, no prediction.</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setSmoothMode</span><span class="s3">(</span><span class="s1">SmoothMover</span><span class="s3">.</span><span class="s1">SMOff</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setPredictionMode</span><span class="s3">(</span><span class="s1">SmoothMover</span><span class="s3">.</span><span class="s1">PMOff</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">smoother</span><span class="s3">.</span><span class="s1">setDelay</span><span class="s3">(</span><span class="s6">0.0</span><span class="s3">)</span>
</pre>
</body>
</html>