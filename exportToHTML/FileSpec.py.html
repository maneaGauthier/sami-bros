<html>
<head>
<title>FileSpec.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
FileSpec.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
.. deprecated:: 1.10.0 
   The p3d packaging system has been replaced with the new setuptools-based 
   system.  See the :ref:`distribution` manual section. 
&quot;&quot;&quot;</span>
<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">&quot;FileSpec&quot;</span><span class="s2">]</span>

<span class="s4">import </span><span class="s1">os</span>
<span class="s4">import </span><span class="s1">time</span>
<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s1">Filename</span><span class="s2">, </span><span class="s1">HashVal</span><span class="s2">, </span><span class="s1">VirtualFileSystem</span>

<span class="s4">class </span><span class="s1">FileSpec</span><span class="s2">:</span>
    <span class="s0">&quot;&quot;&quot; This class represents a disk file whose hash and size 
    etc. were read from an xml file.  This class provides methods to 
    verify whether the file on disk matches the version demanded by 
    the xml. &quot;&quot;&quot;</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">actualFile </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">timestamp </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">hash </span><span class="s2">= </span><span class="s4">None</span>

    <span class="s4">def </span><span class="s1">fromFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">, </span><span class="s1">pathname </span><span class="s2">= </span><span class="s4">None</span><span class="s2">, </span><span class="s1">st </span><span class="s2">= </span><span class="s4">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Reads the file information from the indicated file.  If st 
        is supplied, it is the result of os.stat on the filename. &quot;&quot;&quot;</span>

        <span class="s1">vfs </span><span class="s2">= </span><span class="s1">VirtualFileSystem</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>

        <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">pathname </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">pathname </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basename </span><span class="s2">= </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">()</span>

        <span class="s4">if </span><span class="s1">st </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">st </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">stat</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">st_size</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">timestamp </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">st</span><span class="s2">.</span><span class="s1">st_mtime</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">readHash</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">readHash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pathname</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Reads the hash only from the indicated pathname. &quot;&quot;&quot;</span>

        <span class="s1">hv </span><span class="s2">= </span><span class="s1">HashVal</span><span class="s2">()</span>
        <span class="s1">hv</span><span class="s2">.</span><span class="s1">hashFile</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">hash </span><span class="s2">= </span><span class="s1">hv</span><span class="s2">.</span><span class="s1">asHex</span><span class="s2">()</span>


    <span class="s4">def </span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xelement</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Reads the file information from the indicated XML 
        element. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">= </span><span class="s1">xelement</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'filename'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basename </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">basename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">).</span><span class="s1">getBasename</span><span class="s2">()</span>

        <span class="s1">size </span><span class="s2">= </span><span class="s1">xelement</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'size'</span><span class="s2">)</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">size</span><span class="s2">)</span>
        <span class="s4">except</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s5">0</span>

        <span class="s1">timestamp </span><span class="s2">= </span><span class="s1">xelement</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'timestamp'</span><span class="s2">)</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">timestamp </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">timestamp</span><span class="s2">)</span>
        <span class="s4">except</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">timestamp </span><span class="s2">= </span><span class="s5">0</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">hash </span><span class="s2">= </span><span class="s1">xelement</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'hash'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xelement</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Adds the file information to the indicated XML 
        element. &quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">:</span>
            <span class="s1">xelement</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'filename'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">size</span><span class="s2">:</span>
            <span class="s1">xelement</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'size'</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">size</span><span class="s2">))</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">timestamp</span><span class="s2">:</span>
            <span class="s1">xelement</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'timestamp'</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">timestamp</span><span class="s2">)))</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hash</span><span class="s2">:</span>
            <span class="s1">xelement</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'hash'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hash</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">storeMiniXml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xelement</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Adds the just the &quot;mini&quot; file information--size and 
        hash--to the indicated XML element. &quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">size</span><span class="s2">:</span>
            <span class="s1">xelement</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'size'</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">size</span><span class="s2">))</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hash</span><span class="s2">:</span>
            <span class="s1">xelement</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'hash'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hash</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">quickVerify</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageDir </span><span class="s2">= </span><span class="s4">None</span><span class="s2">, </span><span class="s1">pathname </span><span class="s2">= </span><span class="s4">None</span><span class="s2">,</span>
                    <span class="s1">notify </span><span class="s2">= </span><span class="s4">None</span><span class="s2">, </span><span class="s1">correctSelf </span><span class="s2">= </span><span class="s4">False</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Performs a quick test to ensure the file has not been 
        modified.  This test is vulnerable to people maliciously 
        attempting to fool the program (by setting datestamps etc.). 
 
        if correctSelf is True, then any discrepency is corrected by 
        updating the appropriate fields internally, making the 
        assumption that the file on disk is the authoritative version. 
 
        Returns true if it is intact, false if it is incorrect.  If 
        correctSelf is true, raises OSError if the self-update is 
        impossible (for instance, because the file does not exist).&quot;&quot;&quot;</span>

        <span class="s4">if not </span><span class="s1">pathname</span><span class="s2">:</span>
            <span class="s1">pathname </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">st </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">stat</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s4">except </span><span class="s1">OSError</span><span class="s2">:</span>
            <span class="s6"># If the file is missing, the file fails.</span>
            <span class="s4">if </span><span class="s1">notify</span><span class="s2">:</span>
                <span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;file not found: %s&quot; </span><span class="s2">% (</span><span class="s1">pathname</span><span class="s2">))</span>
                <span class="s4">if </span><span class="s1">correctSelf</span><span class="s2">:</span>
                    <span class="s4">raise</span>
            <span class="s4">return False</span>

        <span class="s4">if </span><span class="s1">st</span><span class="s2">.</span><span class="s1">st_size </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">size</span><span class="s2">:</span>
            <span class="s6"># If the size is wrong, the file fails.</span>
            <span class="s4">if </span><span class="s1">notify</span><span class="s2">:</span>
                <span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;size wrong: %s&quot; </span><span class="s2">% (</span><span class="s1">pathname</span><span class="s2">))</span>
            <span class="s4">if </span><span class="s1">correctSelf</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__correctHash</span><span class="s2">(</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">st</span><span class="s2">, </span><span class="s1">notify</span><span class="s2">)</span>
            <span class="s4">return False</span>

        <span class="s4">if </span><span class="s1">int</span><span class="s2">(</span><span class="s1">st</span><span class="s2">.</span><span class="s1">st_mtime</span><span class="s2">) == </span><span class="s1">self</span><span class="s2">.</span><span class="s1">timestamp</span><span class="s2">:</span>
            <span class="s6"># If the size is right and the timestamp is right, the</span>
            <span class="s6"># file passes.</span>
            <span class="s4">if </span><span class="s1">notify</span><span class="s2">:</span>
                <span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;file ok: %s&quot; </span><span class="s2">% (</span><span class="s1">pathname</span><span class="s2">))</span>
            <span class="s4">return True</span>

        <span class="s4">if </span><span class="s1">notify</span><span class="s2">:</span>
            <span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;modification time wrong: %s&quot; </span><span class="s2">% (</span><span class="s1">pathname</span><span class="s2">))</span>

        <span class="s6"># If the size is right but the timestamp is wrong, the file</span>
        <span class="s6"># soft-fails.  We follow this up with a hash check.</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">checkHash</span><span class="s2">(</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">st</span><span class="s2">):</span>
            <span class="s6"># Hard fail, the hash is wrong.</span>
            <span class="s4">if </span><span class="s1">notify</span><span class="s2">:</span>
                <span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;hash check wrong: %s&quot; </span><span class="s2">% (</span><span class="s1">pathname</span><span class="s2">))</span>
                <span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;  found %s, expected %s&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">actualFile</span><span class="s2">.</span><span class="s1">hash</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hash</span><span class="s2">))</span>
            <span class="s4">if </span><span class="s1">correctSelf</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__correctHash</span><span class="s2">(</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">st</span><span class="s2">, </span><span class="s1">notify</span><span class="s2">)</span>
            <span class="s4">return False</span>

        <span class="s4">if </span><span class="s1">notify</span><span class="s2">:</span>
            <span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;hash check ok: %s&quot; </span><span class="s2">% (</span><span class="s1">pathname</span><span class="s2">))</span>

        <span class="s6"># The hash is OK after all.  Change the file's timestamp back</span>
        <span class="s6"># to what we expect it to be, so we can quick-verify it</span>
        <span class="s6"># successfully next time.</span>
        <span class="s4">if </span><span class="s1">correctSelf</span><span class="s2">:</span>
            <span class="s6"># Or update our own timestamp.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__correctTimestamp</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">st</span><span class="s2">, </span><span class="s1">notify</span><span class="s2">)</span>
            <span class="s4">return False</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__updateTimestamp</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">st</span><span class="s2">)</span>

        <span class="s4">return True</span>


    <span class="s4">def </span><span class="s1">fullVerify</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageDir </span><span class="s2">= </span><span class="s4">None</span><span class="s2">, </span><span class="s1">pathname </span><span class="s2">= </span><span class="s4">None</span><span class="s2">, </span><span class="s1">notify </span><span class="s2">= </span><span class="s4">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Performs a more thorough test to ensure the file has not 
        been modified.  This test is less vulnerable to malicious 
        attacks, since it reads and verifies the entire file. 
 
        Returns true if it is intact, false if it needs to be 
        redownloaded. &quot;&quot;&quot;</span>

        <span class="s4">if not </span><span class="s1">pathname</span><span class="s2">:</span>
            <span class="s1">pathname </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">st </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">stat</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s4">except </span><span class="s1">OSError</span><span class="s2">:</span>
            <span class="s6"># If the file is missing, the file fails.</span>
            <span class="s4">if </span><span class="s1">notify</span><span class="s2">:</span>
                <span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;file not found: %s&quot; </span><span class="s2">% (</span><span class="s1">pathname</span><span class="s2">))</span>
            <span class="s4">return False</span>

        <span class="s4">if </span><span class="s1">st</span><span class="s2">.</span><span class="s1">st_size </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">size</span><span class="s2">:</span>
            <span class="s6"># If the size is wrong, the file fails;</span>
            <span class="s4">if </span><span class="s1">notify</span><span class="s2">:</span>
                <span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;size wrong: %s&quot; </span><span class="s2">% (</span><span class="s1">pathname</span><span class="s2">))</span>
            <span class="s4">return False</span>

        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">checkHash</span><span class="s2">(</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">st</span><span class="s2">):</span>
            <span class="s6"># Hard fail, the hash is wrong.</span>
            <span class="s4">if </span><span class="s1">notify</span><span class="s2">:</span>
                <span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;hash check wrong: %s&quot; </span><span class="s2">% (</span><span class="s1">pathname</span><span class="s2">))</span>
                <span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;  found %s, expected %s&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">actualFile</span><span class="s2">.</span><span class="s1">hash</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hash</span><span class="s2">))</span>
            <span class="s4">return False</span>

        <span class="s4">if </span><span class="s1">notify</span><span class="s2">:</span>
            <span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;hash check ok: %s&quot; </span><span class="s2">% (</span><span class="s1">pathname</span><span class="s2">))</span>

        <span class="s6"># The hash is OK.  If the timestamp is wrong, change it back</span>
        <span class="s6"># to what we expect it to be, so we can quick-verify it</span>
        <span class="s6"># successfully next time.</span>
        <span class="s4">if </span><span class="s1">int</span><span class="s2">(</span><span class="s1">st</span><span class="s2">.</span><span class="s1">st_mtime</span><span class="s2">) != </span><span class="s1">self</span><span class="s2">.</span><span class="s1">timestamp</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__updateTimestamp</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">st</span><span class="s2">)</span>

        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">__updateTimestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">st</span><span class="s2">):</span>
        <span class="s6"># On Windows, we have to change the file to read-write before</span>
        <span class="s6"># we can successfully update its timestamp.</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">chmod</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s5">0o755</span><span class="s2">)</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">utime</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), (</span><span class="s1">st</span><span class="s2">.</span><span class="s1">st_atime</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">timestamp</span><span class="s2">))</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">chmod</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s5">0o555</span><span class="s2">)</span>
        <span class="s4">except </span><span class="s1">OSError</span><span class="s2">:</span>
            <span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">__correctTimestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">st</span><span class="s2">, </span><span class="s1">notify</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Corrects the internal timestamp to match the one on 
        disk. &quot;&quot;&quot;</span>
        <span class="s4">if </span><span class="s1">notify</span><span class="s2">:</span>
            <span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Correcting timestamp of %s to %d (%s)&quot; </span><span class="s2">% (</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">st</span><span class="s2">.</span><span class="s1">st_mtime</span><span class="s2">, </span><span class="s1">time</span><span class="s2">.</span><span class="s1">asctime</span><span class="s2">(</span><span class="s1">time</span><span class="s2">.</span><span class="s1">localtime</span><span class="s2">(</span><span class="s1">st</span><span class="s2">.</span><span class="s1">st_mtime</span><span class="s2">))))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">timestamp </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">st</span><span class="s2">.</span><span class="s1">st_mtime</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">checkHash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">st</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Returns true if the file has the expected md5 hash, false 
        otherwise.  As a side effect, stores a FileSpec corresponding 
        to the on-disk file in self.actualFile. &quot;&quot;&quot;</span>

        <span class="s1">fileSpec </span><span class="s2">= </span><span class="s1">FileSpec</span><span class="s2">()</span>
        <span class="s1">fileSpec</span><span class="s2">.</span><span class="s1">fromFile</span><span class="s2">(</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">,</span>
                          <span class="s1">pathname </span><span class="s2">= </span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">st </span><span class="s2">= </span><span class="s1">st</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">actualFile </span><span class="s2">= </span><span class="s1">fileSpec</span>

        <span class="s4">return </span><span class="s2">(</span><span class="s1">fileSpec</span><span class="s2">.</span><span class="s1">hash </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hash</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__correctHash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">st</span><span class="s2">, </span><span class="s1">notify</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Corrects the internal hash to match the one on disk. &quot;&quot;&quot;</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">actualFile</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">checkHash</span><span class="s2">(</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">st</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">notify</span><span class="s2">:</span>
            <span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Correcting hash %s to %s&quot; </span><span class="s2">% (</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">actualFile</span><span class="s2">.</span><span class="s1">hash</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">hash </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">actualFile</span><span class="s2">.</span><span class="s1">hash</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">actualFile</span><span class="s2">.</span><span class="s1">size</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">timestamp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">actualFile</span><span class="s2">.</span><span class="s1">timestamp</span>
</pre>
</body>
</html>