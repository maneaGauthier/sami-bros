<html>
<head>
<title>CommonFilters.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #7a7e85;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
CommonFilters.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Class CommonFilters implements certain common image 
postprocessing filters.  See the :ref:`common-image-filters` page for 
more information about how to use these filters. 
 
These filters are written in the Cg shading language. 
&quot;&quot;&quot;</span>

<span class="s2"># It is not ideal that these filters are all included in a single</span>
<span class="s2"># monolithic module.  Unfortunately, when you want to apply two filters</span>
<span class="s2"># at the same time, you have to compose them into a single shader, and</span>
<span class="s2"># the composition process isn't simply a question of concatenating them:</span>
<span class="s2"># you have to somehow make them work together.  I suspect that there</span>
<span class="s2"># exists some fairly simple framework that would make this automatable.</span>
<span class="s2"># However, until I write some more filters myself, I won't know what</span>
<span class="s2"># that framework is.  Until then, I'll settle for this</span>
<span class="s2"># clunky approach.  - Josh</span>

<span class="s3">from </span><span class="s4">.</span><span class="s1">FilterManager </span><span class="s3">import </span><span class="s1">FilterManager</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">filterBloomI </span><span class="s3">import </span><span class="s1">BLOOM_I</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">filterBloomX </span><span class="s3">import </span><span class="s1">BLOOM_X</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">filterBloomY </span><span class="s3">import </span><span class="s1">BLOOM_Y</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">filterBlurX </span><span class="s3">import </span><span class="s1">BLUR_X</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">filterBlurY </span><span class="s3">import </span><span class="s1">BLUR_Y</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">filterCopy </span><span class="s3">import </span><span class="s1">COPY</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">filterDown4 </span><span class="s3">import </span><span class="s1">DOWN_4</span>
<span class="s3">from </span><span class="s1">panda3d</span><span class="s4">.</span><span class="s1">core </span><span class="s3">import </span><span class="s1">LVecBase4</span><span class="s4">, </span><span class="s1">LPoint2</span>
<span class="s3">from </span><span class="s1">panda3d</span><span class="s4">.</span><span class="s1">core </span><span class="s3">import </span><span class="s1">Filename</span>
<span class="s3">from </span><span class="s1">panda3d</span><span class="s4">.</span><span class="s1">core </span><span class="s3">import </span><span class="s1">AuxBitplaneAttrib</span><span class="s4">, </span><span class="s1">AntialiasAttrib</span>
<span class="s3">from </span><span class="s1">panda3d</span><span class="s4">.</span><span class="s1">core </span><span class="s3">import </span><span class="s1">Texture</span><span class="s4">, </span><span class="s1">Shader</span><span class="s4">, </span><span class="s1">ATSNone</span>
<span class="s3">from </span><span class="s1">panda3d</span><span class="s4">.</span><span class="s1">core </span><span class="s3">import </span><span class="s1">FrameBufferProperties</span>
<span class="s3">from </span><span class="s1">panda3d</span><span class="s4">.</span><span class="s1">core </span><span class="s3">import </span><span class="s1">getDefaultCoordinateSystem</span><span class="s4">, </span><span class="s1">CS_zup_right</span><span class="s4">, </span><span class="s1">CS_zup_left</span>
<span class="s3">import </span><span class="s1">os</span>

<span class="s1">CARTOON_BODY</span><span class="s4">=</span><span class="s5">&quot;&quot;&quot; 
float4 cartoondelta = k_cartoonseparation * texpix_txaux.xwyw; 
float4 cartoon_c0 = tex2D(k_txaux, %(texcoord)s + cartoondelta.xy); 
float4 cartoon_c1 = tex2D(k_txaux, %(texcoord)s - cartoondelta.xy); 
float4 cartoon_c2 = tex2D(k_txaux, %(texcoord)s + cartoondelta.wz); 
float4 cartoon_c3 = tex2D(k_txaux, %(texcoord)s - cartoondelta.wz); 
float4 cartoon_mx = max(cartoon_c0, max(cartoon_c1, max(cartoon_c2, cartoon_c3))); 
float4 cartoon_mn = min(cartoon_c0, min(cartoon_c1, min(cartoon_c2, cartoon_c3))); 
float cartoon_thresh = saturate(dot(cartoon_mx - cartoon_mn, float4(3,3,0,0)) - 0.5); 
o_color = lerp(o_color, k_cartooncolor, cartoon_thresh); 
&quot;&quot;&quot;</span>

<span class="s2"># Some GPUs do not support variable-length loops.</span>
<span class="s2">#</span>
<span class="s2"># We fill in the actual value of numsamples in the loop limit</span>
<span class="s2"># when the shader is configured.</span>
<span class="s2">#</span>
<span class="s1">SSAO_BODY</span><span class="s4">=</span><span class="s5">&quot;&quot;&quot;//Cg 
 
void vshader(float4 vtx_position : POSITION, 
             float2 vtx_texcoord : TEXCOORD0, 
             out float4 l_position : POSITION, 
             out float2 l_texcoord : TEXCOORD0, 
             out float2 l_texcoordD : TEXCOORD1, 
             out float2 l_texcoordN : TEXCOORD2, 
             uniform float4 texpad_depth, 
             uniform float4 texpad_normal, 
             uniform float4x4 mat_modelproj) 
{ 
  l_position = mul(mat_modelproj, vtx_position); 
  l_texcoord = vtx_texcoord; 
  l_texcoordD = vtx_texcoord * texpad_depth.xy * 2; 
  l_texcoordN = vtx_texcoord * texpad_normal.xy * 2; 
} 
 
float3 sphere[16] = float3[](float3(0.53812504, 0.18565957, -0.43192),float3(0.13790712, 0.24864247, 0.44301823),float3(0.33715037, 0.56794053, -0.005789503),float3(-0.6999805, -0.04511441, -0.0019965635),float3(0.06896307, -0.15983082, -0.85477847),float3(0.056099437, 0.006954967, -0.1843352),float3(-0.014653638, 0.14027752, 0.0762037),float3(0.010019933, -0.1924225, -0.034443386),float3(-0.35775623, -0.5301969, -0.43581226),float3(-0.3169221, 0.106360726, 0.015860917),float3(0.010350345, -0.58698344, 0.0046293875),float3(-0.08972908, -0.49408212, 0.3287904),float3(0.7119986, -0.0154690035, -0.09183723),float3(-0.053382345, 0.059675813, -0.5411899),float3(0.035267662, -0.063188605, 0.54602677),float3(-0.47761092, 0.2847911, -0.0271716)); 
 
void fshader(out float4 o_color : COLOR, 
             uniform float4 k_params1, 
             uniform float4 k_params2, 
             float2 l_texcoord : TEXCOORD0, 
             float2 l_texcoordD : TEXCOORD1, 
             float2 l_texcoordN : TEXCOORD2, 
             uniform sampler2D k_random : TEXUNIT0, 
             uniform sampler2D k_depth : TEXUNIT1, 
             uniform sampler2D k_normal : TEXUNIT2) 
{ 
  float pixel_depth = tex2D(k_depth, l_texcoordD).a; 
  float3 pixel_normal = (tex2D(k_normal, l_texcoordN).xyz * 2.0 - 1.0); 
  float3 random_vector = normalize((tex2D(k_random, l_texcoord * 18.0 + pixel_depth + pixel_normal.xy).xyz * 2.0) - float3(1.0)).xyz; 
  float occlusion = 0.0; 
  float radius = k_params1.z / pixel_depth; 
  float depth_difference; 
  float3 sample_normal; 
  float3 ray; 
  for(int i = 0; i &lt; %d; ++i) { 
   ray = radius * reflect(sphere[i], random_vector); 
   sample_normal = (tex2D(k_normal, l_texcoordN + ray.xy).xyz * 2.0 - 1.0); 
   depth_difference =  (pixel_depth - tex2D(k_depth,l_texcoordD + ray.xy).r); 
   occlusion += step(k_params2.y, depth_difference) * (1.0 - dot(sample_normal.xyz, pixel_normal)) * (1.0 - smoothstep(k_params2.y, k_params2.x, depth_difference)); 
  } 
  o_color.rgb = 1.0 + (occlusion * k_params1.y); 
  o_color.a = 1.0; 
} 
&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">FilterConfig</span><span class="s4">:</span>
    <span class="s3">pass</span>

<span class="s3">class </span><span class="s1">CommonFilters</span><span class="s4">:</span>

    <span class="s0">&quot;&quot;&quot; Class CommonFilters implements certain common image postprocessing 
    filters.  The constructor requires a filter builder as a parameter. &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">win</span><span class="s4">, </span><span class="s1">cam</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">manager </span><span class="s4">= </span><span class="s1">FilterManager</span><span class="s4">(</span><span class="s1">win</span><span class="s4">, </span><span class="s1">cam</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">configuration </span><span class="s4">= {}</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">task </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">cleanup</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">cleanup</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">cleanup</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">textures </span><span class="s4">= {}</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">finalQuad </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom </span><span class="s4">= []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">blur </span><span class="s4">= []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ssao </span><span class="s4">= []</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">task </span><span class="s4">!= </span><span class="s3">None</span><span class="s4">:</span>
          <span class="s1">taskMgr</span><span class="s4">.</span><span class="s1">remove</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">task</span><span class="s4">)</span>
          <span class="s1">self</span><span class="s4">.</span><span class="s1">task </span><span class="s4">= </span><span class="s3">None</span>

    <span class="s3">def </span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">fullrebuild</span><span class="s4">, </span><span class="s1">changed</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot; Reconfigure is called whenever any configuration change is made. &quot;&quot;&quot;</span>

        <span class="s1">configuration </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span>

        <span class="s3">if </span><span class="s4">(</span><span class="s1">fullrebuild</span><span class="s4">):</span>

            <span class="s1">self</span><span class="s4">.</span><span class="s1">cleanup</span><span class="s4">()</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">configuration</span><span class="s4">) == </span><span class="s6">0</span><span class="s4">):</span>
                <span class="s3">return</span>

            <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">win</span><span class="s4">.</span><span class="s1">gsg</span><span class="s4">.</span><span class="s1">getSupportsBasicShaders</span><span class="s4">():</span>
                <span class="s3">return False</span>

            <span class="s1">auxbits </span><span class="s4">= </span><span class="s6">0</span>
            <span class="s1">needtex </span><span class="s4">= </span><span class="s1">set</span><span class="s4">([</span><span class="s5">&quot;color&quot;</span><span class="s4">])</span>
            <span class="s1">needtexcoord </span><span class="s4">= </span><span class="s1">set</span><span class="s4">([</span><span class="s5">&quot;color&quot;</span><span class="s4">])</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;CartoonInk&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">needtex</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s5">&quot;aux&quot;</span><span class="s4">)</span>
                <span class="s1">auxbits </span><span class="s4">|= </span><span class="s1">AuxBitplaneAttrib</span><span class="s4">.</span><span class="s1">ABOAuxNormal</span>
                <span class="s1">needtexcoord</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s5">&quot;aux&quot;</span><span class="s4">)</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;AmbientOcclusion&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">needtex</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s5">&quot;depth&quot;</span><span class="s4">)</span>
                <span class="s1">needtex</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s5">&quot;ssao0&quot;</span><span class="s4">)</span>
                <span class="s1">needtex</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s5">&quot;ssao1&quot;</span><span class="s4">)</span>
                <span class="s1">needtex</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s5">&quot;ssao2&quot;</span><span class="s4">)</span>
                <span class="s1">needtex</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s5">&quot;aux&quot;</span><span class="s4">)</span>
                <span class="s1">auxbits </span><span class="s4">|= </span><span class="s1">AuxBitplaneAttrib</span><span class="s4">.</span><span class="s1">ABOAuxNormal</span>
                <span class="s1">needtexcoord</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s5">&quot;ssao2&quot;</span><span class="s4">)</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;BlurSharpen&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">needtex</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s5">&quot;blur0&quot;</span><span class="s4">)</span>
                <span class="s1">needtex</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s5">&quot;blur1&quot;</span><span class="s4">)</span>
                <span class="s1">needtexcoord</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s5">&quot;blur1&quot;</span><span class="s4">)</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;Bloom&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">needtex</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s5">&quot;bloom0&quot;</span><span class="s4">)</span>
                <span class="s1">needtex</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s5">&quot;bloom1&quot;</span><span class="s4">)</span>
                <span class="s1">needtex</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s5">&quot;bloom2&quot;</span><span class="s4">)</span>
                <span class="s1">needtex</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s5">&quot;bloom3&quot;</span><span class="s4">)</span>
                <span class="s1">auxbits </span><span class="s4">|= </span><span class="s1">AuxBitplaneAttrib</span><span class="s4">.</span><span class="s1">ABOGlow</span>
                <span class="s1">needtexcoord</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s5">&quot;bloom3&quot;</span><span class="s4">)</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;ViewGlow&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">auxbits </span><span class="s4">|= </span><span class="s1">AuxBitplaneAttrib</span><span class="s4">.</span><span class="s1">ABOGlow</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;VolumetricLighting&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">needtex</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;VolumetricLighting&quot;</span><span class="s4">].</span><span class="s1">source</span><span class="s4">)</span>

            <span class="s3">for </span><span class="s1">tex </span><span class="s3">in </span><span class="s1">needtex</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s1">tex</span><span class="s4">] = </span><span class="s1">Texture</span><span class="s4">(</span><span class="s5">&quot;scene-&quot; </span><span class="s4">+ </span><span class="s1">tex</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s1">tex</span><span class="s4">].</span><span class="s1">setWrapU</span><span class="s4">(</span><span class="s1">Texture</span><span class="s4">.</span><span class="s1">WMClamp</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s1">tex</span><span class="s4">].</span><span class="s1">setWrapV</span><span class="s4">(</span><span class="s1">Texture</span><span class="s4">.</span><span class="s1">WMClamp</span><span class="s4">)</span>

            <span class="s1">fbprops </span><span class="s4">= </span><span class="s3">None</span>
            <span class="s1">clamping </span><span class="s4">= </span><span class="s3">None</span>
            <span class="s3">if </span><span class="s5">&quot;HighDynamicRange&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">:</span>
                <span class="s1">fbprops </span><span class="s4">= </span><span class="s1">FrameBufferProperties</span><span class="s4">()</span>
                <span class="s1">fbprops</span><span class="s4">.</span><span class="s1">setFloatColor</span><span class="s4">(</span><span class="s3">True</span><span class="s4">)</span>
                <span class="s1">fbprops</span><span class="s4">.</span><span class="s1">setSrgbColor</span><span class="s4">(</span><span class="s3">False</span><span class="s4">)</span>
                <span class="s1">clamping </span><span class="s4">= </span><span class="s3">False</span>

            <span class="s3">if </span><span class="s5">&quot;MSAA&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">fbprops </span><span class="s3">is None</span><span class="s4">:</span>
                    <span class="s1">fbprops </span><span class="s4">= </span><span class="s1">FrameBufferProperties</span><span class="s4">()</span>
                <span class="s1">fbprops</span><span class="s4">.</span><span class="s1">setMultisamples</span><span class="s4">(</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;MSAA&quot;</span><span class="s4">].</span><span class="s1">samples</span><span class="s4">)</span>

            <span class="s1">self</span><span class="s4">.</span><span class="s1">finalQuad </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">renderSceneInto</span><span class="s4">(</span><span class="s1">textures </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">, </span><span class="s1">auxbits</span><span class="s4">=</span><span class="s1">auxbits</span><span class="s4">, </span><span class="s1">fbprops</span><span class="s4">=</span><span class="s1">fbprops</span><span class="s4">, </span><span class="s1">clamping</span><span class="s4">=</span><span class="s1">clamping</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">finalQuad </span><span class="s4">== </span><span class="s3">None</span><span class="s4">):</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">cleanup</span><span class="s4">()</span>
                <span class="s3">return False</span>

            <span class="s3">if </span><span class="s5">&quot;MSAA&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">:</span>
                <span class="s1">camNode </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">camera</span><span class="s4">.</span><span class="s1">node</span><span class="s4">()</span>
                <span class="s1">state </span><span class="s4">= </span><span class="s1">camNode</span><span class="s4">.</span><span class="s1">getInitialState</span><span class="s4">()</span>
                <span class="s1">state</span><span class="s4">.</span><span class="s1">setAttrib</span><span class="s4">(</span><span class="s1">AntialiasAttrib</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">AntialiasAttrib</span><span class="s4">.</span><span class="s1">M_multisample</span><span class="s4">))</span>
                <span class="s1">camNode</span><span class="s4">.</span><span class="s1">setInitialState</span><span class="s4">(</span><span class="s1">state</span><span class="s4">)</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;BlurSharpen&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">blur0</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s5">&quot;blur0&quot;</span><span class="s4">]</span>
                <span class="s1">blur1</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s5">&quot;blur1&quot;</span><span class="s4">]</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">blur</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">renderQuadInto</span><span class="s4">(</span><span class="s5">&quot;filter-blur0&quot;</span><span class="s4">, </span><span class="s1">colortex</span><span class="s4">=</span><span class="s1">blur0</span><span class="s4">,</span><span class="s1">div</span><span class="s4">=</span><span class="s6">2</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">blur</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">renderQuadInto</span><span class="s4">(</span><span class="s5">&quot;filter-blur1&quot;</span><span class="s4">, </span><span class="s1">colortex</span><span class="s4">=</span><span class="s1">blur1</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">blur</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;src&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s5">&quot;color&quot;</span><span class="s4">])</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">blur</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">setShader</span><span class="s4">(</span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">BLUR_X</span><span class="s4">, </span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">SL_Cg</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">blur</span><span class="s4">[</span><span class="s6">1</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;src&quot;</span><span class="s4">, </span><span class="s1">blur0</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">blur</span><span class="s4">[</span><span class="s6">1</span><span class="s4">].</span><span class="s1">setShader</span><span class="s4">(</span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">BLUR_Y</span><span class="s4">, </span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">SL_Cg</span><span class="s4">))</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;AmbientOcclusion&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">ssao0</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s5">&quot;ssao0&quot;</span><span class="s4">]</span>
                <span class="s1">ssao1</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s5">&quot;ssao1&quot;</span><span class="s4">]</span>
                <span class="s1">ssao2</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s5">&quot;ssao2&quot;</span><span class="s4">]</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ssao</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">renderQuadInto</span><span class="s4">(</span><span class="s5">&quot;filter-ssao0&quot;</span><span class="s4">, </span><span class="s1">colortex</span><span class="s4">=</span><span class="s1">ssao0</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ssao</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">renderQuadInto</span><span class="s4">(</span><span class="s5">&quot;filter-ssao1&quot;</span><span class="s4">, </span><span class="s1">colortex</span><span class="s4">=</span><span class="s1">ssao1</span><span class="s4">,</span><span class="s1">div</span><span class="s4">=</span><span class="s6">2</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ssao</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">renderQuadInto</span><span class="s4">(</span><span class="s5">&quot;filter-ssao2&quot;</span><span class="s4">, </span><span class="s1">colortex</span><span class="s4">=</span><span class="s1">ssao2</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ssao</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;depth&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s5">&quot;depth&quot;</span><span class="s4">])</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ssao</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;normal&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s5">&quot;aux&quot;</span><span class="s4">])</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ssao</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;random&quot;</span><span class="s4">, </span><span class="s1">loader</span><span class="s4">.</span><span class="s1">loadTexture</span><span class="s4">(</span><span class="s5">&quot;maps/random.rgb&quot;</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ssao</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">setShader</span><span class="s4">(</span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">SSAO_BODY </span><span class="s4">% </span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;AmbientOcclusion&quot;</span><span class="s4">].</span><span class="s1">numsamples</span><span class="s4">, </span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">SL_Cg</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ssao</span><span class="s4">[</span><span class="s6">1</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;src&quot;</span><span class="s4">, </span><span class="s1">ssao0</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ssao</span><span class="s4">[</span><span class="s6">1</span><span class="s4">].</span><span class="s1">setShader</span><span class="s4">(</span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">BLUR_X</span><span class="s4">, </span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">SL_Cg</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ssao</span><span class="s4">[</span><span class="s6">2</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;src&quot;</span><span class="s4">, </span><span class="s1">ssao1</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ssao</span><span class="s4">[</span><span class="s6">2</span><span class="s4">].</span><span class="s1">setShader</span><span class="s4">(</span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">BLUR_Y</span><span class="s4">, </span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">SL_Cg</span><span class="s4">))</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;Bloom&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">bloomconf </span><span class="s4">= </span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;Bloom&quot;</span><span class="s4">]</span>
                <span class="s1">bloom0</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s5">&quot;bloom0&quot;</span><span class="s4">]</span>
                <span class="s1">bloom1</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s5">&quot;bloom1&quot;</span><span class="s4">]</span>
                <span class="s1">bloom2</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s5">&quot;bloom2&quot;</span><span class="s4">]</span>
                <span class="s1">bloom3</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s5">&quot;bloom3&quot;</span><span class="s4">]</span>
                <span class="s3">if </span><span class="s4">(</span><span class="s1">bloomconf</span><span class="s4">.</span><span class="s1">size </span><span class="s4">== </span><span class="s5">&quot;large&quot;</span><span class="s4">):</span>
                    <span class="s1">scale</span><span class="s4">=</span><span class="s6">8</span>
                    <span class="s1">downsamplerName</span><span class="s4">=</span><span class="s5">&quot;filter-down4&quot;</span>
                    <span class="s1">downsampler</span><span class="s4">=</span><span class="s1">DOWN_4</span>
                <span class="s3">elif </span><span class="s4">(</span><span class="s1">bloomconf</span><span class="s4">.</span><span class="s1">size </span><span class="s4">== </span><span class="s5">&quot;medium&quot;</span><span class="s4">):</span>
                    <span class="s1">scale</span><span class="s4">=</span><span class="s6">4</span>
                    <span class="s1">downsamplerName</span><span class="s4">=</span><span class="s5">&quot;filter-copy&quot;</span>
                    <span class="s1">downsampler</span><span class="s4">=</span><span class="s1">COPY</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">scale</span><span class="s4">=</span><span class="s6">2</span>
                    <span class="s1">downsamplerName</span><span class="s4">=</span><span class="s5">&quot;filter-copy&quot;</span>
                    <span class="s1">downsampler</span><span class="s4">=</span><span class="s1">COPY</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">renderQuadInto</span><span class="s4">(</span><span class="s5">&quot;filter-bloomi&quot;</span><span class="s4">, </span><span class="s1">colortex</span><span class="s4">=</span><span class="s1">bloom0</span><span class="s4">, </span><span class="s1">div</span><span class="s4">=</span><span class="s6">2</span><span class="s4">,     </span><span class="s1">align</span><span class="s4">=</span><span class="s1">scale</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">renderQuadInto</span><span class="s4">(</span><span class="s1">downsamplerName</span><span class="s4">, </span><span class="s1">colortex</span><span class="s4">=</span><span class="s1">bloom1</span><span class="s4">, </span><span class="s1">div</span><span class="s4">=</span><span class="s1">scale</span><span class="s4">, </span><span class="s1">align</span><span class="s4">=</span><span class="s1">scale</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">renderQuadInto</span><span class="s4">(</span><span class="s5">&quot;filter-bloomx&quot;</span><span class="s4">, </span><span class="s1">colortex</span><span class="s4">=</span><span class="s1">bloom2</span><span class="s4">, </span><span class="s1">div</span><span class="s4">=</span><span class="s1">scale</span><span class="s4">, </span><span class="s1">align</span><span class="s4">=</span><span class="s1">scale</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">renderQuadInto</span><span class="s4">(</span><span class="s5">&quot;filter-bloomy&quot;</span><span class="s4">, </span><span class="s1">colortex</span><span class="s4">=</span><span class="s1">bloom3</span><span class="s4">, </span><span class="s1">div</span><span class="s4">=</span><span class="s1">scale</span><span class="s4">, </span><span class="s1">align</span><span class="s4">=</span><span class="s1">scale</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;src&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s5">&quot;color&quot;</span><span class="s4">])</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">setShader</span><span class="s4">(</span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">BLOOM_I</span><span class="s4">, </span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">SL_Cg</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom</span><span class="s4">[</span><span class="s6">1</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;src&quot;</span><span class="s4">, </span><span class="s1">bloom0</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom</span><span class="s4">[</span><span class="s6">1</span><span class="s4">].</span><span class="s1">setShader</span><span class="s4">(</span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">downsampler</span><span class="s4">, </span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">SL_Cg</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom</span><span class="s4">[</span><span class="s6">2</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;src&quot;</span><span class="s4">, </span><span class="s1">bloom1</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom</span><span class="s4">[</span><span class="s6">2</span><span class="s4">].</span><span class="s1">setShader</span><span class="s4">(</span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">BLOOM_X</span><span class="s4">, </span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">SL_Cg</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom</span><span class="s4">[</span><span class="s6">3</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;src&quot;</span><span class="s4">, </span><span class="s1">bloom2</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom</span><span class="s4">[</span><span class="s6">3</span><span class="s4">].</span><span class="s1">setShader</span><span class="s4">(</span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">BLOOM_Y</span><span class="s4">, </span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">SL_Cg</span><span class="s4">))</span>

            <span class="s1">texcoords </span><span class="s4">= {}</span>
            <span class="s1">texcoordPadding </span><span class="s4">= {}</span>

            <span class="s3">for </span><span class="s1">tex </span><span class="s3">in </span><span class="s1">needtexcoord</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s1">tex</span><span class="s4">].</span><span class="s1">getAutoTextureScale</span><span class="s4">() != </span><span class="s1">ATSNone </span><span class="s3">or </span><span class="s1">\</span>
                                           <span class="s5">&quot;HalfPixelShift&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">:</span>
                    <span class="s1">texcoords</span><span class="s4">[</span><span class="s1">tex</span><span class="s4">] = </span><span class="s5">&quot;l_texcoord_&quot; </span><span class="s4">+ </span><span class="s1">tex</span>
                    <span class="s1">texcoordPadding</span><span class="s4">[</span><span class="s5">&quot;l_texcoord_&quot; </span><span class="s4">+ </span><span class="s1">tex</span><span class="s4">] = </span><span class="s1">tex</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s2"># Share unpadded texture coordinates.</span>
                    <span class="s1">texcoords</span><span class="s4">[</span><span class="s1">tex</span><span class="s4">] = </span><span class="s5">&quot;l_texcoord&quot;</span>
                    <span class="s1">texcoordPadding</span><span class="s4">[</span><span class="s5">&quot;l_texcoord&quot;</span><span class="s4">] = </span><span class="s3">None</span>

            <span class="s1">texcoordSets </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">texcoordPadding</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">()))</span>

            <span class="s1">text </span><span class="s4">= </span><span class="s5">&quot;//Cg</span><span class="s3">\n</span><span class="s5">&quot;</span>
            <span class="s3">if </span><span class="s5">&quot;HighDynamicRange&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">:</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;static const float3x3 aces_input_mat = {</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  {0.59719, 0.35458, 0.04823},</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  {0.07600, 0.90834, 0.01566},</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  {0.02840, 0.13383, 0.83777},</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;};</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;static const float3x3 aces_output_mat = {</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  { 1.60475, -0.53108, -0.07367},</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  {-0.10208,  1.10813, -0.00605},</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  {-0.00327, -0.07276,  1.07602},</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;};</span><span class="s3">\n</span><span class="s5">&quot;</span>
            <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;void vshader(float4 vtx_position : POSITION,</span><span class="s3">\n</span><span class="s5">&quot;</span>
            <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  out float4 l_position : POSITION,</span><span class="s3">\n</span><span class="s5">&quot;</span>

            <span class="s3">for </span><span class="s1">texcoord</span><span class="s4">, </span><span class="s1">padTex </span><span class="s3">in </span><span class="s1">texcoordPadding</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
                <span class="s3">if </span><span class="s1">padTex </span><span class="s3">is not None</span><span class="s4">:</span>
                    <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  uniform float4 texpad_tx%s,</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% (</span><span class="s1">padTex</span><span class="s4">)</span>
                    <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;HalfPixelShift&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                        <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  uniform float4 texpix_tx%s,</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% (</span><span class="s1">padTex</span><span class="s4">)</span>

            <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">name </span><span class="s3">in </span><span class="s1">texcoordSets</span><span class="s4">:</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  out float2 %s : TEXCOORD%d,</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% (</span><span class="s1">name</span><span class="s4">, </span><span class="s1">i</span><span class="s4">)</span>

            <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  uniform float4x4 mat_modelproj)</span><span class="s3">\n</span><span class="s5">&quot;</span>
            <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;{</span><span class="s3">\n</span><span class="s5">&quot;</span>
            <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  l_position = mul(mat_modelproj, vtx_position);</span><span class="s3">\n</span><span class="s5">&quot;</span>

            <span class="s2"># The card is oriented differently depending on our chosen</span>
            <span class="s2"># coordinate system.  We could just use vtx_texcoord, but this</span>
            <span class="s2"># saves on an additional variable.</span>
            <span class="s3">if </span><span class="s1">getDefaultCoordinateSystem</span><span class="s4">() </span><span class="s3">in </span><span class="s4">(</span><span class="s1">CS_zup_right</span><span class="s4">, </span><span class="s1">CS_zup_left</span><span class="s4">):</span>
                <span class="s1">pos </span><span class="s4">= </span><span class="s5">&quot;vtx_position.xz&quot;</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">pos </span><span class="s4">= </span><span class="s5">&quot;vtx_position.xy&quot;</span>

            <span class="s3">for </span><span class="s1">texcoord</span><span class="s4">, </span><span class="s1">padTex </span><span class="s3">in </span><span class="s1">texcoordPadding</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
                <span class="s3">if </span><span class="s1">padTex </span><span class="s3">is None</span><span class="s4">:</span>
                    <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  %s = %s * float2(0.5, 0.5) + float2(0.5, 0.5);</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% (</span><span class="s1">texcoord</span><span class="s4">, </span><span class="s1">pos</span><span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  %s = (%s * texpad_tx%s.xy) + texpad_tx%s.xy;</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% (</span><span class="s1">texcoord</span><span class="s4">, </span><span class="s1">pos</span><span class="s4">, </span><span class="s1">padTex</span><span class="s4">, </span><span class="s1">padTex</span><span class="s4">)</span>

                    <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;HalfPixelShift&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                        <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  %s += texpix_tx%s.xy * 0.5;</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% (</span><span class="s1">texcoord</span><span class="s4">, </span><span class="s1">padTex</span><span class="s4">)</span>

            <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;}</span><span class="s3">\n</span><span class="s5">&quot;</span>

            <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;void fshader(</span><span class="s3">\n</span><span class="s5">&quot;</span>

            <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">name </span><span class="s3">in </span><span class="s1">texcoordSets</span><span class="s4">:</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  float2 %s : TEXCOORD%d,</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% (</span><span class="s1">name</span><span class="s4">, </span><span class="s1">i</span><span class="s4">)</span>

            <span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">:</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  uniform sampler2D k_tx&quot; </span><span class="s4">+ </span><span class="s1">key </span><span class="s4">+ </span><span class="s5">&quot;,</span><span class="s3">\n</span><span class="s5">&quot;</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;CartoonInk&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  uniform float4 k_cartoonseparation,</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  uniform float4 k_cartooncolor,</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  uniform float4 texpix_txaux,</span><span class="s3">\n</span><span class="s5">&quot;</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;BlurSharpen&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  uniform float4 k_blurval,</span><span class="s3">\n</span><span class="s5">&quot;</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;VolumetricLighting&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  uniform float4 k_casterpos,</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  uniform float4 k_vlparams,</span><span class="s3">\n</span><span class="s5">&quot;</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;ExposureAdjust&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  uniform float k_exposure,</span><span class="s3">\n</span><span class="s5">&quot;</span>

            <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  out float4 o_color : COLOR)</span><span class="s3">\n</span><span class="s5">&quot;</span>
            <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;{</span><span class="s3">\n</span><span class="s5">&quot;</span>
            <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  o_color = tex2D(k_txcolor, %s);</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% (</span><span class="s1">texcoords</span><span class="s4">[</span><span class="s5">&quot;color&quot;</span><span class="s4">])</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;CartoonInk&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s1">CARTOON_BODY </span><span class="s4">% {</span><span class="s5">&quot;texcoord&quot; </span><span class="s4">: </span><span class="s1">texcoords</span><span class="s4">[</span><span class="s5">&quot;aux&quot;</span><span class="s4">]}</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;AmbientOcclusion&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  o_color *= tex2D(k_txssao2, %s).r;</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% (</span><span class="s1">texcoords</span><span class="s4">[</span><span class="s5">&quot;ssao2&quot;</span><span class="s4">])</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;BlurSharpen&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  o_color = lerp(tex2D(k_txblur1, %s), o_color, k_blurval.x);</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% (</span><span class="s1">texcoords</span><span class="s4">[</span><span class="s5">&quot;blur1&quot;</span><span class="s4">])</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;Bloom&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  o_color = saturate(o_color);</span><span class="s3">\n</span><span class="s5">&quot;</span><span class="s1">;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  float4 bloom = 0.5 * tex2D(k_txbloom3, %s);</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% (</span><span class="s1">texcoords</span><span class="s4">[</span><span class="s5">&quot;bloom3&quot;</span><span class="s4">])</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  o_color = 1-((1-bloom)*(1-o_color));</span><span class="s3">\n</span><span class="s5">&quot;</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;ViewGlow&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  o_color.r = o_color.a;</span><span class="s3">\n</span><span class="s5">&quot;</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;VolumetricLighting&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  float decay = 1.0f;</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  float2 curcoord = %s;</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% (</span><span class="s1">texcoords</span><span class="s4">[</span><span class="s5">&quot;color&quot;</span><span class="s4">])</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  float2 lightdir = curcoord - k_casterpos.xy;</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  lightdir *= k_vlparams.x;</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  half4 sample = tex2D(k_txcolor, curcoord);</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  float3 vlcolor = sample.rgb * sample.a;</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  for (int i = 0; i &lt; %s; i++) {</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% (</span><span class="s1">int</span><span class="s4">(</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;VolumetricLighting&quot;</span><span class="s4">].</span><span class="s1">numsamples</span><span class="s4">))</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;    curcoord -= lightdir;</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;    sample = tex2D(k_tx%s, curcoord);</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% (</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;VolumetricLighting&quot;</span><span class="s4">].</span><span class="s1">source</span><span class="s4">)</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;    sample *= sample.a * decay;//*weight</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;    vlcolor += sample.rgb;</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;    decay *= k_vlparams.y;</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  }</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  o_color += float4(vlcolor * k_vlparams.z, 1);</span><span class="s3">\n</span><span class="s5">&quot;</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;ExposureAdjust&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  o_color.rgb *= k_exposure;</span><span class="s3">\n</span><span class="s5">&quot;</span>

            <span class="s2"># With thanks to Stephen Hill!</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;HighDynamicRange&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  float3 aces_color = mul(aces_input_mat, o_color.rgb);</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  o_color.rgb = saturate(mul(aces_output_mat, (aces_color * (aces_color + 0.0245786f) - 0.000090537f) / (aces_color * (0.983729f * aces_color + 0.4329510f) + 0.238081f)));</span><span class="s3">\n</span><span class="s5">&quot;</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;GammaAdjust&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">gamma </span><span class="s4">= </span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;GammaAdjust&quot;</span><span class="s4">]</span>
                <span class="s3">if </span><span class="s1">gamma </span><span class="s4">== </span><span class="s6">0.5</span><span class="s4">:</span>
                    <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  o_color.rgb = sqrt(o_color.rgb);</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s3">elif </span><span class="s1">gamma </span><span class="s4">== </span><span class="s6">2.0</span><span class="s4">:</span>
                    <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  o_color.rgb *= o_color.rgb;</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s3">elif </span><span class="s1">gamma </span><span class="s4">!= </span><span class="s6">1.0</span><span class="s4">:</span>
                    <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  o_color.rgb = pow(o_color.rgb, %ff);</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% (</span><span class="s1">gamma</span><span class="s4">)</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;SrgbEncode&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  o_color.r = (o_color.r &lt; 0.0031308) ? (o_color.r * 12.92) : (1.055 * pow(o_color.r, 0.41666) - 0.055);</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  o_color.g = (o_color.g &lt; 0.0031308) ? (o_color.g * 12.92) : (1.055 * pow(o_color.g, 0.41666) - 0.055);</span><span class="s3">\n</span><span class="s5">&quot;</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  o_color.b = (o_color.b &lt; 0.0031308) ? (o_color.b * 12.92) : (1.055 * pow(o_color.b, 0.41666) - 0.055);</span><span class="s3">\n</span><span class="s5">&quot;</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;Inverted&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;  o_color = float4(1, 1, 1, 1) - o_color;</span><span class="s3">\n</span><span class="s5">&quot;</span>
            <span class="s1">text </span><span class="s4">+= </span><span class="s5">&quot;}</span><span class="s3">\n</span><span class="s5">&quot;</span>

            <span class="s1">shader </span><span class="s4">= </span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">text</span><span class="s4">, </span><span class="s1">Shader</span><span class="s4">.</span><span class="s1">SL_Cg</span><span class="s4">)</span>
            <span class="s3">if not </span><span class="s1">shader</span><span class="s4">:</span>
                <span class="s3">return False</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">finalQuad</span><span class="s4">.</span><span class="s1">setShader</span><span class="s4">(</span><span class="s1">shader</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">tex </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">finalQuad</span><span class="s4">.</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;tx&quot;</span><span class="s4">+</span><span class="s1">tex</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">textures</span><span class="s4">[</span><span class="s1">tex</span><span class="s4">])</span>

            <span class="s1">self</span><span class="s4">.</span><span class="s1">task </span><span class="s4">= </span><span class="s1">taskMgr</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">update</span><span class="s4">, </span><span class="s5">&quot;common-filters-update&quot;</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s4">(</span><span class="s1">changed </span><span class="s4">== </span><span class="s5">&quot;CartoonInk&quot;</span><span class="s4">) </span><span class="s3">or </span><span class="s1">fullrebuild</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;CartoonInk&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">c </span><span class="s4">= </span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;CartoonInk&quot;</span><span class="s4">]</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">finalQuad</span><span class="s4">.</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;cartoonseparation&quot;</span><span class="s4">, </span><span class="s1">LVecBase4</span><span class="s4">(</span><span class="s1">c</span><span class="s4">.</span><span class="s1">separation</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s1">c</span><span class="s4">.</span><span class="s1">separation</span><span class="s4">, </span><span class="s6">0</span><span class="s4">))</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">finalQuad</span><span class="s4">.</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;cartooncolor&quot;</span><span class="s4">, </span><span class="s1">c</span><span class="s4">.</span><span class="s1">color</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s4">(</span><span class="s1">changed </span><span class="s4">== </span><span class="s5">&quot;BlurSharpen&quot;</span><span class="s4">) </span><span class="s3">or </span><span class="s1">fullrebuild</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;BlurSharpen&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">blurval </span><span class="s4">= </span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;BlurSharpen&quot;</span><span class="s4">]</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">finalQuad</span><span class="s4">.</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;blurval&quot;</span><span class="s4">, </span><span class="s1">LVecBase4</span><span class="s4">(</span><span class="s1">blurval</span><span class="s4">, </span><span class="s1">blurval</span><span class="s4">, </span><span class="s1">blurval</span><span class="s4">, </span><span class="s1">blurval</span><span class="s4">))</span>

        <span class="s3">if </span><span class="s4">(</span><span class="s1">changed </span><span class="s4">== </span><span class="s5">&quot;Bloom&quot;</span><span class="s4">) </span><span class="s3">or </span><span class="s1">fullrebuild</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;Bloom&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">bloomconf </span><span class="s4">= </span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;Bloom&quot;</span><span class="s4">]</span>
                <span class="s1">intensity </span><span class="s4">= </span><span class="s1">bloomconf</span><span class="s4">.</span><span class="s1">intensity </span><span class="s4">* </span><span class="s6">3.0</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;blend&quot;</span><span class="s4">, </span><span class="s1">bloomconf</span><span class="s4">.</span><span class="s1">blendx</span><span class="s4">, </span><span class="s1">bloomconf</span><span class="s4">.</span><span class="s1">blendy</span><span class="s4">, </span><span class="s1">bloomconf</span><span class="s4">.</span><span class="s1">blendz</span><span class="s4">, </span><span class="s1">bloomconf</span><span class="s4">.</span><span class="s1">blendw </span><span class="s4">* </span><span class="s6">2.0</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;trigger&quot;</span><span class="s4">, </span><span class="s1">bloomconf</span><span class="s4">.</span><span class="s1">mintrigger</span><span class="s4">, </span><span class="s6">1.0</span><span class="s4">/(</span><span class="s1">bloomconf</span><span class="s4">.</span><span class="s1">maxtrigger</span><span class="s4">-</span><span class="s1">bloomconf</span><span class="s4">.</span><span class="s1">mintrigger</span><span class="s4">), </span><span class="s6">0.0</span><span class="s4">, </span><span class="s6">0.0</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;desat&quot;</span><span class="s4">, </span><span class="s1">bloomconf</span><span class="s4">.</span><span class="s1">desat</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">bloom</span><span class="s4">[</span><span class="s6">3</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;intensity&quot;</span><span class="s4">, </span><span class="s1">intensity</span><span class="s4">, </span><span class="s1">intensity</span><span class="s4">, </span><span class="s1">intensity</span><span class="s4">, </span><span class="s1">intensity</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s4">(</span><span class="s1">changed </span><span class="s4">== </span><span class="s5">&quot;VolumetricLighting&quot;</span><span class="s4">) </span><span class="s3">or </span><span class="s1">fullrebuild</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;VolumetricLighting&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">config </span><span class="s4">= </span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;VolumetricLighting&quot;</span><span class="s4">]</span>
                <span class="s1">tcparam </span><span class="s4">= </span><span class="s1">config</span><span class="s4">.</span><span class="s1">density </span><span class="s4">/ </span><span class="s1">float</span><span class="s4">(</span><span class="s1">config</span><span class="s4">.</span><span class="s1">numsamples</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">finalQuad</span><span class="s4">.</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;vlparams&quot;</span><span class="s4">, </span><span class="s1">tcparam</span><span class="s4">, </span><span class="s1">config</span><span class="s4">.</span><span class="s1">decay</span><span class="s4">, </span><span class="s1">config</span><span class="s4">.</span><span class="s1">exposure</span><span class="s4">, </span><span class="s6">0.0</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s4">(</span><span class="s1">changed </span><span class="s4">== </span><span class="s5">&quot;AmbientOcclusion&quot;</span><span class="s4">) </span><span class="s3">or </span><span class="s1">fullrebuild</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;AmbientOcclusion&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">config </span><span class="s4">= </span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;AmbientOcclusion&quot;</span><span class="s4">]</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ssao</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;params1&quot;</span><span class="s4">, </span><span class="s1">config</span><span class="s4">.</span><span class="s1">numsamples</span><span class="s4">, -</span><span class="s1">float</span><span class="s4">(</span><span class="s1">config</span><span class="s4">.</span><span class="s1">amount</span><span class="s4">) / </span><span class="s1">config</span><span class="s4">.</span><span class="s1">numsamples</span><span class="s4">, </span><span class="s1">config</span><span class="s4">.</span><span class="s1">radius</span><span class="s4">, </span><span class="s6">0</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ssao</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;params2&quot;</span><span class="s4">, </span><span class="s1">config</span><span class="s4">.</span><span class="s1">strength</span><span class="s4">, </span><span class="s1">config</span><span class="s4">.</span><span class="s1">falloff</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s4">(</span><span class="s1">changed </span><span class="s4">== </span><span class="s5">&quot;ExposureAdjust&quot;</span><span class="s4">) </span><span class="s3">or </span><span class="s1">fullrebuild</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;ExposureAdjust&quot; </span><span class="s3">in </span><span class="s1">configuration</span><span class="s4">):</span>
                <span class="s1">stops </span><span class="s4">= </span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;ExposureAdjust&quot;</span><span class="s4">]</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">finalQuad</span><span class="s4">.</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;exposure&quot;</span><span class="s4">, </span><span class="s6">2 </span><span class="s4">** </span><span class="s1">stops</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">update</span><span class="s4">()</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">update</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">task </span><span class="s4">= </span><span class="s3">None</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Updates the shader inputs that need to be updated every frame. 
        Normally, you shouldn't call this, it's being called in a task.&quot;&quot;&quot;</span>

        <span class="s3">if </span><span class="s5">&quot;VolumetricLighting&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">:</span>
            <span class="s1">caster </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;VolumetricLighting&quot;</span><span class="s4">].</span><span class="s1">caster</span>
            <span class="s1">casterpos </span><span class="s4">= </span><span class="s1">LPoint2</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">camera</span><span class="s4">.</span><span class="s1">node</span><span class="s4">().</span><span class="s1">getLens</span><span class="s4">().</span><span class="s1">project</span><span class="s4">(</span><span class="s1">caster</span><span class="s4">.</span><span class="s1">getPos</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">camera</span><span class="s4">), </span><span class="s1">casterpos</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">finalQuad</span><span class="s4">.</span><span class="s1">setShaderInput</span><span class="s4">(</span><span class="s5">&quot;casterpos&quot;</span><span class="s4">, </span><span class="s1">LVecBase4</span><span class="s4">(</span><span class="s1">casterpos</span><span class="s4">.</span><span class="s1">getX</span><span class="s4">() * </span><span class="s6">0.5 </span><span class="s4">+ </span><span class="s6">0.5</span><span class="s4">, (</span><span class="s1">casterpos</span><span class="s4">.</span><span class="s1">getY</span><span class="s4">() * </span><span class="s6">0.5 </span><span class="s4">+ </span><span class="s6">0.5</span><span class="s4">), </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">))</span>
        <span class="s3">if </span><span class="s1">task </span><span class="s4">!= </span><span class="s3">None</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">task</span><span class="s4">.</span><span class="s1">cont</span>

    <span class="s3">def </span><span class="s1">setMSAA</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">samples</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Enables multisample anti-aliasing on the render-to-texture buffer. 
        If you enable this, it is recommended to leave any multisample request 
        on the main framebuffer OFF (ie. don't set framebuffer-multisample true 
        in Config.prc), since it would be a waste of resources otherwise. 
 
        .. versionadded:: 1.10.13 
        &quot;&quot;&quot;</span>
        <span class="s1">fullrebuild </span><span class="s4">= </span><span class="s5">&quot;MSAA&quot; </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration </span><span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;MSAA&quot;</span><span class="s4">].</span><span class="s1">samples </span><span class="s4">!= </span><span class="s1">samples</span>
        <span class="s1">newconfig </span><span class="s4">= </span><span class="s1">FilterConfig</span><span class="s4">()</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">samples </span><span class="s4">= </span><span class="s1">samples</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;MSAA&quot;</span><span class="s4">] = </span><span class="s1">newconfig</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s1">fullrebuild</span><span class="s4">, </span><span class="s5">&quot;MSAA&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">delMSAA</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s5">&quot;MSAA&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">:</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;MSAA&quot;</span><span class="s4">]</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s5">&quot;MSAA&quot;</span><span class="s4">)</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">setCartoonInk</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">separation</span><span class="s4">=</span><span class="s6">1</span><span class="s4">, </span><span class="s1">color</span><span class="s4">=(</span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)):</span>
        <span class="s1">fullrebuild </span><span class="s4">= ((</span><span class="s5">&quot;CartoonInk&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">) == </span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">newconfig </span><span class="s4">= </span><span class="s1">FilterConfig</span><span class="s4">()</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">separation </span><span class="s4">= </span><span class="s1">separation</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">color </span><span class="s4">= </span><span class="s1">color</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;CartoonInk&quot;</span><span class="s4">] = </span><span class="s1">newconfig</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s1">fullrebuild</span><span class="s4">, </span><span class="s5">&quot;CartoonInk&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">delCartoonInk</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;CartoonInk&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">):</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;CartoonInk&quot;</span><span class="s4">]</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s5">&quot;CartoonInk&quot;</span><span class="s4">)</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">setBloom</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">blend</span><span class="s4">=(</span><span class="s6">0.3</span><span class="s4">,</span><span class="s6">0.4</span><span class="s4">,</span><span class="s6">0.3</span><span class="s4">,</span><span class="s6">0.0</span><span class="s4">), </span><span class="s1">mintrigger</span><span class="s4">=</span><span class="s6">0.6</span><span class="s4">, </span><span class="s1">maxtrigger</span><span class="s4">=</span><span class="s6">1.0</span><span class="s4">, </span><span class="s1">desat</span><span class="s4">=</span><span class="s6">0.6</span><span class="s4">, </span><span class="s1">intensity</span><span class="s4">=</span><span class="s6">1.0</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=</span><span class="s5">&quot;medium&quot;</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Applies the Bloom filter to the output. 
        size can either be &quot;off&quot;, &quot;small&quot;, &quot;medium&quot;, or &quot;large&quot;. 
        Setting size to &quot;off&quot; will remove the Bloom filter. 
        &quot;&quot;&quot;</span>
        <span class="s3">if   </span><span class="s4">(</span><span class="s1">size</span><span class="s4">==</span><span class="s6">0</span><span class="s4">): </span><span class="s1">size</span><span class="s4">=</span><span class="s5">&quot;off&quot;</span>
        <span class="s3">elif </span><span class="s4">(</span><span class="s1">size</span><span class="s4">==</span><span class="s6">1</span><span class="s4">): </span><span class="s1">size</span><span class="s4">=</span><span class="s5">&quot;small&quot;</span>
        <span class="s3">elif </span><span class="s4">(</span><span class="s1">size</span><span class="s4">==</span><span class="s6">2</span><span class="s4">): </span><span class="s1">size</span><span class="s4">=</span><span class="s5">&quot;medium&quot;</span>
        <span class="s3">elif </span><span class="s4">(</span><span class="s1">size</span><span class="s4">==</span><span class="s6">3</span><span class="s4">): </span><span class="s1">size</span><span class="s4">=</span><span class="s5">&quot;large&quot;</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s1">size</span><span class="s4">==</span><span class="s5">&quot;off&quot;</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">delBloom</span><span class="s4">()</span>
            <span class="s3">return</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s1">maxtrigger</span><span class="s4">==</span><span class="s3">None</span><span class="s4">): </span><span class="s1">maxtrigger</span><span class="s4">=</span><span class="s1">mintrigger</span><span class="s4">+</span><span class="s6">0.8</span>
        <span class="s1">oldconfig </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">&quot;Bloom&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">fullrebuild </span><span class="s4">= </span><span class="s3">True</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s1">oldconfig</span><span class="s4">) </span><span class="s3">and </span><span class="s4">(</span><span class="s1">oldconfig</span><span class="s4">.</span><span class="s1">size </span><span class="s4">== </span><span class="s1">size</span><span class="s4">):</span>
            <span class="s1">fullrebuild </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">newconfig </span><span class="s4">= </span><span class="s1">FilterConfig</span><span class="s4">()</span>
        <span class="s4">(</span><span class="s1">newconfig</span><span class="s4">.</span><span class="s1">blendx</span><span class="s4">, </span><span class="s1">newconfig</span><span class="s4">.</span><span class="s1">blendy</span><span class="s4">, </span><span class="s1">newconfig</span><span class="s4">.</span><span class="s1">blendz</span><span class="s4">, </span><span class="s1">newconfig</span><span class="s4">.</span><span class="s1">blendw</span><span class="s4">) = </span><span class="s1">blend</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">maxtrigger </span><span class="s4">= </span><span class="s1">maxtrigger</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">mintrigger </span><span class="s4">= </span><span class="s1">mintrigger</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">desat </span><span class="s4">= </span><span class="s1">desat</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">intensity </span><span class="s4">= </span><span class="s1">intensity</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">size </span><span class="s4">= </span><span class="s1">size</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;Bloom&quot;</span><span class="s4">] = </span><span class="s1">newconfig</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s1">fullrebuild</span><span class="s4">, </span><span class="s5">&quot;Bloom&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">delBloom</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;Bloom&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">):</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;Bloom&quot;</span><span class="s4">]</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s5">&quot;Bloom&quot;</span><span class="s4">)</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">setHalfPixelShift</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">fullrebuild </span><span class="s4">= ((</span><span class="s5">&quot;HalfPixelShift&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">) == </span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;HalfPixelShift&quot;</span><span class="s4">] = </span><span class="s6">1</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s1">fullrebuild</span><span class="s4">, </span><span class="s5">&quot;HalfPixelShift&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">delHalfPixelShift</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;HalfPixelShift&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">):</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;HalfPixelShift&quot;</span><span class="s4">]</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s5">&quot;HalfPixelShift&quot;</span><span class="s4">)</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">setViewGlow</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">fullrebuild </span><span class="s4">= ((</span><span class="s5">&quot;ViewGlow&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">) == </span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;ViewGlow&quot;</span><span class="s4">] = </span><span class="s6">1</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s1">fullrebuild</span><span class="s4">, </span><span class="s5">&quot;ViewGlow&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">delViewGlow</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;ViewGlow&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">):</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;ViewGlow&quot;</span><span class="s4">]</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s5">&quot;ViewGlow&quot;</span><span class="s4">)</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">setInverted</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">fullrebuild </span><span class="s4">= ((</span><span class="s5">&quot;Inverted&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">) == </span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;Inverted&quot;</span><span class="s4">] = </span><span class="s6">1</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s1">fullrebuild</span><span class="s4">, </span><span class="s5">&quot;Inverted&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">delInverted</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;Inverted&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">):</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;Inverted&quot;</span><span class="s4">]</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s5">&quot;Inverted&quot;</span><span class="s4">)</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">setVolumetricLighting</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">caster</span><span class="s4">, </span><span class="s1">numsamples </span><span class="s4">= </span><span class="s6">32</span><span class="s4">, </span><span class="s1">density </span><span class="s4">= </span><span class="s6">5.0</span><span class="s4">, </span><span class="s1">decay </span><span class="s4">= </span><span class="s6">0.1</span><span class="s4">, </span><span class="s1">exposure </span><span class="s4">= </span><span class="s6">0.1</span><span class="s4">, </span><span class="s1">source </span><span class="s4">= </span><span class="s5">&quot;color&quot;</span><span class="s4">):</span>
        <span class="s1">oldconfig </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">&quot;VolumetricLighting&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">fullrebuild </span><span class="s4">= </span><span class="s3">True</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s1">oldconfig</span><span class="s4">) </span><span class="s3">and </span><span class="s4">(</span><span class="s1">oldconfig</span><span class="s4">.</span><span class="s1">source </span><span class="s4">== </span><span class="s1">source</span><span class="s4">) </span><span class="s3">and </span><span class="s4">(</span><span class="s1">oldconfig</span><span class="s4">.</span><span class="s1">numsamples </span><span class="s4">== </span><span class="s1">int</span><span class="s4">(</span><span class="s1">numsamples</span><span class="s4">)):</span>
            <span class="s1">fullrebuild </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">newconfig </span><span class="s4">= </span><span class="s1">FilterConfig</span><span class="s4">()</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">caster </span><span class="s4">= </span><span class="s1">caster</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">numsamples </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">numsamples</span><span class="s4">)</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">density </span><span class="s4">= </span><span class="s1">density</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">decay </span><span class="s4">= </span><span class="s1">decay</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">exposure </span><span class="s4">= </span><span class="s1">exposure</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">source </span><span class="s4">= </span><span class="s1">source</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;VolumetricLighting&quot;</span><span class="s4">] = </span><span class="s1">newconfig</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s1">fullrebuild</span><span class="s4">, </span><span class="s5">&quot;VolumetricLighting&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">delVolumetricLighting</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;VolumetricLighting&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">):</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;VolumetricLighting&quot;</span><span class="s4">]</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s5">&quot;VolumetricLighting&quot;</span><span class="s4">)</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">setBlurSharpen</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">amount</span><span class="s4">=</span><span class="s6">0.0</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Enables the blur/sharpen filter. If the 'amount' parameter is 1.0, it will not have any effect. 
        A value of 0.0 means fully blurred, and a value higher than 1.0 sharpens the image.&quot;&quot;&quot;</span>
        <span class="s1">fullrebuild </span><span class="s4">= ((</span><span class="s5">&quot;BlurSharpen&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">) == </span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;BlurSharpen&quot;</span><span class="s4">] = </span><span class="s1">amount</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s1">fullrebuild</span><span class="s4">, </span><span class="s5">&quot;BlurSharpen&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">delBlurSharpen</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;BlurSharpen&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">):</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;BlurSharpen&quot;</span><span class="s4">]</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s5">&quot;BlurSharpen&quot;</span><span class="s4">)</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">setAmbientOcclusion</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">numsamples </span><span class="s4">= </span><span class="s6">16</span><span class="s4">, </span><span class="s1">radius </span><span class="s4">= </span><span class="s6">0.05</span><span class="s4">, </span><span class="s1">amount </span><span class="s4">= </span><span class="s6">2.0</span><span class="s4">, </span><span class="s1">strength </span><span class="s4">= </span><span class="s6">0.01</span><span class="s4">, </span><span class="s1">falloff </span><span class="s4">= </span><span class="s6">0.000002</span><span class="s4">):</span>
        <span class="s1">fullrebuild </span><span class="s4">= ((</span><span class="s5">&quot;AmbientOcclusion&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">) == </span><span class="s3">False</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s4">(</span><span class="s3">not </span><span class="s1">fullrebuild</span><span class="s4">):</span>
            <span class="s1">fullrebuild </span><span class="s4">= (</span><span class="s1">numsamples </span><span class="s4">!= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;AmbientOcclusion&quot;</span><span class="s4">].</span><span class="s1">numsamples</span><span class="s4">)</span>

        <span class="s1">newconfig </span><span class="s4">= </span><span class="s1">FilterConfig</span><span class="s4">()</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">numsamples </span><span class="s4">= </span><span class="s1">numsamples</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">radius </span><span class="s4">= </span><span class="s1">radius</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">amount </span><span class="s4">= </span><span class="s1">amount</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">strength </span><span class="s4">= </span><span class="s1">strength</span>
        <span class="s1">newconfig</span><span class="s4">.</span><span class="s1">falloff </span><span class="s4">= </span><span class="s1">falloff</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;AmbientOcclusion&quot;</span><span class="s4">] = </span><span class="s1">newconfig</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s1">fullrebuild</span><span class="s4">, </span><span class="s5">&quot;AmbientOcclusion&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">delAmbientOcclusion</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;AmbientOcclusion&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">):</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;AmbientOcclusion&quot;</span><span class="s4">]</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s5">&quot;AmbientOcclusion&quot;</span><span class="s4">)</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">setGammaAdjust</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">gamma</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot; Applies additional gamma correction to the image.  1.0 = no correction. &quot;&quot;&quot;</span>
        <span class="s1">old_gamma </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">&quot;GammaAdjust&quot;</span><span class="s4">, </span><span class="s6">1.0</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">old_gamma </span><span class="s4">!= </span><span class="s1">gamma</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;GammaAdjust&quot;</span><span class="s4">] = </span><span class="s1">gamma</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s5">&quot;GammaAdjust&quot;</span><span class="s4">)</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">delGammaAdjust</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;GammaAdjust&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">):</span>
            <span class="s1">old_gamma </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;GammaAdjust&quot;</span><span class="s4">]</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;GammaAdjust&quot;</span><span class="s4">]</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">((</span><span class="s1">old_gamma </span><span class="s4">!= </span><span class="s6">1.0</span><span class="s4">), </span><span class="s5">&quot;GammaAdjust&quot;</span><span class="s4">)</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">setSrgbEncode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">force</span><span class="s4">=</span><span class="s3">False</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot; Applies the inverse sRGB EOTF to the output, unless the window 
        already has an sRGB framebuffer, in which case this filter refuses to 
        apply, to prevent accidental double-application. 
 
        Set the force argument to True to force it to be applied in all cases. 
 
        .. versionadded:: 1.10.7 
        &quot;&quot;&quot;</span>
        <span class="s1">new_enable </span><span class="s4">= </span><span class="s1">force </span><span class="s3">or not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">win</span><span class="s4">.</span><span class="s1">getFbProperties</span><span class="s4">().</span><span class="s1">getSrgbColor</span><span class="s4">()</span>
        <span class="s1">old_enable </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">&quot;SrgbEncode&quot;</span><span class="s4">, </span><span class="s3">False</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">new_enable </span><span class="s3">and not </span><span class="s1">old_enable</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;SrgbEncode&quot;</span><span class="s4">] = </span><span class="s3">True</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s5">&quot;SrgbEncode&quot;</span><span class="s4">)</span>
        <span class="s3">elif not </span><span class="s1">new_enable </span><span class="s3">and </span><span class="s1">old_enable</span><span class="s4">:</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;SrgbEncode&quot;</span><span class="s4">]</span>
        <span class="s3">return </span><span class="s1">new_enable</span>

    <span class="s3">def </span><span class="s1">delSrgbEncode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot; Reverses the effects of setSrgbEncode. &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;SrgbEncode&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">):</span>
            <span class="s1">old_enable </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;SrgbEncode&quot;</span><span class="s4">]</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;SrgbEncode&quot;</span><span class="s4">]</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s1">old_enable</span><span class="s4">, </span><span class="s5">&quot;SrgbEncode&quot;</span><span class="s4">)</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">setHighDynamicRange</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot; Enables HDR rendering by using a floating-point framebuffer, 
        disabling color clamping on the main scene, and applying a tone map 
        operator (ACES). 
 
        It may also be necessary to use setExposureAdjust to perform exposure 
        compensation on the scene, depending on the lighting intensity. 
 
        .. versionadded:: 1.10.7 
        &quot;&quot;&quot;</span>

        <span class="s1">fullrebuild </span><span class="s4">= ((</span><span class="s5">&quot;HighDynamicRange&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">) </span><span class="s3">is False</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;HighDynamicRange&quot;</span><span class="s4">] = </span><span class="s6">1</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s1">fullrebuild</span><span class="s4">, </span><span class="s5">&quot;HighDynamicRange&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">delHighDynamicRange</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;HighDynamicRange&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">):</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;HighDynamicRange&quot;</span><span class="s4">]</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s5">&quot;HighDynamicRange&quot;</span><span class="s4">)</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">setExposureAdjust</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">stops</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot; Sets a relative exposure adjustment to multiply with the result of 
        rendering the scene, in stops.  A value of 0 means no adjustment, a 
        positive value will result in a brighter image.  Useful in conjunction 
        with HDR, see setHighDynamicRange. 
 
        .. versionadded:: 1.10.7 
        &quot;&quot;&quot;</span>
        <span class="s1">old_stops </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">&quot;ExposureAdjust&quot;</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">old_stops </span><span class="s4">!= </span><span class="s1">stops</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;ExposureAdjust&quot;</span><span class="s4">] = </span><span class="s1">stops</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s1">old_stops </span><span class="s3">is None</span><span class="s4">, </span><span class="s5">&quot;ExposureAdjust&quot;</span><span class="s4">)</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">delExposureAdjust</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s5">&quot;ExposureAdjust&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">):</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configuration</span><span class="s4">[</span><span class="s5">&quot;ExposureAdjust&quot;</span><span class="s4">]</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reconfigure</span><span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s5">&quot;ExposureAdjust&quot;</span><span class="s4">)</span>
        <span class="s3">return True</span>

    <span class="s2">#snake_case alias:</span>
    <span class="s1">set_msaa </span><span class="s4">= </span><span class="s1">setMSAA</span>
    <span class="s1">del_msaa </span><span class="s4">= </span><span class="s1">delMSAA</span>
    <span class="s1">del_cartoon_ink </span><span class="s4">= </span><span class="s1">delCartoonInk</span>
    <span class="s1">set_half_pixel_shift </span><span class="s4">= </span><span class="s1">setHalfPixelShift</span>
    <span class="s1">del_half_pixel_shift </span><span class="s4">= </span><span class="s1">delHalfPixelShift</span>
    <span class="s1">set_inverted </span><span class="s4">= </span><span class="s1">setInverted</span>
    <span class="s1">del_inverted </span><span class="s4">= </span><span class="s1">delInverted</span>
    <span class="s1">del_view_glow </span><span class="s4">= </span><span class="s1">delViewGlow</span>
    <span class="s1">set_volumetric_lighting </span><span class="s4">= </span><span class="s1">setVolumetricLighting</span>
    <span class="s1">set_bloom </span><span class="s4">= </span><span class="s1">setBloom</span>
    <span class="s1">set_view_glow </span><span class="s4">= </span><span class="s1">setViewGlow</span>
    <span class="s1">set_ambient_occlusion </span><span class="s4">= </span><span class="s1">setAmbientOcclusion</span>
    <span class="s1">set_cartoon_ink </span><span class="s4">= </span><span class="s1">setCartoonInk</span>
    <span class="s1">del_bloom </span><span class="s4">= </span><span class="s1">delBloom</span>
    <span class="s1">del_ambient_occlusion </span><span class="s4">= </span><span class="s1">delAmbientOcclusion</span>
    <span class="s1">set_blur_sharpen </span><span class="s4">= </span><span class="s1">setBlurSharpen</span>
    <span class="s1">del_blur_sharpen </span><span class="s4">= </span><span class="s1">delBlurSharpen</span>
    <span class="s1">del_volumetric_lighting </span><span class="s4">= </span><span class="s1">delVolumetricLighting</span>
    <span class="s1">set_gamma_adjust </span><span class="s4">= </span><span class="s1">setGammaAdjust</span>
    <span class="s1">del_gamma_adjust </span><span class="s4">= </span><span class="s1">delGammaAdjust</span>
    <span class="s1">set_srgb_encode </span><span class="s4">= </span><span class="s1">setSrgbEncode</span>
    <span class="s1">del_srgb_encode </span><span class="s4">= </span><span class="s1">delSrgbEncode</span>
    <span class="s1">set_exposure_adjust </span><span class="s4">= </span><span class="s1">setExposureAdjust</span>
    <span class="s1">del_exposure_adjust </span><span class="s4">= </span><span class="s1">delExposureAdjust</span>
    <span class="s1">set_high_dynamic_range </span><span class="s4">= </span><span class="s1">setHighDynamicRange</span>
    <span class="s1">del_high_dynamic_range </span><span class="s4">= </span><span class="s1">delHighDynamicRange</span>
</pre>
</body>
</html>