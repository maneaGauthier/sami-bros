<html>
<head>
<title>_collections.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #7a7e85;}
.s3 { color: #bcbec4;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_collections.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">collections</span>
<span class="s0">import </span><span class="s1">functools</span>
<span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">operator</span>


<span class="s2"># from jaraco.collections 3.5.1</span>
<span class="s0">class </span><span class="s1">DictStack</span><span class="s3">(</span><span class="s1">list</span><span class="s3">, </span><span class="s1">collections</span><span class="s3">.</span><span class="s1">abc</span><span class="s3">.</span><span class="s1">Mapping</span><span class="s3">):</span>
    <span class="s4">&quot;&quot;&quot; 
    A stack of dictionaries that behaves as a view on those dictionaries, 
    giving preference to the last. 
 
    &gt;&gt;&gt; stack = DictStack([dict(a=1, c=2), dict(b=2, a=2)]) 
    &gt;&gt;&gt; stack['a'] 
    2 
    &gt;&gt;&gt; stack['b'] 
    2 
    &gt;&gt;&gt; stack['c'] 
    2 
    &gt;&gt;&gt; len(stack) 
    3 
    &gt;&gt;&gt; stack.push(dict(a=3)) 
    &gt;&gt;&gt; stack['a'] 
    3 
    &gt;&gt;&gt; set(stack.keys()) == set(['a', 'b', 'c']) 
    True 
    &gt;&gt;&gt; set(stack.items()) == set([('a', 3), ('b', 2), ('c', 2)]) 
    True 
    &gt;&gt;&gt; dict(**stack) == dict(stack) == dict(a=3, c=2, b=2) 
    True 
    &gt;&gt;&gt; d = stack.pop() 
    &gt;&gt;&gt; stack['a'] 
    2 
    &gt;&gt;&gt; d = stack.pop() 
    &gt;&gt;&gt; stack['a'] 
    1 
    &gt;&gt;&gt; stack.get('b', None) 
    &gt;&gt;&gt; 'c' in stack 
    True 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">dicts </span><span class="s3">= </span><span class="s1">list</span><span class="s3">.</span><span class="s1">__iter__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s0">return </span><span class="s1">iter</span><span class="s3">(</span><span class="s1">set</span><span class="s3">(</span><span class="s1">itertools</span><span class="s3">.</span><span class="s1">chain</span><span class="s3">.</span><span class="s1">from_iterable</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">() </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">dicts</span><span class="s3">)))</span>

    <span class="s0">def </span><span class="s1">__getitem__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">):</span>
        <span class="s0">for </span><span class="s1">scope </span><span class="s0">in </span><span class="s1">reversed</span><span class="s3">(</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">list</span><span class="s3">.</span><span class="s1">__iter__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">))):</span>
            <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">scope</span><span class="s3">:</span>
                <span class="s0">return </span><span class="s1">scope</span><span class="s3">[</span><span class="s1">key</span><span class="s3">]</span>
        <span class="s0">raise </span><span class="s1">KeyError</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)</span>

    <span class="s1">push </span><span class="s3">= </span><span class="s1">list</span><span class="s3">.</span><span class="s1">append</span>

    <span class="s0">def </span><span class="s1">__contains__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s1">collections</span><span class="s3">.</span><span class="s1">abc</span><span class="s3">.</span><span class="s1">Mapping</span><span class="s3">.</span><span class="s1">__contains__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">__len__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">iter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)))</span>


<span class="s2"># from jaraco.collections 3.7</span>
<span class="s0">class </span><span class="s1">RangeMap</span><span class="s3">(</span><span class="s1">dict</span><span class="s3">):</span>
    <span class="s4">&quot;&quot;&quot; 
    A dictionary-like object that uses the keys as bounds for a range. 
    Inclusion of the value for that range is determined by the 
    key_match_comparator, which defaults to less-than-or-equal. 
    A value is returned for a key if it is the first key that matches in 
    the sorted list of keys. 
 
    One may supply keyword parameters to be passed to the sort function used 
    to sort keys (i.e. key, reverse) as sort_params. 
 
    Let's create a map that maps 1-3 -&gt; 'a', 4-6 -&gt; 'b' 
 
    &gt;&gt;&gt; r = RangeMap({3: 'a', 6: 'b'})  # boy, that was easy 
    &gt;&gt;&gt; r[1], r[2], r[3], r[4], r[5], r[6] 
    ('a', 'a', 'a', 'b', 'b', 'b') 
 
    Even float values should work so long as the comparison operator 
    supports it. 
 
    &gt;&gt;&gt; r[4.5] 
    'b' 
 
    But you'll notice that the way rangemap is defined, it must be open-ended 
    on one side. 
 
    &gt;&gt;&gt; r[0] 
    'a' 
    &gt;&gt;&gt; r[-1] 
    'a' 
 
    One can close the open-end of the RangeMap by using undefined_value 
 
    &gt;&gt;&gt; r = RangeMap({0: RangeMap.undefined_value, 3: 'a', 6: 'b'}) 
    &gt;&gt;&gt; r[0] 
    Traceback (most recent call last): 
    ... 
    KeyError: 0 
 
    One can get the first or last elements in the range by using RangeMap.Item 
 
    &gt;&gt;&gt; last_item = RangeMap.Item(-1) 
    &gt;&gt;&gt; r[last_item] 
    'b' 
 
    .last_item is a shortcut for Item(-1) 
 
    &gt;&gt;&gt; r[RangeMap.last_item] 
    'b' 
 
    Sometimes it's useful to find the bounds for a RangeMap 
 
    &gt;&gt;&gt; r.bounds() 
    (0, 6) 
 
    RangeMap supports .get(key, default) 
 
    &gt;&gt;&gt; r.get(0, 'not found') 
    'not found' 
 
    &gt;&gt;&gt; r.get(7, 'not found') 
    'not found' 
 
    One often wishes to define the ranges by their left-most values, 
    which requires use of sort params and a key_match_comparator. 
 
    &gt;&gt;&gt; r = RangeMap({1: 'a', 4: 'b'}, 
    ...     sort_params=dict(reverse=True), 
    ...     key_match_comparator=operator.ge) 
    &gt;&gt;&gt; r[1], r[2], r[3], r[4], r[5], r[6] 
    ('a', 'a', 'a', 'b', 'b', 'b') 
 
    That wasn't nearly as easy as before, so an alternate constructor 
    is provided: 
 
    &gt;&gt;&gt; r = RangeMap.left({1: 'a', 4: 'b', 7: RangeMap.undefined_value}) 
    &gt;&gt;&gt; r[1], r[2], r[3], r[4], r[5], r[6] 
    ('a', 'a', 'a', 'b', 'b', 'b') 
 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">source</span><span class="s3">, </span><span class="s1">sort_params</span><span class="s3">={}, </span><span class="s1">key_match_comparator</span><span class="s3">=</span><span class="s1">operator</span><span class="s3">.</span><span class="s1">le</span><span class="s3">):</span>
        <span class="s1">dict</span><span class="s3">.</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">source</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sort_params </span><span class="s3">= </span><span class="s1">sort_params</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">match </span><span class="s3">= </span><span class="s1">key_match_comparator</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">left</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">source</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s3">(</span>
            <span class="s1">source</span><span class="s3">, </span><span class="s1">sort_params</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">reverse</span><span class="s3">=</span><span class="s0">True</span><span class="s3">), </span><span class="s1">key_match_comparator</span><span class="s3">=</span><span class="s1">operator</span><span class="s3">.</span><span class="s1">ge</span>
        <span class="s3">)</span>

    <span class="s0">def </span><span class="s1">__getitem__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">item</span><span class="s3">):</span>
        <span class="s1">sorted_keys </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">(), **</span><span class="s1">self</span><span class="s3">.</span><span class="s1">sort_params</span><span class="s3">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">item</span><span class="s3">, </span><span class="s1">RangeMap</span><span class="s3">.</span><span class="s1">Item</span><span class="s3">):</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__getitem__</span><span class="s3">(</span><span class="s1">sorted_keys</span><span class="s3">[</span><span class="s1">item</span><span class="s3">])</span>
        <span class="s0">else</span><span class="s3">:</span>
            <span class="s1">key </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_find_first_match_</span><span class="s3">(</span><span class="s1">sorted_keys</span><span class="s3">, </span><span class="s1">item</span><span class="s3">)</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">.</span><span class="s1">__getitem__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">)</span>
            <span class="s0">if </span><span class="s1">result </span><span class="s0">is </span><span class="s1">RangeMap</span><span class="s3">.</span><span class="s1">undefined_value</span><span class="s3">:</span>
                <span class="s0">raise </span><span class="s1">KeyError</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)</span>
        <span class="s0">return </span><span class="s1">result</span>

    <span class="s0">def </span><span class="s1">get</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">default</span><span class="s3">=</span><span class="s0">None</span><span class="s3">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Return the value for key if key is in the dictionary, else default. 
        If default is not given, it defaults to None, so that this method 
        never raises a KeyError. 
        &quot;&quot;&quot;</span>
        <span class="s0">try</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s3">[</span><span class="s1">key</span><span class="s3">]</span>
        <span class="s0">except </span><span class="s1">KeyError</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">default</span>

    <span class="s0">def </span><span class="s1">_find_first_match_</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">keys</span><span class="s3">, </span><span class="s1">item</span><span class="s3">):</span>
        <span class="s1">is_match </span><span class="s3">= </span><span class="s1">functools</span><span class="s3">.</span><span class="s1">partial</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">match</span><span class="s3">, </span><span class="s1">item</span><span class="s3">)</span>
        <span class="s1">matches </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">is_match</span><span class="s3">, </span><span class="s1">keys</span><span class="s3">))</span>
        <span class="s0">if </span><span class="s1">matches</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">matches</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s0">raise </span><span class="s1">KeyError</span><span class="s3">(</span><span class="s1">item</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">bounds</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">sorted_keys </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">(), **</span><span class="s1">self</span><span class="s3">.</span><span class="s1">sort_params</span><span class="s3">)</span>
        <span class="s0">return </span><span class="s3">(</span><span class="s1">sorted_keys</span><span class="s3">[</span><span class="s1">RangeMap</span><span class="s3">.</span><span class="s1">first_item</span><span class="s3">], </span><span class="s1">sorted_keys</span><span class="s3">[</span><span class="s1">RangeMap</span><span class="s3">.</span><span class="s1">last_item</span><span class="s3">])</span>

    <span class="s2"># some special values for the RangeMap</span>
    <span class="s1">undefined_value </span><span class="s3">= </span><span class="s1">type</span><span class="s3">(</span><span class="s6">'RangeValueUndefined'</span><span class="s3">, (), {})()</span>

    <span class="s0">class </span><span class="s1">Item</span><span class="s3">(</span><span class="s1">int</span><span class="s3">):</span>
        <span class="s4">&quot;RangeMap Item&quot;</span>

    <span class="s1">first_item </span><span class="s3">= </span><span class="s1">Item</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">last_item </span><span class="s3">= </span><span class="s1">Item</span><span class="s3">(-</span><span class="s5">1</span><span class="s3">)</span>
</pre>
</body>
</html>