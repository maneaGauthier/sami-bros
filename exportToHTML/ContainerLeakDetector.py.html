<html>
<head>
<title>ContainerLeakDetector.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ContainerLeakDetector.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">directnotify</span><span class="s2">.</span><span class="s1">DirectNotifyGlobal </span><span class="s0">import </span><span class="s1">directNotify</span>
<span class="s0">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase</span><span class="s2">.</span><span class="s1">PythonUtil </span><span class="s0">import </span><span class="s1">makeFlywheelGen</span>
<span class="s0">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase</span><span class="s2">.</span><span class="s1">PythonUtil </span><span class="s0">import </span><span class="s1">itype</span><span class="s2">, </span><span class="s1">serialNum</span><span class="s2">, </span><span class="s1">safeRepr</span><span class="s2">, </span><span class="s1">fastRepr</span>
<span class="s0">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase</span><span class="s2">.</span><span class="s1">Job </span><span class="s0">import </span><span class="s1">Job</span>
<span class="s0">import </span><span class="s1">types</span><span class="s2">, </span><span class="s1">weakref</span><span class="s2">, </span><span class="s1">random</span><span class="s2">, </span><span class="s1">sys</span>

<span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">):</span>
    <span class="s0">import </span><span class="s1">builtins </span><span class="s0">as </span><span class="s1">__builtin__</span>

    <span class="s1">intTypes </span><span class="s2">= (</span><span class="s1">int</span><span class="s2">,)</span>
    <span class="s1">deadEndTypes </span><span class="s2">= (</span><span class="s1">bool</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">BuiltinFunctionType</span><span class="s2">,</span>
                    <span class="s1">types</span><span class="s2">.</span><span class="s1">BuiltinMethodType</span><span class="s2">, </span><span class="s1">complex</span><span class="s2">,</span>
                    <span class="s1">float</span><span class="s2">, </span><span class="s1">int</span><span class="s2">,</span>
                    <span class="s1">type</span><span class="s2">(</span><span class="s0">None</span><span class="s2">), </span><span class="s1">type</span><span class="s2">(</span><span class="s1">NotImplemented</span><span class="s2">),</span>
                    <span class="s1">type</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">CodeType</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">,</span>
                    <span class="s1">bytes</span><span class="s2">, </span><span class="s1">str</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)</span>
<span class="s0">else</span><span class="s2">:</span>
    <span class="s0">import </span><span class="s1">__builtin__</span>

    <span class="s1">intTypes </span><span class="s2">= (</span><span class="s1">int</span><span class="s2">, </span><span class="s1">long</span><span class="s2">)</span>
    <span class="s1">deadEndTypes </span><span class="s2">= (</span><span class="s1">types</span><span class="s2">.</span><span class="s1">BooleanType</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">BuiltinFunctionType</span><span class="s2">,</span>
                    <span class="s1">types</span><span class="s2">.</span><span class="s1">BuiltinMethodType</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">ComplexType</span><span class="s2">,</span>
                    <span class="s1">types</span><span class="s2">.</span><span class="s1">FloatType</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">LongType</span><span class="s2">,</span>
                    <span class="s1">types</span><span class="s2">.</span><span class="s1">NoneType</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">NotImplementedType</span><span class="s2">,</span>
                    <span class="s1">types</span><span class="s2">.</span><span class="s1">TypeType</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">CodeType</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">,</span>
                    <span class="s1">types</span><span class="s2">.</span><span class="s1">StringType</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">UnicodeType</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">TupleType</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_createContainerLeak</span><span class="s2">():</span>
    <span class="s0">def </span><span class="s1">leakContainer</span><span class="s2">(</span><span class="s1">task</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">base </span><span class="s2">= </span><span class="s1">getBase</span><span class="s2">()</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">base</span><span class="s2">, </span><span class="s4">'leakContainer'</span><span class="s2">):</span>
            <span class="s1">base</span><span class="s2">.</span><span class="s1">leakContainer </span><span class="s2">= {}</span>
        <span class="s5"># use tuples as keys since they can't be weakref'd, and use an instance</span>
        <span class="s5"># since it can't be repr/eval'd</span>
        <span class="s5"># that will force the leak detector to hold a normal 'non-weak' reference</span>
        <span class="s0">class </span><span class="s1">LeakKey</span><span class="s2">:</span>
            <span class="s0">pass</span>
        <span class="s1">base</span><span class="s2">.</span><span class="s1">leakContainer</span><span class="s2">[(</span><span class="s1">LeakKey</span><span class="s2">(),)] = {}</span>
        <span class="s5"># test the non-weakref object reference handling</span>
        <span class="s0">if </span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">() &lt; </span><span class="s3">.01</span><span class="s2">:</span>
            <span class="s1">key </span><span class="s2">= </span><span class="s1">random</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">base</span><span class="s2">.</span><span class="s1">leakContainer</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()))</span>
            <span class="s1">ContainerLeakDetector</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span>
                <span class="s4">'removing reference to leakContainer key %s so it will be garbage-collected' </span><span class="s2">% </span><span class="s1">safeRepr</span><span class="s2">(</span><span class="s1">key</span><span class="s2">))</span>
            <span class="s0">del </span><span class="s1">base</span><span class="s2">.</span><span class="s1">leakContainer</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>
        <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">doMethodLater</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">leakContainer</span><span class="s2">, </span><span class="s4">'leakContainer-%s' </span><span class="s2">% </span><span class="s1">serialNum</span><span class="s2">())</span>
        <span class="s0">if </span><span class="s1">task</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">task</span><span class="s2">.</span><span class="s1">done</span>
    <span class="s1">leakContainer</span><span class="s2">()</span>

<span class="s0">def </span><span class="s1">_createTaskLeak</span><span class="s2">():</span>
    <span class="s1">leakTaskName </span><span class="s2">= </span><span class="s1">uniqueName</span><span class="s2">(</span><span class="s4">'leakedTask'</span><span class="s2">)</span>
    <span class="s1">leakDoLaterName </span><span class="s2">= </span><span class="s1">uniqueName</span><span class="s2">(</span><span class="s4">'leakedDoLater'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">nullTask</span><span class="s2">(</span><span class="s1">task</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">task</span><span class="s2">.</span><span class="s1">cont</span>
    <span class="s0">def </span><span class="s1">nullDoLater</span><span class="s2">(</span><span class="s1">task</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">task</span><span class="s2">.</span><span class="s1">done</span>
    <span class="s0">def </span><span class="s1">leakTask</span><span class="s2">(</span><span class="s1">task</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">leakTaskName</span><span class="s2">=</span><span class="s1">leakTaskName</span><span class="s2">):</span>
        <span class="s1">base </span><span class="s2">= </span><span class="s1">getBase</span><span class="s2">()</span>
        <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">nullTask</span><span class="s2">, </span><span class="s1">uniqueName</span><span class="s2">(</span><span class="s1">leakTaskName</span><span class="s2">))</span>
        <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">doMethodLater</span><span class="s2">(</span><span class="s3">1 </span><span class="s2">&lt;&lt; </span><span class="s3">31</span><span class="s2">, </span><span class="s1">nullDoLater</span><span class="s2">, </span><span class="s1">uniqueName</span><span class="s2">(</span><span class="s1">leakDoLaterName</span><span class="s2">))</span>
        <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">doMethodLater</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">leakTask</span><span class="s2">, </span><span class="s4">'doLeakTask-%s' </span><span class="s2">% </span><span class="s1">serialNum</span><span class="s2">())</span>
        <span class="s0">if </span><span class="s1">task</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">task</span><span class="s2">.</span><span class="s1">done</span>
    <span class="s1">leakTask</span><span class="s2">()</span>

<span class="s0">class </span><span class="s1">NoDictKey</span><span class="s2">:</span>
    <span class="s0">pass</span>

<span class="s0">class </span><span class="s1">Indirection</span><span class="s2">:</span>
    <span class="s6">&quot;&quot;&quot; 
    Represents the indirection that brings you from a container to an element of the container. 
    Stored as a string to be used as part of an eval, or as a key to be looked up in a dict. 
    Each dictionary dereference is individually eval'd since the dict key might have been 
    garbage-collected 
    TODO: store string components that are duplicates of strings in the actual system so that 
    Python will keep one copy and reduce memory usage 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">evalStr</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">dictKey</span><span class="s2">=</span><span class="s1">NoDictKey</span><span class="s2">):</span>
        <span class="s5"># if this is a dictionary lookup, pass dictKey instead of evalStr</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">evalStr </span><span class="s2">= </span><span class="s1">evalStr</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dictKey </span><span class="s2">= </span><span class="s1">NoDictKey</span>
        <span class="s5"># is the dictKey a weak reference?</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_isWeakRef </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_refCount </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s0">if </span><span class="s1">dictKey </span><span class="s0">is not </span><span class="s1">NoDictKey</span><span class="s2">:</span>
            <span class="s5"># if we can repr/eval the key, store it as an evalStr</span>
            <span class="s1">keyRepr </span><span class="s2">= </span><span class="s1">safeRepr</span><span class="s2">(</span><span class="s1">dictKey</span><span class="s2">)</span>
            <span class="s1">useEval </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">keyEval </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">keyRepr</span><span class="s2">)</span>
                <span class="s1">useEval </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s0">except</span><span class="s2">:</span>
                <span class="s0">pass</span>
            <span class="s0">if </span><span class="s1">useEval</span><span class="s2">:</span>
                <span class="s5"># check to make sure the eval succeeded</span>
                <span class="s0">if </span><span class="s1">hash</span><span class="s2">(</span><span class="s1">keyEval</span><span class="s2">) != </span><span class="s1">hash</span><span class="s2">(</span><span class="s1">dictKey</span><span class="s2">):</span>
                    <span class="s1">useEval </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s0">if </span><span class="s1">useEval</span><span class="s2">:</span>
                <span class="s5"># eval/repr succeeded, store as an evalStr</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">evalStr </span><span class="s2">= </span><span class="s4">'[%s]' </span><span class="s2">% </span><span class="s1">keyRepr</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s5"># store a weakref to the key</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">dictKey </span><span class="s2">= </span><span class="s1">weakref</span><span class="s2">.</span><span class="s1">ref</span><span class="s2">(</span><span class="s1">dictKey</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_isWeakRef </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s0">except </span><span class="s1">TypeError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                    <span class="s1">ContainerLeakDetector</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s4">'could not weakref dict key %s' </span><span class="s2">% </span><span class="s1">keyRepr</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">dictKey </span><span class="s2">= </span><span class="s1">dictKey</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_isWeakRef </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># re-entrant</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dictKey </span><span class="s2">= </span><span class="s1">NoDictKey</span>

    <span class="s0">def </span><span class="s1">acquire</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_refCount </span><span class="s2">+= </span><span class="s3">1</span>
    <span class="s0">def </span><span class="s1">release</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_refCount </span><span class="s2">-= </span><span class="s3">1</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_refCount </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">isDictKey</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># is this an indirection through a dictionary?</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dictKey </span><span class="s0">is not </span><span class="s1">NoDictKey</span>

    <span class="s0">def </span><span class="s1">_getNonWeakDictKey</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_isWeakRef</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dictKey</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">key </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dictKey</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">key </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s4">'&lt;garbage-collected dict key&gt;'</span>
            <span class="s0">return </span><span class="s1">key</span>

    <span class="s0">def </span><span class="s1">dereferenceDictKey</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parentDict</span><span class="s2">):</span>
        <span class="s5"># look ourselves up in parentDict</span>
        <span class="s1">key </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_getNonWeakDictKey</span><span class="s2">()</span>
        <span class="s5"># objects in __builtin__ will have parentDict==None</span>
        <span class="s0">if </span><span class="s1">parentDict </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">key</span>
        <span class="s0">return </span><span class="s1">parentDict</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">getString</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">prevIndirection</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">nextIndirection</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s5"># return our contribution to the full name of an object</span>
        <span class="s1">instanceDictStr </span><span class="s2">= </span><span class="s4">'.__dict__'</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">evalStr </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s5"># if we're an instance dict, skip over this one (obj.__dict__[keyName] == obj.keyName)</span>
            <span class="s0">if </span><span class="s1">nextIndirection </span><span class="s0">is not None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">evalStr</span><span class="s2">[-</span><span class="s1">len</span><span class="s2">(</span><span class="s1">instanceDictStr</span><span class="s2">):] == </span><span class="s1">instanceDictStr</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">evalStr</span><span class="s2">[:-</span><span class="s1">len</span><span class="s2">(</span><span class="s1">instanceDictStr</span><span class="s2">)]</span>
            <span class="s5"># if the previous indirection was an instance dict, change our syntax from ['key'] to .key</span>
            <span class="s0">if </span><span class="s1">prevIndirection </span><span class="s0">is not None and </span><span class="s1">prevIndirection</span><span class="s2">.</span><span class="s1">evalStr </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">prevIndirection</span><span class="s2">.</span><span class="s1">evalStr</span><span class="s2">[-</span><span class="s1">len</span><span class="s2">(</span><span class="s1">instanceDictStr</span><span class="s2">):] == </span><span class="s1">instanceDictStr</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s4">'.%s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">evalStr</span><span class="s2">[</span><span class="s3">2</span><span class="s2">:-</span><span class="s3">2</span><span class="s2">]</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">evalStr</span>

        <span class="s5"># we're stored as a dict key</span>
        <span class="s1">keyRepr </span><span class="s2">= </span><span class="s1">safeRepr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_getNonWeakDictKey</span><span class="s2">())</span>
        <span class="s5"># if the previous indirection was an instance dict, change our syntax from ['key'] to .key</span>
        <span class="s0">if </span><span class="s1">prevIndirection </span><span class="s0">is not None and </span><span class="s1">prevIndirection</span><span class="s2">.</span><span class="s1">evalStr </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">prevIndirection</span><span class="s2">.</span><span class="s1">evalStr</span><span class="s2">[-</span><span class="s1">len</span><span class="s2">(</span><span class="s1">instanceDictStr</span><span class="s2">):] == </span><span class="s1">instanceDictStr</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s4">'.%s' </span><span class="s2">% </span><span class="s1">keyRepr</span>
        <span class="s0">return </span><span class="s4">'[%s]' </span><span class="s2">% </span><span class="s1">keyRepr</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">()</span>

<span class="s0">class </span><span class="s1">ObjectRef</span><span class="s2">:</span>
    <span class="s6">&quot;&quot;&quot; 
    stores a reference to a container in a way that does not prevent garbage 
    collection of the container if possible 
    stored as a series of 'indirections' (obj.foo -&gt; '.foo', dict[key] -&gt; '[key]', etc.) 
    &quot;&quot;&quot;</span>
    <span class="s1">notify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s4">&quot;ObjectRef&quot;</span><span class="s2">)</span>

    <span class="s0">class </span><span class="s1">FailedEval</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">indirection</span><span class="s2">, </span><span class="s1">objId</span><span class="s2">, </span><span class="s1">other</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_indirections </span><span class="s2">= []</span>
        <span class="s5"># are we building off of an existing ref?</span>
        <span class="s0">if </span><span class="s1">other </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">ind </span><span class="s0">in </span><span class="s1">other</span><span class="s2">.</span><span class="s1">_indirections</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_indirections</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ind</span><span class="s2">)</span>

        <span class="s5"># make sure we're not storing a reference to the actual object,</span>
        <span class="s5"># that could cause a memory leak</span>
        <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">objId</span><span class="s2">) </span><span class="s0">in </span><span class="s1">intTypes</span>
        <span class="s5"># prevent cycles (i.e. base.loader.base.loader)</span>
        <span class="s0">assert not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">goesThrough</span><span class="s2">(</span><span class="s1">objId</span><span class="s2">=</span><span class="s1">objId</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_indirections</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">indirection</span><span class="s2">)</span>

        <span class="s5"># make sure our indirections don't get destroyed while we're using them</span>
        <span class="s0">for </span><span class="s1">ind </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_indirections</span><span class="s2">:</span>
            <span class="s1">ind</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">indirection </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_indirections</span><span class="s2">:</span>
            <span class="s1">indirection</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_indirections</span>

    <span class="s0">def </span><span class="s1">getNumIndirections</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_indirections</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">goesThroughGen</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">objId</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">obj </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">objId</span><span class="s2">) </span><span class="s0">in </span><span class="s1">intTypes</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">objId </span><span class="s2">= </span><span class="s1">id</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s1">o </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">evalStr </span><span class="s2">= </span><span class="s4">''</span>
        <span class="s1">curObj </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s5"># make sure the indirections don't go away on us</span>
        <span class="s1">indirections </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_indirections</span>
        <span class="s0">for </span><span class="s1">indirection </span><span class="s0">in </span><span class="s1">indirections</span><span class="s2">:</span>
            <span class="s0">yield None</span>
            <span class="s1">indirection</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">indirection </span><span class="s0">in </span><span class="s1">indirections</span><span class="s2">:</span>
            <span class="s0">yield None</span>
            <span class="s0">if not </span><span class="s1">indirection</span><span class="s2">.</span><span class="s1">isDictKey</span><span class="s2">():</span>
                <span class="s5"># build up a string to be eval'd</span>
                <span class="s1">evalStr </span><span class="s2">+= </span><span class="s1">indirection</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">curObj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_getContainerByEval</span><span class="s2">(</span><span class="s1">evalStr</span><span class="s2">, </span><span class="s1">curObj</span><span class="s2">=</span><span class="s1">curObj</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">curObj </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">FailedEval</span><span class="s2">(</span><span class="s1">evalStr</span><span class="s2">)</span>
                <span class="s5"># try to look up this key in the curObj dictionary</span>
                <span class="s1">curObj </span><span class="s2">= </span><span class="s1">indirection</span><span class="s2">.</span><span class="s1">dereferenceDictKey</span><span class="s2">(</span><span class="s1">curObj</span><span class="s2">)</span>
                <span class="s1">evalStr </span><span class="s2">= </span><span class="s4">''</span>
            <span class="s0">yield None</span>
            <span class="s1">o </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_getContainerByEval</span><span class="s2">(</span><span class="s1">evalStr</span><span class="s2">, </span><span class="s1">curObj</span><span class="s2">=</span><span class="s1">curObj</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">id</span><span class="s2">(</span><span class="s1">o</span><span class="s2">) == </span><span class="s1">objId</span><span class="s2">:</span>
                <span class="s0">break</span>
        <span class="s0">for </span><span class="s1">indirection </span><span class="s0">in </span><span class="s1">indirections</span><span class="s2">:</span>
            <span class="s0">yield None</span>
            <span class="s1">indirection</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

        <span class="s0">yield </span><span class="s1">id</span><span class="s2">(</span><span class="s1">o</span><span class="s2">) == </span><span class="s1">objId</span>

    <span class="s0">def </span><span class="s1">goesThrough</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">objId</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s5"># since we cache the ids involved in this reference,</span>
        <span class="s5"># this isn't perfect, for example if base.myObject is reassigned</span>
        <span class="s5"># to a different object after this Ref was created this would return</span>
        <span class="s5"># false, allowing a ref to base.myObject.otherObject.myObject</span>
        <span class="s0">for </span><span class="s1">goesThrough </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">goesThroughGen</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">=</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">objId</span><span class="s2">=</span><span class="s1">objId</span><span class="s2">):</span>
            <span class="s0">pass</span>
        <span class="s0">return </span><span class="s1">goesThrough</span>

    <span class="s0">def </span><span class="s1">_getContainerByEval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">evalStr</span><span class="s2">, </span><span class="s1">curObj</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">curObj </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s5"># eval('curObj.foo.bar.someDict')</span>
            <span class="s1">evalStr </span><span class="s2">= </span><span class="s4">'curObj%s' </span><span class="s2">% </span><span class="s1">evalStr</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s5"># this eval is not based off of curObj, use the global__builtin__ namespace</span>
            <span class="s5"># put __builtin__ at the start if it's not already there</span>
            <span class="s1">bis </span><span class="s2">= </span><span class="s4">'__builtin__'</span>
            <span class="s0">if </span><span class="s1">evalStr</span><span class="s2">[:</span><span class="s1">len</span><span class="s2">(</span><span class="s1">bis</span><span class="s2">)] != </span><span class="s1">bis</span><span class="s2">:</span>
                <span class="s1">evalStr </span><span class="s2">= </span><span class="s4">'%s.%s' </span><span class="s2">% (</span><span class="s1">bis</span><span class="s2">, </span><span class="s1">evalStr</span><span class="s2">)</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">container </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">evalStr</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">NameError </span><span class="s0">as </span><span class="s1">ne</span><span class="s2">:</span>
            <span class="s0">return None</span>
        <span class="s0">except </span><span class="s1">AttributeError </span><span class="s0">as </span><span class="s1">ae</span><span class="s2">:</span>
            <span class="s0">return None</span>
        <span class="s0">except </span><span class="s1">KeyError </span><span class="s0">as </span><span class="s1">ke</span><span class="s2">:</span>
            <span class="s0">return None</span>
        <span class="s0">return </span><span class="s1">container</span>

    <span class="s0">def </span><span class="s1">getContainerGen</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">getInstance</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s5"># try to get a handle on the container by eval'ing and looking things</span>
        <span class="s5"># up in dictionaries, depending on the type of each indirection</span>
        <span class="s5"># if getInstance is True, will return instance instead of instance dict</span>
        <span class="s5">#import pdb;pdb.set_trace()</span>
        <span class="s1">evalStr </span><span class="s2">= </span><span class="s4">''</span>
        <span class="s1">curObj </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s5"># make sure the indirections don't go away on us</span>
        <span class="s1">indirections </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_indirections</span>
        <span class="s0">for </span><span class="s1">indirection </span><span class="s0">in </span><span class="s1">indirections</span><span class="s2">:</span>
            <span class="s1">indirection</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">indirection </span><span class="s0">in </span><span class="s1">indirections</span><span class="s2">:</span>
            <span class="s0">yield None</span>
            <span class="s0">if not </span><span class="s1">indirection</span><span class="s2">.</span><span class="s1">isDictKey</span><span class="s2">():</span>
                <span class="s5"># build up a string to be eval'd</span>
                <span class="s1">evalStr </span><span class="s2">+= </span><span class="s1">indirection</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">curObj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_getContainerByEval</span><span class="s2">(</span><span class="s1">evalStr</span><span class="s2">, </span><span class="s1">curObj</span><span class="s2">=</span><span class="s1">curObj</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">curObj </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">FailedEval</span><span class="s2">(</span><span class="s1">evalStr</span><span class="s2">)</span>
                <span class="s5"># try to look up this key in the curObj dictionary</span>
                <span class="s1">curObj </span><span class="s2">= </span><span class="s1">indirection</span><span class="s2">.</span><span class="s1">dereferenceDictKey</span><span class="s2">(</span><span class="s1">curObj</span><span class="s2">)</span>
                <span class="s1">evalStr </span><span class="s2">= </span><span class="s4">''</span>
        <span class="s0">for </span><span class="s1">indirection </span><span class="s0">in </span><span class="s1">indirections</span><span class="s2">:</span>
            <span class="s0">yield None</span>
            <span class="s1">indirection</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">getInstance</span><span class="s2">:</span>
            <span class="s1">lenDict </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s4">'.__dict__'</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">evalStr</span><span class="s2">[-</span><span class="s1">lenDict</span><span class="s2">:] == </span><span class="s4">'.__dict__'</span><span class="s2">:</span>
                <span class="s1">evalStr </span><span class="s2">= </span><span class="s1">evalStr</span><span class="s2">[:-</span><span class="s1">lenDict</span><span class="s2">]</span>

        <span class="s5"># TODO: check that this is still the object we originally pointed to</span>
        <span class="s0">yield </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_getContainerByEval</span><span class="s2">(</span><span class="s1">evalStr</span><span class="s2">, </span><span class="s1">curObj</span><span class="s2">=</span><span class="s1">curObj</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getEvalStrGen</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">getInstance</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">str </span><span class="s2">= </span><span class="s4">''</span>
        <span class="s1">prevIndirection </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">curIndirection </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">nextIndirection </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s5"># make sure the indirections don't go away on us</span>
        <span class="s1">indirections </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_indirections</span>
        <span class="s0">for </span><span class="s1">indirection </span><span class="s0">in </span><span class="s1">indirections</span><span class="s2">:</span>
            <span class="s1">indirection</span><span class="s2">.</span><span class="s1">acquire</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">indirections</span><span class="s2">)):</span>
            <span class="s0">yield None</span>
            <span class="s0">if </span><span class="s1">i </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">prevIndirection </span><span class="s2">= </span><span class="s1">indirections</span><span class="s2">[</span><span class="s1">i</span><span class="s2">-</span><span class="s3">1</span><span class="s2">]</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">prevIndirection </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">curIndirection </span><span class="s2">= </span><span class="s1">indirections</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">indirections</span><span class="s2">)-</span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">nextIndirection </span><span class="s2">= </span><span class="s1">indirections</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s3">1</span><span class="s2">]</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">nextIndirection </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">str </span><span class="s2">+= </span><span class="s1">curIndirection</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">prevIndirection</span><span class="s2">=</span><span class="s1">prevIndirection</span><span class="s2">,</span>
                                            <span class="s1">nextIndirection</span><span class="s2">=</span><span class="s1">nextIndirection</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">getInstance</span><span class="s2">:</span>
            <span class="s1">lenDict </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s4">'.__dict__'</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">str</span><span class="s2">[-</span><span class="s1">lenDict</span><span class="s2">:] == </span><span class="s4">'.__dict__'</span><span class="s2">:</span>
                <span class="s1">str </span><span class="s2">= </span><span class="s1">str</span><span class="s2">[:-</span><span class="s1">lenDict</span><span class="s2">]</span>

        <span class="s0">for </span><span class="s1">indirection </span><span class="s0">in </span><span class="s1">indirections</span><span class="s2">:</span>
            <span class="s0">yield None</span>
            <span class="s1">indirection</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>
        <span class="s0">yield </span><span class="s1">str</span>

    <span class="s0">def </span><span class="s1">getFinalIndirectionStr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">prevIndirection </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_indirections</span><span class="s2">) &gt; </span><span class="s3">1</span><span class="s2">:</span>
            <span class="s1">prevIndirection </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_indirections</span><span class="s2">[-</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_indirections</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">].</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">prevIndirection</span><span class="s2">=</span><span class="s1">prevIndirection</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">result </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getEvalStrGen</span><span class="s2">():</span>
            <span class="s0">pass</span>
        <span class="s0">return </span><span class="s1">result</span>

<span class="s0">class </span><span class="s1">FindContainers</span><span class="s2">(</span><span class="s1">Job</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Explore the Python graph, looking for objects that support __len__() 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">leakDetector</span><span class="s2">):</span>
        <span class="s1">Job</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector </span><span class="s2">= </span><span class="s1">leakDetector</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">_id2ref</span>
        <span class="s5"># these hold objects that we should start traversals from often and not-as-often,</span>
        <span class="s5"># respectively</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2baseStartRef </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2discoveredStartRef </span><span class="s2">= {}</span>
        <span class="s5"># these are working copies so that our iterations aren't disturbed by changes to the</span>
        <span class="s5"># definitive ref sets</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_baseStartRefWorkingList </span><span class="s2">= </span><span class="s1">ScratchPad</span><span class="s2">(</span><span class="s1">refGen</span><span class="s2">=</span><span class="s1">nullGen</span><span class="s2">(),</span>
                                                   <span class="s1">source</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2baseStartRef</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_discoveredStartRefWorkingList </span><span class="s2">= </span><span class="s1">ScratchPad</span><span class="s2">(</span><span class="s1">refGen</span><span class="s2">=</span><span class="s1">nullGen</span><span class="s2">(),</span>
                                                         <span class="s1">source</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2discoveredStartRef</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">notify</span>
        <span class="s1">ContainerLeakDetector</span><span class="s2">.</span><span class="s1">addPrivateObj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)</span>

        <span class="s5"># set up the base containers, the ones that hold most objects</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">ObjectRef</span><span class="s2">(</span><span class="s1">Indirection</span><span class="s2">(</span><span class="s1">evalStr</span><span class="s2">=</span><span class="s4">'__builtin__.__dict__'</span><span class="s2">), </span><span class="s1">id</span><span class="s2">(</span><span class="s1">__builtin__</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2baseStartRef</span><span class="s2">[</span><span class="s1">id</span><span class="s2">(</span><span class="s1">__builtin__</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)] = </span><span class="s1">ref</span>
        <span class="s5"># container for objects that want to make sure they are found by</span>
        <span class="s5"># the object exploration algorithm, including objects that exist</span>
        <span class="s5"># just to measure things such as C++ memory usage, scene graph size,</span>
        <span class="s5"># framerate, etc. See LeakDetectors.py</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">__builtin__</span><span class="s2">, </span><span class="s4">&quot;leakDetectors&quot;</span><span class="s2">):</span>
            <span class="s1">__builtin__</span><span class="s2">.</span><span class="s1">leakDetectors </span><span class="s2">= {}</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">ObjectRef</span><span class="s2">(</span><span class="s1">Indirection</span><span class="s2">(</span><span class="s1">evalStr</span><span class="s2">=</span><span class="s4">'leakDetectors'</span><span class="s2">), </span><span class="s1">id</span><span class="s2">(</span><span class="s1">leakDetectors</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2baseStartRef</span><span class="s2">[</span><span class="s1">id</span><span class="s2">(</span><span class="s1">leakDetectors</span><span class="s2">)] = </span><span class="s1">ref</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_addContainerGen</span><span class="s2">(</span><span class="s1">__builtin__</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">):</span>
            <span class="s0">pass</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">base</span>
        <span class="s0">except</span><span class="s2">:</span>
            <span class="s0">pass</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">ref </span><span class="s2">= </span><span class="s1">ObjectRef</span><span class="s2">(</span><span class="s1">Indirection</span><span class="s2">(</span><span class="s1">evalStr</span><span class="s2">=</span><span class="s4">'base.__dict__'</span><span class="s2">), </span><span class="s1">id</span><span class="s2">(</span><span class="s1">base</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2baseStartRef</span><span class="s2">[</span><span class="s1">id</span><span class="s2">(</span><span class="s1">base</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)] = </span><span class="s1">ref</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_addContainerGen</span><span class="s2">(</span><span class="s1">base</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">):</span>
                <span class="s0">pass</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">simbase</span>
        <span class="s0">except</span><span class="s2">:</span>
            <span class="s0">pass</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">ref </span><span class="s2">= </span><span class="s1">ObjectRef</span><span class="s2">(</span><span class="s1">Indirection</span><span class="s2">(</span><span class="s1">evalStr</span><span class="s2">=</span><span class="s4">'simbase.__dict__'</span><span class="s2">), </span><span class="s1">id</span><span class="s2">(</span><span class="s1">simbase</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2baseStartRef</span><span class="s2">[</span><span class="s1">id</span><span class="s2">(</span><span class="s1">simbase</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)] = </span><span class="s1">ref</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_addContainerGen</span><span class="s2">(</span><span class="s1">simbase</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">):</span>
                <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ContainerLeakDetector</span><span class="s2">.</span><span class="s1">removePrivateObj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)</span>
        <span class="s1">Job</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getPriority</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Job</span><span class="s2">.</span><span class="s1">Priorities</span><span class="s2">.</span><span class="s1">Low</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">getStartObjAffinity</span><span class="s2">(</span><span class="s1">startObj</span><span class="s2">):</span>
        <span class="s5"># how good of a starting object is this object for traversing the object graph?</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">startObj</span><span class="s2">)</span>
        <span class="s0">except</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s3">1</span>

    <span class="s0">def </span><span class="s1">_isDeadEnd</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">objName</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">type</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">) </span><span class="s0">in </span><span class="s1">deadEndTypes</span><span class="s2">:</span>
            <span class="s0">return True</span>

        <span class="s5"># if it's an internal object, ignore it</span>
        <span class="s0">if </span><span class="s1">id</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">) </span><span class="s0">in </span><span class="s1">ContainerLeakDetector</span><span class="s2">.</span><span class="s1">PrivateIds</span><span class="s2">:</span>
            <span class="s0">return True</span>
        <span class="s5"># prevent crashes in objects that define __cmp__ and don't handle strings</span>
        <span class="s0">if </span><span class="s1">type</span><span class="s2">(</span><span class="s1">objName</span><span class="s2">) == </span><span class="s1">str </span><span class="s0">and </span><span class="s1">objName </span><span class="s0">in </span><span class="s2">(</span><span class="s4">'im_self'</span><span class="s2">, </span><span class="s4">'im_class'</span><span class="s2">):</span>
            <span class="s0">return True</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">className </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span>
        <span class="s0">except</span><span class="s2">:</span>
            <span class="s0">pass</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s5"># prevent infinite recursion in built-in containers related to methods</span>
            <span class="s0">if </span><span class="s1">className </span><span class="s2">== </span><span class="s4">'method-wrapper'</span><span class="s2">:</span>
                <span class="s0">return True</span>
        <span class="s0">return False</span>

    <span class="s0">def </span><span class="s1">_hasLength</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s4">'__len__'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_addContainerGen</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cont</span><span class="s2">, </span><span class="s1">objRef</span><span class="s2">):</span>
        <span class="s1">contId </span><span class="s2">= </span><span class="s1">id</span><span class="s2">(</span><span class="s1">cont</span><span class="s2">)</span>
        <span class="s5"># if this container is new, or the objRef repr is shorter than what we already have,</span>
        <span class="s5"># put it in the table</span>
        <span class="s0">if </span><span class="s1">contId </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">existingRepr </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">[</span><span class="s1">contId</span><span class="s2">].</span><span class="s1">getEvalStrGen</span><span class="s2">():</span>
                <span class="s0">yield None</span>
            <span class="s0">for </span><span class="s1">newRepr </span><span class="s0">in </span><span class="s1">objRef</span><span class="s2">.</span><span class="s1">getEvalStrGen</span><span class="s2">():</span>
                <span class="s0">yield None</span>
        <span class="s0">if </span><span class="s1">contId </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref </span><span class="s0">or </span><span class="s1">len</span><span class="s2">(</span><span class="s1">newRepr</span><span class="s2">) &lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">existingRepr</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">contId </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">removeContainerById</span><span class="s2">(</span><span class="s1">contId</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">[</span><span class="s1">contId</span><span class="s2">] = </span><span class="s1">objRef</span>

    <span class="s0">def </span><span class="s1">_addDiscoveredStartRef</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">):</span>
        <span class="s5"># we've discovered an object that can be used to start an object graph traversal</span>
        <span class="s1">objId </span><span class="s2">= </span><span class="s1">id</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">objId </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2discoveredStartRef</span><span class="s2">:</span>
            <span class="s1">existingRef </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2discoveredStartRef</span><span class="s2">[</span><span class="s1">objId</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">type</span><span class="s2">(</span><span class="s1">existingRef</span><span class="s2">) </span><span class="s0">not in </span><span class="s1">intTypes</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s2">(</span><span class="s1">existingRef</span><span class="s2">.</span><span class="s1">getNumIndirections</span><span class="s2">() &gt;=</span>
                    <span class="s1">ref</span><span class="s2">.</span><span class="s1">getNumIndirections</span><span class="s2">()):</span>
                    <span class="s5"># the ref that we already have is more concise than the new ref</span>
                    <span class="s0">return</span>
        <span class="s0">if </span><span class="s1">objId </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">[</span><span class="s1">objId</span><span class="s2">].</span><span class="s1">getNumIndirections</span><span class="s2">() &gt;=</span>
                <span class="s1">ref</span><span class="s2">.</span><span class="s1">getNumIndirections</span><span class="s2">()):</span>
                <span class="s5"># the ref that we already have is more concise than the new ref</span>
                <span class="s0">return</span>
        <span class="s1">storedItem </span><span class="s2">= </span><span class="s1">ref</span>
        <span class="s5"># if we already are storing a reference to this object, don't store a second reference</span>
        <span class="s0">if </span><span class="s1">objId </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">:</span>
            <span class="s1">storedItem </span><span class="s2">= </span><span class="s1">objId</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2discoveredStartRef</span><span class="s2">[</span><span class="s1">objId</span><span class="s2">] = </span><span class="s1">storedItem</span>

    <span class="s0">def </span><span class="s1">run</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s5"># this yields a different set of start refs every time we start a new traversal</span>
            <span class="s5"># force creation of a new workingListSelector inside the while loop right off the bat</span>
            <span class="s1">workingListSelector </span><span class="s2">= </span><span class="s1">nullGen</span><span class="s2">()</span>
            <span class="s5"># this holds the current step of the current traversal</span>
            <span class="s1">curObjRef </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s0">while True</span><span class="s2">:</span>
                <span class="s5"># yield up here instead of at the end, since we skip back to the</span>
                <span class="s5"># top of the while loop from various points</span>
                <span class="s0">yield None</span>
                <span class="s5">#import pdb;pdb.set_trace()</span>
                <span class="s0">if </span><span class="s1">curObjRef </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s5"># choose an object to start a traversal from</span>
                    <span class="s0">try</span><span class="s2">:</span>
                        <span class="s1">startRefWorkingList </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">workingListSelector</span><span class="s2">)</span>
                    <span class="s0">except </span><span class="s1">StopIteration</span><span class="s2">:</span>
                        <span class="s5"># do relative # of traversals on each set based on how many refs it contains</span>
                        <span class="s1">baseLen </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_baseStartRefWorkingList</span><span class="s2">.</span><span class="s1">source</span><span class="s2">)</span>
                        <span class="s1">discLen </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_discoveredStartRefWorkingList</span><span class="s2">.</span><span class="s1">source</span><span class="s2">)</span>
                        <span class="s1">minLen </span><span class="s2">= </span><span class="s1">float</span><span class="s2">(</span><span class="s1">max</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">min</span><span class="s2">(</span><span class="s1">baseLen</span><span class="s2">, </span><span class="s1">discLen</span><span class="s2">)))</span>
                        <span class="s5"># this will cut down the traversals of the larger set by 2/3</span>
                        <span class="s1">minLen </span><span class="s2">*= </span><span class="s3">3.</span>
                        <span class="s1">workingListSelector </span><span class="s2">= </span><span class="s1">flywheel</span><span class="s2">([</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_baseStartRefWorkingList</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_discoveredStartRefWorkingList</span><span class="s2">],</span>
                                                       <span class="s2">[</span><span class="s1">baseLen</span><span class="s2">/</span><span class="s1">minLen</span><span class="s2">, </span><span class="s1">discLen</span><span class="s2">/</span><span class="s1">minLen</span><span class="s2">])</span>
                        <span class="s0">yield None</span>
                        <span class="s0">continue</span>

                    <span class="s5"># grab the next start ref from this sequence and see if it's still valid</span>
                    <span class="s0">while True</span><span class="s2">:</span>
                        <span class="s0">yield None</span>
                        <span class="s0">try</span><span class="s2">:</span>
                            <span class="s1">curObjRef </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">startRefWorkingList</span><span class="s2">.</span><span class="s1">refGen</span><span class="s2">)</span>
                            <span class="s0">break</span>
                        <span class="s0">except </span><span class="s1">StopIteration</span><span class="s2">:</span>
                            <span class="s5"># we've run out of refs, grab a new set</span>
                            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">startRefWorkingList</span><span class="s2">.</span><span class="s1">source</span><span class="s2">) == </span><span class="s3">0</span><span class="s2">:</span>
                                <span class="s5"># ref set is empty, choose another</span>
                                <span class="s0">break</span>
                            <span class="s5"># make a generator that yields containers a # of times that is</span>
                            <span class="s5"># proportional to their length</span>
                            <span class="s0">for </span><span class="s1">fw </span><span class="s0">in </span><span class="s1">makeFlywheelGen</span><span class="s2">(</span>
                                <span class="s1">list</span><span class="s2">(</span><span class="s1">startRefWorkingList</span><span class="s2">.</span><span class="s1">source</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()),</span>
                                <span class="s1">countFunc</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getStartObjAffinity</span><span class="s2">(</span><span class="s1">x</span><span class="s2">),</span>
                                <span class="s1">scale</span><span class="s2">=</span><span class="s3">.05</span><span class="s2">):</span>
                                <span class="s0">yield None</span>
                            <span class="s1">startRefWorkingList</span><span class="s2">.</span><span class="s1">refGen </span><span class="s2">= </span><span class="s1">fw</span>
                    <span class="s0">if </span><span class="s1">curObjRef </span><span class="s0">is None</span><span class="s2">:</span>
                        <span class="s5"># this ref set is empty, choose another</span>
                        <span class="s5"># the base set should never be empty (__builtin__ etc.)</span>
                        <span class="s0">continue</span>
                    <span class="s5"># do we need to go look up the object in _id2ref? sometimes we do that</span>
                    <span class="s5"># to avoid storing multiple redundant refs to a single item</span>
                    <span class="s0">if </span><span class="s1">type</span><span class="s2">(</span><span class="s1">curObjRef</span><span class="s2">) </span><span class="s0">in </span><span class="s1">intTypes</span><span class="s2">:</span>
                        <span class="s1">startId </span><span class="s2">= </span><span class="s1">curObjRef</span>
                        <span class="s1">curObjRef </span><span class="s2">= </span><span class="s0">None</span>
                        <span class="s0">try</span><span class="s2">:</span>
                            <span class="s0">for </span><span class="s1">containerRef </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerByIdGen</span><span class="s2">(</span><span class="s1">startId</span><span class="s2">):</span>
                                <span class="s0">yield None</span>
                        <span class="s0">except</span><span class="s2">:</span>
                            <span class="s5"># ref is invalid</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s4">'invalid startRef, stored as id %s' </span><span class="s2">% </span><span class="s1">startId</span><span class="s2">)</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">removeContainerById</span><span class="s2">(</span><span class="s1">startId</span><span class="s2">)</span>
                            <span class="s0">continue</span>
                        <span class="s1">curObjRef </span><span class="s2">= </span><span class="s1">containerRef</span>

                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s0">for </span><span class="s1">curObj </span><span class="s0">in </span><span class="s1">curObjRef</span><span class="s2">.</span><span class="s1">getContainerGen</span><span class="s2">():</span>
                        <span class="s0">yield None</span>
                <span class="s0">except</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s4">'lost current container, ref.getContainerGen() failed'</span><span class="s2">)</span>
                    <span class="s5"># that container is gone, try again</span>
                    <span class="s1">curObjRef </span><span class="s2">= </span><span class="s0">None</span>
                    <span class="s0">continue</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s4">'--&gt; %s' </span><span class="s2">% </span><span class="s1">curObjRef</span><span class="s2">)</span>
                <span class="s5">#import pdb;pdb.set_trace()</span>

                <span class="s5"># store a copy of the current objRef</span>
                <span class="s1">parentObjRef </span><span class="s2">= </span><span class="s1">curObjRef</span>
                <span class="s5"># if we hit a dead end, start over from another container</span>
                <span class="s1">curObjRef </span><span class="s2">= </span><span class="s0">None</span>

                <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">curObj</span><span class="s2">, </span><span class="s4">'__dict__'</span><span class="s2">):</span>
                    <span class="s1">child </span><span class="s2">= </span><span class="s1">curObj</span><span class="s2">.</span><span class="s1">__dict__</span>
                    <span class="s1">hasLength </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_hasLength</span><span class="s2">(</span><span class="s1">child</span><span class="s2">)</span>
                    <span class="s1">notDeadEnd </span><span class="s2">= </span><span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_isDeadEnd</span><span class="s2">(</span><span class="s1">child</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">hasLength </span><span class="s0">or </span><span class="s1">notDeadEnd</span><span class="s2">:</span>
                        <span class="s5"># prevent cycles in the references (i.e. base.loader.base)</span>
                        <span class="s0">for </span><span class="s1">goesThrough </span><span class="s0">in </span><span class="s1">parentObjRef</span><span class="s2">.</span><span class="s1">goesThroughGen</span><span class="s2">(</span><span class="s1">child</span><span class="s2">):</span>
                            <span class="s5"># don't yield, container might lose this element</span>
                            <span class="s0">pass</span>
                        <span class="s0">if not </span><span class="s1">goesThrough</span><span class="s2">:</span>
                            <span class="s1">objRef </span><span class="s2">= </span><span class="s1">ObjectRef</span><span class="s2">(</span><span class="s1">Indirection</span><span class="s2">(</span><span class="s1">evalStr</span><span class="s2">=</span><span class="s4">'.__dict__'</span><span class="s2">),</span>
                                               <span class="s1">id</span><span class="s2">(</span><span class="s1">child</span><span class="s2">), </span><span class="s1">parentObjRef</span><span class="s2">)</span>
                            <span class="s0">yield None</span>
                            <span class="s0">if </span><span class="s1">hasLength</span><span class="s2">:</span>
                                <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_addContainerGen</span><span class="s2">(</span><span class="s1">child</span><span class="s2">, </span><span class="s1">objRef</span><span class="s2">):</span>
                                    <span class="s0">yield None</span>
                            <span class="s0">if </span><span class="s1">notDeadEnd</span><span class="s2">:</span>
                                <span class="s1">self</span><span class="s2">.</span><span class="s1">_addDiscoveredStartRef</span><span class="s2">(</span><span class="s1">child</span><span class="s2">, </span><span class="s1">objRef</span><span class="s2">)</span>
                                <span class="s1">curObjRef </span><span class="s2">= </span><span class="s1">objRef</span>
                    <span class="s0">continue</span>

                <span class="s0">if </span><span class="s1">type</span><span class="s2">(</span><span class="s1">curObj</span><span class="s2">) </span><span class="s0">is </span><span class="s1">dict</span><span class="s2">:</span>
                    <span class="s1">key </span><span class="s2">= </span><span class="s0">None</span>
                    <span class="s1">attr </span><span class="s2">= </span><span class="s0">None</span>
                    <span class="s1">keys </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">curObj</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
                    <span class="s5"># we will continue traversing the object graph via one key of the dict,</span>
                    <span class="s5"># choose it at random without taking a big chunk of CPU time</span>
                    <span class="s1">numKeysLeft </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">) + </span><span class="s3">1</span>
                    <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">keys</span><span class="s2">:</span>
                        <span class="s0">yield None</span>
                        <span class="s1">numKeysLeft </span><span class="s2">-= </span><span class="s3">1</span>
                        <span class="s0">try</span><span class="s2">:</span>
                            <span class="s1">attr </span><span class="s2">= </span><span class="s1">curObj</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>
                        <span class="s0">except </span><span class="s1">KeyError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                            <span class="s5"># this is OK because we are yielding during the iteration</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s4">'could not index into %s with key %s' </span><span class="s2">% (</span>
                                <span class="s1">parentObjRef</span><span class="s2">, </span><span class="s1">safeRepr</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)))</span>
                            <span class="s0">continue</span>
                        <span class="s1">hasLength </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_hasLength</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">)</span>
                        <span class="s1">notDeadEnd </span><span class="s2">= </span><span class="s0">False</span>
                        <span class="s5"># if we haven't picked the next ref, check if this one is a candidate</span>
                        <span class="s0">if </span><span class="s1">curObjRef </span><span class="s0">is None</span><span class="s2">:</span>
                            <span class="s1">notDeadEnd </span><span class="s2">= </span><span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_isDeadEnd</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">, </span><span class="s1">key</span><span class="s2">)</span>
                        <span class="s0">if </span><span class="s1">hasLength </span><span class="s0">or </span><span class="s1">notDeadEnd</span><span class="s2">:</span>
                            <span class="s5"># prevent cycles in the references (i.e. base.loader.base)</span>
                            <span class="s0">for </span><span class="s1">goesThrough </span><span class="s0">in </span><span class="s1">parentObjRef</span><span class="s2">.</span><span class="s1">goesThroughGen</span><span class="s2">(</span><span class="s1">curObj</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]):</span>
                                <span class="s5"># don't yield, container might lose this element</span>
                                <span class="s0">pass</span>
                            <span class="s0">if not </span><span class="s1">goesThrough</span><span class="s2">:</span>
                                <span class="s0">if </span><span class="s1">curObj </span><span class="s0">is </span><span class="s1">__builtin__</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">:</span>
                                    <span class="s1">objRef </span><span class="s2">= </span><span class="s1">ObjectRef</span><span class="s2">(</span><span class="s1">Indirection</span><span class="s2">(</span><span class="s1">evalStr</span><span class="s2">=</span><span class="s4">'%s' </span><span class="s2">% </span><span class="s1">key</span><span class="s2">),</span>
                                                       <span class="s1">id</span><span class="s2">(</span><span class="s1">curObj</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]))</span>
                                <span class="s0">else</span><span class="s2">:</span>
                                    <span class="s1">objRef </span><span class="s2">= </span><span class="s1">ObjectRef</span><span class="s2">(</span><span class="s1">Indirection</span><span class="s2">(</span><span class="s1">dictKey</span><span class="s2">=</span><span class="s1">key</span><span class="s2">),</span>
                                                       <span class="s1">id</span><span class="s2">(</span><span class="s1">curObj</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]), </span><span class="s1">parentObjRef</span><span class="s2">)</span>
                                <span class="s0">yield None</span>
                                <span class="s0">if </span><span class="s1">hasLength</span><span class="s2">:</span>
                                    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_addContainerGen</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">, </span><span class="s1">objRef</span><span class="s2">):</span>
                                        <span class="s0">yield None</span>
                                <span class="s0">if </span><span class="s1">notDeadEnd</span><span class="s2">:</span>
                                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_addDiscoveredStartRef</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">, </span><span class="s1">objRef</span><span class="s2">)</span>
                                    <span class="s0">if </span><span class="s1">curObjRef </span><span class="s0">is None and </span><span class="s1">random</span><span class="s2">.</span><span class="s1">randrange</span><span class="s2">(</span><span class="s1">numKeysLeft</span><span class="s2">) == </span><span class="s3">0</span><span class="s2">:</span>
                                        <span class="s1">curObjRef </span><span class="s2">= </span><span class="s1">objRef</span>
                    <span class="s0">del </span><span class="s1">key</span>
                    <span class="s0">del </span><span class="s1">attr</span>
                    <span class="s0">continue</span>

                    <span class="s0">try</span><span class="s2">:</span>
                        <span class="s1">childNames </span><span class="s2">= </span><span class="s1">dir</span><span class="s2">(</span><span class="s1">curObj</span><span class="s2">)</span>
                    <span class="s0">except</span><span class="s2">:</span>
                        <span class="s0">pass</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s0">try</span><span class="s2">:</span>
                            <span class="s1">index </span><span class="s2">= -</span><span class="s3">1</span>
                            <span class="s1">attrs </span><span class="s2">= []</span>
                            <span class="s0">while </span><span class="s3">1</span><span class="s2">:</span>
                                <span class="s0">yield None</span>
                                <span class="s0">try</span><span class="s2">:</span>
                                    <span class="s1">attr </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">itr</span><span class="s2">)</span>
                                <span class="s0">except</span><span class="s2">:</span>
                                    <span class="s5"># some custom classes don't do well when iterated</span>
                                    <span class="s1">attr </span><span class="s2">= </span><span class="s0">None</span>
                                    <span class="s0">break</span>
                                <span class="s1">attrs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">)</span>
                            <span class="s5"># we will continue traversing the object graph via one attr,</span>
                            <span class="s5"># choose it at random without taking a big chunk of CPU time</span>
                            <span class="s1">numAttrsLeft </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">) + </span><span class="s3">1</span>
                            <span class="s0">for </span><span class="s1">attr </span><span class="s0">in </span><span class="s1">attrs</span><span class="s2">:</span>
                                <span class="s0">yield None</span>
                                <span class="s1">index </span><span class="s2">+= </span><span class="s3">1</span>
                                <span class="s1">numAttrsLeft </span><span class="s2">-= </span><span class="s3">1</span>
                                <span class="s1">hasLength </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_hasLength</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">)</span>
                                <span class="s1">notDeadEnd </span><span class="s2">= </span><span class="s0">False</span>
                                <span class="s0">if </span><span class="s1">curObjRef </span><span class="s0">is None</span><span class="s2">:</span>
                                    <span class="s1">notDeadEnd </span><span class="s2">= </span><span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_isDeadEnd</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">)</span>
                                <span class="s0">if </span><span class="s1">hasLength </span><span class="s0">or </span><span class="s1">notDeadEnd</span><span class="s2">:</span>
                                    <span class="s5"># prevent cycles in the references (i.e. base.loader.base)</span>
                                    <span class="s0">for </span><span class="s1">goesThrough </span><span class="s0">in </span><span class="s1">parentObjRef</span><span class="s2">.</span><span class="s1">goesThrough</span><span class="s2">(</span><span class="s1">curObj</span><span class="s2">[</span><span class="s1">index</span><span class="s2">]):</span>
                                        <span class="s5"># don't yield, container might lose this element</span>
                                        <span class="s0">pass</span>
                                    <span class="s0">if not </span><span class="s1">goesThrough</span><span class="s2">:</span>
                                        <span class="s1">objRef </span><span class="s2">= </span><span class="s1">ObjectRef</span><span class="s2">(</span><span class="s1">Indirection</span><span class="s2">(</span><span class="s1">evalStr</span><span class="s2">=</span><span class="s4">'[%s]' </span><span class="s2">% </span><span class="s1">index</span><span class="s2">),</span>
                                                           <span class="s1">id</span><span class="s2">(</span><span class="s1">curObj</span><span class="s2">[</span><span class="s1">index</span><span class="s2">]), </span><span class="s1">parentObjRef</span><span class="s2">)</span>
                                        <span class="s0">yield None</span>
                                        <span class="s0">if </span><span class="s1">hasLength</span><span class="s2">:</span>
                                            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_addContainerGen</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">, </span><span class="s1">objRef</span><span class="s2">):</span>
                                                <span class="s0">yield None</span>
                                        <span class="s0">if </span><span class="s1">notDeadEnd</span><span class="s2">:</span>
                                            <span class="s1">self</span><span class="s2">.</span><span class="s1">_addDiscoveredStartRef</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">, </span><span class="s1">objRef</span><span class="s2">)</span>
                                            <span class="s0">if </span><span class="s1">curObjRef </span><span class="s0">is None and </span><span class="s1">random</span><span class="s2">.</span><span class="s1">randrange</span><span class="s2">(</span><span class="s1">numAttrsLeft</span><span class="s2">) == </span><span class="s3">0</span><span class="s2">:</span>
                                                <span class="s1">curObjRef </span><span class="s2">= </span><span class="s1">objRef</span>
                            <span class="s0">del </span><span class="s1">attr</span>
                        <span class="s0">except </span><span class="s1">StopIteration </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                            <span class="s0">pass</span>
                        <span class="s0">del </span><span class="s1">itr</span>
                        <span class="s0">continue</span>

        <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s4">'FindContainers job caught exception: %s' </span><span class="s2">% </span><span class="s1">e</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">__dev__</span><span class="s2">:</span>
                <span class="s0">raise</span>
        <span class="s0">yield </span><span class="s1">Job</span><span class="s2">.</span><span class="s1">Done</span>

<span class="s0">class </span><span class="s1">CheckContainers</span><span class="s2">(</span><span class="s1">Job</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Job to check container sizes and find potential leaks; sub-job of ContainerLeakDetector 
    &quot;&quot;&quot;</span>
    <span class="s1">ReprItems </span><span class="s2">= </span><span class="s3">5</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">leakDetector</span><span class="s2">, </span><span class="s1">index</span><span class="s2">):</span>
        <span class="s1">Job</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector </span><span class="s2">= </span><span class="s1">leakDetector</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">notify</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_index </span><span class="s2">= </span><span class="s1">index</span>
        <span class="s1">ContainerLeakDetector</span><span class="s2">.</span><span class="s1">addPrivateObj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ContainerLeakDetector</span><span class="s2">.</span><span class="s1">removePrivateObj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)</span>
        <span class="s1">Job</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getPriority</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Job</span><span class="s2">.</span><span class="s1">Priorities</span><span class="s2">.</span><span class="s1">Normal</span>

    <span class="s0">def </span><span class="s1">run</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">_index2containerId2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">] = {}</span>
            <span class="s1">ids </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerIds</span><span class="s2">()</span>
            <span class="s5"># record the current len of each container</span>
            <span class="s0">for </span><span class="s1">objId </span><span class="s0">in </span><span class="s1">ids</span><span class="s2">:</span>
                <span class="s0">yield None</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s0">for </span><span class="s1">result </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerByIdGen</span><span class="s2">(</span><span class="s1">objId</span><span class="s2">):</span>
                        <span class="s0">yield None</span>
                    <span class="s1">container </span><span class="s2">= </span><span class="s1">result</span>
                <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                    <span class="s5"># this container no longer exists</span>
                    <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">getDebug</span><span class="s2">():</span>
                        <span class="s0">for </span><span class="s1">contName </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerNameByIdGen</span><span class="s2">(</span><span class="s1">objId</span><span class="s2">):</span>
                            <span class="s0">yield None</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span>
                            <span class="s4">'%s no longer exists; caught exception in getContainerById (%s)' </span><span class="s2">% (</span>
                            <span class="s1">contName</span><span class="s2">, </span><span class="s1">e</span><span class="s2">))</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">removeContainerById</span><span class="s2">(</span><span class="s1">objId</span><span class="s2">)</span>
                    <span class="s0">continue</span>
                <span class="s0">if </span><span class="s1">container </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s5"># this container no longer exists</span>
                    <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">getDebug</span><span class="s2">():</span>
                        <span class="s0">for </span><span class="s1">contName </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerNameByIdGen</span><span class="s2">(</span><span class="s1">objId</span><span class="s2">):</span>
                            <span class="s0">yield None</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s4">'%s no longer exists; getContainerById returned None' </span><span class="s2">%</span>
                                          <span class="s1">contName</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">removeContainerById</span><span class="s2">(</span><span class="s1">objId</span><span class="s2">)</span>
                    <span class="s0">continue</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">cLen </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">container</span><span class="s2">)</span>
                <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                    <span class="s5"># this container no longer exists</span>
                    <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">getDebug</span><span class="s2">():</span>
                        <span class="s0">for </span><span class="s1">contName </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerNameByIdGen</span><span class="s2">(</span><span class="s1">objId</span><span class="s2">):</span>
                            <span class="s0">yield None</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span>
                            <span class="s4">'%s is no longer a container, it is now %s (%s)' </span><span class="s2">%</span>
                            <span class="s2">(</span><span class="s1">contName</span><span class="s2">, </span><span class="s1">safeRepr</span><span class="s2">(</span><span class="s1">container</span><span class="s2">), </span><span class="s1">e</span><span class="s2">))</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">removeContainerById</span><span class="s2">(</span><span class="s1">objId</span><span class="s2">)</span>
                    <span class="s0">continue</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">_index2containerId2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">][</span><span class="s1">objId</span><span class="s2">] = </span><span class="s1">cLen</span>
            <span class="s5"># compare the current len of each container to past lens</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">idx2id2len </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">_index2containerId2len</span>
                <span class="s0">for </span><span class="s1">objId </span><span class="s0">in </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">]:</span>
                    <span class="s0">yield None</span>
                    <span class="s0">if </span><span class="s1">objId </span><span class="s0">in </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">-</span><span class="s3">1</span><span class="s2">]:</span>
                        <span class="s1">diff </span><span class="s2">= </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">][</span><span class="s1">objId</span><span class="s2">] - </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">-</span><span class="s3">1</span><span class="s2">][</span><span class="s1">objId</span><span class="s2">]</span>
                        <span class="s4">&quot;&quot;&quot; 
                        # this check is too spammy 
                        if diff &gt; 20: 
                            if diff &gt; idx2id2len[self._index-1][objId]: 
                                minutes = (self._leakDetector._index2delay[self._index] - 
                                           self._leakDetector._index2delay[self._index-1]) / 60. 
                                name = self._leakDetector.getContainerNameById(objId) 
                                if idx2id2len[self._index-1][objId] != 0: 
                                    percent = 100. * (float(diff) / float(idx2id2len[self._index-1][objId])) 
                                    try: 
                                        for container in self._leakDetector.getContainerByIdGen(objId): 
                                            yield None 
                                    except: 
                                        # TODO 
                                        self.notify.debug('caught exception in getContainerByIdGen (1)') 
                                    else: 
                                        self.notify.warning( 
                                            '%s (%s) grew %.2f%% in %.2f minutes (%s items at last measurement, current contents: %s)' % ( 
                                            name, itype(container), percent, minutes, idx2id2len[self._index][objId], 
                                            fastRepr(container, maxLen=CheckContainers.ReprItems))) 
                                    yield None 
                                    &quot;&quot;&quot;</span>
                        <span class="s0">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index </span><span class="s2">&gt; </span><span class="s3">2 </span><span class="s0">and</span>
                            <span class="s1">objId </span><span class="s0">in </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">-</span><span class="s3">2</span><span class="s2">] </span><span class="s0">and</span>
                            <span class="s1">objId </span><span class="s0">in </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">-</span><span class="s3">3</span><span class="s2">]):</span>
                            <span class="s1">diff2 </span><span class="s2">= </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">-</span><span class="s3">1</span><span class="s2">][</span><span class="s1">objId</span><span class="s2">] - </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">-</span><span class="s3">2</span><span class="s2">][</span><span class="s1">objId</span><span class="s2">]</span>
                            <span class="s1">diff3 </span><span class="s2">= </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">-</span><span class="s3">2</span><span class="s2">][</span><span class="s1">objId</span><span class="s2">] - </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">-</span><span class="s3">3</span><span class="s2">][</span><span class="s1">objId</span><span class="s2">]</span>
                            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index </span><span class="s2">&lt;= </span><span class="s3">4</span><span class="s2">:</span>
                                <span class="s0">if </span><span class="s1">diff </span><span class="s2">&gt; </span><span class="s3">0 </span><span class="s0">and </span><span class="s1">diff2 </span><span class="s2">&gt; </span><span class="s3">0 </span><span class="s0">and </span><span class="s1">diff3 </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                                    <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerNameById</span><span class="s2">(</span><span class="s1">objId</span><span class="s2">)</span>
                                    <span class="s0">try</span><span class="s2">:</span>
                                        <span class="s0">for </span><span class="s1">container </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerByIdGen</span><span class="s2">(</span><span class="s1">objId</span><span class="s2">):</span>
                                            <span class="s0">yield None</span>
                                    <span class="s0">except</span><span class="s2">:</span>
                                        <span class="s5"># TODO</span>
                                        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s4">'caught exception in getContainerByIdGen (2)'</span><span class="s2">)</span>
                                    <span class="s0">else</span><span class="s2">:</span>
                                        <span class="s1">msg </span><span class="s2">= (</span><span class="s4">'%s (%s) consistently increased in size over the last '</span>
                                               <span class="s4">'3 periods (%s items at last measurement, current contents: %s)' </span><span class="s2">%</span>
                                               <span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">itype</span><span class="s2">(</span><span class="s1">container</span><span class="s2">), </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">][</span><span class="s1">objId</span><span class="s2">],</span>
                                                <span class="s1">fastRepr</span><span class="s2">(</span><span class="s1">container</span><span class="s2">, </span><span class="s1">maxLen</span><span class="s2">=</span><span class="s1">CheckContainers</span><span class="s2">.</span><span class="s1">ReprItems</span><span class="s2">)))</span>
                                        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>
                                    <span class="s0">yield None</span>
                            <span class="s0">elif </span><span class="s2">(</span><span class="s1">objId </span><span class="s0">in </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">-</span><span class="s3">4</span><span class="s2">] </span><span class="s0">and</span>
                                  <span class="s1">objId </span><span class="s0">in </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">-</span><span class="s3">5</span><span class="s2">]):</span>
                                <span class="s5"># if size has consistently increased over the last 5 checks,</span>
                                <span class="s5"># send out a warning</span>
                                <span class="s1">diff4 </span><span class="s2">= </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">-</span><span class="s3">3</span><span class="s2">][</span><span class="s1">objId</span><span class="s2">] - </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">-</span><span class="s3">4</span><span class="s2">][</span><span class="s1">objId</span><span class="s2">]</span>
                                <span class="s1">diff5 </span><span class="s2">= </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">-</span><span class="s3">4</span><span class="s2">][</span><span class="s1">objId</span><span class="s2">] - </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">-</span><span class="s3">5</span><span class="s2">][</span><span class="s1">objId</span><span class="s2">]</span>
                                <span class="s0">if </span><span class="s1">diff </span><span class="s2">&gt; </span><span class="s3">0 </span><span class="s0">and </span><span class="s1">diff2 </span><span class="s2">&gt; </span><span class="s3">0 </span><span class="s0">and </span><span class="s1">diff3 </span><span class="s2">&gt; </span><span class="s3">0 </span><span class="s0">and </span><span class="s1">diff4 </span><span class="s2">&gt; </span><span class="s3">0 </span><span class="s0">and </span><span class="s1">diff5 </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                                    <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerNameById</span><span class="s2">(</span><span class="s1">objId</span><span class="s2">)</span>
                                    <span class="s0">try</span><span class="s2">:</span>
                                        <span class="s0">for </span><span class="s1">container </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerByIdGen</span><span class="s2">(</span><span class="s1">objId</span><span class="s2">):</span>
                                            <span class="s0">yield None</span>
                                    <span class="s0">except</span><span class="s2">:</span>
                                        <span class="s5"># TODO</span>
                                        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s4">'caught exception in getContainerByIdGen (3)'</span><span class="s2">)</span>
                                    <span class="s0">else</span><span class="s2">:</span>
                                        <span class="s1">msg </span><span class="s2">= (</span><span class="s4">'leak detected: %s (%s) consistently increased in size over the last '</span>
                                               <span class="s4">'5 periods (%s items at last measurement, current contents: %s)' </span><span class="s2">%</span>
                                               <span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">itype</span><span class="s2">(</span><span class="s1">container</span><span class="s2">), </span><span class="s1">idx2id2len</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">][</span><span class="s1">objId</span><span class="s2">],</span>
                                                <span class="s1">fastRepr</span><span class="s2">(</span><span class="s1">container</span><span class="s2">, </span><span class="s1">maxLen</span><span class="s2">=</span><span class="s1">CheckContainers</span><span class="s2">.</span><span class="s1">ReprItems</span><span class="s2">)))</span>
                                        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>
                                        <span class="s0">yield None</span>
                                        <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getLeakEvent</span><span class="s2">(), [</span><span class="s1">container</span><span class="s2">, </span><span class="s1">name</span><span class="s2">])</span>
                                        <span class="s0">if </span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s4">'pdb-on-leak-detect'</span><span class="s2">, </span><span class="s3">0</span><span class="s2">):</span>
                                            <span class="s0">import </span><span class="s1">pdb;pdb</span><span class="s2">.</span><span class="s1">set_trace</span><span class="s2">()</span>
                                            <span class="s0">pass</span>
        <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s4">'CheckContainers job caught exception: %s' </span><span class="s2">% </span><span class="s1">e</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">__dev__</span><span class="s2">:</span>
                <span class="s0">raise</span>
        <span class="s0">yield </span><span class="s1">Job</span><span class="s2">.</span><span class="s1">Done</span>

<span class="s0">class </span><span class="s1">FPTObjsOfType</span><span class="s2">(</span><span class="s1">Job</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">leakDetector</span><span class="s2">, </span><span class="s1">otn</span><span class="s2">, </span><span class="s1">doneCallback</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">Job</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector </span><span class="s2">= </span><span class="s1">leakDetector</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">notify</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_otn </span><span class="s2">= </span><span class="s1">otn</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_doneCallback </span><span class="s2">= </span><span class="s1">doneCallback</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_ldde </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">_getDestroyEvent</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ldde</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_handleLDDestroy</span><span class="s2">)</span>
        <span class="s1">ContainerLeakDetector</span><span class="s2">.</span><span class="s1">addPrivateObj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ignore</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ldde</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_doneCallback </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">ContainerLeakDetector</span><span class="s2">.</span><span class="s1">removePrivateObj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)</span>
        <span class="s1">Job</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_handleLDDestroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">getPriority</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Job</span><span class="s2">.</span><span class="s1">Priorities</span><span class="s2">.</span><span class="s1">High</span>

    <span class="s0">def </span><span class="s1">run</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ids </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerIds</span><span class="s2">()</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">id </span><span class="s0">in </span><span class="s1">ids</span><span class="s2">:</span>
                <span class="s1">getInstance </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_otn</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s0">not in </span><span class="s4">'dict'</span><span class="s2">)</span>
                <span class="s0">yield None</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s0">for </span><span class="s1">container </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerByIdGen</span><span class="s2">(</span>
                        <span class="s1">id</span><span class="s2">, </span><span class="s1">getInstance</span><span class="s2">=</span><span class="s1">getInstance</span><span class="s2">):</span>
                        <span class="s0">yield None</span>
                <span class="s0">except</span><span class="s2">:</span>
                    <span class="s0">pass</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">container</span><span class="s2">, </span><span class="s4">'__class__'</span><span class="s2">):</span>
                        <span class="s1">cName </span><span class="s2">= </span><span class="s1">container</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">cName </span><span class="s2">= </span><span class="s1">container</span><span class="s2">.</span><span class="s1">__name__</span>
                    <span class="s0">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_otn</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s0">in </span><span class="s1">cName</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()):</span>
                        <span class="s0">try</span><span class="s2">:</span>
                            <span class="s0">for </span><span class="s1">ptc </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerNameByIdGen</span><span class="s2">(</span>
                                <span class="s1">id</span><span class="s2">, </span><span class="s1">getInstance</span><span class="s2">=</span><span class="s1">getInstance</span><span class="s2">):</span>
                                <span class="s0">yield None</span>
                        <span class="s0">except</span><span class="s2">:</span>
                            <span class="s0">pass</span>
                        <span class="s0">else</span><span class="s2">:</span>
                            <span class="s1">print</span><span class="s2">(</span><span class="s4">'GPTC(' </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_otn </span><span class="s2">+ </span><span class="s4">'):' </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getJobName</span><span class="s2">() + </span><span class="s4">': ' </span><span class="s2">+ </span><span class="s1">ptc</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s4">'FPTObjsOfType job caught exception: %s' </span><span class="s2">% </span><span class="s1">e</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">__dev__</span><span class="s2">:</span>
                <span class="s0">raise</span>
        <span class="s0">yield </span><span class="s1">Job</span><span class="s2">.</span><span class="s1">Done</span>

    <span class="s0">def </span><span class="s1">finished</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_doneCallback</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_doneCallback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">FPTObjsNamed</span><span class="s2">(</span><span class="s1">Job</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">leakDetector</span><span class="s2">, </span><span class="s1">on</span><span class="s2">, </span><span class="s1">doneCallback</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">Job</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector </span><span class="s2">= </span><span class="s1">leakDetector</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">notify</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_on </span><span class="s2">= </span><span class="s1">on</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_doneCallback </span><span class="s2">= </span><span class="s1">doneCallback</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_ldde </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">_getDestroyEvent</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ldde</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_handleLDDestroy</span><span class="s2">)</span>
        <span class="s1">ContainerLeakDetector</span><span class="s2">.</span><span class="s1">addPrivateObj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ignore</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ldde</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_doneCallback </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">ContainerLeakDetector</span><span class="s2">.</span><span class="s1">removePrivateObj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)</span>
        <span class="s1">Job</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_handleLDDestroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">getPriority</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Job</span><span class="s2">.</span><span class="s1">Priorities</span><span class="s2">.</span><span class="s1">High</span>

    <span class="s0">def </span><span class="s1">run</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ids </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerIds</span><span class="s2">()</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">id </span><span class="s0">in </span><span class="s1">ids</span><span class="s2">:</span>
                <span class="s0">yield None</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s0">for </span><span class="s1">container </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerByIdGen</span><span class="s2">(</span><span class="s1">id</span><span class="s2">):</span>
                        <span class="s0">yield None</span>
                <span class="s0">except</span><span class="s2">:</span>
                    <span class="s0">pass</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">[</span><span class="s1">id</span><span class="s2">].</span><span class="s1">getFinalIndirectionStr</span><span class="s2">()</span>
                    <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_on</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s0">in </span><span class="s1">name</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">():</span>
                        <span class="s0">try</span><span class="s2">:</span>
                            <span class="s0">for </span><span class="s1">ptc </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerNameByIdGen</span><span class="s2">(</span><span class="s1">id</span><span class="s2">):</span>
                                <span class="s0">yield None</span>
                        <span class="s0">except</span><span class="s2">:</span>
                            <span class="s0">pass</span>
                        <span class="s0">else</span><span class="s2">:</span>
                            <span class="s1">print</span><span class="s2">(</span><span class="s4">'GPTCN(' </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_on </span><span class="s2">+ </span><span class="s4">'):' </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getJobName</span><span class="s2">() + </span><span class="s4">': ' </span><span class="s2">+ </span><span class="s1">ptc</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s4">'FPTObjsNamed job caught exception: %s' </span><span class="s2">% </span><span class="s1">e</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">__dev__</span><span class="s2">:</span>
                <span class="s0">raise</span>
        <span class="s0">yield </span><span class="s1">Job</span><span class="s2">.</span><span class="s1">Done</span>

    <span class="s0">def </span><span class="s1">finished</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_doneCallback</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_doneCallback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">PruneObjectRefs</span><span class="s2">(</span><span class="s1">Job</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Job to destroy any container refs that are no longer valid. 
    Checks validity by asking for each container 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">leakDetector</span><span class="s2">):</span>
        <span class="s1">Job</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector </span><span class="s2">= </span><span class="s1">leakDetector</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">notify</span>
        <span class="s1">ContainerLeakDetector</span><span class="s2">.</span><span class="s1">addPrivateObj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ContainerLeakDetector</span><span class="s2">.</span><span class="s1">removePrivateObj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)</span>
        <span class="s1">Job</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getPriority</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Job</span><span class="s2">.</span><span class="s1">Priorities</span><span class="s2">.</span><span class="s1">Normal</span>

    <span class="s0">def </span><span class="s1">run</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">ids </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerIds</span><span class="s2">()</span>
            <span class="s0">for </span><span class="s1">id </span><span class="s0">in </span><span class="s1">ids</span><span class="s2">:</span>
                <span class="s0">yield None</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s0">for </span><span class="s1">container </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">getContainerByIdGen</span><span class="s2">(</span><span class="s1">id</span><span class="s2">):</span>
                        <span class="s0">yield None</span>
                <span class="s0">except</span><span class="s2">:</span>
                    <span class="s5"># reference is invalid, remove it</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">removeContainerById</span><span class="s2">(</span><span class="s1">id</span><span class="s2">)</span>
            <span class="s1">_id2baseStartRef </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">_findContainersJob</span><span class="s2">.</span><span class="s1">_id2baseStartRef</span>
            <span class="s1">ids </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">_id2baseStartRef</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
            <span class="s0">for </span><span class="s1">id </span><span class="s0">in </span><span class="s1">ids</span><span class="s2">:</span>
                <span class="s0">yield None</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s0">for </span><span class="s1">container </span><span class="s0">in </span><span class="s1">_id2baseStartRef</span><span class="s2">[</span><span class="s1">id</span><span class="s2">].</span><span class="s1">getContainerGen</span><span class="s2">():</span>
                        <span class="s0">yield None</span>
                <span class="s0">except</span><span class="s2">:</span>
                    <span class="s5"># reference is invalid, remove it</span>
                    <span class="s0">del </span><span class="s1">_id2baseStartRef</span><span class="s2">[</span><span class="s1">id</span><span class="s2">]</span>
            <span class="s1">_id2discoveredStartRef </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_leakDetector</span><span class="s2">.</span><span class="s1">_findContainersJob</span><span class="s2">.</span><span class="s1">_id2discoveredStartRef</span>
            <span class="s1">ids </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">_id2discoveredStartRef</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
            <span class="s0">for </span><span class="s1">id </span><span class="s0">in </span><span class="s1">ids</span><span class="s2">:</span>
                <span class="s0">yield None</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s0">for </span><span class="s1">container </span><span class="s0">in </span><span class="s1">_id2discoveredStartRef</span><span class="s2">[</span><span class="s1">id</span><span class="s2">].</span><span class="s1">getContainerGen</span><span class="s2">():</span>
                        <span class="s0">yield None</span>
                <span class="s0">except</span><span class="s2">:</span>
                    <span class="s5"># reference is invalid, remove it</span>
                    <span class="s0">del </span><span class="s1">_id2discoveredStartRef</span><span class="s2">[</span><span class="s1">id</span><span class="s2">]</span>
        <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s4">'PruneObjectRefs job caught exception: %s' </span><span class="s2">% </span><span class="s1">e</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">__dev__</span><span class="s2">:</span>
                <span class="s0">raise</span>
        <span class="s0">yield </span><span class="s1">Job</span><span class="s2">.</span><span class="s1">Done</span>

<span class="s0">class </span><span class="s1">ContainerLeakDetector</span><span class="s2">(</span><span class="s1">Job</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Low-priority Python object-graph walker that looks for leaking containers. 
    To reduce memory usage, this does a random walk of the Python objects to 
    discover containers rather than keep a set of all visited objects; it may 
    visit the same object many times but eventually it will discover every object. 
    Checks container sizes at ever-increasing intervals. 
    &quot;&quot;&quot;</span>
    <span class="s1">notify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s4">&quot;ContainerLeakDetector&quot;</span><span class="s2">)</span>
    <span class="s5"># set of containers that should not be examined</span>
    <span class="s1">PrivateIds </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">firstCheckDelay </span><span class="s2">= </span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">Job</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_serialNum </span><span class="s2">= </span><span class="s1">serialNum</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_findContainersJob </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_checkContainersJob </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_pruneContainersJob </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s0">if </span><span class="s1">firstCheckDelay </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">firstCheckDelay </span><span class="s2">= </span><span class="s3">60. </span><span class="s2">* </span><span class="s3">15.</span>
        <span class="s5"># divide by two, since the first check just takes length measurements and</span>
        <span class="s5"># doesn't check for leaks</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_nextCheckDelay </span><span class="s2">= </span><span class="s1">firstCheckDelay</span><span class="s2">/</span><span class="s3">2.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_checkDelayScale </span><span class="s2">= </span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetFloat</span><span class="s2">(</span><span class="s4">'leak-detector-check-delay-scale'</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_pruneTaskPeriod </span><span class="s2">= </span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetFloat</span><span class="s2">(</span><span class="s4">'leak-detector-prune-period'</span><span class="s2">, </span><span class="s3">60. </span><span class="s2">* </span><span class="s3">30.</span><span class="s2">)</span>

        <span class="s5"># main dict of id(container)-&gt;containerRef</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref </span><span class="s2">= {}</span>
        <span class="s5"># storage for results of check-container job</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_index2containerId2len </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_index2delay </span><span class="s2">= {}</span>

        <span class="s0">if </span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s4">'leak-container'</span><span class="s2">, </span><span class="s3">0</span><span class="s2">):</span>
            <span class="s1">_createContainerLeak</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s4">'leak-tasks'</span><span class="s2">, </span><span class="s3">0</span><span class="s2">):</span>
            <span class="s1">_createTaskLeak</span><span class="s2">()</span>

        <span class="s5"># don't check our own tables for leaks</span>
        <span class="s1">ContainerLeakDetector</span><span class="s2">.</span><span class="s1">addPrivateObj</span><span class="s2">(</span><span class="s1">ContainerLeakDetector</span><span class="s2">.</span><span class="s1">PrivateIds</span><span class="s2">)</span>
        <span class="s1">ContainerLeakDetector</span><span class="s2">.</span><span class="s1">addPrivateObj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">setPriority</span><span class="s2">(</span><span class="s1">Job</span><span class="s2">.</span><span class="s1">Priorities</span><span class="s2">.</span><span class="s1">Min</span><span class="s2">)</span>
        <span class="s1">jobMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_getDestroyEvent</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreAll</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pruneContainersJob </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">jobMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pruneContainersJob</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_pruneContainersJob </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_checkContainersJob </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">jobMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_checkContainersJob</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_checkContainersJob </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">jobMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_findContainersJob</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_findContainersJob </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index2containerId2len</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index2delay</span>

    <span class="s0">def </span><span class="s1">_getDestroyEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># sent when leak detector is about to be destroyed</span>
        <span class="s0">return </span><span class="s4">'cldDestroy-%s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_serialNum</span>

    <span class="s0">def </span><span class="s1">getLeakEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># sent when a leak is detected</span>
        <span class="s5"># passes description string as argument</span>
        <span class="s0">return </span><span class="s4">'containerLeakDetected-%s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_serialNum</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">addPrivateObj</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">PrivateIds</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">id</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">))</span>
    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">removePrivateObj</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">PrivateIds</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">id</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">_getCheckTaskName</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s4">'checkForLeakingContainers-%s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_serialNum</span>
    <span class="s0">def </span><span class="s1">_getPruneTaskName</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s4">'pruneLeakingContainerRefs-%s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_serialNum</span>

    <span class="s0">def </span><span class="s1">getContainerIds</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">getContainerByIdGen</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">id</span><span class="s2">, **</span><span class="s1">kwArgs</span><span class="s2">):</span>
        <span class="s5"># return a generator to look up a container</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">[</span><span class="s1">id</span><span class="s2">].</span><span class="s1">getContainerGen</span><span class="s2">(**</span><span class="s1">kwArgs</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">getContainerById</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">id</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">result </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">[</span><span class="s1">id</span><span class="s2">].</span><span class="s1">getContainerGen</span><span class="s2">():</span>
            <span class="s0">pass</span>
        <span class="s0">return </span><span class="s1">result</span>
    <span class="s0">def </span><span class="s1">getContainerNameByIdGen</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">id</span><span class="s2">, **</span><span class="s1">kwArgs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">[</span><span class="s1">id</span><span class="s2">].</span><span class="s1">getEvalStrGen</span><span class="s2">(**</span><span class="s1">kwArgs</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">getContainerNameById</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">id</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">id </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">[</span><span class="s1">id</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s4">'&lt;unknown container&gt;'</span>
    <span class="s0">def </span><span class="s1">removeContainerById</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">id</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">id </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">[</span><span class="s1">id</span><span class="s2">].</span><span class="s1">destroy</span><span class="s2">()</span>
            <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2ref</span><span class="s2">[</span><span class="s1">id</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">run</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># start looking for containers</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_findContainersJob </span><span class="s2">= </span><span class="s1">FindContainers</span><span class="s2">(</span>
            <span class="s4">'%s-findContainers' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getJobName</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">jobMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_findContainersJob</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_scheduleNextLeakCheck</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_scheduleNextPruning</span><span class="s2">()</span>

        <span class="s0">while True</span><span class="s2">:</span>
            <span class="s0">yield </span><span class="s1">Job</span><span class="s2">.</span><span class="s1">Sleep</span>

    <span class="s0">def </span><span class="s1">getPathsToContainers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">ot</span><span class="s2">, </span><span class="s1">doneCallback</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">j </span><span class="s2">=  </span><span class="s1">FPTObjsOfType</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">ot</span><span class="s2">, </span><span class="s1">doneCallback</span><span class="s2">)</span>
        <span class="s1">jobMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">j</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">j</span>

    <span class="s0">def </span><span class="s1">getPathsToContainersNamed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">on</span><span class="s2">, </span><span class="s1">doneCallback</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">j </span><span class="s2">=  </span><span class="s1">FPTObjsNamed</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">on</span><span class="s2">, </span><span class="s1">doneCallback</span><span class="s2">)</span>
        <span class="s1">jobMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">j</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">j</span>

    <span class="s0">def </span><span class="s1">_scheduleNextLeakCheck</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">doMethodLater</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_nextCheckDelay</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_checkForLeaks</span><span class="s2">,</span>
                              <span class="s1">self</span><span class="s2">.</span><span class="s1">_getCheckTaskName</span><span class="s2">())</span>
        <span class="s5"># delay between checks</span>
        <span class="s5"># fib:    1   1   2   3   5   8   13   21   34   55   89</span>
        <span class="s5"># * 2.:   1   2   4   8  16  32   64  128  256  512 1024</span>
        <span class="s5"># * 1.5:  1 1.5 2.3 3.4 5.1 7.6 11.4 17.1 25.6 38.4 57.7</span>
        <span class="s5">#</span>
        <span class="s5"># delay from job start</span>
        <span class="s5"># fib:    1   2    4    7   12   20    33    54    88    143    232</span>
        <span class="s5"># * 2.:   1   3    7   15   31   63   127   255   511   1023   2047</span>
        <span class="s5"># * 1.5:  1 2.5 4.75  8.1 13.2 20.8  32.2  49.3  74.9  113.3    171</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_nextCheckDelay </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_nextCheckDelay </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_checkDelayScale</span>

    <span class="s0">def </span><span class="s1">_checkForLeaks</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">task</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_index2delay</span><span class="s2">[</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index2containerId2len</span><span class="s2">)] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_nextCheckDelay</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_checkContainersJob </span><span class="s2">= </span><span class="s1">CheckContainers</span><span class="s2">(</span>
            <span class="s4">'%s-checkForLeaks' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getJobName</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index2containerId2len</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">acceptOnce</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_checkContainersJob</span><span class="s2">.</span><span class="s1">getFinishedEvent</span><span class="s2">(),</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">_scheduleNextLeakCheck</span><span class="s2">)</span>
        <span class="s1">jobMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_checkContainersJob</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">task</span><span class="s2">.</span><span class="s1">done</span>

    <span class="s0">def </span><span class="s1">_scheduleNextPruning</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">doMethodLater</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pruneTaskPeriod</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pruneObjectRefs</span><span class="s2">,</span>
                              <span class="s1">self</span><span class="s2">.</span><span class="s1">_getPruneTaskName</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">_pruneObjectRefs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">task</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_pruneContainersJob </span><span class="s2">= </span><span class="s1">PruneObjectRefs</span><span class="s2">(</span>
            <span class="s4">'%s-pruneObjectRefs' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getJobName</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">acceptOnce</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pruneContainersJob</span><span class="s2">.</span><span class="s1">getFinishedEvent</span><span class="s2">(),</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">_scheduleNextPruning</span><span class="s2">)</span>
        <span class="s1">jobMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pruneContainersJob</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">task</span><span class="s2">.</span><span class="s1">done</span>
</pre>
</body>
</html>