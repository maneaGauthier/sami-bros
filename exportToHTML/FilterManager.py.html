<html>
<head>
<title>FilterManager.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
FilterManager.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
 
The FilterManager is a convenience class that helps with the creation 
of render-to-texture buffers for image postprocessing applications. 
 
See :ref:`generalized-image-filters` for information on how to use this class. 
 
Still need to implement: 
 
* Make sure sort-order of buffers is correct. 
* Matching buffer size to original region instead of original window. 
* Intermediate layer creation. 
* Handling of window clears. 
* Resizing of windows. 
* Do something about window-size roundoff problems. 
 
&quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s1">panda3d</span><span class="s3">.</span><span class="s1">core </span><span class="s2">import </span><span class="s1">NodePath</span>
<span class="s2">from </span><span class="s1">panda3d</span><span class="s3">.</span><span class="s1">core </span><span class="s2">import </span><span class="s1">Texture</span>
<span class="s2">from </span><span class="s1">panda3d</span><span class="s3">.</span><span class="s1">core </span><span class="s2">import </span><span class="s1">CardMaker</span>
<span class="s2">from </span><span class="s1">panda3d</span><span class="s3">.</span><span class="s1">core </span><span class="s2">import </span><span class="s1">GraphicsPipe</span><span class="s3">, </span><span class="s1">GraphicsOutput</span>
<span class="s2">from </span><span class="s1">panda3d</span><span class="s3">.</span><span class="s1">core </span><span class="s2">import </span><span class="s1">WindowProperties</span><span class="s3">, </span><span class="s1">FrameBufferProperties</span>
<span class="s2">from </span><span class="s1">panda3d</span><span class="s3">.</span><span class="s1">core </span><span class="s2">import </span><span class="s1">Camera</span>
<span class="s2">from </span><span class="s1">panda3d</span><span class="s3">.</span><span class="s1">core </span><span class="s2">import </span><span class="s1">OrthographicLens</span>
<span class="s2">from </span><span class="s1">panda3d</span><span class="s3">.</span><span class="s1">core </span><span class="s2">import </span><span class="s1">AuxBitplaneAttrib</span>
<span class="s2">from </span><span class="s1">panda3d</span><span class="s3">.</span><span class="s1">core </span><span class="s2">import </span><span class="s1">LightRampAttrib</span>
<span class="s2">from </span><span class="s1">direct</span><span class="s3">.</span><span class="s1">directnotify</span><span class="s3">.</span><span class="s1">DirectNotifyGlobal </span><span class="s2">import </span><span class="s3">*</span>
<span class="s2">from </span><span class="s1">direct</span><span class="s3">.</span><span class="s1">showbase</span><span class="s3">.</span><span class="s1">DirectObject </span><span class="s2">import </span><span class="s1">DirectObject</span>

<span class="s1">__all__ </span><span class="s3">= [</span><span class="s4">&quot;FilterManager&quot;</span><span class="s3">]</span>

<span class="s2">class </span><span class="s1">FilterManager</span><span class="s3">(</span><span class="s1">DirectObject</span><span class="s3">):</span>

    <span class="s1">notify </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">win</span><span class="s3">, </span><span class="s1">cam</span><span class="s3">, </span><span class="s1">forcex</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">forcey</span><span class="s3">=</span><span class="s5">0</span><span class="s3">):</span>

        <span class="s0">&quot;&quot;&quot; The FilterManager constructor requires you to provide 
        a window which is rendering a scene, and the camera which is 
        used by that window to render the scene.  These are henceforth 
        called the 'original window' and the 'original camera.' &quot;&quot;&quot;</span>

        <span class="s6"># Create the notify category</span>

        <span class="s2">if </span><span class="s1">FilterManager</span><span class="s3">.</span><span class="s1">notify </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">FilterManager</span><span class="s3">.</span><span class="s1">notify </span><span class="s3">= </span><span class="s1">directNotify</span><span class="s3">.</span><span class="s1">newCategory</span><span class="s3">(</span><span class="s4">&quot;FilterManager&quot;</span><span class="s3">)</span>

        <span class="s6"># Find the appropriate display region.</span>

        <span class="s1">region </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">for </span><span class="s1">dr </span><span class="s2">in </span><span class="s1">win</span><span class="s3">.</span><span class="s1">getDisplayRegions</span><span class="s3">():</span>
            <span class="s1">drcam </span><span class="s3">= </span><span class="s1">dr</span><span class="s3">.</span><span class="s1">getCamera</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">drcam </span><span class="s3">== </span><span class="s1">cam</span><span class="s3">:</span>
                <span class="s1">region </span><span class="s3">= </span><span class="s1">dr</span>

        <span class="s2">if </span><span class="s1">region </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">'Could not find appropriate DisplayRegion to filter'</span><span class="s3">)</span>
            <span class="s2">return False</span>

        <span class="s6"># Instance Variables.</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">win </span><span class="s3">= </span><span class="s1">win</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">forcex </span><span class="s3">= </span><span class="s1">forcex</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">forcey </span><span class="s3">= </span><span class="s1">forcey</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">engine </span><span class="s3">= </span><span class="s1">win</span><span class="s3">.</span><span class="s1">getGsg</span><span class="s3">().</span><span class="s1">getEngine</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">region </span><span class="s3">= </span><span class="s1">region</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">wclears </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getClears</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">win</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">rclears </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getClears</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">region</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">camera </span><span class="s3">= </span><span class="s1">cam</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">caminit </span><span class="s3">= </span><span class="s1">cam</span><span class="s3">.</span><span class="s1">node</span><span class="s3">().</span><span class="s1">getInitialState</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">camstate </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">caminit</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">buffers </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sizes </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">nextsort </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">win</span><span class="s3">.</span><span class="s1">getSort</span><span class="s3">() - </span><span class="s5">1000</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">basex </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">basey </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">accept</span><span class="s3">(</span><span class="s4">&quot;window-event&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">windowEvent</span><span class="s3">)</span>


    <span class="s2">def </span><span class="s1">getClears</span><span class="s3">(</span><span class="s1">self</span><span class="s3">,</span><span class="s1">region</span><span class="s3">):</span>
        <span class="s1">clears </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">GraphicsOutput</span><span class="s3">.</span><span class="s1">RTPCOUNT</span><span class="s3">):</span>
            <span class="s1">clears</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">region</span><span class="s3">.</span><span class="s1">getClearActive</span><span class="s3">(</span><span class="s1">i</span><span class="s3">), </span><span class="s1">region</span><span class="s3">.</span><span class="s1">getClearValue</span><span class="s3">(</span><span class="s1">i</span><span class="s3">)))</span>
        <span class="s2">return </span><span class="s1">clears</span>

    <span class="s2">def </span><span class="s1">setClears</span><span class="s3">(</span><span class="s1">self</span><span class="s3">,</span><span class="s1">region</span><span class="s3">,</span><span class="s1">clears</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">GraphicsOutput</span><span class="s3">.</span><span class="s1">RTPCOUNT</span><span class="s3">):</span>
            <span class="s3">(</span><span class="s1">active</span><span class="s3">, </span><span class="s1">value</span><span class="s3">) = </span><span class="s1">clears</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
            <span class="s1">region</span><span class="s3">.</span><span class="s1">setClearActive</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">active</span><span class="s3">)</span>
            <span class="s1">region</span><span class="s3">.</span><span class="s1">setClearValue</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">value</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">setStackedClears</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">region</span><span class="s3">, </span><span class="s1">clears0</span><span class="s3">, </span><span class="s1">clears1</span><span class="s3">):</span>
        <span class="s1">clears </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">GraphicsOutput</span><span class="s3">.</span><span class="s1">RTPCOUNT</span><span class="s3">):</span>
            <span class="s3">(</span><span class="s1">active</span><span class="s3">, </span><span class="s1">value</span><span class="s3">) = </span><span class="s1">clears0</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">active </span><span class="s3">== </span><span class="s5">0</span><span class="s3">):</span>
                <span class="s3">(</span><span class="s1">active</span><span class="s3">, </span><span class="s1">value</span><span class="s3">) = </span><span class="s1">clears1</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
            <span class="s1">region</span><span class="s3">.</span><span class="s1">setClearActive</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">active</span><span class="s3">)</span>
            <span class="s1">region</span><span class="s3">.</span><span class="s1">setClearValue</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">value</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">clears</span>

    <span class="s2">def </span><span class="s1">isFullscreen</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">((</span><span class="s1">self</span><span class="s3">.</span><span class="s1">region</span><span class="s3">.</span><span class="s1">getLeft</span><span class="s3">()   == </span><span class="s5">0.0</span><span class="s3">) </span><span class="s2">and</span>
                <span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">region</span><span class="s3">.</span><span class="s1">getRight</span><span class="s3">()  == </span><span class="s5">1.0</span><span class="s3">) </span><span class="s2">and</span>
                <span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">region</span><span class="s3">.</span><span class="s1">getBottom</span><span class="s3">() == </span><span class="s5">0.0</span><span class="s3">) </span><span class="s2">and</span>
                <span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">region</span><span class="s3">.</span><span class="s1">getTop</span><span class="s3">()    == </span><span class="s5">1.0</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">getScaledSize</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">mul</span><span class="s3">, </span><span class="s1">div</span><span class="s3">, </span><span class="s1">align</span><span class="s3">):</span>

        <span class="s0">&quot;&quot;&quot; Calculate the size of the desired window. Not public. &quot;&quot;&quot;</span>

        <span class="s1">winx </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">forcex</span>
        <span class="s1">winy </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">forcey</span>
        <span class="s2">if </span><span class="s1">winx </span><span class="s3">== </span><span class="s5">0</span><span class="s3">: </span><span class="s1">winx </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">win</span><span class="s3">.</span><span class="s1">getXSize</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">winy </span><span class="s3">== </span><span class="s5">0</span><span class="s3">: </span><span class="s1">winy </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">win</span><span class="s3">.</span><span class="s1">getYSize</span><span class="s3">()</span>

        <span class="s2">if </span><span class="s1">div </span><span class="s3">!= </span><span class="s5">1</span><span class="s3">:</span>
            <span class="s1">winx </span><span class="s3">= ((</span><span class="s1">winx</span><span class="s3">+</span><span class="s1">align</span><span class="s3">-</span><span class="s5">1</span><span class="s3">) // </span><span class="s1">align</span><span class="s3">) * </span><span class="s1">align</span>
            <span class="s1">winy </span><span class="s3">= ((</span><span class="s1">winy</span><span class="s3">+</span><span class="s1">align</span><span class="s3">-</span><span class="s5">1</span><span class="s3">) // </span><span class="s1">align</span><span class="s3">) * </span><span class="s1">align</span>
            <span class="s1">winx </span><span class="s3">= </span><span class="s1">winx </span><span class="s3">// </span><span class="s1">div</span>
            <span class="s1">winy </span><span class="s3">= </span><span class="s1">winy </span><span class="s3">// </span><span class="s1">div</span>

        <span class="s2">if </span><span class="s1">mul </span><span class="s3">!= </span><span class="s5">1</span><span class="s3">:</span>
            <span class="s1">winx </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">round</span><span class="s3">(</span><span class="s1">winx </span><span class="s3">* </span><span class="s1">mul</span><span class="s3">))</span>
            <span class="s1">winy </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">round</span><span class="s3">(</span><span class="s1">winy </span><span class="s3">* </span><span class="s1">mul</span><span class="s3">))</span>

        <span class="s2">return </span><span class="s1">winx</span><span class="s3">,</span><span class="s1">winy</span>

    <span class="s2">def </span><span class="s1">renderSceneInto</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">depthtex</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">colortex</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">auxtex</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">auxbits</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">textures</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">fbprops</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">clamping</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>

        <span class="s0">&quot;&quot;&quot; Causes the scene to be rendered into the supplied textures 
        instead of into the original window.  Puts a fullscreen quad 
        into the original window to show the render-to-texture results. 
        Returns the quad.  Normally, the caller would then apply a 
        shader to the quad. 
 
        To elaborate on how this all works: 
 
        * An offscreen buffer is created.  It is set up to mimic 
          the original display region - it is the same size, 
          uses the same clear colors, and contains a DisplayRegion 
          that uses the original camera. 
 
        * A fullscreen quad and an orthographic camera to render 
          that quad are both created.  The original camera is 
          removed from the original window, and in its place, the 
          orthographic quad-camera is installed. 
 
        * The fullscreen quad is textured with the data from the 
          offscreen buffer.  A shader is applied that tints the 
          results pink. 
 
        * Automatic shader generation NOT enabled. 
          If you have a filter that depends on a render target from 
          the auto-shader, you either need to set an auto-shader 
          attrib on the main camera or scene, or, you need to provide 
          these outputs in your own shader. 
 
        * All clears are disabled on the original display region. 
          If the display region fills the whole window, then clears 
          are disabled on the original window as well.  It is 
          assumed that rendering the full-screen quad eliminates 
          the need to do clears. 
 
        Hence, the original window which used to contain the actual 
        scene, now contains a pink-tinted quad with a texture of the 
        scene.  It is assumed that the user will replace the shader 
        on the quad with a more interesting filter. &quot;&quot;&quot;</span>

        <span class="s2">if </span><span class="s3">(</span><span class="s1">textures</span><span class="s3">):</span>
            <span class="s1">colortex </span><span class="s3">= </span><span class="s1">textures</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;color&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
            <span class="s1">depthtex </span><span class="s3">= </span><span class="s1">textures</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;depth&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
            <span class="s1">auxtex </span><span class="s3">= </span><span class="s1">textures</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;aux&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
            <span class="s1">auxtex0 </span><span class="s3">= </span><span class="s1">textures</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;aux0&quot;</span><span class="s3">, </span><span class="s1">auxtex</span><span class="s3">)</span>
            <span class="s1">auxtex1 </span><span class="s3">= </span><span class="s1">textures</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;aux1&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">auxtex0 </span><span class="s3">= </span><span class="s1">auxtex</span>
            <span class="s1">auxtex1 </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s2">if </span><span class="s3">(</span><span class="s1">colortex </span><span class="s3">== </span><span class="s2">None</span><span class="s3">):</span>
            <span class="s1">colortex </span><span class="s3">= </span><span class="s1">Texture</span><span class="s3">(</span><span class="s4">&quot;filter-base-color&quot;</span><span class="s3">)</span>
            <span class="s1">colortex</span><span class="s3">.</span><span class="s1">setWrapU</span><span class="s3">(</span><span class="s1">Texture</span><span class="s3">.</span><span class="s1">WMClamp</span><span class="s3">)</span>
            <span class="s1">colortex</span><span class="s3">.</span><span class="s1">setWrapV</span><span class="s3">(</span><span class="s1">Texture</span><span class="s3">.</span><span class="s1">WMClamp</span><span class="s3">)</span>

        <span class="s1">texgroup </span><span class="s3">= (</span><span class="s1">depthtex</span><span class="s3">, </span><span class="s1">colortex</span><span class="s3">, </span><span class="s1">auxtex0</span><span class="s3">, </span><span class="s1">auxtex1</span><span class="s3">)</span>

        <span class="s6"># Choose the size of the offscreen buffer.</span>

        <span class="s3">(</span><span class="s1">winx</span><span class="s3">, </span><span class="s1">winy</span><span class="s3">) = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getScaledSize</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">1</span><span class="s3">,</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">fbprops </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">buffer </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">createBuffer</span><span class="s3">(</span><span class="s4">&quot;filter-base&quot;</span><span class="s3">, </span><span class="s1">winx</span><span class="s3">, </span><span class="s1">winy</span><span class="s3">, </span><span class="s1">texgroup</span><span class="s3">, </span><span class="s1">fbprops</span><span class="s3">=</span><span class="s1">fbprops</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">buffer </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">createBuffer</span><span class="s3">(</span><span class="s4">&quot;filter-base&quot;</span><span class="s3">, </span><span class="s1">winx</span><span class="s3">, </span><span class="s1">winy</span><span class="s3">, </span><span class="s1">texgroup</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s3">(</span><span class="s1">buffer </span><span class="s3">== </span><span class="s2">None</span><span class="s3">):</span>
            <span class="s2">return None</span>

        <span class="s1">cm </span><span class="s3">= </span><span class="s1">CardMaker</span><span class="s3">(</span><span class="s4">&quot;filter-base-quad&quot;</span><span class="s3">)</span>
        <span class="s1">cm</span><span class="s3">.</span><span class="s1">setFrameFullscreenQuad</span><span class="s3">()</span>
        <span class="s1">quad </span><span class="s3">= </span><span class="s1">NodePath</span><span class="s3">(</span><span class="s1">cm</span><span class="s3">.</span><span class="s1">generate</span><span class="s3">())</span>
        <span class="s1">quad</span><span class="s3">.</span><span class="s1">setDepthTest</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">quad</span><span class="s3">.</span><span class="s1">setDepthWrite</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">quad</span><span class="s3">.</span><span class="s1">setTexture</span><span class="s3">(</span><span class="s1">colortex</span><span class="s3">)</span>
        <span class="s1">quad</span><span class="s3">.</span><span class="s1">setColor</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

        <span class="s1">cs </span><span class="s3">= </span><span class="s1">NodePath</span><span class="s3">(</span><span class="s4">&quot;dummy&quot;</span><span class="s3">)</span>
        <span class="s1">cs</span><span class="s3">.</span><span class="s1">setState</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">camstate</span><span class="s3">)</span>
        <span class="s6"># Do we really need to turn on the Shader Generator?</span>
        <span class="s6">#cs.setShaderAuto()</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">auxbits</span><span class="s3">):</span>
            <span class="s1">cs</span><span class="s3">.</span><span class="s1">setAttrib</span><span class="s3">(</span><span class="s1">AuxBitplaneAttrib</span><span class="s3">.</span><span class="s1">make</span><span class="s3">(</span><span class="s1">auxbits</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">clamping </span><span class="s2">is False</span><span class="s3">:</span>
            <span class="s6"># Disables clamping in the shader generator.</span>
            <span class="s1">cs</span><span class="s3">.</span><span class="s1">setAttrib</span><span class="s3">(</span><span class="s1">LightRampAttrib</span><span class="s3">.</span><span class="s1">make_identity</span><span class="s3">())</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">camera</span><span class="s3">.</span><span class="s1">node</span><span class="s3">().</span><span class="s1">setInitialState</span><span class="s3">(</span><span class="s1">cs</span><span class="s3">.</span><span class="s1">getState</span><span class="s3">())</span>

        <span class="s1">quadcamnode </span><span class="s3">= </span><span class="s1">Camera</span><span class="s3">(</span><span class="s4">&quot;filter-quad-cam&quot;</span><span class="s3">)</span>
        <span class="s1">lens </span><span class="s3">= </span><span class="s1">OrthographicLens</span><span class="s3">()</span>
        <span class="s1">lens</span><span class="s3">.</span><span class="s1">setFilmSize</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">lens</span><span class="s3">.</span><span class="s1">setFilmOffset</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">lens</span><span class="s3">.</span><span class="s1">setNearFar</span><span class="s3">(-</span><span class="s5">1000</span><span class="s3">, </span><span class="s5">1000</span><span class="s3">)</span>
        <span class="s1">quadcamnode</span><span class="s3">.</span><span class="s1">setLens</span><span class="s3">(</span><span class="s1">lens</span><span class="s3">)</span>
        <span class="s1">quadcam </span><span class="s3">= </span><span class="s1">quad</span><span class="s3">.</span><span class="s1">attachNewNode</span><span class="s3">(</span><span class="s1">quadcamnode</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">region</span><span class="s3">.</span><span class="s1">setCamera</span><span class="s3">(</span><span class="s1">quadcam</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">setStackedClears</span><span class="s3">(</span><span class="s1">buffer</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rclears</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wclears</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">auxtex0</span><span class="s3">):</span>
            <span class="s1">buffer</span><span class="s3">.</span><span class="s1">setClearActive</span><span class="s3">(</span><span class="s1">GraphicsOutput</span><span class="s3">.</span><span class="s1">RTPAuxRgba0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
            <span class="s1">buffer</span><span class="s3">.</span><span class="s1">setClearValue</span><span class="s3">(</span><span class="s1">GraphicsOutput</span><span class="s3">.</span><span class="s1">RTPAuxRgba0</span><span class="s3">, (</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">auxtex1</span><span class="s3">):</span>
            <span class="s1">buffer</span><span class="s3">.</span><span class="s1">setClearActive</span><span class="s3">(</span><span class="s1">GraphicsOutput</span><span class="s3">.</span><span class="s1">RTPAuxRgba1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">region</span><span class="s3">.</span><span class="s1">disableClears</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">isFullscreen</span><span class="s3">()):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">win</span><span class="s3">.</span><span class="s1">disableClears</span><span class="s3">()</span>

        <span class="s1">dr </span><span class="s3">= </span><span class="s1">buffer</span><span class="s3">.</span><span class="s1">makeDisplayRegion</span><span class="s3">()</span>
        <span class="s1">dr</span><span class="s3">.</span><span class="s1">disableClears</span><span class="s3">()</span>
        <span class="s1">dr</span><span class="s3">.</span><span class="s1">setCamera</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">camera</span><span class="s3">)</span>
        <span class="s1">dr</span><span class="s3">.</span><span class="s1">setActive</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">buffers</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">buffer</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">))</span>

        <span class="s2">return </span><span class="s1">quad</span>

    <span class="s2">def </span><span class="s1">renderQuadInto</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;filter-stage&quot;</span><span class="s3">, </span><span class="s1">mul</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">div</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">align</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">depthtex</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">colortex</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">auxtex0</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">auxtex1</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">fbprops</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>

        <span class="s0">&quot;&quot;&quot; Creates an offscreen buffer for an intermediate 
        computation. Installs a quad into the buffer.  Returns 
        the fullscreen quad.  The size of the buffer is initially 
        equal to the size of the main window.  The parameters 'mul', 
        'div', and 'align' can be used to adjust that size. &quot;&quot;&quot;</span>

        <span class="s1">texgroup </span><span class="s3">= (</span><span class="s1">depthtex</span><span class="s3">, </span><span class="s1">colortex</span><span class="s3">, </span><span class="s1">auxtex0</span><span class="s3">, </span><span class="s1">auxtex1</span><span class="s3">)</span>

        <span class="s1">winx</span><span class="s3">, </span><span class="s1">winy </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getScaledSize</span><span class="s3">(</span><span class="s1">mul</span><span class="s3">, </span><span class="s1">div</span><span class="s3">, </span><span class="s1">align</span><span class="s3">)</span>

        <span class="s1">depthbits </span><span class="s3">= </span><span class="s1">bool</span><span class="s3">(</span><span class="s1">depthtex </span><span class="s3">!= </span><span class="s2">None</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">fbprops </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">buffer </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">createBuffer</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">winx</span><span class="s3">, </span><span class="s1">winy</span><span class="s3">, </span><span class="s1">texgroup</span><span class="s3">, </span><span class="s1">depthbits</span><span class="s3">, </span><span class="s1">fbprops</span><span class="s3">=</span><span class="s1">fbprops</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">buffer </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">createBuffer</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">winx</span><span class="s3">, </span><span class="s1">winy</span><span class="s3">, </span><span class="s1">texgroup</span><span class="s3">, </span><span class="s1">depthbits</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s3">(</span><span class="s1">buffer </span><span class="s3">== </span><span class="s2">None</span><span class="s3">):</span>
            <span class="s2">return None</span>

        <span class="s1">cm </span><span class="s3">= </span><span class="s1">CardMaker</span><span class="s3">(</span><span class="s4">&quot;filter-stage-quad&quot;</span><span class="s3">)</span>
        <span class="s1">cm</span><span class="s3">.</span><span class="s1">setFrameFullscreenQuad</span><span class="s3">()</span>
        <span class="s1">quad </span><span class="s3">= </span><span class="s1">NodePath</span><span class="s3">(</span><span class="s1">cm</span><span class="s3">.</span><span class="s1">generate</span><span class="s3">())</span>
        <span class="s1">quad</span><span class="s3">.</span><span class="s1">setDepthTest</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">quad</span><span class="s3">.</span><span class="s1">setDepthWrite</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">quad</span><span class="s3">.</span><span class="s1">setColor</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

        <span class="s1">quadcamnode </span><span class="s3">= </span><span class="s1">Camera</span><span class="s3">(</span><span class="s4">&quot;filter-quad-cam&quot;</span><span class="s3">)</span>
        <span class="s1">lens </span><span class="s3">= </span><span class="s1">OrthographicLens</span><span class="s3">()</span>
        <span class="s1">lens</span><span class="s3">.</span><span class="s1">setFilmSize</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">lens</span><span class="s3">.</span><span class="s1">setFilmOffset</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">lens</span><span class="s3">.</span><span class="s1">setNearFar</span><span class="s3">(-</span><span class="s5">1000</span><span class="s3">, </span><span class="s5">1000</span><span class="s3">)</span>
        <span class="s1">quadcamnode</span><span class="s3">.</span><span class="s1">setLens</span><span class="s3">(</span><span class="s1">lens</span><span class="s3">)</span>
        <span class="s1">quadcam </span><span class="s3">= </span><span class="s1">quad</span><span class="s3">.</span><span class="s1">attachNewNode</span><span class="s3">(</span><span class="s1">quadcamnode</span><span class="s3">)</span>

        <span class="s1">dr </span><span class="s3">= </span><span class="s1">buffer</span><span class="s3">.</span><span class="s1">makeDisplayRegion</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">dr</span><span class="s3">.</span><span class="s1">disableClears</span><span class="s3">()</span>
        <span class="s1">dr</span><span class="s3">.</span><span class="s1">setCamera</span><span class="s3">(</span><span class="s1">quadcam</span><span class="s3">)</span>
        <span class="s1">dr</span><span class="s3">.</span><span class="s1">setActive</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">dr</span><span class="s3">.</span><span class="s1">setScissorEnabled</span><span class="s3">(</span><span class="s2">False</span><span class="s3">)</span>

        <span class="s6"># This clear stage is important if the buffer is padded, so that</span>
        <span class="s6"># any pixels accidentally sampled in the padded region won't</span>
        <span class="s6"># be reading from unititialised memory.</span>
        <span class="s1">buffer</span><span class="s3">.</span><span class="s1">setClearColor</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">buffer</span><span class="s3">.</span><span class="s1">setClearColorActive</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">buffers</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">buffer</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">mul</span><span class="s3">, </span><span class="s1">div</span><span class="s3">, </span><span class="s1">align</span><span class="s3">))</span>

        <span class="s2">return </span><span class="s1">quad</span>

    <span class="s2">def </span><span class="s1">createBuffer</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">xsize</span><span class="s3">, </span><span class="s1">ysize</span><span class="s3">, </span><span class="s1">texgroup</span><span class="s3">, </span><span class="s1">depthbits</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">fbprops</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Low-level buffer creation.  Not intended for public use. &quot;&quot;&quot;</span>

        <span class="s1">winprops </span><span class="s3">= </span><span class="s1">WindowProperties</span><span class="s3">()</span>
        <span class="s1">winprops</span><span class="s3">.</span><span class="s1">setSize</span><span class="s3">(</span><span class="s1">xsize</span><span class="s3">, </span><span class="s1">ysize</span><span class="s3">)</span>
        <span class="s1">props </span><span class="s3">= </span><span class="s1">FrameBufferProperties</span><span class="s3">(</span><span class="s1">FrameBufferProperties</span><span class="s3">.</span><span class="s1">getDefault</span><span class="s3">())</span>
        <span class="s1">props</span><span class="s3">.</span><span class="s1">setBackBuffers</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">props</span><span class="s3">.</span><span class="s1">setRgbColor</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">depthbits </span><span class="s2">is True</span><span class="s3">:</span>
            <span class="s6"># Respect depth-bits from Config.prc</span>
            <span class="s2">if </span><span class="s1">props</span><span class="s3">.</span><span class="s1">getDepthBits</span><span class="s3">() == </span><span class="s5">0</span><span class="s3">:</span>
                <span class="s1">props</span><span class="s3">.</span><span class="s1">setDepthBits</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">props</span><span class="s3">.</span><span class="s1">setDepthBits</span><span class="s3">(</span><span class="s1">depthbits</span><span class="s3">)</span>
        <span class="s1">props</span><span class="s3">.</span><span class="s1">setStereo</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">win</span><span class="s3">.</span><span class="s1">isStereo</span><span class="s3">())</span>
        <span class="s2">if </span><span class="s1">fbprops </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">props</span><span class="s3">.</span><span class="s1">addProperties</span><span class="s3">(</span><span class="s1">fbprops</span><span class="s3">)</span>

        <span class="s1">depthtex</span><span class="s3">, </span><span class="s1">colortex</span><span class="s3">, </span><span class="s1">auxtex0</span><span class="s3">, </span><span class="s1">auxtex1 </span><span class="s3">= </span><span class="s1">texgroup</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">auxtex0 </span><span class="s3">!= </span><span class="s2">None</span><span class="s3">):</span>
            <span class="s1">props</span><span class="s3">.</span><span class="s1">setAuxRgba</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">auxtex1 </span><span class="s3">!= </span><span class="s2">None</span><span class="s3">):</span>
            <span class="s1">props</span><span class="s3">.</span><span class="s1">setAuxRgba</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">buffer</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">engine</span><span class="s3">.</span><span class="s1">makeOutput</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">win</span><span class="s3">.</span><span class="s1">getPipe</span><span class="s3">(), </span><span class="s1">name</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">,</span>
            <span class="s1">props</span><span class="s3">, </span><span class="s1">winprops</span><span class="s3">, </span><span class="s1">GraphicsPipe</span><span class="s3">.</span><span class="s1">BFRefuseWindow </span><span class="s3">| </span><span class="s1">GraphicsPipe</span><span class="s3">.</span><span class="s1">BFResizeable</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">win</span><span class="s3">.</span><span class="s1">getGsg</span><span class="s3">(), </span><span class="s1">self</span><span class="s3">.</span><span class="s1">win</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">buffer </span><span class="s3">== </span><span class="s2">None</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">buffer</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">depthtex</span><span class="s3">):</span>
            <span class="s1">buffer</span><span class="s3">.</span><span class="s1">addRenderTexture</span><span class="s3">(</span><span class="s1">depthtex</span><span class="s3">, </span><span class="s1">GraphicsOutput</span><span class="s3">.</span><span class="s1">RTMBindOrCopy</span><span class="s3">, </span><span class="s1">GraphicsOutput</span><span class="s3">.</span><span class="s1">RTPDepth</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">colortex</span><span class="s3">):</span>
            <span class="s1">buffer</span><span class="s3">.</span><span class="s1">addRenderTexture</span><span class="s3">(</span><span class="s1">colortex</span><span class="s3">, </span><span class="s1">GraphicsOutput</span><span class="s3">.</span><span class="s1">RTMBindOrCopy</span><span class="s3">, </span><span class="s1">GraphicsOutput</span><span class="s3">.</span><span class="s1">RTPColor</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">auxtex0</span><span class="s3">):</span>
            <span class="s1">buffer</span><span class="s3">.</span><span class="s1">addRenderTexture</span><span class="s3">(</span><span class="s1">auxtex0</span><span class="s3">, </span><span class="s1">GraphicsOutput</span><span class="s3">.</span><span class="s1">RTMBindOrCopy</span><span class="s3">, </span><span class="s1">GraphicsOutput</span><span class="s3">.</span><span class="s1">RTPAuxRgba0</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">auxtex1</span><span class="s3">):</span>
            <span class="s1">buffer</span><span class="s3">.</span><span class="s1">addRenderTexture</span><span class="s3">(</span><span class="s1">auxtex1</span><span class="s3">, </span><span class="s1">GraphicsOutput</span><span class="s3">.</span><span class="s1">RTMBindOrCopy</span><span class="s3">, </span><span class="s1">GraphicsOutput</span><span class="s3">.</span><span class="s1">RTPAuxRgba1</span><span class="s3">)</span>
        <span class="s1">buffer</span><span class="s3">.</span><span class="s1">setSort</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">nextsort</span><span class="s3">)</span>
        <span class="s1">buffer</span><span class="s3">.</span><span class="s1">disableClears</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">nextsort </span><span class="s3">+= </span><span class="s5">1</span>
        <span class="s2">return </span><span class="s1">buffer</span>

    <span class="s2">def </span><span class="s1">windowEvent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">win</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; When the window changes size, automatically resize all buffers &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">resizeBuffers</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">resizeBuffers</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Resize all buffers to match the size of the window. &quot;&quot;&quot;</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">buffers</span><span class="s3">)):</span>
            <span class="s3">(</span><span class="s1">mul</span><span class="s3">, </span><span class="s1">div</span><span class="s3">, </span><span class="s1">align</span><span class="s3">) = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sizes</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
            <span class="s3">(</span><span class="s1">xsize</span><span class="s3">, </span><span class="s1">ysize</span><span class="s3">) = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getScaledSize</span><span class="s3">(</span><span class="s1">mul</span><span class="s3">, </span><span class="s1">div</span><span class="s3">, </span><span class="s1">align</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">buffers</span><span class="s3">[</span><span class="s1">i</span><span class="s3">].</span><span class="s1">setSize</span><span class="s3">(</span><span class="s1">xsize</span><span class="s3">, </span><span class="s1">ysize</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">cleanup</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Restore everything to its original state, deleting any 
        new buffers in the process. &quot;&quot;&quot;</span>

        <span class="s2">for </span><span class="s1">buffer </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">buffers</span><span class="s3">:</span>
            <span class="s1">buffer</span><span class="s3">.</span><span class="s1">clearRenderTextures</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">engine</span><span class="s3">.</span><span class="s1">removeWindow</span><span class="s3">(</span><span class="s1">buffer</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">buffers </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sizes </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setClears</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">win</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wclears</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setClears</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">region</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rclears</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">camstate </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">caminit</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">camera</span><span class="s3">.</span><span class="s1">node</span><span class="s3">().</span><span class="s1">setInitialState</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">caminit</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">region</span><span class="s3">.</span><span class="s1">setCamera</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">camera</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">region</span><span class="s3">, </span><span class="s4">'clearCullResult'</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">region</span><span class="s3">.</span><span class="s1">clearCullResult</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">nextsort </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">win</span><span class="s3">.</span><span class="s1">getSort</span><span class="s3">() - </span><span class="s5">1000</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">basex </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">basey </span><span class="s3">= </span><span class="s5">0</span>

    <span class="s6">#snake_case alias:</span>
    <span class="s1">is_fullscreen </span><span class="s3">= </span><span class="s1">isFullscreen</span>
    <span class="s1">resize_buffers </span><span class="s3">= </span><span class="s1">resizeBuffers</span>
    <span class="s1">set_stacked_clears </span><span class="s3">= </span><span class="s1">setStackedClears</span>
    <span class="s1">render_scene_into </span><span class="s3">= </span><span class="s1">renderSceneInto</span>
    <span class="s1">get_scaled_size </span><span class="s3">= </span><span class="s1">getScaledSize</span>
    <span class="s1">render_quad_into </span><span class="s3">= </span><span class="s1">renderQuadInto</span>
    <span class="s1">get_clears </span><span class="s3">= </span><span class="s1">getClears</span>
    <span class="s1">set_clears </span><span class="s3">= </span><span class="s1">setClears</span>
    <span class="s1">create_buffer </span><span class="s3">= </span><span class="s1">createBuffer</span>
    <span class="s1">window_event </span><span class="s3">= </span><span class="s1">windowEvent</span>
</pre>
</body>
</html>