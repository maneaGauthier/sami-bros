<html>
<head>
<title>StatePush.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
StatePush.py</font>
</center></td></tr></table>
<pre><span class="s0"># classes for event-driven programming</span>
<span class="s0"># http://en.wikipedia.org/wiki/Event-driven_programming</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">'StateVar'</span><span class="s2">, </span><span class="s3">'FunctionCall'</span><span class="s2">, </span><span class="s3">'EnterExit'</span><span class="s2">, </span><span class="s3">'Pulse'</span><span class="s2">, </span><span class="s3">'EventPulse'</span><span class="s2">,</span>
           <span class="s3">'EventArgument'</span><span class="s2">, ]</span>

<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase</span><span class="s2">.</span><span class="s1">DirectObject </span><span class="s4">import </span><span class="s1">DirectObject</span>


<span class="s4">class </span><span class="s1">PushesStateChanges</span><span class="s2">:</span>
    <span class="s0"># base class for objects that broadcast state changes to a set of subscriber objects</span>
    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_value </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s0"># push state changes to these objects</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_subscribers </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_subscribers</span><span class="s2">) != </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">'%s object still has subscribers in destroy(): %s' </span><span class="s2">% (</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_subscribers</span><span class="s2">))</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_subscribers</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_value</span>

    <span class="s4">def </span><span class="s1">getState</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_value</span>

    <span class="s4">def </span><span class="s1">pushCurrentState</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_handleStateChange</span><span class="s2">()</span>
        <span class="s4">return </span><span class="s1">self</span>

    <span class="s4">def </span><span class="s1">_addSubscription</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">subscriber</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_subscribers</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">subscriber</span><span class="s2">)</span>
        <span class="s1">subscriber</span><span class="s2">.</span><span class="s1">_recvStatePush</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_removeSubscription</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">subscriber</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_subscribers</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">subscriber</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_handlePotentialStateChange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">oldValue </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_value </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s4">if </span><span class="s1">oldValue </span><span class="s2">!= </span><span class="s1">value</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_handleStateChange</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">_handleStateChange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0"># push this object's state to the subscribing objects</span>
        <span class="s4">for </span><span class="s1">subscriber </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_subscribers</span><span class="s2">:</span>
            <span class="s1">subscriber</span><span class="s2">.</span><span class="s1">_recvStatePush</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

<span class="s4">if __debug__</span><span class="s2">:</span>
    <span class="s1">psc </span><span class="s2">= </span><span class="s1">PushesStateChanges</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">psc</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">() == </span><span class="s5">0</span>
    <span class="s1">psc</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s4">del </span><span class="s1">psc</span>

<span class="s4">class </span><span class="s1">ReceivesStateChanges</span><span class="s2">:</span>
    <span class="s0"># base class for objects that subscribe to state changes from PushesStateChanges objects</span>
    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_source </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_initSource </span><span class="s2">= </span><span class="s1">source</span>

    <span class="s4">def </span><span class="s1">_finishInit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0"># initialization is split across two functions to allow objects that derive from this</span>
        <span class="s0"># class to set everything up so that they can respond appropriately to the initial</span>
        <span class="s0"># state push from the state source</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_subscribeTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_initSource</span><span class="s2">)</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_initSource</span>

    <span class="s4">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_unsubscribe</span><span class="s2">()</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_source</span>

    <span class="s4">def </span><span class="s1">_subscribeTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_unsubscribe</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_source </span><span class="s2">= </span><span class="s1">source</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_source</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_source</span><span class="s2">.</span><span class="s1">_addSubscription</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_unsubscribe</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_source</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_source</span><span class="s2">.</span><span class="s1">_removeSubscription</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_source </span><span class="s2">= </span><span class="s4">None</span>

    <span class="s4">def </span><span class="s1">_recvStatePush</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">):</span>
        <span class="s4">pass</span>

<span class="s4">if __debug__</span><span class="s2">:</span>
    <span class="s1">rsc </span><span class="s2">= </span><span class="s1">ReceivesStateChanges</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>
    <span class="s1">rsc</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s4">del </span><span class="s1">rsc</span>

<span class="s4">class </span><span class="s1">StateVar</span><span class="s2">(</span><span class="s1">PushesStateChanges</span><span class="s2">):</span>
    <span class="s0"># coder-friendly object that allows values to be set on it and pushes those values</span>
    <span class="s0"># as state changes</span>
    <span class="s4">def </span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">PushesStateChanges</span><span class="s2">.</span><span class="s1">_handlePotentialStateChange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">PushesStateChanges</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

<span class="s4">if __debug__</span><span class="s2">:</span>
    <span class="s1">sv </span><span class="s2">= </span><span class="s1">StateVar</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">sv</span><span class="s2">.</span><span class="s1">get</span><span class="s2">() == </span><span class="s5">0</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">sv</span><span class="s2">.</span><span class="s1">get</span><span class="s2">() == </span><span class="s5">1</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s4">del </span><span class="s1">sv</span>

<span class="s4">class </span><span class="s1">StateChangeNode</span><span class="s2">(</span><span class="s1">PushesStateChanges</span><span class="s2">, </span><span class="s1">ReceivesStateChanges</span><span class="s2">):</span>
    <span class="s0"># base class that can be used to create a state-change notification chain</span>
    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">):</span>
        <span class="s1">ReceivesStateChanges</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">)</span>
        <span class="s1">PushesStateChanges</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">())</span>
        <span class="s1">ReceivesStateChanges</span><span class="s2">.</span><span class="s1">_finishInit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">PushesStateChanges</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">ReceivesStateChanges</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_recvStatePush</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">):</span>
        <span class="s0"># got a state push, apply new state to self</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_handlePotentialStateChange</span><span class="s2">(</span><span class="s1">source</span><span class="s2">.</span><span class="s1">_value</span><span class="s2">)</span>

<span class="s4">if __debug__</span><span class="s2">:</span>
    <span class="s1">sv </span><span class="s2">= </span><span class="s1">StateVar</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">sv</span><span class="s2">.</span><span class="s1">get</span><span class="s2">() == </span><span class="s5">0</span>
    <span class="s1">scn </span><span class="s2">= </span><span class="s1">StateChangeNode</span><span class="s2">(</span><span class="s1">sv</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">scn</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">() == </span><span class="s5">0</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">sv</span><span class="s2">.</span><span class="s1">get</span><span class="s2">() == </span><span class="s5">1</span>
    <span class="s4">assert </span><span class="s1">scn</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">() == </span><span class="s5">1</span>
    <span class="s1">scn2 </span><span class="s2">= </span><span class="s1">StateChangeNode</span><span class="s2">(</span><span class="s1">scn</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">scn2</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">() == </span><span class="s5">1</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">scn2</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">() == </span><span class="s5">2</span>
    <span class="s1">scn3 </span><span class="s2">= </span><span class="s1">StateChangeNode</span><span class="s2">(</span><span class="s1">scn</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">scn3</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">() == </span><span class="s5">2</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">scn2</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">() == </span><span class="s5">3</span>
    <span class="s4">assert </span><span class="s1">scn3</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">() == </span><span class="s5">3</span>
    <span class="s1">scn3</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s1">scn2</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s1">scn</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s4">del </span><span class="s1">scn3</span>
    <span class="s4">del </span><span class="s1">scn2</span>
    <span class="s4">del </span><span class="s1">scn</span>
    <span class="s4">del </span><span class="s1">sv</span>

<span class="s4">class </span><span class="s1">ReceivesMultipleStateChanges</span><span class="s2">:</span>
    <span class="s0"># base class for objects that subscribe to state changes from multiple PushesStateChanges</span>
    <span class="s0"># objects</span>
    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_key2source </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_source2key </span><span class="s2">= {}</span>

    <span class="s4">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">keys </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_key2source</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
        <span class="s4">for </span><span class="s1">key </span><span class="s4">in </span><span class="s1">keys</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_unsubscribe</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_key2source</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_source2key</span>

    <span class="s4">def </span><span class="s1">_subscribeTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_unsubscribe</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_key2source</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">source</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_source2key</span><span class="s2">[</span><span class="s1">source</span><span class="s2">] = </span><span class="s1">key</span>
        <span class="s1">source</span><span class="s2">.</span><span class="s1">_addSubscription</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_unsubscribe</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">key </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_key2source</span><span class="s2">:</span>
            <span class="s1">source </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_key2source</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>
            <span class="s1">source</span><span class="s2">.</span><span class="s1">_removeSubscription</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_key2source</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>
            <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_source2key</span><span class="s2">[</span><span class="s1">source</span><span class="s2">]</span>

    <span class="s4">def </span><span class="s1">_recvStatePush</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_recvMultiStatePush</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_source2key</span><span class="s2">[</span><span class="s1">source</span><span class="s2">], </span><span class="s1">source</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_recvMultiStatePush</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">source</span><span class="s2">):</span>
        <span class="s4">pass</span>

<span class="s4">if __debug__</span><span class="s2">:</span>
    <span class="s1">rsc </span><span class="s2">= </span><span class="s1">ReceivesMultipleStateChanges</span><span class="s2">()</span>
    <span class="s1">sv </span><span class="s2">= </span><span class="s1">StateVar</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">sv2 </span><span class="s2">= </span><span class="s1">StateVar</span><span class="s2">(</span><span class="s3">'b'</span><span class="s2">)</span>
    <span class="s1">rsc</span><span class="s2">.</span><span class="s1">_subscribeTo</span><span class="s2">(</span><span class="s1">sv</span><span class="s2">, </span><span class="s3">'a'</span><span class="s2">)</span>
    <span class="s1">rsc</span><span class="s2">.</span><span class="s1">_subscribeTo</span><span class="s2">(</span><span class="s1">sv2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">rsc</span><span class="s2">.</span><span class="s1">_unsubscribe</span><span class="s2">(</span><span class="s3">'a'</span><span class="s2">)</span>
    <span class="s1">rsc</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s4">del </span><span class="s1">rsc</span>

<span class="s4">class </span><span class="s1">FunctionCall</span><span class="s2">(</span><span class="s1">ReceivesMultipleStateChanges</span><span class="s2">, </span><span class="s1">PushesStateChanges</span><span class="s2">):</span>
    <span class="s0"># calls func with provided args whenever arguments' state changes</span>
    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kArgs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_initialized </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">ReceivesMultipleStateChanges</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">PushesStateChanges</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_func </span><span class="s2">= </span><span class="s1">func</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_args </span><span class="s2">= </span><span class="s1">args</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_kArgs </span><span class="s2">= </span><span class="s1">kArgs</span>
        <span class="s0"># keep a copy of the arguments ready to go, already filled in with</span>
        <span class="s0"># the value of arguments that push state</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_bakedArgs </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_bakedKargs </span><span class="s2">= {}</span>
        <span class="s4">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">arg </span><span class="s4">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">):</span>
            <span class="s1">key </span><span class="s2">= </span><span class="s1">i</span>
            <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">PushesStateChanges</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_bakedArgs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">())</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_subscribeTo</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">key</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_bakedArgs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
        <span class="s4">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">arg </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_kArgs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">PushesStateChanges</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_bakedKargs</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">arg</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_subscribeTo</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">key</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_bakedKargs</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">arg</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_initialized </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s0"># call pushCurrentState() instead</span>
        <span class="s0">## push the current state to any listeners</span>
        <span class="s0">##self._handleStateChange()</span>

    <span class="s4">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ReceivesMultipleStateChanges</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">PushesStateChanges</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_func</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_args</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_kArgs</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bakedArgs</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bakedKargs</span>

    <span class="s4">def </span><span class="s1">getState</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0"># for any state recievers that are hooked up to us, they get a tuple</span>
        <span class="s0"># of (tuple(positional argument values), dict(keyword argument name-&gt;value))</span>
        <span class="s4">return </span><span class="s2">(</span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bakedArgs</span><span class="s2">), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bakedKargs</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">_recvMultiStatePush</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">source</span><span class="s2">):</span>
        <span class="s0"># one of the arguments changed</span>
        <span class="s0"># pick up the new value</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_bakedKargs</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">source</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">()</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_bakedArgs</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">source</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">()</span>
        <span class="s0"># and send it out</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_handlePotentialStateChange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">())</span>

    <span class="s4">def </span><span class="s1">_handleStateChange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_initialized</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_func</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bakedArgs</span><span class="s2">, **</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bakedKargs</span><span class="s2">)</span>
            <span class="s1">PushesStateChanges</span><span class="s2">.</span><span class="s1">_handleStateChange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

<span class="s4">if __debug__</span><span class="s2">:</span>
    <span class="s1">l </span><span class="s2">= []</span>
    <span class="s4">def </span><span class="s1">handler</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">l</span><span class="s2">=</span><span class="s1">l</span><span class="s2">):</span>
        <span class="s1">l</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== []</span>
    <span class="s1">sv </span><span class="s2">= </span><span class="s1">StateVar</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">fc </span><span class="s2">= </span><span class="s1">FunctionCall</span><span class="s2">(</span><span class="s1">handler</span><span class="s2">, </span><span class="s1">sv</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== []</span>
    <span class="s1">fc</span><span class="s2">.</span><span class="s1">pushCurrentState</span><span class="s2">()</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== [</span><span class="s5">0</span><span class="s2">,]</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== [</span><span class="s5">0</span><span class="s2">,</span><span class="s5">1</span><span class="s2">,]</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== [</span><span class="s5">0</span><span class="s2">,</span><span class="s5">1</span><span class="s2">,</span><span class="s5">2</span><span class="s2">,]</span>
    <span class="s1">fc</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s4">del </span><span class="s1">fc</span>
    <span class="s4">del </span><span class="s1">sv</span>
    <span class="s4">del </span><span class="s1">handler</span>
    <span class="s4">del </span><span class="s1">l</span>

    <span class="s1">l </span><span class="s2">= []</span>
    <span class="s4">def </span><span class="s1">handler</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">kDummy</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">kValue</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">l</span><span class="s2">=</span><span class="s1">l</span><span class="s2">):</span>
        <span class="s1">l</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">value</span><span class="s2">, </span><span class="s1">kValue</span><span class="s2">))</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== []</span>
    <span class="s1">sv </span><span class="s2">= </span><span class="s1">StateVar</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">ksv </span><span class="s2">= </span><span class="s1">StateVar</span><span class="s2">(</span><span class="s3">'a'</span><span class="s2">)</span>
    <span class="s1">fc </span><span class="s2">= </span><span class="s1">FunctionCall</span><span class="s2">(</span><span class="s1">handler</span><span class="s2">, </span><span class="s1">sv</span><span class="s2">, </span><span class="s1">kValue</span><span class="s2">=</span><span class="s1">ksv</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== []</span>
    <span class="s1">fc</span><span class="s2">.</span><span class="s1">pushCurrentState</span><span class="s2">()</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== [(</span><span class="s5">0</span><span class="s2">,</span><span class="s3">'a'</span><span class="s2">,),]</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== [(</span><span class="s5">0</span><span class="s2">,</span><span class="s3">'a'</span><span class="s2">),(</span><span class="s5">1</span><span class="s2">,</span><span class="s3">'a'</span><span class="s2">),]</span>
    <span class="s1">ksv</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s3">'b'</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== [(</span><span class="s5">0</span><span class="s2">,</span><span class="s3">'a'</span><span class="s2">),(</span><span class="s5">1</span><span class="s2">,</span><span class="s3">'a'</span><span class="s2">),(</span><span class="s5">1</span><span class="s2">,</span><span class="s3">'b'</span><span class="s2">),]</span>
    <span class="s1">fc</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s4">del </span><span class="s1">fc</span>
    <span class="s4">del </span><span class="s1">sv</span>
    <span class="s4">del </span><span class="s1">handler</span>
    <span class="s4">del </span><span class="s1">l</span>

<span class="s4">class </span><span class="s1">EnterExit</span><span class="s2">(</span><span class="s1">StateChangeNode</span><span class="s2">):</span>
    <span class="s0"># call enterFunc when our state becomes true, exitFunc when it becomes false</span>
    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">, </span><span class="s1">enterFunc</span><span class="s2">, </span><span class="s1">exitFunc</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_enterFunc </span><span class="s2">= </span><span class="s1">enterFunc</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_exitFunc </span><span class="s2">= </span><span class="s1">exitFunc</span>
        <span class="s1">StateChangeNode</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">StateChangeNode</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_exitFunc</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_enterFunc</span>

    <span class="s4">def </span><span class="s1">_handlePotentialStateChange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0"># convert the incoming state as a bool</span>
        <span class="s1">StateChangeNode</span><span class="s2">.</span><span class="s1">_handlePotentialStateChange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">value</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">_handleStateChange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_value</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_enterFunc</span><span class="s2">()</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_exitFunc</span><span class="s2">()</span>
        <span class="s1">StateChangeNode</span><span class="s2">.</span><span class="s1">_handleStateChange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

<span class="s4">if __debug__</span><span class="s2">:</span>
    <span class="s1">l </span><span class="s2">= []</span>
    <span class="s4">def </span><span class="s1">enter</span><span class="s2">(</span><span class="s1">l</span><span class="s2">=</span><span class="s1">l</span><span class="s2">):</span>
        <span class="s1">l</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s4">def </span><span class="s1">exit</span><span class="s2">(</span><span class="s1">l</span><span class="s2">=</span><span class="s1">l</span><span class="s2">):</span>
        <span class="s1">l</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">sv </span><span class="s2">= </span><span class="s1">StateVar</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">ee </span><span class="s2">= </span><span class="s1">EnterExit</span><span class="s2">(</span><span class="s1">sv</span><span class="s2">, </span><span class="s1">enter</span><span class="s2">, </span><span class="s1">exit</span><span class="s2">)</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== []</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== [</span><span class="s5">1</span><span class="s2">,]</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== [</span><span class="s5">1</span><span class="s2">,]</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== [</span><span class="s5">1</span><span class="s2">,</span><span class="s5">0</span><span class="s2">,]</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== [</span><span class="s5">1</span><span class="s2">,</span><span class="s5">0</span><span class="s2">,</span><span class="s5">1</span><span class="s2">,]</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== [</span><span class="s5">1</span><span class="s2">,</span><span class="s5">0</span><span class="s2">,</span><span class="s5">1</span><span class="s2">,</span><span class="s5">0</span><span class="s2">,]</span>
    <span class="s1">ee</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s1">sv</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s4">del </span><span class="s1">ee</span>
    <span class="s4">del </span><span class="s1">sv</span>
    <span class="s4">del </span><span class="s1">enter</span>
    <span class="s4">del </span><span class="s1">exit</span>
    <span class="s4">del </span><span class="s1">l</span>

<span class="s4">class </span><span class="s1">Pulse</span><span class="s2">(</span><span class="s1">PushesStateChanges</span><span class="s2">):</span>
    <span class="s0"># changes state to True then immediately to False whenever sendPulse is called</span>
    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">PushesStateChanges</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">False</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">sendPulse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_handlePotentialStateChange</span><span class="s2">(</span><span class="s4">True</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_handlePotentialStateChange</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>

<span class="s4">if __debug__</span><span class="s2">:</span>
    <span class="s1">l </span><span class="s2">= []</span>
    <span class="s4">def </span><span class="s1">handler</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">l</span><span class="s2">=</span><span class="s1">l</span><span class="s2">):</span>
        <span class="s1">l</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s1">Pulse</span><span class="s2">()</span>
    <span class="s1">fc </span><span class="s2">= </span><span class="s1">FunctionCall</span><span class="s2">(</span><span class="s1">handler</span><span class="s2">, </span><span class="s1">p</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== []</span>
    <span class="s1">fc</span><span class="s2">.</span><span class="s1">pushCurrentState</span><span class="s2">()</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== [</span><span class="s4">False</span><span class="s2">, ]</span>
    <span class="s1">p</span><span class="s2">.</span><span class="s1">sendPulse</span><span class="s2">()</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== [</span><span class="s4">False</span><span class="s2">, </span><span class="s4">True</span><span class="s2">, </span><span class="s4">False</span><span class="s2">, ]</span>
    <span class="s1">p</span><span class="s2">.</span><span class="s1">sendPulse</span><span class="s2">()</span>
    <span class="s4">assert </span><span class="s1">l </span><span class="s2">== [</span><span class="s4">False</span><span class="s2">, </span><span class="s4">True</span><span class="s2">, </span><span class="s4">False</span><span class="s2">, </span><span class="s4">True</span><span class="s2">, </span><span class="s4">False</span><span class="s2">, ]</span>
    <span class="s1">fc</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s1">p</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s4">del </span><span class="s1">fc</span>
    <span class="s4">del </span><span class="s1">p</span>
    <span class="s4">del </span><span class="s1">l</span>
    <span class="s4">del </span><span class="s1">handler</span>

<span class="s4">class </span><span class="s1">EventPulse</span><span class="s2">(</span><span class="s1">Pulse</span><span class="s2">, </span><span class="s1">DirectObject</span><span class="s2">):</span>
    <span class="s0"># sends a True-False &quot;pulse&quot; whenever a specific messenger message is sent</span>
    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">):</span>
        <span class="s1">Pulse</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">(</span><span class="s1">event</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sendPulse</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreAll</span><span class="s2">()</span>
        <span class="s1">Pulse</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

<span class="s4">class </span><span class="s1">EventArgument</span><span class="s2">(</span><span class="s1">PushesStateChanges</span><span class="s2">, </span><span class="s1">DirectObject</span><span class="s2">):</span>
    <span class="s0"># tracks a particular argument to a particular messenger event</span>
    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s5">0</span><span class="s2">):</span>
        <span class="s1">PushesStateChanges</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_index </span><span class="s2">= </span><span class="s1">index</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">(</span><span class="s1">event</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_handleEvent</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreAll</span><span class="s2">()</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span>
        <span class="s1">PushesStateChanges</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_handleEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_handlePotentialStateChange</span><span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index</span><span class="s2">])</span>

<span class="s4">class </span><span class="s1">AttrSetter</span><span class="s2">(</span><span class="s1">StateChangeNode</span><span class="s2">):</span>
    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">, </span><span class="s1">object</span><span class="s2">, </span><span class="s1">attrName</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_object </span><span class="s2">= </span><span class="s1">object</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_attrName </span><span class="s2">= </span><span class="s1">attrName</span>
        <span class="s1">StateChangeNode</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_handleStateChange</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">_handleStateChange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">setattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_object</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_attrName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_value</span><span class="s2">)</span>
        <span class="s1">StateChangeNode</span><span class="s2">.</span><span class="s1">_handleStateChange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

<span class="s4">if __debug__</span><span class="s2">:</span>
    <span class="s1">o </span><span class="s2">= </span><span class="s1">ScratchPad</span><span class="s2">()</span>
    <span class="s1">svar </span><span class="s2">= </span><span class="s1">StateVar</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">aset </span><span class="s2">= </span><span class="s1">AttrSetter</span><span class="s2">(</span><span class="s1">svar</span><span class="s2">, </span><span class="s1">o</span><span class="s2">, </span><span class="s3">'testAttr'</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">o</span><span class="s2">, </span><span class="s3">'testAttr'</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">o</span><span class="s2">.</span><span class="s1">testAttr </span><span class="s2">== </span><span class="s5">0</span>
    <span class="s1">svar</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s3">'red'</span><span class="s2">)</span>
    <span class="s4">assert </span><span class="s1">o</span><span class="s2">.</span><span class="s1">testAttr </span><span class="s2">== </span><span class="s3">'red'</span>
    <span class="s1">aset</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s1">svar</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s1">o</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
    <span class="s4">del </span><span class="s1">aset</span>
    <span class="s4">del </span><span class="s1">svar</span>
    <span class="s4">del </span><span class="s1">o</span>
</pre>
</body>
</html>