<html>
<head>
<title>ClientRepository.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ClientRepository.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;ClientRepository module: contains the ClientRepository class&quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s3">.</span><span class="s1">ClientRepositoryBase </span><span class="s2">import </span><span class="s1">ClientRepositoryBase</span>
<span class="s2">from </span><span class="s1">direct</span><span class="s3">.</span><span class="s1">directnotify </span><span class="s2">import </span><span class="s1">DirectNotifyGlobal</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">MsgTypesCMU </span><span class="s2">import </span><span class="s3">*</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">PyDatagram </span><span class="s2">import </span><span class="s1">PyDatagram</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">PyDatagramIterator </span><span class="s2">import </span><span class="s1">PyDatagramIterator</span>
<span class="s2">from </span><span class="s1">panda3d</span><span class="s3">.</span><span class="s1">core </span><span class="s2">import </span><span class="s1">UniqueIdAllocator</span>


<span class="s2">class </span><span class="s1">ClientRepository</span><span class="s3">(</span><span class="s1">ClientRepositoryBase</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    This is the open-source ClientRepository as provided by CMU.  It 
    communicates with the ServerRepository in this same directory. 
 
    If you are looking for the VR Studio's implementation of the 
    client repository, look to OTPClientRepository (elsewhere). 
    &quot;&quot;&quot;</span>
    <span class="s1">notify </span><span class="s3">= </span><span class="s1">DirectNotifyGlobal</span><span class="s3">.</span><span class="s1">directNotify</span><span class="s3">.</span><span class="s1">newCategory</span><span class="s3">(</span><span class="s4">&quot;ClientRepository&quot;</span><span class="s3">)</span>

    <span class="s5"># This is required by DoCollectionManager, even though it's not</span>
    <span class="s5"># used by this implementation.</span>
    <span class="s1">GameGlobalsId </span><span class="s3">= </span><span class="s6">0</span>

    <span class="s1">doNotDeallocateChannel </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dcFileNames </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s1">dcSuffix </span><span class="s3">= </span><span class="s4">''</span><span class="s3">, </span><span class="s1">connectMethod </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
                 <span class="s1">threadedNet </span><span class="s3">= </span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">ClientRepositoryBase</span><span class="s3">.</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dcFileNames </span><span class="s3">= </span><span class="s1">dcFileNames</span><span class="s3">, </span><span class="s1">dcSuffix </span><span class="s3">= </span><span class="s1">dcSuffix</span><span class="s3">, </span><span class="s1">connectMethod </span><span class="s3">= </span><span class="s1">connectMethod</span><span class="s3">, </span><span class="s1">threadedNet </span><span class="s3">= </span><span class="s1">threadedNet</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">setHandleDatagramsInternally</span><span class="s3">(</span><span class="s2">False</span><span class="s3">)</span>

        <span class="s1">base</span><span class="s3">.</span><span class="s1">finalExitCallbacks</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">shutdown</span><span class="s3">)</span>

        <span class="s5"># The doId allocator.  The CMU LAN server may choose to</span>
        <span class="s5"># send us a block of doIds.  If it chooses to do so, then we</span>
        <span class="s5"># may create objects, using those doIds.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">doIdAllocator </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">doIdBase </span><span class="s3">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">doIdLast </span><span class="s3">= </span><span class="s6">0</span>

        <span class="s5"># The doIdBase of the client message currently being</span>
        <span class="s5"># processed.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">currentSenderId </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s5"># Explicitly-requested interest zones.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">interestZones </span><span class="s3">= []</span>

    <span class="s2">def </span><span class="s1">handleSetDoIdrange</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">di</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">doIdBase </span><span class="s3">= </span><span class="s1">di</span><span class="s3">.</span><span class="s1">getUint32</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">doIdLast </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">doIdBase </span><span class="s3">+ </span><span class="s1">di</span><span class="s3">.</span><span class="s1">getUint32</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">doIdAllocator </span><span class="s3">= </span><span class="s1">UniqueIdAllocator</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">doIdBase</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">doIdLast </span><span class="s3">- </span><span class="s6">1</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">ourChannel </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">doIdBase</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">createReady</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">createReady</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Now that we've got a doId range, we can safely generate new</span>
        <span class="s5"># distributed objects.</span>
        <span class="s1">messenger</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s4">'createReady'</span><span class="s3">, </span><span class="s1">taskChain </span><span class="s3">= </span><span class="s4">'default'</span><span class="s3">)</span>
        <span class="s1">messenger</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">uniqueName</span><span class="s3">(</span><span class="s4">'createReady'</span><span class="s3">), </span><span class="s1">taskChain </span><span class="s3">= </span><span class="s4">'default'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">handleRequestGenerates</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">di</span><span class="s3">):</span>
        <span class="s5"># When new clients join the zone of an object, they need to hear</span>
        <span class="s5"># about it, so we send out all of our information about objects in</span>
        <span class="s5"># that particular zone.</span>

        <span class="s1">zone </span><span class="s3">= </span><span class="s1">di</span><span class="s3">.</span><span class="s1">getUint32</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">obj </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">doId2do</span><span class="s3">.</span><span class="s1">values</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s1">obj</span><span class="s3">.</span><span class="s1">zoneId </span><span class="s3">== </span><span class="s1">zone</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">isLocalId</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">.</span><span class="s1">doId</span><span class="s3">)):</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">resendGenerate</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">resendGenerate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Sends the generate message again for an already-generated 
        object, presumably to inform any newly-arrived clients of this 
        object's current state. &quot;&quot;&quot;</span>

        <span class="s5"># get the list of &quot;ram&quot; fields that aren't</span>
        <span class="s5"># required.  These are fields whose values should</span>
        <span class="s5"># persist even if they haven't been received</span>
        <span class="s5"># lately, so we have to re-broadcast these values</span>
        <span class="s5"># in case the new client hasn't heard their latest</span>
        <span class="s5"># values.</span>
        <span class="s1">extraFields </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">.</span><span class="s1">dclass</span><span class="s3">.</span><span class="s1">getNumInheritedFields</span><span class="s3">()):</span>
            <span class="s1">field </span><span class="s3">= </span><span class="s1">obj</span><span class="s3">.</span><span class="s1">dclass</span><span class="s3">.</span><span class="s1">getInheritedField</span><span class="s3">(</span><span class="s1">i</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">field</span><span class="s3">.</span><span class="s1">hasKeyword</span><span class="s3">(</span><span class="s4">'broadcast'</span><span class="s3">) </span><span class="s2">and </span><span class="s1">field</span><span class="s3">.</span><span class="s1">hasKeyword</span><span class="s3">(</span><span class="s4">'ram'</span><span class="s3">) </span><span class="s2">and not </span><span class="s1">field</span><span class="s3">.</span><span class="s1">hasKeyword</span><span class="s3">(</span><span class="s4">'required'</span><span class="s3">):</span>
                <span class="s2">if </span><span class="s1">field</span><span class="s3">.</span><span class="s1">asMolecularField</span><span class="s3">():</span>
                    <span class="s5"># It's a molecular field; this means</span>
                    <span class="s5"># we have to pack the components.</span>
                    <span class="s5"># Fortunately, we'll find those</span>
                    <span class="s5"># separately through the iteration, so</span>
                    <span class="s5"># we can ignore this field itself.</span>
                    <span class="s2">continue</span>

                <span class="s1">extraFields</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">field</span><span class="s3">.</span><span class="s1">getName</span><span class="s3">())</span>

        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">formatGenerate</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">extraFields</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">handleGenerate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">di</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">currentSenderId </span><span class="s3">= </span><span class="s1">di</span><span class="s3">.</span><span class="s1">getUint32</span><span class="s3">()</span>
        <span class="s1">zoneId </span><span class="s3">= </span><span class="s1">di</span><span class="s3">.</span><span class="s1">getUint32</span><span class="s3">()</span>
        <span class="s1">classId </span><span class="s3">= </span><span class="s1">di</span><span class="s3">.</span><span class="s1">getUint16</span><span class="s3">()</span>
        <span class="s1">doId </span><span class="s3">= </span><span class="s1">di</span><span class="s3">.</span><span class="s1">getUint32</span><span class="s3">()</span>

        <span class="s5"># Look up the dclass</span>
        <span class="s1">dclass </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dclassesByNumber</span><span class="s3">[</span><span class="s1">classId</span><span class="s3">]</span>

        <span class="s1">distObj </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">doId2do</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">distObj </span><span class="s2">and </span><span class="s1">distObj</span><span class="s3">.</span><span class="s1">dclass </span><span class="s3">== </span><span class="s1">dclass</span><span class="s3">:</span>
            <span class="s5"># We've already got this object.  Probably this is just a</span>
            <span class="s5"># repeat-generate, synthesized for the benefit of someone</span>
            <span class="s5"># else who just entered the zone.  Accept the new updates,</span>
            <span class="s5"># but don't make a formal generate.</span>
            <span class="s2">assert</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">&quot;performing generate-update for %s %s&quot; </span><span class="s3">% (</span><span class="s1">dclass</span><span class="s3">.</span><span class="s1">getName</span><span class="s3">(), </span><span class="s1">doId</span><span class="s3">)))</span>
            <span class="s1">dclass</span><span class="s3">.</span><span class="s1">receiveUpdateBroadcastRequired</span><span class="s3">(</span><span class="s1">distObj</span><span class="s3">, </span><span class="s1">di</span><span class="s3">)</span>
            <span class="s1">dclass</span><span class="s3">.</span><span class="s1">receiveUpdateOther</span><span class="s3">(</span><span class="s1">distObj</span><span class="s3">, </span><span class="s1">di</span><span class="s3">)</span>
            <span class="s2">return</span>

        <span class="s2">assert</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">&quot;performing generate for %s %s&quot; </span><span class="s3">% (</span><span class="s1">dclass</span><span class="s3">.</span><span class="s1">getName</span><span class="s3">(), </span><span class="s1">doId</span><span class="s3">)))</span>
        <span class="s1">dclass</span><span class="s3">.</span><span class="s1">startGenerate</span><span class="s3">()</span>
        <span class="s5"># Create a new distributed object, and put it in the dictionary</span>
        <span class="s1">distObj </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">generateWithRequiredOtherFields</span><span class="s3">(</span><span class="s1">dclass</span><span class="s3">, </span><span class="s1">doId</span><span class="s3">, </span><span class="s1">di</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s1">zoneId</span><span class="s3">)</span>
        <span class="s1">dclass</span><span class="s3">.</span><span class="s1">stopGenerate</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">allocateDoId</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Returns a newly-allocated doId.  Call freeDoId() when the 
        object has been deleted. &quot;&quot;&quot;</span>

        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">doIdAllocator</span><span class="s3">.</span><span class="s1">allocate</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">reserveDoId</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">doId</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Removes the indicate doId from the available pool, as if 
        it had been explicitly allocated.  You may pass it to 
        freeDoId() later if you wish. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">doIdAllocator</span><span class="s3">.</span><span class="s1">initialReserveId</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">doId</span>

    <span class="s2">def </span><span class="s1">freeDoId</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">doId</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Returns a doId back into the free pool for re-use. &quot;&quot;&quot;</span>

        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">isLocalId</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">doIdAllocator</span><span class="s3">.</span><span class="s1">free</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">storeObjectLocation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">object</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneId</span><span class="s3">):</span>
        <span class="s5"># The CMU implementation doesn't use the DoCollectionManager</span>
        <span class="s5"># much.</span>
        <span class="s1">object</span><span class="s3">.</span><span class="s1">parentId </span><span class="s3">= </span><span class="s1">parentId</span>
        <span class="s1">object</span><span class="s3">.</span><span class="s1">zoneId </span><span class="s3">= </span><span class="s1">zoneId</span>

    <span class="s2">def </span><span class="s1">createDistributedObject</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">className </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s1">distObj </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
                                <span class="s1">zoneId </span><span class="s3">= </span><span class="s6">0</span><span class="s3">, </span><span class="s1">optionalFields </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
                                <span class="s1">doId </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s1">reserveDoId </span><span class="s3">= </span><span class="s2">False</span><span class="s3">):</span>

        <span class="s0">&quot;&quot;&quot; To create a DistributedObject, you must pass in either the 
        name of the object's class, or an already-created instance of 
        the class (or both).  If you pass in just a class name (to the 
        className parameter), then a default instance of the object 
        will be created, with whatever parameters the default 
        constructor supplies.  Alternatively, if you wish to create 
        some initial values different from the default, you can create 
        the instance yourself and supply it to the distObj parameter, 
        then that instance will be used instead.  (It should be a 
        newly-created object, not one that has already been manifested 
        on the network or previously passed through 
        createDistributedObject.)  In either case, the new 
        DistributedObject is returned from this method. 
 
        This method will issue the appropriate network commands to 
        make this object appear on all of the other clients. 
 
        You should supply an initial zoneId in which to manifest the 
        object.  The fields marked &quot;required&quot; or &quot;ram&quot; will be 
        broadcast to all of the other clients; if you wish to 
        broadcast additional field values at this time as well, pass a 
        list of field names in the optionalFields parameters. 
 
        Normally, doId is None, to mean allocate a new doId for the 
        object.  If you wish to use a particular doId, pass it in 
        here.  If you also pass reserveDoId = True, this doId will be 
        reserved from the allocation pool using self.reserveDoId(). 
        You are responsible for ensuring this doId falls within the 
        client's allowable doId range and has not already been 
        assigned to another object.  &quot;&quot;&quot;</span>

        <span class="s2">if not </span><span class="s1">className</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">distObj</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">&quot;Must specify either a className or a distObj.&quot;</span><span class="s3">)</span>
            <span class="s1">className </span><span class="s3">= </span><span class="s1">distObj</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">.</span><span class="s1">__name__</span>

        <span class="s2">if </span><span class="s1">doId </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">doId </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">allocateDoId</span><span class="s3">()</span>
        <span class="s2">elif </span><span class="s1">reserveDoId</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">reserveDoId</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">)</span>

        <span class="s1">dclass </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dclassesByName</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">className</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">dclass</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">&quot;Unknown distributed class: %s&quot; </span><span class="s3">% (</span><span class="s1">distObj</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">))</span>
        <span class="s1">classDef </span><span class="s3">= </span><span class="s1">dclass</span><span class="s3">.</span><span class="s1">getClassDef</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">classDef </span><span class="s3">== </span><span class="s2">None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">&quot;Could not create an undefined %s object.&quot; </span><span class="s3">% (</span>
                <span class="s1">dclass</span><span class="s3">.</span><span class="s1">getName</span><span class="s3">()))</span>

        <span class="s2">if not </span><span class="s1">distObj</span><span class="s3">:</span>
            <span class="s1">distObj </span><span class="s3">= </span><span class="s1">classDef</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">distObj</span><span class="s3">, </span><span class="s1">classDef</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">&quot;Object %s is not an instance of %s&quot; </span><span class="s3">% (</span><span class="s1">distObj</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">, </span><span class="s1">classDef</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">))</span>

        <span class="s1">distObj</span><span class="s3">.</span><span class="s1">dclass </span><span class="s3">= </span><span class="s1">dclass</span>
        <span class="s1">distObj</span><span class="s3">.</span><span class="s1">doId </span><span class="s3">= </span><span class="s1">doId</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">doId2do</span><span class="s3">[</span><span class="s1">doId</span><span class="s3">] = </span><span class="s1">distObj</span>
        <span class="s1">distObj</span><span class="s3">.</span><span class="s1">generateInit</span><span class="s3">()</span>
        <span class="s1">distObj</span><span class="s3">.</span><span class="s1">_retrieveCachedData</span><span class="s3">()</span>
        <span class="s1">distObj</span><span class="s3">.</span><span class="s1">generate</span><span class="s3">()</span>
        <span class="s1">distObj</span><span class="s3">.</span><span class="s1">setLocation</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">zoneId</span><span class="s3">)</span>
        <span class="s1">distObj</span><span class="s3">.</span><span class="s1">announceGenerate</span><span class="s3">()</span>
        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">formatGenerate</span><span class="s3">(</span><span class="s1">distObj</span><span class="s3">, </span><span class="s1">optionalFields</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">distObj</span>

    <span class="s2">def </span><span class="s1">formatGenerate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">distObj</span><span class="s3">, </span><span class="s1">extraFields</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Returns a datagram formatted for sending the generate message for the indicated object. &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">distObj</span><span class="s3">.</span><span class="s1">dclass</span><span class="s3">.</span><span class="s1">clientFormatGenerateCMU</span><span class="s3">(</span><span class="s1">distObj</span><span class="s3">, </span><span class="s1">distObj</span><span class="s3">.</span><span class="s1">doId</span><span class="s3">, </span><span class="s1">distObj</span><span class="s3">.</span><span class="s1">zoneId</span><span class="s3">, </span><span class="s1">extraFields</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">sendDeleteMsg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">doId</span><span class="s3">):</span>
        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">PyDatagram</span><span class="s3">()</span>
        <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint16</span><span class="s3">(</span><span class="s1">OBJECT_DELETE_CMU</span><span class="s3">)</span>
        <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint32</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">sendDisconnect</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">isConnected</span><span class="s3">():</span>
            <span class="s5"># Tell the game server that we're going:</span>
            <span class="s1">datagram </span><span class="s3">= </span><span class="s1">PyDatagram</span><span class="s3">()</span>
            <span class="s5"># Add message type</span>
            <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint16</span><span class="s3">(</span><span class="s1">CLIENT_DISCONNECT_CMU</span><span class="s3">)</span>
            <span class="s5"># Send the message</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;Sent disconnect message to server&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">disconnect</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">stopHeartbeat</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">setInterestZones</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">interestZoneIds</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Changes the set of zones that this particular client is 
        interested in hearing about. &quot;&quot;&quot;</span>

        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">PyDatagram</span><span class="s3">()</span>
        <span class="s5"># Add message type</span>
        <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint16</span><span class="s3">(</span><span class="s1">CLIENT_SET_INTEREST_CMU</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">zoneId </span><span class="s2">in </span><span class="s1">interestZoneIds</span><span class="s3">:</span>
            <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint32</span><span class="s3">(</span><span class="s1">zoneId</span><span class="s3">)</span>

        <span class="s5"># send the message</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">interestZones </span><span class="s3">= </span><span class="s1">interestZoneIds</span><span class="s3">[:]</span>

    <span class="s2">def </span><span class="s1">setObjectZone</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">distObj</span><span class="s3">, </span><span class="s1">zoneId</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Moves the object into the indicated zone. &quot;&quot;&quot;</span>
        <span class="s1">distObj</span><span class="s3">.</span><span class="s1">b_setLocation</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">zoneId</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">distObj</span><span class="s3">.</span><span class="s1">zoneId </span><span class="s3">== </span><span class="s1">zoneId</span>

        <span class="s5"># Tell all of the clients monitoring the new zone that we've</span>
        <span class="s5"># arrived.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">resendGenerate</span><span class="s3">(</span><span class="s1">distObj</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">sendSetLocation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">doId</span><span class="s3">, </span><span class="s1">parentId</span><span class="s3">, </span><span class="s1">zoneId</span><span class="s3">):</span>
        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">PyDatagram</span><span class="s3">()</span>
        <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint16</span><span class="s3">(</span><span class="s1">OBJECT_SET_ZONE_CMU</span><span class="s3">)</span>
        <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint32</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">)</span>
        <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint32</span><span class="s3">(</span><span class="s1">zoneId</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">sendHeartbeat</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">PyDatagram</span><span class="s3">()</span>
        <span class="s5"># Add message type</span>
        <span class="s1">datagram</span><span class="s3">.</span><span class="s1">addUint16</span><span class="s3">(</span><span class="s1">CLIENT_HEARTBEAT_CMU</span><span class="s3">)</span>
        <span class="s5"># Send it!</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">lastHeartbeat </span><span class="s3">= </span><span class="s1">globalClock</span><span class="s3">.</span><span class="s1">getRealTime</span><span class="s3">()</span>
        <span class="s5"># This is important enough to consider flushing immediately</span>
        <span class="s5"># (particularly if we haven't run readerPollTask recently).</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">considerFlush</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">isLocalId</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">doId</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Returns true if this doId is one that we're the owner of, 
        false otherwise. &quot;&quot;&quot;</span>

        <span class="s2">return </span><span class="s3">((</span><span class="s1">doId </span><span class="s3">&gt;= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">doIdBase</span><span class="s3">) </span><span class="s2">and </span><span class="s3">(</span><span class="s1">doId </span><span class="s3">&lt; </span><span class="s1">self</span><span class="s3">.</span><span class="s1">doIdLast</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">haveCreateAuthority</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Returns true if this client has been assigned a range of 
        doId's it may use to create objects, false otherwise. &quot;&quot;&quot;</span>

        <span class="s2">return </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">doIdLast </span><span class="s3">&gt; </span><span class="s1">self</span><span class="s3">.</span><span class="s1">doIdBase</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">getAvatarIdFromSender</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Returns the doIdBase of the client that originally sent 
        the current update message.  This is only defined when 
        processing an update message or a generate message. &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">currentSenderId</span>

    <span class="s2">def </span><span class="s1">handleDatagram</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">di</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">getDebug</span><span class="s3">():</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;ClientRepository received datagram:&quot;</span><span class="s3">)</span>
            <span class="s1">di</span><span class="s3">.</span><span class="s1">getDatagram</span><span class="s3">().</span><span class="s1">dumpHex</span><span class="s3">(</span><span class="s1">ostream</span><span class="s3">)</span>

        <span class="s1">msgType </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getMsgType</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">currentSenderId </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s5"># These are the sort of messages we may expect from the public</span>
        <span class="s5"># Panda server.</span>

        <span class="s2">if </span><span class="s1">msgType </span><span class="s3">== </span><span class="s1">SET_DOID_RANGE_CMU</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">handleSetDoIdrange</span><span class="s3">(</span><span class="s1">di</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">msgType </span><span class="s3">== </span><span class="s1">OBJECT_GENERATE_CMU</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">handleGenerate</span><span class="s3">(</span><span class="s1">di</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">msgType </span><span class="s3">== </span><span class="s1">OBJECT_UPDATE_FIELD_CMU</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">handleUpdateField</span><span class="s3">(</span><span class="s1">di</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">msgType </span><span class="s3">== </span><span class="s1">OBJECT_DISABLE_CMU</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">handleDisable</span><span class="s3">(</span><span class="s1">di</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">msgType </span><span class="s3">== </span><span class="s1">OBJECT_DELETE_CMU</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">handleDelete</span><span class="s3">(</span><span class="s1">di</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">msgType </span><span class="s3">== </span><span class="s1">REQUEST_GENERATES_CMU</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">handleRequestGenerates</span><span class="s3">(</span><span class="s1">di</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">handleMessageType</span><span class="s3">(</span><span class="s1">msgType</span><span class="s3">, </span><span class="s1">di</span><span class="s3">)</span>

        <span class="s5"># If we're processing a lot of datagrams within one frame, we</span>
        <span class="s5"># may forget to send heartbeats.  Keep them coming!</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">considerHeartbeat</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">handleMessageType</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">msgType</span><span class="s3">, </span><span class="s1">di</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">&quot;unrecognized message type %s&quot; </span><span class="s3">% (</span><span class="s1">msgType</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">handleUpdateField</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">di</span><span class="s3">):</span>
        <span class="s5"># The CMU update message starts with an additional field, not</span>
        <span class="s5"># present in the Disney update message: the doIdBase of the</span>
        <span class="s5"># original sender.  Extract that and call up to the parent.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">currentSenderId </span><span class="s3">= </span><span class="s1">di</span><span class="s3">.</span><span class="s1">getUint32</span><span class="s3">()</span>
        <span class="s1">ClientRepositoryBase</span><span class="s3">.</span><span class="s1">handleUpdateField</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">di</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">handleDisable</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">di</span><span class="s3">):</span>
        <span class="s5"># Receives a list of doIds.</span>
        <span class="s2">while </span><span class="s1">di</span><span class="s3">.</span><span class="s1">getRemainingSize</span><span class="s3">() &gt; </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s1">doId </span><span class="s3">= </span><span class="s1">di</span><span class="s3">.</span><span class="s1">getUint32</span><span class="s3">()</span>

            <span class="s5"># We should never get a disable message for our own object.</span>
            <span class="s2">assert not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">isLocalId</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">disableDoId</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">handleDelete</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">di</span><span class="s3">):</span>
        <span class="s5"># Receives a single doId.</span>
        <span class="s1">doId </span><span class="s3">= </span><span class="s1">di</span><span class="s3">.</span><span class="s1">getUint32</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">deleteObject</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">deleteObject</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">doId</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Removes the object from the client's view of the world.  This 
        should normally not be called directly except in the case of 
        error recovery, since the server will normally be responsible 
        for deleting and disabling objects as they go out of scope. 
 
        After this is called, future updates by server on this object 
        will be ignored (with a warning message).  The object will 
        become valid again the next time the server sends a generate 
        message for this doId. 
 
        This is not a distributed message and does not delete the 
        object on the server or on any other client. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">doId </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">doId2do</span><span class="s3">:</span>
            <span class="s5"># If it is in the dictionary, remove it.</span>
            <span class="s1">obj </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">doId2do</span><span class="s3">[</span><span class="s1">doId</span><span class="s3">]</span>
            <span class="s5"># Remove it from the dictionary</span>
            <span class="s2">del </span><span class="s1">self</span><span class="s3">.</span><span class="s1">doId2do</span><span class="s3">[</span><span class="s1">doId</span><span class="s3">]</span>
            <span class="s5"># Disable, announce, and delete the object itself...</span>
            <span class="s5"># unless delayDelete is on...</span>
            <span class="s1">obj</span><span class="s3">.</span><span class="s1">deleteOrDelay</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">isLocalId</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">freeDoId</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cache</span><span class="s3">.</span><span class="s1">contains</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">):</span>
            <span class="s5"># If it is in the cache, remove it.</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">cache</span><span class="s3">.</span><span class="s1">delete</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">isLocalId</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">freeDoId</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s5"># Otherwise, ignore it</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span>
                <span class="s4">&quot;Asked to delete non-existent DistObj &quot; </span><span class="s3">+ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">doId</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">stopTrackRequestDeletedDO</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">):</span>
        <span class="s5"># No-op.  Not entirely sure what this does on the VR Studio side.</span>
        <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">sendUpdate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">distObj</span><span class="s3">, </span><span class="s1">fieldName</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Sends a normal update for a single field. &quot;&quot;&quot;</span>
        <span class="s1">dg </span><span class="s3">= </span><span class="s1">distObj</span><span class="s3">.</span><span class="s1">dclass</span><span class="s3">.</span><span class="s1">clientFormatUpdate</span><span class="s3">(</span>
            <span class="s1">fieldName</span><span class="s3">, </span><span class="s1">distObj</span><span class="s3">.</span><span class="s1">doId</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">dg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">sendUpdateToChannel</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">distObj</span><span class="s3">, </span><span class="s1">channelId</span><span class="s3">, </span><span class="s1">fieldName</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>

        <span class="s0">&quot;&quot;&quot; Sends a targeted update of a single field to a particular 
        client.  The top 32 bits of channelId is ignored; the lower 32 
        bits should be the client Id of the recipient (i.e. the 
        client's doIdbase).  The field update will be sent to the 
        indicated client only.  The field must be marked clsend or 
        p2p, and may not be marked broadcast. &quot;&quot;&quot;</span>

        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">distObj</span><span class="s3">.</span><span class="s1">dclass</span><span class="s3">.</span><span class="s1">clientFormatUpdate</span><span class="s3">(</span>
            <span class="s1">fieldName</span><span class="s3">, </span><span class="s1">distObj</span><span class="s3">.</span><span class="s1">doId</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
        <span class="s1">dgi </span><span class="s3">= </span><span class="s1">PyDatagramIterator</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">)</span>

        <span class="s5"># Reformat the packed datagram to change the message type and</span>
        <span class="s5"># add the target id.</span>
        <span class="s1">dgi</span><span class="s3">.</span><span class="s1">getUint16</span><span class="s3">()</span>

        <span class="s1">dg </span><span class="s3">= </span><span class="s1">PyDatagram</span><span class="s3">()</span>
        <span class="s1">dg</span><span class="s3">.</span><span class="s1">addUint16</span><span class="s3">(</span><span class="s1">CLIENT_OBJECT_UPDATE_FIELD_TARGETED_CMU</span><span class="s3">)</span>
        <span class="s1">dg</span><span class="s3">.</span><span class="s1">addUint32</span><span class="s3">(</span><span class="s1">channelId </span><span class="s3">&amp; </span><span class="s6">0xffffffff</span><span class="s3">)</span>
        <span class="s1">dg</span><span class="s3">.</span><span class="s1">appendData</span><span class="s3">(</span><span class="s1">dgi</span><span class="s3">.</span><span class="s1">getRemainingBytes</span><span class="s3">())</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">dg</span><span class="s3">)</span>
</pre>
</body>
</html>