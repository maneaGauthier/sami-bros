<html>
<head>
<title>level_editor.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
level_editor.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">ursina </span><span class="s0">import </span><span class="s2">*</span>
<span class="s0">from </span><span class="s1">ursina</span><span class="s2">.</span><span class="s1">shaders </span><span class="s0">import </span><span class="s1">unlit_shader</span><span class="s2">, </span><span class="s1">lit_with_shadows_shader</span><span class="s2">, </span><span class="s1">matcap_shader</span><span class="s2">, </span><span class="s1">triplanar_shader</span><span class="s2">, </span><span class="s1">normals_shader</span>
<span class="s0">from </span><span class="s1">time </span><span class="s0">import </span><span class="s1">perf_counter</span>
<span class="s0">import </span><span class="s1">csv</span>
<span class="s0">import </span><span class="s1">builtins</span>
<span class="s0">import </span><span class="s1">pyperclip</span>


<span class="s0">class </span><span class="s1">LevelEditor</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">()</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">LEVEL_EDITOR </span><span class="s2">= </span><span class="s1">self</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scene_folder </span><span class="s2">= </span><span class="s1">application</span><span class="s2">.</span><span class="s1">asset_folder </span><span class="s2">/ </span><span class="s3">'scenes'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scenes </span><span class="s2">= [[</span><span class="s1">LevelEditorScene</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s3">f'untitled_scene[</span><span class="s0">{</span><span class="s1">x</span><span class="s0">}</span><span class="s3">,</span><span class="s0">{</span><span class="s1">y</span><span class="s0">}</span><span class="s3">]'</span><span class="s2">) </span><span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">8</span><span class="s2">)] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">8</span><span class="s2">)]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene </span><span class="s2">= </span><span class="s0">None</span>


        <span class="s1">self</span><span class="s2">.</span><span class="s1">grid </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s1">Grid</span><span class="s2">(</span><span class="s4">16</span><span class="s2">,</span><span class="s4">16</span><span class="s2">), </span><span class="s1">rotation_x</span><span class="s2">=</span><span class="s4">90</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">64</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'box'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">white33</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">origin_mode </span><span class="s2">= </span><span class="s3">'center'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">editor_camera </span><span class="s2">= </span><span class="s1">EditorCamera</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rotation_x</span><span class="s2">=</span><span class="s4">20</span><span class="s2">, </span><span class="s1">eternal</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">rotation_smoothing</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">original_editor_camera_rotation_speed </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">rotation_speed</span>
        <span class="s0">def </span><span class="s1">_update</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">rotation_speed </span><span class="s2">= </span><span class="s1">original_editor_camera_rotation_speed </span><span class="s2">* </span><span class="s1">int</span><span class="s2">(</span><span class="s0">not </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">left</span><span class="s2">)   </span><span class="s5"># don't rotate when holding left mouse button</span>
        <span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">, </span><span class="s1">update</span><span class="s2">=</span><span class="s1">_update</span><span class="s2">)</span>


        <span class="s1">self</span><span class="s2">.</span><span class="s1">ui </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">camera</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">'LEVEL_EDITOR.ui'</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">point_renderer </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s1">Mesh</span><span class="s2">([], </span><span class="s1">mode</span><span class="s2">=</span><span class="s3">'point'</span><span class="s2">, </span><span class="s1">thickness</span><span class="s2">=</span><span class="s4">.1</span><span class="s2">, </span><span class="s1">render_points_in_3d</span><span class="s2">=</span><span class="s0">True</span><span class="s2">), </span><span class="s1">texture</span><span class="s2">=</span><span class="s3">'circle_outlined'</span><span class="s2">, </span><span class="s1">always_on_top</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">unlit</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">render_queue</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cubes </span><span class="s2">= [</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">wireframe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">azure</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">128</span><span class="s2">)] </span><span class="s5"># max selection</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">origin_mode_menu </span><span class="s2">= </span><span class="s1">ButtonGroup</span><span class="s2">([</span><span class="s3">'last'</span><span class="s2">, </span><span class="s3">'center'</span><span class="s2">, </span><span class="s3">'individual'</span><span class="s2">], </span><span class="s1">min_selection</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">position</span><span class="s2">=</span><span class="s1">window</span><span class="s2">.</span><span class="s1">top</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">origin_mode_menu</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">*= </span><span class="s4">.5</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">origin_mode_menu</span><span class="s2">.</span><span class="s1">on_value_changed </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">render_selection</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">local_global_menu </span><span class="s2">= </span><span class="s1">ButtonGroup</span><span class="s2">([</span><span class="s3">'local'</span><span class="s2">, </span><span class="s3">'global'</span><span class="s2">], </span><span class="s1">default</span><span class="s2">=</span><span class="s3">'global'</span><span class="s2">, </span><span class="s1">min_selection</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">position</span><span class="s2">=</span><span class="s1">window</span><span class="s2">.</span><span class="s1">top </span><span class="s2">- </span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">.2</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">local_global_menu</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">*= </span><span class="s4">.5</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">local_global_menu</span><span class="s2">.</span><span class="s1">on_value_changed </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">render_selection</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">target_fov </span><span class="s2">= </span><span class="s4">90</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">sun_handler </span><span class="s2">= </span><span class="s1">SunHandler</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">gizmo </span><span class="s2">= </span><span class="s1">Gizmo</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rotation_gizmo </span><span class="s2">= </span><span class="s1">RotationGizmo</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scale_gizmo </span><span class="s2">= </span><span class="s1">ScaleGizmo</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">box_gizmo </span><span class="s2">= </span><span class="s1">BoxGizmo</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">gizmo_toggler </span><span class="s2">= </span><span class="s1">GizmoToggler</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">quick_grabber </span><span class="s2">= </span><span class="s1">QuickGrabber</span><span class="s2">()   </span><span class="s5"># requires gizmo, selector</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">quick_scaler </span><span class="s2">= </span><span class="s1">QuickScaler</span><span class="s2">()    </span><span class="s5"># requires scale_gizmo, gizmo_toggler, selector</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">quick_rotator </span><span class="s2">= </span><span class="s1">QuickRotator</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rotate_to_view </span><span class="s2">= </span><span class="s1">RotateRelativeToView</span><span class="s2">(</span><span class="s1">target_entity</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">selector </span><span class="s2">= </span><span class="s1">Selector</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">selection_box </span><span class="s2">= </span><span class="s1">SelectionBox</span><span class="s2">(</span><span class="s1">model</span><span class="s2">=</span><span class="s1">Quad</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s3">'line'</span><span class="s2">), </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">scale</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">), </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">white33</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s3">'new'</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">prefab_folder </span><span class="s2">= </span><span class="s1">application</span><span class="s2">.</span><span class="s1">asset_folder </span><span class="s2">/ </span><span class="s3">'prefabs'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">built_in_prefabs </span><span class="s2">= [</span><span class="s1">ClassSpawner</span><span class="s2">, </span><span class="s1">WhiteCube</span><span class="s2">, </span><span class="s1">TriplanarCube</span><span class="s2">, </span><span class="s1">Pyramid</span><span class="s2">, </span><span class="s1">PokeShape</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">spawner </span><span class="s2">= </span><span class="s1">Spawner</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">deleter </span><span class="s2">= </span><span class="s1">Deleter</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">grouper </span><span class="s2">= </span><span class="s1">Grouper</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">level_menu </span><span class="s2">= </span><span class="s1">LevelMenu</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">goto_scene </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">level_menu</span><span class="s2">.</span><span class="s1">goto_scene</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">duplicator </span><span class="s2">= </span><span class="s1">Duplicator</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">copier </span><span class="s2">= </span><span class="s1">Copier</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">model_menu </span><span class="s2">= </span><span class="s1">ModelMenu</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">texture_menu </span><span class="s2">= </span><span class="s1">TextureMenu</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">color_menu </span><span class="s2">= </span><span class="s1">ColorMenu</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">shader_menu </span><span class="s2">= </span><span class="s1">ShaderMenu</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">collider_menu </span><span class="s2">= </span><span class="s1">ColliderMenu</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">class_menu </span><span class="s2">= </span><span class="s1">ClassMenu</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">menu_handler </span><span class="s2">= </span><span class="s1">MenuHandler</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">right_click_menu </span><span class="s2">= </span><span class="s1">RightClickMenu</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">hierarchy_list </span><span class="s2">= </span><span class="s1">HierarchyList</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inspector </span><span class="s2">= </span><span class="s1">Inspector</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">point_of_view_selector </span><span class="s2">= </span><span class="s1">PointOfViewSelector</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">help </span><span class="s2">= </span><span class="s1">Help</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_edit_mode </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sky </span><span class="s2">= </span><span class="s1">Sky</span>


    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">entities</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s2">[]</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">entities</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">selection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s2">[]</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">selection</span>

    <span class="s2">@</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">selection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">on_enable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_camera_original_fov </span><span class="s2">= </span><span class="s1">camera</span><span class="s2">.</span><span class="s1">fov</span>
        <span class="s1">camera</span><span class="s2">.</span><span class="s1">fov </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_fov</span>

    <span class="s0">def </span><span class="s1">on_disable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">camera</span><span class="s2">.</span><span class="s1">fov </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_camera_original_fov</span>

    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s3">'gsxyz'</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>
                <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">left</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'alt'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'s'</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">:</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;no current_scene, can't save&quot;</span><span class="s2">)</span>
                <span class="s0">return</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">save</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">]:</span>
            <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'z' </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">undo</span><span class="s2">.</span><span class="s1">undo</span><span class="s2">()</span>
            <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'y' </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">undo</span><span class="s2">.</span><span class="s1">redo</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'f'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">animate_position</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">world_position</span><span class="s2">, </span><span class="s1">duration</span><span class="s2">=</span><span class="s4">.1</span><span class="s2">, </span><span class="s1">curve</span><span class="s2">=</span><span class="s1">curve</span><span class="s2">.</span><span class="s1">linear</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'e'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">edit_mode </span><span class="s2">= </span><span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">edit_mode</span>


    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">edit_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_edit_mode</span>

    <span class="s2">@</span><span class="s1">edit_mode</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">edit_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">value </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_edit_mode</span><span class="s2">:   </span><span class="s5"># enter play mode</span>
            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">children</span><span class="s2">:</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">ignore </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">visible </span><span class="s2">= </span><span class="s0">False</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">original_target_z </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">target_z</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">:</span>
                <span class="s5"># switch editor colliders out for what they should have during play</span>
                <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'edit_mode'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">e</span><span class="s2">.</span><span class="s1">edit_mode</span><span class="s2">:</span>
                    <span class="s1">e</span><span class="s2">.</span><span class="s1">edit_mode </span><span class="s2">= </span><span class="s0">False</span>

                <span class="s1">e</span><span class="s2">.</span><span class="s1">editor_collider </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">collider</span>
                <span class="s0">if </span><span class="s1">e</span><span class="s2">.</span><span class="s1">collider</span><span class="s2">:</span>
                    <span class="s1">e</span><span class="s2">.</span><span class="s1">editor_collider </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">collider</span><span class="s2">.</span><span class="s1">name</span>

                <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'collider_type'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">e</span><span class="s2">.</span><span class="s1">collider_type </span><span class="s2">!= </span><span class="s3">'None'</span><span class="s2">:</span>
                    <span class="s1">e</span><span class="s2">.</span><span class="s1">collider </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">collider_type</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">e</span><span class="s2">.</span><span class="s1">collider </span><span class="s2">= </span><span class="s0">None</span>


                <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'start'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">callable</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">start</span><span class="s2">):</span>
                    <span class="s1">e</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>

        <span class="s0">elif </span><span class="s1">value </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_edit_mode</span><span class="s2">: </span><span class="s5"># back to editor mode</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'stop'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">callable</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">stop</span><span class="s2">):</span>
                    <span class="s1">e</span><span class="s2">.</span><span class="s1">stop</span><span class="s2">()</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">collider </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">editor_collider</span>

            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">children</span><span class="s2">:</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">ignore </span><span class="s2">= </span><span class="s0">False</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">visible </span><span class="s2">= </span><span class="s0">True</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">target_z </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">original_target_z</span>
            <span class="s1">camera</span><span class="s2">.</span><span class="s1">z </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">target_z</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_edit_mode </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s5"># print('set edit mode to', value)</span>


    <span class="s0">def </span><span class="s1">render_selection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">update_gizmo_position</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">e </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">e </span><span class="s2">== </span><span class="s0">None</span><span class="s2">:</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">f'error in entities </span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">, is </span><span class="s0">{</span><span class="s1">e</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>

        <span class="s5"># self.point_renderer.model.vertices = [e.world_position for e in self.entities if e.selectable and not e.model ]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">point_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">point_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>

        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">e </span><span class="s0">or </span><span class="s1">e</span><span class="s2">.</span><span class="s1">model </span><span class="s0">and </span><span class="s1">e</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s3">'cube'</span><span class="s2">:</span>
                <span class="s0">continue</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">point_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">world_position</span><span class="s2">)</span>

            <span class="s0">if not </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">gizmo_color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">orange</span>
                <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s3">'gizmo_color'</span><span class="s2">):</span>
                    <span class="s1">gizmo_color </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">gizmo_color</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">point_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">gizmo_color</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">gizmo_color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">azure</span>
                <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s3">'gizmo_color_selected'</span><span class="s2">):</span>
                    <span class="s1">gizmo_color </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">gizmo_color_selected</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">point_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">gizmo_color</span><span class="s2">)</span>


        <span class="s5"># self.point_renderer.model.colors = [color.azure if e in self.selection else lerp(color.orange, color.hsv(0,0,1,0), distance(e.world_position, camera.world_position)/100) for e in self.entities if e.selectable and not e.collider]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">point_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>

        <span class="s5"># self.gizmo.enabled = bool(self.selection and self.selection[-1])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">e </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">if </span><span class="s1">e</span><span class="s2">]</span>

        <span class="s0">if </span><span class="s1">update_gizmo_position </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">origin_mode_menu</span><span class="s2">.</span><span class="s1">value </span><span class="s0">in </span><span class="s2">(</span><span class="s3">'last'</span><span class="s2">, </span><span class="s3">'individual'</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">world_position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">].</span><span class="s1">world_position</span>
            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">origin_mode_menu</span><span class="s2">.</span><span class="s1">value </span><span class="s2">== </span><span class="s3">'center'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">world_position </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">([</span><span class="s1">e</span><span class="s2">.</span><span class="s1">world_position </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">]) / </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">local_global_menu</span><span class="s2">.</span><span class="s1">value </span><span class="s2">== </span><span class="s3">'local' </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">origin_mode_menu</span><span class="s2">.</span><span class="s1">value </span><span class="s2">== </span><span class="s3">'last'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">world_rotation </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">].</span><span class="s1">world_rotation</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">world_rotation </span><span class="s2">= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)</span>

        <span class="s2">[</span><span class="s1">e</span><span class="s2">.</span><span class="s1">disable</span><span class="s2">() </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cubes</span><span class="s2">]</span>
        <span class="s5"># [setattr(e, 'parent', self) for e in self.cubes]</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">e </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">([</span><span class="s1">e </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">if </span><span class="s1">e</span><span class="s2">.</span><span class="s1">collider</span><span class="s2">]):</span>
            <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cubes</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cubes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">world_transform </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">world_transform</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cubes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">origin </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">origin</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cubes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">model </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cubes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>

        <span class="s5"># print('---------- rendered selection')</span>

        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">hierarchy_list</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">on_enable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'ui'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">on_disable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>


<span class="s0">class </span><span class="s1">LevelEditorScene</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">coordinates </span><span class="s2">= [</span><span class="s1">x</span><span class="s2">,</span><span class="s1">y</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">path </span><span class="s2">= </span><span class="s0">None    </span><span class="s5"># must be assigned to be able to load</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">entities </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scene_parent </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">undo </span><span class="s2">= </span><span class="s1">Undo</span><span class="s2">()</span>
        <span class="s5"># self.undo_handler     # gets assigned later</span>

    <span class="s0">def </span><span class="s1">save</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">'cant save scene with not path and no entities'</span><span class="s2">)</span>
            <span class="s0">return</span>

        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scene_folder</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">(</span><span class="s1">parents</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">exist_ok</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">list_of_dicts </span><span class="s2">= []</span>

        <span class="s1">fields </span><span class="s2">= [</span><span class="s3">'class'</span><span class="s2">, ]</span>
        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'is_gizmo'</span><span class="s2">):</span>
                <span class="s0">continue</span>

            <span class="s1">changes </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">get_changes</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">changes</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s0">if </span><span class="s1">value </span><span class="s2">== </span><span class="s0">None</span><span class="s2">:</span>
                    <span class="s1">changes</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s0">False</span>
            <span class="s5"># if 'subdivisions' in changes:</span>
            <span class="s1">changes</span><span class="s2">[</span><span class="s3">'class'</span><span class="s2">] = </span><span class="s1">e</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span>
            <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'collider_type'</span><span class="s2">):</span>
                <span class="s1">changes</span><span class="s2">[</span><span class="s3">'collider_type'</span><span class="s2">] = </span><span class="s3">f&quot;'</span><span class="s0">{</span><span class="s1">e</span><span class="s2">.</span><span class="s1">collider_type</span><span class="s0">}</span><span class="s3">'&quot;</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">'changes:'</span><span class="s2">, </span><span class="s1">changes</span><span class="s2">)</span>
            <span class="s1">list_of_dicts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">changes</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">changes</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">():</span>
                <span class="s0">if </span><span class="s1">key </span><span class="s0">not in </span><span class="s1">fields</span><span class="s2">:</span>
                    <span class="s1">fields</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>


        <span class="s1">name </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">path </span><span class="s2">=  </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scene_folder </span><span class="s2">/ </span><span class="s3">f'</span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s3">.csv'</span>

        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s3">'w'</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">'UTF8'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">file</span><span class="s2">:</span>
            <span class="s1">writer </span><span class="s2">= </span><span class="s1">csv</span><span class="s2">.</span><span class="s1">DictWriter</span><span class="s2">(</span><span class="s1">file</span><span class="s2">, </span><span class="s1">fieldnames</span><span class="s2">=</span><span class="s1">fields</span><span class="s2">, </span><span class="s1">delimiter</span><span class="s2">=</span><span class="s3">';'</span><span class="s2">)</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeheader</span><span class="s2">()</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writerows</span><span class="s2">(</span><span class="s1">list_of_dicts</span><span class="s2">)</span>

        <span class="s1">print</span><span class="s2">(</span><span class="s3">'saved:'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">)</span>


    <span class="s0">def </span><span class="s1">load</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">'cant load scene, no path'</span><span class="s2">)</span>
            <span class="s0">return</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scene_parent</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">'error, scene already loaded'</span><span class="s2">)</span>
            <span class="s0">return</span>

        <span class="s1">t </span><span class="s2">= </span><span class="s1">perf_counter</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s3">'r'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">scene_parent </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">()</span>
            <span class="s1">reader </span><span class="s2">= </span><span class="s1">csv</span><span class="s2">.</span><span class="s1">DictReader</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">delimiter</span><span class="s2">=</span><span class="s3">';'</span><span class="s2">)</span>
            <span class="s1">fields </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">fieldnames</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:]</span>

            <span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">reader</span><span class="s2">:</span>
                <span class="s1">args </span><span class="s2">= </span><span class="s3">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s3">f'</span><span class="s0">{</span><span class="s1">key</span><span class="s0">}</span><span class="s3">=</span><span class="s0">{</span><span class="s1">value</span><span class="s0">}</span><span class="s3">' </span><span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">line</span><span class="s2">.</span><span class="s1">items</span><span class="s2">() </span><span class="s0">if </span><span class="s1">value </span><span class="s0">and not </span><span class="s1">key</span><span class="s2">==</span><span class="s3">'class'</span><span class="s2">])</span>
                <span class="s5"># print('eval:', f'{line[&quot;class&quot;]}(parent=self.scene_parent, {args})')</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">e </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s3">f'</span><span class="s0">{</span><span class="s1">line</span><span class="s2">[</span><span class="s3">&quot;class&quot;</span><span class="s2">]</span><span class="s0">}</span><span class="s3">(parent=self.scene_parent, </span><span class="s0">{</span><span class="s1">args</span><span class="s0">}</span><span class="s3">)'</span><span class="s2">, </span><span class="s1">globals</span><span class="s2">(), </span><span class="s1">locals</span><span class="s2">())</span>
                <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                    <span class="s1">print_warning</span><span class="s2">(</span><span class="s3">'Error loading scene:'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">e</span><span class="s2">, </span><span class="s3">'line:</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">, </span><span class="s3">f'</span><span class="s0">{</span><span class="s1">line</span><span class="s2">[</span><span class="s3">&quot;class&quot;</span><span class="s2">]</span><span class="s0">}</span><span class="s3">(parent=self.scene_parent, </span><span class="s0">{</span><span class="s1">args</span><span class="s0">}</span><span class="s3">)'</span><span class="s2">)</span>
                    <span class="s0">try</span><span class="s2">:</span>
                        <span class="s1">e </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s3">f'</span><span class="s0">{</span><span class="s1">line</span><span class="s2">[</span><span class="s3">&quot;class&quot;</span><span class="s2">]</span><span class="s0">}</span><span class="s3">(parent=self.scene_parent)'</span><span class="s2">)</span>
                    <span class="s0">except</span><span class="s2">:</span>
                        <span class="s1">print</span><span class="s2">(</span><span class="s3">'missing/invalid class:'</span><span class="s2">, </span><span class="s1">line</span><span class="s2">[</span><span class="s3">'class'</span><span class="s2">])</span>
                        <span class="s5"># error_cube = Entity(model='cube', color=color.magenta)</span>
                        <span class="s5"># for key in ('parent', 'position', 'rotation', 'scale'):</span>
                        <span class="s5">#     if line[key]: setattr(error_cube, key, line[key]</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">:</span>
                    <span class="s0">if not </span><span class="s1">e</span><span class="s2">.</span><span class="s1">shader</span><span class="s2">:</span>
                        <span class="s1">e</span><span class="s2">.</span><span class="s1">shader </span><span class="s2">= </span><span class="s1">lit_with_shadows_shader</span>
                    <span class="s1">e</span><span class="s2">.</span><span class="s1">selectable </span><span class="s2">= </span><span class="s0">True</span>

                    <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'collider_type'</span><span class="s2">):</span>
                        <span class="s1">e</span><span class="s2">.</span><span class="s1">collider_type </span><span class="s2">= </span><span class="s0">None</span>

                    <span class="s1">e</span><span class="s2">.</span><span class="s1">original_parent </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">parent</span>
                    <span class="s0">if </span><span class="s1">e</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s3">'cube'</span><span class="s2">:</span>
                        <span class="s1">e</span><span class="s2">.</span><span class="s1">collider </span><span class="s2">= </span><span class="s3">'box'</span>
                        <span class="s1">e</span><span class="s2">.</span><span class="s1">collision </span><span class="s2">= </span><span class="s0">False</span>


        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scene_parent</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">f'loaded scene: &quot;</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s0">}</span><span class="s3">&quot; in </span><span class="s0">{</span><span class="s1">perf_counter</span><span class="s2">()-</span><span class="s1">t</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scene_parent</span>


    <span class="s0">def </span><span class="s1">unload</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'parent'</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">cubes</span><span class="s2">]</span>
        <span class="s2">[</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">]</span>
        <span class="s5"># if not self.scene_parent:</span>
        <span class="s5">#     # print('cant unload scene, its already empty')</span>
        <span class="s5">#     return</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">entities </span><span class="s2">= []</span>
        <span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scene_parent</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Undo</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">, </span><span class="s1">undo_data</span><span class="s2">=[], </span><span class="s1">undo_index</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">record_undo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">'record undo:'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">undo_data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">undo_data</span><span class="s2">[:</span><span class="s1">self</span><span class="s2">.</span><span class="s1">undo_index</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">undo_data</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">undo_index </span><span class="s2">+= </span><span class="s4">1</span>

    <span class="s0">def </span><span class="s1">undo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">undo_index </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s1">current_undo_data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">undo_data</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">undo_index</span><span class="s2">]</span>

        <span class="s0">if </span><span class="s1">current_undo_data</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s3">'restore entities'</span><span class="s2">:     </span><span class="s5"># restore deleted entity</span>
            <span class="s0">for </span><span class="s1">id</span><span class="s2">, </span><span class="s1">recipe </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">current_undo_data</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">current_undo_data</span><span class="s2">[</span><span class="s4">2</span><span class="s2">]):</span>
                <span class="s5"># print('------------', recipe)</span>
                <span class="s1">clone </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">recipe</span><span class="s2">)</span>
                <span class="s1">clone</span><span class="s2">.</span><span class="s1">selectable </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s1">clone</span><span class="s2">.</span><span class="s1">original_parent </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">.</span><span class="s1">parent</span>
                <span class="s1">clone</span><span class="s2">.</span><span class="s1">shader </span><span class="s2">= </span><span class="s1">lit_with_shadows_shader</span>
                <span class="s5"># print('------------', recipe, id, 'clone:', clone)</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">id</span><span class="s2">, </span><span class="s1">clone</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">current_undo_data</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s3">'delete entities'</span><span class="s2">: </span><span class="s5"># delete newly created entity</span>
            <span class="s1">target_entities </span><span class="s2">= [</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">[</span><span class="s1">id</span><span class="s2">] </span><span class="s0">for </span><span class="s1">id </span><span class="s0">in </span><span class="s1">current_undo_data</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]]</span>
            <span class="s2">[</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">target_entities </span><span class="s0">if </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">]</span>
            <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'parent'</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">cubes</span><span class="s2">]</span>
            <span class="s2">[</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">target_entities</span><span class="s2">]</span>
            <span class="s2">[</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">target_entities</span><span class="s2">]</span>

        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">data </span><span class="s0">in </span><span class="s1">current_undo_data</span><span class="s2">:</span>
                <span class="s1">id</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">original</span><span class="s2">, </span><span class="s1">new </span><span class="s2">= </span><span class="s1">data</span>
                <span class="s1">setattr</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">[</span><span class="s1">id</span><span class="s2">], </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">original</span><span class="s2">)</span>

        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()     </span><span class="s5"># make sure the gizmo position updates</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">undo_index </span><span class="s2">-= </span><span class="s4">1</span>

    <span class="s0">def </span><span class="s1">redo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">undo_index</span><span class="s2">+</span><span class="s4">2 </span><span class="s2">&gt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">undo_data</span><span class="s2">):</span>
            <span class="s0">return</span>

        <span class="s1">current_undo_data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">undo_data</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">undo_index</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]</span>

        <span class="s5"># do the same as for undo, but opposite</span>
        <span class="s0">if </span><span class="s1">current_undo_data</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s3">'delete entities'</span><span class="s2">:     </span><span class="s5"># delete entity</span>
            <span class="s5"># pass</span>
            <span class="s0">for </span><span class="s1">id</span><span class="s2">, </span><span class="s1">recipe </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">current_undo_data</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">current_undo_data</span><span class="s2">[</span><span class="s4">2</span><span class="s2">]):</span>
                <span class="s1">clone </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">recipe</span><span class="s2">)</span>
                <span class="s1">clone</span><span class="s2">.</span><span class="s1">selectable </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s1">clone</span><span class="s2">.</span><span class="s1">original_parent </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">.</span><span class="s1">parent</span>
                <span class="s1">clone</span><span class="s2">.</span><span class="s1">shader </span><span class="s2">= </span><span class="s1">lit_with_shadows_shader</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">id</span><span class="s2">, </span><span class="s1">clone</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">current_undo_data</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s3">'restore entities'</span><span class="s2">: </span><span class="s5"># restore entity</span>
            <span class="s0">pass</span>
            <span class="s1">target_entities </span><span class="s2">= [</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">[</span><span class="s1">id</span><span class="s2">] </span><span class="s0">for </span><span class="s1">id </span><span class="s0">in </span><span class="s1">current_undo_data</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]]</span>
            <span class="s2">[</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">target_entities </span><span class="s0">if </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">]</span>
            <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'parent'</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">cubes</span><span class="s2">]</span>
            <span class="s2">[</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">target_entities </span><span class="s0">if </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">]</span>
            <span class="s2">[</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">target_entities</span><span class="s2">]</span>


        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">data </span><span class="s0">in </span><span class="s1">current_undo_data</span><span class="s2">:</span>
                <span class="s1">id</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">original</span><span class="s2">, </span><span class="s1">new </span><span class="s2">= </span><span class="s1">data</span>
                <span class="s1">setattr</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">[</span><span class="s1">id</span><span class="s2">], </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">new</span><span class="s2">)</span>

        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()     </span><span class="s5"># make sure the gizmo position updates</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">undo_index </span><span class="s2">+= </span><span class="s4">1</span>


<span class="s1">axis_colors </span><span class="s2">= {</span>
    <span class="s3">'x' </span><span class="s2">: </span><span class="s1">color</span><span class="s2">.</span><span class="s1">magenta</span><span class="s2">,</span>
    <span class="s3">'y' </span><span class="s2">: </span><span class="s1">color</span><span class="s2">.</span><span class="s1">yellow</span><span class="s2">,</span>
    <span class="s3">'z' </span><span class="s2">: </span><span class="s1">color</span><span class="s2">.</span><span class="s1">cyan</span>
<span class="s2">}</span>

<span class="s0">if not </span><span class="s1">load_model</span><span class="s2">(</span><span class="s3">'arrow'</span><span class="s2">, </span><span class="s1">application</span><span class="s2">.</span><span class="s1">internal_models_compressed_folder</span><span class="s2">):</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">p</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'cube'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">.05</span><span class="s2">,</span><span class="s4">.05</span><span class="s2">))</span>
    <span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">p</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s1">Cone</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s1">direction</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)), </span><span class="s1">x</span><span class="s2">=</span><span class="s4">.5</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">.2</span><span class="s2">)</span>
    <span class="s1">arrow_model </span><span class="s2">= </span><span class="s1">p</span><span class="s2">.</span><span class="s1">combine</span><span class="s2">()</span>
    <span class="s1">arrow_model</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s3">'arrow.ursinamesh'</span><span class="s2">, </span><span class="s1">path</span><span class="s2">=</span><span class="s1">application</span><span class="s2">.</span><span class="s1">internal_models_compressed_folder</span><span class="s2">)</span>

<span class="s0">if not </span><span class="s1">load_model</span><span class="s2">(</span><span class="s3">'scale_gizmo'</span><span class="s2">, </span><span class="s1">application</span><span class="s2">.</span><span class="s1">internal_models_compressed_folder</span><span class="s2">):</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">p</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'cube'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=(</span><span class="s4">.05</span><span class="s2">,</span><span class="s4">.05</span><span class="s2">,</span><span class="s4">1</span><span class="s2">))</span>
    <span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">p</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'cube'</span><span class="s2">, </span><span class="s1">z</span><span class="s2">=</span><span class="s4">.5</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">.2</span><span class="s2">)</span>
    <span class="s1">arrow_model </span><span class="s2">= </span><span class="s1">p</span><span class="s2">.</span><span class="s1">combine</span><span class="s2">()</span>
    <span class="s1">arrow_model</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s3">'scale_gizmo.ursinamesh'</span><span class="s2">, </span><span class="s1">path</span><span class="s2">=</span><span class="s1">application</span><span class="s2">.</span><span class="s1">internal_models_compressed_folder</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">GizmoArrow</span><span class="s2">(</span><span class="s1">Draggable</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'arrow'</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'box'</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">model</span><span class="s2">=</span><span class="s1">model</span><span class="s2">, </span><span class="s1">origin_x</span><span class="s2">=-</span><span class="s4">.55</span><span class="s2">, </span><span class="s1">always_on_top</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">render_queue</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">is_gizmo</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">shader</span><span class="s2">=</span><span class="s1">unlit_shader</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">setattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">record_undo </span><span class="s2">= </span><span class="s0">True     </span><span class="s5"># this can be set to False when moving this though code for example, and you don't want it to record undo.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">original_rotation </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rotation</span>


    <span class="s0">def </span><span class="s1">drag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">self</span>
        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">, </span><span class="s3">'is_gizmo'</span><span class="s2">) </span><span class="s0">or </span><span class="s1">e</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">is_gizmo </span><span class="s2">== </span><span class="s0">False</span><span class="s2">:</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">original_parent </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">parent</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">original_parent </span><span class="s2">= </span><span class="s1">scene</span>

            <span class="s0">if </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">local_global_menu</span><span class="s2">.</span><span class="s1">value </span><span class="s2">== </span><span class="s3">'global'</span><span class="s2">:</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">self</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">fake_gizmo</span>

            <span class="s1">e</span><span class="s2">.</span><span class="s1">always_on_top </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">_original_world_transform </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">world_transform</span>

    <span class="s0">def </span><span class="s1">drop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span>

        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">original_parent</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">'---------------'</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">original_parent</span><span class="s2">, </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">original_parent</span><span class="s2">, </span><span class="s1">GizmoArrow</span><span class="s2">))</span>

        <span class="s0">if not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s1">changed </span><span class="s2">= ( </span><span class="s5"># don't record undo if transform didn't change</span>
            <span class="s1">distance</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">world_transform</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">_original_world_transform</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]) &gt; </span><span class="s4">.0001 </span><span class="s0">or</span>
            <span class="s1">distance</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">world_transform</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">_original_world_transform</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]) &gt; </span><span class="s4">.0001 </span><span class="s0">or</span>
            <span class="s1">distance</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">world_transform</span><span class="s2">[</span><span class="s4">2</span><span class="s2">], </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">_original_world_transform</span><span class="s2">[</span><span class="s4">2</span><span class="s2">]) &gt; </span><span class="s4">.0001</span>
            <span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">record_undo </span><span class="s0">and </span><span class="s1">changed</span><span class="s2">:</span>
            <span class="s1">changes </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">changes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">([</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">e</span><span class="s2">), </span><span class="s3">'world_transform'</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">_original_world_transform</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">world_transform</span><span class="s2">])</span>

            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">undo</span><span class="s2">.</span><span class="s1">record_undo</span><span class="s2">(</span><span class="s1">changes</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">parent </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">arrow_parent</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= (</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rotation </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">original_rotation</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">input</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'control'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">step </span><span class="s2">= (</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'control up'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">step </span><span class="s2">= (</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)</span>



<span class="s0">class </span><span class="s1">Gizmo</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">arrow_parent </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">lock_axis_helper_parent </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">,</span>
            <span class="s5"># model='wireframe_cube',</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">lock_axis_helper </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lock_axis_helper_parent</span><span class="s2">,</span>
            <span class="s5"># model=Circle(6, radius=.2), color=color.red, double_sided=True, always_on_top=True, render_queue=1</span>
        <span class="s2">) </span><span class="s5"># this will help us lock the movement to an axis on local space</span>


        <span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos </span><span class="s2">= {</span>
            <span class="s3">'xz' </span><span class="s2">: </span><span class="s1">GizmoArrow</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">arrow_parent</span><span class="s2">, </span><span class="s1">gizmo</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'cube'</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'plane'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">.6</span><span class="s2">, </span><span class="s1">scale_y</span><span class="s2">=</span><span class="s4">.05</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.75</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,-</span><span class="s4">.75</span><span class="s2">), </span><span class="s1">color</span><span class="s2">=</span><span class="s1">lerp</span><span class="s2">(</span><span class="s1">color</span><span class="s2">.</span><span class="s1">magenta</span><span class="s2">, </span><span class="s1">color</span><span class="s2">.</span><span class="s1">cyan</span><span class="s2">, </span><span class="s4">.5</span><span class="s2">), </span><span class="s1">plane_direction</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)),</span>
            <span class="s3">'x'  </span><span class="s2">: </span><span class="s1">GizmoArrow</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">arrow_parent</span><span class="s2">, </span><span class="s1">gizmo</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">axis_colors</span><span class="s2">[</span><span class="s3">'x'</span><span class="s2">], </span><span class="s1">lock</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">)),</span>
            <span class="s3">'y'  </span><span class="s2">: </span><span class="s1">GizmoArrow</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">arrow_parent</span><span class="s2">, </span><span class="s1">gizmo</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rotation</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,-</span><span class="s4">90</span><span class="s2">), </span><span class="s1">color</span><span class="s2">=</span><span class="s1">axis_colors</span><span class="s2">[</span><span class="s3">'y'</span><span class="s2">], </span><span class="s1">lock</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">)),</span>
            <span class="s3">'z'  </span><span class="s2">: </span><span class="s1">GizmoArrow</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">arrow_parent</span><span class="s2">, </span><span class="s1">gizmo</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rotation</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">,-</span><span class="s4">90</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">color</span><span class="s2">=</span><span class="s1">axis_colors</span><span class="s2">[</span><span class="s3">'z'</span><span class="s2">], </span><span class="s1">plane_direction</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">lock</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)),</span>
        <span class="s2">}</span>

        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arrow_parent</span><span class="s2">.</span><span class="s1">children</span><span class="s2">:</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">highlight_color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">white</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">original_scale </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">scale</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">fake_gizmo </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fake_gizmo</span><span class="s2">.</span><span class="s1">subgizmos </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">fake_gizmo</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">duplicate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s1">key</span><span class="s2">], </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fake_gizmo</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">ignore</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):   </span><span class="s5"># this will execute before GizmoArrow drag()</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'left mouse down' </span><span class="s0">and </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">hovered_entity </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">drag</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'left mouse up' </span><span class="s0">and </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">local_global_menu</span><span class="s2">.</span><span class="s1">value </span><span class="s2">== </span><span class="s3">'local'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">drag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">show_gizmo_while_dragging</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s3">'xyz'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s1">axis</span><span class="s2">].</span><span class="s1">plane_direction </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">up</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s1">axis</span><span class="s2">].</span><span class="s1">lock </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">local_global_menu</span><span class="s2">.</span><span class="s1">value </span><span class="s2">== </span><span class="s3">'global'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s1">axis</span><span class="s2">].</span><span class="s1">lock </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">]</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s1">axis</span><span class="s2">].</span><span class="s1">lock</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s4">0</span>

            <span class="s0">if </span><span class="s1">axis </span><span class="s2">== </span><span class="s3">'y'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s1">axis</span><span class="s2">].</span><span class="s1">plane_direction </span><span class="s2">= </span><span class="s1">camera</span><span class="s2">.</span><span class="s1">back</span>


        <span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s3">'xz'</span><span class="s2">].</span><span class="s1">plane_direction </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">up</span>
        <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'visible_self'</span><span class="s2">, </span><span class="s1">show_gizmo_while_dragging</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()]</span>


        <span class="s5"># use fake gizmo technique to lock movement to local axis. if in global mode, skip this and use the old simpler way.</span>
        <span class="s0">if </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">local_global_menu</span><span class="s2">.</span><span class="s1">value </span><span class="s2">== </span><span class="s3">'local'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">lock_axis_helper_parent</span><span class="s2">.</span><span class="s1">world_transform </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">world_transform</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">lock_axis_helper</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= (</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">fake_gizmo</span><span class="s2">.</span><span class="s1">world_transform </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">world_transform</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">fake_gizmo</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">visible </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'visible_self'</span><span class="s2">, </span><span class="s1">show_gizmo_while_dragging</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fake_gizmo</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()]</span>
            <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'visible_self'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()]</span>


    <span class="s0">def </span><span class="s1">drop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fake_gizmo</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">visible </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'visible_self'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fake_gizmo</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()]</span>
        <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'visible_self'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()]</span>
        <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'scale'</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">original_scale</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()]</span>


    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'r'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'s'</span><span class="s2">]:</span>
            <span class="s0">return</span>
        <span class="s5"># self.world_scale = distance(self.world_position, camera.world_position) * camera.fov * .0005</span>

        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s3">'xyz'</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s1">axis</span><span class="s2">].</span><span class="s1">dragging</span><span class="s2">:</span>
                <span class="s1">setattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lock_axis_helper</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s1">axis</span><span class="s2">].</span><span class="s1">get_position</span><span class="s2">(</span><span class="s1">relative_to</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lock_axis_helper_parent</span><span class="s2">)[</span><span class="s1">i</span><span class="s2">])</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">fake_gizmo</span><span class="s2">.</span><span class="s1">world_position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lock_axis_helper</span><span class="s2">.</span><span class="s1">world_position</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s3">'xz'</span><span class="s2">].</span><span class="s1">dragging</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">fake_gizmo</span><span class="s2">.</span><span class="s1">world_position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s3">'xz'</span><span class="s2">].</span><span class="s1">world_position</span>



<span class="s0">class </span><span class="s1">RotationGizmo</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">RotationGizmo</span><span class="s2">.</span><span class="s1">model</span><span class="s2">:</span>
            <span class="s1">RotationGizmo</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">load_model</span><span class="s2">(</span><span class="s3">'rotation_gizmo_model'</span><span class="s2">, </span><span class="s1">application</span><span class="s2">.</span><span class="s1">internal_models_compressed_folder</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">RotationGizmo</span><span class="s2">.</span><span class="s1">model</span><span class="s2">:</span>
                <span class="s1">path </span><span class="s2">= </span><span class="s1">Circle</span><span class="s2">(</span><span class="s4">24</span><span class="s2">).</span><span class="s1">vertices</span>
                <span class="s1">path</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">path</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>
                <span class="s1">RotationGizmo</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">Pipe</span><span class="s2">(</span><span class="s1">base_shape</span><span class="s2">=</span><span class="s1">Quad</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s4">0</span><span class="s2">), </span><span class="s1">path</span><span class="s2">=[</span><span class="s1">Vec3</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)*</span><span class="s4">32 </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">path</span><span class="s2">])</span>
                <span class="s1">RotationGizmo</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s3">'rotation_gizmo_model.ursinamesh'</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">)/</span><span class="s3">'models_compressed'</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">rotator </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">axis </span><span class="s2">= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sensitivity </span><span class="s2">= </span><span class="s4">36000</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dragging </span><span class="s2">= </span><span class="s0">False</span>



        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">dir </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">((</span><span class="s1">Vec3</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,-</span><span class="s4">1</span><span class="s2">))):</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">Button</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">RotationGizmo</span><span class="s2">.</span><span class="s1">model</span><span class="s2">), </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'mesh'</span><span class="s2">,</span>
                <span class="s1">color</span><span class="s2">=</span><span class="s1">axis_colors</span><span class="s2">[(</span><span class="s3">'x'</span><span class="s2">,</span><span class="s3">'y'</span><span class="s2">,</span><span class="s3">'z'</span><span class="s2">)[</span><span class="s1">i</span><span class="s2">]], </span><span class="s1">is_gizmo</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">always_on_top</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">render_queue</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">unlit</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">double_sided</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                <span class="s1">on_click</span><span class="s2">=</span><span class="s1">Sequence</span><span class="s2">(</span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s3">'axis'</span><span class="s2">, </span><span class="s1">dir</span><span class="s2">), </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">drag</span><span class="s2">)),</span>
                <span class="s1">drop</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">,</span>
                <span class="s1">name</span><span class="s2">=</span><span class="s3">f'rotation_gizmo_</span><span class="s0">{</span><span class="s3">&quot;xyz&quot;</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span><span class="s0">}</span><span class="s3">'</span><span class="s2">,</span>
                <span class="s1">scale</span><span class="s2">=</span><span class="s4">1</span><span class="s2">/</span><span class="s4">32</span>
                <span class="s2">)</span>
            <span class="s1">b</span><span class="s2">.</span><span class="s1">look_at</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">)</span>
            <span class="s1">b</span><span class="s2">.</span><span class="s1">original_color </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">color</span>
            <span class="s1">b</span><span class="s2">.</span><span class="s1">start_dragging </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">on_click   </span><span class="s5"># for the quick rotate</span>
            <span class="s1">b</span><span class="s2">.</span><span class="s1">on_mouse_enter </span><span class="s2">= </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s3">'color'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">.</span><span class="s1">white</span><span class="s2">)</span>
            <span class="s1">b</span><span class="s2">.</span><span class="s1">on_mouse_exit </span><span class="s2">= </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s3">'color'</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">original_color</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s3">'xyz'</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]] = </span><span class="s1">b</span>


    <span class="s0">def </span><span class="s1">drag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rotator</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">scene</span>
        <span class="s5"># print('drag')</span>
        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rotator</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">_original_world_transform </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">world_transform</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dragging </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">drop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># print('drop')</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rotator</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span>
        <span class="s1">changes </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">original_parent</span>
            <span class="s1">changes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">([</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">e</span><span class="s2">), </span><span class="s3">'world_transform'</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">_original_world_transform</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">world_transform</span><span class="s2">])</span>

        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">undo</span><span class="s2">.</span><span class="s1">record_undo</span><span class="s2">(</span><span class="s1">changes</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dragging </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rotator</span><span class="s2">.</span><span class="s1">rotation </span><span class="s2">= (</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'left mouse up' </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dragging</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">dragging </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dragging</span><span class="s2">:</span>
            <span class="s1">rotation_amount </span><span class="s2">= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">velocity</span><span class="s2">), </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">velocity</span><span class="s2">), </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">velocity</span><span class="s2">)) * </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sensitivity </span><span class="s2">* </span><span class="s1">time</span><span class="s2">.</span><span class="s1">dt </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">axis </span><span class="s2">* </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,-</span><span class="s4">1</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">origin_mode_menu</span><span class="s2">.</span><span class="s1">value </span><span class="s2">== </span><span class="s3">'individual'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">rotator</span><span class="s2">.</span><span class="s1">rotation </span><span class="s2">-= </span><span class="s1">rotation_amount</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                    <span class="s1">e</span><span class="s2">.</span><span class="s1">rotation </span><span class="s2">-= </span><span class="s1">rotation_amount</span>




<span class="s0">class </span><span class="s1">ScaleGizmo</span><span class="s2">(</span><span class="s1">Draggable</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'cube'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">.25</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">orange</span><span class="s2">, </span><span class="s1">visible</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">always_on_top</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">render_queue</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">is_gizmo</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">dragging</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">shader</span><span class="s2">=</span><span class="s1">unlit_shader</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scaler </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">axis </span><span class="s2">= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">on_click </span><span class="s2">= </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s3">'axis'</span><span class="s2">, </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sensitivity </span><span class="s2">= </span><span class="s4">300</span>

        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">dir </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">((</span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">))):</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">Button</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'scale_gizmo'</span><span class="s2">, </span><span class="s1">origin_z</span><span class="s2">=-</span><span class="s4">.5</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'box'</span><span class="s2">,</span>
                <span class="s1">color</span><span class="s2">=</span><span class="s1">axis_colors</span><span class="s2">[(</span><span class="s3">'x'</span><span class="s2">,</span><span class="s3">'y'</span><span class="s2">,</span><span class="s3">'z'</span><span class="s2">)[</span><span class="s1">i</span><span class="s2">]], </span><span class="s1">is_gizmo</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">always_on_top</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">render_queue</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">shader</span><span class="s2">=</span><span class="s1">unlit_shader</span><span class="s2">,</span>
                <span class="s1">on_click</span><span class="s2">=</span><span class="s1">Sequence</span><span class="s2">(</span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s3">'axis'</span><span class="s2">, </span><span class="s1">dir</span><span class="s2">), </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">drag</span><span class="s2">)), </span><span class="s1">name</span><span class="s2">=</span><span class="s3">f'scale_gizmo_</span><span class="s0">{</span><span class="s3">&quot;xyz&quot;</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
            <span class="s1">b</span><span class="s2">.</span><span class="s1">look_at</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s3">'xyz'</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]] = </span><span class="s1">b</span>


    <span class="s0">def </span><span class="s1">drag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scaler</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">_original_world_transform </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">world_transform</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dragging </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">drop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">changes </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">original_parent</span>
            <span class="s1">changes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">([</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">e</span><span class="s2">), </span><span class="s3">'world_transform'</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">_original_world_transform</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">world_transform</span><span class="s2">])</span>

        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">undo</span><span class="s2">.</span><span class="s1">record_undo</span><span class="s2">(</span><span class="s1">changes</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dragging </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scaler</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">= </span><span class="s4">1</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>



    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dragging</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">origin_mode_menu</span><span class="s2">.</span><span class="s1">value </span><span class="s2">== </span><span class="s3">'individual'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">scaler</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">+= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">velocity</span><span class="s2">), </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">velocity</span><span class="s2">), </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">velocity</span><span class="s2">)) * </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sensitivity </span><span class="s2">* </span><span class="s1">time</span><span class="s2">.</span><span class="s1">dt </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">axis</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                    <span class="s1">e</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">+= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">velocity</span><span class="s2">), </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">velocity</span><span class="s2">), </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">velocity</span><span class="s2">)) * </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sensitivity </span><span class="s2">* </span><span class="s1">time</span><span class="s2">.</span><span class="s1">dt </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">axis</span>

<span class="s0">class </span><span class="s1">BoxGizmo</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scaler </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">helper </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'cube'</span><span class="s2">, </span><span class="s1">unlit</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">azure</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sensitivity </span><span class="s2">= </span><span class="s4">600</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scale_from_center </span><span class="s2">= </span><span class="s0">False    </span><span class="s5"># scale from center if holding alt</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">normal </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">axis_name </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'a'</span><span class="s2">:</span>
            <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'collision'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">]</span>
            <span class="s1">mouse</span><span class="s2">.</span><span class="s1">update</span><span class="s2">()</span>

            <span class="s0">if </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">hovered_entity </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities </span><span class="s0">and </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">normal </span><span class="s0">and </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">normal </span><span class="s2">!= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">hovered_entity</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">_original_world_transform </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">world_transform</span>
                <span class="s5"># self.target.original_parent = self.target.parent</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">normal </span><span class="s2">= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">axis_name </span><span class="s2">= </span><span class="s3">'xyz'</span><span class="s2">[[</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">].</span><span class="s1">index</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)]</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">scale_from_center </span><span class="s2">= </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'alt'</span><span class="s2">]</span>
                <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scale_from_center</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">scaler</span><span class="s2">.</span><span class="s1">parent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">scaler</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= -</span><span class="s1">self</span><span class="s2">.</span><span class="s1">normal </span><span class="s2">* </span><span class="s4">.5</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">scaler</span><span class="s2">.</span><span class="s1">rotation </span><span class="s2">= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">scaler</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">self</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">scaler</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">world_position</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">scaler</span><span class="s2">.</span><span class="s1">rotation </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">world_rotation</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scaler</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">helper</span><span class="s2">.</span><span class="s1">parent </span><span class="s2">= </span><span class="s1">self</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">helper</span><span class="s2">.</span><span class="s1">parent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">helper</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">normal </span><span class="s2">/ </span><span class="s4">2</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">helper</span><span class="s2">.</span><span class="s1">rotation </span><span class="s2">= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">helper</span><span class="s2">.</span><span class="s1">world_scale </span><span class="s2">= </span><span class="s4">.05</span>

                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">local_global_menu</span><span class="s2">.</span><span class="s1">original_value </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">local_global_menu</span><span class="s2">.</span><span class="s1">value</span>
                <span class="s0">if not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">local_global_menu</span><span class="s2">.</span><span class="s1">value </span><span class="s2">== </span><span class="s3">'local'</span><span class="s2">:</span>
                    <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">local_global_menu</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s3">'local'</span>

                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">helper</span><span class="s2">, ]</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">drag</span><span class="s2">(</span><span class="s1">show_gizmo_while_dragging</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">axis_name</span><span class="s2">].</span><span class="s1">start_dragging</span><span class="s2">()</span>


        <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'a up' </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">:</span>
            <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'collision'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">original_parent</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">normal </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">helper</span><span class="s2">.</span><span class="s1">parent </span><span class="s2">= </span><span class="s1">self</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">scaler</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">= </span><span class="s4">1</span>

            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">()</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">axis_name</span><span class="s2">].</span><span class="s1">record_undo </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">axis_name</span><span class="s2">].</span><span class="s1">stop_dragging</span><span class="s2">()</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">axis_name</span><span class="s2">].</span><span class="s1">record_undo </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= []</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">local_global_menu</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">local_global_menu</span><span class="s2">.</span><span class="s1">original_value</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">helper</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>

            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">undo</span><span class="s2">.</span><span class="s1">record_undo</span><span class="s2">([(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">), </span><span class="s3">'world_transform'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">_original_world_transform</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">world_transform</span><span class="s2">), ])</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s0">None</span>


    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target </span><span class="s0">and </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">helper </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scaler</span><span class="s2">:</span>
            <span class="s1">relative_position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">helper</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">(</span><span class="s1">relative_to</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scaler</span><span class="s2">)</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">relative_position</span><span class="s2">[[</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">].</span><span class="s1">index</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)])</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scale_from_center</span><span class="s2">:</span>
                <span class="s1">value </span><span class="s2">*= </span><span class="s4">2</span>

            <span class="s1">setattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">, </span><span class="s3">f'scale_</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">axis_name</span><span class="s0">}</span><span class="s3">'</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>

            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scale_from_center</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">world_position </span><span class="s2">= </span><span class="s1">lerp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scaler</span><span class="s2">.</span><span class="s1">world_position</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">helper</span><span class="s2">.</span><span class="s1">world_position</span><span class="s2">, </span><span class="s4">.5</span><span class="s2">)</span>




<span class="s0">class </span><span class="s1">GizmoToggler</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">animator </span><span class="s2">= </span><span class="s1">Animator</span><span class="s2">({</span>
            <span class="s3">'w' </span><span class="s2">: </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">arrow_parent</span><span class="s2">,</span>
            <span class="s3">'e' </span><span class="s2">: </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scale_gizmo</span><span class="s2">,</span>
            <span class="s3">'u' </span><span class="s2">: </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">rotation_gizmo</span><span class="s2">,</span>
            <span class="s5"># 't' : box_gizmo,</span>

            <span class="s3">'q' </span><span class="s2">: </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s2">})</span>

    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s1">key </span><span class="s2">= </span><span class="s1">input_handler</span><span class="s2">.</span><span class="s1">get_combined_key</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">animator</span><span class="s2">.</span><span class="s1">animations </span><span class="s0">and not </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">left</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">animator</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">key</span>


<span class="s0">class </span><span class="s1">QuickGrabber</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">target_axis </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">plane </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">model</span><span class="s2">=</span><span class="s3">'quad'</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'box'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">999</span><span class="s2">,</span><span class="s4">999</span><span class="s2">,</span><span class="s4">1</span><span class="s2">), </span><span class="s1">visible_self</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">offset_helper </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">start_position </span><span class="s2">= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_dragging </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts </span><span class="s2">= {</span>
            <span class="s3">'left mouse down'</span><span class="s2">: </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_moving_on_axis</span><span class="s2">, </span><span class="s3">'xz'</span><span class="s2">),</span>
            <span class="s3">'d'</span><span class="s2">: </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_moving_on_axis</span><span class="s2">, </span><span class="s3">'xz'</span><span class="s2">),</span>
            <span class="s3">'w'</span><span class="s2">: </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_moving_on_axis</span><span class="s2">, </span><span class="s3">'xz'</span><span class="s2">, </span><span class="s1">auto_select_hovered_entity</span><span class="s2">=</span><span class="s0">False</span><span class="s2">),</span>
            <span class="s3">'x'</span><span class="s2">: </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_moving_on_axis</span><span class="s2">, </span><span class="s3">'x'</span><span class="s2">),</span>
            <span class="s3">'y'</span><span class="s2">: </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_moving_on_axis</span><span class="s2">, </span><span class="s3">'y'</span><span class="s2">),</span>
            <span class="s3">'z'</span><span class="s2">: </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_moving_on_axis</span><span class="s2">, </span><span class="s3">'z'</span><span class="s2">),</span>
            <span class="s2">}</span>

    <span class="s0">def </span><span class="s1">start_moving_on_axis</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">auto_select_hovered_entity</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">auto_select_hovered_entity </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">) &gt; </span><span class="s4">1</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selector</span><span class="s2">.</span><span class="s1">get_hovered_entity</span><span class="s2">()</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s5"># print('MOVE ON AXIS', axis)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">:</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">, ]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">plane</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">plane</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">world_position</span>

            <span class="s0">if </span><span class="s1">axis </span><span class="s2">== </span><span class="s3">'y' </span><span class="s0">or </span><span class="s1">axis </span><span class="s2">== </span><span class="s3">'xy'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">plane</span><span class="s2">.</span><span class="s1">look_at</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">plane</span><span class="s2">.</span><span class="s1">position </span><span class="s2">+ </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,-</span><span class="s4">1</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">plane</span><span class="s2">.</span><span class="s1">look_at</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">plane</span><span class="s2">.</span><span class="s1">position </span><span class="s2">+ </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">))</span>

            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">) &gt; </span><span class="s4">1</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">]</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock </span><span class="s2">= [</span><span class="s1">axis</span><span class="s2">!=</span><span class="s3">'x'</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">!=</span><span class="s3">'y'</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">!=</span><span class="s3">'z'</span><span class="s2">]</span>

            <span class="s1">mouse</span><span class="s2">.</span><span class="s1">traverse_target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">plane</span>
            <span class="s1">mouse</span><span class="s2">.</span><span class="s1">update</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">offset_helper</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">world_point</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">start_position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">offset_helper</span><span class="s2">.</span><span class="s1">world_position</span>

            <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">, </span><span class="s3">'is_gizmo'</span><span class="s2">) </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">is_gizmo </span><span class="s2">== </span><span class="s0">False</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">original_parent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">parent</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">original_parent </span><span class="s2">= </span><span class="s1">scene</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">_original_world_position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">world_position</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">offset_helper</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">is_dragging </span><span class="s2">= </span><span class="s0">True</span>


    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">key</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">' up'</span><span class="s2">) </span><span class="s0">and </span><span class="s2">(</span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'alt'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'s'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">right </span><span class="s0">or </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">middle </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'r'</span><span class="s2">]):</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'left mouse up' </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity </span><span class="s0">and </span><span class="s1">distance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">_original_world_position</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">world_position</span><span class="s2">) &lt; </span><span class="s4">.1 </span><span class="s0">and </span><span class="s2">(</span><span class="s1">time</span><span class="s2">.</span><span class="s1">time</span><span class="s2">()-</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">prev_click_time</span><span class="s2">) &lt; </span><span class="s4">.5</span><span class="s2">:  </span><span class="s5"># prevent accidentally moving the entity when you meant to select it</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">is_dragging </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">mouse</span><span class="s2">.</span><span class="s1">traverse_target </span><span class="s2">= </span><span class="s1">scene</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">original_parent</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">world_position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">_original_world_position</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">, ]</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">plane</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">:</span>
                <span class="s0">return</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]()</span>

        <span class="s0">elif </span><span class="s2">(</span><span class="s1">key </span><span class="s0">in </span><span class="s2">[</span><span class="s3">f'</span><span class="s0">{</span><span class="s1">e</span><span class="s0">} </span><span class="s3">up' </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()] </span><span class="s0">or </span><span class="s3">'left mouse down' </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shortcuts </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'left mouse up'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">drop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_dragging </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">mouse</span><span class="s2">.</span><span class="s1">traverse_target </span><span class="s2">= </span><span class="s1">scene</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">original_parent</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">world_position </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">_original_world_position</span><span class="s2">:</span>
            <span class="s1">changes </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">changes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">([</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">e</span><span class="s2">), </span><span class="s3">'world_position'</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">_original_world_position</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">world_position</span><span class="s2">])</span>

            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">undo</span><span class="s2">.</span><span class="s1">record_undo</span><span class="s2">(</span><span class="s1">changes</span><span class="s2">)</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= []</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">, ]</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">plane</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>


    <span class="s0">def </span><span class="s1">on_disable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_dragging </span><span class="s0">or not </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">world_point</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">right</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s1">pos </span><span class="s2">= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">world_point</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">]:</span>
            <span class="s1">pos </span><span class="s2">= </span><span class="s1">round</span><span class="s2">(</span><span class="s1">pos</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">e </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">pos</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]:</span>
                <span class="s1">pos</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_position</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">offset_helper</span><span class="s2">.</span><span class="s1">world_position </span><span class="s2">= </span><span class="s1">pos</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">]:</span>
            <span class="s1">snap_step </span><span class="s2">= </span><span class="s4">1</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">offset_helper</span><span class="s2">.</span><span class="s1">world_position </span><span class="s2">= </span><span class="s1">Vec3</span><span class="s2">(*[</span><span class="s1">round</span><span class="s2">(</span><span class="s1">e </span><span class="s2">* </span><span class="s1">snap_step</span><span class="s2">) /</span><span class="s1">snap_step </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">offset_helper</span><span class="s2">.</span><span class="s1">world_position</span><span class="s2">])</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">world_position </span><span class="s2">= </span><span class="s1">Vec3</span><span class="s2">(*[</span><span class="s1">round</span><span class="s2">(</span><span class="s1">e </span><span class="s2">* </span><span class="s1">snap_step</span><span class="s2">) /</span><span class="s1">snap_step </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">world_position</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">QuickScaler</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span>
            <span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">,</span>
            <span class="s1">gizmos_to_toggle</span><span class="s2">={</span>
                <span class="s3">'s' </span><span class="s2">:  </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scale_gizmo</span><span class="s2">,</span>
                <span class="s3">'sx' </span><span class="s2">: </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scale_gizmo</span><span class="s2">,</span>
                <span class="s3">'sy' </span><span class="s2">: </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scale_gizmo</span><span class="s2">,</span>
                <span class="s3">'sz' </span><span class="s2">: </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scale_gizmo</span><span class="s2">,</span>
            <span class="s2">},</span>
            <span class="s1">clear_selection</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">dragging</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">original_gizmo_state</span><span class="s2">=</span><span class="s3">'q'</span>
            <span class="s2">)</span>


    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'alt'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">left </span><span class="s0">or </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">middle </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'r'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'d'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'t'</span><span class="s2">]:</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s2">(</span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'x'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'y'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'z'</span><span class="s2">]) </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'s'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">original_gizmo_state </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo_toggler</span><span class="s2">.</span><span class="s1">animator</span><span class="s2">.</span><span class="s1">state</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'s'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">key </span><span class="s0">in </span><span class="s3">'xyz'</span><span class="s2">:</span>
            <span class="s1">key </span><span class="s2">= </span><span class="s3">'s' </span><span class="s2">+ </span><span class="s1">key</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s2">(</span><span class="s3">'s'</span><span class="s2">, </span><span class="s3">'sx'</span><span class="s2">, </span><span class="s3">'sy'</span><span class="s2">, </span><span class="s3">'sz'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">original_gizmo_state </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo_toggler</span><span class="s2">.</span><span class="s1">animator</span><span class="s2">.</span><span class="s1">state</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo_toggler</span><span class="s2">.</span><span class="s1">animator</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s3">'e'</span>

            <span class="s0">if not </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'s'</span><span class="s2">:</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scale_gizmo</span><span class="s2">.</span><span class="s1">axis </span><span class="s2">= (</span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">))[(</span><span class="s3">'sx'</span><span class="s2">, </span><span class="s3">'sy'</span><span class="s2">, </span><span class="s3">'sz'</span><span class="s2">).</span><span class="s1">index</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)]</span>


        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gizmos_to_toggle</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">():</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selector</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection_box</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>

            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">arrow_parent</span><span class="s2">.</span><span class="s1">visible </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scale_gizmo</span><span class="s2">.</span><span class="s1">visible </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">gizmos_to_toggle</span><span class="s2">[</span><span class="s1">key</span><span class="s2">].</span><span class="s1">visible_self </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s0">if not </span><span class="s1">key </span><span class="s0">in </span><span class="s2">(</span><span class="s3">'sx'</span><span class="s2">, </span><span class="s3">'sy'</span><span class="s2">, </span><span class="s3">'sz'</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">clear_selection </span><span class="s2">= </span><span class="s0">not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span>

            <span class="s0">if not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selector</span><span class="s2">.</span><span class="s1">input</span><span class="s2">(</span><span class="s3">'left mouse down'</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">gizmos_to_toggle</span><span class="s2">[</span><span class="s1">key</span><span class="s2">].</span><span class="s1">input</span><span class="s2">(</span><span class="s3">'left mouse down'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">gizmos_to_toggle</span><span class="s2">[</span><span class="s1">key</span><span class="s2">].</span><span class="s1">start_dragging</span><span class="s2">()</span>


        <span class="s5"># print('------------', key)</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s2">(</span><span class="s3">'s up'</span><span class="s2">, </span><span class="s3">'x up'</span><span class="s2">, </span><span class="s3">'y up'</span><span class="s2">, </span><span class="s3">'z up'</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gizmos_to_toggle</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">input</span><span class="s2">(</span><span class="s3">'left mouse up'</span><span class="s2">)</span>
            <span class="s5"># self.gizmos_to_toggle[key].drop()</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">clear_selection</span><span class="s2">:</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>

            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">arrow_parent</span><span class="s2">.</span><span class="s1">visible </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scale_gizmo</span><span class="s2">.</span><span class="s1">visible </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scale_gizmo</span><span class="s2">.</span><span class="s1">axis </span><span class="s2">= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">)</span>
            <span class="s5"># self.gizmos_to_toggle[key].visible_self = True</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo_toggler</span><span class="s2">.</span><span class="s1">animator</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">original_gizmo_state</span>

            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selector</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection_box</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">mouse</span><span class="s2">.</span><span class="s1">traverse_target </span><span class="s2">= </span><span class="s1">scene</span>


    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gizmos_to_toggle</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">velocity </span><span class="s2">!= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">):</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">(</span><span class="s1">update_gizmo_position</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s0">return</span>


<span class="s0">class </span><span class="s1">QuickRotator</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'alt'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'s'</span><span class="s2">]:</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'r' </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">) &lt;= </span><span class="s4">1</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selector</span><span class="s2">.</span><span class="s1">get_hovered_entity</span><span class="s2">(), ]</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>

            <span class="s0">if not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s0">return</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">rotation_gizmo</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s3">'y'</span><span class="s2">].</span><span class="s1">input</span><span class="s2">(</span><span class="s3">'left mouse down'</span><span class="s2">)</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">rotation_gizmo</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s3">'y'</span><span class="s2">].</span><span class="s1">start_dragging</span><span class="s2">()</span>

        <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'r up' </span><span class="s0">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'target_entity'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">:</span>
            <span class="s1">key </span><span class="s2">= </span><span class="s1">key</span><span class="s2">[:-</span><span class="s4">3</span><span class="s2">]</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">rotation_gizmo</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s3">'y'</span><span class="s2">].</span><span class="s1">input</span><span class="s2">(</span><span class="s3">'left mouse up'</span><span class="s2">)</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">rotation_gizmo</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s3">'y'</span><span class="s2">].</span><span class="s1">drop</span><span class="s2">()</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'r'</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">velocity </span><span class="s2">!= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">):</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">(</span><span class="s1">update_gizmo_position</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s0">return</span>


<span class="s0">class </span><span class="s1">RotateRelativeToView</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s1">_rotation_helper </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">'RotateRelativeToView_rotation_helper'</span><span class="s2">, </span><span class="s1">add_to_scene_entities</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">sensitivity </span><span class="s2">= </span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">200</span><span class="s2">,</span><span class="s4">200</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'alt'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'s'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'r'</span><span class="s2">]:</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'t'</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">) &gt; </span><span class="s4">1</span><span class="s2">:</span>
                <span class="s0">return</span>

            <span class="s0">if not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selector</span><span class="s2">.</span><span class="s1">get_hovered_entity</span><span class="s2">(), ]</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>

            <span class="s0">if not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s0">return</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
            <span class="s1">__class__</span><span class="s2">.</span><span class="s1">_rotation_helper</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">scene</span>
            <span class="s1">__class__</span><span class="s2">.</span><span class="s1">_rotation_helper</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">world_position</span>
            <span class="s1">__class__</span><span class="s2">.</span><span class="s1">_rotation_helper</span><span class="s2">.</span><span class="s1">rotation </span><span class="s2">= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">_entity_original_parent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">parent</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_entity_original_rotation </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">world_rotation</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">_rotation_helper</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_mouse_start_x </span><span class="s2">= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">x</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_mouse_start_y </span><span class="s2">= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">y</span>

        <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'t up' </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_entity_original_parent</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">x_mov </span><span class="s2">= </span><span class="s4">0</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">y_mov </span><span class="s2">= </span><span class="s4">0</span>

    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_entity </span><span class="s0">and </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'t'</span><span class="s2">]:</span>
            <span class="s1">__class__</span><span class="s2">.</span><span class="s1">_rotation_helper</span><span class="s2">.</span><span class="s1">rotation_y </span><span class="s2">-= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">velocity</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] * </span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">sensitivity</span><span class="s2">.</span><span class="s1">x </span><span class="s2">/ </span><span class="s1">camera</span><span class="s2">.</span><span class="s1">aspect_ratio</span>
            <span class="s1">__class__</span><span class="s2">.</span><span class="s1">_rotation_helper</span><span class="s2">.</span><span class="s1">rotation_x </span><span class="s2">+= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">velocity</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] * </span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">sensitivity</span><span class="s2">.</span><span class="s1">y</span>




<span class="s0">class </span><span class="s1">Selector</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'left mouse down'</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">hovered_entity</span><span class="s2">:</span>
                <span class="s5"># print('sroifjseofisjeoij')</span>
                <span class="s0">return</span>

            <span class="s1">clicked_entity </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_hovered_entity</span><span class="s2">()</span>

            <span class="s0">if </span><span class="s1">clicked_entity </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'alt'</span><span class="s2">]:</span>
                <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">]:</span>
                    <span class="s0">if not </span><span class="s1">clicked_entity </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">clicked_entity</span><span class="s2">) </span><span class="s5"># append</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">clicked_entity</span><span class="s2">, ]   </span><span class="s5"># overwrite</span>

            <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'alt'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">clicked_entity </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">clicked_entity</span><span class="s2">) </span><span class="s5"># remove</span>

            <span class="s0">if not </span><span class="s1">clicked_entity </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'alt'</span><span class="s2">]: </span><span class="s5"># clear</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>

            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'a'</span><span class="s2">:</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">e </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">]</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>

        <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'h'</span><span class="s2">:</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">point_renderer</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">point_renderer</span><span class="s2">.</span><span class="s1">enabled</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'left mouse up'</span><span class="s2">:</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">)</span>



    <span class="s0">def </span><span class="s1">get_hovered_entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities </span><span class="s2">= [</span><span class="s1">e </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities </span><span class="s0">if </span><span class="s1">e</span><span class="s2">]</span>
        <span class="s5"># [print(str(e)) for e in LEVEL_EDITOR.entities]</span>
        <span class="s1">entities_in_range </span><span class="s2">= [(</span><span class="s1">distance_2d</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">screen_position</span><span class="s2">, </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">position</span><span class="s2">), </span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities </span><span class="s0">if </span><span class="s1">e </span><span class="s0">and </span><span class="s1">e</span><span class="s2">.</span><span class="s1">selectable </span><span class="s0">and not </span><span class="s1">e</span><span class="s2">.</span><span class="s1">collider</span><span class="s2">]</span>
        <span class="s1">entities_in_range </span><span class="s2">= [</span><span class="s1">e </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">entities_in_range </span><span class="s0">if </span><span class="s1">e</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] &lt; </span><span class="s4">.03</span><span class="s2">]</span>
        <span class="s1">entities_in_range</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">()</span>

        <span class="s1">clicked_entity </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">if </span><span class="s1">entities_in_range</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">entities_in_range</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">]</span>

        <span class="s5"># try getting entities with box collider</span>
        <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'collision'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities </span><span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'is_gizmo'</span><span class="s2">)]</span>
        <span class="s5"># print('-------------', len([e for e in LEVEL_EDITOR.entities  if not hasattr(e, 'is_gizmo') and e.collider and e.collision]))</span>
        <span class="s1">mouse</span><span class="s2">.</span><span class="s1">update</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">hovered_entity </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">:</span>

            <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'collision'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities </span><span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'is_gizmo'</span><span class="s2">)]</span>
            <span class="s0">return </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">hovered_entity</span>

        <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'collision'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities </span><span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'is_gizmo'</span><span class="s2">)]</span>



<span class="s0">class </span><span class="s1">SelectionBox</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">, </span><span class="s1">visible</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'left mouse down'</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">hovered_entity </span><span class="s0">and </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">hovered_entity </span><span class="s0">not in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s5"># print('-------', 'clicked on gizmo, dont box select')</span>
                <span class="s0">return</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">position</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">= </span><span class="s4">.001</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">visible </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">mode </span><span class="s2">= </span><span class="s3">'new'</span>
            <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">]:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">mode </span><span class="s2">= </span><span class="s3">'add'</span>
            <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'alt'</span><span class="s2">]:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">mode </span><span class="s2">= </span><span class="s3">'subtract'</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'left mouse up' </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">visible</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">visible </span><span class="s2">= </span><span class="s0">False</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scale_x </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">x </span><span class="s2">+= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scale_x</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">scale_x </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scale_x</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scale_y </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">y </span><span class="s2">+= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scale_y</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">scale_y </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scale_y</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scale_x </span><span class="s2">&lt; </span><span class="s4">.01 </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scale_y </span><span class="s2">&lt; </span><span class="s4">.01 </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'w'</span><span class="s2">]:</span>
                <span class="s0">return</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mode </span><span class="s2">== </span><span class="s3">'new'</span><span class="s2">:</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>

            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">:</span>
                <span class="s0">if not </span><span class="s1">e</span><span class="s2">.</span><span class="s1">selectable</span><span class="s2">:</span>
                    <span class="s0">continue</span>

                <span class="s1">pos </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">screen_position</span>
                <span class="s0">if </span><span class="s1">pos</span><span class="s2">.</span><span class="s1">x </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x </span><span class="s0">and </span><span class="s1">pos</span><span class="s2">.</span><span class="s1">x </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x </span><span class="s2">+ </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scale_x</span><span class="s2">) </span><span class="s0">and </span><span class="s1">pos</span><span class="s2">.</span><span class="s1">y </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y </span><span class="s0">and </span><span class="s1">pos</span><span class="s2">.</span><span class="s1">y </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y </span><span class="s2">+ </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scale_y</span><span class="s2">):</span>
                    <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mode </span><span class="s0">in </span><span class="s2">(</span><span class="s3">'add'</span><span class="s2">, </span><span class="s3">'new'</span><span class="s2">) </span><span class="s0">and not </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>
                    <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mode </span><span class="s2">== </span><span class="s3">'subtract' </span><span class="s0">and </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>

            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">mode </span><span class="s2">= </span><span class="s3">'new'</span>

    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">left</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">x </span><span class="s2">== </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">start_x </span><span class="s0">and </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">y </span><span class="s2">== </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">start_y</span><span class="s2">:</span>
                <span class="s0">return</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">scale_x </span><span class="s2">= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">x </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">scale_y </span><span class="s2">= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">y </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y</span>




<span class="s0">class </span><span class="s1">WhiteCube</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s1">default_values </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">.</span><span class="s1">default_values </span><span class="s2">| </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">model</span><span class="s2">=</span><span class="s3">'cube'</span><span class="s2">, </span><span class="s1">shader</span><span class="s2">=</span><span class="s3">'lit_with_shadows_shader'</span><span class="s2">, </span><span class="s1">texture</span><span class="s2">=</span><span class="s3">'white_cube'</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'box'</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">'cube'</span><span class="s2">) </span><span class="s5"># combine dicts</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">default_values </span><span class="s2">| </span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__deepcopy__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">memo</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">ClassSpawner</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s1">default_values </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">.</span><span class="s1">default_values </span><span class="s2">| </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">class_to_spawn</span><span class="s2">=</span><span class="s3">''</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'wireframe_cube'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">blue</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">'ClassSpawner'</span><span class="s2">) </span><span class="s5"># combine dicts</span>
    <span class="s3">'''Prefab for spawning target class on play'''</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">default_values </span><span class="s2">| </span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">class_instance </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">draw_inspector</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">{</span><span class="s3">'class_to_spawn'</span><span class="s2">: </span><span class="s1">type</span><span class="s2">}</span>

    <span class="s0">def </span><span class="s1">start</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">class_to_spawn </span><span class="s0">not in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">class_menu</span><span class="s2">.</span><span class="s1">available_classes</span><span class="s2">:</span>
            <span class="s1">print_warning</span><span class="s2">(</span><span class="s3">'class to spawn not found in LEVEL_EDITOR.class_menu.available_classes:'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">class_to_spawn</span><span class="s2">)</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">class_to_spawn</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">'spawn class'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">class_to_spawn</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">class_instance </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">class_menu</span><span class="s2">.</span><span class="s1">available_classes</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">class_to_spawn</span><span class="s2">](</span><span class="s1">world_transform</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">world_transform</span><span class="s2">, </span><span class="s1">add_to_scene_entities</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">stop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">class_instance</span><span class="s2">:</span>
            <span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">class_instance</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">class_instance </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">__deepcopy__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">memo</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TriplanarCube</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s1">default_values </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">.</span><span class="s1">default_values </span><span class="s2">| </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">model</span><span class="s2">=</span><span class="s3">'cube'</span><span class="s2">, </span><span class="s1">shader</span><span class="s2">=</span><span class="s3">'triplanar_shader'</span><span class="s2">, </span><span class="s1">texture</span><span class="s2">=</span><span class="s3">'white_cube'</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'box'</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">'cube'</span><span class="s2">) </span><span class="s5"># combine dicts</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">default_values </span><span class="s2">| </span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">set_shader_input</span><span class="s2">(</span><span class="s3">'top_texture'</span><span class="s2">, </span><span class="s1">load_texture</span><span class="s2">(</span><span class="s3">'brick'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">__deepcopy__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">memo</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">Pyramid</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s1">default_values </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">.</span><span class="s1">default_values </span><span class="s2">| </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">'pyramid'</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s1">Cone</span><span class="s2">(</span><span class="s4">4</span><span class="s2">), </span><span class="s1">texture</span><span class="s2">=</span><span class="s3">'brick'</span><span class="s2">) </span><span class="s5"># combine dicts</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">default_values </span><span class="s2">| </span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__deepcopy__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">memo</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">Rock</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s1">default_values </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">.</span><span class="s1">default_values </span><span class="s2">| </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">'rock'</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'procedural_rock_0'</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'box'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">hsv</span><span class="s2">(</span><span class="s4">20</span><span class="s2">,</span><span class="s4">.2</span><span class="s2">,</span><span class="s4">.45</span><span class="s2">)) </span><span class="s5"># combine dicts</span>
    <span class="s1">gizmo_color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">brown</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">default_values </span><span class="s2">| </span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__deepcopy__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">memo</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">Spawner</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ui </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">, </span><span class="s1">position</span><span class="s2">=</span><span class="s1">window</span><span class="s2">.</span><span class="s1">bottom</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">update_menu</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">update_menu</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">[</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">.</span><span class="s1">children</span><span class="s2">]</span>
        <span class="s5"># for file in LEVEL_EDITOR.prefab_folder.glob('**/*.py')</span>
        <span class="s1">import_all_classes</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">prefab_folder</span><span class="s2">, </span><span class="s1">debug</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s5"># LEVEL_EDITOR.prefabs =</span>

        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">prefab </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">built_in_prefabs</span><span class="s2">):</span>
            <span class="s1">button </span><span class="s2">= </span><span class="s1">Button</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">.075</span><span class="s2">/</span><span class="s4">2</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">' '</span><span class="s2">, </span><span class="s1">text_size</span><span class="s2">=</span><span class="s4">.5</span><span class="s2">, </span><span class="s1">on_click</span><span class="s2">=</span><span class="s1">Func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">spawn_entity</span><span class="s2">, </span><span class="s1">prefab</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">prefab</span><span class="s2">, </span><span class="s3">'icon'</span><span class="s2">):</span>
                <span class="s1">button</span><span class="s2">.</span><span class="s1">icon </span><span class="s2">= </span><span class="s1">prefab</span><span class="s2">.</span><span class="s1">icon</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">button</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">chunk_list</span><span class="s2">(</span><span class="s1">prefab</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s4">5</span><span class="s2">))</span>

        <span class="s1">grid_layout</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">.</span><span class="s1">children</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">,-</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">spacing</span><span class="s2">=(</span><span class="s4">.05</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">max_x</span><span class="s2">=</span><span class="s4">32</span><span class="s2">)</span>



    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'i'</span><span class="s2">:</span>
            <span class="s1">mouse</span><span class="s2">.</span><span class="s1">traverse_target </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">grid</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">spawn_entity</span><span class="s2">()</span>

        <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'i up' </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">drop_entity</span><span class="s2">()</span>
            <span class="s1">mouse</span><span class="s2">.</span><span class="s1">traverse_target </span><span class="s2">= </span><span class="s1">scene</span>

        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'left mouse up'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">drop_entity</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">spawn_entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_class</span><span class="s2">=</span><span class="s1">Entity</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">:</span>
            <span class="s1">print_on_screen</span><span class="s2">(</span><span class="s3">'&lt;red&gt;select a scene first'</span><span class="s2">, </span><span class="s1">position</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">origin</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">))</span>
            <span class="s0">return</span>

        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s1">_class</span><span class="s2">(</span><span class="s1">position</span><span class="s2">=</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">world_point</span><span class="s2">, </span><span class="s1">original_parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">, </span><span class="s1">selectable</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">collision</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">, </span><span class="s3">'collider_type'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">collider_type </span><span class="s2">= </span><span class="s3">'None'</span>
        <span class="s5"># print(self.target.model.name)</span>
        <span class="s5"># if not self.target.collider:</span>
        <span class="s5">#     self.target.collider = 'box'</span>
        <span class="s5">#     self.target.collision = False</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">shader</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">shader </span><span class="s2">= </span><span class="s1">lit_with_shadows_shader</span>

        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">)</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">drop_entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">undo</span><span class="s2">.</span><span class="s1">record_undo</span><span class="s2">((</span><span class="s3">'delete entities'</span><span class="s2">, [</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">), ], [</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">), ]))</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">, ]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>


    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">world_point </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'n'</span><span class="s2">] </span><span class="s0">or </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">left</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">world_point</span>


<span class="s0">class </span><span class="s1">Deleter</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'delete'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">delete_selected</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">delete_selected</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">undo</span><span class="s2">.</span><span class="s1">record_undo</span><span class="s2">((</span>
            <span class="s3">'restore entities'</span><span class="s2">,</span>
            <span class="s2">[</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">],</span>
            <span class="s2">))</span>

        <span class="s5"># print(LEVEL_EDITOR.selection)</span>
        <span class="s1">before </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">)</span>
        <span class="s5"># LEVEL_EDITOR.entities = [e for e in LEVEL_EDITOR.entities if e not in LEVEL_EDITOR.selection]</span>
        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">:</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>

        <span class="s5"># print('---------------', before, '--&gt;', len(LEVEL_EDITOR.entities))</span>
        <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'parent'</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">cubes</span><span class="s2">]</span>
        <span class="s2">[</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">]</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'g' </span><span class="s0">and </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s1">group_entity </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">scene_parent</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">'[group]'</span><span class="s2">, </span><span class="s1">selectable</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">group_entity</span><span class="s2">)</span>

            <span class="s1">parents </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">set</span><span class="s2">([</span><span class="s1">e</span><span class="s2">.</span><span class="s1">parent </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">]))</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">parents</span><span class="s2">) == </span><span class="s4">1</span><span class="s2">:</span>
                <span class="s1">group_entity</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">parents</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>

            <span class="s1">group_entity</span><span class="s2">.</span><span class="s1">world_position </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">([</span><span class="s1">e</span><span class="s2">.</span><span class="s1">world_position </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">]) / </span><span class="s1">len</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">group_entity</span>

            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">group_entity</span><span class="s2">, ]</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>



<span class="s0">class </span><span class="s1">PointOfViewSelector</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'cube'</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'box'</span><span class="s2">, </span><span class="s1">texture</span><span class="s2">=</span><span class="s3">'white_cube'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">.05</span><span class="s2">, </span><span class="s1">position</span><span class="s2">=</span><span class="s1">window</span><span class="s2">.</span><span class="s1">top_right</span><span class="s2">-</span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">.1</span><span class="s2">,</span><span class="s4">.05</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">front_text </span><span class="s2">= </span><span class="s1">Text</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'front'</span><span class="s2">, </span><span class="s1">z</span><span class="s2">=-</span><span class="s4">.5</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">azure</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">setattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">on_click</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">normal </span><span class="s2">== </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,-</span><span class="s4">1</span><span class="s2">):   </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">animate_rotation</span><span class="s2">((</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)) </span><span class="s5"># front</span>
        <span class="s0">elif </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">normal </span><span class="s2">== </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">):  </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">animate_rotation</span><span class="s2">((</span><span class="s4">0</span><span class="s2">,</span><span class="s4">180</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)) </span><span class="s5"># back</span>
        <span class="s0">elif </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">normal </span><span class="s2">== </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">):  </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">animate_rotation</span><span class="s2">((</span><span class="s4">0</span><span class="s2">,</span><span class="s4">90</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)) </span><span class="s5"># right</span>
        <span class="s0">elif </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">normal </span><span class="s2">== </span><span class="s1">Vec3</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">): </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">animate_rotation</span><span class="s2">((</span><span class="s4">0</span><span class="s2">,-</span><span class="s4">90</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)) </span><span class="s5"># right</span>
        <span class="s0">elif </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">normal </span><span class="s2">== </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">):  </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">animate_rotation</span><span class="s2">((</span><span class="s4">90</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)) </span><span class="s5"># top</span>
        <span class="s0">elif </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">normal </span><span class="s2">== </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,-</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">): </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">animate_rotation</span><span class="s2">((-</span><span class="s4">90</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)) </span><span class="s5"># top</span>


    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rotation </span><span class="s2">= -</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">rotation</span>

    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">]:</span>
            <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'1'</span><span class="s2">:   </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">animate_rotation</span><span class="s2">((</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)) </span><span class="s5"># front</span>
            <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'3'</span><span class="s2">: </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">animate_rotation</span><span class="s2">((</span><span class="s4">0</span><span class="s2">,</span><span class="s4">90</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)) </span><span class="s5"># right</span>
            <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'7'</span><span class="s2">: </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">editor_camera</span><span class="s2">.</span><span class="s1">animate_rotation</span><span class="s2">((</span><span class="s4">90</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)) </span><span class="s5"># top</span>
            <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'5'</span><span class="s2">: </span><span class="s1">camera</span><span class="s2">.</span><span class="s1">orthographic </span><span class="s2">= </span><span class="s0">not </span><span class="s1">camera</span><span class="s2">.</span><span class="s1">orthographic</span>


<span class="s5"># class PaintBucket(Entity):</span>
<span class="s5">#     def input(self, key):</span>
<span class="s5">#         if held_keys['alt'] and key == 'c' and mouse.hovered_entity:</span>
<span class="s5">#             self.color = mouse.hovered_entity.color</span>

<span class="s0">class </span><span class="s1">Copier</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s1">prefix </span><span class="s2">= </span><span class="s3">'ursina_editor_copy_data:```py</span><span class="s0">\n</span><span class="s3">'</span>

    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'c'</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">code </span><span class="s2">= </span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">prefix</span>
                <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                    <span class="s1">entity_repr </span><span class="s2">= </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>
                    <span class="s0">if not </span><span class="s3">'collider_type=' </span><span class="s0">in </span><span class="s1">entity_repr </span><span class="s0">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'collider_type'</span><span class="s2">):</span>
                        <span class="s1">entity_repr </span><span class="s2">= </span><span class="s3">f'</span><span class="s0">{</span><span class="s1">entity_repr</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]</span><span class="s0">}</span><span class="s3">collider_type=</span><span class="s0">\'{</span><span class="s1">e</span><span class="s2">.</span><span class="s1">collider_type</span><span class="s0">}\'</span><span class="s3">)'</span>
                    <span class="s1">code </span><span class="s2">+= </span><span class="s1">entity_repr </span><span class="s2">+ </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span>

                <span class="s1">pyperclip</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s3">f'</span><span class="s0">{</span><span class="s1">code</span><span class="s0">}\n</span><span class="s3">```'</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'v'</span><span class="s2">:</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">pyperclip</span><span class="s2">.</span><span class="s1">paste</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">value</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'ursina_editor_copy_data:```py</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">value</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">'</span><span class="s0">\n</span><span class="s3">```'</span><span class="s2">):</span>
                <span class="s1">cleaned_code </span><span class="s2">= </span><span class="s1">value</span><span class="s2">[</span><span class="s1">len</span><span class="s2">(</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">prefix</span><span class="s2">):-</span><span class="s4">4</span><span class="s2">].</span><span class="s1">strip</span><span class="s2">().</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">)</span>
                <span class="s1">clones </span><span class="s2">= []</span>
                <span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">cleaned_code</span><span class="s2">:</span>
                    <span class="s1">instance </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">line</span><span class="s2">)</span>
                    <span class="s1">instance</span><span class="s2">.</span><span class="s1">selectable </span><span class="s2">= </span><span class="s0">True</span>
                    <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">)</span>
                    <span class="s1">clones</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">)</span>

                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">clones</span><span class="s2">)</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= </span><span class="s1">clones</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">undo</span><span class="s2">.</span><span class="s1">record_undo</span><span class="s2">((</span><span class="s3">'delete entities'</span><span class="s2">, [</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">en</span><span class="s2">) </span><span class="s0">for </span><span class="s1">en </span><span class="s0">in </span><span class="s1">clones</span><span class="s2">], [</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">clones</span><span class="s2">]))</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">'------------------------'</span><span class="s2">)</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>




<span class="s0">class </span><span class="s1">LevelMenu</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">menu </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s1">Quad</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s4">.05</span><span class="s2">), </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">black</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">.2</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">x</span><span class="s2">=</span><span class="s1">camera</span><span class="s2">.</span><span class="s1">aspect_ratio</span><span class="s2">*</span><span class="s4">.495</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s4">.3</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'box'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">menu</span><span class="s2">.</span><span class="s1">grid </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">menu</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s1">Grid</span><span class="s2">(</span><span class="s4">8</span><span class="s2">,</span><span class="s4">8</span><span class="s2">), </span><span class="s1">z</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">menu</span><span class="s2">.</span><span class="s1">origin</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">dark_gray</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">content_renderer </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">menu</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">1</span><span class="s2">/</span><span class="s4">8</span><span class="s2">, </span><span class="s1">position</span><span class="s2">=(-</span><span class="s4">1</span><span class="s2">,-</span><span class="s4">.5</span><span class="s2">,-</span><span class="s4">1</span><span class="s2">), </span><span class="s1">model</span><span class="s2">=</span><span class="s1">Mesh</span><span class="s2">(), </span><span class="s1">color</span><span class="s2">=</span><span class="s3">'#222222'</span><span class="s2">) </span><span class="s5"># scales the content so I can set the position as (x,y) instead of (-1+(x/8),-.5+(y/8))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">content_renderer</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'quad'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">lime</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,-</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">z</span><span class="s2">=-</span><span class="s4">2</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s4">.5</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene_indicator </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">content_renderer</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'circle'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">azure</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,-</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">z</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s5"># self.tabs = [Button(parent=self.menu, scale=(1/4,1/8), position=(-1+(i/4),.5), origin=(-.5,-.5), color=color.hsv(90*i,.5,.3)) for i in range(4)]</span>


        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene_label </span><span class="s2">= </span><span class="s1">Text</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">menu</span><span class="s2">, </span><span class="s1">x</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s4">.5</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'current scene:'</span><span class="s2">, </span><span class="s1">z</span><span class="s2">=-</span><span class="s4">10</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">2.5</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">load_scenes</span><span class="s2">()</span>
        <span class="s5"># self.goto_scene(0, 0)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">load_scenes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">scene_file </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scene_folder</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">'*.csv'</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s3">'__' </span><span class="s0">in </span><span class="s1">scene_file</span><span class="s2">.</span><span class="s1">name</span><span class="s2">:</span>
                <span class="s0">continue</span>

            <span class="s5"># print('found scene:', scene_file)</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">scene_file</span><span class="s2">.</span><span class="s1">stem</span>
            <span class="s0">if </span><span class="s3">'[' </span><span class="s0">in </span><span class="s1">name </span><span class="s0">and </span><span class="s3">']' </span><span class="s0">in </span><span class="s1">name</span><span class="s2">:</span>
                <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= (</span><span class="s1">int</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">name</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'['</span><span class="s2">)[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">split</span><span class="s2">(</span><span class="s3">']'</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">split</span><span class="s2">(</span><span class="s3">','</span><span class="s2">))</span>
                <span class="s5"># print('scene is at coordinate:', x, y)</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scenes</span><span class="s2">[</span><span class="s1">x</span><span class="s2">][</span><span class="s1">y</span><span class="s2">].</span><span class="s1">path </span><span class="s2">= </span><span class="s1">scene_file</span>


    <span class="s0">def </span><span class="s1">draw</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'quad_vertices'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">quad_vertices </span><span class="s2">= </span><span class="s1">load_model</span><span class="s2">(</span><span class="s3">'quad'</span><span class="s2">, </span><span class="s1">application</span><span class="s2">.</span><span class="s1">internal_models_compressed_folder</span><span class="s2">, </span><span class="s1">use_deepcopy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">vertices</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">quad_vertices </span><span class="s2">= [</span><span class="s1">Vec3</span><span class="s2">(*</span><span class="s1">e</span><span class="s2">)*</span><span class="s4">.75 </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">quad_vertices</span><span class="s2">]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">content_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">8</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">8</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scenes</span><span class="s2">[</span><span class="s1">x</span><span class="s2">][</span><span class="s1">y</span><span class="s2">].</span><span class="s1">path</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">content_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices </span><span class="s2">+= [</span><span class="s1">Vec3</span><span class="s2">(*</span><span class="s1">v</span><span class="s2">)+</span><span class="s1">Vec3</span><span class="s2">(</span><span class="s1">x</span><span class="s2">+</span><span class="s4">.5</span><span class="s2">,</span><span class="s1">y</span><span class="s2">+</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">quad_vertices</span><span class="s2">]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">content_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">menu</span><span class="s2">.</span><span class="s1">hovered</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">menu</span><span class="s2">.</span><span class="s1">hovered</span><span class="s2">:</span>
            <span class="s1">grid_pos </span><span class="s2">= [</span><span class="s1">floor</span><span class="s2">((</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">point</span><span class="s2">.</span><span class="s1">x</span><span class="s2">+</span><span class="s4">1</span><span class="s2">) * </span><span class="s4">8</span><span class="s2">), </span><span class="s1">floor</span><span class="s2">((</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">point</span><span class="s2">.</span><span class="s1">y</span><span class="s2">+</span><span class="s4">.5</span><span class="s2">) * </span><span class="s4">8</span><span class="s2">)]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= </span><span class="s1">grid_pos</span>


    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'m'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">menu</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">menu</span><span class="s2">.</span><span class="s1">enabled</span>

        <span class="s5"># if key == 'left mouse down' and self.menu.hovered:</span>
        <span class="s5">#     self.click_start_pos = [int((mouse.point.x+1) * 8), int((mouse.point.y+.5) * 8)]</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'left mouse down' </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">menu</span><span class="s2">.</span><span class="s1">hovered</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= [</span><span class="s1">int</span><span class="s2">((</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">point</span><span class="s2">.</span><span class="s1">x</span><span class="s2">+</span><span class="s4">1</span><span class="s2">) * </span><span class="s4">8</span><span class="s2">), </span><span class="s1">int</span><span class="s2">((</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">point</span><span class="s2">.</span><span class="s1">y</span><span class="s2">+</span><span class="s4">.5</span><span class="s2">) * </span><span class="s4">8</span><span class="s2">)]</span>
            <span class="s5"># start_x, start_y = self.click_start_pos</span>
            <span class="s5">#</span>
            <span class="s5"># if x != start_x or y != start_y: # move scene</span>
            <span class="s5">#     print(f'move scene at {start_x},{start_y} to {x},{y}')</span>
            <span class="s5">#     scene_a = LEVEL_EDITOR.scenes[start_x][start_y]</span>
            <span class="s5">#     scene_a.coordinates = (x,y)</span>
            <span class="s5">#     scene_a.name = scene_a.name.split('[')[0] + f'[{x},{y}]'</span>
            <span class="s5">#     if scene_a.path:</span>
            <span class="s5">#         scene_a.path = scene_a.path.parent / (scene_a.name + '.py')</span>
            <span class="s5">#</span>
            <span class="s5">#     scene_b = LEVEL_EDITOR.scenes[x][y]</span>
            <span class="s5">#     scene_b.coordinates = (start_x, start_y)</span>
            <span class="s5">#     scene_b.name = scene_a.name.split('[')[0] + f'[{start_x},{start_y}]'</span>
            <span class="s5">#     if scene_b.path:</span>
            <span class="s5">#         scene_b.path = scene_b.path.parent / (scene_b.name + '.py')</span>
            <span class="s5">#</span>
            <span class="s5">#     # swap scenes</span>
            <span class="s5">#     LEVEL_EDITOR.scenes[self.click_start_pos[0]][self.click_start_pos[1]], LEVEL_EDITOR.scenes[x][y] = LEVEL_EDITOR.scenes[x][y], LEVEL_EDITOR.scenes[self.click_start_pos[0]][self.click_start_pos[1]]</span>
            <span class="s5">#</span>
            <span class="s5">#     self.draw()</span>
            <span class="s5">#     return</span>
            <span class="s5"># print(x, y)</span>
            <span class="s0">if not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'alt'</span><span class="s2">]:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">goto_scene</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

            <span class="s0">elif </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'alt'</span><span class="s2">]: </span><span class="s5"># append</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scenes</span><span class="s2">[</span><span class="s1">x</span><span class="s2">][</span><span class="s1">y</span><span class="s2">].</span><span class="s1">load</span><span class="s2">()</span>

            <span class="s0">elif </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'alt'</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">]: </span><span class="s5"># remove</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scenes</span><span class="s2">[</span><span class="s1">x</span><span class="s2">][</span><span class="s1">y</span><span class="s2">].</span><span class="s1">unload</span><span class="s2">()</span>


        <span class="s5"># hotkeys for loading neighbour levels</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'alt'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">key </span><span class="s0">in </span><span class="s3">'wasd'</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">:</span>
                <span class="s0">return</span>

            <span class="s1">coords </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">coordinates</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'d'</span><span class="s2">: </span><span class="s1">coords</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] += </span><span class="s4">1</span>
            <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'a'</span><span class="s2">: </span><span class="s1">coords</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] -= </span><span class="s4">1</span>
            <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'w'</span><span class="s2">: </span><span class="s1">coords</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] += </span><span class="s4">1</span>
            <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'s'</span><span class="s2">: </span><span class="s1">coords</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] -= </span><span class="s4">1</span>

            <span class="s5"># print(LEVEL_EDITOR.current_scene.coordinates, '--&gt;', coords)</span>
            <span class="s1">coords</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s1">clamp</span><span class="s2">(</span><span class="s1">coords</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s4">0</span><span class="s2">, </span><span class="s4">8</span><span class="s2">)</span>
            <span class="s1">coords</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">clamp</span><span class="s2">(</span><span class="s1">coords</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s4">0</span><span class="s2">, </span><span class="s4">8</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">goto_scene</span><span class="s2">(</span><span class="s1">coords</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">coords</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>


        <span class="s5"># elif key == 'right mouse down' and self.hovered:</span>
        <span class="s5">#     x, y = [int((mouse.point.x+1) * 8), int((mouse.point.y+.5) * 8)]</span>
        <span class="s5">#     self.right_click_menu.enabled = True</span>
        <span class="s5">#     self.right_click_menu.position = (x,y)</span>



    <span class="s0">def </span><span class="s1">goto_scene</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene_indicator</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene_indicator</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= (</span><span class="s1">x</span><span class="s2">,</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s2">[[</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scenes</span><span class="s2">[</span><span class="s1">_x</span><span class="s2">][</span><span class="s1">_y</span><span class="s2">].</span><span class="s1">unload</span><span class="s2">() </span><span class="s0">for </span><span class="s1">_x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">8</span><span class="s2">)] </span><span class="s0">for </span><span class="s1">_y </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">8</span><span class="s2">)]</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">scenes</span><span class="s2">[</span><span class="s1">x</span><span class="s2">][</span><span class="s1">y</span><span class="s2">]</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">load</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_scene_label</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>

        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">inspector</span><span class="s2">.</span><span class="s1">update_inspector</span><span class="s2">()</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">sun_handler</span><span class="s2">.</span><span class="s1">sun</span><span class="s2">.</span><span class="s1">shadows </span><span class="s2">= </span><span class="s0">True</span>


<span class="s0">class </span><span class="s1">HierarchyList</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">quad_model </span><span class="s2">= </span><span class="s1">load_model</span><span class="s2">(</span><span class="s3">'quad'</span><span class="s2">, </span><span class="s1">application</span><span class="s2">.</span><span class="s1">internal_models_folder</span><span class="s2">, </span><span class="s1">use_deepcopy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bg </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'quad'</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'box'</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">black90</span><span class="s2">, </span><span class="s1">position</span><span class="s2">=</span><span class="s1">window</span><span class="s2">.</span><span class="s1">top_left</span><span class="s2">+</span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,-</span><span class="s4">.05</span><span class="s2">), </span><span class="s1">scale</span><span class="s2">=(</span><span class="s4">.15</span><span class="s2">,</span><span class="s4">10</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">entity_list_text </span><span class="s2">= </span><span class="s1">Text</span><span class="s2">(</span><span class="s1">font</span><span class="s2">=</span><span class="s3">'VeraMono.ttf'</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">.6</span><span class="s2">, </span><span class="s1">line_height</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">position</span><span class="s2">=</span><span class="s1">window</span><span class="s2">.</span><span class="s1">top_left</span><span class="s2">+</span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">.005</span><span class="s2">,-</span><span class="s4">.05</span><span class="s2">), </span><span class="s1">z</span><span class="s2">=-</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">selected_renderer </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">entity_list_text</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=(</span><span class="s4">.25</span><span class="s2">,</span><span class="s1">Text</span><span class="s2">.</span><span class="s1">size</span><span class="s2">), </span><span class="s1">model</span><span class="s2">=</span><span class="s1">Mesh</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">=[]), </span><span class="s1">color</span><span class="s2">=</span><span class="s1">hsv</span><span class="s2">(</span><span class="s4">210</span><span class="s2">,</span><span class="s4">.9</span><span class="s2">,</span><span class="s4">.6</span><span class="s2">), </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">x</span><span class="s2">=-</span><span class="s4">.01</span><span class="s2">, </span><span class="s1">z</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">selected_renderer</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">self</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">selected_renderer</span><span class="s2">.</span><span class="s1">z</span><span class="s2">= -</span><span class="s4">.1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">prev_y </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span>

    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'left mouse down' </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">hovered</span><span class="s2">:</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(-</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">point</span><span class="s2">.</span><span class="s1">y </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">scale_y </span><span class="s2">/ </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">size </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">entity_list_text</span><span class="s2">.</span><span class="s1">scale_y</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">y </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">):</span>
                <span class="s0">if not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">]:     </span><span class="s5"># select one</span>
                    <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">entity_indices</span><span class="s2">[</span><span class="s1">y</span><span class="s2">]], ]</span>
                <span class="s0">elif </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">]:       </span><span class="s5"># add one</span>
                    <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">entity_indices</span><span class="s2">[</span><span class="s1">y</span><span class="s2">]])</span>
                <span class="s0">elif </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">prev_y</span><span class="s2">:                    </span><span class="s5"># add multiple</span>
                    <span class="s1">from_y </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">prev_y</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
                    <span class="s1">to_y </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">prev_y</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">from_y</span><span class="s2">, </span><span class="s1">to_y</span><span class="s2">+</span><span class="s4">1</span><span class="s2">):</span>
                        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">entity_indices</span><span class="s2">[</span><span class="s1">_</span><span class="s2">]])</span>

            <span class="s0">elif not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">]:</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">prev_y </span><span class="s2">= </span><span class="s1">y</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>
            <span class="s5"># LEVEL_EDITOR.render_selection()</span>


        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'left mouse up'</span><span class="s2">:</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">draw</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">entity</span><span class="s2">, </span><span class="s1">indent</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">entity_indices</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">entity</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">entity </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_text </span><span class="s2">+= </span><span class="s3">f'&lt;gray&gt;</span><span class="s0">{</span><span class="s3">&quot; &quot;</span><span class="s2">*</span><span class="s1">indent</span><span class="s0">}{</span><span class="s1">entity</span><span class="s2">.</span><span class="s1">name</span><span class="s0">}\n</span><span class="s3">'</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">selected_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s1">Vec3</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)-</span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s1">self</span><span class="s2">.</span><span class="s1">i</span><span class="s2">,</span><span class="s4">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">quad_model</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">])</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_text </span><span class="s2">+= </span><span class="s3">f'&lt;white&gt;</span><span class="s0">{</span><span class="s3">&quot; &quot;</span><span class="s2">*</span><span class="s1">indent</span><span class="s0">}{</span><span class="s1">entity</span><span class="s2">.</span><span class="s1">name</span><span class="s0">}\n</span><span class="s3">'</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">i </span><span class="s2">+= </span><span class="s4">1</span>


    <span class="s0">def </span><span class="s1">render_selection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_text </span><span class="s2">= </span><span class="s3">''</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">selected_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">entity_indices </span><span class="s2">= [-</span><span class="s4">1 </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s1">current_node </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s0">for </span><span class="s1">entity </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">entity</span><span class="s2">, </span><span class="s3">'is_gizmo'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">entity</span><span class="s2">.</span><span class="s1">is_gizmo</span><span class="s2">:</span>
                <span class="s0">continue</span>

            <span class="s0">if </span><span class="s1">entity</span><span class="s2">.</span><span class="s1">parent </span><span class="s2">== </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">scene_parent</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">(</span><span class="s1">entity</span><span class="s2">, </span><span class="s1">indent</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

                <span class="s0">for </span><span class="s1">child </span><span class="s0">in </span><span class="s2">[</span><span class="s1">e </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">entity</span><span class="s2">.</span><span class="s1">children </span><span class="s0">if </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">]:</span>
                    <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">child</span><span class="s2">, </span><span class="s3">'is_gizmo'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">child</span><span class="s2">.</span><span class="s1">is_gizmo</span><span class="s2">:</span>
                        <span class="s0">continue</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">(</span><span class="s1">child</span><span class="s2">, </span><span class="s1">indent</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>

                    <span class="s0">for </span><span class="s1">child_2 </span><span class="s0">in </span><span class="s2">[</span><span class="s1">e </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">child</span><span class="s2">.</span><span class="s1">children </span><span class="s0">if </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">]:</span>
                        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">child_2</span><span class="s2">, </span><span class="s3">'is_gizmo'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">child_2</span><span class="s2">.</span><span class="s1">is_gizmo</span><span class="s2">:</span>
                            <span class="s0">continue</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">(</span><span class="s1">child_2</span><span class="s2">, </span><span class="s1">indent</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>

                        <span class="s0">for </span><span class="s1">child_3 </span><span class="s0">in </span><span class="s2">[</span><span class="s1">e </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">child_2</span><span class="s2">.</span><span class="s1">children </span><span class="s0">if </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">]:</span>
                            <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">child_3</span><span class="s2">, </span><span class="s3">'is_gizmo'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">child_3</span><span class="s2">.</span><span class="s1">is_gizmo</span><span class="s2">:</span>
                                <span class="s0">continue</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">(</span><span class="s1">child_3</span><span class="s2">, </span><span class="s1">indent</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>


        <span class="s1">self</span><span class="s2">.</span><span class="s1">entity_list_text</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_text</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">selected_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>


<span class="s1">Text</span><span class="s2">.</span><span class="s1">default_font </span><span class="s2">= </span><span class="s3">'VeraMono.ttf'</span>
<span class="s0">class </span><span class="s1">InspectorInputField</span><span class="s2">(</span><span class="s1">InputField</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text_field</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s4">.05</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text_field</span><span class="s2">.</span><span class="s1">y </span><span class="s2">= -</span><span class="s4">.25</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text_field</span><span class="s2">.</span><span class="s1">world_scale </span><span class="s2">= </span><span class="s4">25 </span><span class="s2">* </span><span class="s4">.75</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text_field</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">light_gray</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">highlight_color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">_32</span>


<span class="s0">class </span><span class="s1">InspectorButton</span><span class="s2">(</span><span class="s1">Button</span><span class="s2">):</span>
    <span class="s1">defaults </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">model</span><span class="s2">=</span><span class="s3">'quad'</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">text_origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">text_color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">light_gray</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">black90</span><span class="s2">, </span><span class="s1">highlight_color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">_32</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">defaults </span><span class="s2">| </span><span class="s1">kwargs</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s4">.025</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">*= </span><span class="s4">.75</span>


<span class="s0">class </span><span class="s1">ColorField</span><span class="s2">(</span><span class="s1">InspectorButton</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr_name</span><span class="s2">=</span><span class="s3">'color'</span><span class="s2">, </span><span class="s1">is_shader_input</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">white</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">attr_name </span><span class="s2">= </span><span class="s1">attr_name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_shader_input </span><span class="s2">= </span><span class="s1">is_shader_input</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">preview </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s1">Quad</span><span class="s2">(</span><span class="s1">aspect</span><span class="s2">=</span><span class="s4">2</span><span class="s2">/</span><span class="s4">1</span><span class="s2">), </span><span class="s1">scale</span><span class="s2">=(</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">.8</span><span class="s2">), </span><span class="s1">origin</span><span class="s2">=(</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">x</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">z</span><span class="s2">=-</span><span class="s4">.1</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s4">.05</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'box'</span><span class="s2">, </span><span class="s1">on_click</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_click</span><span class="s2">)</span>
        <span class="s5"># self.text_entity.scale *= .75</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">value</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">preview</span><span class="s2">.</span><span class="s1">color</span>

    <span class="s2">@</span><span class="s1">value</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">preview</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">on_click</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">color_menu</span><span class="s2">.</span><span class="s1">color_field </span><span class="s2">= </span><span class="s1">self</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">color_menu</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">preview</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">(</span><span class="s1">relative_to</span><span class="s2">=</span><span class="s1">camera</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">).</span><span class="s1">xy </span><span class="s2">+ </span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">.025</span><span class="s2">,-</span><span class="s4">.01</span><span class="s2">)</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s3">'color_menu'</span>


<span class="s0">class </span><span class="s1">Inspector</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">, </span><span class="s1">position</span><span class="s2">=</span><span class="s1">window</span><span class="s2">.</span><span class="s1">top_left</span><span class="s2">+</span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">.15</span><span class="s2">,-</span><span class="s4">.04</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">selected_entity </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ui </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name_field </span><span class="s2">= </span><span class="s1">InspectorInputField</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">, </span><span class="s1">default_value</span><span class="s2">=</span><span class="s3">'name'</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">scale_x</span><span class="s2">=</span><span class="s4">.15</span><span class="s2">*</span><span class="s4">3</span><span class="s2">, </span><span class="s1">scale_y</span><span class="s2">=</span><span class="s4">.05</span><span class="s2">*</span><span class="s4">.75</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">hsv</span><span class="s2">(</span><span class="s4">210</span><span class="s2">,</span><span class="s4">.9</span><span class="s2">,</span><span class="s4">.6</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">input_fields </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name_field</span><span class="s2">, ]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">transform_fields </span><span class="s2">= []</span>

        <span class="s0">for </span><span class="s1">y</span><span class="s2">, </span><span class="s1">names </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(((</span><span class="s3">'x'</span><span class="s2">,</span><span class="s3">'y'</span><span class="s2">,</span><span class="s3">'z'</span><span class="s2">), (</span><span class="s3">'rotation_x'</span><span class="s2">,</span><span class="s3">'rotation_y'</span><span class="s2">,</span><span class="s3">'rotation_z'</span><span class="s2">), (</span><span class="s3">'scale_x'</span><span class="s2">,</span><span class="s3">'scale_y'</span><span class="s2">,</span><span class="s3">'scale_z'</span><span class="s2">))):</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">):</span>
                <span class="s1">default </span><span class="s2">= </span><span class="s3">'0'</span>
                <span class="s0">if </span><span class="s1">y </span><span class="s2">== </span><span class="s4">2</span><span class="s2">:</span>
                    <span class="s1">default </span><span class="s2">= </span><span class="s3">'1'</span>

                <span class="s1">field </span><span class="s2">= </span><span class="s1">InspectorInputField</span><span class="s2">(</span><span class="s1">max_width</span><span class="s2">=</span><span class="s4">8</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'quad'</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name_field</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">/</span><span class="s4">3</span><span class="s2">,</span><span class="s4">1</span><span class="s2">), </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">default_value</span><span class="s2">=</span><span class="s1">default</span><span class="s2">, </span><span class="s1">limit_content_to</span><span class="s2">=</span><span class="s1">ContentTypes</span><span class="s2">.</span><span class="s1">math</span><span class="s2">, </span><span class="s1">x</span><span class="s2">=</span><span class="s1">x</span><span class="s2">/</span><span class="s4">3</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s1">y</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">_8</span><span class="s2">)</span>
                <span class="s0">def </span><span class="s1">on_submit</span><span class="s2">(</span><span class="s1">names</span><span class="s2">=</span><span class="s1">names</span><span class="s2">, </span><span class="s1">x</span><span class="s2">=</span><span class="s1">x</span><span class="s2">, </span><span class="s1">field</span><span class="s2">=</span><span class="s1">field</span><span class="s2">):</span>
                    <span class="s0">try</span><span class="s2">:</span>
                        <span class="s1">value </span><span class="s2">= </span><span class="s1">float</span><span class="s2">(</span><span class="s1">eval</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">text</span><span class="s2">[:</span><span class="s4">8</span><span class="s2">]))</span>
                        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">float</span><span class="s2">):</span>
                            <span class="s1">field</span><span class="s2">.</span><span class="s1">text_field</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)[:</span><span class="s4">8</span><span class="s2">]</span>
                            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                                <span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">names</span><span class="s2">[</span><span class="s1">x</span><span class="s2">], </span><span class="s1">float</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">text_field</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">text</span><span class="s2">))</span>
                    <span class="s0">except</span><span class="s2">: </span><span class="s5"># invalid/incomplete math</span>
                        <span class="s5"># print('invalid')</span>
                        <span class="s0">return</span>

                <span class="s5"># field.submit_on = 'enter'</span>
                <span class="s1">field</span><span class="s2">.</span><span class="s1">on_submit </span><span class="s2">= </span><span class="s1">on_submit</span>
                <span class="s1">field</span><span class="s2">.</span><span class="s1">on_value_changed </span><span class="s2">= </span><span class="s1">on_submit</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">transform_fields</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)</span>
                <span class="s5"># self.input_fields.append(field)</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">transform_fields</span><span class="s2">)-</span><span class="s4">1</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">transform_fields</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">next_field </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">transform_fields</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">fields </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span>
            <span class="s1">model </span><span class="s2">=   </span><span class="s1">InspectorButton</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name_field</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'model: '</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s4">4</span><span class="s2">, </span><span class="s1">on_click</span><span class="s2">=</span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">, </span><span class="s3">'state'</span><span class="s2">, </span><span class="s3">'model_menu'</span><span class="s2">)),</span>
            <span class="s1">texture </span><span class="s2">= </span><span class="s1">InspectorButton</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name_field</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'texture: '</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s4">4</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">on_click</span><span class="s2">=</span><span class="s1">Sequence</span><span class="s2">(</span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">, </span><span class="s3">'state'</span><span class="s2">, </span><span class="s3">'texture_menu'</span><span class="s2">), </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">texture_menu</span><span class="s2">, </span><span class="s3">'target_attr'</span><span class="s2">, </span><span class="s3">'texture'</span><span class="s2">))),</span>
            <span class="s1">color </span><span class="s2">=   </span><span class="s1">ColorField</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name_field</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'c:color: '</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s4">4</span><span class="s2">-</span><span class="s4">2</span><span class="s2">, </span><span class="s1">attr_name</span><span class="s2">=</span><span class="s3">'color'</span><span class="s2">, </span><span class="s1">is_shader_input</span><span class="s2">=</span><span class="s0">False</span><span class="s2">),</span>
            <span class="s1">collider_type </span><span class="s2">= </span><span class="s1">InspectorButton</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name_field</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'collider_type: '</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s4">4</span><span class="s2">-</span><span class="s4">3</span><span class="s2">, </span><span class="s1">on_click</span><span class="s2">=</span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">, </span><span class="s3">'state'</span><span class="s2">, </span><span class="s3">'collider_menu'</span><span class="s2">)),</span>
            <span class="s1">shader </span><span class="s2">=  </span><span class="s1">InspectorButton</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name_field</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'shader: '</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s4">4</span><span class="s2">-</span><span class="s4">4</span><span class="s2">, </span><span class="s1">on_click</span><span class="s2">=</span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">, </span><span class="s3">'state'</span><span class="s2">, </span><span class="s3">'shader_menu'</span><span class="s2">)),</span>
        <span class="s2">)</span>


        <span class="s1">Entity</span><span class="s2">(</span><span class="s1">model</span><span class="s2">=</span><span class="s1">Grid</span><span class="s2">(</span><span class="s4">3</span><span class="s2">,</span><span class="s4">3</span><span class="s2">), </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">transform_fields</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">z</span><span class="s2">=-</span><span class="s4">.1</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">_64</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">shader_inputs_parent </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name_field</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s4">9</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">= </span><span class="s4">.6</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">update_inspector</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">!= </span><span class="s3">'left mouse up'</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">and </span><span class="s2">(</span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">left </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'d'</span><span class="s2">]):</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selected_entity</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">update_inspector</span><span class="s2">()</span>
            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selected_entity </span><span class="s2">!= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">update_inspector</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">update_inspector</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># print('update inspector')</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">selected_entity </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s3">'color'</span><span class="s2">].</span><span class="s1">preview</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">color</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name_field</span><span class="s2">.</span><span class="s1">text_field</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selected_entity</span><span class="s2">.</span><span class="s1">name</span>

        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">attr_name </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">((</span><span class="s3">'x'</span><span class="s2">, </span><span class="s3">'y'</span><span class="s2">, </span><span class="s3">'z'</span><span class="s2">, </span><span class="s3">'rotation_x'</span><span class="s2">, </span><span class="s3">'rotation_y'</span><span class="s2">, </span><span class="s3">'rotation_z'</span><span class="s2">, </span><span class="s3">'scale_x'</span><span class="s2">, </span><span class="s3">'scale_y'</span><span class="s2">, </span><span class="s3">'scale_z'</span><span class="s2">)):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">transform_fields</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">text_field</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">round</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selected_entity</span><span class="s2">, </span><span class="s1">attr_name</span><span class="s2">),</span><span class="s4">4</span><span class="s2">))</span>

        <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s2">(</span><span class="s3">'model'</span><span class="s2">, </span><span class="s3">'texture'</span><span class="s2">, </span><span class="s3">'collider_type'</span><span class="s2">, </span><span class="s3">'shader'</span><span class="s2">):</span>
            <span class="s1">unique_field_values </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">set</span><span class="s2">([</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)]))</span>
            <span class="s0">if </span><span class="s1">unique_field_values </span><span class="s2">== ():</span>
                <span class="s1">text </span><span class="s2">= </span><span class="s3">'*error*'</span>

            <span class="s0">elif </span><span class="s1">len</span><span class="s2">(</span><span class="s1">unique_field_values</span><span class="s2">) == </span><span class="s4">1</span><span class="s2">: </span><span class="s5"># all selected entities has the same value, so draw that</span>
                <span class="s1">text </span><span class="s2">= </span><span class="s1">unique_field_values</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
                <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">text</span><span class="s2">, </span><span class="s3">'name'</span><span class="s2">):</span>
                    <span class="s1">text </span><span class="s2">= </span><span class="s1">text</span><span class="s2">.</span><span class="s1">name</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">text </span><span class="s2">= </span><span class="s3">'--- mixed ---'</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s1">name</span><span class="s2">].</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= (</span><span class="s3">f'</span><span class="s0">{</span><span class="s1">name</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span><span class="s0">}</span><span class="s3">:</span><span class="s0">{</span><span class="s1">text</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>

        <span class="s2">[</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shader_inputs_parent</span><span class="s2">.</span><span class="s1">children</span><span class="s2">]</span>
        <span class="s0">from </span><span class="s1">ursina</span><span class="s2">.</span><span class="s1">prefabs</span><span class="s2">.</span><span class="s1">vec_field </span><span class="s0">import </span><span class="s1">VecField</span>

        <span class="s1">i </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selected_entity</span><span class="s2">.</span><span class="s1">shader</span><span class="s2">:</span>
            <span class="s1">shader_inputs </span><span class="s2">= {</span><span class="s1">key</span><span class="s2">: </span><span class="s1">value </span><span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selected_entity</span><span class="s2">.</span><span class="s1">shader</span><span class="s2">.</span><span class="s1">default_input</span><span class="s2">.</span><span class="s1">items</span><span class="s2">() </span><span class="s0">if </span><span class="s1">key </span><span class="s2">!= </span><span class="s3">'shadow_color'</span><span class="s2">}</span>
            <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">shader_inputs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s1">instance_value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selected_entity</span><span class="s2">.</span><span class="s1">get_shader_input</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">instance_value</span><span class="s2">:</span>
                    <span class="s5"># print('use instance value,', instance_value)</span>
                    <span class="s1">value </span><span class="s2">= </span><span class="s1">instance_value</span>

                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
                    <span class="s1">b </span><span class="s2">= </span><span class="s1">InspectorButton</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">shader_inputs_parent</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">f'   </span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s3">:'</span><span class="s2">, </span><span class="s1">highlight_color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">black90</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s1">i</span><span class="s2">)</span>
                    <span class="s1">b</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">*= </span><span class="s4">.6</span>
                    <span class="s1">b</span><span class="s2">.</span><span class="s1">on_click </span><span class="s2">= </span><span class="s1">Sequence</span><span class="s2">(</span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">, </span><span class="s3">'state'</span><span class="s2">, </span><span class="s3">'texture_menu'</span><span class="s2">), </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">texture_menu</span><span class="s2">, </span><span class="s3">'target_attr'</span><span class="s2">, </span><span class="s1">name</span><span class="s2">))</span>


                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Vec2</span><span class="s2">) </span><span class="s0">or </span><span class="s2">(</span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s3">'__len__'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) == </span><span class="s4">2</span><span class="s2">):</span>
                    <span class="s1">field </span><span class="s2">= </span><span class="s1">VecField</span><span class="s2">(</span><span class="s1">default_value</span><span class="s2">=</span><span class="s1">instance_value</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">shader_inputs_parent</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'quad'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">), </span><span class="s1">x</span><span class="s2">=</span><span class="s4">.5</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s1">i</span><span class="s2">-</span><span class="s4">.5</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">f'  </span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">field</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">:</span>
                        <span class="s1">e</span><span class="s2">.</span><span class="s1">text_field</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">*= </span><span class="s4">.6</span>
                        <span class="s1">e</span><span class="s2">.</span><span class="s1">text_field</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">light_gray</span>
                    <span class="s1">field</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">*= </span><span class="s4">.6</span><span class="s2">*</span><span class="s4">.75</span>
                    <span class="s1">field</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">light_gray</span>

                    <span class="s0">def </span><span class="s1">on_submit</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">, </span><span class="s1">field</span><span class="s2">=</span><span class="s1">field</span><span class="s2">):</span>
                        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                            <span class="s5"># setattr(e, name, float(field.text_field.text_entity.text))</span>
                            <span class="s1">e</span><span class="s2">.</span><span class="s1">set_shader_input</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">field</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>
                    <span class="s1">field</span><span class="s2">.</span><span class="s1">on_value_changed </span><span class="s2">= </span><span class="s1">on_submit</span>

                <span class="s5"># # float</span>
                <span class="s5"># # int</span>
                <span class="s5"># # Vec3</span>

                <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Color</span><span class="s2">):</span>
                    <span class="s1">color_field </span><span class="s2">= </span><span class="s1">ColorField</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">shader_inputs_parent</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">f' </span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s3">'</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s1">i</span><span class="s2">, </span><span class="s1">is_shader_input</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">attr_name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">)</span>
                    <span class="s1">color_field</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">*= </span><span class="s4">.6</span>

                <span class="s1">i </span><span class="s2">+= </span><span class="s4">1</span>

        <span class="s1">i </span><span class="s2">+= </span><span class="s4">0</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selected_entity</span><span class="s2">, </span><span class="s3">'draw_inspector'</span><span class="s2">):</span>
            <span class="s1">divider </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">shader_inputs_parent</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'quad'</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'box'</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">scale</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">black90</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s1">i</span><span class="s2">)</span>
            <span class="s1">i </span><span class="s2">+= </span><span class="s4">1</span>
            <span class="s5"># print('-------------', self.selected_entity.draw_inspector())</span>
            <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">_type </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selected_entity</span><span class="s2">.</span><span class="s1">draw_inspector</span><span class="s2">().</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selected_entity</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
                    <span class="s0">continue</span>
                <span class="s1">attr </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selected_entity</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">attr </span><span class="s0">is False or </span><span class="s1">attr </span><span class="s0">is True</span><span class="s2">:</span>
                <span class="s5"># if isinstance(attr, bool):</span>
                    <span class="s1">b </span><span class="s2">= </span><span class="s1">InspectorButton</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">shader_inputs_parent</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">f' </span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s3">:'</span><span class="s2">, </span><span class="s1">highlight_color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">red</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s1">i</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">0</span><span class="s2">))</span>
                    <span class="s1">b</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">*= </span><span class="s4">.6</span>
                    <span class="s0">def </span><span class="s1">toggle_value</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">):</span>
                        <span class="s1">new_value </span><span class="s2">= </span><span class="s0">not </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">selected_entity</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
                        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                            <span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">new_value</span><span class="s2">)</span>
                            <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'generate'</span><span class="s2">):</span>
                                <span class="s1">e</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>

                    <span class="s1">b</span><span class="s2">.</span><span class="s1">on_click </span><span class="s2">= </span><span class="s1">toggle_value</span>

                <span class="s0">elif </span><span class="s1">_type </span><span class="s0">in </span><span class="s2">(</span><span class="s1">float</span><span class="s2">, </span><span class="s1">int</span><span class="s2">):</span>
                    <span class="s1">field </span><span class="s2">= </span><span class="s1">VecField</span><span class="s2">(</span><span class="s1">default_value</span><span class="s2">=</span><span class="s1">attr</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">shader_inputs_parent</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'quad'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">), </span><span class="s1">x</span><span class="s2">=</span><span class="s4">.5</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s1">i</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">f'  </span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">field</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">:</span>
                        <span class="s1">e</span><span class="s2">.</span><span class="s1">text_field</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">*= </span><span class="s4">.6</span>
                        <span class="s1">e</span><span class="s2">.</span><span class="s1">text_field</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">light_gray</span>
                    <span class="s1">field</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">*= </span><span class="s4">.6</span><span class="s2">*</span><span class="s4">.75</span>
                    <span class="s1">field</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">light_gray</span>

                    <span class="s0">def </span><span class="s1">on_submit</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">, </span><span class="s1">field</span><span class="s2">=</span><span class="s1">field</span><span class="s2">):</span>
                        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                            <span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">field</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

                    <span class="s1">field</span><span class="s2">.</span><span class="s1">on_value_changed </span><span class="s2">= </span><span class="s1">on_submit</span>

                <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">_type</span><span class="s2">, </span><span class="s1">type</span><span class="s2">):</span>
                    <span class="s1">text </span><span class="s2">= </span><span class="s1">attr</span>
                    <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">, </span><span class="s3">'name'</span><span class="s2">):</span>
                        <span class="s1">text </span><span class="s2">= </span><span class="s1">attr</span><span class="s2">.</span><span class="s1">__name__</span>

                    <span class="s1">b </span><span class="s2">= </span><span class="s1">InspectorButton</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">shader_inputs_parent</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">f' </span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s3">: </span><span class="s0">{</span><span class="s1">text</span><span class="s0">}</span><span class="s3">'</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=-</span><span class="s1">i</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">0</span><span class="s2">))</span>
                    <span class="s1">b</span><span class="s2">.</span><span class="s1">text_entity</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">*= </span><span class="s4">.6</span>
                    <span class="s1">b</span><span class="s2">.</span><span class="s1">on_click </span><span class="s2">= </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">, </span><span class="s3">'state'</span><span class="s2">, </span><span class="s3">'class_menu'</span><span class="s2">)</span>

                <span class="s1">i </span><span class="s2">+= </span><span class="s4">1</span>



<span class="s0">class </span><span class="s1">MenuHandler</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_state </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">states </span><span class="s2">= {</span>
            <span class="s3">'None' </span><span class="s2">: </span><span class="s0">None</span><span class="s2">,</span>
            <span class="s3">'model_menu' </span><span class="s2">: </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">model_menu</span><span class="s2">,</span>
            <span class="s3">'texture_menu' </span><span class="s2">: </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">texture_menu</span><span class="s2">,</span>
            <span class="s3">'shader_menu' </span><span class="s2">: </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">shader_menu</span><span class="s2">,</span>
            <span class="s3">'color_menu' </span><span class="s2">: </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">color_menu</span><span class="s2">,</span>
            <span class="s3">'collider_menu'</span><span class="s2">: </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">collider_menu</span><span class="s2">,</span>
            <span class="s3">'class_menu'</span><span class="s2">: </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">class_menu</span>
        <span class="s2">}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">keybinds </span><span class="s2">= {</span><span class="s3">'m' </span><span class="s2">: </span><span class="s3">'model_menu'</span><span class="s2">, </span><span class="s3">'v' </span><span class="s2">: </span><span class="s3">'texture_menu'</span><span class="s2">, </span><span class="s3">'n' </span><span class="s2">: </span><span class="s3">'shader_menu'</span><span class="s2">, </span><span class="s3">'b' </span><span class="s2">: </span><span class="s3">'color_menu'</span><span class="s2">, </span><span class="s3">'escape' </span><span class="s2">: </span><span class="s3">'None'</span><span class="s2">}</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">state</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span>

    <span class="s2">@</span><span class="s1">state</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">state</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">target_state </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">states</span><span class="s2">[</span><span class="s1">value</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state </span><span class="s2">== </span><span class="s1">value</span><span class="s2">:</span>
            <span class="s5"># print('toggle:', target_state, 'from:', target_state.enabled, not target_state.enabled)</span>
            <span class="s1">target_state</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">not </span><span class="s1">target_state</span><span class="s2">.</span><span class="s1">enabled</span>
            <span class="s0">return</span>

        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">states</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():        </span><span class="s5"># only show set state and disable the rest</span>
            <span class="s0">if </span><span class="s1">e</span><span class="s2">:</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s1">value </span><span class="s2">== </span><span class="s1">key</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_state </span><span class="s2">= </span><span class="s1">value</span>


    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'escape' </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">!= </span><span class="s3">'None'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s3">'None'</span>
            <span class="s0">return</span>
        <span class="s5"># print(key, self.keybinds)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">!= </span><span class="s3">'None'</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s0">if not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'alt'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">keybinds </span><span class="s0">and </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">keybinds</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>
            <span class="s5"># print('sets state:', self.keybinds[key], self.state)</span>

<span class="s0">class </span><span class="s1">AssetMenu</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">z</span><span class="s2">=-</span><span class="s4">2</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">button_list </span><span class="s2">= </span><span class="s1">ButtonList</span><span class="s2">({}, </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">font</span><span class="s2">=</span><span class="s3">'VeraMono.ttf'</span><span class="s2">, </span><span class="s1">x</span><span class="s2">=-</span><span class="s4">.25</span><span class="s2">*</span><span class="s4">.75</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">.75</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bg </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">button_list</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'quad'</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'box'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">black33</span><span class="s2">, </span><span class="s1">on_click</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">disable</span><span class="s2">, </span><span class="s1">z</span><span class="s2">=</span><span class="s4">.1</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">100</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">on_enable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">asset_names</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">'no texture assets found'</span><span class="s2">)</span>
            <span class="s5"># return</span>
        <span class="s1">asset_dict </span><span class="s2">= {</span><span class="s1">name </span><span class="s2">: </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_select_asset</span><span class="s2">, </span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">asset_names</span><span class="s2">}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">button_list</span><span class="s2">.</span><span class="s1">button_dict </span><span class="s2">= </span><span class="s1">asset_dict</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">button_list</span><span class="s2">.</span><span class="s1">y </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">asset_dict</span><span class="s2">) / </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">button_list</span><span class="s2">.</span><span class="s1">button_height </span><span class="s2">* </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">size</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">button_list</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">x</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">button_list</span><span class="s2">.</span><span class="s1">y </span><span class="s2">= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">y</span>


<span class="s0">class </span><span class="s1">ModelMenu</span><span class="s2">(</span><span class="s1">AssetMenu</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">on_enable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># self.model_names = [e.stem for e in application.internal_models_compressed_folder.glob('**/*.ursinamesh')]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">asset_names </span><span class="s2">= [</span><span class="s3">'None'</span><span class="s2">, </span><span class="s3">'cube'</span><span class="s2">, </span><span class="s3">'sphere'</span><span class="s2">, </span><span class="s3">'plane'</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">file_type </span><span class="s0">in </span><span class="s2">(</span><span class="s3">'.bam'</span><span class="s2">, </span><span class="s3">'.obj'</span><span class="s2">, </span><span class="s3">'.ursinamesh'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">asset_names </span><span class="s2">+= [</span><span class="s1">e</span><span class="s2">.</span><span class="s1">stem </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">application</span><span class="s2">.</span><span class="s1">asset_folder</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">f'**/*</span><span class="s0">{</span><span class="s1">file_type</span><span class="s0">}</span><span class="s3">'</span><span class="s2">) </span><span class="s0">if not </span><span class="s3">'animation' </span><span class="s0">in </span><span class="s1">e</span><span class="s2">.</span><span class="s1">stem</span><span class="s2">]</span>

        <span class="s1">super</span><span class="s2">().</span><span class="s1">on_enable</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">on_select_asset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s3">'None'</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">changes </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s1">index </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">e</span><span class="s2">.</span><span class="s1">model</span><span class="s2">:</span>
                <span class="s1">changes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">index</span><span class="s2">, </span><span class="s3">'model'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">name</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">changes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">index</span><span class="s2">, </span><span class="s3">'model'</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">name</span><span class="s2">))</span>

        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">name</span>
            <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s3">'cube'</span><span class="s2">:</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">collider </span><span class="s2">= </span><span class="s3">'cube'</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">collider </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s3">'None'</span>


<span class="s0">class </span><span class="s1">TextureMenu</span><span class="s2">(</span><span class="s1">AssetMenu</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">target_attr </span><span class="s2">= </span><span class="s3">'texture'</span>

    <span class="s0">def </span><span class="s1">on_enable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">search_for </span><span class="s2">= </span><span class="s3">''</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">asset_names </span><span class="s2">= [</span><span class="s3">'None'</span><span class="s2">, </span><span class="s3">'white_cube'</span><span class="s2">, </span><span class="s3">'brick'</span><span class="s2">, </span><span class="s3">'grass_tintable'</span><span class="s2">, </span><span class="s3">'radial_gradient'</span><span class="s2">, </span><span class="s3">'cog'</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">file_type </span><span class="s0">in </span><span class="s2">(</span><span class="s3">'.png'</span><span class="s2">, </span><span class="s3">'.jpg'</span><span class="s2">, </span><span class="s3">'.jpeg'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">asset_names </span><span class="s2">+= [</span><span class="s1">e</span><span class="s2">.</span><span class="s1">stem </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">application</span><span class="s2">.</span><span class="s1">asset_folder</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">f'**/</span><span class="s0">{</span><span class="s1">search_for</span><span class="s0">}</span><span class="s3">*</span><span class="s0">{</span><span class="s1">file_type</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)]</span>

        <span class="s1">super</span><span class="s2">().</span><span class="s1">on_enable</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">on_select_asset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s3">'None'</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_attr </span><span class="s2">== </span><span class="s3">'texture'</span><span class="s2">:</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">undo</span><span class="s2">.</span><span class="s1">record_undo</span><span class="s2">([(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">e</span><span class="s2">), </span><span class="s3">'texture'</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">texture</span><span class="s2">, </span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">])</span>
            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">texture </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s5"># LEVEL_EDITOR.current_scene.undo.record_undo([(LEVEL_EDITOR.entities.index(e), 'texture', e.texture, name) for e in LEVEL_EDITOR.selection])</span>
            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">set_shader_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target_attr</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>

        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">inspector</span><span class="s2">.</span><span class="s1">update_inspector</span><span class="s2">()</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s3">'None'</span>

<span class="s0">class </span><span class="s1">ShaderMenu</span><span class="s2">(</span><span class="s1">AssetMenu</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">on_enable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">asset_names </span><span class="s2">= [</span>
            <span class="s3">'unlit_shader'</span><span class="s2">,</span>
            <span class="s3">'lit_with_shadows_shader'</span><span class="s2">,</span>
            <span class="s3">'triplanar_shader'</span><span class="s2">,</span>
            <span class="s3">'matcap_shader'</span><span class="s2">,</span>
            <span class="s3">'normals_shader'</span><span class="s2">,</span>
        <span class="s2">]</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">on_enable</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">on_select_asset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s3">'None'</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">undo</span><span class="s2">.</span><span class="s1">record_undo</span><span class="s2">([(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">e</span><span class="s2">), </span><span class="s3">'shader'</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">shader</span><span class="s2">, </span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">])</span>
        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s1">exec</span><span class="s2">(</span><span class="s3">f'from ursina.shaders import </span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
            <span class="s1">exec</span><span class="s2">(</span><span class="s3">f'e.shader = </span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">inspector</span><span class="s2">.</span><span class="s1">update_inspector</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">ColorMenu</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bg </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'box'</span><span class="s2">, </span><span class="s1">z</span><span class="s2">=</span><span class="s4">.1</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">black</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s4">.8</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">scale</span><span class="s2">=(</span><span class="s4">.6</span><span class="s2">,</span><span class="s4">.15</span><span class="s2">), </span><span class="s1">position</span><span class="s2">=(-</span><span class="s4">.05</span><span class="s2">,</span><span class="s4">.03</span><span class="s2">), </span><span class="s1">model</span><span class="s2">=</span><span class="s1">Quad</span><span class="s2">(</span><span class="s1">aspect</span><span class="s2">=</span><span class="s4">.6</span><span class="s2">/</span><span class="s4">.15</span><span class="s2">))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">h_slider </span><span class="s2">= </span><span class="s1">Slider</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">'h'</span><span class="s2">, </span><span class="s1">min</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">max</span><span class="s2">=</span><span class="s4">360</span><span class="s2">, </span><span class="s1">step</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'h'</span><span class="s2">, </span><span class="s1">dynamic</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">world_parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">on_value_changed</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_slider_changed</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">h_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">white</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">h_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">texture </span><span class="s2">= </span><span class="s3">'rainbow'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">h_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">texture</span><span class="s2">.</span><span class="s1">filtering </span><span class="s2">= </span><span class="s0">True</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">s_slider </span><span class="s2">= </span><span class="s1">Slider</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">'s'</span><span class="s2">, </span><span class="s1">min</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">max</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">step</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">default</span><span class="s2">=</span><span class="s4">50</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'s'</span><span class="s2">, </span><span class="s1">dynamic</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">world_parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">on_value_changed</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_slider_changed</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">s_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">white</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">s_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">colors </span><span class="s2">= [</span><span class="s1">color</span><span class="s2">.</span><span class="s1">white </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">v_slider </span><span class="s2">= </span><span class="s1">Slider</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">'v'</span><span class="s2">, </span><span class="s1">min</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">max</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">default</span><span class="s2">=</span><span class="s4">50</span><span class="s2">, </span><span class="s1">step</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'v'</span><span class="s2">, </span><span class="s1">dynamic</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">world_parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">on_value_changed</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_slider_changed</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">v_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">colors </span><span class="s2">= [</span><span class="s1">color</span><span class="s2">.</span><span class="s1">black </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">v_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">v_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">white</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">a_slider </span><span class="s2">= </span><span class="s1">Slider</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">'a'</span><span class="s2">, </span><span class="s1">min</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">max</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">default</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">step</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'a'</span><span class="s2">, </span><span class="s1">dynamic</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">world_parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">on_value_changed</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_slider_changed</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">colors </span><span class="s2">= [</span><span class="s1">color</span><span class="s2">.</span><span class="s1">white </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">white</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">v</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] &lt; </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">a_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">color</span><span class="s2">.</span><span class="s1">clear</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>

        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">e </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">h_slider</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_slider</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">v_slider</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a_slider</span><span class="s2">)):</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">y </span><span class="s2">= -</span><span class="s1">i </span><span class="s2">* </span><span class="s4">.03</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">knob</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">white</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">*= </span><span class="s4">.5</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">bg </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'quad'</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'box'</span><span class="s2">, </span><span class="s1">visible_self</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">z</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">on_click</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">close</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">apply_color </span><span class="s2">= </span><span class="s0">True     </span><span class="s5"># set to False when you want to move the sliders but not update the color of the entities.</span>


    <span class="s0">def </span><span class="s1">on_slider_changed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">hsv</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">h_slider</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_slider</span><span class="s2">.</span><span class="s1">value</span><span class="s2">/</span><span class="s4">100</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">v_slider</span><span class="s2">.</span><span class="s1">value</span><span class="s2">/</span><span class="s4">100</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a_slider</span><span class="s2">.</span><span class="s1">value</span><span class="s2">/</span><span class="s4">100</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">apply_color</span><span class="s2">:</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">inspector</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s3">'color'</span><span class="s2">].</span><span class="s1">preview</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">value</span>
            <span class="s0">if not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">inspector</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s3">'color'</span><span class="s2">].</span><span class="s1">is_shader_input</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                    <span class="s1">e</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">value</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s5"># print('is shader input, set', inspector.fields['color'].attr_name)</span>
                <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                    <span class="s1">e</span><span class="s2">.</span><span class="s1">set_shader_input</span><span class="s2">(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">inspector</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s3">'color'</span><span class="s2">].</span><span class="s1">attr_name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>


        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">v</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] &lt; </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">s_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">color</span><span class="s2">.</span><span class="s1">gray</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">s_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">color</span><span class="s2">.</span><span class="s1">hsv</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">h</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">value</span><span class="s2">.</span><span class="s1">v</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">s_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>

        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">v_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">v</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] &gt; </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">v_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">color</span><span class="s2">.</span><span class="s1">hsv</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">h</span><span class="s2">, </span><span class="s1">value</span><span class="s2">.</span><span class="s1">s</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">v_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">a_slider</span><span class="s2">.</span><span class="s1">bg</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">value</span>


    <span class="s0">def </span><span class="s1">on_enable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">original_color </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">color</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">apply_color </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">h_slider</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">inspector</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s3">'color'</span><span class="s2">].</span><span class="s1">preview</span><span class="s2">.</span><span class="s1">color</span><span class="s2">.</span><span class="s1">h</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">s_slider</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">inspector</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s3">'color'</span><span class="s2">].</span><span class="s1">preview</span><span class="s2">.</span><span class="s1">color</span><span class="s2">.</span><span class="s1">s </span><span class="s2">* </span><span class="s4">100</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">v_slider</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">inspector</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s3">'color'</span><span class="s2">].</span><span class="s1">preview</span><span class="s2">.</span><span class="s1">color</span><span class="s2">.</span><span class="s1">v </span><span class="s2">* </span><span class="s4">100</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a_slider</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">inspector</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s3">'color'</span><span class="s2">].</span><span class="s1">preview</span><span class="s2">.</span><span class="s1">color</span><span class="s2">.</span><span class="s1">a </span><span class="s2">* </span><span class="s4">100</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">apply_color </span><span class="s2">= </span><span class="s0">True</span>


    <span class="s0">def </span><span class="s1">close</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s3">'None'</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">undo</span><span class="s2">.</span><span class="s1">record_undo</span><span class="s2">([(</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">e</span><span class="s2">), </span><span class="s3">'color'</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">original_color</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">color</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">ColliderMenu</span><span class="s2">(</span><span class="s1">AssetMenu</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">on_enable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">asset_names </span><span class="s2">= [</span><span class="s3">'None'</span><span class="s2">, </span><span class="s3">'box'</span><span class="s2">, </span><span class="s3">'sphere'</span><span class="s2">, </span><span class="s3">'mesh'</span><span class="s2">, ]</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">on_enable</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">on_select_asset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s3">'None'</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s5"># LEVEL_EDITOR.current_scene.undo.record_undo([(LEVEL_EDITOR.entities.index(e), 'collider', e.texture, name) for e in LEVEL_EDITOR.selection])</span>
        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">collider_type </span><span class="s2">= </span><span class="s1">name</span>

        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">inspector</span><span class="s2">.</span><span class="s1">update_inspector</span><span class="s2">()</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s3">'None'</span>


<span class="s0">class </span><span class="s1">ClassMenu</span><span class="s2">(</span><span class="s1">AssetMenu</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">available_classes </span><span class="s2">= {</span><span class="s3">'None'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">}</span>

    <span class="s0">def </span><span class="s1">on_enable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">asset_names </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">available_classes</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">on_enable</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">on_select_asset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s5"># LEVEL_EDITOR.current_scene.undo.record_undo([(LEVEL_EDITOR.entities.index(e), 'collider', e.texture, name) for e in LEVEL_EDITOR.selection])</span>
        <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'class_to_spawn'</span><span class="s2">):</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">class_to_spawn </span><span class="s2">= </span><span class="s1">name</span>

        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">inspector</span><span class="s2">.</span><span class="s1">update_inspector</span><span class="s2">()</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s3">'None'</span>


<span class="s0">class </span><span class="s1">Help</span><span class="s2">(</span><span class="s1">Button</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'?'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">.025</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'circle'</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">text_origin</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">position</span><span class="s2">=</span><span class="s1">window</span><span class="s2">.</span><span class="s1">top_left</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tooltip </span><span class="s2">= </span><span class="s1">Text</span><span class="s2">(</span>
            <span class="s1">position</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">position </span><span class="s2">+ </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">.05</span><span class="s2">,-</span><span class="s4">.05</span><span class="s2">,-</span><span class="s4">10</span><span class="s2">),</span>
            <span class="s5"># wordwrap=0,</span>
            <span class="s1">font</span><span class="s2">=</span><span class="s3">'VeraMono.ttf'</span><span class="s2">,</span>
            <span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">text</span><span class="s2">=</span><span class="s1">dedent</span><span class="s2">(</span><span class="s3">''' 
                Hotkeys: 
                n:          add new cube 
 
                d:          quick drag 
                w:          move tool 
                x/y/z:      hold to quick move on axis 
 
                c:          quick rotate on y axis 
                t:          tilt 
 
                e:          scale tool 
                s:          quick scale 
                s + x/y/z:  quick scale on axis 
 
                f:          move editor camera to point 
                shift+f:    reset editor camera position 
                shift+p:    toggle perspective/orthographic 
                shift+d:    duplicate 
            '''</span><span class="s2">).</span><span class="s1">strip</span><span class="s2">(),</span>
            <span class="s1">background</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s1">scale</span><span class="s2">=</span><span class="s4">.5</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tooltip</span><span class="s2">.</span><span class="s1">background</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">black</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tooltip</span><span class="s2">.</span><span class="s1">original_scale </span><span class="s2">= </span><span class="s4">.75</span>


<span class="s0">class </span><span class="s1">Duplicator</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">, </span><span class="s1">clones</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">plane </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">model</span><span class="s2">=</span><span class="s3">'plane'</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s3">'box'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">100</span><span class="s2">,</span><span class="s4">.1</span><span class="s2">,</span><span class="s4">100</span><span class="s2">), </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">visible</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dragger </span><span class="s2">= </span><span class="s1">Draggable</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">scene</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">collider</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dragging </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">start_position </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">clone_from_position </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock_gizmos </span><span class="s2">= [</span>
            <span class="s1">Entity</span><span class="s2">(</span><span class="s1">model</span><span class="s2">=</span><span class="s3">'cube'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">100</span><span class="s2">,</span><span class="s4">.01</span><span class="s2">,</span><span class="s4">.01</span><span class="s2">), </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">magenta</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dragger</span><span class="s2">, </span><span class="s1">unlit</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">),</span>
            <span class="s1">Entity</span><span class="s2">(</span><span class="s1">model</span><span class="s2">=</span><span class="s3">'cube'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">.01</span><span class="s2">,</span><span class="s4">100</span><span class="s2">,</span><span class="s4">.01</span><span class="s2">), </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">yellow</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dragger</span><span class="s2">, </span><span class="s1">unlit</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">),</span>
            <span class="s1">Entity</span><span class="s2">(</span><span class="s1">model</span><span class="s2">=</span><span class="s3">'cube'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">.01</span><span class="s2">,</span><span class="s4">.01</span><span class="s2">,</span><span class="s4">100</span><span class="s2">), </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">cyan</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dragger</span><span class="s2">, </span><span class="s1">unlit</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">),</span>
        <span class="s2">]</span>

    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">plane</span><span class="s2">.</span><span class="s1">enabled</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">dragger</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">world_point</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock </span><span class="s0">is not None</span><span class="s2">:</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock_gizmos</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock</span><span class="s2">].</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">dragger</span><span class="s2">.</span><span class="s1">z </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_position</span><span class="s2">.</span><span class="s1">z</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock </span><span class="s2">== </span><span class="s4">2</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">dragger</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_position</span><span class="s2">.</span><span class="s1">x</span>


    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">] </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'d' </span><span class="s0">and </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s5"># print('duplicate')</span>

            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s3">'None'</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">clones </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">clone </span><span class="s2">= </span><span class="s1">deepcopy</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>
                <span class="s1">clone</span><span class="s2">.</span><span class="s1">original_parent </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">parent</span>
                <span class="s1">clone</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">color</span>
                <span class="s1">clone</span><span class="s2">.</span><span class="s1">shader </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">shader</span>
                <span class="s1">clone</span><span class="s2">.</span><span class="s1">origin </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">origin</span>
                <span class="s1">clone</span><span class="s2">.</span><span class="s1">selectable </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">e</span><span class="s2">.</span><span class="s1">_shader_inputs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                    <span class="s1">clone</span><span class="s2">.</span><span class="s1">set_shader_input</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>

                <span class="s1">clone</span><span class="s2">.</span><span class="s1">collision </span><span class="s2">= </span><span class="s0">False</span>
                <span class="s1">clone</span><span class="s2">.</span><span class="s1">collider_type </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">collider_type</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">clones</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">clone</span><span class="s2">)</span>

            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">clones</span><span class="s2">)</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">clones</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">current_scene</span><span class="s2">.</span><span class="s1">undo</span><span class="s2">.</span><span class="s1">record_undo</span><span class="s2">((</span><span class="s3">'delete entities'</span><span class="s2">, [</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">en</span><span class="s2">) </span><span class="s0">for </span><span class="s1">en </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">clones</span><span class="s2">], [</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">clones</span><span class="s2">],))</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">clone_from_position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">clones</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">].</span><span class="s1">position</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">plane</span><span class="s2">.</span><span class="s1">y </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">].</span><span class="s1">world_y</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">plane</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>

            <span class="s1">mouse</span><span class="s2">.</span><span class="s1">traverse_target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">plane</span>
            <span class="s1">mouse</span><span class="s2">.</span><span class="s1">update</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">start_position </span><span class="s2">= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">world_point</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">dragger</span><span class="s2">.</span><span class="s1">world_position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_position</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">dragger</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock </span><span class="s2">= </span><span class="s0">None</span>

            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dragger</span>


        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">plane</span><span class="s2">.</span><span class="s1">enabled </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'left mouse up'</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">clones</span><span class="s2">:</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">world_parent </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">original_parent</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">plane</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">dragger</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">clones </span><span class="s2">= []</span>
            <span class="s1">mouse</span><span class="s2">.</span><span class="s1">traverse_target </span><span class="s2">= </span><span class="s1">scene</span>
            <span class="s2">[</span><span class="s1">e</span><span class="s2">.</span><span class="s1">disable</span><span class="s2">() </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock_gizmos</span><span class="s2">]</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>

        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">plane</span><span class="s2">.</span><span class="s1">enabled </span><span class="s0">and </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'middle mouse down'</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock </span><span class="s2">== </span><span class="s0">None</span><span class="s2">:</span>
                <span class="s1">delta_position </span><span class="s2">= (</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dragger</span><span class="s2">.</span><span class="s1">x</span><span class="s2">-</span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_position</span><span class="s2">.</span><span class="s1">x</span><span class="s2">), </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dragger</span><span class="s2">.</span><span class="s1">y</span><span class="s2">-</span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_position</span><span class="s2">.</span><span class="s1">y</span><span class="s2">), </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dragger</span><span class="s2">.</span><span class="s1">z</span><span class="s2">-</span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_position</span><span class="s2">.</span><span class="s1">z</span><span class="s2">))</span>
                <span class="s1">max_val </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">delta_position</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock </span><span class="s2">= </span><span class="s1">delta_position</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">max_val</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock_gizmos</span><span class="s2">:</span>
                    <span class="s1">e</span><span class="s2">.</span><span class="s1">world_position </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">clones</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">].</span><span class="s1">world_position</span>
                <span class="s5"># print('lock on axis:', delta_position, max_val, self.axis_lock)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">axis_lock </span><span class="s2">= </span><span class="s0">None</span>


<span class="s0">class </span><span class="s1">PokeShape</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s1">default_values </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">.</span><span class="s1">default_values </span><span class="s2">| </span><span class="s1">dict</span><span class="s2">(</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s3">'poke_shape'</span><span class="s2">,</span>
        <span class="s5"># make_wall=True,</span>
        <span class="s1">wall_height</span><span class="s2">=</span><span class="s4">1.0</span><span class="s2">,</span>
        <span class="s5"># wall_thickness=.1,</span>
        <span class="s1">subdivisions</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">smoothing_distance</span><span class="s2">=</span><span class="s4">.1</span><span class="s2">,</span>
        <span class="s1">points</span><span class="s2">=[</span><span class="s1">Vec3</span><span class="s2">(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,-</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,-</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">Vec3</span><span class="s2">(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">)],</span>
        <span class="s1">texture_scale</span><span class="s2">=</span><span class="s1">Vec2</span><span class="s2">(</span><span class="s4">.125</span><span class="s2">),</span>
        <span class="s1">collider_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>

    <span class="s2">) </span><span class="s5"># combine dicts</span>

    <span class="s1">gizmo_color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">violet</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">points</span><span class="s2">=[</span><span class="s1">Vec3</span><span class="s2">(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,-</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,-</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">), </span><span class="s1">Vec3</span><span class="s2">(-</span><span class="s4">.5</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">.5</span><span class="s2">)], **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">original_parent </span><span class="s2">= </span><span class="s1">LEVEL_EDITOR</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">selectable </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">highlight_color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">blue</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">default_values </span><span class="s2">| </span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">Mesh</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos </span><span class="s2">= </span><span class="s1">LoopingList</span><span class="s2">([</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">original_parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">position</span><span class="s2">=</span><span class="s1">e</span><span class="s2">, </span><span class="s1">selectable</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">'PokeShape_point'</span><span class="s2">, </span><span class="s1">is_gizmo</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">points</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">add_new_point_renderer </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">model</span><span class="s2">=</span><span class="s1">Mesh</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">=[], </span><span class="s1">mode</span><span class="s2">=</span><span class="s3">'point'</span><span class="s2">, </span><span class="s1">thickness</span><span class="s2">=</span><span class="s4">.075</span><span class="s2">), </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">white</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s4">.5</span><span class="s2">, </span><span class="s1">texture</span><span class="s2">=</span><span class="s3">'circle'</span><span class="s2">, </span><span class="s1">unlit</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">is_gizmo</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">selectable</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">always_on_top</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">add_collider </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">wall_parent </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_edit_mode </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">edit_mode </span><span class="s2">= </span><span class="s0">False</span>


    <span class="s0">def </span><span class="s1">draw_inspector</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">{</span><span class="s3">'edit_mode'</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">, </span><span class="s3">'wall_height'</span><span class="s2">: </span><span class="s1">float</span><span class="s2">, </span><span class="s3">'subdivisions'</span><span class="s2">:</span><span class="s1">int</span><span class="s2">, </span><span class="s3">'smoothing_distance'</span><span class="s2">:</span><span class="s1">float</span><span class="s2">}</span>


    <span class="s0">def </span><span class="s1">generate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">import </span><span class="s1">tripy</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos </span><span class="s2">= </span><span class="s1">LoopingList</span><span class="s2">([</span><span class="s1">e </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos </span><span class="s0">if </span><span class="s1">e</span><span class="s2">])</span>
        <span class="s1">polygon </span><span class="s2">= </span><span class="s1">LoopingList</span><span class="s2">(</span><span class="s1">Vec2</span><span class="s2">(*</span><span class="s1">e</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">(</span><span class="s1">relative_to</span><span class="s2">=</span><span class="s1">self</span><span class="s2">).</span><span class="s1">xz</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subdivisions</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">subdivisions</span><span class="s2">):</span>
                <span class="s1">smooth_polygon </span><span class="s2">= </span><span class="s1">LoopingList</span><span class="s2">()</span>
                <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">p </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">polygon</span><span class="s2">):</span>
                    <span class="s1">smooth_polygon</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">lerp</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">polygon</span><span class="s2">[</span><span class="s1">i</span><span class="s2">-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">smoothing_distance</span><span class="s2">))</span>
                    <span class="s1">smooth_polygon</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">lerp</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">polygon</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">smoothing_distance</span><span class="s2">))</span>
                <span class="s1">polygon </span><span class="s2">= </span><span class="s1">smooth_polygon</span>

        <span class="s1">triangles </span><span class="s2">= </span><span class="s1">tripy</span><span class="s2">.</span><span class="s1">earclip</span><span class="s2">(</span><span class="s1">polygon</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">tri </span><span class="s0">in </span><span class="s1">triangles</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">tri</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">Vec3</span><span class="s2">(</span><span class="s1">v</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s4">0</span><span class="s2">, </span><span class="s1">v</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">uvs </span><span class="s2">= [</span><span class="s1">Vec2</span><span class="s2">(</span><span class="s1">v</span><span class="s2">[</span><span class="s4">0</span><span class="s2">],</span><span class="s1">v</span><span class="s2">[</span><span class="s4">2</span><span class="s2">])*</span><span class="s4">1 </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">normals </span><span class="s2">= [</span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">))]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">texture </span><span class="s2">= </span><span class="s3">'grass'</span>
        <span class="s5"># [destroy(e) for e in self.wall_parent.children]</span>
        <span class="s5"># print('-------------', self.make_wall, self.wall_parent)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wall_parent</span><span class="s2">:</span>
            <span class="s5"># print('destroy old wall parent')</span>
            <span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">wall_parent</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">wall_parent </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wall_height</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wall_parent</span><span class="s2">:</span>
                <span class="s5"># print('make new wall parent')</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">wall_parent </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s1">Mesh</span><span class="s2">(), </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">dark_gray</span><span class="s2">, </span><span class="s1">add_to_scene_entities</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

            <span class="s5"># polygon_3d = [Vec3(e[0], 0, e[1]) for e in polygon]</span>
            <span class="s5"># polygon_3d.append(polygon_3d[0])</span>
            <span class="s5"># self.wall_parent.model = Pipe(base_shape=Quad(scale=(self.wall_thickness, self.wall_height)), path=polygon_3d)</span>
            <span class="s5"># self.wall_parent.model = Pipe(polygon_3d, path=[Vec3(0,0,0), Vec3(0,-10,0)])</span>
            <span class="s1">wall_verts </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">vert </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">polygon</span><span class="s2">):</span>
                <span class="s1">vert </span><span class="s2">= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s1">vert</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s4">0</span><span class="s2">, </span><span class="s1">vert</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
                <span class="s1">next_vert </span><span class="s2">= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s1">polygon</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">][</span><span class="s4">0</span><span class="s2">], </span><span class="s4">0</span><span class="s2">, </span><span class="s1">polygon</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">][</span><span class="s4">1</span><span class="s2">])</span>

                <span class="s1">wall_verts</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">((</span>
                    <span class="s1">vert</span><span class="s2">,</span>
                    <span class="s1">vert </span><span class="s2">+ </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,-</span><span class="s1">self</span><span class="s2">.</span><span class="s1">wall_height</span><span class="s2">,</span><span class="s4">0</span><span class="s2">),</span>
                    <span class="s1">next_vert</span><span class="s2">,</span>

                    <span class="s1">next_vert</span><span class="s2">,</span>
                    <span class="s1">vert </span><span class="s2">+ </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,-</span><span class="s1">self</span><span class="s2">.</span><span class="s1">wall_height</span><span class="s2">,</span><span class="s4">0</span><span class="s2">),</span>
                    <span class="s1">next_vert </span><span class="s2">+ </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,-</span><span class="s1">self</span><span class="s2">.</span><span class="s1">wall_height</span><span class="s2">,</span><span class="s4">0</span><span class="s2">),</span>
                <span class="s2">))</span>
            <span class="s5">#     # wall = Entity(model='cube', origin_x=-.5, scale=.1, position=vert, scale_x=distance(vert, next_vert), color=color.blue, parent=self.wall_parent, add_to_scene_entities=False)</span>
            <span class="s5">#     # wall.look_at(next_vert, 'right')</span>
            <span class="s5">#</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">wall_parent</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices </span><span class="s2">= </span><span class="s1">wall_verts</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">wall_parent</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>


        <span class="s5"># if self.add_collider:</span>
        <span class="s5">#     self.collider = self.model</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">edit_mode</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">add_new_point_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">e </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">add_new_point_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">lerp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">world_position</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">].</span><span class="s1">world_position</span><span class="s2">, </span><span class="s4">.5</span><span class="s2">))</span>
                <span class="s5"># self.add_new_point_renderer.model.vertices.append(self.point_gizmos[i].world_position)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">add_new_point_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">__deepcopy__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">memo</span><span class="s2">):</span>
        <span class="s1">changes </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_changes</span><span class="s2">(</span><span class="s1">__class__</span><span class="s2">)</span>

        <span class="s1">_copy </span><span class="s2">= </span><span class="s1">__class__</span><span class="s2">(</span><span class="s1">texture_scale </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">texture_scale</span><span class="s2">, **</span><span class="s1">changes</span><span class="s2">)</span>
        <span class="s1">_copy</span><span class="s2">.</span><span class="s1">texture_scale </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">texture_scale</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">'---------------'</span><span class="s2">, </span><span class="s1">_copy</span><span class="s2">.</span><span class="s1">texture_scale</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">_copy</span>


    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">points</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">e</span><span class="s2">.</span><span class="s1">position </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">edit_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_edit_mode</span>

    <span class="s2">@</span><span class="s1">edit_mode</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">edit_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>

        <span class="s5"># print('set edit mode', value)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_edit_mode </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s0">if </span><span class="s1">value</span><span class="s2">:</span>
            <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'selectable'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities </span><span class="s0">if not </span><span class="s1">e </span><span class="s2">== </span><span class="s1">self</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">:</span>
                <span class="s0">if not </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">:</span>
                    <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>

            <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'selectable'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">]</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s3">'y'</span><span class="s2">].</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">fake_gizmo</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s3">'y'</span><span class="s2">].</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">add_new_point_renderer</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">collider </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s2">[</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">]</span>
            <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'selectable'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">]</span>
            <span class="s0">if True in </span><span class="s2">[</span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">]: </span><span class="s5"># if point is selected when exiting edit mode, select the poke shape</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">, ]</span>

            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s3">'y'</span><span class="s2">].</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">gizmo</span><span class="s2">.</span><span class="s1">fake_gizmo</span><span class="s2">.</span><span class="s1">subgizmos</span><span class="s2">[</span><span class="s3">'y'</span><span class="s2">].</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">add_new_point_renderer</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">collider </span><span class="s2">= </span><span class="s3">'mesh'</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">wall_height</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_wall_height</span>
    <span class="s2">@</span><span class="s1">wall_height</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">wall_height</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_wall_height </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">edit_mode</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">left </span><span class="s0">or </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'d'</span><span class="s2">]:</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'tab' </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">]:</span>
            <span class="s0">if not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">edit_mode </span><span class="s2">= </span><span class="s0">False</span>

            <span class="s0">if </span><span class="s1">self </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">or True in </span><span class="s2">[</span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">]:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">edit_mode </span><span class="s2">= </span><span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">edit_mode</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">edit_mode </span><span class="s0">and </span><span class="s2">(</span><span class="s1">key </span><span class="s2">== </span><span class="s3">'left mouse down' </span><span class="s0">or </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'d'</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selector</span><span class="s2">.</span><span class="s1">get_hovered_entity</span><span class="s2">():</span>
                <span class="s0">return</span>
            <span class="s1">points_in_range </span><span class="s2">= [(</span><span class="s1">distance_2d</span><span class="s2">(</span><span class="s1">world_position_to_screen_position</span><span class="s2">(</span><span class="s1">v</span><span class="s2">), </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">position</span><span class="s2">), </span><span class="s1">v</span><span class="s2">) </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">add_new_point_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">]</span>
            <span class="s1">points_in_range </span><span class="s2">= [</span><span class="s1">e </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">points_in_range </span><span class="s0">if </span><span class="s1">e</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] &lt; </span><span class="s4">.075</span><span class="s2">/</span><span class="s4">2</span><span class="s2">]</span>
            <span class="s1">points_in_range</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">()</span>

            <span class="s1">closest_point </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s0">if not </span><span class="s1">points_in_range</span><span class="s2">:</span>
                <span class="s0">return</span>

            <span class="s1">closest_point </span><span class="s2">= </span><span class="s1">points_in_range</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">]</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">add_new_point_renderer</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">closest_point</span><span class="s2">)</span>

            <span class="s1">new_point </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">original_parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">position</span><span class="s2">=</span><span class="s1">lerp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">position</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">].</span><span class="s1">position</span><span class="s2">, </span><span class="s4">.5</span><span class="s2">), </span><span class="s1">selectable</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">is_gizmo</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">new_point</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">, </span><span class="s1">new_point</span><span class="s2">)</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'d'</span><span class="s2">:</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">quick_grabber</span><span class="s2">.</span><span class="s1">input</span><span class="s2">(</span><span class="s3">'d'</span><span class="s2">)</span>


        <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'space'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>

        <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'double click' </span><span class="s0">and </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selector</span><span class="s2">.</span><span class="s1">get_hovered_entity</span><span class="s2">() == </span><span class="s1">self</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">edit_mode </span><span class="s2">= </span><span class="s0">True</span>

        <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'double click' </span><span class="s0">and not </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selector</span><span class="s2">.</span><span class="s1">get_hovered_entity</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">edit_mode </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">edit_mode </span><span class="s0">and </span><span class="s1">key</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">' up'</span><span class="s2">):</span>
            <span class="s1">invoke</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">, </span><span class="s1">delay</span><span class="s2">=</span><span class="s4">3</span><span class="s2">/</span><span class="s4">60</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__setattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s3">'model' </span><span class="s0">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'model'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s0">and not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Mesh</span><span class="s2">):</span>
            <span class="s1">print_info</span><span class="s2">(</span><span class="s3">'can</span><span class="s0">\'</span><span class="s3">t set model of PokeShape'</span><span class="s2">)</span>
            <span class="s0">return</span>

        <span class="s1">super</span><span class="s2">().</span><span class="s1">__setattr__</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>



<span class="s0">class </span><span class="s1">PipeEditor</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">points</span><span class="s2">=[</span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)], **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">original_parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">, </span><span class="s1">selectable</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">'Pipe'</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos </span><span class="s2">= </span><span class="s1">LoopingList</span><span class="s2">([</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">original_parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">position</span><span class="s2">=</span><span class="s1">e</span><span class="s2">, </span><span class="s1">selectable</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">'PipeEditor_point'</span><span class="s2">, </span><span class="s1">is_gizmo</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">points</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">Pipe</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">edit_mode </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">add_collider </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">generate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># self.model.path = [e.get_position(relative_to=self) for e in self.point_gizmos]</span>
        <span class="s5"># self.model.thicknesses = [e.scale.xz for e in self.point_gizmos]</span>
        <span class="s5">#</span>
        <span class="s5"># self.model.generate()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">Pipe</span><span class="s2">(</span>
            <span class="s1">path </span><span class="s2">= [</span><span class="s1">e</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">(</span><span class="s1">relative_to</span><span class="s2">=</span><span class="s1">self</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">],</span>
            <span class="s1">thicknesses </span><span class="s2">= [</span><span class="s1">e</span><span class="s2">.</span><span class="s1">scale</span><span class="s2">.</span><span class="s1">xz </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s5"># print('GENERATE')</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">texture </span><span class="s2">= </span><span class="s3">'grass'</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">add_collider</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">collider </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span>


    <span class="s0">def </span><span class="s1">__deepcopy__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">memo</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">))</span>


    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">points</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">e</span><span class="s2">.</span><span class="s1">position </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">edit_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_edit_mode</span>

    <span class="s2">@</span><span class="s1">edit_mode</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">edit_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s5"># print('set edit mode', value)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_edit_mode </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s0">if </span><span class="s1">value</span><span class="s2">:</span>
            <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'selectable'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities </span><span class="s0">if not </span><span class="s1">e </span><span class="s2">== </span><span class="s1">self</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">:</span>
                <span class="s0">if not </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">:</span>
                    <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>

            <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'selectable'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s5"># print(self.point_gizmos[0] in LEVEL_EDITOR.entities)</span>
            <span class="s2">[</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">]</span>
            <span class="s2">[</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">'selectable'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">]</span>
            <span class="s0">if True in </span><span class="s2">[</span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">]: </span><span class="s5"># if point is selected when exiting edit mode, select the poke shape</span>
                <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">, ]</span>

        <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">render_selection</span><span class="s2">()</span>


    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'tab' </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'control'</span><span class="s2">] </span><span class="s0">and not </span><span class="s1">held_keys</span><span class="s2">[</span><span class="s3">'shift'</span><span class="s2">]:</span>
            <span class="s0">if </span><span class="s1">self </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">or True in </span><span class="s2">[</span><span class="s1">e </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">point_gizmos</span><span class="s2">]:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">edit_mode </span><span class="s2">= </span><span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">edit_mode</span>


        <span class="s5"># elif key == '+' and len(LEVEL_EDITOR.selection) == 1 and LEVEL_EDITOR.selection[0] in self.point_gizmos:</span>
        <span class="s5">#     print('add point')</span>
        <span class="s5">#     i = self.point_gizmos.index(LEVEL_EDITOR.selection[0])</span>
        <span class="s5">#</span>
        <span class="s5">#     new_point = Entity(parent=self, original_parent=self, position=lerp(self.point_gizmos[i].position, self.point_gizmos[i+1].position, .5), selectable=True, is_gizmo=True)</span>
        <span class="s5">#     LEVEL_EDITOR.entities.append(new_point)</span>
        <span class="s5">#     self.point_gizmos.insert(i+1, new_point)</span>
        <span class="s5">#     LEVEL_EDITOR.render_selection()</span>
        <span class="s5">#     # self.generate()</span>


        <span class="s0">elif </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'space'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>

        <span class="s5"># elif key == 'double click' and LEVEL_EDITOR.selection == [self, ] and selector.get_hovered_entity() == self:</span>
        <span class="s5">#     self.edit_mode = not self.edit_mode</span>

        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">edit_mode </span><span class="s0">and </span><span class="s1">key</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">' up'</span><span class="s2">):</span>
            <span class="s1">invoke</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">, </span><span class="s1">delay</span><span class="s2">=</span><span class="s4">3</span><span class="s2">/</span><span class="s4">60</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">SunHandler</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sun </span><span class="s2">= </span><span class="s1">DirectionalLight</span><span class="s2">(</span><span class="s1">shadow_map_resolution</span><span class="s2">=(</span><span class="s4">2048</span><span class="s2">,</span><span class="s4">2048</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sun</span><span class="s2">.</span><span class="s1">look_at</span><span class="s2">(</span><span class="s1">Vec3</span><span class="s2">(-</span><span class="s4">2</span><span class="s2">,-</span><span class="s4">1</span><span class="s2">,-</span><span class="s4">1</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'l'</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">'toggle sun'</span><span class="s2">)</span>
            <span class="s5"># self.sun.enabled = not self.sun.enabled</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sun</span><span class="s2">.</span><span class="s1">update_bounds</span><span class="s2">()</span>
            <span class="s5"># for e in LEVEL_EDITOR.entities:</span>
            <span class="s5">#     # e.shader = unlit_shader</span>
            <span class="s5">#     e.unlit = not e.unlit</span>

<span class="s0">from </span><span class="s1">ursina</span><span class="s2">.</span><span class="s1">prefabs</span><span class="s2">.</span><span class="s1">radial_menu </span><span class="s0">import </span><span class="s1">RadialMenu</span>
<span class="s0">class </span><span class="s1">RightClickMenu</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">radial_menu </span><span class="s2">= </span><span class="s1">RadialMenu</span><span class="s2">(</span>
            <span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">,</span>
            <span class="s1">buttons </span><span class="s2">= (</span>
                <span class="s1">Button</span><span class="s2">(</span><span class="s1">highlight_color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">azure</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'circle'</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'Model'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">1.5</span><span class="s2">, </span><span class="s1">on_click</span><span class="s2">=</span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">, </span><span class="s3">'state'</span><span class="s2">, </span><span class="s3">'model_menu'</span><span class="s2">)),</span>
                <span class="s1">Button</span><span class="s2">(</span><span class="s1">highlight_color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">azure</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'circle'</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'Tex'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">1.5</span><span class="s2">, </span><span class="s1">on_click</span><span class="s2">=</span><span class="s1">Sequence</span><span class="s2">(</span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">, </span><span class="s3">'state'</span><span class="s2">, </span><span class="s3">'texture_menu'</span><span class="s2">), </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">texture_menu</span><span class="s2">, </span><span class="s3">'target_attr'</span><span class="s2">, </span><span class="s3">'texture'</span><span class="s2">))),</span>
                <span class="s1">Button</span><span class="s2">(</span><span class="s1">highlight_color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">azure</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'circle'</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'Col'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">1.5</span><span class="s2">, </span><span class="s1">on_click</span><span class="s2">=</span><span class="s1">Sequence</span><span class="s2">(</span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">, </span><span class="s3">'state'</span><span class="s2">, </span><span class="s3">'color_menu'</span><span class="s2">), </span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">color_menu</span><span class="s2">, </span><span class="s3">'position'</span><span class="s2">, </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">position</span><span class="s2">))),</span>
                <span class="s1">Button</span><span class="s2">(</span><span class="s1">highlight_color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">azure</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'circle'</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'Sh'</span><span class="s2">,  </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">1.5</span><span class="s2">, </span><span class="s1">on_click</span><span class="s2">=</span><span class="s1">Func</span><span class="s2">(</span><span class="s1">setattr</span><span class="s2">, </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">menu_handler</span><span class="s2">, </span><span class="s3">'state'</span><span class="s2">, </span><span class="s3">'shader_menu'</span><span class="s2">)),</span>
                <span class="s1">Button</span><span class="s2">(</span><span class="s1">highlight_color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">black</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'circle'</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'del'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">.75</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">red</span><span class="s2">, </span><span class="s1">on_click</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">deleter</span><span class="s2">.</span><span class="s1">delete_selected</span><span class="s2">),</span>
                <span class="s1">Button</span><span class="s2">(</span><span class="s1">highlight_color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">azure</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'circle'</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s3">'Coll'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">1.5</span><span class="s2">),</span>
            <span class="s2">),</span>
            <span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">scale</span><span class="s2">=</span><span class="s4">.05</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'right mouse down'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">start_click_pos </span><span class="s2">= </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">position</span>

        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'right mouse up'</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection </span><span class="s0">and </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">mouse</span><span class="s2">.</span><span class="s1">position</span><span class="s2">-</span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_click_pos</span><span class="s2">) &lt; </span><span class="s4">.005 </span><span class="s0">and </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selector</span><span class="s2">.</span><span class="s1">get_hovered_entity</span><span class="s2">() </span><span class="s0">in </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">radial_menu</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>



<span class="s0">class </span><span class="s1">Search</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">input_field </span><span class="s2">= </span><span class="s1">InputField</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">ui</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s3">'space' </span><span class="s0">and </span><span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">input_field</span><span class="s2">.</span><span class="s1">enabled </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">input_field</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s3">''</span>

        <span class="s5"># elif len(key) == 1:</span>
        <span class="s5">#     print('---', self.input_field.text)</span>

<span class="s0">def </span><span class="s1">get_major_axis_relative_to_view</span><span class="s2">(</span><span class="s1">entity</span><span class="s2">): </span><span class="s5"># if we're looking at the entity from the right/left, return 0, top/bot:1, front/back: 2</span>
    <span class="s1">r </span><span class="s2">= </span><span class="s1">round</span><span class="s2">(</span><span class="s1">camera</span><span class="s2">.</span><span class="s1">back</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">entity</span><span class="s2">.</span><span class="s1">right</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">u </span><span class="s2">= </span><span class="s1">round</span><span class="s2">(</span><span class="s1">camera</span><span class="s2">.</span><span class="s1">back</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">entity</span><span class="s2">.</span><span class="s1">up</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">f </span><span class="s2">= </span><span class="s1">round</span><span class="s2">(</span><span class="s1">camera</span><span class="s2">.</span><span class="s1">back</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">entity</span><span class="s2">.</span><span class="s1">forward</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">dir </span><span class="s2">= (</span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">f</span><span class="s2">)</span>
    <span class="s1">axis_index </span><span class="s2">= </span><span class="s1">dir</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">max</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s1">abs</span><span class="s2">))</span>
    <span class="s1">is_positive_direction </span><span class="s2">= </span><span class="s1">dir</span><span class="s2">[</span><span class="s1">axis_index</span><span class="s2">] &gt; </span><span class="s4">0</span>

    <span class="s0">return </span><span class="s1">axis_index</span><span class="s2">, </span><span class="s1">is_positive_direction</span>


<span class="s0">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">'__main__'</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">ursina </span><span class="s0">import </span><span class="s2">*</span>
    <span class="s5"># from ursina.editor.level_editor import LevelEditor</span>

    <span class="s1">app </span><span class="s2">= </span><span class="s1">Ursina</span><span class="s2">(</span><span class="s1">vsync</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">class </span><span class="s1">Tree</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s3">'cube'</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span><span class="s2">.</span><span class="s1">brown</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">top </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">'tree_top'</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s4">1.5</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s3">'cube'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">.</span><span class="s1">green</span><span class="s2">, </span><span class="s1">selectable</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">LEVEL_EDITOR</span><span class="s2">.</span><span class="s1">entities</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">top</span><span class="s2">)</span>


    <span class="s1">level_editor </span><span class="s2">= </span><span class="s1">LevelEditor</span><span class="s2">()</span>
    <span class="s1">level_editor</span><span class="s2">.</span><span class="s1">goto_scene</span><span class="s2">(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">)</span>



    <span class="s1">level_editor</span><span class="s2">.</span><span class="s1">class_menu</span><span class="s2">.</span><span class="s1">available_classes </span><span class="s2">|= {</span><span class="s3">'WhiteCube'</span><span class="s2">: </span><span class="s1">WhiteCube</span><span class="s2">, </span><span class="s3">'EditorCamera'</span><span class="s2">:</span><span class="s1">EditorCamera</span><span class="s2">, }</span>

    <span class="s1">app</span><span class="s2">.</span><span class="s1">run</span><span class="s2">()</span>


    <span class="s5"># level_editor.prefabs.append(Tree)</span>
    <span class="s5"># level_editor.spawner.update_menu()</span>

    <span class="s5"># level_editor.selection = [level_editor.entities[0], ]</span>
    <span class="s5"># window.center_on_screen()</span>
    <span class="s5"># Sky()</span>
</pre>
</body>
</html>