<html>
<head>
<title>MetaInterval.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
MetaInterval.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
This module defines the various &quot;meta intervals&quot;, which execute other 
intervals either in parallel or in a specified sequential order. 
&quot;&quot;&quot;</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">'MetaInterval'</span><span class="s2">, </span><span class="s3">'Sequence'</span><span class="s2">, </span><span class="s3">'Parallel'</span><span class="s2">, </span><span class="s3">'ParallelEndTogether'</span><span class="s2">, </span><span class="s3">'Track'</span><span class="s2">]</span>

<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s2">*</span>
<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">direct </span><span class="s4">import </span><span class="s2">*</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">directnotify</span><span class="s2">.</span><span class="s1">DirectNotifyGlobal </span><span class="s4">import </span><span class="s2">*</span>
<span class="s4">from </span><span class="s2">.</span><span class="s1">IntervalManager </span><span class="s4">import </span><span class="s1">ivalMgr</span>
<span class="s4">from </span><span class="s2">. </span><span class="s4">import </span><span class="s1">Interval</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">task</span><span class="s2">.</span><span class="s1">Task </span><span class="s4">import </span><span class="s1">TaskManager</span>
<span class="s5">#if __debug__:</span>
<span class="s5">#    import direct.showbase.PythonUtil as PythonUtil</span>

<span class="s1">PREVIOUS_END </span><span class="s2">= </span><span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">RSPreviousEnd</span>
<span class="s1">PREVIOUS_START </span><span class="s2">= </span><span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">RSPreviousBegin</span>
<span class="s1">TRACK_START </span><span class="s2">= </span><span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">RSLevelBegin</span>

<span class="s4">class </span><span class="s1">MetaInterval</span><span class="s2">(</span><span class="s1">CMetaInterval</span><span class="s2">):</span>
    <span class="s5"># This is a Python-C++ hybrid class.  MetaInterval is a Python</span>
    <span class="s5"># extension of the C++ class CMetaInterval, which adds some</span>
    <span class="s5"># Python-specific features (like list management).</span>

    <span class="s5"># This is the base class of Sequence, Parallel, and Track.</span>

    <span class="s1">notify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s3">&quot;MetaInterval&quot;</span><span class="s2">)</span>

    <span class="s1">SequenceNum </span><span class="s2">= </span><span class="s6">1</span>
    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">ivals</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
        <span class="s5">#if __debug__:</span>
        <span class="s5">#    self.debugInitTraceback = PythonUtil.StackTrace(</span>
        <span class="s5">#        &quot;create interval&quot;, 1, 10)</span>

        <span class="s1">name </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s5">#if len(ivals) == 2 and isinstance(ivals[1], str):</span>
        <span class="s5">#    # If the second parameter is a string, it's the name.</span>
        <span class="s5">#    name = ivals[1]</span>
        <span class="s5">#    ivals = ivals[0]</span>
        <span class="s5">#else:</span>

        <span class="s5"># Look for the name in the keyword params.</span>
        <span class="s4">if </span><span class="s3">'name' </span><span class="s4">in </span><span class="s1">kw</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">kw</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">]</span>
            <span class="s4">del </span><span class="s1">kw</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">]</span>

        <span class="s5"># If the keyword &quot;autoPause&quot; or &quot;autoFinish&quot; is defined to</span>
        <span class="s5"># non-zero, it means the interval may be automatically paused</span>
        <span class="s5"># or finished when CIntervalManager::interrupt() is called.</span>
        <span class="s5"># This is generally called only on a catastrophic situation</span>
        <span class="s5"># (for instance, the connection to the server being lost) when</span>
        <span class="s5"># we have to exit right away; these keywords indicate</span>
        <span class="s5"># intervals that might not be cleaned up by their owners.</span>

        <span class="s1">autoPause </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s1">autoFinish </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s4">if </span><span class="s3">'autoPause' </span><span class="s4">in </span><span class="s1">kw</span><span class="s2">:</span>
            <span class="s1">autoPause </span><span class="s2">= </span><span class="s1">kw</span><span class="s2">[</span><span class="s3">'autoPause'</span><span class="s2">]</span>
            <span class="s4">del </span><span class="s1">kw</span><span class="s2">[</span><span class="s3">'autoPause'</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s3">'autoFinish' </span><span class="s4">in </span><span class="s1">kw</span><span class="s2">:</span>
            <span class="s1">autoFinish </span><span class="s2">= </span><span class="s1">kw</span><span class="s2">[</span><span class="s3">'autoFinish'</span><span class="s2">]</span>
            <span class="s4">del </span><span class="s1">kw</span><span class="s2">[</span><span class="s3">'autoFinish'</span><span class="s2">]</span>

        <span class="s5"># A duration keyword specifies the duration the interval will</span>
        <span class="s5"># appear to have for the purposes of computing the start time</span>
        <span class="s5"># for subsequent intervals in a sequence or track.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">phonyDuration </span><span class="s2">= -</span><span class="s6">1</span>
        <span class="s4">if </span><span class="s3">'duration' </span><span class="s4">in </span><span class="s1">kw</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">phonyDuration </span><span class="s2">= </span><span class="s1">kw</span><span class="s2">[</span><span class="s3">'duration'</span><span class="s2">]</span>
            <span class="s4">del </span><span class="s1">kw</span><span class="s2">[</span><span class="s3">'duration'</span><span class="s2">]</span>

        <span class="s4">if </span><span class="s1">kw</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Unexpected keyword parameters: %s&quot; </span><span class="s2">% (</span><span class="s1">list</span><span class="s2">(</span><span class="s1">kw</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())))</span>

        <span class="s5"># We must allow the old style: Track([ival0, ival1, ...]) as</span>
        <span class="s5"># well as the new style: Track(ival0, ival1, ...)</span>

        <span class="s5"># Note: this breaks in the case of a Track with one tuple:</span>
        <span class="s5"># Track((0, ival0),).  We could go through some effort to fix</span>
        <span class="s5"># this case, but for now I prefer just to document it as a</span>
        <span class="s5"># bug, since it will go away when we eventually remove support</span>
        <span class="s5"># for the old interface.</span>
        <span class="s5">#if len(ivals) == 1 and \</span>
        <span class="s5">#   (isinstance(ivals[0], tuple) or \</span>
        <span class="s5">#    isinstance(ivals[0], list)):</span>
        <span class="s5">#    self.ivals = ivals[0]</span>
        <span class="s5">#else:</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals </span><span class="s2">= </span><span class="s1">ivals</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__ivalsDirty </span><span class="s2">= </span><span class="s6">1</span>

        <span class="s4">if </span><span class="s1">name </span><span class="s2">== </span><span class="s4">None</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__ </span><span class="s2">+ </span><span class="s3">'-%d'</span>

        <span class="s4">if </span><span class="s3">'%' </span><span class="s4">in </span><span class="s1">name</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">name </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">SequenceNum</span><span class="s2">)</span>
            <span class="s1">MetaInterval</span><span class="s2">.</span><span class="s1">SequenceNum </span><span class="s2">+= </span><span class="s6">1</span>

        <span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__manager </span><span class="s2">= </span><span class="s1">ivalMgr</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setAutoPause</span><span class="s2">(</span><span class="s1">autoPause</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setAutoFinish</span><span class="s2">(</span><span class="s1">autoFinish</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">pstats </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">if __debug__ and </span><span class="s1">TaskManager</span><span class="s2">.</span><span class="s1">taskTimerVerbose</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pname </span><span class="s2">= </span><span class="s1">name</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'-'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)[</span><span class="s6">0</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pstats </span><span class="s2">= </span><span class="s1">PStatCollector</span><span class="s2">(</span><span class="s3">&quot;App:Show code:ivalLoop:%s&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pname</span><span class="s2">))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">pythonIvals </span><span class="s2">= []</span>

        <span class="s5"># If we are running in debug mode, we validate the intervals</span>
        <span class="s5"># in the list right away.  There's no good reason to do this,</span>
        <span class="s5"># except that it makes it easier for the programmer to detect</span>
        <span class="s5"># when a MetaInterval is misdefined at creation time.</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">validateComponents</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">)</span>



    <span class="s5"># Functions to make the MetaInterval object act just like a Python</span>
    <span class="s5"># list of intervals:</span>

    <span class="s4">def </span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">):</span>
        <span class="s5"># Appends a single interval to the list so far.</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__ivalsDirty </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">validateComponent</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ivals</span><span class="s2">):</span>
        <span class="s5"># Appends a list of intervals to the list so far.</span>
        <span class="s1">self </span><span class="s2">+= </span><span class="s1">ivals</span>

    <span class="s4">def </span><span class="s1">count</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">):</span>
        <span class="s5"># Returns the number of occurrences of the indicated interval.</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">.</span><span class="s1">count</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">):</span>
        <span class="s5"># Returns the position of the indicated interval within the list.</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">insert</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">):</span>
        <span class="s5"># Inserts the given interval into the middle of the list.</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__ivalsDirty </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">validateComponent</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">pop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">index </span><span class="s2">= </span><span class="s4">None</span><span class="s2">):</span>
        <span class="s5"># Returns element index (or the last element) and removes it</span>
        <span class="s5"># from the list.</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__ivalsDirty </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s4">if </span><span class="s1">index </span><span class="s2">== </span><span class="s4">None</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">index</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">):</span>
        <span class="s5"># Removes the indicated interval from the list.</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__ivalsDirty </span><span class="s2">= </span><span class="s6">1</span>

    <span class="s4">def </span><span class="s1">reverse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Reverses the order of the intervals.</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">.</span><span class="s1">reverse</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__ivalsDirty </span><span class="s2">= </span><span class="s6">1</span>

    <span class="s4">def </span><span class="s1">sort</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cmpfunc </span><span class="s2">= </span><span class="s4">None</span><span class="s2">):</span>
        <span class="s5"># Sorts the intervals. (?)</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__ivalsDirty </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s4">if </span><span class="s1">cmpfunc </span><span class="s2">== </span><span class="s4">None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">()</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">cmpfunc</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__len__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">index</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">index</span><span class="s2">]</span>

    <span class="s4">def </span><span class="s1">__setitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] = </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__ivalsDirty </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">validateComponent</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__delitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">index</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">)</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">index</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__ivalsDirty </span><span class="s2">= </span><span class="s6">1</span>

    <span class="s4">def </span><span class="s1">__getslice__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">i</span><span class="s2">: </span><span class="s1">j</span><span class="s2">])</span>

    <span class="s4">def </span><span class="s1">__setslice__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">, </span><span class="s1">s</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">i</span><span class="s2">: </span><span class="s1">j</span><span class="s2">] = </span><span class="s1">s</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__ivalsDirty </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">validateComponents</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__delslice__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">)</span>
        <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">i</span><span class="s2">: </span><span class="s1">j</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__ivalsDirty </span><span class="s2">= </span><span class="s6">1</span>

    <span class="s4">def </span><span class="s1">__iadd__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">MetaInterval</span><span class="s2">):</span>
            <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__ </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">__class__</span>
            <span class="s1">ivals </span><span class="s2">= </span><span class="s1">other</span><span class="s2">.</span><span class="s1">ivals</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">ivals </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals </span><span class="s2">+= </span><span class="s1">ivals</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__ivalsDirty </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">validateComponents</span><span class="s2">(</span><span class="s1">ivals</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">self</span>

    <span class="s4">def </span><span class="s1">__add__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s1">copy </span><span class="s2">= </span><span class="s1">self</span><span class="s2">[:]</span>
        <span class="s1">copy </span><span class="s2">+= </span><span class="s1">other</span>
        <span class="s4">return </span><span class="s1">copy</span>

    <span class="s5"># Functions to define sequence, parallel, and track behaviors:</span>

    <span class="s4">def </span><span class="s1">addSequence</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">list</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">, </span><span class="s1">duration</span><span class="s2">):</span>
        <span class="s5"># Adds the given list of intervals to the MetaInterval to be</span>
        <span class="s5"># played one after the other.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pushLevel</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">)</span>
        <span class="s4">for </span><span class="s1">ival </span><span class="s4">in </span><span class="s1">list</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">addInterval</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s6">0.0</span><span class="s2">, </span><span class="s1">PREVIOUS_END</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">popLevel</span><span class="s2">(</span><span class="s1">duration</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">addParallel</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">list</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">, </span><span class="s1">duration</span><span class="s2">):</span>
        <span class="s5"># Adds the given list of intervals to the MetaInterval to be</span>
        <span class="s5"># played simultaneously; all will start at the same time.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pushLevel</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">)</span>
        <span class="s4">for </span><span class="s1">ival </span><span class="s4">in </span><span class="s1">list</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">addInterval</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s6">0.0</span><span class="s2">, </span><span class="s1">TRACK_START</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">popLevel</span><span class="s2">(</span><span class="s1">duration</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">addParallelEndTogether</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">list</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">, </span><span class="s1">duration</span><span class="s2">):</span>
        <span class="s5"># Adds the given list of intervals to the MetaInterval to be</span>
        <span class="s5"># played simultaneously; all will end at the same time, but</span>
        <span class="s5"># the longest interval will be started first to achieve this.</span>

        <span class="s1">maxDuration </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s4">for </span><span class="s1">ival </span><span class="s4">in </span><span class="s1">list</span><span class="s2">:</span>
            <span class="s1">maxDuration </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">maxDuration</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">.</span><span class="s1">getDuration</span><span class="s2">())</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">pushLevel</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">)</span>
        <span class="s4">for </span><span class="s1">ival </span><span class="s4">in </span><span class="s1">list</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">addInterval</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s1">maxDuration </span><span class="s2">- </span><span class="s1">ival</span><span class="s2">.</span><span class="s1">getDuration</span><span class="s2">(), </span><span class="s1">TRACK_START</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">popLevel</span><span class="s2">(</span><span class="s1">duration</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">addTrack</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trackList</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">, </span><span class="s1">duration</span><span class="s2">):</span>
        <span class="s5"># Adds a &quot;track list&quot;.  This is a list of tuples of the form:</span>
        <span class="s5">#</span>
        <span class="s5">#   (&lt;delay&gt;, &lt;Interval&gt;,</span>
        <span class="s5">#       PREVIOUS_END | PREVIOUS_START | TRACK_START)</span>
        <span class="s5">#</span>
        <span class="s5"># where &lt;delay&gt; is a relative time, in seconds, for the</span>
        <span class="s5"># &lt;Interval&gt; to start, relative to either the end of the</span>
        <span class="s5"># previous interval (PREVIOUS_END), the start of the previous</span>
        <span class="s5"># interval (PREVIOUS_START) or the start of the track list</span>
        <span class="s5"># (TRACK_START).  If the relative code is omitted, the default</span>
        <span class="s5"># is TRACK_START.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pushLevel</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">)</span>
        <span class="s4">for </span><span class="s1">tupleObj </span><span class="s4">in </span><span class="s1">trackList</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">tupleObj</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">) </span><span class="s4">or </span><span class="s1">\</span>
               <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">tupleObj</span><span class="s2">, </span><span class="s1">list</span><span class="s2">):</span>
                <span class="s1">relTime </span><span class="s2">= </span><span class="s1">tupleObj</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
                <span class="s1">ival </span><span class="s2">= </span><span class="s1">tupleObj</span><span class="s2">[</span><span class="s6">1</span><span class="s2">]</span>
                <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">tupleObj</span><span class="s2">) &gt;= </span><span class="s6">3</span><span class="s2">:</span>
                    <span class="s1">relTo </span><span class="s2">= </span><span class="s1">tupleObj</span><span class="s2">[</span><span class="s6">2</span><span class="s2">]</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">relTo </span><span class="s2">= </span><span class="s1">TRACK_START</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">addInterval</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">)</span>

            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Not a tuple in Track: %s&quot; </span><span class="s2">% (</span><span class="s1">tupleObj</span><span class="s2">,))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">popLevel</span><span class="s2">(</span><span class="s1">duration</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">addInterval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">):</span>
        <span class="s5"># Adds the given interval to the MetaInterval.</span>

        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s1">CInterval</span><span class="s2">):</span>
            <span class="s5"># It's a C++-style Interval, so add it directly.</span>
            <span class="s4">if </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s3">&quot;inPython&quot;</span><span class="s2">, </span><span class="s6">0</span><span class="s2">):</span>
                <span class="s5"># Actually, it's been flagged to run in Python, even</span>
                <span class="s5"># though it's a C++ Interval.  It's probably got some</span>
                <span class="s5"># Python functors that must be invoked at runtime to</span>
                <span class="s5"># define some of its parameters.  Treat it as a Python</span>
                <span class="s5"># interval.</span>
                <span class="s1">index </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pythonIvals</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">pythonIvals</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">addExtIndex</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">(), </span><span class="s1">ival</span><span class="s2">.</span><span class="s1">getDuration</span><span class="s2">(),</span>
                                 <span class="s1">ival</span><span class="s2">.</span><span class="s1">getOpenEnded</span><span class="s2">(), </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">)</span>
            <span class="s4">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s1">MetaInterval</span><span class="s2">):</span>
                <span class="s5"># It's another MetaInterval, so copy in its intervals</span>
                <span class="s5"># directly to this object.  We could just store the</span>
                <span class="s5"># MetaInterval itself, which would work, but we get a</span>
                <span class="s5"># performance advantage by flattening out the deeply</span>
                <span class="s5"># nested hierarchy into a linear list within the root</span>
                <span class="s5"># CMetaInterval object.</span>
                <span class="s1">ival</span><span class="s2">.</span><span class="s1">applyIvals</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s5"># Nope, a perfectly ordinary C++ interval.  Hooray!</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">addCInterval</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s1">Interval</span><span class="s2">.</span><span class="s1">Interval</span><span class="s2">):</span>
            <span class="s5"># It's a Python-style Interval, so add it as an external.</span>
            <span class="s1">index </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pythonIvals</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pythonIvals</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pstats</span><span class="s2">:</span>
                <span class="s1">ival</span><span class="s2">.</span><span class="s1">pstats </span><span class="s2">= </span><span class="s1">PStatCollector</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pstats</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">.</span><span class="s1">pname</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">addExtIndex</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">(), </span><span class="s1">ival</span><span class="s2">.</span><span class="s1">getDuration</span><span class="s2">(),</span>
                             <span class="s1">ival</span><span class="s2">.</span><span class="s1">getOpenEnded</span><span class="s2">(), </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">)</span>

        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Not an Interval: %s&quot; </span><span class="s2">% (</span><span class="s1">ival</span><span class="s2">,))</span>

    <span class="s5"># Functions to support automatic playback of MetaIntervals along</span>
    <span class="s5"># with all of their associated Python callbacks:</span>

    <span class="s4">def </span><span class="s1">setManager</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">manager</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__manager </span><span class="s2">= </span><span class="s1">manager</span>
        <span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">setManager</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">manager</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">getManager</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__manager</span>

    <span class="s1">manager </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">getManager</span><span class="s2">, </span><span class="s1">setManager</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">setT</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">t</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__updateIvals</span><span class="s2">()</span>
        <span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">setT</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">t</span><span class="s2">)</span>

    <span class="s1">t </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">getT</span><span class="s2">, </span><span class="s1">setT</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">start</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">startT </span><span class="s2">= </span><span class="s6">0.0</span><span class="s2">, </span><span class="s1">endT </span><span class="s2">= -</span><span class="s6">1.0</span><span class="s2">, </span><span class="s1">playRate </span><span class="s2">= </span><span class="s6">1.0</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__updateIvals</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setupPlay</span><span class="s2">(</span><span class="s1">startT</span><span class="s2">, </span><span class="s1">endT</span><span class="s2">, </span><span class="s1">playRate</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__manager</span><span class="s2">.</span><span class="s1">addInterval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">loop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">startT </span><span class="s2">= </span><span class="s6">0.0</span><span class="s2">, </span><span class="s1">endT </span><span class="s2">= -</span><span class="s6">1.0</span><span class="s2">, </span><span class="s1">playRate </span><span class="s2">= </span><span class="s6">1.0</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__updateIvals</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setupPlay</span><span class="s2">(</span><span class="s1">startT</span><span class="s2">, </span><span class="s1">endT</span><span class="s2">, </span><span class="s1">playRate</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__manager</span><span class="s2">.</span><span class="s1">addInterval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">pause</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">() == </span><span class="s1">CInterval</span><span class="s2">.</span><span class="s1">SStarted</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">privInterrupt</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__manager</span><span class="s2">.</span><span class="s1">removeInterval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">privPostEvent</span><span class="s2">()</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getT</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">resume</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">startT </span><span class="s2">= </span><span class="s4">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__updateIvals</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">startT </span><span class="s2">!= </span><span class="s4">None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">setT</span><span class="s2">(</span><span class="s1">startT</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setupResume</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__manager</span><span class="s2">.</span><span class="s1">addInterval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">resumeUntil</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">endT</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__updateIvals</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setupResumeUntil</span><span class="s2">(</span><span class="s1">endT</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__manager</span><span class="s2">.</span><span class="s1">addInterval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">finish</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__updateIvals</span><span class="s2">()</span>
        <span class="s1">state </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">state </span><span class="s2">== </span><span class="s1">CInterval</span><span class="s2">.</span><span class="s1">SInitial</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">privInstant</span><span class="s2">()</span>
        <span class="s4">elif </span><span class="s1">state </span><span class="s2">!= </span><span class="s1">CInterval</span><span class="s2">.</span><span class="s1">SFinal</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">privFinalize</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__manager</span><span class="s2">.</span><span class="s1">removeInterval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">privPostEvent</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">clearToInitial</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># This is overloaded at the Python level to properly call</span>
        <span class="s5"># pause() at the Python level, then upcall to finish the job</span>
        <span class="s5"># at the C++ level.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pause</span><span class="s2">()</span>
        <span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">clearToInitial</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s5"># Internal functions:</span>

    <span class="s4">def </span><span class="s1">validateComponent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">component</span><span class="s2">):</span>
        <span class="s5"># This is called only in debug mode to verify that the</span>
        <span class="s5"># indicated component added to the MetaInterval is appropriate</span>
        <span class="s5"># to this type of MetaInterval.  In most cases except Track,</span>
        <span class="s5"># this is the same as asking that the component is itself an</span>
        <span class="s5"># Interval.</span>
        <span class="s4">return </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">component</span><span class="s2">, </span><span class="s1">CInterval</span><span class="s2">) </span><span class="s4">or </span><span class="s1">\</span>
               <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">component</span><span class="s2">, </span><span class="s1">Interval</span><span class="s2">.</span><span class="s1">Interval</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">validateComponents</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">components</span><span class="s2">):</span>
        <span class="s5"># This is called only in debug mode to verify that all the</span>
        <span class="s5"># components on the indicated list are appropriate to this</span>
        <span class="s5"># type of MetaInterval.</span>
        <span class="s4">for </span><span class="s1">component </span><span class="s4">in </span><span class="s1">components</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">validateComponent</span><span class="s2">(</span><span class="s1">component</span><span class="s2">):</span>
                <span class="s4">return </span><span class="s6">0</span>
        <span class="s4">return </span><span class="s6">1</span>

    <span class="s4">def </span><span class="s1">__updateIvals</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># The MetaInterval object does not create the C++ list of</span>
        <span class="s5"># Intervals immediately; rather, it stores a Python list of</span>
        <span class="s5"># Intervals that will be compiled into the C++ list the first</span>
        <span class="s5"># time it is needed.</span>

        <span class="s5"># This design allows us to avoid creation of the C++ list for</span>
        <span class="s5"># nested MetaInterval objects, instead copying all nested</span>
        <span class="s5"># MetaInterval hierarchy into the root CMetaInterval object,</span>
        <span class="s5"># for a performance benefit.</span>

        <span class="s5"># This function is called only on the root MetaInterval</span>
        <span class="s5"># object, when it is time to build the C++ list for itself.</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__ivalsDirty</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">clearIntervals</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">applyIvals</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">TRACK_START</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__ivalsDirty </span><span class="s2">= </span><span class="s6">0</span>

    <span class="s4">def </span><span class="s1">clearIntervals</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># This overrides the function defined at the C++ level to</span>
        <span class="s5"># reset the inPython flag.  Clearing out the intervals list</span>
        <span class="s5"># allows us to run entirely in C++ again, at least until a new</span>
        <span class="s5"># Python interval gets added.</span>
        <span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">clearIntervals</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inPython </span><span class="s2">= </span><span class="s6">0</span>

    <span class="s4">def </span><span class="s1">applyIvals</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">meta</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">):</span>
        <span class="s5"># Add the intervals listed in this object to the given</span>
        <span class="s5"># MetaInterval object at the C++ level.  This will make the</span>
        <span class="s5"># other MetaInterval object ready to play the intervals.</span>

        <span class="s5"># This function should be overridden in a derived class to</span>
        <span class="s5"># change the intepretation of the intervals in this list.  In</span>
        <span class="s5"># the case of a MetaInterval directly, this is valid only if</span>
        <span class="s5"># the list has only zero or one intervals.</span>

        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">) == </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s4">pass</span>
        <span class="s4">elif </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">) == </span><span class="s6">1</span><span class="s2">:</span>
            <span class="s1">meta</span><span class="s2">.</span><span class="s1">addInterval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Cannot build list from MetaInterval directly.&quot;</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">setPlayRate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">playRate</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Changes the play rate of the interval.  If the interval is 
        already started, this changes its speed on-the-fly.  Note that 
        since playRate is a parameter to start() and loop(), the next 
        call to start() or loop() will reset this parameter. &quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">isPlaying</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pause</span><span class="s2">()</span>
            <span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">setPlayRate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">playRate</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">resume</span><span class="s2">()</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">setPlayRate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">playRate</span><span class="s2">)</span>

    <span class="s1">play_rate </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">getPlayRate</span><span class="s2">, </span><span class="s1">setPlayRate</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__doPythonCallbacks</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># This function invokes any Python-level Intervals that need</span>
        <span class="s5"># to be invoked at this point in time.  It must be called</span>
        <span class="s5"># after any call to setT() or setFinalT() or stepPlay(), or</span>
        <span class="s5"># some such; basically any function that might invoke an</span>
        <span class="s5"># interval.  The C++ base class will invoke whatever C++</span>
        <span class="s5"># intervals it can, and then indicate the Python intervals</span>
        <span class="s5"># that must be invoked through this interface.</span>

        <span class="s1">ival </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s4">while </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">isEventReady</span><span class="s2">()):</span>
                <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getEventIndex</span><span class="s2">()</span>
                <span class="s1">t </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getEventT</span><span class="s2">()</span>
                <span class="s1">eventType </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getEventType</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">popEvent</span><span class="s2">()</span>

                <span class="s1">ival </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pythonIvals</span><span class="s2">[</span><span class="s1">index</span><span class="s2">]</span>
                <span class="s1">ival</span><span class="s2">.</span><span class="s1">privDoEvent</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">eventType</span><span class="s2">)</span>
                <span class="s1">ival</span><span class="s2">.</span><span class="s1">privPostEvent</span><span class="s2">()</span>
                <span class="s1">ival </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">except</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">ival </span><span class="s2">!= </span><span class="s4">None</span><span class="s2">:</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Exception occurred while processing %s of %s:&quot; </span><span class="s2">% (</span><span class="s1">ival</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">()))</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Exception occurred while processing %s:&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">()))</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s4">raise</span>

    <span class="s4">def </span><span class="s1">privDoEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">event</span><span class="s2">):</span>
        <span class="s5"># This function overrides the C++ function to initialize the</span>
        <span class="s5"># intervals first if necessary.</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pstats</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pstats</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__updateIvals</span><span class="s2">()</span>
        <span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">privDoEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">event</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pstats</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pstats</span><span class="s2">.</span><span class="s1">stop</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">privPostEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pstats</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pstats</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__doPythonCallbacks</span><span class="s2">()</span>
        <span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">privPostEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pstats</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pstats</span><span class="s2">.</span><span class="s1">stop</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">setIntervalStartTime</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
        <span class="s5"># This function overrides from the parent level to force it to</span>
        <span class="s5"># update the interval list first, if necessary.</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__updateIvals</span><span class="s2">()</span>
        <span class="s5"># Once we have monkeyed with the interval timings, we'd better</span>
        <span class="s5"># run the whole thing as a monolithic Python interval, since</span>
        <span class="s5"># we can't extract the ivals list back out and append them</span>
        <span class="s5"># into a parent MetaInterval.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inPython </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s4">return </span><span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">setIntervalStartTime</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">getIntervalStartTime</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
        <span class="s5"># This function overrides from the parent level to force it to</span>
        <span class="s5"># update the interval list first, if necessary.</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__updateIvals</span><span class="s2">()</span>
        <span class="s4">return </span><span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">getIntervalStartTime</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">)</span>


    <span class="s4">def </span><span class="s1">getDuration</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># This function overrides from the parent level to force it to</span>
        <span class="s5"># update the interval list first, if necessary.</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__updateIvals</span><span class="s2">()</span>
        <span class="s4">return </span><span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">getDuration</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s1">duration </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">getDuration</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
        <span class="s5"># This function overrides from the parent level to force it to</span>
        <span class="s5"># update the interval list first, if necessary.</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__updateIvals</span><span class="s2">()</span>
        <span class="s4">return </span><span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
        <span class="s5"># This function overrides from the parent level to force it to</span>
        <span class="s5"># update the interval list first, if necessary.</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__updateIvals</span><span class="s2">()</span>
        <span class="s4">return </span><span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">)</span>


    <span class="s4">def </span><span class="s1">timeline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">out </span><span class="s2">= </span><span class="s4">None</span><span class="s2">):</span>
        <span class="s5"># This function overrides from the parent level to force it to</span>
        <span class="s5"># update the interval list first, if necessary.</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__updateIvals</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">out </span><span class="s2">== </span><span class="s4">None</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">ostream</span>
        <span class="s1">CMetaInterval</span><span class="s2">.</span><span class="s1">timeline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">out</span><span class="s2">)</span>

    <span class="s1">add_sequence </span><span class="s2">= </span><span class="s1">addSequence</span>
    <span class="s1">add_parallel </span><span class="s2">= </span><span class="s1">addParallel</span>
    <span class="s1">add_parallel_end_together </span><span class="s2">= </span><span class="s1">addParallelEndTogether</span>
    <span class="s1">add_track </span><span class="s2">= </span><span class="s1">addTrack</span>
    <span class="s1">add_interval </span><span class="s2">= </span><span class="s1">addInterval</span>
    <span class="s1">set_manager </span><span class="s2">= </span><span class="s1">setManager</span>
    <span class="s1">get_manager </span><span class="s2">= </span><span class="s1">getManager</span>
    <span class="s1">set_t </span><span class="s2">= </span><span class="s1">setT</span>
    <span class="s1">resume_until </span><span class="s2">= </span><span class="s1">resumeUntil</span>
    <span class="s1">clear_to_initial </span><span class="s2">= </span><span class="s1">clearToInitial</span>
    <span class="s1">clear_intervals </span><span class="s2">= </span><span class="s1">clearIntervals</span>
    <span class="s1">set_play_rate </span><span class="s2">= </span><span class="s1">setPlayRate</span>
    <span class="s1">priv_do_event </span><span class="s2">= </span><span class="s1">privDoEvent</span>
    <span class="s1">priv_post_event </span><span class="s2">= </span><span class="s1">privPostEvent</span>
    <span class="s1">set_interval_start_time </span><span class="s2">= </span><span class="s1">setIntervalStartTime</span>
    <span class="s1">get_interval_start_time </span><span class="s2">= </span><span class="s1">getIntervalStartTime</span>
    <span class="s1">get_duration </span><span class="s2">= </span><span class="s1">getDuration</span>


<span class="s4">class </span><span class="s1">Sequence</span><span class="s2">(</span><span class="s1">MetaInterval</span><span class="s2">):</span>
    <span class="s4">def </span><span class="s1">applyIvals</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">meta</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">):</span>
        <span class="s1">meta</span><span class="s2">.</span><span class="s1">addSequence</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">(),</span>
                         <span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phonyDuration</span><span class="s2">)</span>
<span class="s4">class </span><span class="s1">Parallel</span><span class="s2">(</span><span class="s1">MetaInterval</span><span class="s2">):</span>
    <span class="s4">def </span><span class="s1">applyIvals</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">meta</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">):</span>
        <span class="s1">meta</span><span class="s2">.</span><span class="s1">addParallel</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">(),</span>
                         <span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phonyDuration</span><span class="s2">)</span>

<span class="s4">class </span><span class="s1">ParallelEndTogether</span><span class="s2">(</span><span class="s1">MetaInterval</span><span class="s2">):</span>
    <span class="s4">def </span><span class="s1">applyIvals</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">meta</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">):</span>
        <span class="s1">meta</span><span class="s2">.</span><span class="s1">addParallelEndTogether</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">(),</span>
                         <span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phonyDuration</span><span class="s2">)</span>

<span class="s4">class </span><span class="s1">Track</span><span class="s2">(</span><span class="s1">MetaInterval</span><span class="s2">):</span>
    <span class="s4">def </span><span class="s1">applyIvals</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">meta</span><span class="s2">, </span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">):</span>
        <span class="s1">meta</span><span class="s2">.</span><span class="s1">addTrack</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">(),</span>
                      <span class="s1">relTime</span><span class="s2">, </span><span class="s1">relTo</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phonyDuration</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">validateComponent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tupleObj</span><span class="s2">):</span>
        <span class="s5"># This is called only in debug mode to verify that the</span>
        <span class="s5"># indicated component added to the MetaInterval is appropriate</span>
        <span class="s5"># to this type of MetaInterval.  In most cases except Track,</span>
        <span class="s5"># this is the same as asking that the component is itself an</span>
        <span class="s5"># Interval.</span>

        <span class="s4">if not </span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">tupleObj</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">) </span><span class="s4">or </span><span class="s1">\</span>
                <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">tupleObj</span><span class="s2">, </span><span class="s1">list</span><span class="s2">)):</span>
            <span class="s5"># It's not a tuple.</span>
            <span class="s4">return </span><span class="s6">0</span>

        <span class="s1">relTime </span><span class="s2">= </span><span class="s1">tupleObj</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
        <span class="s1">ival </span><span class="s2">= </span><span class="s1">tupleObj</span><span class="s2">[</span><span class="s6">1</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">tupleObj</span><span class="s2">) &gt;= </span><span class="s6">3</span><span class="s2">:</span>
            <span class="s1">relTo </span><span class="s2">= </span><span class="s1">tupleObj</span><span class="s2">[</span><span class="s6">2</span><span class="s2">]</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">relTo </span><span class="s2">= </span><span class="s1">TRACK_START</span>

        <span class="s4">if not </span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">float</span><span class="s2">) </span><span class="s4">or </span><span class="s1">\</span>
                <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">relTime</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)):</span>
            <span class="s5"># First parameter is not a number.</span>
            <span class="s4">return </span><span class="s6">0</span>
        <span class="s4">if not </span><span class="s1">MetaInterval</span><span class="s2">.</span><span class="s1">validateComponent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">):</span>
            <span class="s5"># Second parameter is not an interval.</span>
            <span class="s4">return </span><span class="s6">0</span>
        <span class="s4">if </span><span class="s1">relTo </span><span class="s2">!= </span><span class="s1">PREVIOUS_END </span><span class="s4">and </span><span class="s1">\</span>
           <span class="s1">relTo </span><span class="s2">!= </span><span class="s1">PREVIOUS_START </span><span class="s4">and </span><span class="s1">\</span>
           <span class="s1">relTo </span><span class="s2">!= </span><span class="s1">TRACK_START</span><span class="s2">:</span>
            <span class="s5"># Third parameter is an invalid value.</span>
            <span class="s4">return </span><span class="s6">0</span>

        <span class="s5"># Looks good.</span>
        <span class="s4">return </span><span class="s6">1</span>
</pre>
</body>
</html>