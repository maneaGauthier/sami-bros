<html>
<head>
<title>AppRunner.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
AppRunner.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
This module is intended to be compiled into the Panda3D runtime 
distributable, to execute a packaged p3d application, but it can also 
be run directly via the Python interpreter (if the current Panda3D and 
Python versions match the version expected by the application).  See 
runp3d.py for a command-line tool to invoke this module. 
 
The global AppRunner instance may be imported as follows:: 
 
   from direct.showbase.AppRunnerGlobal import appRunner 
 
This will be None if Panda was not run from the runtime environment. 
 
.. deprecated:: 1.10.0 
   The p3d packaging system has been replaced with the new setuptools-based 
   system.  See the :ref:`distribution` manual section. 
&quot;&quot;&quot;</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">&quot;AppRunner&quot;</span><span class="s2">, </span><span class="s3">&quot;dummyAppRunner&quot;</span><span class="s2">, </span><span class="s3">&quot;ArgumentError&quot;</span><span class="s2">]</span>

<span class="s4">import </span><span class="s1">sys</span>
<span class="s4">import </span><span class="s1">os</span>

<span class="s4">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">):</span>
    <span class="s4">import </span><span class="s1">builtins</span>
<span class="s4">else</span><span class="s2">:</span>
    <span class="s4">import </span><span class="s1">__builtin__ </span><span class="s4">as </span><span class="s1">builtins</span>

<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase </span><span class="s4">import </span><span class="s1">VFSImporter</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase</span><span class="s2">.</span><span class="s1">DirectObject </span><span class="s4">import </span><span class="s1">DirectObject</span>
<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s1">VirtualFileSystem</span><span class="s2">, </span><span class="s1">Filename</span><span class="s2">, </span><span class="s1">Multifile</span><span class="s2">, </span><span class="s1">loadPrcFileData</span><span class="s2">, </span><span class="s1">unloadPrcFile</span><span class="s2">, </span><span class="s1">getModelPath</span><span class="s2">, </span><span class="s1">WindowProperties</span><span class="s2">, </span><span class="s1">ExecutionEnvironment</span><span class="s2">, </span><span class="s1">PandaSystem</span><span class="s2">, </span><span class="s1">Notify</span><span class="s2">, </span><span class="s1">StreamWriter</span><span class="s2">, </span><span class="s1">ConfigVariableString</span><span class="s2">, </span><span class="s1">ConfigPageManager</span>
<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">direct </span><span class="s4">import </span><span class="s1">init_app_for_gui</span>
<span class="s4">from </span><span class="s1">panda3d </span><span class="s4">import </span><span class="s1">core</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">stdpy </span><span class="s4">import </span><span class="s1">file</span><span class="s2">, </span><span class="s1">glob</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">task</span><span class="s2">.</span><span class="s1">TaskManagerGlobal </span><span class="s4">import </span><span class="s1">taskMgr</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase</span><span class="s2">.</span><span class="s1">MessengerGlobal </span><span class="s4">import </span><span class="s1">messenger</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase </span><span class="s4">import </span><span class="s1">AppRunnerGlobal</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">directnotify</span><span class="s2">.</span><span class="s1">DirectNotifyGlobal </span><span class="s4">import </span><span class="s1">directNotify</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">p3d</span><span class="s2">.</span><span class="s1">HostInfo </span><span class="s4">import </span><span class="s1">HostInfo</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">p3d</span><span class="s2">.</span><span class="s1">ScanDirectoryNode </span><span class="s4">import </span><span class="s1">ScanDirectoryNode</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">p3d</span><span class="s2">.</span><span class="s1">InstalledHostData </span><span class="s4">import </span><span class="s1">InstalledHostData</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">p3d</span><span class="s2">.</span><span class="s1">InstalledPackageData </span><span class="s4">import </span><span class="s1">InstalledPackageData</span>

<span class="s6"># These imports are read by the C++ wrapper in p3dPythonRun.cxx.</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">p3d</span><span class="s2">.</span><span class="s1">JavaScript </span><span class="s4">import </span><span class="s1">Undefined</span><span class="s2">, </span><span class="s1">ConcreteStruct</span>

<span class="s4">class </span><span class="s1">ArgumentError</span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">):</span>
    <span class="s4">pass</span>

<span class="s4">class </span><span class="s1">ScriptAttributes</span><span class="s2">:</span>
    <span class="s0">&quot;&quot;&quot; This dummy class serves as the root object for the scripting 
    interface.  The Python code can store objects and functions here 
    for direct inspection by the browser's JavaScript code. &quot;&quot;&quot;</span>
    <span class="s4">pass</span>

<span class="s4">class </span><span class="s1">AppRunner</span><span class="s2">(</span><span class="s1">DirectObject</span><span class="s2">):</span>

    <span class="s0">&quot;&quot;&quot; This class is intended to be compiled into the Panda3D runtime 
    distributable, to execute a packaged p3d application.  It also 
    provides some useful runtime services while running in that 
    packaged environment. 
 
    It does not usually exist while running Python directly, but you 
    can use dummyAppRunner() to create one at startup for testing or 
    development purposes.  &quot;&quot;&quot;</span>

    <span class="s1">notify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s3">&quot;AppRunner&quot;</span><span class="s2">)</span>

    <span class="s1">ConfigBasename </span><span class="s2">= </span><span class="s3">'config.xml'</span>

    <span class="s6"># Default values for parameters that are absent from the config file:</span>
    <span class="s1">maxDiskUsage </span><span class="s2">= </span><span class="s5">2048 </span><span class="s2">* </span><span class="s5">1048576  </span><span class="s6"># 2 GB</span>

    <span class="s6"># Values for verifyContents, from p3d_plugin.h</span>
    <span class="s1">P3DVCNone </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">P3DVCNormal </span><span class="s2">= </span><span class="s5">1</span>
    <span class="s1">P3DVCForce </span><span class="s2">= </span><span class="s5">2</span>
    <span class="s1">P3DVCNever </span><span class="s2">= </span><span class="s5">3</span>

    <span class="s6"># Also from p3d_plugin.h</span>
    <span class="s1">P3D_CONTENTS_DEFAULT_MAX_AGE </span><span class="s2">= </span><span class="s5">5</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">DirectObject</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

        <span class="s6"># We direct both our stdout and stderr objects onto Panda's</span>
        <span class="s6"># Notify stream.  This ensures that unadorned print statements</span>
        <span class="s6"># made within Python will get routed into the log properly.</span>
        <span class="s1">stream </span><span class="s2">= </span><span class="s1">StreamWriter</span><span class="s2">(</span><span class="s1">Notify</span><span class="s2">.</span><span class="s1">out</span><span class="s2">(), </span><span class="s4">False</span><span class="s2">)</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">stdout </span><span class="s2">= </span><span class="s1">stream</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">stderr </span><span class="s2">= </span><span class="s1">stream</span>

        <span class="s6"># This is set true by dummyAppRunner(), below.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dummy </span><span class="s2">= </span><span class="s4">False</span>

        <span class="s6"># These will be set from the application flags when</span>
        <span class="s6"># setP3DFilename() is called.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">allowPythonDev </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">guiApp </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">interactiveConsole </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">initialAppImport </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">trueFileIO </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">respectPerPlatform </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">verifyContents </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">P3DVCNone</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">sessionId </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">packedAppEnvironmentInitialized </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">gotWindow </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">gotP3DFilename </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dFilename </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dUrl </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">started </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">windowOpened </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">windowPrc </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">http </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">core</span><span class="s2">, </span><span class="s3">'HTTPClient'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">http </span><span class="s2">= </span><span class="s1">core</span><span class="s2">.</span><span class="s1">HTTPClient</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">Undefined </span><span class="s2">= </span><span class="s1">Undefined</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ConcreteStruct </span><span class="s2">= </span><span class="s1">ConcreteStruct</span>

        <span class="s6"># This is per session.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">nextScriptId </span><span class="s2">= </span><span class="s5">0</span>

        <span class="s6"># TODO: we need one of these per instance, not per session.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">instanceId </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s6"># The root Panda3D install directory.  This is filled in when</span>
        <span class="s6"># the instance starts up.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rootDir </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s6"># The log directory.  Also filled in when the instance starts.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">logDirectory </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s6"># self.superMirrorUrl, if nonempty, is the &quot;super mirror&quot; URL</span>
        <span class="s6"># that should be contacted first before trying the actual</span>
        <span class="s6"># host.  This is primarily used for &quot;downloading&quot; from a</span>
        <span class="s6"># locally-stored Panda3D installation.  This is also filled in</span>
        <span class="s6"># when the instance starts up.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">superMirrorUrl </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s6"># A list of the Panda3D packages that have been loaded.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">installedPackages </span><span class="s2">= []</span>

        <span class="s6"># A list of the Panda3D packages that in the queue to be</span>
        <span class="s6"># downloaded.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadingPackages </span><span class="s2">= []</span>

        <span class="s6"># A dictionary of HostInfo objects for the various download</span>
        <span class="s6"># hosts we have imported packages from.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">hosts </span><span class="s2">= {}</span>

        <span class="s6"># The altHost string that is in effect from the HTML tokens,</span>
        <span class="s6"># if any, and the dictionary of URL remapping: orig host url</span>
        <span class="s6"># -&gt; alt host url.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">altHost </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">altHostMap </span><span class="s2">= {}</span>

        <span class="s6"># The URL from which Panda itself should be downloaded.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pandaHostUrl </span><span class="s2">= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageHostUrl</span><span class="s2">()</span>

        <span class="s6"># Application code can assign a callable object here; if so,</span>
        <span class="s6"># it will be invoked when an uncaught exception propagates to</span>
        <span class="s6"># the top of the TaskMgr.run() loop.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">exceptionHandler </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s6"># Managing packages for runtime download.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadingPackages </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadTask </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s6"># The mount point for the multifile.  For now, this is always</span>
        <span class="s6"># the current working directory, for convenience; but when we</span>
        <span class="s6"># move to multiple-instance sessions, it may have to be</span>
        <span class="s6"># different for each instance.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">multifileRoot </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">ExecutionEnvironment</span><span class="s2">.</span><span class="s1">getCwd</span><span class="s2">())</span>

        <span class="s6"># The &quot;main&quot; object will be exposed to the DOM as a property</span>
        <span class="s6"># of the plugin object; that is, document.pluginobject.main in</span>
        <span class="s6"># JavaScript will be appRunner.main here.  This may be</span>
        <span class="s6"># replaced with a direct reference to the JavaScript object</span>
        <span class="s6"># later, in setInstanceInfo().</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">main </span><span class="s2">= </span><span class="s1">ScriptAttributes</span><span class="s2">()</span>

        <span class="s6"># By default, we publish a stop() method so the browser can</span>
        <span class="s6"># easy stop the plugin.  A particular application can remove</span>
        <span class="s6"># this if it chooses.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">main</span><span class="s2">.</span><span class="s1">stop </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stop</span>

        <span class="s6"># This will be the browser's toplevel window DOM object;</span>
        <span class="s6"># e.g. self.dom.document will be the document.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dom </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s6"># This is the list of expressions we will evaluate when</span>
        <span class="s6"># self.dom gets assigned.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">deferredEvals </span><span class="s2">= []</span>

        <span class="s6"># This is the default requestFunc that is installed if we</span>
        <span class="s6"># never call setRequestFunc().</span>
        <span class="s4">def </span><span class="s1">defaultRequestFunc</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">):</span>
            <span class="s4">if </span><span class="s1">args</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] == </span><span class="s3">'notify'</span><span class="s2">:</span>
                <span class="s6"># Quietly ignore notifies.</span>
                <span class="s4">return</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Ignoring request: %s&quot; </span><span class="s2">% (</span><span class="s1">args</span><span class="s2">,))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">requestFunc </span><span class="s2">= </span><span class="s1">defaultRequestFunc</span>

        <span class="s6"># This will be filled in with the default WindowProperties for</span>
        <span class="s6"># this instance, e.g. the WindowProperties necessary to</span>
        <span class="s6"># re-embed a window in the browser frame.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">windowProperties </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s6"># Store our pointer so DirectStart-based apps can find us.</span>
        <span class="s4">if </span><span class="s1">AppRunnerGlobal</span><span class="s2">.</span><span class="s1">appRunner </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">AppRunnerGlobal</span><span class="s2">.</span><span class="s1">appRunner </span><span class="s2">= </span><span class="s1">self</span>

        <span class="s6"># We use this messenger hook to dispatch this __startIfReady()</span>
        <span class="s6"># call back to the main thread.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">(</span><span class="s3">'AppRunner_startIfReady'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__startIfReady</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">getToken</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tokenName</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Returns the value of the indicated web token as a string, 
        if it was set, or None if it was not. &quot;&quot;&quot;</span>

        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tokenDict</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">tokenName</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">(), </span><span class="s4">None</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">getTokenInt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tokenName</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Returns the value of the indicated web token as an integer 
        value, if it was set, or None if it was not, or not an 
        integer. &quot;&quot;&quot;</span>

        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getToken</span><span class="s2">(</span><span class="s1">tokenName</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">value </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s4">try</span><span class="s2">:</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s4">except </span><span class="s1">ValueError</span><span class="s2">:</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">return </span><span class="s1">value</span>

    <span class="s4">def </span><span class="s1">getTokenFloat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tokenName</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Returns the value of the indicated web token as a 
        floating-point value value, if it was set, or None if it was 
        not, or not a number. &quot;&quot;&quot;</span>

        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getToken</span><span class="s2">(</span><span class="s1">tokenName</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">value </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s4">try</span><span class="s2">:</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">float</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s4">except </span><span class="s1">ValueError</span><span class="s2">:</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">return </span><span class="s1">value</span>

    <span class="s4">def </span><span class="s1">getTokenBool</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tokenName</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Returns the value of the indicated web token as a boolean 
        value, if it was set, or None if it was not. &quot;&quot;&quot;</span>

        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getTokenInt</span><span class="s2">(</span><span class="s1">tokenName</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">value </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">value</span>



    <span class="s4">def </span><span class="s1">installPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">version </span><span class="s2">= </span><span class="s4">None</span><span class="s2">, </span><span class="s1">hostUrl </span><span class="s2">= </span><span class="s4">None</span><span class="s2">):</span>

        <span class="s0">&quot;&quot;&quot; Installs the named package, downloading it first if 
        necessary.  Returns true on success, false on failure.  This 
        method runs synchronously, and will block until it is 
        finished; see the PackageInstaller class if you want this to 
        happen asynchronously instead. &quot;&quot;&quot;</span>

        <span class="s1">host </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getHostWithAlt</span><span class="s2">(</span><span class="s1">hostUrl</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">host</span><span class="s2">.</span><span class="s1">downloadContentsFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
            <span class="s4">return False</span>

        <span class="s6"># All right, get the package info now.</span>
        <span class="s1">package </span><span class="s2">= </span><span class="s1">host</span><span class="s2">.</span><span class="s1">getPackage</span><span class="s2">(</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">version</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">package</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Package %s %s not known on %s&quot; </span><span class="s2">% (</span>
                <span class="s1">packageName</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">hostUrl</span><span class="s2">))</span>
            <span class="s4">return False</span>

        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__rInstallPackage</span><span class="s2">(</span><span class="s1">package</span><span class="s2">, [])</span>

    <span class="s4">def </span><span class="s1">__rInstallPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">package</span><span class="s2">, </span><span class="s1">nested</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; The recursive implementation of installPackage().  The new 
        parameter, nested, is a list of packages that we are 
        recursively calling this from, to avoid recursive loops. &quot;&quot;&quot;</span>

        <span class="s1">package</span><span class="s2">.</span><span class="s1">checkStatus</span><span class="s2">()</span>
        <span class="s4">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">downloadDescFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
            <span class="s4">return False</span>

        <span class="s6"># Now that we've downloaded and read the desc file, we can</span>
        <span class="s6"># install all of the required packages first.</span>
        <span class="s1">nested </span><span class="s2">= </span><span class="s1">nested</span><span class="s2">[:] + [</span><span class="s1">self</span><span class="s2">]</span>
        <span class="s4">for </span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">host </span><span class="s4">in </span><span class="s1">package</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">host</span><span class="s2">.</span><span class="s1">downloadContentsFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
                <span class="s1">p2 </span><span class="s2">= </span><span class="s1">host</span><span class="s2">.</span><span class="s1">getPackage</span><span class="s2">(</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">version</span><span class="s2">)</span>
                <span class="s4">if not </span><span class="s1">p2</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Couldn't find %s %s on %s&quot; </span><span class="s2">% (</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">))</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s4">if </span><span class="s1">p2 </span><span class="s4">not in </span><span class="s1">nested</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">__rInstallPackage</span><span class="s2">(</span><span class="s1">p2</span><span class="s2">, </span><span class="s1">nested</span><span class="s2">)</span>

        <span class="s6"># Now that all of the required packages are installed, carry</span>
        <span class="s6"># on to download and install this package.</span>
        <span class="s4">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">downloadPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
            <span class="s4">return False</span>

        <span class="s4">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">installPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s4">return False</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Package %s %s installed.&quot; </span><span class="s2">% (</span>
            <span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageVersion</span><span class="s2">))</span>
        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">getHostWithAlt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">hostUrl</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Returns a suitable HostInfo object for downloading 
        contents from the indicated URL.  This is almost always the 
        same thing as getHost(), except in the rare case when we have 
        an alt_host specified in the HTML tokens; in this case, we may 
        actually want to download the contents from a different URL 
        than the one given, for instance to download a version in 
        testing. &quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s1">hostUrl </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">hostUrl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pandaHostUrl</span>

        <span class="s1">altUrl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">altHostMap</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">altUrl</span><span class="s2">:</span>
            <span class="s6"># We got an alternate host.  Use it.</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getHost</span><span class="s2">(</span><span class="s1">altUrl</span><span class="s2">)</span>

        <span class="s6"># We didn't get an aternate host, use the original.</span>
        <span class="s1">host </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getHost</span><span class="s2">(</span><span class="s1">hostUrl</span><span class="s2">)</span>

        <span class="s6"># But we might need to consult the host itself to see if *it*</span>
        <span class="s6"># recommends an altHost.</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">altHost</span><span class="s2">:</span>
            <span class="s6"># This means forcing the host to download its contents</span>
            <span class="s6"># file on the spot, a blocking operation.  This is a</span>
            <span class="s6"># little unfortunate, but since alt_host is so rarely</span>
            <span class="s6"># used, probably not really a problem.</span>
            <span class="s1">host</span><span class="s2">.</span><span class="s1">downloadContentsFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">)</span>
            <span class="s1">altUrl </span><span class="s2">= </span><span class="s1">host</span><span class="s2">.</span><span class="s1">altHosts</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">altHost</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">altUrl</span><span class="s2">:</span>
                <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getHost</span><span class="s2">(</span><span class="s1">altUrl</span><span class="s2">)</span>

        <span class="s6"># No shenanigans, just return the requested host.</span>
        <span class="s4">return </span><span class="s1">host</span>

    <span class="s4">def </span><span class="s1">getHost</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">hostDir </span><span class="s2">= </span><span class="s4">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Returns a new HostInfo object corresponding to the 
        indicated host URL.  If we have already seen this URL 
        previously, returns the same object. 
 
        This returns the literal referenced host.  To return the 
        mapped host, which is the one we should actually download 
        from, see getHostWithAlt().  &quot;&quot;&quot;</span>

        <span class="s4">if not </span><span class="s1">hostUrl</span><span class="s2">:</span>
            <span class="s1">hostUrl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pandaHostUrl</span>

        <span class="s1">host </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">host</span><span class="s2">:</span>
            <span class="s1">host </span><span class="s2">= </span><span class="s1">HostInfo</span><span class="s2">(</span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">appRunner </span><span class="s2">= </span><span class="s1">self</span><span class="s2">, </span><span class="s1">hostDir </span><span class="s2">= </span><span class="s1">hostDir</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">[</span><span class="s1">hostUrl</span><span class="s2">] = </span><span class="s1">host</span>
        <span class="s4">return </span><span class="s1">host</span>

    <span class="s4">def </span><span class="s1">getHostWithDir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">hostDir</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Returns the HostInfo object that corresponds to the 
        indicated on-disk host directory.  This would be used when 
        reading a host directory from disk, instead of downloading it 
        from a server.  Supply the full path to the host directory, as 
        a Filename.  Returns None if the contents.xml in the indicated 
        host directory cannot be read or doesn't seem consistent. &quot;&quot;&quot;</span>

        <span class="s1">host </span><span class="s2">= </span><span class="s1">HostInfo</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">hostDir </span><span class="s2">= </span><span class="s1">hostDir</span><span class="s2">, </span><span class="s1">appRunner </span><span class="s2">= </span><span class="s1">self</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">host</span><span class="s2">.</span><span class="s1">hasContentsFile</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">host</span><span class="s2">.</span><span class="s1">readContentsFile</span><span class="s2">():</span>
                <span class="s6"># Couldn't read the contents.xml file</span>
                <span class="s4">return None</span>

        <span class="s4">if not </span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">:</span>
            <span class="s6"># The contents.xml file there didn't seem to indicate the</span>
            <span class="s6"># same host directory.</span>
            <span class="s4">return None</span>

        <span class="s1">host2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">host2 </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s6"># No such host already; store this one.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">[</span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">] = </span><span class="s1">host</span>
            <span class="s4">return </span><span class="s1">host</span>

        <span class="s4">if </span><span class="s1">host2</span><span class="s2">.</span><span class="s1">hostDir </span><span class="s2">!= </span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostDir</span><span class="s2">:</span>
            <span class="s6"># Hmm, we already have that host somewhere else.</span>
            <span class="s4">return None</span>

        <span class="s6"># We already have that host, and it's consistent.</span>
        <span class="s4">return </span><span class="s1">host2</span>

    <span class="s4">def </span><span class="s1">deletePackages</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packages</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Removes all of the indicated packages from the disk, 
        uninstalling them and deleting all of their files.  The 
        packages parameter must be a list of one or more PackageInfo 
        objects, for instance as returned by getHost().getPackage(). 
        Returns the list of packages that were NOT found. &quot;&quot;&quot;</span>

        <span class="s4">for </span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">host </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">packages </span><span class="s2">= </span><span class="s1">host</span><span class="s2">.</span><span class="s1">deletePackages</span><span class="s2">(</span><span class="s1">packages</span><span class="s2">)</span>

            <span class="s4">if not </span><span class="s1">host</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">:</span>
                <span class="s6"># If that's all of the packages for this host, delete</span>
                <span class="s6"># the host directory too.</span>
                <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">[</span><span class="s1">hostUrl</span><span class="s2">]</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__deleteHostFiles</span><span class="s2">(</span><span class="s1">host</span><span class="s2">)</span>

        <span class="s4">return </span><span class="s1">packages</span>

    <span class="s4">def </span><span class="s1">__deleteHostFiles</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">host</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Called by deletePackages(), this removes all the files for 
        the indicated host (for which we have presumably already 
        removed all of the packages). &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Deleting host %s: %s&quot; </span><span class="s2">% (</span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostDir</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rmtree</span><span class="s2">(</span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostDir</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">sendRequest</span><span class="s2">(</span><span class="s3">'forget_package'</span><span class="s2">, </span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s3">''</span><span class="s2">, </span><span class="s3">''</span><span class="s2">)</span>


    <span class="s4">def </span><span class="s1">freshenFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">host</span><span class="s2">, </span><span class="s1">fileSpec</span><span class="s2">, </span><span class="s1">localPathname</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Ensures that the localPathname is the most current version 
        of the file defined by fileSpec, as offered by host.  If not, 
        it downloads a new version on-the-spot.  Returns true on 
        success, false on failure. &quot;&quot;&quot;</span>

        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span>
        <span class="s4">return </span><span class="s1">host</span><span class="s2">.</span><span class="s1">freshenFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">, </span><span class="s1">fileSpec</span><span class="s2">, </span><span class="s1">localPathname</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">scanInstalledPackages</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Scans the hosts and packages already installed locally on 
        the system.  Returns a list of InstalledHostData objects, each 
        of which contains a list of InstalledPackageData objects. &quot;&quot;&quot;</span>

        <span class="s1">result </span><span class="s2">= []</span>
        <span class="s1">hostsFilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rootDir</span><span class="s2">, </span><span class="s3">'hosts'</span><span class="s2">)</span>
        <span class="s1">hostsDir </span><span class="s2">= </span><span class="s1">ScanDirectoryNode</span><span class="s2">(</span><span class="s1">hostsFilename</span><span class="s2">)</span>
        <span class="s4">for </span><span class="s1">dirnode </span><span class="s4">in </span><span class="s1">hostsDir</span><span class="s2">.</span><span class="s1">nested</span><span class="s2">:</span>
            <span class="s1">host </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getHostWithDir</span><span class="s2">(</span><span class="s1">dirnode</span><span class="s2">.</span><span class="s1">pathname</span><span class="s2">)</span>
            <span class="s1">hostData </span><span class="s2">= </span><span class="s1">InstalledHostData</span><span class="s2">(</span><span class="s1">host</span><span class="s2">, </span><span class="s1">dirnode</span><span class="s2">)</span>

            <span class="s4">if </span><span class="s1">host</span><span class="s2">:</span>
                <span class="s4">for </span><span class="s1">package </span><span class="s4">in </span><span class="s1">host</span><span class="s2">.</span><span class="s1">getAllPackages</span><span class="s2">(</span><span class="s1">includeAllPlatforms </span><span class="s2">= </span><span class="s4">True</span><span class="s2">):</span>
                    <span class="s1">packageDir </span><span class="s2">= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">getPackageDir</span><span class="s2">()</span>
                    <span class="s4">if not </span><span class="s1">packageDir</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">():</span>
                        <span class="s4">continue</span>

                    <span class="s1">subdir </span><span class="s2">= </span><span class="s1">dirnode</span><span class="s2">.</span><span class="s1">extractSubdir</span><span class="s2">(</span><span class="s1">packageDir</span><span class="s2">)</span>
                    <span class="s4">if not </span><span class="s1">subdir</span><span class="s2">:</span>
                        <span class="s6"># This package, while defined by the host, isn't installed</span>
                        <span class="s6"># locally; ignore it.</span>
                        <span class="s4">continue</span>

                    <span class="s1">packageData </span><span class="s2">= </span><span class="s1">InstalledPackageData</span><span class="s2">(</span><span class="s1">package</span><span class="s2">, </span><span class="s1">subdir</span><span class="s2">)</span>
                    <span class="s1">hostData</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">packageData</span><span class="s2">)</span>

            <span class="s6"># Now that we've examined all of the packages for the host,</span>
            <span class="s6"># anything left over is junk.</span>
            <span class="s4">for </span><span class="s1">subdir </span><span class="s4">in </span><span class="s1">dirnode</span><span class="s2">.</span><span class="s1">nested</span><span class="s2">:</span>
                <span class="s1">packageData </span><span class="s2">= </span><span class="s1">InstalledPackageData</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">subdir</span><span class="s2">)</span>
                <span class="s1">hostData</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">packageData</span><span class="s2">)</span>

            <span class="s1">result</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">hostData</span><span class="s2">)</span>

        <span class="s4">return </span><span class="s1">result</span>

    <span class="s4">def </span><span class="s1">readConfigXml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Reads the config.xml file that may be present in the root 
        directory. &quot;&quot;&quot;</span>

        <span class="s4">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">core</span><span class="s2">, </span><span class="s3">'TiXmlDocument'</span><span class="s2">):</span>
            <span class="s4">return</span>

        <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rootDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ConfigBasename</span><span class="s2">)</span>
        <span class="s1">doc </span><span class="s2">= </span><span class="s1">core</span><span class="s2">.</span><span class="s1">TiXmlDocument</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s4">if not </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">LoadFile</span><span class="s2">():</span>
            <span class="s4">return</span>

        <span class="s1">xconfig </span><span class="s2">= </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'config'</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">xconfig</span><span class="s2">:</span>
            <span class="s1">maxDiskUsage </span><span class="s2">= </span><span class="s1">xconfig</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'max_disk_usage'</span><span class="s2">)</span>
            <span class="s4">try</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">maxDiskUsage </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">maxDiskUsage </span><span class="s4">or </span><span class="s3">''</span><span class="s2">)</span>
            <span class="s4">except </span><span class="s1">ValueError</span><span class="s2">:</span>
                <span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">writeConfigXml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Rewrites the config.xml to the root directory.  This isn't 
        called automatically; an application may call this after 
        adjusting some parameters (such as self.maxDiskUsage). &quot;&quot;&quot;</span>

        <span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s1">TiXmlDocument</span><span class="s2">, </span><span class="s1">TiXmlDeclaration</span><span class="s2">, </span><span class="s1">TiXmlElement</span>

        <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rootDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ConfigBasename</span><span class="s2">)</span>
        <span class="s1">doc </span><span class="s2">= </span><span class="s1">TiXmlDocument</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s1">decl </span><span class="s2">= </span><span class="s1">TiXmlDeclaration</span><span class="s2">(</span><span class="s3">&quot;1.0&quot;</span><span class="s2">, </span><span class="s3">&quot;utf-8&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
        <span class="s1">doc</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">decl</span><span class="s2">)</span>

        <span class="s1">xconfig </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'config'</span><span class="s2">)</span>
        <span class="s1">xconfig</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'max_disk_usage'</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">maxDiskUsage</span><span class="s2">))</span>
        <span class="s1">doc</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xconfig</span><span class="s2">)</span>

        <span class="s6"># Write the file to a temporary filename, then atomically move</span>
        <span class="s6"># it to its actual filename, to avoid race conditions when</span>
        <span class="s6"># updating this file.</span>
        <span class="s1">tfile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rootDir</span><span class="s2">), </span><span class="s3">'.xml'</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">SaveFile</span><span class="s2">(</span><span class="s1">tfile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()):</span>
            <span class="s1">tfile</span><span class="s2">.</span><span class="s1">renameTo</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>


    <span class="s4">def </span><span class="s1">checkDiskUsage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Checks the total disk space used by all packages, and 
        removes old packages if necessary. &quot;&quot;&quot;</span>

        <span class="s1">totalSize </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">hosts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scanInstalledPackages</span><span class="s2">()</span>
        <span class="s4">for </span><span class="s1">hostData </span><span class="s4">in </span><span class="s1">hosts</span><span class="s2">:</span>
            <span class="s4">for </span><span class="s1">packageData </span><span class="s4">in </span><span class="s1">hostData</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">:</span>
                <span class="s1">totalSize </span><span class="s2">+= </span><span class="s1">packageData</span><span class="s2">.</span><span class="s1">totalSize</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Total Panda3D disk space used: %s MB&quot; </span><span class="s2">% (</span>
            <span class="s2">(</span><span class="s1">totalSize </span><span class="s2">+ </span><span class="s5">524288</span><span class="s2">) // </span><span class="s5">1048576</span><span class="s2">))</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verifyContents </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">P3DVCNever</span><span class="s2">:</span>
            <span class="s6"># We're not allowed to delete anything anyway.</span>
            <span class="s4">return</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Configured max usage is: %s MB&quot; </span><span class="s2">% (</span>
            <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">maxDiskUsage </span><span class="s2">+ </span><span class="s5">524288</span><span class="s2">) // </span><span class="s5">1048576</span><span class="s2">))</span>
        <span class="s4">if </span><span class="s1">totalSize </span><span class="s2">&lt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">maxDiskUsage</span><span class="s2">:</span>
            <span class="s6"># Still within budget; no need to clean up anything.</span>
            <span class="s4">return</span>

        <span class="s6"># OK, we're over budget.  Now we have to remove old packages.</span>
        <span class="s1">usedPackages </span><span class="s2">= []</span>
        <span class="s4">for </span><span class="s1">hostData </span><span class="s4">in </span><span class="s1">hosts</span><span class="s2">:</span>
            <span class="s4">for </span><span class="s1">packageData </span><span class="s4">in </span><span class="s1">hostData</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">packageData</span><span class="s2">.</span><span class="s1">package </span><span class="s4">and </span><span class="s1">packageData</span><span class="s2">.</span><span class="s1">package</span><span class="s2">.</span><span class="s1">installed</span><span class="s2">:</span>
                    <span class="s6"># Don't uninstall any packages we're currently using.</span>
                    <span class="s4">continue</span>

                <span class="s1">usedPackages</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">packageData</span><span class="s2">.</span><span class="s1">lastUse</span><span class="s2">, </span><span class="s1">packageData</span><span class="s2">))</span>

        <span class="s6"># Sort the packages into oldest-first order.</span>
        <span class="s1">usedPackages</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">()</span>

        <span class="s6"># Delete packages until we free up enough space.</span>
        <span class="s1">packages </span><span class="s2">= []</span>
        <span class="s4">for </span><span class="s1">lastUse</span><span class="s2">, </span><span class="s1">packageData </span><span class="s4">in </span><span class="s1">usedPackages</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">totalSize </span><span class="s2">&lt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">maxDiskUsage</span><span class="s2">:</span>
                <span class="s4">break</span>
            <span class="s1">totalSize </span><span class="s2">-= </span><span class="s1">packageData</span><span class="s2">.</span><span class="s1">totalSize</span>

            <span class="s4">if </span><span class="s1">packageData</span><span class="s2">.</span><span class="s1">package</span><span class="s2">:</span>
                <span class="s1">packages</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">packageData</span><span class="s2">.</span><span class="s1">package</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s6"># If it's an unknown package, just delete it directly.</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Deleting unknown package %s&quot; </span><span class="s2">% (</span><span class="s1">packageData</span><span class="s2">.</span><span class="s1">pathname</span><span class="s2">))</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">rmtree</span><span class="s2">(</span><span class="s1">packageData</span><span class="s2">.</span><span class="s1">pathname</span><span class="s2">)</span>

        <span class="s1">packages </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">deletePackages</span><span class="s2">(</span><span class="s1">packages</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">packages</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Unable to delete %s packages&quot; </span><span class="s2">% (</span><span class="s1">len</span><span class="s2">(</span><span class="s1">packages</span><span class="s2">)))</span>

        <span class="s4">return</span>

    <span class="s4">def </span><span class="s1">stop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This method can be called by JavaScript to stop the 
        application. &quot;&quot;&quot;</span>

        <span class="s6"># We defer the actual exit for a few frames, so we don't raise</span>
        <span class="s6"># an exception and invalidate the JavaScript call; and also to</span>
        <span class="s6"># help protect against race conditions as the application</span>
        <span class="s6"># shuts down.</span>
        <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">doMethodLater</span><span class="s2">(</span><span class="s5">0.5</span><span class="s2">, </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">, </span><span class="s3">'exit'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">run</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This method calls taskMgr.run(), with an optional 
        exception handler.  This is generally the program's main loop 
        when running in a p3d environment (except on unusual platforms 
        like the iPhone, which have to hand the main loop off to the 
        OS, and don't use this interface). &quot;&quot;&quot;</span>

        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">run</span><span class="s2">()</span>

        <span class="s4">except </span><span class="s1">SystemExit </span><span class="s4">as </span><span class="s1">err</span><span class="s2">:</span>
            <span class="s6"># Presumably the window has already been shut down here, but shut</span>
            <span class="s6"># it down again for good measure.</span>
            <span class="s4">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">builtins</span><span class="s2">, </span><span class="s3">&quot;base&quot;</span><span class="s2">):</span>
                <span class="s1">base</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Normal exit with status %s.&quot; </span><span class="s2">% </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">err</span><span class="s2">.</span><span class="s1">code</span><span class="s2">))</span>
            <span class="s4">raise</span>

        <span class="s4">except</span><span class="s2">:</span>
            <span class="s6"># Some unexpected Python exception; pass it to the</span>
            <span class="s6"># optional handler, if it is defined.</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exceptionHandler </span><span class="s4">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">interactiveConsole</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">exceptionHandler</span><span class="s2">()</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s4">raise</span>

    <span class="s4">def </span><span class="s1">rmtree</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This is like shutil.rmtree(), but it can remove read-only 
        files on Windows.  It receives a Filename, the root directory 
        to delete. &quot;&quot;&quot;</span>
        <span class="s4">if </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">isDirectory</span><span class="s2">():</span>
            <span class="s4">for </span><span class="s1">child </span><span class="s4">in </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">scanDirectory</span><span class="s2">():</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">rmtree</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">child</span><span class="s2">))</span>
            <span class="s4">if not </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">rmdir</span><span class="s2">():</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;could not remove directory %s&quot; </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">))</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">():</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;could not delete %s&quot; </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">setSessionId</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sessionId</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This message should come in at startup. &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sessionId </span><span class="s2">= </span><span class="s1">sessionId</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">nextScriptId </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sessionId </span><span class="s2">* </span><span class="s5">1000 </span><span class="s2">+ </span><span class="s5">10000</span>

    <span class="s4">def </span><span class="s1">initPackedAppEnvironment</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This function sets up the Python environment suitably for 
        running a packed app.  It should only run once in any given 
        session (and it includes logic to ensure this). &quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packedAppEnvironmentInitialized</span><span class="s2">:</span>
            <span class="s4">return</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">packedAppEnvironmentInitialized </span><span class="s2">= </span><span class="s4">True</span>

        <span class="s1">vfs </span><span class="s2">= </span><span class="s1">VirtualFileSystem</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>

        <span class="s6"># Now set up Python to import this stuff.</span>
        <span class="s1">VFSImporter</span><span class="s2">.</span><span class="s1">register</span><span class="s2">()</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multifileRoot</span><span class="s2">)</span>

        <span class="s6"># Make sure that $MAIN_DIR is set to the p3d root before we</span>
        <span class="s6"># start executing the code in this file.</span>
        <span class="s1">ExecutionEnvironment</span><span class="s2">.</span><span class="s1">setEnvironmentVariable</span><span class="s2">(</span><span class="s3">&quot;MAIN_DIR&quot;</span><span class="s2">, </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multifileRoot</span><span class="s2">).</span><span class="s1">toOsSpecific</span><span class="s2">())</span>

        <span class="s6"># Put our root directory on the model-path, too.</span>
        <span class="s1">getModelPath</span><span class="s2">().</span><span class="s1">appendDirectory</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multifileRoot</span><span class="s2">)</span>

        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">trueFileIO</span><span class="s2">:</span>
            <span class="s6"># Replace the builtin open and file symbols so user code will get</span>
            <span class="s6"># our versions by default, which can open and read files out of</span>
            <span class="s6"># the multifile.</span>
            <span class="s1">builtins</span><span class="s2">.</span><span class="s1">open </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">open</span>
            <span class="s4">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&lt; (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">):</span>
                <span class="s1">builtins</span><span class="s2">.</span><span class="s1">file </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">open</span>
                <span class="s1">builtins</span><span class="s2">.</span><span class="s1">execfile </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">execfile</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">listdir </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">listdir</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">walk </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">walk</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">join</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">isfile</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">isdir</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">exists</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">lexists </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">lexists</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">getmtime </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">getmtime</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">getsize </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">getsize</span>
            <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s3">'glob'</span><span class="s2">] = </span><span class="s1">glob</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">checkDiskUsage</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">__startIfReady</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Called internally to start the application. &quot;&quot;&quot;</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">started</span><span class="s2">:</span>
            <span class="s4">return</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gotWindow </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gotP3DFilename</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">started </span><span class="s2">= </span><span class="s4">True</span>

            <span class="s6"># Now we can ignore future calls to startIfReady().</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ignore</span><span class="s2">(</span><span class="s3">'AppRunner_startIfReady'</span><span class="s2">)</span>

            <span class="s6"># Hang a hook so we know when the window is actually opened.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">acceptOnce</span><span class="s2">(</span><span class="s3">'window-event'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__windowEvent</span><span class="s2">)</span>

            <span class="s6"># Look for the startup Python file.  This might be a magic</span>
            <span class="s6"># filename (like &quot;__main__&quot;, or any filename that contains</span>
            <span class="s6"># invalid module characters), so we can't just import it</span>
            <span class="s6"># directly; instead, we go through the low-level importer.</span>

            <span class="s6"># If there's no p3d_info.xml file, we look for &quot;main&quot;.</span>
            <span class="s1">moduleName </span><span class="s2">= </span><span class="s3">'main'</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dPackage</span><span class="s2">:</span>
                <span class="s1">mainName </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dPackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'main_module'</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">mainName</span><span class="s2">:</span>
                    <span class="s1">moduleName </span><span class="s2">= </span><span class="s1">mainName</span>

            <span class="s6"># Temporarily set this flag while we import the app, so</span>
            <span class="s6"># that if the app calls run() within its own main.py, it</span>
            <span class="s6"># will properly get ignored by ShowBase.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">initialAppImport </span><span class="s2">= </span><span class="s4">True</span>

            <span class="s6"># Python won't let us import a module named __main__.  So,</span>
            <span class="s6"># we have to do that manually, via the VFSImporter.</span>
            <span class="s4">if </span><span class="s1">moduleName </span><span class="s2">== </span><span class="s3">'__main__'</span><span class="s2">:</span>
                <span class="s1">dirName </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multifileRoot</span><span class="s2">).</span><span class="s1">toOsSpecific</span><span class="s2">()</span>
                <span class="s1">importer </span><span class="s2">= </span><span class="s1">VFSImporter</span><span class="s2">.</span><span class="s1">VFSImporter</span><span class="s2">(</span><span class="s1">dirName</span><span class="s2">)</span>
                <span class="s1">loader </span><span class="s2">= </span><span class="s1">importer</span><span class="s2">.</span><span class="s1">find_module</span><span class="s2">(</span><span class="s3">'__main__'</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">loader </span><span class="s4">is None</span><span class="s2">:</span>
                    <span class="s4">raise </span><span class="s1">ImportError</span><span class="s2">(</span><span class="s3">'No module named __main__'</span><span class="s2">)</span>

                <span class="s1">mainModule </span><span class="s2">= </span><span class="s1">loader</span><span class="s2">.</span><span class="s1">load_module</span><span class="s2">(</span><span class="s3">'__main__'</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">__import__</span><span class="s2">(</span><span class="s1">moduleName</span><span class="s2">)</span>
                <span class="s1">mainModule </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s1">moduleName</span><span class="s2">]</span>

            <span class="s6"># Check if it has a main() function.  If so, call it.</span>
            <span class="s4">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">mainModule</span><span class="s2">, </span><span class="s3">'main'</span><span class="s2">) </span><span class="s4">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">mainModule</span><span class="s2">.</span><span class="s1">main</span><span class="s2">, </span><span class="s3">'__call__'</span><span class="s2">):</span>
                <span class="s1">mainModule</span><span class="s2">.</span><span class="s1">main</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

            <span class="s6"># Now clear this flag.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">initialAppImport </span><span class="s2">= </span><span class="s4">False</span>

            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">interactiveConsole</span><span class="s2">:</span>
                <span class="s6"># At this point, we have successfully loaded the app.</span>
                <span class="s6"># If the interactive_console flag is enabled, stop the</span>
                <span class="s6"># main loop now and give the user a Python prompt.</span>
                <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">stop</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">getPandaScriptObject</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Called by the browser to query the Panda instance's 
        toplevel scripting object, for querying properties in the 
        Panda instance.  The attributes on this object are mapped to 
        document.pluginobject.main within the DOM. &quot;&quot;&quot;</span>

        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">main</span>

    <span class="s4">def </span><span class="s1">setBrowserScriptObject</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dom</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Called by the browser to supply the browser's toplevel DOM 
        object, for controlling the JavaScript and the document in the 
        same page with the Panda3D plugin. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">dom </span><span class="s2">= </span><span class="s1">dom</span>

        <span class="s6"># Now evaluate any deferred expressions.</span>
        <span class="s4">for </span><span class="s1">expression </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">deferredEvals</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">scriptRequest</span><span class="s2">(</span><span class="s3">'eval'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dom</span><span class="s2">, </span><span class="s1">value </span><span class="s2">= </span><span class="s1">expression</span><span class="s2">,</span>
                               <span class="s1">needsResponse </span><span class="s2">= </span><span class="s4">False</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">deferredEvals </span><span class="s2">= []</span>

    <span class="s4">def </span><span class="s1">setInstanceInfo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rootDir</span><span class="s2">, </span><span class="s1">logDirectory</span><span class="s2">, </span><span class="s1">superMirrorUrl</span><span class="s2">,</span>
                        <span class="s1">verifyContents</span><span class="s2">, </span><span class="s1">main</span><span class="s2">, </span><span class="s1">respectPerPlatform</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Called by the browser to set some global information about 
        the instance. &quot;&quot;&quot;</span>

        <span class="s6"># rootDir is the root Panda3D install directory on the local</span>
        <span class="s6"># machine.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rootDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">rootDir</span><span class="s2">)</span>

        <span class="s6"># logDirectory is the directory name where all log files end</span>
        <span class="s6"># up.</span>
        <span class="s4">if </span><span class="s1">logDirectory</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">logDirectory </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">logDirectory</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">logDirectory </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">rootDir</span><span class="s2">, </span><span class="s3">'log'</span><span class="s2">)</span>

        <span class="s6"># The &quot;super mirror&quot; URL, generally used only by panda3d.exe.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">superMirrorUrl </span><span class="s2">= </span><span class="s1">superMirrorUrl</span>

        <span class="s6"># How anxious should we be about contacting the server for</span>
        <span class="s6"># the latest code?</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">verifyContents </span><span class="s2">= </span><span class="s1">verifyContents</span>

        <span class="s6"># The initial &quot;main&quot; object, if specified.</span>
        <span class="s4">if </span><span class="s1">main </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">main </span><span class="s2">= </span><span class="s1">main</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">respectPerPlatform </span><span class="s2">= </span><span class="s1">respectPerPlatform</span>
        <span class="s6">#self.notify.info(&quot;respectPerPlatform = %s&quot; % (self.respectPerPlatform))</span>

        <span class="s6"># Now that we have rootDir, we can read the config file.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">readConfigXml</span><span class="s2">()</span>


    <span class="s4">def </span><span class="s1">addPackageInfo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">hostDir </span><span class="s2">= </span><span class="s4">None</span><span class="s2">,</span>
                       <span class="s1">recurse </span><span class="s2">= </span><span class="s4">False</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Called by the browser for each one of the &quot;required&quot; 
        packages that were preloaded before starting the application. 
        If for some reason the package isn't already downloaded, this 
        will download it on the spot.  Raises OSError on failure. &quot;&quot;&quot;</span>

        <span class="s1">host </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getHost</span><span class="s2">(</span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">hostDir </span><span class="s2">= </span><span class="s1">hostDir</span><span class="s2">)</span>

        <span class="s4">if not </span><span class="s1">host</span><span class="s2">.</span><span class="s1">hasContentsFile</span><span class="s2">:</span>
            <span class="s6"># Always pre-read these hosts' contents.xml files, even if</span>
            <span class="s6"># we have P3DVCForce in effect, since presumably we've</span>
            <span class="s6"># already forced them on the plugin side.</span>
            <span class="s1">host</span><span class="s2">.</span><span class="s1">readContentsFile</span><span class="s2">()</span>

        <span class="s4">if not </span><span class="s1">host</span><span class="s2">.</span><span class="s1">downloadContentsFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
            <span class="s6"># Couldn't download?  Must have failed to download in the</span>
            <span class="s6"># plugin as well.  But since we launched, we probably have</span>
            <span class="s6"># a copy already local; let's use it.</span>
            <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;Host %s cannot be downloaded, cannot preload %s.&quot; </span><span class="s2">% (</span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
            <span class="s4">if not </span><span class="s1">host</span><span class="s2">.</span><span class="s1">hasContentsFile</span><span class="s2">:</span>
                <span class="s6"># This is weird.  How did we launch without having</span>
                <span class="s6"># this file at all?</span>
                <span class="s4">raise </span><span class="s1">OSError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

            <span class="s6"># Just make it a warning and continue.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">name </span><span class="s2">== </span><span class="s3">'panda3d' </span><span class="s4">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pandaHostUrl</span><span class="s2">:</span>
            <span class="s6"># A special case: in case we don't have the PackageHostUrl</span>
            <span class="s6"># compiled in, infer it from the first package we</span>
            <span class="s6"># installed named &quot;panda3d&quot;.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pandaHostUrl </span><span class="s2">= </span><span class="s1">hostUrl</span>

        <span class="s4">if not </span><span class="s1">platform</span><span class="s2">:</span>
            <span class="s1">platform </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">package </span><span class="s2">= </span><span class="s1">host</span><span class="s2">.</span><span class="s1">getPackage</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">platform </span><span class="s2">= </span><span class="s1">platform</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">package</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">recurse</span><span class="s2">:</span>
                <span class="s6"># Maybe the contents.xml file isn't current.  Re-fetch it.</span>
                <span class="s4">if </span><span class="s1">host</span><span class="s2">.</span><span class="s1">redownloadContentsFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
                    <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">addPackageInfo</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">hostDir </span><span class="s2">= </span><span class="s1">hostDir</span><span class="s2">, </span><span class="s1">recurse </span><span class="s2">= </span><span class="s4">True</span><span class="s2">)</span>

            <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;Couldn't find %s %s on %s&quot; </span><span class="s2">% (</span><span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">hostUrl</span><span class="s2">)</span>
            <span class="s4">raise </span><span class="s1">OSError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

        <span class="s1">package</span><span class="s2">.</span><span class="s1">checkStatus</span><span class="s2">()</span>
        <span class="s4">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">downloadDescFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
            <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;Couldn't get desc file for %s&quot; </span><span class="s2">% (</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s4">raise </span><span class="s1">OSError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

        <span class="s4">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">downloadPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
            <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;Couldn't download %s&quot; </span><span class="s2">% (</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s4">raise </span><span class="s1">OSError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

        <span class="s4">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">installPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;Couldn't install %s&quot; </span><span class="s2">% (</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s4">raise </span><span class="s1">OSError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">guiApp</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">guiApp </span><span class="s2">= </span><span class="s4">True</span>
            <span class="s1">init_app_for_gui</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">setP3DFilename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">p3dFilename</span><span class="s2">, </span><span class="s1">tokens</span><span class="s2">, </span><span class="s1">argv</span><span class="s2">, </span><span class="s1">instanceId</span><span class="s2">,</span>
                       <span class="s1">interactiveConsole</span><span class="s2">, </span><span class="s1">p3dOffset </span><span class="s2">= </span><span class="s5">0</span><span class="s2">, </span><span class="s1">p3dUrl </span><span class="s2">= </span><span class="s4">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Called by the browser to specify the p3d file that 
        contains the application itself, along with the web tokens 
        and/or command-line arguments.  Once this method has been 
        called, the application is effectively started. &quot;&quot;&quot;</span>

        <span class="s6"># One day we will have support for multiple instances within a</span>
        <span class="s6"># Python session.  Against that day, we save the instance ID</span>
        <span class="s6"># for this instance.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">instanceId </span><span class="s2">= </span><span class="s1">instanceId</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">tokens </span><span class="s2">= </span><span class="s1">tokens</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">argv </span><span class="s2">= </span><span class="s1">argv</span>

        <span class="s6"># We build up a token dictionary with care, so that if a given</span>
        <span class="s6"># token appears twice in the token list, we record only the</span>
        <span class="s6"># first value, not the second or later.  This is consistent</span>
        <span class="s6"># with the internal behavior of the core API.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tokenDict </span><span class="s2">= {}</span>
        <span class="s4">for </span><span class="s1">token</span><span class="s2">, </span><span class="s1">keyword </span><span class="s4">in </span><span class="s1">tokens</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tokenDict</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">token</span><span class="s2">, </span><span class="s1">keyword</span><span class="s2">)</span>

        <span class="s6"># Also store the arguments on sys, for applications that</span>
        <span class="s6"># aren't instance-ready.</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">argv </span><span class="s2">= </span><span class="s1">argv</span>

        <span class="s6"># That means we now know the altHost in effect.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">altHost </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tokenDict</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'alt_host'</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>

        <span class="s6"># Tell the browser that Python is up and running, and ready to</span>
        <span class="s6"># respond to queries.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">notifyRequest</span><span class="s2">(</span><span class="s3">'onpythonload'</span><span class="s2">)</span>

        <span class="s6"># Now go load the applet.</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">p3dFilename</span><span class="s2">)</span>
        <span class="s1">vfs </span><span class="s2">= </span><span class="s1">VirtualFileSystem</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>

        <span class="s4">if not </span><span class="s1">vfs</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">):</span>
            <span class="s4">raise </span><span class="s1">ArgumentError</span><span class="s2">(</span><span class="s3">&quot;No such file: %s&quot; </span><span class="s2">% (</span><span class="s1">p3dFilename</span><span class="s2">))</span>

        <span class="s1">fname</span><span class="s2">.</span><span class="s1">makeAbsolute</span><span class="s2">()</span>
        <span class="s1">fname</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>
        <span class="s1">mf </span><span class="s2">= </span><span class="s1">Multifile</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">p3dOffset </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">mf</span><span class="s2">.</span><span class="s1">openRead</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">):</span>
                <span class="s4">raise </span><span class="s1">ArgumentError</span><span class="s2">(</span><span class="s3">&quot;Not a Panda3D application: %s&quot; </span><span class="s2">% (</span><span class="s1">p3dFilename</span><span class="s2">))</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">mf</span><span class="s2">.</span><span class="s1">openRead</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">, </span><span class="s1">p3dOffset</span><span class="s2">):</span>
                <span class="s4">raise </span><span class="s1">ArgumentError</span><span class="s2">(</span><span class="s3">&quot;Not a Panda3D application: %s at offset: %s&quot; </span><span class="s2">% (</span><span class="s1">p3dFilename</span><span class="s2">, </span><span class="s1">p3dOffset</span><span class="s2">))</span>

        <span class="s6"># Now load the p3dInfo file.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dInfo </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dPackage </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dConfig </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">allowPythonDev </span><span class="s2">= </span><span class="s4">False</span>

        <span class="s1">i </span><span class="s2">= </span><span class="s1">mf</span><span class="s2">.</span><span class="s1">findSubfile</span><span class="s2">(</span><span class="s3">'p3d_info.xml'</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">i </span><span class="s2">&gt;= </span><span class="s5">0 </span><span class="s4">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">core</span><span class="s2">, </span><span class="s3">'readXmlStream'</span><span class="s2">):</span>
            <span class="s1">stream </span><span class="s2">= </span><span class="s1">mf</span><span class="s2">.</span><span class="s1">openReadSubfile</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dInfo </span><span class="s2">= </span><span class="s1">core</span><span class="s2">.</span><span class="s1">readXmlStream</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">)</span>
            <span class="s1">mf</span><span class="s2">.</span><span class="s1">closeReadSubfile</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dInfo</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dPackage </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dInfo</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'package'</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dPackage</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dConfig </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dPackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'config'</span><span class="s2">)</span>

            <span class="s1">xhost </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dPackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'host'</span><span class="s2">)</span>
            <span class="s4">while </span><span class="s1">xhost</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__readHostXml</span><span class="s2">(</span><span class="s1">xhost</span><span class="s2">)</span>
                <span class="s1">xhost </span><span class="s2">= </span><span class="s1">xhost</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s3">'host'</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dConfig</span><span class="s2">:</span>
            <span class="s1">allowPythonDev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dConfig</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'allow_python_dev'</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">allowPythonDev</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">allowPythonDev </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">allowPythonDev</span><span class="s2">)</span>
            <span class="s1">guiApp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dConfig</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'gui_app'</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">guiApp</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">guiApp </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">guiApp</span><span class="s2">)</span>

            <span class="s1">trueFileIO </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dConfig</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'true_file_io'</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">trueFileIO</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">trueFileIO </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">trueFileIO</span><span class="s2">)</span>

        <span class="s6"># The interactiveConsole flag can only be set true if the</span>
        <span class="s6"># application has allow_python_dev set.</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">allowPythonDev </span><span class="s4">and </span><span class="s1">interactiveConsole</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;Impossible, interactive_console set without allow_python_dev.&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">interactiveConsole </span><span class="s2">= </span><span class="s1">interactiveConsole</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">allowPythonDev</span><span class="s2">:</span>
            <span class="s6"># Set the fps text to remind the user that</span>
            <span class="s6"># allow_python_dev is enabled.</span>
            <span class="s1">ConfigVariableString</span><span class="s2">(</span><span class="s3">'frame-rate-meter-text-pattern'</span><span class="s2">).</span><span class="s1">setValue</span><span class="s2">(</span><span class="s3">'allow_python_dev %0.1f fps'</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">guiApp</span><span class="s2">:</span>
            <span class="s1">init_app_for_gui</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">initPackedAppEnvironment</span><span class="s2">()</span>

        <span class="s6"># Mount the Multifile under self.multifileRoot.</span>
        <span class="s1">vfs</span><span class="s2">.</span><span class="s1">mount</span><span class="s2">(</span><span class="s1">mf</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">multifileRoot</span><span class="s2">, </span><span class="s1">vfs</span><span class="s2">.</span><span class="s1">MFReadOnly</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dMultifile </span><span class="s2">= </span><span class="s1">mf</span>
        <span class="s1">VFSImporter</span><span class="s2">.</span><span class="s1">reloadSharedPackages</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">loadMultifilePrcFiles</span><span class="s2">(</span><span class="s1">mf</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">multifileRoot</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">gotP3DFilename </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dFilename </span><span class="s2">= </span><span class="s1">fname</span>
        <span class="s4">if </span><span class="s1">p3dUrl</span><span class="s2">:</span>
            <span class="s6"># The url from which the p3d file was downloaded is</span>
            <span class="s6"># provided if available.  It is only for documentation</span>
            <span class="s6"># purposes; the actual p3d file has already been</span>
            <span class="s6"># downloaded to p3dFilename.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dUrl </span><span class="s2">= </span><span class="s1">core</span><span class="s2">.</span><span class="s1">URLSpec</span><span class="s2">(</span><span class="s1">p3dUrl</span><span class="s2">)</span>

        <span class="s6"># Send this call to the main thread; don't call it directly.</span>
        <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s3">'AppRunner_startIfReady'</span><span class="s2">, </span><span class="s1">taskChain </span><span class="s2">= </span><span class="s3">'default'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__readHostXml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xhost</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Reads the data in the indicated &lt;host&gt; entry. &quot;&quot;&quot;</span>

        <span class="s1">url </span><span class="s2">= </span><span class="s1">xhost</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'url'</span><span class="s2">)</span>
        <span class="s1">host </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getHost</span><span class="s2">(</span><span class="s1">url</span><span class="s2">)</span>
        <span class="s1">host</span><span class="s2">.</span><span class="s1">readHostXml</span><span class="s2">(</span><span class="s1">xhost</span><span class="s2">)</span>

        <span class="s6"># Scan for a matching &lt;alt_host&gt;.  If found, it means we</span>
        <span class="s6"># should use the alternate URL instead of the original URL.</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">altHost</span><span class="s2">:</span>
            <span class="s1">xalthost </span><span class="s2">= </span><span class="s1">xhost</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'alt_host'</span><span class="s2">)</span>
            <span class="s4">while </span><span class="s1">xalthost</span><span class="s2">:</span>
                <span class="s1">keyword </span><span class="s2">= </span><span class="s1">xalthost</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'keyword'</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">keyword </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">altHost</span><span class="s2">:</span>
                    <span class="s1">origUrl </span><span class="s2">= </span><span class="s1">xhost</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'url'</span><span class="s2">)</span>
                    <span class="s1">newUrl </span><span class="s2">= </span><span class="s1">xalthost</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'url'</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">altHostMap</span><span class="s2">[</span><span class="s1">origUrl</span><span class="s2">] = </span><span class="s1">newUrl</span>
                    <span class="s4">break</span>

                <span class="s1">xalthost </span><span class="s2">= </span><span class="s1">xalthost</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s3">'alt_host'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">loadMultifilePrcFiles</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">mf</span><span class="s2">, </span><span class="s1">root</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Loads any prc files in the root of the indicated 
        Multifile, which is presumed to have been mounted already 
        under root. &quot;&quot;&quot;</span>

        <span class="s6"># We have to load these prc files explicitly, since the</span>
        <span class="s6"># ConfigPageManager can't directly look inside the vfs.  Use</span>
        <span class="s6"># the Multifile interface to find the prc files, rather than</span>
        <span class="s6"># vfs.scanDirectory(), so we only pick up the files in this</span>
        <span class="s6"># particular multifile.</span>
        <span class="s1">cpMgr </span><span class="s2">= </span><span class="s1">ConfigPageManager</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>
        <span class="s4">for </span><span class="s1">f </span><span class="s4">in </span><span class="s1">mf</span><span class="s2">.</span><span class="s1">getSubfileNames</span><span class="s2">():</span>
            <span class="s1">fn </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">getDirname</span><span class="s2">() == </span><span class="s3">'' </span><span class="s4">and </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">getExtension</span><span class="s2">() == </span><span class="s3">'prc'</span><span class="s2">:</span>
                <span class="s1">pathname </span><span class="s2">= </span><span class="s3">'%s/%s' </span><span class="s2">% (</span><span class="s1">root</span><span class="s2">, </span><span class="s1">f</span><span class="s2">)</span>

                <span class="s1">alreadyLoaded </span><span class="s2">= </span><span class="s4">False</span>
                <span class="s4">for </span><span class="s1">cpi </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">cpMgr</span><span class="s2">.</span><span class="s1">getNumImplicitPages</span><span class="s2">()):</span>
                    <span class="s4">if </span><span class="s1">cpMgr</span><span class="s2">.</span><span class="s1">getImplicitPage</span><span class="s2">(</span><span class="s1">cpi</span><span class="s2">).</span><span class="s1">getName</span><span class="s2">() == </span><span class="s1">pathname</span><span class="s2">:</span>
                        <span class="s6"># No need to load this file twice.</span>
                        <span class="s1">alreadyLoaded </span><span class="s2">= </span><span class="s4">True</span>
                        <span class="s4">break</span>

                <span class="s4">if not </span><span class="s1">alreadyLoaded</span><span class="s2">:</span>
                    <span class="s1">data </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">), </span><span class="s3">'r'</span><span class="s2">).</span><span class="s1">read</span><span class="s2">()</span>
                    <span class="s1">cp </span><span class="s2">= </span><span class="s1">loadPrcFileData</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>
                    <span class="s6"># Set it to sort value 20, behind the implicit pages.</span>
                    <span class="s1">cp</span><span class="s2">.</span><span class="s1">setSort</span><span class="s2">(</span><span class="s5">20</span><span class="s2">)</span>


    <span class="s4">def </span><span class="s1">__clearWindowProperties</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Clears the windowPrc file that was created in a previous 
        call to setupWindow(), if any. &quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">windowPrc</span><span class="s2">:</span>
            <span class="s1">unloadPrcFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">windowPrc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">windowPrc </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">WindowProperties</span><span class="s2">.</span><span class="s1">clearDefault</span><span class="s2">()</span>

        <span class="s6"># However, we keep the self.windowProperties object around, in</span>
        <span class="s6"># case an application wants to return the window to the</span>
        <span class="s6"># browser frame.</span>

    <span class="s4">def </span><span class="s1">setupWindow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">windowType</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">,</span>
                    <span class="s1">parent</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Applies the indicated window parameters to the prc 
        settings, for future windows; or applies them directly to the 
        main window if the window has already been opened.  This is 
        called by the browser. &quot;&quot;&quot;</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">started </span><span class="s4">and </span><span class="s1">base</span><span class="s2">.</span><span class="s1">win</span><span class="s2">:</span>
            <span class="s6"># If we've already got a window, this must be a</span>
            <span class="s6"># resize/reposition request.</span>
            <span class="s1">wp </span><span class="s2">= </span><span class="s1">WindowProperties</span><span class="s2">()</span>
            <span class="s4">if </span><span class="s1">x </span><span class="s4">or </span><span class="s1">y </span><span class="s4">or </span><span class="s1">windowType </span><span class="s2">== </span><span class="s3">'embedded'</span><span class="s2">:</span>
                <span class="s1">wp</span><span class="s2">.</span><span class="s1">setOrigin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">width </span><span class="s4">or </span><span class="s1">height</span><span class="s2">:</span>
                <span class="s1">wp</span><span class="s2">.</span><span class="s1">setSize</span><span class="s2">(</span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">windowType </span><span class="s2">== </span><span class="s3">'embedded'</span><span class="s2">:</span>
                <span class="s1">wp</span><span class="s2">.</span><span class="s1">setParentWindow</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">)</span>
            <span class="s1">wp</span><span class="s2">.</span><span class="s1">setFullscreen</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
            <span class="s1">base</span><span class="s2">.</span><span class="s1">win</span><span class="s2">.</span><span class="s1">requestProperties</span><span class="s2">(</span><span class="s1">wp</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">windowProperties </span><span class="s2">= </span><span class="s1">wp</span>
            <span class="s4">return</span>

        <span class="s6"># If we haven't got a window already, start 'er up.  Apply the</span>
        <span class="s6"># requested setting to the prc file, and to the default</span>
        <span class="s6"># WindowProperties structure.</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__clearWindowProperties</span><span class="s2">()</span>

        <span class="s4">if </span><span class="s1">windowType </span><span class="s2">== </span><span class="s3">'hidden'</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s3">'window-type none</span><span class="s4">\n</span><span class="s3">'</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s3">'window-type onscreen</span><span class="s4">\n</span><span class="s3">'</span>

        <span class="s1">wp </span><span class="s2">= </span><span class="s1">WindowProperties</span><span class="s2">.</span><span class="s1">getDefault</span><span class="s2">()</span>

        <span class="s1">wp</span><span class="s2">.</span><span class="s1">clearParentWindow</span><span class="s2">()</span>
        <span class="s1">wp</span><span class="s2">.</span><span class="s1">clearOrigin</span><span class="s2">()</span>
        <span class="s1">wp</span><span class="s2">.</span><span class="s1">clearSize</span><span class="s2">()</span>

        <span class="s1">wp</span><span class="s2">.</span><span class="s1">setFullscreen</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">windowType </span><span class="s2">== </span><span class="s3">'fullscreen'</span><span class="s2">:</span>
            <span class="s1">wp</span><span class="s2">.</span><span class="s1">setFullscreen</span><span class="s2">(</span><span class="s4">True</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">windowType </span><span class="s2">== </span><span class="s3">'embedded'</span><span class="s2">:</span>
            <span class="s1">wp</span><span class="s2">.</span><span class="s1">setParentWindow</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">x </span><span class="s4">or </span><span class="s1">y </span><span class="s4">or </span><span class="s1">windowType </span><span class="s2">== </span><span class="s3">'embedded'</span><span class="s2">:</span>
            <span class="s1">wp</span><span class="s2">.</span><span class="s1">setOrigin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">width </span><span class="s4">or </span><span class="s1">height</span><span class="s2">:</span>
            <span class="s1">wp</span><span class="s2">.</span><span class="s1">setSize</span><span class="s2">(</span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">windowProperties </span><span class="s2">= </span><span class="s1">wp</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">windowPrc </span><span class="s2">= </span><span class="s1">loadPrcFileData</span><span class="s2">(</span><span class="s3">&quot;setupWindow&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">WindowProperties</span><span class="s2">.</span><span class="s1">setDefault</span><span class="s2">(</span><span class="s1">wp</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">gotWindow </span><span class="s2">= </span><span class="s4">True</span>

        <span class="s6"># Send this call to the main thread; don't call it directly.</span>
        <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s3">'AppRunner_startIfReady'</span><span class="s2">, </span><span class="s1">taskChain </span><span class="s2">= </span><span class="s3">'default'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">setRequestFunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This method is called by the browser at startup to supply a 
        function that can be used to deliver requests upstream, to the 
        core API, and thereby to the browser. &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">requestFunc </span><span class="s2">= </span><span class="s1">func</span>

    <span class="s4">def </span><span class="s1">sendRequest</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Delivers a request to the browser via self.requestFunc. 
        This low-level function is not intended to be called directly 
        by user code. &quot;&quot;&quot;</span>

        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">requestFunc</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">requestFunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">instanceId</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__windowEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">win</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This method is called when we get a window event.  We 
        listen for this to detect when the window has been 
        successfully opened. &quot;&quot;&quot;</span>

        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">windowOpened</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">windowOpened </span><span class="s2">= </span><span class="s4">True</span>

            <span class="s6"># Now that the window is open, we don't need to keep those</span>
            <span class="s6"># prc settings around any more.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__clearWindowProperties</span><span class="s2">()</span>

            <span class="s6"># Inform the plugin and browser.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notifyRequest</span><span class="s2">(</span><span class="s3">'onwindowopen'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">notifyRequest</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">message</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Delivers a notify request to the browser.  This is a &quot;this 
        happened&quot; type notification; it also triggers some JavaScript 
        code execution, if indicated in the HTML tags, and may also 
        trigger some internal automatic actions.  (For instance, the 
        plugin takes down the splash window when it sees the 
        onwindowopen notification. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">sendRequest</span><span class="s2">(</span><span class="s3">'notify'</span><span class="s2">, </span><span class="s1">message</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">())</span>

    <span class="s4">def </span><span class="s1">evalScript</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">expression</span><span class="s2">, </span><span class="s1">needsResponse </span><span class="s2">= </span><span class="s4">False</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Evaluates an arbitrary JavaScript expression in the global 
        DOM space.  This may be deferred if necessary if needsResponse 
        is False and self.dom has not yet been assigned.  If 
        needsResponse is true, this waits for the value and returns 
        it, which means it cannot be deferred. &quot;&quot;&quot;</span>

        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dom</span><span class="s2">:</span>
            <span class="s6"># Defer the expression.</span>
            <span class="s4">assert not </span><span class="s1">needsResponse</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">deferredEvals</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">expression</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s6"># Evaluate it now.</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scriptRequest</span><span class="s2">(</span><span class="s3">'eval'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dom</span><span class="s2">, </span><span class="s1">value </span><span class="s2">= </span><span class="s1">expression</span><span class="s2">,</span>
                                      <span class="s1">needsResponse </span><span class="s2">= </span><span class="s1">needsResponse</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">scriptRequest</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">operation</span><span class="s2">, </span><span class="s1">object</span><span class="s2">, </span><span class="s1">propertyName </span><span class="s2">= </span><span class="s3">''</span><span class="s2">,</span>
                      <span class="s1">value </span><span class="s2">= </span><span class="s4">None</span><span class="s2">, </span><span class="s1">needsResponse </span><span class="s2">= </span><span class="s4">True</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Issues a new script request to the browser.  This queries 
        or modifies one of the browser's DOM properties.  This is a 
        low-level method that user code should not call directly; 
        instead, just operate on the Python wrapper objects that 
        shadow the DOM objects, beginning with appRunner.dom. 
 
        operation may be one of [ 'get_property', 'set_property', 
        'call', 'evaluate' ]. 
 
        object is the browser object to manipulate, or the scope in 
        which to evaluate the expression. 
 
        propertyName is the name of the property to manipulate, if 
        relevant (set to None for the default method name). 
 
        value is the new value to assign to the property for 
        set_property, or the parameter list for call, or the string 
        expression for evaluate. 
 
        If needsResponse is true, this method will block until the 
        return value is received from the browser, and then it returns 
        that value.  Otherwise, it returns None immediately, without 
        waiting for the browser to process the request. 
        &quot;&quot;&quot;</span>
        <span class="s1">uniqueId </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">nextScriptId</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">nextScriptId </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">nextScriptId </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) % </span><span class="s5">0xffffffff</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sendRequest</span><span class="s2">(</span><span class="s3">'script'</span><span class="s2">, </span><span class="s1">operation</span><span class="s2">, </span><span class="s1">object</span><span class="s2">,</span>
                         <span class="s1">propertyName</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">needsResponse</span><span class="s2">, </span><span class="s1">uniqueId</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">needsResponse</span><span class="s2">:</span>
            <span class="s6"># Now wait for the response to come in.</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sendRequest</span><span class="s2">(</span><span class="s3">'wait_script_response'</span><span class="s2">, </span><span class="s1">uniqueId</span><span class="s2">)</span>
            <span class="s4">return </span><span class="s1">result</span>

    <span class="s4">def </span><span class="s1">dropObject</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">objectId</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Inform the parent process that we no longer have an 
        interest in the P3D_object corresponding to the indicated 
        objectId.  Not intended to be called by user code. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">sendRequest</span><span class="s2">(</span><span class="s3">'drop_p3dobj'</span><span class="s2">, </span><span class="s1">objectId</span><span class="s2">)</span>

<span class="s4">def </span><span class="s1">dummyAppRunner</span><span class="s2">(</span><span class="s1">tokens </span><span class="s2">= [], </span><span class="s1">argv </span><span class="s2">= </span><span class="s4">None</span><span class="s2">):</span>
    <span class="s0">&quot;&quot;&quot; This function creates a dummy global AppRunner object, which 
    is useful for testing running in a packaged environment without 
    actually bothering to package up the application.  Call this at 
    the start of your application to enable it. 
 
    It places the current working directory under /mf, as if it were 
    mounted from a packed multifile.  It doesn't convert egg files to 
    bam files, of course; and there are other minor differences from 
    running in an actual packaged environment.  But it can be a useful 
    first-look sanity check. &quot;&quot;&quot;</span>

    <span class="s4">if </span><span class="s1">AppRunnerGlobal</span><span class="s2">.</span><span class="s1">appRunner</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Already have AppRunner, not creating a new one.&quot;</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">AppRunnerGlobal</span><span class="s2">.</span><span class="s1">appRunner</span>

    <span class="s1">appRunner </span><span class="s2">= </span><span class="s1">AppRunner</span><span class="s2">()</span>
    <span class="s1">appRunner</span><span class="s2">.</span><span class="s1">dummy </span><span class="s2">= </span><span class="s4">True</span>
    <span class="s1">AppRunnerGlobal</span><span class="s2">.</span><span class="s1">appRunner </span><span class="s2">= </span><span class="s1">appRunner</span>

    <span class="s1">platform </span><span class="s2">= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPlatform</span><span class="s2">()</span>
    <span class="s1">version </span><span class="s2">= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageVersionString</span><span class="s2">()</span>
    <span class="s1">hostUrl </span><span class="s2">= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageHostUrl</span><span class="s2">()</span>

    <span class="s4">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'win'</span><span class="s2">):</span>
        <span class="s1">rootDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">getUserAppdataDirectory</span><span class="s2">(), </span><span class="s3">'Panda3D'</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'osx'</span><span class="s2">):</span>
        <span class="s1">rootDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">getHomeDirectory</span><span class="s2">(), </span><span class="s3">'Library/Caches/Panda3D'</span><span class="s2">)</span>
    <span class="s4">else</span><span class="s2">:</span>
        <span class="s1">rootDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">getHomeDirectory</span><span class="s2">(), </span><span class="s3">'.panda3d'</span><span class="s2">)</span>

    <span class="s1">appRunner</span><span class="s2">.</span><span class="s1">rootDir </span><span class="s2">= </span><span class="s1">rootDir</span>
    <span class="s1">appRunner</span><span class="s2">.</span><span class="s1">logDirectory </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">rootDir</span><span class="s2">, </span><span class="s3">'log'</span><span class="s2">)</span>

    <span class="s6"># Of course we will have the panda3d application loaded.</span>
    <span class="s1">appRunner</span><span class="s2">.</span><span class="s1">addPackageInfo</span><span class="s2">(</span><span class="s3">'panda3d'</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">hostUrl</span><span class="s2">)</span>

    <span class="s1">appRunner</span><span class="s2">.</span><span class="s1">tokens </span><span class="s2">= </span><span class="s1">tokens</span>
    <span class="s1">appRunner</span><span class="s2">.</span><span class="s1">tokenDict </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">tokens</span><span class="s2">)</span>
    <span class="s4">if </span><span class="s1">argv </span><span class="s4">is None</span><span class="s2">:</span>
        <span class="s1">argv </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span>
    <span class="s1">appRunner</span><span class="s2">.</span><span class="s1">argv </span><span class="s2">= </span><span class="s1">argv</span>
    <span class="s1">appRunner</span><span class="s2">.</span><span class="s1">altHost </span><span class="s2">= </span><span class="s1">appRunner</span><span class="s2">.</span><span class="s1">tokenDict</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'alt_host'</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>

    <span class="s1">appRunner</span><span class="s2">.</span><span class="s1">p3dInfo </span><span class="s2">= </span><span class="s4">None</span>
    <span class="s1">appRunner</span><span class="s2">.</span><span class="s1">p3dPackage </span><span class="s2">= </span><span class="s4">None</span>

    <span class="s6"># Mount the current directory under the multifileRoot, as if it</span>
    <span class="s6"># were coming from a multifile.</span>
    <span class="s1">cwd </span><span class="s2">= </span><span class="s1">ExecutionEnvironment</span><span class="s2">.</span><span class="s1">getCwd</span><span class="s2">()</span>
    <span class="s1">vfs </span><span class="s2">= </span><span class="s1">VirtualFileSystem</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>
    <span class="s1">vfs</span><span class="s2">.</span><span class="s1">mount</span><span class="s2">(</span><span class="s1">cwd</span><span class="s2">, </span><span class="s1">appRunner</span><span class="s2">.</span><span class="s1">multifileRoot</span><span class="s2">, </span><span class="s1">vfs</span><span class="s2">.</span><span class="s1">MFReadOnly</span><span class="s2">)</span>

    <span class="s1">appRunner</span><span class="s2">.</span><span class="s1">initPackedAppEnvironment</span><span class="s2">()</span>

    <span class="s4">return </span><span class="s1">appRunner</span>

</pre>
</body>
</html>