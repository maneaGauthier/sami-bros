<html>
<head>
<title>DirectGeometry.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #bcbec4;}
.s1 { color: #cf8e6d;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
DirectGeometry.py</font>
</center></td></tr></table>
<pre>
<span class="s1">from </span><span class="s0">panda3d</span><span class="s2">.</span><span class="s0">core </span><span class="s1">import </span><span class="s2">*</span>
<span class="s1">from </span><span class="s2">.</span><span class="s0">DirectGlobals </span><span class="s1">import </span><span class="s2">*</span>
<span class="s1">from </span><span class="s2">.</span><span class="s0">DirectUtil </span><span class="s1">import </span><span class="s2">*</span>
<span class="s1">import </span><span class="s0">math</span>

<span class="s1">class </span><span class="s0">LineNodePath</span><span class="s2">(</span><span class="s0">NodePath</span><span class="s2">):</span>
    <span class="s1">def </span><span class="s0">__init__</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">parent </span><span class="s2">= </span><span class="s1">None</span><span class="s2">, </span><span class="s0">name </span><span class="s2">= </span><span class="s1">None</span><span class="s2">,</span>
                 <span class="s0">thickness </span><span class="s2">= </span><span class="s3">1.0</span><span class="s2">, </span><span class="s0">colorVec </span><span class="s2">= </span><span class="s0">VBase4</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)):</span>

        <span class="s4"># Initialize the superclass</span>
        <span class="s0">NodePath</span><span class="s2">.</span><span class="s0">__init__</span><span class="s2">(</span><span class="s0">self</span><span class="s2">)</span>

        <span class="s1">if </span><span class="s0">parent </span><span class="s1">is None</span><span class="s2">:</span>
            <span class="s0">parent </span><span class="s2">= </span><span class="s0">hidden</span>

        <span class="s4"># Attach a geomNode to the parent and set self to be</span>
        <span class="s4"># the resulting node path</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">lineNode </span><span class="s2">= </span><span class="s0">GeomNode</span><span class="s2">(</span><span class="s5">&quot;lineNode&quot;</span><span class="s2">)</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">assign</span><span class="s2">(</span><span class="s0">parent</span><span class="s2">.</span><span class="s0">attachNewNode</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">lineNode</span><span class="s2">))</span>
        <span class="s1">if </span><span class="s0">name</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">setName</span><span class="s2">(</span><span class="s0">name</span><span class="s2">)</span>

        <span class="s4"># Create a lineSegs object to hold the line</span>
        <span class="s0">ls </span><span class="s2">= </span><span class="s0">self</span><span class="s2">.</span><span class="s0">lineSegs </span><span class="s2">= </span><span class="s0">LineSegs</span><span class="s2">()</span>
        <span class="s4"># Initialize the lineSegs parameters</span>
        <span class="s0">ls</span><span class="s2">.</span><span class="s0">setThickness</span><span class="s2">(</span><span class="s0">thickness</span><span class="s2">)</span>
        <span class="s0">ls</span><span class="s2">.</span><span class="s0">setColor</span><span class="s2">(</span><span class="s0">colorVec</span><span class="s2">)</span>

    <span class="s1">def </span><span class="s0">moveTo</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, *</span><span class="s0">_args</span><span class="s2">):</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">lineSegs</span><span class="s2">.</span><span class="s0">moveTo</span><span class="s2">(*</span><span class="s0">_args</span><span class="s2">)</span>

    <span class="s1">def </span><span class="s0">drawTo</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, *</span><span class="s0">_args</span><span class="s2">):</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">lineSegs</span><span class="s2">.</span><span class="s0">drawTo</span><span class="s2">(*</span><span class="s0">_args</span><span class="s2">)</span>

    <span class="s1">def </span><span class="s0">create</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">frameAccurate </span><span class="s2">= </span><span class="s3">0</span><span class="s2">):</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">lineSegs</span><span class="s2">.</span><span class="s0">create</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">lineNode</span><span class="s2">, </span><span class="s0">frameAccurate</span><span class="s2">)</span>

    <span class="s1">def </span><span class="s0">reset</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">lineSegs</span><span class="s2">.</span><span class="s0">reset</span><span class="s2">()</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">lineNode</span><span class="s2">.</span><span class="s0">removeAllGeoms</span><span class="s2">()</span>

    <span class="s1">def </span><span class="s0">isEmpty</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s1">return </span><span class="s0">self</span><span class="s2">.</span><span class="s0">lineSegs</span><span class="s2">.</span><span class="s0">isEmpty</span><span class="s2">()</span>

    <span class="s1">def </span><span class="s0">setThickness</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">thickness</span><span class="s2">):</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">lineSegs</span><span class="s2">.</span><span class="s0">setThickness</span><span class="s2">(</span><span class="s0">thickness</span><span class="s2">)</span>

    <span class="s1">def </span><span class="s0">setColor</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, *</span><span class="s0">_args</span><span class="s2">):</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">lineSegs</span><span class="s2">.</span><span class="s0">setColor</span><span class="s2">(*</span><span class="s0">_args</span><span class="s2">)</span>

    <span class="s1">def </span><span class="s0">setVertex</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, *</span><span class="s0">_args</span><span class="s2">):</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">lineSegs</span><span class="s2">.</span><span class="s0">setVertex</span><span class="s2">(*</span><span class="s0">_args</span><span class="s2">)</span>

    <span class="s1">def </span><span class="s0">setVertexColor</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">vertex</span><span class="s2">, *</span><span class="s0">_args</span><span class="s2">):</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">lineSegs</span><span class="s2">.</span><span class="s0">setVertexColor</span><span class="s2">(*(</span><span class="s0">vertex</span><span class="s2">,) + </span><span class="s0">_args</span><span class="s2">)</span>

    <span class="s1">def </span><span class="s0">getCurrentPosition</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s1">return </span><span class="s0">self</span><span class="s2">.</span><span class="s0">lineSegs</span><span class="s2">.</span><span class="s0">getCurrentPosition</span><span class="s2">()</span>

    <span class="s1">def </span><span class="s0">getNumVertices</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s1">return </span><span class="s0">self</span><span class="s2">.</span><span class="s0">lineSegs</span><span class="s2">.</span><span class="s0">getNumVertices</span><span class="s2">()</span>

    <span class="s1">def </span><span class="s0">getVertex</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">index</span><span class="s2">):</span>
        <span class="s1">return </span><span class="s0">self</span><span class="s2">.</span><span class="s0">lineSegs</span><span class="s2">.</span><span class="s0">getVertex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">)</span>

    <span class="s1">def </span><span class="s0">getVertexColor</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s1">return </span><span class="s0">self</span><span class="s2">.</span><span class="s0">lineSegs</span><span class="s2">.</span><span class="s0">getVertexColor</span><span class="s2">()</span>

    <span class="s1">def </span><span class="s0">drawArrow</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">sv</span><span class="s2">, </span><span class="s0">ev</span><span class="s2">, </span><span class="s0">arrowAngle</span><span class="s2">, </span><span class="s0">arrowLength</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Do the work of moving the cursor around to draw an arrow from 
        sv to ev. Hack: the arrows take the z value of the end point 
        &quot;&quot;&quot;</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">moveTo</span><span class="s2">(</span><span class="s0">sv</span><span class="s2">)</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">drawTo</span><span class="s2">(</span><span class="s0">ev</span><span class="s2">)</span>
        <span class="s0">v </span><span class="s2">= </span><span class="s0">sv </span><span class="s2">- </span><span class="s0">ev</span>
        <span class="s4"># Find the angle of the line</span>
        <span class="s0">angle </span><span class="s2">= </span><span class="s0">math</span><span class="s2">.</span><span class="s0">atan2</span><span class="s2">(</span><span class="s0">v</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s0">v</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s4"># Get the arrow angles</span>
        <span class="s0">a1 </span><span class="s2">= </span><span class="s0">angle </span><span class="s2">+ </span><span class="s0">deg2Rad</span><span class="s2">(</span><span class="s0">arrowAngle</span><span class="s2">)</span>
        <span class="s0">a2 </span><span class="s2">= </span><span class="s0">angle </span><span class="s2">- </span><span class="s0">deg2Rad</span><span class="s2">(</span><span class="s0">arrowAngle</span><span class="s2">)</span>
        <span class="s4"># Get the arrow points</span>
        <span class="s0">a1x </span><span class="s2">= </span><span class="s0">arrowLength </span><span class="s2">* </span><span class="s0">math</span><span class="s2">.</span><span class="s0">cos</span><span class="s2">(</span><span class="s0">a1</span><span class="s2">)</span>
        <span class="s0">a1y </span><span class="s2">= </span><span class="s0">arrowLength </span><span class="s2">* </span><span class="s0">math</span><span class="s2">.</span><span class="s0">sin</span><span class="s2">(</span><span class="s0">a1</span><span class="s2">)</span>
        <span class="s0">a2x </span><span class="s2">= </span><span class="s0">arrowLength </span><span class="s2">* </span><span class="s0">math</span><span class="s2">.</span><span class="s0">cos</span><span class="s2">(</span><span class="s0">a2</span><span class="s2">)</span>
        <span class="s0">a2y </span><span class="s2">= </span><span class="s0">arrowLength </span><span class="s2">* </span><span class="s0">math</span><span class="s2">.</span><span class="s0">sin</span><span class="s2">(</span><span class="s0">a2</span><span class="s2">)</span>
        <span class="s0">z </span><span class="s2">= </span><span class="s0">ev</span><span class="s2">[</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">moveTo</span><span class="s2">(</span><span class="s0">ev</span><span class="s2">)</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">drawTo</span><span class="s2">(</span><span class="s0">Point3</span><span class="s2">(</span><span class="s0">ev </span><span class="s2">+ </span><span class="s0">Point3</span><span class="s2">(</span><span class="s0">a1x</span><span class="s2">, </span><span class="s0">a1y</span><span class="s2">, </span><span class="s0">z</span><span class="s2">)))</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">moveTo</span><span class="s2">(</span><span class="s0">ev</span><span class="s2">)</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">drawTo</span><span class="s2">(</span><span class="s0">Point3</span><span class="s2">(</span><span class="s0">ev </span><span class="s2">+ </span><span class="s0">Point3</span><span class="s2">(</span><span class="s0">a2x</span><span class="s2">, </span><span class="s0">a2y</span><span class="s2">, </span><span class="s0">z</span><span class="s2">)))</span>

    <span class="s1">def </span><span class="s0">drawArrow2d</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">sv</span><span class="s2">, </span><span class="s0">ev</span><span class="s2">, </span><span class="s0">arrowAngle</span><span class="s2">, </span><span class="s0">arrowLength</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Do the work of moving the cursor around to draw an arrow from 
        sv to ev. Hack: the arrows take the z value of the end point 
        &quot;&quot;&quot;</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">moveTo</span><span class="s2">(</span><span class="s0">sv</span><span class="s2">)</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">drawTo</span><span class="s2">(</span><span class="s0">ev</span><span class="s2">)</span>
        <span class="s0">v </span><span class="s2">= </span><span class="s0">sv </span><span class="s2">- </span><span class="s0">ev</span>
        <span class="s4"># Find the angle of the line</span>
        <span class="s0">angle </span><span class="s2">= </span><span class="s0">math</span><span class="s2">.</span><span class="s0">atan2</span><span class="s2">(</span><span class="s0">v</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s0">v</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s4"># Get the arrow angles</span>
        <span class="s0">a1 </span><span class="s2">= </span><span class="s0">angle </span><span class="s2">+ </span><span class="s0">deg2Rad</span><span class="s2">(</span><span class="s0">arrowAngle</span><span class="s2">)</span>
        <span class="s0">a2 </span><span class="s2">= </span><span class="s0">angle </span><span class="s2">- </span><span class="s0">deg2Rad</span><span class="s2">(</span><span class="s0">arrowAngle</span><span class="s2">)</span>
        <span class="s4"># Get the arrow points</span>
        <span class="s0">a1x </span><span class="s2">= </span><span class="s0">arrowLength </span><span class="s2">* </span><span class="s0">math</span><span class="s2">.</span><span class="s0">cos</span><span class="s2">(</span><span class="s0">a1</span><span class="s2">)</span>
        <span class="s0">a1y </span><span class="s2">= </span><span class="s0">arrowLength </span><span class="s2">* </span><span class="s0">math</span><span class="s2">.</span><span class="s0">sin</span><span class="s2">(</span><span class="s0">a1</span><span class="s2">)</span>
        <span class="s0">a2x </span><span class="s2">= </span><span class="s0">arrowLength </span><span class="s2">* </span><span class="s0">math</span><span class="s2">.</span><span class="s0">cos</span><span class="s2">(</span><span class="s0">a2</span><span class="s2">)</span>
        <span class="s0">a2y </span><span class="s2">= </span><span class="s0">arrowLength </span><span class="s2">* </span><span class="s0">math</span><span class="s2">.</span><span class="s0">sin</span><span class="s2">(</span><span class="s0">a2</span><span class="s2">)</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">moveTo</span><span class="s2">(</span><span class="s0">ev</span><span class="s2">)</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">drawTo</span><span class="s2">(</span><span class="s0">Point3</span><span class="s2">(</span><span class="s0">ev </span><span class="s2">+ </span><span class="s0">Point3</span><span class="s2">(</span><span class="s0">a1x</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s0">a1y</span><span class="s2">)))</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">moveTo</span><span class="s2">(</span><span class="s0">ev</span><span class="s2">)</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">drawTo</span><span class="s2">(</span><span class="s0">Point3</span><span class="s2">(</span><span class="s0">ev </span><span class="s2">+ </span><span class="s0">Point3</span><span class="s2">(</span><span class="s0">a2x</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s0">a2y</span><span class="s2">)))</span>

    <span class="s1">def </span><span class="s0">drawLines</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">lineList</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Given a list of lists of points, draw a separate line for each list 
        &quot;&quot;&quot;</span>
        <span class="s1">for </span><span class="s0">pointList </span><span class="s1">in </span><span class="s0">lineList</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">moveTo</span><span class="s2">(*</span><span class="s0">pointList</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
            <span class="s1">for </span><span class="s0">point </span><span class="s1">in </span><span class="s0">pointList</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:]:</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">drawTo</span><span class="s2">(*</span><span class="s0">point</span><span class="s2">)</span>

<span class="s4">##</span>
<span class="s4">## Given a point in space, and a direction, find the point of intersection</span>
<span class="s4">## of that ray with a plane at the specified origin, with the specified normal</span>
<span class="s1">def </span><span class="s0">planeIntersect </span><span class="s2">(</span><span class="s0">lineOrigin</span><span class="s2">, </span><span class="s0">lineDir</span><span class="s2">, </span><span class="s0">planeOrigin</span><span class="s2">, </span><span class="s0">normal</span><span class="s2">):</span>
    <span class="s0">t </span><span class="s2">= </span><span class="s3">0</span>
    <span class="s0">offset </span><span class="s2">= </span><span class="s0">planeOrigin </span><span class="s2">- </span><span class="s0">lineOrigin</span>
    <span class="s0">t </span><span class="s2">= </span><span class="s0">offset</span><span class="s2">.</span><span class="s0">dot</span><span class="s2">(</span><span class="s0">normal</span><span class="s2">) / </span><span class="s0">lineDir</span><span class="s2">.</span><span class="s0">dot</span><span class="s2">(</span><span class="s0">normal</span><span class="s2">)</span>
    <span class="s0">hitPt </span><span class="s2">= </span><span class="s0">lineDir </span><span class="s2">* </span><span class="s0">t</span>
    <span class="s1">return </span><span class="s0">hitPt </span><span class="s2">+ </span><span class="s0">lineOrigin</span>

<span class="s1">def </span><span class="s0">getNearProjectionPoint</span><span class="s2">(</span><span class="s0">nodePath</span><span class="s2">):</span>
    <span class="s4"># Find the position of the projection of the specified node path</span>
    <span class="s4"># on the near plane</span>
    <span class="s0">origin </span><span class="s2">= </span><span class="s0">nodePath</span><span class="s2">.</span><span class="s0">getPos</span><span class="s2">(</span><span class="s0">base</span><span class="s2">.</span><span class="s0">direct</span><span class="s2">.</span><span class="s0">camera</span><span class="s2">)</span>
    <span class="s4"># project this onto near plane</span>
    <span class="s1">if </span><span class="s0">origin</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] != </span><span class="s3">0.0</span><span class="s2">:</span>
        <span class="s1">return </span><span class="s0">origin </span><span class="s2">* (</span><span class="s0">base</span><span class="s2">.</span><span class="s0">direct</span><span class="s2">.</span><span class="s0">dr</span><span class="s2">.</span><span class="s0">near </span><span class="s2">/ </span><span class="s0">origin</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
    <span class="s1">else</span><span class="s2">:</span>
        <span class="s4"># Object is coplaner with camera, just return something reasonable</span>
        <span class="s1">return </span><span class="s0">Point3</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s0">base</span><span class="s2">.</span><span class="s0">direct</span><span class="s2">.</span><span class="s0">dr</span><span class="s2">.</span><span class="s0">near</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

<span class="s1">def </span><span class="s0">getScreenXY</span><span class="s2">(</span><span class="s0">nodePath</span><span class="s2">):</span>
    <span class="s4"># Where does the node path's projection fall on the near plane</span>
    <span class="s0">nearVec </span><span class="s2">= </span><span class="s0">getNearProjectionPoint</span><span class="s2">(</span><span class="s0">nodePath</span><span class="s2">)</span>
    <span class="s4"># Clamp these coordinates to visible screen</span>
    <span class="s0">nearX </span><span class="s2">= </span><span class="s0">CLAMP</span><span class="s2">(</span><span class="s0">nearVec</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s0">base</span><span class="s2">.</span><span class="s0">direct</span><span class="s2">.</span><span class="s0">dr</span><span class="s2">.</span><span class="s0">left</span><span class="s2">, </span><span class="s0">base</span><span class="s2">.</span><span class="s0">direct</span><span class="s2">.</span><span class="s0">dr</span><span class="s2">.</span><span class="s0">right</span><span class="s2">)</span>
    <span class="s0">nearY </span><span class="s2">= </span><span class="s0">CLAMP</span><span class="s2">(</span><span class="s0">nearVec</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s0">base</span><span class="s2">.</span><span class="s0">direct</span><span class="s2">.</span><span class="s0">dr</span><span class="s2">.</span><span class="s0">bottom</span><span class="s2">, </span><span class="s0">base</span><span class="s2">.</span><span class="s0">direct</span><span class="s2">.</span><span class="s0">dr</span><span class="s2">.</span><span class="s0">top</span><span class="s2">)</span>
    <span class="s4"># What percentage of the distance across the screen is this?</span>
    <span class="s0">percentX </span><span class="s2">= (</span><span class="s0">nearX </span><span class="s2">- </span><span class="s0">base</span><span class="s2">.</span><span class="s0">direct</span><span class="s2">.</span><span class="s0">dr</span><span class="s2">.</span><span class="s0">left</span><span class="s2">)/</span><span class="s0">base</span><span class="s2">.</span><span class="s0">direct</span><span class="s2">.</span><span class="s0">dr</span><span class="s2">.</span><span class="s0">nearWidth</span>
    <span class="s0">percentY </span><span class="s2">= (</span><span class="s0">nearY </span><span class="s2">- </span><span class="s0">base</span><span class="s2">.</span><span class="s0">direct</span><span class="s2">.</span><span class="s0">dr</span><span class="s2">.</span><span class="s0">bottom</span><span class="s2">)/</span><span class="s0">base</span><span class="s2">.</span><span class="s0">direct</span><span class="s2">.</span><span class="s0">dr</span><span class="s2">.</span><span class="s0">nearHeight</span>
    <span class="s4"># Map this percentage to the same -1 to 1 space as the mouse</span>
    <span class="s0">screenXY </span><span class="s2">= </span><span class="s0">Vec3</span><span class="s2">((</span><span class="s3">2 </span><span class="s2">* </span><span class="s0">percentX</span><span class="s2">) - </span><span class="s3">1.0</span><span class="s2">, </span><span class="s0">nearVec</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], (</span><span class="s3">2 </span><span class="s2">* </span><span class="s0">percentY</span><span class="s2">) - </span><span class="s3">1.0</span><span class="s2">)</span>
    <span class="s4"># Return the resulting value</span>
    <span class="s1">return </span><span class="s0">screenXY</span>

<span class="s1">def </span><span class="s0">getCrankAngle</span><span class="s2">(</span><span class="s0">center</span><span class="s2">):</span>
    <span class="s4"># Used to compute current angle of mouse (relative to the coa's</span>
    <span class="s4"># origin) in screen space</span>
    <span class="s0">x </span><span class="s2">= </span><span class="s0">base</span><span class="s2">.</span><span class="s0">direct</span><span class="s2">.</span><span class="s0">dr</span><span class="s2">.</span><span class="s0">mouseX </span><span class="s2">- </span><span class="s0">center</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
    <span class="s0">y </span><span class="s2">= </span><span class="s0">base</span><span class="s2">.</span><span class="s0">direct</span><span class="s2">.</span><span class="s0">dr</span><span class="s2">.</span><span class="s0">mouseY </span><span class="s2">- </span><span class="s0">center</span><span class="s2">[</span><span class="s3">2</span><span class="s2">]</span>
    <span class="s1">return </span><span class="s2">(</span><span class="s3">180 </span><span class="s2">+ </span><span class="s0">rad2Deg</span><span class="s2">(</span><span class="s0">math</span><span class="s2">.</span><span class="s0">atan2</span><span class="s2">(</span><span class="s0">y</span><span class="s2">, </span><span class="s0">x</span><span class="s2">)))</span>

<span class="s1">def </span><span class="s0">relHpr</span><span class="s2">(</span><span class="s0">nodePath</span><span class="s2">, </span><span class="s0">base</span><span class="s2">, </span><span class="s0">h</span><span class="s2">, </span><span class="s0">p</span><span class="s2">, </span><span class="s0">r</span><span class="s2">):</span>
    <span class="s4"># Compute nodePath2newNodePath relative to base coordinate system</span>
    <span class="s4"># nodePath2base</span>
    <span class="s0">mNodePath2Base </span><span class="s2">= </span><span class="s0">nodePath</span><span class="s2">.</span><span class="s0">getMat</span><span class="s2">(</span><span class="s0">base</span><span class="s2">)</span>
    <span class="s4"># delta scale, orientation, and position matrix</span>
    <span class="s0">mBase2NewBase </span><span class="s2">= </span><span class="s0">Mat4</span><span class="s2">(</span><span class="s0">Mat4</span><span class="s2">.</span><span class="s0">identMat</span><span class="s2">()) </span><span class="s4"># [gjeon] fixed to give required argument</span>
    <span class="s0">composeMatrix</span><span class="s2">(</span><span class="s0">mBase2NewBase</span><span class="s2">, </span><span class="s0">UNIT_VEC</span><span class="s2">, </span><span class="s0">VBase3</span><span class="s2">(</span><span class="s0">h</span><span class="s2">, </span><span class="s0">p</span><span class="s2">, </span><span class="s0">r</span><span class="s2">), </span><span class="s0">ZERO_VEC</span><span class="s2">,</span>
                  <span class="s0">CSDefault</span><span class="s2">)</span>
    <span class="s4"># base2nodePath</span>
    <span class="s0">mBase2NodePath </span><span class="s2">= </span><span class="s0">base</span><span class="s2">.</span><span class="s0">getMat</span><span class="s2">(</span><span class="s0">nodePath</span><span class="s2">)</span>
    <span class="s4"># nodePath2 Parent</span>
    <span class="s0">mNodePath2Parent </span><span class="s2">= </span><span class="s0">nodePath</span><span class="s2">.</span><span class="s0">getMat</span><span class="s2">()</span>
    <span class="s4"># Compose the result</span>
    <span class="s0">resultMat </span><span class="s2">= </span><span class="s0">mNodePath2Base </span><span class="s2">* </span><span class="s0">mBase2NewBase</span>
    <span class="s0">resultMat </span><span class="s2">= </span><span class="s0">resultMat </span><span class="s2">* </span><span class="s0">mBase2NodePath</span>
    <span class="s0">resultMat </span><span class="s2">= </span><span class="s0">resultMat </span><span class="s2">* </span><span class="s0">mNodePath2Parent</span>
    <span class="s4"># Extract and apply the hpr</span>
    <span class="s0">hpr </span><span class="s2">= </span><span class="s0">Vec3</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s0">decomposeMatrix</span><span class="s2">(</span><span class="s0">resultMat</span><span class="s2">, </span><span class="s0">VBase3</span><span class="s2">(), </span><span class="s0">hpr</span><span class="s2">, </span><span class="s0">VBase3</span><span class="s2">(),</span>
                    <span class="s0">CSDefault</span><span class="s2">)</span>
    <span class="s0">nodePath</span><span class="s2">.</span><span class="s0">setHpr</span><span class="s2">(</span><span class="s0">hpr</span><span class="s2">)</span>

<span class="s4"># Quaternion interpolation</span>
<span class="s1">def </span><span class="s0">qSlerp</span><span class="s2">(</span><span class="s0">startQuat</span><span class="s2">, </span><span class="s0">endQuat</span><span class="s2">, </span><span class="s0">t</span><span class="s2">):</span>
    <span class="s0">startQ </span><span class="s2">= </span><span class="s0">Quat</span><span class="s2">(</span><span class="s0">startQuat</span><span class="s2">)</span>
    <span class="s0">destQuat </span><span class="s2">= </span><span class="s0">Quat</span><span class="s2">(</span><span class="s0">Quat</span><span class="s2">.</span><span class="s0">identQuat</span><span class="s2">())</span>
    <span class="s4"># Calc dot product</span>
    <span class="s0">cosOmega </span><span class="s2">= (</span><span class="s0">startQ</span><span class="s2">.</span><span class="s0">getI</span><span class="s2">() * </span><span class="s0">endQuat</span><span class="s2">.</span><span class="s0">getI</span><span class="s2">() +</span>
                <span class="s0">startQ</span><span class="s2">.</span><span class="s0">getJ</span><span class="s2">() * </span><span class="s0">endQuat</span><span class="s2">.</span><span class="s0">getJ</span><span class="s2">() +</span>
                <span class="s0">startQ</span><span class="s2">.</span><span class="s0">getK</span><span class="s2">() * </span><span class="s0">endQuat</span><span class="s2">.</span><span class="s0">getK</span><span class="s2">() +</span>
                <span class="s0">startQ</span><span class="s2">.</span><span class="s0">getR</span><span class="s2">() * </span><span class="s0">endQuat</span><span class="s2">.</span><span class="s0">getR</span><span class="s2">())</span>
    <span class="s4"># If the above dot product is negative, it would be better to</span>
    <span class="s4"># go between the negative of the initial and the final, so that</span>
    <span class="s4"># we take the shorter path.</span>
    <span class="s1">if </span><span class="s0">cosOmega </span><span class="s2">&lt; </span><span class="s3">0.0</span><span class="s2">:</span>
        <span class="s0">cosOmega </span><span class="s2">*= -</span><span class="s3">1</span>
        <span class="s0">startQ</span><span class="s2">.</span><span class="s0">setI</span><span class="s2">(-</span><span class="s3">1 </span><span class="s2">* </span><span class="s0">startQ</span><span class="s2">.</span><span class="s0">getI</span><span class="s2">())</span>
        <span class="s0">startQ</span><span class="s2">.</span><span class="s0">setJ</span><span class="s2">(-</span><span class="s3">1 </span><span class="s2">* </span><span class="s0">startQ</span><span class="s2">.</span><span class="s0">getJ</span><span class="s2">())</span>
        <span class="s0">startQ</span><span class="s2">.</span><span class="s0">setK</span><span class="s2">(-</span><span class="s3">1 </span><span class="s2">* </span><span class="s0">startQ</span><span class="s2">.</span><span class="s0">getK</span><span class="s2">())</span>
        <span class="s0">startQ</span><span class="s2">.</span><span class="s0">setR</span><span class="s2">(-</span><span class="s3">1 </span><span class="s2">* </span><span class="s0">startQ</span><span class="s2">.</span><span class="s0">getR</span><span class="s2">())</span>
    <span class="s1">if </span><span class="s2">((</span><span class="s3">1.0 </span><span class="s2">+ </span><span class="s0">cosOmega</span><span class="s2">) &gt; </span><span class="s0">Q_EPSILON</span><span class="s2">):</span>
        <span class="s4"># usual case</span>
        <span class="s1">if </span><span class="s2">((</span><span class="s3">1.0 </span><span class="s2">- </span><span class="s0">cosOmega</span><span class="s2">) &gt; </span><span class="s0">Q_EPSILON</span><span class="s2">):</span>
            <span class="s4"># usual case</span>
            <span class="s0">omega </span><span class="s2">= </span><span class="s0">math</span><span class="s2">.</span><span class="s0">acos</span><span class="s2">(</span><span class="s0">cosOmega</span><span class="s2">)</span>
            <span class="s0">sinOmega </span><span class="s2">= </span><span class="s0">math</span><span class="s2">.</span><span class="s0">sin</span><span class="s2">(</span><span class="s0">omega</span><span class="s2">)</span>
            <span class="s0">startScale </span><span class="s2">= </span><span class="s0">math</span><span class="s2">.</span><span class="s0">sin</span><span class="s2">((</span><span class="s3">1.0 </span><span class="s2">- </span><span class="s0">t</span><span class="s2">) * </span><span class="s0">omega</span><span class="s2">)/</span><span class="s0">sinOmega</span>
            <span class="s0">endScale </span><span class="s2">= </span><span class="s0">math</span><span class="s2">.</span><span class="s0">sin</span><span class="s2">(</span><span class="s0">t </span><span class="s2">* </span><span class="s0">omega</span><span class="s2">)/</span><span class="s0">sinOmega</span>
        <span class="s1">else</span><span class="s2">:</span>
            <span class="s4"># ends very close</span>
            <span class="s0">startScale </span><span class="s2">= </span><span class="s3">1.0 </span><span class="s2">- </span><span class="s0">t</span>
            <span class="s0">endScale </span><span class="s2">= </span><span class="s0">t</span>
        <span class="s0">destQuat</span><span class="s2">.</span><span class="s0">setI</span><span class="s2">(</span><span class="s0">startScale </span><span class="s2">* </span><span class="s0">startQ</span><span class="s2">.</span><span class="s0">getI</span><span class="s2">() +</span>
                      <span class="s0">endScale </span><span class="s2">* </span><span class="s0">endQuat</span><span class="s2">.</span><span class="s0">getI</span><span class="s2">())</span>
        <span class="s0">destQuat</span><span class="s2">.</span><span class="s0">setJ</span><span class="s2">(</span><span class="s0">startScale </span><span class="s2">* </span><span class="s0">startQ</span><span class="s2">.</span><span class="s0">getJ</span><span class="s2">() +</span>
                      <span class="s0">endScale </span><span class="s2">* </span><span class="s0">endQuat</span><span class="s2">.</span><span class="s0">getJ</span><span class="s2">())</span>
        <span class="s0">destQuat</span><span class="s2">.</span><span class="s0">setK</span><span class="s2">(</span><span class="s0">startScale </span><span class="s2">* </span><span class="s0">startQ</span><span class="s2">.</span><span class="s0">getK</span><span class="s2">() +</span>
                      <span class="s0">endScale </span><span class="s2">* </span><span class="s0">endQuat</span><span class="s2">.</span><span class="s0">getK</span><span class="s2">())</span>
        <span class="s0">destQuat</span><span class="s2">.</span><span class="s0">setR</span><span class="s2">(</span><span class="s0">startScale </span><span class="s2">* </span><span class="s0">startQ</span><span class="s2">.</span><span class="s0">getR</span><span class="s2">() +</span>
                      <span class="s0">endScale </span><span class="s2">* </span><span class="s0">endQuat</span><span class="s2">.</span><span class="s0">getR</span><span class="s2">())</span>
    <span class="s1">else</span><span class="s2">:</span>
        <span class="s4"># ends nearly opposite</span>
        <span class="s0">destQuat</span><span class="s2">.</span><span class="s0">setI</span><span class="s2">(-</span><span class="s0">startQ</span><span class="s2">.</span><span class="s0">getJ</span><span class="s2">())</span>
        <span class="s0">destQuat</span><span class="s2">.</span><span class="s0">setJ</span><span class="s2">(</span><span class="s0">startQ</span><span class="s2">.</span><span class="s0">getI</span><span class="s2">())</span>
        <span class="s0">destQuat</span><span class="s2">.</span><span class="s0">setK</span><span class="s2">(-</span><span class="s0">startQ</span><span class="s2">.</span><span class="s0">getR</span><span class="s2">())</span>
        <span class="s0">destQuat</span><span class="s2">.</span><span class="s0">setR</span><span class="s2">(</span><span class="s0">startQ</span><span class="s2">.</span><span class="s0">getK</span><span class="s2">())</span>
        <span class="s0">startScale </span><span class="s2">= </span><span class="s0">math</span><span class="s2">.</span><span class="s0">sin</span><span class="s2">((</span><span class="s3">0.5 </span><span class="s2">- </span><span class="s0">t</span><span class="s2">) * </span><span class="s0">math</span><span class="s2">.</span><span class="s0">pi</span><span class="s2">)</span>
        <span class="s0">endScale </span><span class="s2">= </span><span class="s0">math</span><span class="s2">.</span><span class="s0">sin</span><span class="s2">(</span><span class="s0">t </span><span class="s2">* </span><span class="s0">math</span><span class="s2">.</span><span class="s0">pi</span><span class="s2">)</span>
        <span class="s0">destQuat</span><span class="s2">.</span><span class="s0">setI</span><span class="s2">(</span><span class="s0">startScale </span><span class="s2">* </span><span class="s0">startQ</span><span class="s2">.</span><span class="s0">getI</span><span class="s2">() +</span>
                      <span class="s0">endScale </span><span class="s2">* </span><span class="s0">endQuat</span><span class="s2">.</span><span class="s0">getI</span><span class="s2">())</span>
        <span class="s0">destQuat</span><span class="s2">.</span><span class="s0">setJ</span><span class="s2">(</span><span class="s0">startScale </span><span class="s2">* </span><span class="s0">startQ</span><span class="s2">.</span><span class="s0">getJ</span><span class="s2">() +</span>
                      <span class="s0">endScale </span><span class="s2">* </span><span class="s0">endQuat</span><span class="s2">.</span><span class="s0">getJ</span><span class="s2">())</span>
        <span class="s0">destQuat</span><span class="s2">.</span><span class="s0">setK</span><span class="s2">(</span><span class="s0">startScale </span><span class="s2">* </span><span class="s0">startQ</span><span class="s2">.</span><span class="s0">getK</span><span class="s2">() +</span>
                      <span class="s0">endScale </span><span class="s2">* </span><span class="s0">endQuat</span><span class="s2">.</span><span class="s0">getK</span><span class="s2">())</span>
    <span class="s1">return </span><span class="s0">destQuat</span>

</pre>
</body>
</html>