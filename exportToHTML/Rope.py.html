<html>
<head>
<title>Rope.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Rope.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s0">import </span><span class="s2">*</span>


<span class="s0">class </span><span class="s1">Rope</span><span class="s2">(</span><span class="s1">NodePath</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    This class defines a NURBS curve whose control vertices are 
    defined based on points relative to one or more nodes in space, so 
    that the &quot;rope&quot; will animate as the nodes move around.  It uses 
    the C++ RopeNode class to achieve fancy rendering effects like 
    thick lines built from triangle strips. 
    &quot;&quot;&quot;</span>

    <span class="s1">showRope </span><span class="s2">= </span><span class="s1">ConfigVariableBool</span><span class="s2">(</span><span class="s4">'show-rope'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">\</span>
      <span class="s4">&quot;Set this to false to deactivate the display of ropes.&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name </span><span class="s2">= </span><span class="s4">'Rope'</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ropeNode </span><span class="s2">= </span><span class="s1">RopeNode</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">curve </span><span class="s2">= </span><span class="s1">NurbsCurveEvaluator</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ropeNode</span><span class="s2">.</span><span class="s1">setCurve</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">curve</span><span class="s2">)</span>
        <span class="s1">NodePath</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ropeNode</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">order </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">verts </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">knots </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">setup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">order</span><span class="s2">, </span><span class="s1">verts</span><span class="s2">, </span><span class="s1">knots </span><span class="s2">= </span><span class="s0">None</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;This must be called to define the shape of the curve 
        initially, and may be called again as needed to adjust the 
        curve's properties. 
 
        order must be either 1, 2, 3, or 4, and is one more than the 
        degree of the curve; most NURBS curves are order 4. 
 
        verts is a list of (NodePath, point) tuples, defining the 
        control vertices of the curve.  For each control vertex, the 
        NodePath may refer to an arbitrary node in the scene graph, 
        indicating the point should be interpreted in the coordinate 
        space of that node (and it will automatically move when the 
        node is moved), or it may be the empty NodePath or None to 
        indicate the point should be interpreted in the coordinate 
        space of the Rope itself.  Each point value may be either a 
        3-tuple or a 4-tuple (or a VBase3 or VBase4).  If it is a 
        3-component vector, it represents a 3-d point in space; a 
        4-component vector represents a point in 4-d homogeneous 
        space; that is to say, a 3-d point and an additional weight 
        factor (which should have been multiplied into the x y z 
        components). 
 
        verts may be a list of dictionaries instead of a list of 
        tuples.  In this case, each vertex dictionary may have any of 
        the following elements: 
 
          'node' : the NodePath indicating the coordinate space 
          'point' : the 3-D point relative to the node; default (0, 0, 0) 
          'color' : the color of the vertex, default (1, 1, 1, 1) 
          'thickness' : the thickness at the vertex, default 1 
 
        In order to enable the per-vertex color or thickness, you must 
        call rope.ropeNode.setUseVertexColor(1) or 
        rope.ropeNode.setUseVertexThickness(1). 
 
        knots is optional.  If specified, it should be a list of 
        floats, and should be of length len(verts) + order.  If it 
        is omitted, a default knot string is generated that consists 
        of the first (order - 1) and last (order - 1) values the 
        same, and the intermediate values incrementing by 1. 
        &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">order </span><span class="s2">= </span><span class="s1">order</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">verts </span><span class="s2">= </span><span class="s1">verts</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">knots </span><span class="s2">= </span><span class="s1">knots</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">recompute</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">recompute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Recomputes the curve after its properties have changed. 
        Normally it is not necessary for the user to call this 
        directly.&quot;&quot;&quot;</span>

        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">showRope</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s1">numVerts </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">verts</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">curve</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">(</span><span class="s1">numVerts</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">curve</span><span class="s2">.</span><span class="s1">setOrder</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">order</span><span class="s2">)</span>

        <span class="s1">defaultNodePath </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">defaultPoint </span><span class="s2">= (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">defaultColor </span><span class="s2">= (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">defaultThickness </span><span class="s2">= </span><span class="s5">1</span>

        <span class="s1">useVertexColor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ropeNode</span><span class="s2">.</span><span class="s1">getUseVertexColor</span><span class="s2">()</span>
        <span class="s1">useVertexThickness </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ropeNode</span><span class="s2">.</span><span class="s1">getUseVertexThickness</span><span class="s2">()</span>

        <span class="s1">vcd </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ropeNode</span><span class="s2">.</span><span class="s1">getVertexColorDimension</span><span class="s2">()</span>
        <span class="s1">vtd </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ropeNode</span><span class="s2">.</span><span class="s1">getVertexThicknessDimension</span><span class="s2">()</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">numVerts</span><span class="s2">):</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verts</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
                <span class="s1">nodePath</span><span class="s2">, </span><span class="s1">point </span><span class="s2">= </span><span class="s1">v</span>
                <span class="s1">color </span><span class="s2">= </span><span class="s1">defaultColor</span>
                <span class="s1">thickness </span><span class="s2">= </span><span class="s1">defaultThickness</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">nodePath </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">'node'</span><span class="s2">, </span><span class="s1">defaultNodePath</span><span class="s2">)</span>
                <span class="s1">point </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">'point'</span><span class="s2">, </span><span class="s1">defaultPoint</span><span class="s2">)</span>
                <span class="s1">color </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">'color'</span><span class="s2">, </span><span class="s1">defaultColor</span><span class="s2">)</span>
                <span class="s1">thickness </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">'thickness'</span><span class="s2">, </span><span class="s1">defaultThickness</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">point</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">point</span><span class="s2">) &gt;= </span><span class="s5">4</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">curve</span><span class="s2">.</span><span class="s1">setVertex</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">VBase4</span><span class="s2">(</span><span class="s1">point</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">point</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">point</span><span class="s2">[</span><span class="s5">2</span><span class="s2">], </span><span class="s1">point</span><span class="s2">[</span><span class="s5">3</span><span class="s2">]))</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">curve</span><span class="s2">.</span><span class="s1">setVertex</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">VBase3</span><span class="s2">(</span><span class="s1">point</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">point</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">point</span><span class="s2">[</span><span class="s5">2</span><span class="s2">]))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">curve</span><span class="s2">.</span><span class="s1">setVertex</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">point</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">nodePath</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">curve</span><span class="s2">.</span><span class="s1">setVertexSpace</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">nodePath</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">useVertexColor</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">curve</span><span class="s2">.</span><span class="s1">setExtendedVertex</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">vcd </span><span class="s2">+ </span><span class="s5">0</span><span class="s2">, </span><span class="s1">color</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">curve</span><span class="s2">.</span><span class="s1">setExtendedVertex</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">vcd </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">, </span><span class="s1">color</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">curve</span><span class="s2">.</span><span class="s1">setExtendedVertex</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">vcd </span><span class="s2">+ </span><span class="s5">2</span><span class="s2">, </span><span class="s1">color</span><span class="s2">[</span><span class="s5">2</span><span class="s2">])</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">curve</span><span class="s2">.</span><span class="s1">setExtendedVertex</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">vcd </span><span class="s2">+ </span><span class="s5">3</span><span class="s2">, </span><span class="s1">color</span><span class="s2">[</span><span class="s5">3</span><span class="s2">])</span>
            <span class="s0">if </span><span class="s1">useVertexThickness</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">curve</span><span class="s2">.</span><span class="s1">setExtendedVertex</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">vtd</span><span class="s2">, </span><span class="s1">thickness</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">knots </span><span class="s2">!= </span><span class="s0">None</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">knots</span><span class="s2">)):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">curve</span><span class="s2">.</span><span class="s1">setKnot</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">knots</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">ropeNode</span><span class="s2">.</span><span class="s1">resetBound</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getPoints</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">len</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Returns a list of len points, evenly distributed in 
        parametric space on the rope, in the coordinate space of the 
        Rope itself.&quot;&quot;&quot;</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">curve</span><span class="s2">.</span><span class="s1">evaluate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">startT </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">getStartT</span><span class="s2">()</span>
        <span class="s1">sizeT </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">getEndT</span><span class="s2">() - </span><span class="s1">startT</span>

        <span class="s1">numPts </span><span class="s2">= </span><span class="s1">len</span>
        <span class="s1">ropePts </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">numPts</span><span class="s2">):</span>
            <span class="s1">pt </span><span class="s2">= </span><span class="s1">Point3</span><span class="s2">()</span>
            <span class="s1">result</span><span class="s2">.</span><span class="s1">evalPoint</span><span class="s2">(</span><span class="s1">sizeT </span><span class="s2">* </span><span class="s1">i </span><span class="s2">/ </span><span class="s1">float</span><span class="s2">(</span><span class="s1">numPts </span><span class="s2">- </span><span class="s5">1</span><span class="s2">) + </span><span class="s1">startT</span><span class="s2">, </span><span class="s1">pt</span><span class="s2">)</span>
            <span class="s1">ropePts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">pt</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ropePts</span>
</pre>
</body>
</html>