<html>
<head>
<title>GridParent.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #bcbec4;}
.s1 { color: #cf8e6d;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
GridParent.py</font>
</center></td></tr></table>
<pre>
<span class="s1">from </span><span class="s0">panda3d</span><span class="s2">.</span><span class="s0">core </span><span class="s1">import </span><span class="s2">*</span>
<span class="s1">from </span><span class="s0">panda3d</span><span class="s2">.</span><span class="s0">direct </span><span class="s1">import </span><span class="s2">*</span>

<span class="s3">#</span>
<span class="s3"># GridParent.py</span>
<span class="s3"># Any object that can be parented to the ocean grid</span>
<span class="s3"># (or any grid whose size is too large to represent in 16 bits),</span>
<span class="s3"># should derive from GridParent.  Can be used on client and AI code.</span>

<span class="s3"># GridParent will put a node inbetween the object and the grid so</span>
<span class="s3"># that the object is broadcasting its position relative to the gridCell</span>
<span class="s3"># it lies in.</span>

<span class="s1">class </span><span class="s0">GridParent</span><span class="s2">:</span>

    <span class="s3"># this lets GridParents share CellOrigins</span>
    <span class="s0">GridZone2CellOrigin </span><span class="s2">= {}</span>
    <span class="s0">GridZone2count </span><span class="s2">= {}</span>
    <span class="s2">@</span><span class="s0">staticmethod</span>
    <span class="s1">def </span><span class="s0">getCellOrigin</span><span class="s2">(</span><span class="s0">grid</span><span class="s2">, </span><span class="s0">zoneId</span><span class="s2">):</span>
        <span class="s0">tup </span><span class="s2">= (</span><span class="s0">grid</span><span class="s2">, </span><span class="s0">zoneId</span><span class="s2">)</span>
        <span class="s1">if </span><span class="s0">tup </span><span class="s1">not in </span><span class="s0">GridParent</span><span class="s2">.</span><span class="s0">GridZone2count</span><span class="s2">:</span>
            <span class="s0">GridParent</span><span class="s2">.</span><span class="s0">GridZone2count</span><span class="s2">[</span><span class="s0">tup</span><span class="s2">] = </span><span class="s4">0</span>
            <span class="s3"># For readability when debugging, append the zone to the name</span>
            <span class="s0">GridParent</span><span class="s2">.</span><span class="s0">GridZone2CellOrigin</span><span class="s2">[</span><span class="s0">tup</span><span class="s2">] = </span><span class="s0">grid</span><span class="s2">.</span><span class="s0">attachNewNode</span><span class="s2">(</span><span class="s5">&quot;cellOrigin-%s&quot; </span><span class="s2">% </span><span class="s0">zoneId</span><span class="s2">)</span>
            <span class="s3"># Get grid cell origin</span>
            <span class="s0">cellPos </span><span class="s2">= </span><span class="s0">grid</span><span class="s2">.</span><span class="s0">getZoneCellOrigin</span><span class="s2">(</span><span class="s0">zoneId</span><span class="s2">)</span>
            <span class="s3"># Set the gridNode's position</span>
            <span class="s0">GridParent</span><span class="s2">.</span><span class="s0">GridZone2CellOrigin</span><span class="s2">[</span><span class="s0">tup</span><span class="s2">].</span><span class="s0">setPos</span><span class="s2">(*</span><span class="s0">cellPos</span><span class="s2">)</span>
        <span class="s0">GridParent</span><span class="s2">.</span><span class="s0">GridZone2count</span><span class="s2">[</span><span class="s0">tup</span><span class="s2">] += </span><span class="s4">1</span>
        <span class="s1">return </span><span class="s0">GridParent</span><span class="s2">.</span><span class="s0">GridZone2CellOrigin</span><span class="s2">[</span><span class="s0">tup</span><span class="s2">]</span>
    <span class="s2">@</span><span class="s0">staticmethod</span>
    <span class="s1">def </span><span class="s0">releaseCellOrigin</span><span class="s2">(</span><span class="s0">grid</span><span class="s2">, </span><span class="s0">zoneId</span><span class="s2">):</span>
        <span class="s0">tup </span><span class="s2">= (</span><span class="s0">grid</span><span class="s2">, </span><span class="s0">zoneId</span><span class="s2">)</span>
        <span class="s0">GridParent</span><span class="s2">.</span><span class="s0">GridZone2count</span><span class="s2">[</span><span class="s0">tup</span><span class="s2">] -= </span><span class="s4">1</span>
        <span class="s1">if </span><span class="s0">GridParent</span><span class="s2">.</span><span class="s0">GridZone2count</span><span class="s2">[</span><span class="s0">tup</span><span class="s2">] == </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s1">del </span><span class="s0">GridParent</span><span class="s2">.</span><span class="s0">GridZone2count</span><span class="s2">[</span><span class="s0">tup</span><span class="s2">]</span>
            <span class="s0">GridParent</span><span class="s2">.</span><span class="s0">GridZone2CellOrigin</span><span class="s2">[</span><span class="s0">tup</span><span class="s2">].</span><span class="s0">removeNode</span><span class="s2">()</span>
            <span class="s1">del </span><span class="s0">GridParent</span><span class="s2">.</span><span class="s0">GridZone2CellOrigin</span><span class="s2">[</span><span class="s0">tup</span><span class="s2">]</span>

    <span class="s1">def </span><span class="s0">__init__</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">av</span><span class="s2">):</span>
        <span class="s3"># The object on the grid will need to broadcast his position relative to</span>
        <span class="s3"># his current grid cell in order to use 16 bit</span>
        <span class="s3"># telemetry.  To do this, we will have a node attached to the</span>
        <span class="s3"># grid cell origin, and the object will wrtReparent himself to it when</span>
        <span class="s3"># crossing into that grid cell.  We don't need to create a node for each</span>
        <span class="s3"># cell origin.  We just need two nodes:  one that we are currently parented</span>
        <span class="s3"># to, and the other that we will wrtReparentTo.  Just before wrtReparenting</span>
        <span class="s3"># to the new node, set it's position to the new grid cell origin.</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">av </span><span class="s2">= </span><span class="s0">av</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">grid </span><span class="s2">= </span><span class="s1">None</span>
        <span class="s3"># NOTE: this node gets renamed when it is put on a zone, so if you</span>
        <span class="s3"># are looking for it by name, try cellOrigin*.</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">ownCellOrigin </span><span class="s2">= </span><span class="s0">NodePath</span><span class="s2">(</span><span class="s5">&quot;cellOrigin&quot;</span><span class="s2">)</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">cellOrigin </span><span class="s2">= </span><span class="s0">self</span><span class="s2">.</span><span class="s0">ownCellOrigin</span>

    <span class="s1">def </span><span class="s0">delete</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">av</span><span class="s2">:</span>
            <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">av</span><span class="s2">.</span><span class="s0">getParent</span><span class="s2">() == </span><span class="s0">self</span><span class="s2">.</span><span class="s0">cellOrigin</span><span class="s2">:</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">av</span><span class="s2">.</span><span class="s0">detachNode</span><span class="s2">()</span>
            <span class="s1">del </span><span class="s0">self</span><span class="s2">.</span><span class="s0">av</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">av </span><span class="s2">= </span><span class="s1">None</span>
        <span class="s3"># Remove the gridNodes</span>
        <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">ownCellOrigin </span><span class="s1">is not None</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">ownCellOrigin</span><span class="s2">.</span><span class="s0">removeNode</span><span class="s2">()</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">ownCellOrigin </span><span class="s2">= </span><span class="s1">None</span>
        <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">grid </span><span class="s1">is not None</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">releaseCellOrigin</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">grid</span><span class="s2">, </span><span class="s0">self</span><span class="s2">.</span><span class="s0">zoneId</span><span class="s2">)</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">grid </span><span class="s2">= </span><span class="s1">None</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">zoneId </span><span class="s2">= </span><span class="s1">None</span>

    <span class="s1">def </span><span class="s0">setGridParent</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">grid</span><span class="s2">, </span><span class="s0">zoneId</span><span class="s2">, </span><span class="s0">teleport</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
        <span class="s3"># If teleport=0, preserve the avatar's absolute position.  If teleport=1</span>
        <span class="s3"># the avatars previous world position is invalid, so don't wrtReparent,</span>
        <span class="s3"># just do a regular reparent, and let the cellOrigin give us our new position</span>

        <span class="s3"># Also, if the avatar has no parent, then force teleport=1</span>
        <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">av</span><span class="s2">.</span><span class="s0">getParent</span><span class="s2">().</span><span class="s0">isEmpty</span><span class="s2">():</span>
            <span class="s0">teleport </span><span class="s2">= </span><span class="s4">1</span>

        <span class="s1">if not </span><span class="s0">teleport</span><span class="s2">:</span>
            <span class="s3"># Stick the avatar under hidden while we move the cellOrigin into</span>
            <span class="s3"># position so we do not lose the avatars absolute position.</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">av</span><span class="s2">.</span><span class="s0">wrtReparentTo</span><span class="s2">(</span><span class="s0">hidden</span><span class="s2">)</span>

        <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">grid </span><span class="s1">is not None</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">releaseCellOrigin</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">grid</span><span class="s2">, </span><span class="s0">self</span><span class="s2">.</span><span class="s0">zoneId</span><span class="s2">)</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">grid </span><span class="s2">= </span><span class="s0">grid</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">zoneId </span><span class="s2">= </span><span class="s0">zoneId</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">cellOrigin </span><span class="s2">= </span><span class="s0">self</span><span class="s2">.</span><span class="s0">getCellOrigin</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">grid</span><span class="s2">, </span><span class="s0">self</span><span class="s2">.</span><span class="s0">zoneId</span><span class="s2">)</span>

        <span class="s3"># Reparent our avatar to this node</span>
        <span class="s1">if not </span><span class="s0">teleport</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">av</span><span class="s2">.</span><span class="s0">wrtReparentTo</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">cellOrigin</span><span class="s2">)</span>
        <span class="s1">else</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">av</span><span class="s2">.</span><span class="s0">reparentTo</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">cellOrigin</span><span class="s2">)</span>

        <span class="s3">#print &quot;gridParent: reparent to %s&quot; % self.av</span>
        <span class="s3">#print &quot;gridParent: pos = %s, %s&quot; % (self.av.getPos(), self.av.getParent().getPos())</span>


</pre>
</body>
</html>