<html>
<head>
<title>BattleWalker.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #bcbec4;}
.s1 { color: #cf8e6d;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #7a7e85;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
BattleWalker.py</font>
</center></td></tr></table>
<pre>
<span class="s1">from </span><span class="s0">direct</span><span class="s2">.</span><span class="s0">showbase</span><span class="s2">.</span><span class="s0">InputStateGlobal </span><span class="s1">import </span><span class="s0">inputState</span>
<span class="s1">from </span><span class="s0">direct</span><span class="s2">.</span><span class="s0">task</span><span class="s2">.</span><span class="s0">Task </span><span class="s1">import </span><span class="s0">Task</span>
<span class="s1">from </span><span class="s0">panda3d</span><span class="s2">.</span><span class="s0">core </span><span class="s1">import </span><span class="s2">*</span>
<span class="s1">from </span><span class="s2">. </span><span class="s1">import </span><span class="s0">GravityWalker</span>

<span class="s0">BattleStrafe </span><span class="s2">= </span><span class="s3">0</span>

<span class="s1">def </span><span class="s0">ToggleStrafe</span><span class="s2">():</span>
    <span class="s1">global </span><span class="s0">BattleStrafe</span>
    <span class="s0">BattleStrafe </span><span class="s2">= </span><span class="s1">not </span><span class="s0">BattleStrafe</span>

<span class="s1">def </span><span class="s0">SetStrafe</span><span class="s2">(</span><span class="s0">status</span><span class="s2">):</span>
    <span class="s1">global </span><span class="s0">BattleStrafe</span>
    <span class="s0">BattleStrafe </span><span class="s2">= </span><span class="s0">status</span>

<span class="s1">class </span><span class="s0">BattleWalker</span><span class="s2">(</span><span class="s0">GravityWalker</span><span class="s2">.</span><span class="s0">GravityWalker</span><span class="s2">):</span>
    <span class="s1">def </span><span class="s0">__init__</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s0">GravityWalker</span><span class="s2">.</span><span class="s0">GravityWalker</span><span class="s2">.</span><span class="s0">__init__</span><span class="s2">(</span><span class="s0">self</span><span class="s2">)</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">slideSpeed </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">advanceSpeed </span><span class="s2">= </span><span class="s3">0</span>

    <span class="s1">def </span><span class="s0">getSpeeds</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s1">return </span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">speed</span><span class="s2">, </span><span class="s0">self</span><span class="s2">.</span><span class="s0">rotationSpeed</span><span class="s2">, </span><span class="s0">self</span><span class="s2">.</span><span class="s0">slideSpeed</span><span class="s2">, </span><span class="s0">self</span><span class="s2">.</span><span class="s0">advanceSpeed</span><span class="s2">)</span>

    <span class="s1">def </span><span class="s0">handleAvatarControls</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">task</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Check on the arrow keys and update the avatar. 
        &quot;&quot;&quot;</span>
        <span class="s5"># get the button states:</span>
        <span class="s0">run </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;run&quot;</span><span class="s2">)</span>
        <span class="s0">forward </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;forward&quot;</span><span class="s2">)</span>
        <span class="s0">reverse </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;reverse&quot;</span><span class="s2">)</span>
        <span class="s0">turnLeft </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;turnLeft&quot;</span><span class="s2">)</span>
        <span class="s0">turnRight </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;turnRight&quot;</span><span class="s2">)</span>
        <span class="s0">slideLeft </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;slideLeft&quot;</span><span class="s2">)</span>
        <span class="s0">slideRight </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;slideRight&quot;</span><span class="s2">)</span>
        <span class="s0">jump </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;jump&quot;</span><span class="s2">)</span>

        <span class="s5"># Check for Auto-Run</span>
        <span class="s1">if </span><span class="s0">base</span><span class="s2">.</span><span class="s0">localAvatar</span><span class="s2">.</span><span class="s0">getAutoRun</span><span class="s2">():</span>
            <span class="s0">forward </span><span class="s2">= </span><span class="s3">1</span>
            <span class="s0">reverse </span><span class="s2">= </span><span class="s3">0</span>

        <span class="s5"># Determine what the speeds are based on the buttons:</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">speed</span><span class="s2">=(</span><span class="s0">forward </span><span class="s1">and </span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarControlForwardSpeed </span><span class="s1">or</span>
                    <span class="s0">reverse </span><span class="s1">and </span><span class="s2">-</span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarControlReverseSpeed</span><span class="s2">)</span>
        <span class="s5"># Slide speed is a scaled down version of forward speed</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">slideSpeed</span><span class="s2">=(</span><span class="s0">slideLeft </span><span class="s1">and </span><span class="s2">-</span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarControlForwardSpeed </span><span class="s1">or</span>
                         <span class="s0">slideRight </span><span class="s1">and </span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarControlForwardSpeed</span><span class="s2">) * </span><span class="s3">0.5</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">rotationSpeed</span><span class="s2">=</span><span class="s1">not </span><span class="s2">(</span><span class="s0">slideLeft </span><span class="s1">or </span><span class="s0">slideRight</span><span class="s2">) </span><span class="s1">and </span><span class="s2">(</span>
                <span class="s2">(</span><span class="s0">turnLeft </span><span class="s1">and </span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarControlRotateSpeed</span><span class="s2">) </span><span class="s1">or</span>
                <span class="s2">(</span><span class="s0">turnRight </span><span class="s1">and </span><span class="s2">-</span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarControlRotateSpeed</span><span class="s2">))</span>

        <span class="s0">debugRunning </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;debugRunning&quot;</span><span class="s2">)</span>

        <span class="s1">if</span><span class="s2">(</span><span class="s0">debugRunning</span><span class="s2">):</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">speed</span><span class="s2">*=</span><span class="s0">base</span><span class="s2">.</span><span class="s0">debugRunningMultiplier</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">slideSpeed</span><span class="s2">*=</span><span class="s0">base</span><span class="s2">.</span><span class="s0">debugRunningMultiplier</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">rotationSpeed</span><span class="s2">*=</span><span class="s3">1.25</span>

        <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">needToDeltaPos</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">setPriorParentVector</span><span class="s2">()</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">needToDeltaPos </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">wantDebugIndicator</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">displayDebugInfo</span><span class="s2">()</span>
        <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">lifter</span><span class="s2">.</span><span class="s0">isOnGround</span><span class="s2">():</span>
            <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">isAirborne</span><span class="s2">:</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">isAirborne </span><span class="s2">= </span><span class="s3">0</span>
                <span class="s1">assert </span><span class="s0">self</span><span class="s2">.</span><span class="s0">debugPrint</span><span class="s2">(</span><span class="s6">&quot;isAirborne 0 due to isOnGround() true&quot;</span><span class="s2">)</span>
                <span class="s0">impact </span><span class="s2">= </span><span class="s0">self</span><span class="s2">.</span><span class="s0">lifter</span><span class="s2">.</span><span class="s0">getImpactVelocity</span><span class="s2">()</span>
                <span class="s1">if </span><span class="s0">impact </span><span class="s2">&lt; -</span><span class="s3">30.0</span><span class="s2">:</span>
                    <span class="s0">messenger</span><span class="s2">.</span><span class="s0">send</span><span class="s2">(</span><span class="s6">&quot;jumpHardLand&quot;</span><span class="s2">)</span>
                    <span class="s0">self</span><span class="s2">.</span><span class="s0">startJumpDelay</span><span class="s2">(</span><span class="s3">0.3</span><span class="s2">)</span>
                <span class="s1">else</span><span class="s2">:</span>
                    <span class="s0">messenger</span><span class="s2">.</span><span class="s0">send</span><span class="s2">(</span><span class="s6">&quot;jumpLand&quot;</span><span class="s2">)</span>
                    <span class="s1">if </span><span class="s0">impact </span><span class="s2">&lt; -</span><span class="s3">5.0</span><span class="s2">:</span>
                        <span class="s0">self</span><span class="s2">.</span><span class="s0">startJumpDelay</span><span class="s2">(</span><span class="s3">0.2</span><span class="s2">)</span>
                    <span class="s5"># else, ignore the little potholes.</span>
            <span class="s1">assert </span><span class="s0">self</span><span class="s2">.</span><span class="s0">isAirborne </span><span class="s2">== </span><span class="s3">0</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">priorParent </span><span class="s2">= </span><span class="s0">Vec3</span><span class="s2">.</span><span class="s0">zero</span><span class="s2">()</span>
            <span class="s1">if </span><span class="s0">jump </span><span class="s1">and </span><span class="s0">self</span><span class="s2">.</span><span class="s0">mayJump</span><span class="s2">:</span>
                <span class="s5"># The jump button is down and we're close</span>
                <span class="s5"># enough to the ground to jump.</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">lifter</span><span class="s2">.</span><span class="s0">addVelocity</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarControlJumpForce</span><span class="s2">)</span>
                <span class="s0">messenger</span><span class="s2">.</span><span class="s0">send</span><span class="s2">(</span><span class="s6">&quot;jumpStart&quot;</span><span class="s2">)</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">isAirborne </span><span class="s2">= </span><span class="s3">1</span>
                <span class="s1">assert </span><span class="s0">self</span><span class="s2">.</span><span class="s0">debugPrint</span><span class="s2">(</span><span class="s6">&quot;isAirborne 1 due to jump&quot;</span><span class="s2">)</span>
        <span class="s1">else</span><span class="s2">:</span>
            <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">isAirborne </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">assert </span><span class="s0">self</span><span class="s2">.</span><span class="s0">debugPrint</span><span class="s2">(</span><span class="s6">&quot;isAirborne 1 due to isOnGround() false&quot;</span><span class="s2">)</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">isAirborne </span><span class="s2">= </span><span class="s3">1</span>

        <span class="s0">self</span><span class="s2">.</span><span class="s0">__oldPosDelta </span><span class="s2">= </span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">getPosDelta</span><span class="s2">(</span><span class="s0">render</span><span class="s2">)</span>
        <span class="s5"># How far did we move based on the amount of time elapsed?</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">__oldDt </span><span class="s2">= </span><span class="s0">ClockObject</span><span class="s2">.</span><span class="s0">getGlobalClock</span><span class="s2">().</span><span class="s0">getDt</span><span class="s2">()</span>
        <span class="s0">dt</span><span class="s2">=</span><span class="s0">self</span><span class="s2">.</span><span class="s0">__oldDt</span>

        <span class="s5"># Check to see if we're moving at all:</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">moving </span><span class="s2">= </span><span class="s0">self</span><span class="s2">.</span><span class="s0">speed </span><span class="s1">or </span><span class="s0">self</span><span class="s2">.</span><span class="s0">slideSpeed </span><span class="s1">or </span><span class="s0">self</span><span class="s2">.</span><span class="s0">rotationSpeed </span><span class="s1">or </span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">priorParent</span><span class="s2">!=</span><span class="s0">Vec3</span><span class="s2">.</span><span class="s0">zero</span><span class="s2">())</span>
        <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">moving</span><span class="s2">:</span>
            <span class="s0">distance </span><span class="s2">= </span><span class="s0">dt </span><span class="s2">* </span><span class="s0">self</span><span class="s2">.</span><span class="s0">speed</span>
            <span class="s0">slideDistance </span><span class="s2">= </span><span class="s0">dt </span><span class="s2">* </span><span class="s0">self</span><span class="s2">.</span><span class="s0">slideSpeed</span>
            <span class="s0">rotation </span><span class="s2">= </span><span class="s0">dt </span><span class="s2">* </span><span class="s0">self</span><span class="s2">.</span><span class="s0">rotationSpeed</span>

            <span class="s5"># Take a step in the direction of our previous heading.</span>
            <span class="s1">if </span><span class="s0">distance </span><span class="s1">or </span><span class="s0">slideDistance </span><span class="s1">or </span><span class="s0">self</span><span class="s2">.</span><span class="s0">priorParent </span><span class="s2">!= </span><span class="s0">Vec3</span><span class="s2">.</span><span class="s0">zero</span><span class="s2">():</span>
                <span class="s5"># rotMat is the rotation matrix corresponding to</span>
                <span class="s5"># our previous heading.</span>
                <span class="s0">rotMat</span><span class="s2">=</span><span class="s0">Mat3</span><span class="s2">.</span><span class="s0">rotateMatNormaxis</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">getH</span><span class="s2">(), </span><span class="s0">Vec3</span><span class="s2">.</span><span class="s0">up</span><span class="s2">())</span>
                <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">isAirborne</span><span class="s2">:</span>
                    <span class="s0">forward </span><span class="s2">= </span><span class="s0">Vec3</span><span class="s2">.</span><span class="s0">forward</span><span class="s2">()</span>
                <span class="s1">else</span><span class="s2">:</span>
                    <span class="s0">contact </span><span class="s2">= </span><span class="s0">self</span><span class="s2">.</span><span class="s0">lifter</span><span class="s2">.</span><span class="s0">getContactNormal</span><span class="s2">()</span>
                    <span class="s0">forward </span><span class="s2">= </span><span class="s0">contact</span><span class="s2">.</span><span class="s0">cross</span><span class="s2">(</span><span class="s0">Vec3</span><span class="s2">.</span><span class="s0">right</span><span class="s2">())</span>
                    <span class="s5"># Consider commenting out this normalize.  If you do so</span>
                    <span class="s5"># then going up and down slops is a touch slower and</span>
                    <span class="s5"># steeper terrain can cut the movement in half.  Without</span>
                    <span class="s5"># the normalize the movement is slowed by the cosine of</span>
                    <span class="s5"># the slope (i.e. it is multiplied by the sign as a</span>
                    <span class="s5"># side effect of the cross product above).</span>
                    <span class="s0">forward</span><span class="s2">.</span><span class="s0">normalize</span><span class="s2">()</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">vel</span><span class="s2">=</span><span class="s0">Vec3</span><span class="s2">(</span><span class="s0">forward </span><span class="s2">* </span><span class="s0">distance</span><span class="s2">)</span>
                <span class="s1">if </span><span class="s0">slideDistance</span><span class="s2">:</span>
                    <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">isAirborne</span><span class="s2">:</span>
                        <span class="s0">right </span><span class="s2">= </span><span class="s0">Vec3</span><span class="s2">.</span><span class="s0">right</span><span class="s2">()</span>
                    <span class="s1">else</span><span class="s2">:</span>
                        <span class="s0">right </span><span class="s2">= </span><span class="s0">forward</span><span class="s2">.</span><span class="s0">cross</span><span class="s2">(</span><span class="s0">contact</span><span class="s2">)</span>
                        <span class="s5"># See note above for forward.normalize()</span>
                        <span class="s0">right</span><span class="s2">.</span><span class="s0">normalize</span><span class="s2">()</span>
                    <span class="s0">self</span><span class="s2">.</span><span class="s0">vel</span><span class="s2">=</span><span class="s0">Vec3</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">vel </span><span class="s2">+ (</span><span class="s0">right </span><span class="s2">* </span><span class="s0">slideDistance</span><span class="s2">))</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">vel</span><span class="s2">=</span><span class="s0">Vec3</span><span class="s2">(</span><span class="s0">rotMat</span><span class="s2">.</span><span class="s0">xform</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">vel</span><span class="s2">))</span>
                <span class="s0">step</span><span class="s2">=</span><span class="s0">self</span><span class="s2">.</span><span class="s0">vel </span><span class="s2">+ (</span><span class="s0">self</span><span class="s2">.</span><span class="s0">priorParent </span><span class="s2">* </span><span class="s0">dt</span><span class="s2">)</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">setFluidPos</span><span class="s2">(</span><span class="s0">Point3</span><span class="s2">(</span>
                        <span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">getPos</span><span class="s2">()+</span><span class="s0">step</span><span class="s2">))</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">setH</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">getH</span><span class="s2">()+</span><span class="s0">rotation</span><span class="s2">)</span>
        <span class="s1">else</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">vel</span><span class="s2">.</span><span class="s0">set</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">)</span>
        <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">moving </span><span class="s1">or </span><span class="s0">jump</span><span class="s2">:</span>
            <span class="s0">messenger</span><span class="s2">.</span><span class="s0">send</span><span class="s2">(</span><span class="s6">&quot;avatarMoving&quot;</span><span class="s2">)</span>
        <span class="s1">return </span><span class="s0">Task</span><span class="s2">.</span><span class="s0">cont</span>

    <span class="s1">if </span><span class="s3">0</span><span class="s2">:</span>
        <span class="s1">def </span><span class="s0">handleAvatarControls</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">task</span><span class="s2">):</span>
            <span class="s5"># If targetNp is not available, revert back to GravityWalker.handleAvatarControls.</span>
            <span class="s5"># This situation occurs when the target dies, but we aren't switched out of</span>
            <span class="s5"># battle walker control mode.</span>

            <span class="s0">targetNp </span><span class="s2">= </span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">currentTarget</span>
            <span class="s1">if not </span><span class="s0">BattleStrafe </span><span class="s1">or </span><span class="s0">targetNp </span><span class="s2">== </span><span class="s1">None or </span><span class="s0">targetNp</span><span class="s2">.</span><span class="s0">isEmpty</span><span class="s2">():</span>
                <span class="s1">return </span><span class="s0">GravityWalker</span><span class="s2">.</span><span class="s0">GravityWalker</span><span class="s2">.</span><span class="s0">handleAvatarControls</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">task</span><span class="s2">)</span>

            <span class="s5"># get the button states:</span>
            <span class="s0">run </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;run&quot;</span><span class="s2">)</span>
            <span class="s0">forward </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;forward&quot;</span><span class="s2">)</span>
            <span class="s0">reverse </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;reverse&quot;</span><span class="s2">)</span>
            <span class="s0">turnLeft </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;turnLeft&quot;</span><span class="s2">)</span>
            <span class="s0">turnRight </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;turnRight&quot;</span><span class="s2">)</span>
            <span class="s0">slide </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;slide&quot;</span><span class="s2">)</span>
            <span class="s0">jump </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;jump&quot;</span><span class="s2">)</span>
            <span class="s5"># Determine what the speeds are based on the buttons:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">advanceSpeed</span><span class="s2">=(</span><span class="s0">forward </span><span class="s1">and </span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarControlForwardSpeed </span><span class="s1">or</span>
                               <span class="s0">reverse </span><span class="s1">and </span><span class="s2">-</span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarControlReverseSpeed</span><span class="s2">)</span>
            <span class="s1">if </span><span class="s0">run </span><span class="s1">and </span><span class="s0">self</span><span class="s2">.</span><span class="s0">advanceSpeed</span><span class="s2">&gt;</span><span class="s3">0.0</span><span class="s2">:</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">advanceSpeed</span><span class="s2">*=</span><span class="s3">2.0 </span><span class="s5">#*#</span>
            <span class="s5"># Should fSlide be renamed slideButton?</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">slideSpeed</span><span class="s2">=</span><span class="s3">.15</span><span class="s2">*(</span><span class="s0">turnLeft </span><span class="s1">and </span><span class="s2">-</span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarControlForwardSpeed </span><span class="s1">or</span>
                                 <span class="s0">turnRight </span><span class="s1">and </span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarControlForwardSpeed</span><span class="s2">)</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s6">'slideSpeed: %s' </span><span class="s2">% </span><span class="s0">self</span><span class="s2">.</span><span class="s0">slideSpeed</span><span class="s2">)</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">rotationSpeed</span><span class="s2">=</span><span class="s3">0</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">speed</span><span class="s2">=</span><span class="s3">0</span>

            <span class="s0">debugRunning </span><span class="s2">= </span><span class="s0">inputState</span><span class="s2">.</span><span class="s0">isSet</span><span class="s2">(</span><span class="s6">&quot;debugRunning&quot;</span><span class="s2">)</span>
            <span class="s1">if </span><span class="s0">debugRunning</span><span class="s2">:</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">advanceSpeed</span><span class="s2">*=</span><span class="s3">4.0</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">slideSpeed</span><span class="s2">*=</span><span class="s3">4.0</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">rotationSpeed</span><span class="s2">*=</span><span class="s3">1.25</span>

            <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">needToDeltaPos</span><span class="s2">:</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">setPriorParentVector</span><span class="s2">()</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">needToDeltaPos </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">wantDebugIndicator</span><span class="s2">:</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">displayDebugInfo</span><span class="s2">()</span>
            <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">lifter</span><span class="s2">.</span><span class="s0">isOnGround</span><span class="s2">():</span>
                <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">isAirborne</span><span class="s2">:</span>
                    <span class="s0">self</span><span class="s2">.</span><span class="s0">isAirborne </span><span class="s2">= </span><span class="s3">0</span>
                    <span class="s1">assert </span><span class="s0">self</span><span class="s2">.</span><span class="s0">debugPrint</span><span class="s2">(</span><span class="s6">&quot;isAirborne 0 due to isOnGround() true&quot;</span><span class="s2">)</span>
                    <span class="s0">impact </span><span class="s2">= </span><span class="s0">self</span><span class="s2">.</span><span class="s0">lifter</span><span class="s2">.</span><span class="s0">getImpactVelocity</span><span class="s2">()</span>
                    <span class="s1">if </span><span class="s0">impact </span><span class="s2">&lt; -</span><span class="s3">30.0</span><span class="s2">:</span>
                        <span class="s0">messenger</span><span class="s2">.</span><span class="s0">send</span><span class="s2">(</span><span class="s6">&quot;jumpHardLand&quot;</span><span class="s2">)</span>
                        <span class="s0">self</span><span class="s2">.</span><span class="s0">startJumpDelay</span><span class="s2">(</span><span class="s3">0.3</span><span class="s2">)</span>
                    <span class="s1">else</span><span class="s2">:</span>
                        <span class="s0">messenger</span><span class="s2">.</span><span class="s0">send</span><span class="s2">(</span><span class="s6">&quot;jumpLand&quot;</span><span class="s2">)</span>
                        <span class="s1">if </span><span class="s0">impact </span><span class="s2">&lt; -</span><span class="s3">5.0</span><span class="s2">:</span>
                            <span class="s0">self</span><span class="s2">.</span><span class="s0">startJumpDelay</span><span class="s2">(</span><span class="s3">0.2</span><span class="s2">)</span>
                        <span class="s5"># else, ignore the little potholes.</span>
                <span class="s1">assert </span><span class="s0">self</span><span class="s2">.</span><span class="s0">isAirborne </span><span class="s2">== </span><span class="s3">0</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">priorParent </span><span class="s2">= </span><span class="s0">Vec3</span><span class="s2">.</span><span class="s0">zero</span><span class="s2">()</span>
                <span class="s1">if </span><span class="s0">jump </span><span class="s1">and </span><span class="s0">self</span><span class="s2">.</span><span class="s0">mayJump</span><span class="s2">:</span>
                    <span class="s5"># The jump button is down and we're close</span>
                    <span class="s5"># enough to the ground to jump.</span>
                    <span class="s0">self</span><span class="s2">.</span><span class="s0">lifter</span><span class="s2">.</span><span class="s0">addVelocity</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarControlJumpForce</span><span class="s2">)</span>
                    <span class="s0">messenger</span><span class="s2">.</span><span class="s0">send</span><span class="s2">(</span><span class="s6">&quot;jumpStart&quot;</span><span class="s2">)</span>
                    <span class="s0">self</span><span class="s2">.</span><span class="s0">isAirborne </span><span class="s2">= </span><span class="s3">1</span>
                    <span class="s1">assert </span><span class="s0">self</span><span class="s2">.</span><span class="s0">debugPrint</span><span class="s2">(</span><span class="s6">&quot;isAirborne 1 due to jump&quot;</span><span class="s2">)</span>
            <span class="s1">else</span><span class="s2">:</span>
                <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">isAirborne </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                    <span class="s1">assert </span><span class="s0">self</span><span class="s2">.</span><span class="s0">debugPrint</span><span class="s2">(</span><span class="s6">&quot;isAirborne 1 due to isOnGround() false&quot;</span><span class="s2">)</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">isAirborne </span><span class="s2">= </span><span class="s3">1</span>

            <span class="s0">self</span><span class="s2">.</span><span class="s0">__oldPosDelta </span><span class="s2">= </span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">getPosDelta</span><span class="s2">(</span><span class="s0">render</span><span class="s2">)</span>
            <span class="s5"># How far did we move based on the amount of time elapsed?</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">__oldDt </span><span class="s2">= </span><span class="s0">ClockObject</span><span class="s2">.</span><span class="s0">getGlobalClock</span><span class="s2">().</span><span class="s0">getDt</span><span class="s2">()</span>
            <span class="s0">dt</span><span class="s2">=</span><span class="s0">self</span><span class="s2">.</span><span class="s0">__oldDt</span>

            <span class="s5"># Before we do anything with position or orientation, make the avatar</span>
            <span class="s5"># face it's target.  Only allow rMax degrees rotation per frame, so</span>
            <span class="s5"># we don't get an unnatural spinning effect</span>
            <span class="s0">curH </span><span class="s2">= </span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">getH</span><span class="s2">()</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">headsUp</span><span class="s2">(</span><span class="s0">targetNp</span><span class="s2">)</span>
            <span class="s0">newH </span><span class="s2">= </span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">getH</span><span class="s2">()</span>
            <span class="s0">delH </span><span class="s2">= </span><span class="s0">reduceAngle</span><span class="s2">(</span><span class="s0">newH</span><span class="s2">-</span><span class="s0">curH</span><span class="s2">)</span>
            <span class="s0">rMax </span><span class="s2">= </span><span class="s3">10</span>
            <span class="s1">if </span><span class="s0">delH </span><span class="s2">&lt; -</span><span class="s0">rMax</span><span class="s2">:</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">setH</span><span class="s2">(</span><span class="s0">curH</span><span class="s2">-</span><span class="s0">rMax</span><span class="s2">)</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">rotationSpeed</span><span class="s2">=-</span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarControlRotateSpeed</span>
            <span class="s1">elif </span><span class="s0">delH </span><span class="s2">&gt; </span><span class="s0">rMax</span><span class="s2">:</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">setH</span><span class="s2">(</span><span class="s0">curH</span><span class="s2">+</span><span class="s0">rMax</span><span class="s2">)</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">rotationSpeed</span><span class="s2">=</span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarControlRotateSpeed</span>

            <span class="s5"># Check to see if we're moving at all:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">moving </span><span class="s2">= </span><span class="s0">self</span><span class="s2">.</span><span class="s0">speed </span><span class="s1">or </span><span class="s0">self</span><span class="s2">.</span><span class="s0">slideSpeed </span><span class="s1">or </span><span class="s0">self</span><span class="s2">.</span><span class="s0">rotationSpeed </span><span class="s1">or </span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">priorParent</span><span class="s2">!=</span><span class="s0">Vec3</span><span class="s2">.</span><span class="s0">zero</span><span class="s2">())</span>
            <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">moving</span><span class="s2">:</span>
                <span class="s0">distance </span><span class="s2">= </span><span class="s0">dt </span><span class="s2">* </span><span class="s0">self</span><span class="s2">.</span><span class="s0">speed</span>
                <span class="s0">slideDistance </span><span class="s2">= </span><span class="s0">dt </span><span class="s2">* </span><span class="s0">self</span><span class="s2">.</span><span class="s0">slideSpeed</span>
                <span class="s0">print</span><span class="s2">(</span><span class="s6">'slideDistance: %s' </span><span class="s2">% </span><span class="s0">slideDistance</span><span class="s2">)</span>
                <span class="s0">rotation </span><span class="s2">= </span><span class="s0">dt </span><span class="s2">* </span><span class="s0">self</span><span class="s2">.</span><span class="s0">rotationSpeed</span>

                <span class="s5"># Take a step in the direction of our previous heading.</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">vel</span><span class="s2">=</span><span class="s0">Vec3</span><span class="s2">(</span><span class="s0">Vec3</span><span class="s2">.</span><span class="s0">forward</span><span class="s2">() * </span><span class="s0">distance </span><span class="s2">+</span>
                              <span class="s0">Vec3</span><span class="s2">.</span><span class="s0">right</span><span class="s2">() * </span><span class="s0">slideDistance</span><span class="s2">)</span>
                <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">vel </span><span class="s2">!= </span><span class="s0">Vec3</span><span class="s2">.</span><span class="s0">zero</span><span class="s2">() </span><span class="s1">or </span><span class="s0">self</span><span class="s2">.</span><span class="s0">priorParent </span><span class="s2">!= </span><span class="s0">Vec3</span><span class="s2">.</span><span class="s0">zero</span><span class="s2">():</span>
                    <span class="s1">if </span><span class="s3">1</span><span class="s2">:</span>
                        <span class="s5"># rotMat is the rotation matrix corresponding to</span>
                        <span class="s5"># our previous heading.</span>
                        <span class="s0">rotMat</span><span class="s2">=</span><span class="s0">Mat3</span><span class="s2">.</span><span class="s0">rotateMatNormaxis</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">getH</span><span class="s2">(), </span><span class="s0">Vec3</span><span class="s2">.</span><span class="s0">up</span><span class="s2">())</span>
                        <span class="s0">step</span><span class="s2">=(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">priorParent </span><span class="s2">* </span><span class="s0">dt</span><span class="s2">) + </span><span class="s0">rotMat</span><span class="s2">.</span><span class="s0">xform</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">vel</span><span class="s2">)</span>
                        <span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">setFluidPos</span><span class="s2">(</span><span class="s0">Point3</span><span class="s2">(</span>
                                <span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">getPos</span><span class="s2">()+</span><span class="s0">step</span><span class="s2">))</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">setH</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">avatarNodePath</span><span class="s2">.</span><span class="s0">getH</span><span class="s2">()+</span><span class="s0">rotation</span><span class="s2">)</span>
            <span class="s1">else</span><span class="s2">:</span>
                <span class="s0">self</span><span class="s2">.</span><span class="s0">vel</span><span class="s2">.</span><span class="s0">set</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">)</span>

            <span class="s6">&quot;&quot;&quot; 
            # Check to see if we're moving at all: 
            self.moving = self.advanceSpeed or self.slideSpeed or self.rotationSpeed or (self.priorParent!=Vec3.zero()) 
            if self.moving: 
                distance = dt * self.advanceSpeed 
                slideDistance = dt * self.slideSpeed 
                rotation = dt * self.rotationSpeed 
 
                # Prevent avatar from getting too close to target 
                d = self.avatarNodePath.getPos(targetNp) 
                # TODO:  make min distance adjust for current weapon 
                if (d[0]*d[0]+d[1]*d[1] &lt; 6.0 and distance &gt; 0): 
                    # move the avatar sideways instead of forward 
                    slideDistance += .2 
                    distance = 0 
 
                # Take a step in the direction of our previous heading. 
                self.vel=Vec3(Vec3.forward() * distance + 
                              Vec3.right() * slideDistance) 
                if self.vel != Vec3.zero() or self.priorParent != Vec3.zero(): 
                    # rotMat is the rotation matrix corresponding to 
                    # our previous heading. 
                    rotMat=Mat3.rotateMatNormaxis(self.avatarNodePath.getH(), Vec3.up()) 
                    step=rotMat.xform(self.vel) + (self.priorParent * dt) 
                    self.avatarNodePath.setFluidPos(Point3( 
                        self.avatarNodePath.getPos()+step)) 
                self.avatarNodePath.setH(self.avatarNodePath.getH()+rotation) 
            else: 
                self.vel.set(0.0, 0.0, 0.0) 
            &quot;&quot;&quot;</span>
            <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">moving </span><span class="s1">or </span><span class="s0">jump</span><span class="s2">:</span>
                <span class="s0">messenger</span><span class="s2">.</span><span class="s0">send</span><span class="s2">(</span><span class="s6">&quot;avatarMoving&quot;</span><span class="s2">)</span>
            <span class="s1">return </span><span class="s0">Task</span><span class="s2">.</span><span class="s0">cont</span>


</pre>
</body>
</html>