<html>
<head>
<title>ClusterClient.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ClusterClient.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;ClusterClient: Master for multi-piping or PC clusters.&quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s1">panda3d</span><span class="s3">.</span><span class="s1">core </span><span class="s2">import </span><span class="s3">*</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">ClusterMsgs </span><span class="s2">import </span><span class="s3">*</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">ClusterConfig </span><span class="s2">import </span><span class="s3">*</span>
<span class="s2">from </span><span class="s1">direct</span><span class="s3">.</span><span class="s1">directnotify </span><span class="s2">import </span><span class="s1">DirectNotifyGlobal</span>
<span class="s2">from </span><span class="s1">direct</span><span class="s3">.</span><span class="s1">showbase </span><span class="s2">import </span><span class="s1">DirectObject</span>
<span class="s2">from </span><span class="s1">direct</span><span class="s3">.</span><span class="s1">task </span><span class="s2">import </span><span class="s1">Task</span>
<span class="s2">import </span><span class="s1">os</span>


<span class="s2">class </span><span class="s1">ClusterClient</span><span class="s3">(</span><span class="s1">DirectObject</span><span class="s3">.</span><span class="s1">DirectObject</span><span class="s3">):</span>
    <span class="s1">notify </span><span class="s3">= </span><span class="s1">DirectNotifyGlobal</span><span class="s3">.</span><span class="s1">directNotify</span><span class="s3">.</span><span class="s1">newCategory</span><span class="s3">(</span><span class="s4">&quot;ClusterClient&quot;</span><span class="s3">)</span>
    <span class="s1">MGR_NUM </span><span class="s3">= </span><span class="s5">1000000</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">configList</span><span class="s3">, </span><span class="s1">clusterSyncFlag</span><span class="s3">):</span>
        <span class="s6"># Set name so cluster __call__ function can be used in Intervals</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">__name__ </span><span class="s3">= </span><span class="s4">'cluster'</span>
        <span class="s6"># First start up servers using direct daemon</span>
        <span class="s6"># What is the name of the client machine?</span>
        <span class="s1">clusterClientDaemonHost </span><span class="s3">= </span><span class="s1">base</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">GetString</span><span class="s3">(</span>
            <span class="s4">'cluster-client-daemon'</span><span class="s3">, </span><span class="s4">'None'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">clusterClientDaemonHost </span><span class="s3">== </span><span class="s4">'None'</span><span class="s3">:</span>
            <span class="s1">clusterClientDaemonHost </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">popen</span><span class="s3">(</span><span class="s4">'uname -n'</span><span class="s3">).</span><span class="s1">read</span><span class="s3">()</span>
            <span class="s1">clusterClientDaemonHost </span><span class="s3">= </span><span class="s1">clusterClientDaemonHost</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">)</span>
        <span class="s6"># What daemon port are we using to communicate between client/servers</span>
        <span class="s1">clusterClientDaemonPort </span><span class="s3">= </span><span class="s1">base</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">GetInt</span><span class="s3">(</span>
            <span class="s4">'cluster-client-daemon-port'</span><span class="s3">, </span><span class="s1">CLUSTER_DAEMON_PORT</span><span class="s3">)</span>
        <span class="s6"># Create a daemon</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">daemon </span><span class="s3">= </span><span class="s1">DirectD</span><span class="s3">()</span>
        <span class="s6"># Start listening for the response</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">daemon</span><span class="s3">.</span><span class="s1">listenTo</span><span class="s3">(</span><span class="s1">clusterClientDaemonPort</span><span class="s3">)</span>
        <span class="s6"># Contact server daemons and start up remote server application</span>
        <span class="s2">for </span><span class="s1">serverConfig </span><span class="s2">in </span><span class="s1">configList</span><span class="s3">:</span>
            <span class="s6"># First kill existing application</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">daemon</span><span class="s3">.</span><span class="s1">tellServer</span><span class="s3">(</span><span class="s1">serverConfig</span><span class="s3">.</span><span class="s1">serverName</span><span class="s3">,</span>
                                   <span class="s1">serverConfig</span><span class="s3">.</span><span class="s1">serverDaemonPort</span><span class="s3">,</span>
                                   <span class="s4">'ka'</span><span class="s3">)</span>
            <span class="s6"># Now start up new application</span>
            <span class="s1">serverCommand </span><span class="s3">= (</span><span class="s1">SERVER_STARTUP_STRING </span><span class="s3">%</span>
                             <span class="s3">(</span><span class="s1">serverConfig</span><span class="s3">.</span><span class="s1">serverMsgPort</span><span class="s3">,</span>
                              <span class="s1">clusterSyncFlag</span><span class="s3">,</span>
                              <span class="s1">clusterClientDaemonHost</span><span class="s3">,</span>
                              <span class="s1">clusterClientDaemonPort</span><span class="s3">))</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">daemon</span><span class="s3">.</span><span class="s1">tellServer</span><span class="s3">(</span><span class="s1">serverConfig</span><span class="s3">.</span><span class="s1">serverName</span><span class="s3">,</span>
                                   <span class="s1">serverConfig</span><span class="s3">.</span><span class="s1">serverDaemonPort</span><span class="s3">,</span>
                                   <span class="s1">serverCommand</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">'Begin waitForServers'</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">daemon</span><span class="s3">.</span><span class="s1">waitForServers</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">configList</span><span class="s3">)):</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">'Cluster Client, no response from servers'</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">'End waitForServers'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">qcm</span><span class="s3">=</span><span class="s1">QueuedConnectionManager</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">serverList </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">serverQueues </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler </span><span class="s3">= </span><span class="s1">ClusterMsgHandler</span><span class="s3">(</span><span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">MGR_NUM</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">)</span>

        <span class="s6"># A dictionary of objects that can be accessed by name</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">objectMappings  </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">objectHasColor  </span><span class="s3">= {}</span>

        <span class="s6"># a dictionary of name objects and the corresponding names of</span>
        <span class="s6"># objects they are to control on the server side</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">controlMappings </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">controlOffsets  </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">taggedObjects   </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">controlPriorities </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sortedControlMappings </span><span class="s3">= []</span>

        <span class="s2">for </span><span class="s1">serverConfig </span><span class="s2">in </span><span class="s1">configList</span><span class="s3">:</span>
            <span class="s1">server </span><span class="s3">= </span><span class="s1">DisplayConnection</span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">qcm</span><span class="s3">, </span><span class="s1">serverConfig</span><span class="s3">.</span><span class="s1">serverName</span><span class="s3">,</span>
                <span class="s1">serverConfig</span><span class="s3">.</span><span class="s1">serverMsgPort</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">server </span><span class="s3">== </span><span class="s2">None</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">'Could not open %s on %s port %d' </span><span class="s3">%</span>
                                  <span class="s3">(</span><span class="s1">serverConfig</span><span class="s3">.</span><span class="s1">serverConfigName</span><span class="s3">,</span>
                                   <span class="s1">serverConfig</span><span class="s3">.</span><span class="s1">serverName</span><span class="s3">,</span>
                                   <span class="s1">serverConfig</span><span class="s3">.</span><span class="s1">serverMsgPort</span><span class="s3">))</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'send cam pos'</span><span class="s3">)</span>
                <span class="s6">#server.sendMoveCam(Point3(0), Vec3(0))</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'send cam offset'</span><span class="s3">)</span>
                <span class="s1">server</span><span class="s3">.</span><span class="s1">sendCamOffset</span><span class="s3">(</span><span class="s1">serverConfig</span><span class="s3">.</span><span class="s1">xyz</span><span class="s3">, </span><span class="s1">serverConfig</span><span class="s3">.</span><span class="s1">hpr</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">serverConfig</span><span class="s3">.</span><span class="s1">fFrustum</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'send cam frustum'</span><span class="s3">)</span>
                    <span class="s1">server</span><span class="s3">.</span><span class="s1">sendCamFrustum</span><span class="s3">(</span><span class="s1">serverConfig</span><span class="s3">.</span><span class="s1">focalLength</span><span class="s3">,</span>
                                          <span class="s1">serverConfig</span><span class="s3">.</span><span class="s1">filmSize</span><span class="s3">,</span>
                                          <span class="s1">serverConfig</span><span class="s3">.</span><span class="s1">filmOffset</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">server</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">serverQueues</span><span class="s3">.</span><span class="s1">append</span><span class="s3">([])</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'pre startTimeTask'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">startSynchronizeTimeTask</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'pre startMoveCam'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">startMoveCamTask</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'post startMoveCam'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">startMoveSelectedTask</span><span class="s3">()</span>


    <span class="s2">def </span><span class="s1">startReaderPollTask</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Task to handle datagrams from server &quot;&quot;&quot;</span>
        <span class="s6"># Run this task just after the listener poll task</span>
        <span class="s1">taskMgr</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_readerPollTask</span><span class="s3">, </span><span class="s4">&quot;clientReaderPollTask&quot;</span><span class="s3">, -</span><span class="s5">39</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_readerPollTask</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Non blocking task to read all available datagrams &quot;&quot;&quot;</span>

        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span><span class="s3">)):</span>
            <span class="s1">server </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
            <span class="s1">datagrams </span><span class="s3">= </span><span class="s1">server</span><span class="s3">.</span><span class="s1">poll</span><span class="s3">()</span>
            <span class="s2">for </span><span class="s1">data </span><span class="s2">in </span><span class="s1">datagrams</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">handleDatagram</span><span class="s3">(</span><span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">],</span><span class="s1">data</span><span class="s3">[</span><span class="s5">1</span><span class="s3">],</span><span class="s1">i</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">Task</span><span class="s3">.</span><span class="s1">cont</span>


    <span class="s2">def </span><span class="s1">startControlObjectTask</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">&quot;moving control objects&quot;</span><span class="s3">)</span>
        <span class="s1">taskMgr</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">controlObjectTask</span><span class="s3">,</span><span class="s4">&quot;controlObjectTask&quot;</span><span class="s3">,</span><span class="s5">50</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">startSynchronizeTimeTask</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'broadcasting frame time'</span><span class="s3">)</span>
        <span class="s1">taskMgr</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">synchronizeTimeTask</span><span class="s3">, </span><span class="s4">&quot;synchronizeTimeTask&quot;</span><span class="s3">, -</span><span class="s5">40</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">synchronizeTimeTask</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">task</span><span class="s3">):</span>
        <span class="s1">frameCount </span><span class="s3">= </span><span class="s1">globalClock</span><span class="s3">.</span><span class="s1">getFrameCount</span><span class="s3">()</span>
        <span class="s1">frameTime </span><span class="s3">= </span><span class="s1">globalClock</span><span class="s3">.</span><span class="s1">getFrameTime</span><span class="s3">()</span>
        <span class="s1">dt </span><span class="s3">= </span><span class="s1">globalClock</span><span class="s3">.</span><span class="s1">getDt</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">server </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span><span class="s3">:</span>
            <span class="s1">server</span><span class="s3">.</span><span class="s1">sendTimeData</span><span class="s3">(</span><span class="s1">frameCount</span><span class="s3">, </span><span class="s1">frameTime</span><span class="s3">, </span><span class="s1">dt</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">Task</span><span class="s3">.</span><span class="s1">cont</span>

    <span class="s2">def </span><span class="s1">startMoveCamTask</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'adding move cam'</span><span class="s3">)</span>
        <span class="s1">taskMgr</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">moveCameraTask</span><span class="s3">, </span><span class="s4">&quot;moveCamTask&quot;</span><span class="s3">, </span><span class="s5">49</span><span class="s3">)</span>


    <span class="s2">def </span><span class="s1">controlObjectTask</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">task</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">pair </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sortedControlMappings</span><span class="s3">:</span>
            <span class="s1">object     </span><span class="s3">= </span><span class="s1">pair</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>
            <span class="s1">name       </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">controlMappings</span><span class="s3">[</span><span class="s1">object</span><span class="s3">][</span><span class="s5">0</span><span class="s3">]</span>
            <span class="s1">serverList </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">controlMappings</span><span class="s3">[</span><span class="s1">object</span><span class="s3">][</span><span class="s5">1</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">object </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">objectMappings</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">moveObject</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">objectMappings</span><span class="s3">[</span><span class="s1">object</span><span class="s3">],</span><span class="s1">name</span><span class="s3">,</span><span class="s1">serverList</span><span class="s3">,</span>
                                <span class="s1">self</span><span class="s3">.</span><span class="s1">controlOffsets</span><span class="s3">[</span><span class="s1">object</span><span class="s3">], </span><span class="s1">self</span><span class="s3">.</span><span class="s1">objectHasColor</span><span class="s3">[</span><span class="s1">object</span><span class="s3">])</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sendNamedMovementDone</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">Task</span><span class="s3">.</span><span class="s1">cont</span>

    <span class="s2">def </span><span class="s1">sendNamedMovementDone</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">serverList </span><span class="s3">= </span><span class="s2">None</span><span class="s3">):</span>

        <span class="s2">if </span><span class="s3">(</span><span class="s1">serverList </span><span class="s3">== </span><span class="s2">None</span><span class="s3">):</span>
            <span class="s1">serverList </span><span class="s3">= </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span><span class="s3">))</span>

        <span class="s2">for </span><span class="s1">server </span><span class="s2">in </span><span class="s1">serverList</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span><span class="s3">[</span><span class="s1">server</span><span class="s3">].</span><span class="s1">sendNamedMovementDone</span><span class="s3">()</span>



    <span class="s2">def </span><span class="s1">redoSortedPriorities</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">sortedControlMappings </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">key </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">controlMappings</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">sortedControlMappings</span><span class="s3">.</span><span class="s1">append</span><span class="s3">([</span><span class="s1">self</span><span class="s3">.</span><span class="s1">controlPriorities</span><span class="s3">[</span><span class="s1">key</span><span class="s3">],</span>
                                               <span class="s1">key</span><span class="s3">])</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">sortedControlMappings</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">moveObject</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">nodePath</span><span class="s3">, </span><span class="s1">object</span><span class="s3">, </span><span class="s1">serverList</span><span class="s3">, </span><span class="s1">offset</span><span class="s3">, </span><span class="s1">hasColor </span><span class="s3">= </span><span class="s2">True</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'moving object '</span><span class="s3">+</span><span class="s1">object</span><span class="s3">)</span>
        <span class="s1">xyz </span><span class="s3">= </span><span class="s1">nodePath</span><span class="s3">.</span><span class="s1">getPos</span><span class="s3">(</span><span class="s1">render</span><span class="s3">) + </span><span class="s1">offset</span>
        <span class="s1">hpr </span><span class="s3">= </span><span class="s1">nodePath</span><span class="s3">.</span><span class="s1">getHpr</span><span class="s3">(</span><span class="s1">render</span><span class="s3">)</span>
        <span class="s1">scale </span><span class="s3">= </span><span class="s1">nodePath</span><span class="s3">.</span><span class="s1">getScale</span><span class="s3">(</span><span class="s1">render</span><span class="s3">)</span>
        <span class="s1">hidden </span><span class="s3">= </span><span class="s1">nodePath</span><span class="s3">.</span><span class="s1">isHidden</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">hasColor</span><span class="s3">):</span>
            <span class="s1">color </span><span class="s3">= </span><span class="s1">nodePath</span><span class="s3">.</span><span class="s1">getColor</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">color </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">,</span><span class="s5">1</span><span class="s3">,</span><span class="s5">1</span><span class="s3">,</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">server </span><span class="s2">in </span><span class="s1">serverList</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span><span class="s3">[</span><span class="s1">server</span><span class="s3">].</span><span class="s1">sendMoveNamedObject</span><span class="s3">(</span><span class="s1">xyz</span><span class="s3">,</span><span class="s1">hpr</span><span class="s3">,</span><span class="s1">scale</span><span class="s3">,</span><span class="s1">color</span><span class="s3">,</span><span class="s1">hidden</span><span class="s3">,</span><span class="s1">object</span><span class="s3">)</span>


    <span class="s2">def </span><span class="s1">moveCameraTask</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">task</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">moveCamera</span><span class="s3">(</span>
            <span class="s1">base</span><span class="s3">.</span><span class="s1">camera</span><span class="s3">.</span><span class="s1">getPos</span><span class="s3">(</span><span class="s1">render</span><span class="s3">),</span>
            <span class="s1">base</span><span class="s3">.</span><span class="s1">camera</span><span class="s3">.</span><span class="s1">getHpr</span><span class="s3">(</span><span class="s1">render</span><span class="s3">))</span>
        <span class="s2">return </span><span class="s1">Task</span><span class="s3">.</span><span class="s1">cont</span>

    <span class="s2">def </span><span class="s1">moveCamera</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xyz</span><span class="s3">, </span><span class="s1">hpr</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'moving unsynced camera'</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">server </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span><span class="s3">:</span>
            <span class="s1">server</span><span class="s3">.</span><span class="s1">sendMoveCam</span><span class="s3">(</span><span class="s1">xyz</span><span class="s3">, </span><span class="s1">hpr</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">startMoveSelectedTask</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">taskMgr</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">moveSelectedTask</span><span class="s3">, </span><span class="s4">&quot;moveSelectedTask&quot;</span><span class="s3">, </span><span class="s5">48</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">moveSelectedTask</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">):</span>
        <span class="s6"># Update cluster if current display is a cluster client</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">last </span><span class="s2">is not None</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'moving selected node path'</span><span class="s3">)</span>
            <span class="s1">xyz </span><span class="s3">= </span><span class="s1">Point3</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
            <span class="s1">hpr </span><span class="s3">= </span><span class="s1">VBase3</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
            <span class="s1">scale </span><span class="s3">= </span><span class="s1">VBase3</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
            <span class="s1">decomposeMatrix</span><span class="s3">(</span><span class="s1">last</span><span class="s3">.</span><span class="s1">getMat</span><span class="s3">(), </span><span class="s1">scale</span><span class="s3">, </span><span class="s1">hpr</span><span class="s3">, </span><span class="s1">xyz</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">server </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span><span class="s3">:</span>
                <span class="s1">server</span><span class="s3">.</span><span class="s1">sendMoveSelected</span><span class="s3">(</span><span class="s1">xyz</span><span class="s3">, </span><span class="s1">hpr</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">Task</span><span class="s3">.</span><span class="s1">cont</span>


    <span class="s2">def </span><span class="s1">addNamedObjectMapping</span><span class="s3">(</span><span class="s1">self</span><span class="s3">,</span><span class="s1">object</span><span class="s3">,</span><span class="s1">name</span><span class="s3">,</span><span class="s1">hasColor </span><span class="s3">= </span><span class="s2">True</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">name </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">objectMappings</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">objectMappings</span><span class="s3">[</span><span class="s1">name</span><span class="s3">] = </span><span class="s1">object</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">objectHasColor</span><span class="s3">[</span><span class="s1">name</span><span class="s3">] = </span><span class="s1">hasColor</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'attempt to add duplicate named object: '</span><span class="s3">+</span><span class="s1">name</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">removeObjectMapping</span><span class="s3">(</span><span class="s1">self</span><span class="s3">,</span><span class="s1">name</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">name </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">objectMappings</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">objectMappings</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>


    <span class="s2">def </span><span class="s1">addControlMapping</span><span class="s3">(</span><span class="s1">self</span><span class="s3">,</span><span class="s1">objectName</span><span class="s3">,</span><span class="s1">controlledName</span><span class="s3">, </span><span class="s1">serverList </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
                          <span class="s1">offset </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s1">priority </span><span class="s3">= </span><span class="s5">0</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">objectName </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">controlMappings</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">serverList </span><span class="s3">== </span><span class="s2">None</span><span class="s3">):</span>
                <span class="s1">serverList </span><span class="s3">= </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">offset </span><span class="s3">== </span><span class="s2">None</span><span class="s3">):</span>
                <span class="s1">offset </span><span class="s3">= </span><span class="s1">Vec3</span><span class="s3">(</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">)</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">controlMappings</span><span class="s3">[</span><span class="s1">objectName</span><span class="s3">] = [</span><span class="s1">controlledName</span><span class="s3">,</span><span class="s1">serverList</span><span class="s3">]</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">controlOffsets</span><span class="s3">[</span><span class="s1">objectName</span><span class="s3">]  = </span><span class="s1">offset</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">controlPriorities</span><span class="s3">[</span><span class="s1">objectName</span><span class="s3">] = </span><span class="s1">priority</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">oldList </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">controlMappings</span><span class="s3">[</span><span class="s1">objectName</span><span class="s3">]</span>
            <span class="s1">mergedList </span><span class="s3">= []</span>
            <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">oldList</span><span class="s3">:</span>
                <span class="s1">mergedList</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">item</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">serverList</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">item </span><span class="s2">not in </span><span class="s1">mergedList</span><span class="s3">):</span>
                    <span class="s1">mergedList</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">item</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">redoSortedPriorities</span><span class="s3">()</span>
            <span class="s6">#self.notify.debug('attempt to add duplicate controlled object: '+name)</span>

    <span class="s2">def </span><span class="s1">setControlMappingOffset</span><span class="s3">(</span><span class="s1">self</span><span class="s3">,</span><span class="s1">objectName</span><span class="s3">,</span><span class="s1">offset</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">objectName </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">controlMappings</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">controlOffsets</span><span class="s3">[</span><span class="s1">objectName</span><span class="s3">] = </span><span class="s1">offset</span>

    <span class="s2">def </span><span class="s1">removeControlMapping</span><span class="s3">(</span><span class="s1">self</span><span class="s3">,</span><span class="s1">name</span><span class="s3">, </span><span class="s1">serverList </span><span class="s3">= </span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">name </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">controlMappings</span><span class="s3">):</span>

            <span class="s2">if </span><span class="s3">(</span><span class="s1">serverList </span><span class="s3">== </span><span class="s2">None</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">controlMappings</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">controlPriorities</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">list </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">controlMappings</span><span class="s3">[</span><span class="s1">key</span><span class="s3">][</span><span class="s5">1</span><span class="s3">]</span>
                <span class="s1">newList </span><span class="s3">= []</span>
                <span class="s2">for </span><span class="s1">server </span><span class="s2">in </span><span class="s1">list</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s3">(</span><span class="s1">server </span><span class="s2">not in </span><span class="s1">serverList</span><span class="s3">):</span>
                        <span class="s1">newList</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">server</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">controlMappings</span><span class="s3">[</span><span class="s1">key</span><span class="s3">][</span><span class="s5">1</span><span class="s3">] = </span><span class="s1">newList</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">newList</span><span class="s3">) == </span><span class="s5">0</span><span class="s3">):</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">controlMappings</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">controlPriorities</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">redoSortedPriorities</span><span class="s3">()</span>


    <span class="s2">def </span><span class="s1">getNodePathFindCmd</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">nodePath</span><span class="s3">):</span>
        <span class="s1">pathString </span><span class="s3">= </span><span class="s1">repr</span><span class="s3">(</span><span class="s1">nodePath</span><span class="s3">)</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">pathString</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s4">'/'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">index </span><span class="s3">!= -</span><span class="s5">1</span><span class="s3">:</span>
            <span class="s1">rootName </span><span class="s3">= </span><span class="s1">pathString</span><span class="s3">[:</span><span class="s1">index</span><span class="s3">]</span>
            <span class="s1">searchString </span><span class="s3">= </span><span class="s1">pathString</span><span class="s3">[</span><span class="s1">index</span><span class="s3">+</span><span class="s5">1</span><span class="s3">:]</span>
            <span class="s2">return </span><span class="s1">rootName </span><span class="s3">+ (</span><span class="s4">'.find(&quot;%s&quot;)' </span><span class="s3">% </span><span class="s1">searchString</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">rootName</span>

    <span class="s2">def </span><span class="s1">getNodePathName</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">nodePath</span><span class="s3">):</span>
        <span class="s1">pathString </span><span class="s3">= </span><span class="s1">repr</span><span class="s3">(</span><span class="s1">nodePath</span><span class="s3">)</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">pathString</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s4">'/'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">index </span><span class="s3">!= -</span><span class="s5">1</span><span class="s3">:</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s1">pathString</span><span class="s3">[</span><span class="s1">index</span><span class="s3">+</span><span class="s5">1</span><span class="s3">:]</span>
            <span class="s2">return </span><span class="s1">name</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">pathString</span>


    <span class="s2">def </span><span class="s1">addObjectTag</span><span class="s3">(</span><span class="s1">self</span><span class="s3">,</span><span class="s1">object</span><span class="s3">,</span><span class="s1">selectFunction</span><span class="s3">,</span><span class="s1">deselectFunction</span><span class="s3">,</span><span class="s1">selectArgs</span><span class="s3">,</span><span class="s1">deselectArgs</span><span class="s3">):</span>
        <span class="s1">newTag </span><span class="s3">= {}</span>
        <span class="s1">newTag</span><span class="s3">[</span><span class="s4">&quot;selectFunction&quot;</span><span class="s3">] = </span><span class="s1">selectFunction</span>
        <span class="s1">newTag</span><span class="s3">[</span><span class="s4">&quot;selectArgs&quot;</span><span class="s3">]     = </span><span class="s1">selectArgs</span>
        <span class="s1">newTag</span><span class="s3">[</span><span class="s4">&quot;deselectFunction&quot;</span><span class="s3">] = </span><span class="s1">deselectFunction</span>
        <span class="s1">newTag</span><span class="s3">[</span><span class="s4">&quot;deselectArgs&quot;</span><span class="s3">]     = </span><span class="s1">deselectArgs</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">taggedObjects</span><span class="s3">[</span><span class="s1">object</span><span class="s3">] = </span><span class="s1">newTag</span>


    <span class="s2">def </span><span class="s1">removeObjectTag</span><span class="s3">(</span><span class="s1">self</span><span class="s3">,</span><span class="s1">object</span><span class="s3">):</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">taggedObjects</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s1">object</span><span class="s3">)</span>


    <span class="s2">def </span><span class="s1">selectNodePath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">nodePath</span><span class="s3">):</span>
        <span class="s1">name </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getNodePathName</span><span class="s3">(</span><span class="s1">nodePath</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">name </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">taggedObjects</span><span class="s3">:</span>
            <span class="s1">taskMgr</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s4">&quot;moveSelectedTask&quot;</span><span class="s3">)</span>
            <span class="s1">tag </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">taggedObjects</span><span class="s3">[</span><span class="s1">name</span><span class="s3">]</span>
            <span class="s1">function </span><span class="s3">= </span><span class="s1">tag</span><span class="s3">[</span><span class="s4">&quot;selectFunction&quot;</span><span class="s3">]</span>
            <span class="s1">args     </span><span class="s3">= </span><span class="s1">tag</span><span class="s3">[</span><span class="s4">&quot;selectArgs&quot;</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">function </span><span class="s3">!= </span><span class="s2">None</span><span class="s3">):</span>
                <span class="s1">function</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">getNodePathFindCmd</span><span class="s3">(</span><span class="s1">nodePath</span><span class="s3">) + </span><span class="s4">'.select()'</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>


    <span class="s2">def </span><span class="s1">deselectNodePath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">nodePath</span><span class="s3">):</span>
        <span class="s1">name </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getNodePathName</span><span class="s3">(</span><span class="s1">nodePath</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">name </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">taggedObjects</span><span class="s3">:</span>
            <span class="s1">tag </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">taggedObjects</span><span class="s3">[</span><span class="s1">name</span><span class="s3">]</span>
            <span class="s1">function </span><span class="s3">= </span><span class="s1">tag</span><span class="s3">[</span><span class="s4">&quot;deselectFunction&quot;</span><span class="s3">]</span>
            <span class="s1">args     </span><span class="s3">= </span><span class="s1">tag</span><span class="s3">[</span><span class="s4">&quot;deselectArgs&quot;</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">function </span><span class="s3">!= </span><span class="s2">None</span><span class="s3">):</span>
                <span class="s1">function</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">startMoveSelectedTask</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">getNodePathFindCmd</span><span class="s3">(</span><span class="s1">nodePath</span><span class="s3">) + </span><span class="s4">'.deselect()'</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">sendCamFrustum</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">focalLength</span><span class="s3">, </span><span class="s1">filmSize</span><span class="s3">, </span><span class="s1">filmOffset</span><span class="s3">, </span><span class="s1">indexList</span><span class="s3">=[]):</span>
        <span class="s2">if </span><span class="s1">indexList</span><span class="s3">:</span>
            <span class="s1">serverList </span><span class="s3">= [</span><span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">indexList</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">serverList </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span>
        <span class="s2">for </span><span class="s1">server </span><span class="s2">in </span><span class="s1">serverList</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'updating camera frustum'</span><span class="s3">)</span>
            <span class="s1">server</span><span class="s3">.</span><span class="s1">sendCamFrustum</span><span class="s3">(</span><span class="s1">focalLength</span><span class="s3">, </span><span class="s1">filmSize</span><span class="s3">, </span><span class="s1">filmOffset</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">loadModel</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">nodePath</span><span class="s3">):</span>
        <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">__call__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">commandString</span><span class="s3">, </span><span class="s1">fLocally </span><span class="s3">= </span><span class="s5">1</span><span class="s3">, </span><span class="s1">serverList </span><span class="s3">= []):</span>
        <span class="s6"># Execute remotely</span>
        <span class="s2">if </span><span class="s1">serverList</span><span class="s3">:</span>
            <span class="s6"># Passed in list of servers</span>
            <span class="s2">for </span><span class="s1">serverNum </span><span class="s2">in </span><span class="s1">serverList</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span><span class="s3">[</span><span class="s1">serverNum</span><span class="s3">].</span><span class="s1">sendCommandString</span><span class="s3">(</span><span class="s1">commandString</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s6"># All servers</span>
            <span class="s2">for </span><span class="s1">server </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span><span class="s3">:</span>
                <span class="s1">server</span><span class="s3">.</span><span class="s1">sendCommandString</span><span class="s3">(</span><span class="s1">commandString</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">fLocally</span><span class="s3">:</span>
            <span class="s6"># Execute locally</span>
            <span class="s1">exec</span><span class="s3">(</span><span class="s1">commandString</span><span class="s3">, </span><span class="s1">__builtins__</span><span class="s3">)</span>


    <span class="s2">def </span><span class="s1">handleDatagram</span><span class="s3">(</span><span class="s1">self</span><span class="s3">,</span><span class="s1">dgi</span><span class="s3">,</span><span class="s1">type</span><span class="s3">,</span><span class="s1">server</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">type </span><span class="s3">== </span><span class="s1">CLUSTER_NONE</span><span class="s3">):</span>
            <span class="s2">pass</span>
        <span class="s2">elif </span><span class="s3">(</span><span class="s1">type </span><span class="s3">== </span><span class="s1">CLUSTER_NAMED_OBJECT_MOVEMENT</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">serverQueues</span><span class="s3">[</span><span class="s1">server</span><span class="s3">].</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">parseNamedMovementDatagram</span><span class="s3">(</span><span class="s1">dgi</span><span class="s3">))</span>
            <span class="s6">#self.handleNamedMovement(dgi)</span>
        <span class="s6"># when we recieve a 'named movement done' packet from a server we handle</span>
        <span class="s6"># all of its messages</span>
        <span class="s2">elif </span><span class="s3">(</span><span class="s1">type </span><span class="s3">== </span><span class="s1">CLUSTER_NAMED_MOVEMENT_DONE</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">handleMessageQueue</span><span class="s3">(</span><span class="s1">server</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span><span class="s4">&quot;Received unsupported packet type:&quot; </span><span class="s3">% </span><span class="s1">type</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">type</span>

    <span class="s2">def </span><span class="s1">handleMessageQueue</span><span class="s3">(</span><span class="s1">self</span><span class="s3">,</span><span class="s1">server</span><span class="s3">):</span>

        <span class="s1">list </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">serverQueues</span><span class="s3">[</span><span class="s1">server</span><span class="s3">]</span>
        <span class="s6"># handle all messages in the queue</span>
        <span class="s2">for </span><span class="s1">data </span><span class="s2">in </span><span class="s1">list</span><span class="s3">:</span>
            <span class="s6">#print dgi</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">handleNamedMovement</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>

        <span class="s6"># clear the queue</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">serverQueues</span><span class="s3">[</span><span class="s1">server</span><span class="s3">] = []</span>


    <span class="s2">def </span><span class="s1">handleNamedMovement</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Update cameraJig position to reflect latest position &quot;&quot;&quot;</span>

        <span class="s3">(</span><span class="s1">name</span><span class="s3">,</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">h</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">r</span><span class="s3">, </span><span class="s1">sx</span><span class="s3">, </span><span class="s1">sy</span><span class="s3">, </span><span class="s1">sz</span><span class="s3">,</span><span class="s1">red</span><span class="s3">,</span><span class="s1">g</span><span class="s3">,</span><span class="s1">b</span><span class="s3">,</span><span class="s1">a</span><span class="s3">, </span><span class="s1">hidden</span><span class="s3">) = </span><span class="s1">data</span>
        <span class="s6">#print &quot;name&quot;</span>
        <span class="s6">#if (name == &quot;camNode&quot;):</span>
        <span class="s6">#    print x,y,z,h,p,r, sx, sy, sz,red,g,b,a, hidden</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">name </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">objectMappings</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">objectMappings</span><span class="s3">[</span><span class="s1">name</span><span class="s3">].</span><span class="s1">setPosHpr</span><span class="s3">(</span><span class="s1">render</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">h</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">r</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">objectMappings</span><span class="s3">[</span><span class="s1">name</span><span class="s3">].</span><span class="s1">setScale</span><span class="s3">(</span><span class="s1">render</span><span class="s3">,</span><span class="s1">sx</span><span class="s3">,</span><span class="s1">sy</span><span class="s3">,</span><span class="s1">sz</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">objectHasColor</span><span class="s3">[</span><span class="s1">name</span><span class="s3">]):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">objectMappings</span><span class="s3">[</span><span class="s1">name</span><span class="s3">].</span><span class="s1">setColor</span><span class="s3">(</span><span class="s1">red</span><span class="s3">,</span><span class="s1">g</span><span class="s3">,</span><span class="s1">b</span><span class="s3">,</span><span class="s1">a</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">hidden</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">objectMappings</span><span class="s3">[</span><span class="s1">name</span><span class="s3">].</span><span class="s1">hide</span><span class="s3">()</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">objectMappings</span><span class="s3">[</span><span class="s1">name</span><span class="s3">].</span><span class="s1">show</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">&quot;recieved unknown named object command: &quot;</span><span class="s3">+</span><span class="s1">name</span><span class="s3">)</span>


    <span class="s2">def </span><span class="s1">exit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Execute remotely</span>
        <span class="s2">for </span><span class="s1">server </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span><span class="s3">:</span>
            <span class="s1">server</span><span class="s3">.</span><span class="s1">sendExit</span><span class="s3">()</span>
        <span class="s6"># Execute locally</span>
        <span class="s2">import </span><span class="s1">sys</span>
        <span class="s1">sys</span><span class="s3">.</span><span class="s1">exit</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">ClusterClientSync</span><span class="s3">(</span><span class="s1">ClusterClient</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">configList</span><span class="s3">, </span><span class="s1">clusterSyncFlag</span><span class="s3">):</span>
        <span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">configList</span><span class="s3">, </span><span class="s1">clusterSyncFlag</span><span class="s3">)</span>
        <span class="s6">#I probably don't need this</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">waitForSwap </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">ready </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;creating synced client&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">startSwapCoordinatorTask</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">startSwapCoordinatorTask</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">taskMgr</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">swapCoordinator</span><span class="s3">, </span><span class="s4">&quot;clientSwapCoordinator&quot;</span><span class="s3">, </span><span class="s5">51</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">swapCoordinator</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">task</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">ready </span><span class="s3">= </span><span class="s5">1</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">waitForSwap</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">waitForSwap</span><span class="s3">=</span><span class="s5">0</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span>
                <span class="s4">&quot;START get swaps----------------------------------&quot;</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">server </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span><span class="s3">:</span>
                <span class="s1">server</span><span class="s3">.</span><span class="s1">getSwapReady</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span>
                <span class="s4">&quot;----------------START swap now--------------------&quot;</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">server </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">serverList</span><span class="s3">:</span>
                <span class="s1">server</span><span class="s3">.</span><span class="s1">sendSwapNow</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span>
                <span class="s4">&quot;------------------------------START swap----------&quot;</span><span class="s3">)</span>
            <span class="s1">base</span><span class="s3">.</span><span class="s1">graphicsEngine</span><span class="s3">.</span><span class="s1">flipFrame</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span>
                <span class="s4">&quot;------------------------------------------END swap&quot;</span><span class="s3">)</span>

        <span class="s6">#print &quot;syncing&quot;</span>
        <span class="s2">return </span><span class="s1">Task</span><span class="s3">.</span><span class="s1">cont</span>

    <span class="s2">def </span><span class="s1">moveCamera</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xyz</span><span class="s3">, </span><span class="s1">hpr</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ready</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'moving synced camera'</span><span class="s3">)</span>
            <span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">moveCamera</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xyz</span><span class="s3">, </span><span class="s1">hpr</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">waitForSwap</span><span class="s3">=</span><span class="s5">1</span>


<span class="s2">class </span><span class="s1">DisplayConnection</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">qcm</span><span class="s3">, </span><span class="s1">serverName</span><span class="s3">, </span><span class="s1">port</span><span class="s3">, </span><span class="s1">msgHandler</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler </span><span class="s3">= </span><span class="s1">msgHandler</span>
        <span class="s1">gameServerTimeoutMs </span><span class="s3">= </span><span class="s1">base</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">GetInt</span><span class="s3">(</span>
            <span class="s4">&quot;cluster-server-timeout-ms&quot;</span><span class="s3">, </span><span class="s5">300000</span><span class="s3">)</span>
        <span class="s6"># A giant 300 second timeout.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tcpConn </span><span class="s3">= </span><span class="s1">qcm</span><span class="s3">.</span><span class="s1">openTCPClientConnection</span><span class="s3">(</span>
            <span class="s1">serverName</span><span class="s3">, </span><span class="s1">port</span><span class="s3">, </span><span class="s1">gameServerTimeoutMs</span><span class="s3">)</span>
        <span class="s6"># Test for bad connection</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tcpConn </span><span class="s3">== </span><span class="s2">None</span><span class="s3">:</span>
            <span class="s2">return None</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">tcpConn</span><span class="s3">.</span><span class="s1">setNoDelay</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">qcr</span><span class="s3">=</span><span class="s1">QueuedConnectionReader</span><span class="s3">(</span><span class="s1">qcm</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">qcr</span><span class="s3">.</span><span class="s1">addConnection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">tcpConn</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">cw</span><span class="s3">=</span><span class="s1">ConnectionWriter</span><span class="s3">(</span><span class="s1">qcm</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>



    <span class="s2">def </span><span class="s1">poll</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Non blocking task to read all available datagrams &quot;&quot;&quot;</span>
        <span class="s1">dataGrams </span><span class="s3">= []</span>
        <span class="s2">while </span><span class="s5">1</span><span class="s3">:</span>
            <span class="s3">(</span><span class="s1">datagram</span><span class="s3">, </span><span class="s1">dgi</span><span class="s3">, </span><span class="s1">type</span><span class="s3">) = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">nonBlockingRead</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">qcr</span><span class="s3">)</span>
            <span class="s6"># Queue is empty, done for now</span>
            <span class="s2">if </span><span class="s1">type </span><span class="s2">is </span><span class="s1">CLUSTER_NONE</span><span class="s3">:</span>
                <span class="s2">break</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s6"># Got a datagram, add it to the list</span>
                <span class="s1">dataGrams</span><span class="s3">.</span><span class="s1">append</span><span class="s3">([</span><span class="s1">dgi</span><span class="s3">, </span><span class="s1">type</span><span class="s3">, </span><span class="s1">datagram</span><span class="s3">])</span>

        <span class="s2">return </span><span class="s1">dataGrams</span>




    <span class="s2">def </span><span class="s1">sendCamOffset</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xyz</span><span class="s3">, </span><span class="s1">hpr</span><span class="s3">):</span>
        <span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">&quot;send cam offset...&quot;</span><span class="s3">)</span>
        <span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">((</span><span class="s4">&quot;packet %d xyz, hpr=%f %f %f %f %f %f&quot; </span><span class="s3">%</span>
             <span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">packetNumber</span><span class="s3">, </span><span class="s1">xyz</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">xyz</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">xyz</span><span class="s3">[</span><span class="s5">2</span><span class="s3">],</span>
             <span class="s1">hpr</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">hpr</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">hpr</span><span class="s3">[</span><span class="s5">2</span><span class="s3">])))</span>
        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">makeCamOffsetDatagram</span><span class="s3">(</span><span class="s1">xyz</span><span class="s3">, </span><span class="s1">hpr</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cw</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tcpConn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">sendCamFrustum</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">focalLength</span><span class="s3">, </span><span class="s1">filmSize</span><span class="s3">, </span><span class="s1">filmOffset</span><span class="s3">):</span>
        <span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;send cam frustum...&quot;</span><span class="s3">)</span>
        <span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span>
            <span class="s3">((</span><span class="s4">&quot;packet %d&quot; </span><span class="s3">% </span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">packetNumber</span><span class="s3">) +</span>
             <span class="s3">(</span><span class="s4">&quot; fl, fs, fo=%0.3f, (%0.3f, %0.3f), (%0.3f, %0.3f)&quot; </span><span class="s3">%</span>
              <span class="s3">(</span><span class="s1">focalLength</span><span class="s3">, </span><span class="s1">filmSize</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">filmSize</span><span class="s3">[</span><span class="s5">1</span><span class="s3">],</span>
               <span class="s1">filmOffset</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">filmOffset</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])))</span>
            <span class="s3">)</span>
        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">makeCamFrustumDatagram</span><span class="s3">(</span>
            <span class="s1">focalLength</span><span class="s3">, </span><span class="s1">filmSize</span><span class="s3">, </span><span class="s1">filmOffset</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cw</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tcpConn</span><span class="s3">)</span>


    <span class="s2">def </span><span class="s1">sendNamedMovementDone</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>

        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">makeNamedMovementDone</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cw</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tcpConn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">sendMoveNamedObject</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xyz</span><span class="s3">, </span><span class="s1">hpr</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">, </span><span class="s1">color</span><span class="s3">, </span><span class="s1">hidden</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">&quot;send named object move...&quot;</span><span class="s3">)</span>
        <span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">((</span><span class="s4">&quot;packet %d xyz, hpr=%f %f %f %f %f %f&quot; </span><span class="s3">%</span>
             <span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">packetNumber</span><span class="s3">, </span><span class="s1">xyz</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">xyz</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">xyz</span><span class="s3">[</span><span class="s5">2</span><span class="s3">],</span>
             <span class="s1">hpr</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">hpr</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">hpr</span><span class="s3">[</span><span class="s5">2</span><span class="s3">])))</span>
        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">makeNamedObjectMovementDatagram</span><span class="s3">(</span><span class="s1">xyz</span><span class="s3">,</span><span class="s1">hpr</span><span class="s3">,</span><span class="s1">scale</span><span class="s3">,</span>
                                                                   <span class="s1">color</span><span class="s3">,</span><span class="s1">hidden</span><span class="s3">,</span>
                                                                   <span class="s1">name</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cw</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tcpConn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">sendMoveCam</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xyz</span><span class="s3">, </span><span class="s1">hpr</span><span class="s3">):</span>
        <span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">&quot;send cam move...&quot;</span><span class="s3">)</span>
        <span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">((</span><span class="s4">&quot;packet %d xyz, hpr=%f %f %f %f %f %f&quot; </span><span class="s3">%</span>
             <span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">packetNumber</span><span class="s3">, </span><span class="s1">xyz</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">xyz</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">xyz</span><span class="s3">[</span><span class="s5">2</span><span class="s3">],</span>
             <span class="s1">hpr</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">hpr</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">hpr</span><span class="s3">[</span><span class="s5">2</span><span class="s3">])))</span>
        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">makeCamMovementDatagram</span><span class="s3">(</span><span class="s1">xyz</span><span class="s3">, </span><span class="s1">hpr</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cw</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tcpConn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">sendMoveSelected</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xyz</span><span class="s3">, </span><span class="s1">hpr</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">):</span>
        <span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">&quot;send move selected...&quot;</span><span class="s3">)</span>
        <span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span>
            <span class="s4">&quot;packet %d xyz, hpr=%f %f %f %f %f %f %f %f %f&quot; </span><span class="s3">%</span>
            <span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">packetNumber</span><span class="s3">,</span>
             <span class="s1">xyz</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">xyz</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">xyz</span><span class="s3">[</span><span class="s5">2</span><span class="s3">],</span>
             <span class="s1">hpr</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">hpr</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">hpr</span><span class="s3">[</span><span class="s5">2</span><span class="s3">],</span>
             <span class="s1">scale</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">scale</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">scale</span><span class="s3">[</span><span class="s5">2</span><span class="s3">]))</span>
        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">makeSelectedMovementDatagram</span><span class="s3">(</span><span class="s1">xyz</span><span class="s3">, </span><span class="s1">hpr</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cw</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tcpConn</span><span class="s3">)</span>

    <span class="s6"># the following should only be called by a synchronized cluster manger</span>
    <span class="s2">def </span><span class="s1">getSwapReady</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">while </span><span class="s5">1</span><span class="s3">:</span>
            <span class="s3">(</span><span class="s1">datagram</span><span class="s3">, </span><span class="s1">dgi</span><span class="s3">, </span><span class="s1">type</span><span class="s3">) = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">blockingRead</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">qcr</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">type </span><span class="s3">== </span><span class="s1">CLUSTER_SWAP_READY</span><span class="s3">:</span>
                <span class="s2">break</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span><span class="s4">'was expecting SWAP_READY, got %d' </span><span class="s3">% </span><span class="s1">type</span><span class="s3">)</span>

    <span class="s6"># the following should only be called by a synchronized cluster manger</span>
    <span class="s2">def </span><span class="s1">sendSwapNow</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span>
            <span class="s4">&quot;display connect send swap now, packet %d&quot; </span><span class="s3">%</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">packetNumber</span><span class="s3">)</span>
        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">makeSwapNowDatagram</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cw</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tcpConn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">sendCommandString</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">commandString</span><span class="s3">):</span>
        <span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">&quot;send command string: %s&quot; </span><span class="s3">% </span><span class="s1">commandString</span><span class="s3">)</span>
        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">makeCommandStringDatagram</span><span class="s3">(</span><span class="s1">commandString</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cw</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tcpConn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">sendExit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span>
            <span class="s4">&quot;display connect send exit, packet %d&quot; </span><span class="s3">%</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">packetNumber</span><span class="s3">)</span>
        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">makeExitDatagram</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cw</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tcpConn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">sendTimeData</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">frameCount</span><span class="s3">, </span><span class="s1">frameTime</span><span class="s3">, </span><span class="s1">dt</span><span class="s3">):</span>
        <span class="s1">ClusterClient</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">&quot;send time data...&quot;</span><span class="s3">)</span>
        <span class="s1">datagram </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">msgHandler</span><span class="s3">.</span><span class="s1">makeTimeDataDatagram</span><span class="s3">(</span>
            <span class="s1">frameCount</span><span class="s3">, </span><span class="s1">frameTime</span><span class="s3">, </span><span class="s1">dt</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cw</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">datagram</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tcpConn</span><span class="s3">)</span>

<span class="s2">class </span><span class="s1">ClusterConfigItem</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">serverConfigName</span><span class="s3">, </span><span class="s1">serverName</span><span class="s3">,</span>
                 <span class="s1">serverDaemonPort</span><span class="s3">, </span><span class="s1">serverMsgPort</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">serverConfigName </span><span class="s3">= </span><span class="s1">serverConfigName</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">serverName </span><span class="s3">= </span><span class="s1">serverName</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">serverDaemonPort </span><span class="s3">= </span><span class="s1">serverDaemonPort</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">serverMsgPort </span><span class="s3">= </span><span class="s1">serverMsgPort</span>
        <span class="s6"># Camera Offset</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">xyz </span><span class="s3">= </span><span class="s1">Vec3</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">hpr </span><span class="s3">= </span><span class="s1">Vec3</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s6"># Camera Frustum Data</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fFrustum </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">focalLength </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">filmSize </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">filmOffset </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s2">def </span><span class="s1">setCamOffset</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xyz</span><span class="s3">, </span><span class="s1">hpr</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">xyz </span><span class="s3">= </span><span class="s1">xyz</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">hpr </span><span class="s3">= </span><span class="s1">hpr</span>
    <span class="s2">def </span><span class="s1">setCamFrustum</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">focalLength</span><span class="s3">, </span><span class="s1">filmSize</span><span class="s3">, </span><span class="s1">filmOffset</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fFrustum </span><span class="s3">= </span><span class="s5">1</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">focalLength </span><span class="s3">= </span><span class="s1">focalLength</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">filmSize </span><span class="s3">= </span><span class="s1">filmSize</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">filmOffset </span><span class="s3">= </span><span class="s1">filmOffset</span>


<span class="s2">def </span><span class="s1">createClusterClient</span><span class="s3">():</span>
    <span class="s6"># setup camera offsets based on cluster-config</span>
    <span class="s1">clusterConfig </span><span class="s3">= </span><span class="s1">base</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">GetString</span><span class="s3">(</span><span class="s4">'cluster-config'</span><span class="s3">, </span><span class="s4">'single-server'</span><span class="s3">)</span>
    <span class="s6"># No cluster config specified!</span>
    <span class="s2">if </span><span class="s1">clusterConfig </span><span class="s2">not in </span><span class="s1">ClientConfigs</span><span class="s3">:</span>
        <span class="s1">base</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span>
            <span class="s4">'createClusterClient: %s cluster-config is undefined.' </span><span class="s3">%</span>
            <span class="s1">clusterConfig</span><span class="s3">)</span>
        <span class="s2">return None</span>
    <span class="s6"># Get display config for each server in the cluster</span>
    <span class="s1">displayConfigs </span><span class="s3">= []</span>
    <span class="s1">configList </span><span class="s3">= </span><span class="s1">ClientConfigs</span><span class="s3">[</span><span class="s1">clusterConfig</span><span class="s3">]</span>
    <span class="s1">numConfigs </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">configList</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">numConfigs</span><span class="s3">):</span>
        <span class="s1">configData </span><span class="s3">= </span><span class="s1">configList</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
        <span class="s1">displayName </span><span class="s3">= </span><span class="s1">configData</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'display name'</span><span class="s3">, (</span><span class="s4">'display%d' </span><span class="s3">% </span><span class="s1">i</span><span class="s3">))</span>
        <span class="s1">displayMode </span><span class="s3">= </span><span class="s1">configData</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'display mode'</span><span class="s3">, </span><span class="s4">'server'</span><span class="s3">)</span>
        <span class="s6"># Init Cam Offset</span>
        <span class="s1">pos </span><span class="s3">= </span><span class="s1">configData</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'pos'</span><span class="s3">, </span><span class="s1">Vec3</span><span class="s3">(</span><span class="s5">0</span><span class="s3">))</span>
        <span class="s1">hpr </span><span class="s3">= </span><span class="s1">configData</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'hpr'</span><span class="s3">, </span><span class="s1">Vec3</span><span class="s3">(</span><span class="s5">0</span><span class="s3">))</span>
        <span class="s6"># Init Frustum if specified</span>
        <span class="s1">fl </span><span class="s3">= </span><span class="s1">configData</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'focal length'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">fs </span><span class="s3">= </span><span class="s1">configData</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'film size'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">fo </span><span class="s3">= </span><span class="s1">configData</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'film offset'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">displayMode </span><span class="s3">== </span><span class="s4">'client'</span><span class="s3">:</span>
            <span class="s6">#lens.setInterocularDistance(pos[0])</span>
            <span class="s1">base</span><span class="s3">.</span><span class="s1">cam</span><span class="s3">.</span><span class="s1">setPos</span><span class="s3">(</span><span class="s1">pos</span><span class="s3">)</span>
            <span class="s1">lens </span><span class="s3">= </span><span class="s1">base</span><span class="s3">.</span><span class="s1">cam</span><span class="s3">.</span><span class="s1">node</span><span class="s3">().</span><span class="s1">getLens</span><span class="s3">()</span>
            <span class="s1">lens</span><span class="s3">.</span><span class="s1">setViewHpr</span><span class="s3">(</span><span class="s1">hpr</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">fl </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">lens</span><span class="s3">.</span><span class="s1">setFocalLength</span><span class="s3">(</span><span class="s1">fl</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">fs </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">lens</span><span class="s3">.</span><span class="s1">setFilmSize</span><span class="s3">(</span><span class="s1">fs</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">fs</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
            <span class="s2">if </span><span class="s1">fo </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">lens</span><span class="s3">.</span><span class="s1">setFilmOffset</span><span class="s3">(</span><span class="s1">fo</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">fo</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">serverConfigName </span><span class="s3">= </span><span class="s4">'cluster-server-%s' </span><span class="s3">% </span><span class="s1">displayName</span>
            <span class="s1">serverName </span><span class="s3">= </span><span class="s1">base</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">GetString</span><span class="s3">(</span><span class="s1">serverConfigName</span><span class="s3">, </span><span class="s4">''</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">serverName </span><span class="s3">== </span><span class="s4">''</span><span class="s3">:</span>
                <span class="s1">base</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span>
                    <span class="s4">'%s undefined in Configrc: expected by %s display client.'</span><span class="s3">%</span>
                    <span class="s3">(</span><span class="s1">serverConfigName</span><span class="s3">, </span><span class="s1">clusterConfig</span><span class="s3">))</span>
                <span class="s1">base</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span><span class="s4">'%s will not be used.' </span><span class="s3">% </span><span class="s1">serverConfigName</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s6"># Daemon port</span>
                <span class="s1">serverDaemonPortConfigName </span><span class="s3">= (</span>
                    <span class="s4">'cluster-server-daemon-port-%s' </span><span class="s3">% </span><span class="s1">displayName</span><span class="s3">)</span>
                <span class="s1">serverDaemonPort </span><span class="s3">= </span><span class="s1">base</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">GetInt</span><span class="s3">(</span>
                    <span class="s1">serverDaemonPortConfigName</span><span class="s3">,</span>
                    <span class="s1">CLUSTER_DAEMON_PORT</span><span class="s3">)</span>
                <span class="s6"># TCP Server port</span>
                <span class="s1">serverMsgPortConfigName </span><span class="s3">= (</span>
                    <span class="s4">'cluster-server-msg-port-%s' </span><span class="s3">% </span><span class="s1">displayName</span><span class="s3">)</span>
                <span class="s1">serverMsgPort </span><span class="s3">= </span><span class="s1">base</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">GetInt</span><span class="s3">(</span><span class="s1">serverMsgPortConfigName</span><span class="s3">,</span>
                                                   <span class="s1">CLUSTER_SERVER_PORT</span><span class="s3">)</span>
                <span class="s1">cci </span><span class="s3">= </span><span class="s1">ClusterConfigItem</span><span class="s3">(</span>
                    <span class="s1">serverConfigName</span><span class="s3">,</span>
                    <span class="s1">serverName</span><span class="s3">,</span>
                    <span class="s1">serverDaemonPort</span><span class="s3">,</span>
                    <span class="s1">serverMsgPort</span><span class="s3">)</span>
                <span class="s6"># Init cam offset</span>
                <span class="s1">cci</span><span class="s3">.</span><span class="s1">setCamOffset</span><span class="s3">(</span><span class="s1">pos</span><span class="s3">, </span><span class="s1">hpr</span><span class="s3">)</span>
                <span class="s6"># Init frustum if specified</span>
                <span class="s2">if </span><span class="s1">fl </span><span class="s2">and </span><span class="s1">fs </span><span class="s2">and </span><span class="s1">fo</span><span class="s3">:</span>
                    <span class="s1">cci</span><span class="s3">.</span><span class="s1">setCamFrustum</span><span class="s3">(</span><span class="s1">fl</span><span class="s3">, </span><span class="s1">fs</span><span class="s3">, </span><span class="s1">fo</span><span class="s3">)</span>
                <span class="s1">displayConfigs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">cci</span><span class="s3">)</span>
    <span class="s6"># Create Cluster Managers (opening connections to servers)</span>
    <span class="s6"># Are the servers going to be synced?</span>
    <span class="s2">if </span><span class="s1">base</span><span class="s3">.</span><span class="s1">clusterSyncFlag</span><span class="s3">:</span>
        <span class="s1">base</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span><span class="s4">'autoflip'</span><span class="s3">)</span>
        <span class="s1">base</span><span class="s3">.</span><span class="s1">graphicsEngine</span><span class="s3">.</span><span class="s1">setAutoFlip</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">base</span><span class="s3">.</span><span class="s1">notify</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span><span class="s4">'ClusterClientSync'</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">ClusterClientSync</span><span class="s3">(</span><span class="s1">displayConfigs</span><span class="s3">, </span><span class="s1">base</span><span class="s3">.</span><span class="s1">clusterSyncFlag</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">ClusterClient</span><span class="s3">(</span><span class="s1">displayConfigs</span><span class="s3">, </span><span class="s1">base</span><span class="s3">.</span><span class="s1">clusterSyncFlag</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">DummyClusterClient</span><span class="s3">(</span><span class="s1">DirectObject</span><span class="s3">.</span><span class="s1">DirectObject</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; Dummy class to handle command strings when not in cluster mode &quot;&quot;&quot;</span>
    <span class="s1">notify </span><span class="s3">= </span><span class="s1">DirectNotifyGlobal</span><span class="s3">.</span><span class="s1">directNotify</span><span class="s3">.</span><span class="s1">newCategory</span><span class="s3">(</span><span class="s4">&quot;DummyClusterClient&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">__call__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">commandString</span><span class="s3">, </span><span class="s1">fLocally </span><span class="s3">= </span><span class="s5">1</span><span class="s3">, </span><span class="s1">serverList </span><span class="s3">= </span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">fLocally</span><span class="s3">:</span>
            <span class="s6"># Execute locally</span>
            <span class="s1">exec</span><span class="s3">(</span><span class="s1">commandString</span><span class="s3">, </span><span class="s1">__builtins__</span><span class="s3">)</span>


</pre>
</body>
</html>