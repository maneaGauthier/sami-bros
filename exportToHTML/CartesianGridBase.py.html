<html>
<head>
<title>CartesianGridBase.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
CartesianGridBase.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s0">import </span><span class="s1">Vec3</span>
<span class="s3"># Utility functions that are useful to both AI and client CartesianGrid code</span>

<span class="s0">class </span><span class="s1">CartesianGridBase</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">isValidZone</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">zoneId</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">checkBounds</span><span class="s2">(</span><span class="s1">self</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">zoneId</span><span class="s2">=</span><span class="s1">zoneId</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s2">((</span><span class="s1">zoneId </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">startingZone</span><span class="s2">) </span><span class="s0">or</span>
                <span class="s2">(</span><span class="s1">zoneId </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">startingZone </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gridSize </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gridSize </span><span class="s2">- </span><span class="s4">1</span><span class="s2">)):</span>
                <span class="s0">return </span><span class="s4">0</span>
            <span class="s0">return </span><span class="s4">1</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">style </span><span class="s2">== </span><span class="s5">&quot;Cartesian&quot;</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">checkBounds</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">style </span><span class="s2">== </span><span class="s5">&quot;CartesianStated&quot;</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">zoneId </span><span class="s2">&gt;= </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">zoneId </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">startingZone</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s4">1</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">checkBounds</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s4">0</span>

    <span class="s0">def </span><span class="s1">getZoneFromXYZ</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pos</span><span class="s2">, </span><span class="s1">wantRowAndCol</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s3"># NOTE: pos should be relative to our own grid origin</span>
        <span class="s3"># Convert a 3d position to a zone</span>
        <span class="s1">dx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cellWidth </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gridSize </span><span class="s2">* </span><span class="s4">.5</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">pos</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] + </span><span class="s1">dx</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">pos</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] + </span><span class="s1">dx</span>
        <span class="s1">col </span><span class="s2">= </span><span class="s1">x </span><span class="s2">// </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cellWidth</span>
        <span class="s1">row </span><span class="s2">= </span><span class="s1">y </span><span class="s2">// </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cellWidth</span>
        <span class="s3"># Compute which zone we are in</span>
        <span class="s1">zoneId </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">startingZone </span><span class="s2">+ ((</span><span class="s1">row </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gridSize</span><span class="s2">) + </span><span class="s1">col</span><span class="s2">))</span>

        <span class="s0">if </span><span class="s2">(</span><span class="s1">wantRowAndCol</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">zoneId</span><span class="s2">,</span><span class="s1">col</span><span class="s2">,</span><span class="s1">row</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">zoneId</span>

    <span class="s0">def </span><span class="s1">getGridSizeFromSphereRadius</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sphereRadius</span><span class="s2">, </span><span class="s1">cellWidth</span><span class="s2">, </span><span class="s1">gridRadius</span><span class="s2">):</span>
        <span class="s3"># NOTE: This ensures that the grid is at least a &quot;gridRadius&quot; number</span>
        <span class="s3"># of cells larger than the trigger sphere that loads the grid.  This</span>
        <span class="s3"># gives us some room to start setting interest to the grid before we</span>
        <span class="s3"># expect to see any objects on it.</span>
        <span class="s1">sphereRadius </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">sphereRadius</span><span class="s2">, </span><span class="s1">gridRadius</span><span class="s2">*</span><span class="s1">cellWidth</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s4">2 </span><span class="s2">* (</span><span class="s1">sphereRadius </span><span class="s2">// </span><span class="s1">cellWidth</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getGridSizeFromSphere</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sphereRadius</span><span class="s2">, </span><span class="s1">spherePos</span><span class="s2">, </span><span class="s1">cellWidth</span><span class="s2">, </span><span class="s1">gridRadius</span><span class="s2">):</span>
        <span class="s3"># NOTE: This ensures that the grid is at least a &quot;gridRadius&quot; number</span>
        <span class="s3"># of cells larger than the trigger sphere that loads the grid.  This</span>
        <span class="s3"># gives us some room to start setting interest to the grid before we</span>
        <span class="s3"># expect to see any objects on it.</span>
        <span class="s1">xMax </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">spherePos</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])+</span><span class="s1">sphereRadius</span>
        <span class="s1">yMax </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">spherePos</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])+</span><span class="s1">sphereRadius</span>
        <span class="s1">sphereRadius </span><span class="s2">= </span><span class="s1">Vec3</span><span class="s2">(</span><span class="s1">xMax</span><span class="s2">,</span><span class="s1">yMax</span><span class="s2">,</span><span class="s4">0</span><span class="s2">).</span><span class="s1">length</span><span class="s2">()</span>

        <span class="s3"># sphereRadius = max(sphereRadius, gridRadius*cellWidth)</span>
        <span class="s0">return </span><span class="s1">max</span><span class="s2">(</span><span class="s4">2 </span><span class="s2">* (</span><span class="s1">sphereRadius </span><span class="s2">// </span><span class="s1">cellWidth</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getZoneCellOrigin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">zoneId</span><span class="s2">):</span>
        <span class="s3"># It returns the origin of the zoneCell</span>
        <span class="s3"># Origin is the top-left corner of zoneCell</span>
        <span class="s1">dx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cellWidth </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gridSize </span><span class="s2">* </span><span class="s4">.5</span>
        <span class="s1">zone </span><span class="s2">= </span><span class="s1">zoneId </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">startingZone</span>
        <span class="s1">row </span><span class="s2">= </span><span class="s1">zone </span><span class="s2">// </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gridSize</span>
        <span class="s1">col </span><span class="s2">= </span><span class="s1">zone </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gridSize</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">col </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cellWidth </span><span class="s2">- </span><span class="s1">dx</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">row </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cellWidth </span><span class="s2">- </span><span class="s1">dx</span>

        <span class="s0">return </span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getZoneCellOriginCenter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">zoneId</span><span class="s2">):</span>
        <span class="s3"># Variant of the getZoneCellOrigin. It</span>
        <span class="s3"># returns the center of the zoneCell</span>
        <span class="s1">dx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cellWidth </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gridSize </span><span class="s2">* </span><span class="s4">.5</span>
        <span class="s1">center </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cellWidth </span><span class="s2">* </span><span class="s4">0.5</span>
        <span class="s1">zone </span><span class="s2">= </span><span class="s1">zoneId </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">startingZone</span>
        <span class="s1">row </span><span class="s2">= </span><span class="s1">zone </span><span class="s2">// </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gridSize</span>
        <span class="s1">col </span><span class="s2">= </span><span class="s1">zone </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gridSize</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">col </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cellWidth </span><span class="s2">- </span><span class="s1">dx </span><span class="s2">+ </span><span class="s1">center</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">row </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cellWidth </span><span class="s2">- </span><span class="s1">dx </span><span class="s2">+ </span><span class="s1">center</span>

        <span class="s0">return </span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s3">#--------------------------------------------------------------------------</span>
    <span class="s3"># Function:   utility function to get all zones in a ring of given radius</span>
    <span class="s3">#               around the given zoneId (so if given a zoneId 34342 and a</span>
    <span class="s3">#               radius of 3, a list of all zones exactly 3 grids away from</span>
    <span class="s3">#               zone 34342 will be returned)</span>
    <span class="s3"># Parameters: zoneId, center zone to find surrounding zones of</span>
    <span class="s3">#             radius, how far from zoneId to find zones of for it them</span>
    <span class="s3"># Changes:</span>
    <span class="s3"># Returns:</span>
    <span class="s3">#--------------------------------------------------------------------------</span>
    <span class="s0">def </span><span class="s1">getConcentricZones</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">zoneId</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">):</span>
        <span class="s1">zones </span><span class="s2">= []</span>
        <span class="s3">#currZone = zoneId + radius</span>
        <span class="s3">#numZones = (2 * radius * 8) + 2</span>
        <span class="s3"># start at upper left</span>
        <span class="s1">zone </span><span class="s2">= </span><span class="s1">zoneId </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">startingZone</span>
        <span class="s1">row </span><span class="s2">= </span><span class="s1">zone </span><span class="s2">// </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gridSize</span>
        <span class="s1">col </span><span class="s2">= </span><span class="s1">zone </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gridSize</span>

        <span class="s1">leftOffset </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">col</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">)</span>
        <span class="s1">rightOffset </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">gridSize </span><span class="s2">- (</span><span class="s1">col </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">), </span><span class="s1">radius</span><span class="s2">)</span>
        <span class="s1">topOffset </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">row</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">)</span>
        <span class="s1">bottomOffset </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">gridSize </span><span class="s2">- (</span><span class="s1">row </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">), </span><span class="s1">radius</span><span class="s2">)</span>

        <span class="s3">#print &quot;starting examination of grid circle of radius %s&quot;%radius</span>
        <span class="s1">ulZone </span><span class="s2">= </span><span class="s1">zoneId </span><span class="s2">- </span><span class="s1">leftOffset </span><span class="s2">- </span><span class="s1">topOffset </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gridSize</span>
        <span class="s3">#print &quot;left offset is %s and radius is %s&quot;%(leftOffset,radius)</span>
        <span class="s0">for </span><span class="s1">currCol </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">rightOffset </span><span class="s2">+ </span><span class="s1">leftOffset </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)):</span>
            <span class="s0">if </span><span class="s2">((</span><span class="s1">currCol </span><span class="s2">== </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">leftOffset </span><span class="s2">== </span><span class="s1">radius</span><span class="s2">) </span><span class="s0">or </span><span class="s2">(</span><span class="s1">currCol </span><span class="s2">== </span><span class="s1">rightOffset </span><span class="s2">+ </span><span class="s1">leftOffset </span><span class="s0">and </span><span class="s1">rightOffset </span><span class="s2">== </span><span class="s1">radius</span><span class="s2">)):</span>
                <span class="s3"># at either left or right edge of area, look at all rows</span>
                <span class="s1">possibleRows </span><span class="s2">= </span><span class="s1">range</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">bottomOffset </span><span class="s2">+ </span><span class="s1">topOffset </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s3"># in a middle column, only look at top and bottom rows</span>
                <span class="s1">possibleRows </span><span class="s2">= []</span>
                <span class="s0">if </span><span class="s2">(</span><span class="s1">topOffset </span><span class="s2">== </span><span class="s1">radius</span><span class="s2">):</span>
                    <span class="s1">possibleRows</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s2">(</span><span class="s1">bottomOffset </span><span class="s2">== </span><span class="s1">radius</span><span class="s2">):</span>
                    <span class="s1">possibleRows</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">bottomOffset </span><span class="s2">+ </span><span class="s1">topOffset</span><span class="s2">)</span>
            <span class="s3">#print &quot;on column %s and looking at rows %s&quot;%(currCol,possibleRows)</span>
            <span class="s0">for </span><span class="s1">currRow </span><span class="s0">in </span><span class="s1">possibleRows</span><span class="s2">:</span>
                <span class="s1">newZone </span><span class="s2">= </span><span class="s1">ulZone </span><span class="s2">+ (</span><span class="s1">currRow </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gridSize</span><span class="s2">) + </span><span class="s1">currCol</span>
                <span class="s1">zones</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">newZone</span><span class="s2">))</span>
                <span class="s3">#print &quot;   examining zone %s&quot;%newZone</span>
        <span class="s0">return </span><span class="s1">zones</span>
</pre>
</body>
</html>