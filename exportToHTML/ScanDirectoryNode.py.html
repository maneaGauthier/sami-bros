<html>
<head>
<title>ScanDirectoryNode.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ScanDirectoryNode.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
.. deprecated:: 1.10.0 
   The p3d packaging system has been replaced with the new setuptools-based 
   system.  See the :ref:`distribution` manual section. 
&quot;&quot;&quot;</span>
<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">&quot;ScanDirectoryNode&quot;</span><span class="s2">]</span>

<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s1">VirtualFileSystem</span><span class="s2">, </span><span class="s1">VirtualFileMountSystem</span><span class="s2">, </span><span class="s1">Filename</span><span class="s2">, </span><span class="s1">TiXmlDocument</span>
<span class="s1">vfs </span><span class="s2">= </span><span class="s1">VirtualFileSystem</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>

<span class="s4">class </span><span class="s1">ScanDirectoryNode</span><span class="s2">:</span>
    <span class="s0">&quot;&quot;&quot; This class is used to scan a list of files on disk. &quot;&quot;&quot;</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">ignoreUsageXml </span><span class="s2">= </span><span class="s4">False</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pathname </span><span class="s2">= </span><span class="s1">pathname</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">filenames </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fileSize </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">nested </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">nestedSize </span><span class="s2">= </span><span class="s5">0</span>

        <span class="s1">xusage </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">if not </span><span class="s1">ignoreUsageXml</span><span class="s2">:</span>
            <span class="s6"># Look for a usage.xml file in this directory.  If we find</span>
            <span class="s6"># one, we read it for the file size and then stop here, as</span>
            <span class="s6"># an optimization.</span>
            <span class="s1">usageFilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">, </span><span class="s3">'usage.xml'</span><span class="s2">)</span>
            <span class="s1">doc </span><span class="s2">= </span><span class="s1">TiXmlDocument</span><span class="s2">(</span><span class="s1">usageFilename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
            <span class="s4">if </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">LoadFile</span><span class="s2">():</span>
                <span class="s1">xusage </span><span class="s2">= </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'usage'</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">xusage</span><span class="s2">:</span>
                    <span class="s1">diskSpace </span><span class="s2">= </span><span class="s1">xusage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'disk_space'</span><span class="s2">)</span>
                    <span class="s4">try</span><span class="s2">:</span>
                        <span class="s1">diskSpace </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">diskSpace </span><span class="s4">or </span><span class="s3">''</span><span class="s2">)</span>
                    <span class="s4">except </span><span class="s1">ValueError</span><span class="s2">:</span>
                        <span class="s1">diskSpace </span><span class="s2">= </span><span class="s4">None</span>
                    <span class="s4">if </span><span class="s1">diskSpace </span><span class="s4">is not None</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">fileSize </span><span class="s2">= </span><span class="s1">diskSpace</span>
                        <span class="s4">return</span>

        <span class="s1">files </span><span class="s2">= </span><span class="s1">vfs</span><span class="s2">.</span><span class="s1">scanDirectory</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pathname</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">files </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">files </span><span class="s2">= []</span>
        <span class="s4">for </span><span class="s1">vfile </span><span class="s4">in </span><span class="s1">files</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">vfile</span><span class="s2">, </span><span class="s3">'getMount'</span><span class="s2">):</span>
                <span class="s4">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">vfile</span><span class="s2">.</span><span class="s1">getMount</span><span class="s2">(), </span><span class="s1">VirtualFileMountSystem</span><span class="s2">):</span>
                    <span class="s6"># Not a real file; ignore it.</span>
                    <span class="s4">continue</span>

            <span class="s4">if </span><span class="s1">vfile</span><span class="s2">.</span><span class="s1">isDirectory</span><span class="s2">():</span>
                <span class="s6"># A nested directory.</span>
                <span class="s1">subdir </span><span class="s2">= </span><span class="s1">ScanDirectoryNode</span><span class="s2">(</span><span class="s1">vfile</span><span class="s2">.</span><span class="s1">getFilename</span><span class="s2">(), </span><span class="s1">ignoreUsageXml </span><span class="s2">= </span><span class="s1">ignoreUsageXml</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">nested</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">subdir</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">nestedSize </span><span class="s2">+= </span><span class="s1">subdir</span><span class="s2">.</span><span class="s1">getTotalSize</span><span class="s2">()</span>

            <span class="s4">elif </span><span class="s1">vfile</span><span class="s2">.</span><span class="s1">isRegularFile</span><span class="s2">():</span>
                <span class="s6"># A nested file.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">filenames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">vfile</span><span class="s2">.</span><span class="s1">getFilename</span><span class="s2">())</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">fileSize </span><span class="s2">+= </span><span class="s1">vfile</span><span class="s2">.</span><span class="s1">getFileSize</span><span class="s2">()</span>

            <span class="s4">else</span><span class="s2">:</span>
                <span class="s6"># Some other wacky file thing.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">filenames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">vfile</span><span class="s2">.</span><span class="s1">getFilename</span><span class="s2">())</span>

        <span class="s4">if </span><span class="s1">xusage</span><span class="s2">:</span>
            <span class="s6"># Now update the usage.xml file with the newly-determined</span>
            <span class="s6"># disk space.</span>
            <span class="s1">xusage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'disk_space'</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">getTotalSize</span><span class="s2">()))</span>
            <span class="s1">tfile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">), </span><span class="s3">'.xml'</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">SaveFile</span><span class="s2">(</span><span class="s1">tfile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()):</span>
                <span class="s1">tfile</span><span class="s2">.</span><span class="s1">renameTo</span><span class="s2">(</span><span class="s1">usageFilename</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">getTotalSize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">nestedSize </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fileSize</span>

    <span class="s4">def </span><span class="s1">extractSubdir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pathname</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Finds the ScanDirectoryNode within this node that 
        corresponds to the indicated full pathname.  If it is found, 
        removes it from its parent, and returns it.  If it is not 
        found, returns None. &quot;&quot;&quot;</span>

        <span class="s6"># We could be a little smarter here, but why bother.  Just</span>
        <span class="s6"># recursively search all children.</span>
        <span class="s4">for </span><span class="s1">subdir </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">nested</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">subdir</span><span class="s2">.</span><span class="s1">pathname </span><span class="s2">== </span><span class="s1">pathname</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">nested</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">subdir</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">nestedSize </span><span class="s2">-= </span><span class="s1">subdir</span><span class="s2">.</span><span class="s1">getTotalSize</span><span class="s2">()</span>
                <span class="s4">return </span><span class="s1">subdir</span>

            <span class="s1">result </span><span class="s2">= </span><span class="s1">subdir</span><span class="s2">.</span><span class="s1">extractSubdir</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">result</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">nestedSize </span><span class="s2">-= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">getTotalSize</span><span class="s2">()</span>
                <span class="s4">if </span><span class="s1">subdir</span><span class="s2">.</span><span class="s1">getTotalSize</span><span class="s2">() == </span><span class="s5">0</span><span class="s2">:</span>
                    <span class="s6"># No other files in the subdirectory that contains</span>
                    <span class="s6"># this package; remove it too.</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">nested</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">subdir</span><span class="s2">)</span>
                <span class="s4">return </span><span class="s1">result</span>

        <span class="s4">return None</span>


</pre>
</body>
</html>