<html>
<head>
<title>FrameProfiler.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
FrameProfiler.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">directnotify</span><span class="s2">.</span><span class="s1">DirectNotifyGlobal </span><span class="s0">import </span><span class="s1">directNotify</span>
<span class="s0">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">fsm</span><span class="s2">.</span><span class="s1">StatePush </span><span class="s0">import </span><span class="s1">FunctionCall</span>
<span class="s0">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase</span><span class="s2">.</span><span class="s1">PythonUtil </span><span class="s0">import </span><span class="s1">formatTimeExact</span><span class="s2">, </span><span class="s1">normalDistrib</span>
<span class="s0">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">task </span><span class="s0">import </span><span class="s1">Task</span>

<span class="s0">class </span><span class="s1">FrameProfiler</span><span class="s2">:</span>
    <span class="s1">notify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s3">'FrameProfiler'</span><span class="s2">)</span>

    <span class="s4"># because of precision requirements, all times related to the profile/log</span>
    <span class="s4"># schedule are stored as integers</span>
    <span class="s1">Minute </span><span class="s2">= </span><span class="s5">60</span>
    <span class="s1">Hour </span><span class="s2">= </span><span class="s5">60 </span><span class="s2">* </span><span class="s1">Minute</span>
    <span class="s1">Day </span><span class="s2">= </span><span class="s5">24 </span><span class="s2">* </span><span class="s1">Hour</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">Hour </span><span class="s2">= </span><span class="s1">FrameProfiler</span><span class="s2">.</span><span class="s1">Hour</span>
        <span class="s4"># how long to wait between frame profiles</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_period </span><span class="s2">= </span><span class="s5">2 </span><span class="s2">* </span><span class="s1">FrameProfiler</span><span class="s2">.</span><span class="s1">Minute</span>
        <span class="s0">if </span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'frequent-frame-profiles'</span><span class="s2">, </span><span class="s5">0</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_period </span><span class="s2">= </span><span class="s5">1 </span><span class="s2">* </span><span class="s1">FrameProfiler</span><span class="s2">.</span><span class="s1">Minute</span>
        <span class="s4"># used to prevent profile from being taken exactly every 'period' seconds</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_jitterMagnitude </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_period </span><span class="s2">* </span><span class="s5">.75</span>
        <span class="s4"># when to log output</span>
        <span class="s4"># each entry must be an integer multiple of all previous entries</span>
        <span class="s4"># as well as an integer multiple of the period</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_logSchedule </span><span class="s2">= [ </span><span class="s5">1 </span><span class="s2">* </span><span class="s1">FrameProfiler</span><span class="s2">.</span><span class="s1">Hour</span><span class="s2">,</span>
                              <span class="s5">4 </span><span class="s2">* </span><span class="s1">FrameProfiler</span><span class="s2">.</span><span class="s1">Hour</span><span class="s2">,</span>
                             <span class="s5">12 </span><span class="s2">* </span><span class="s1">FrameProfiler</span><span class="s2">.</span><span class="s1">Hour</span><span class="s2">,</span>
                              <span class="s5">1 </span><span class="s2">* </span><span class="s1">FrameProfiler</span><span class="s2">.</span><span class="s1">Day</span><span class="s2">,</span>
                              <span class="s2">] </span><span class="s4"># day schedule proceeds as 1, 2, 4, 8 days, etc.</span>
        <span class="s0">if </span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'frequent-frame-profiles'</span><span class="s2">, </span><span class="s5">0</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_logSchedule </span><span class="s2">= [ </span><span class="s5">1  </span><span class="s2">* </span><span class="s1">FrameProfiler</span><span class="s2">.</span><span class="s1">Minute</span><span class="s2">,</span>
                                  <span class="s5">4  </span><span class="s2">* </span><span class="s1">FrameProfiler</span><span class="s2">.</span><span class="s1">Minute</span><span class="s2">,</span>
                                  <span class="s5">12 </span><span class="s2">* </span><span class="s1">FrameProfiler</span><span class="s2">.</span><span class="s1">Minute</span><span class="s2">,</span>
                                  <span class="s5">24 </span><span class="s2">* </span><span class="s1">FrameProfiler</span><span class="s2">.</span><span class="s1">Minute</span><span class="s2">,</span>
                                  <span class="s2">]</span>
        <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_logSchedule</span><span class="s2">:</span>
            <span class="s4">#assert isInteger(t)</span>
            <span class="s4"># make sure the period is evenly divisible into each element of the log schedule</span>
            <span class="s0">assert </span><span class="s2">(</span><span class="s1">t </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_period</span><span class="s2">) == </span><span class="s5">0</span>
        <span class="s4"># make sure each element of the schedule is evenly divisible into each subsequent element</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_logSchedule</span><span class="s2">)):</span>
            <span class="s1">e </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_logSchedule</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_logSchedule</span><span class="s2">)):</span>
                <span class="s0">assert </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_logSchedule</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] % </span><span class="s1">e</span><span class="s2">) == </span><span class="s5">0</span>
        <span class="s4">#assert isInteger(self._period)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_enableFC </span><span class="s2">= </span><span class="s1">FunctionCall</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_setEnabled</span><span class="s2">, </span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">getProfileFramesSV</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_enableFC</span><span class="s2">.</span><span class="s1">pushCurrentState</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_enableFC</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_enableFC</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_setEnabled</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">enabled</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">enabled</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">'frame profiler started'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_startTime </span><span class="s2">= </span><span class="s1">globalClock</span><span class="s2">.</span><span class="s1">getFrameTime</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_profileCounter </span><span class="s2">= </span><span class="s5">0</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_jitter </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_period2aggregateProfile </span><span class="s2">= {}</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2session </span><span class="s2">= {}</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2task </span><span class="s2">= {}</span>
            <span class="s4"># don't profile process startup</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_task </span><span class="s2">= </span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">doMethodLater</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_period</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_scheduleNextProfileDoLater</span><span class="s2">,</span>
                                               <span class="s3">'FrameProfilerStart-%s' </span><span class="s2">% </span><span class="s1">serialNum</span><span class="s2">())</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_task</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">()</span>
            <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_task</span>
            <span class="s0">for </span><span class="s1">session </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_period2aggregateProfile</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
                <span class="s1">session</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>
            <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_period2aggregateProfile</span>
            <span class="s0">for </span><span class="s1">task </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2task</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
                <span class="s1">task</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">()</span>
            <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2task</span>
            <span class="s0">for </span><span class="s1">session </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2session</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
                <span class="s1">session</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>
            <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2session</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">'frame profiler stopped'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_scheduleNextProfileDoLater</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">task</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_scheduleNextProfile</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">task</span><span class="s2">.</span><span class="s1">done</span>

    <span class="s0">def </span><span class="s1">_scheduleNextProfile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_profileCounter </span><span class="s2">+= </span><span class="s5">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_timeElapsed </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_profileCounter </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_period</span>
        <span class="s4">#assert isInteger(self._timeElapsed)</span>
        <span class="s1">time </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_startTime </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_timeElapsed</span>

        <span class="s4"># vary the actual delay between profiles by a random amount to prevent interaction</span>
        <span class="s4"># with periodic events</span>
        <span class="s1">jitter </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_jitter</span>
        <span class="s0">if </span><span class="s1">jitter </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">jitter </span><span class="s2">= </span><span class="s1">normalDistrib</span><span class="s2">(-</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_jitterMagnitude</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_jitterMagnitude</span><span class="s2">)</span>
            <span class="s1">time </span><span class="s2">+= </span><span class="s1">jitter</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">time </span><span class="s2">-= </span><span class="s1">jitter</span>
            <span class="s1">jitter </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_jitter </span><span class="s2">= </span><span class="s1">jitter</span>

        <span class="s1">sessionId </span><span class="s2">= </span><span class="s1">serialNum</span><span class="s2">()</span>
        <span class="s1">session </span><span class="s2">= </span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">getProfileSession</span><span class="s2">(</span><span class="s3">'FrameProfile-%s' </span><span class="s2">% </span><span class="s1">sessionId</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2session</span><span class="s2">[</span><span class="s1">sessionId</span><span class="s2">] = </span><span class="s1">session</span>
        <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">profileFrames</span><span class="s2">(</span><span class="s1">num</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">session</span><span class="s2">=</span><span class="s1">session</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">=</span><span class="s1">Functor</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_analyzeResults</span><span class="s2">, </span><span class="s1">sessionId</span><span class="s2">))</span>

        <span class="s4"># schedule the next profile</span>
        <span class="s1">delay </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">time </span><span class="s2">- </span><span class="s1">globalClock</span><span class="s2">.</span><span class="s1">getFrameTime</span><span class="s2">(), </span><span class="s5">0.</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_task </span><span class="s2">= </span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">doMethodLater</span><span class="s2">(</span><span class="s1">delay</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_scheduleNextProfileDoLater</span><span class="s2">,</span>
                                           <span class="s3">'FrameProfiler-%s' </span><span class="s2">% </span><span class="s1">serialNum</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">_analyzeResults</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sessionId</span><span class="s2">):</span>
        <span class="s4"># do the analysis in a task 1) to separate the processing from the profiled frame,</span>
        <span class="s4"># and 2) to get the processing to show up in a named task instead of in the taskMgr</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2task</span><span class="s2">[</span><span class="s1">sessionId</span><span class="s2">] = </span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span>
            <span class="s1">Functor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_doAnalysis</span><span class="s2">, </span><span class="s1">sessionId</span><span class="s2">), </span><span class="s3">'FrameProfilerAnalysis-%s' </span><span class="s2">% </span><span class="s1">sessionId</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_doAnalysis</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sessionId</span><span class="s2">, </span><span class="s1">task</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">task</span><span class="s2">, </span><span class="s3">'_generator'</span><span class="s2">):</span>
            <span class="s1">gen </span><span class="s2">= </span><span class="s1">task</span><span class="s2">.</span><span class="s1">_generator</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">gen </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_doAnalysisGen</span><span class="s2">(</span><span class="s1">sessionId</span><span class="s2">)</span>
            <span class="s1">task</span><span class="s2">.</span><span class="s1">_generator </span><span class="s2">= </span><span class="s1">gen</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">gen</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">result </span><span class="s2">== </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">done</span><span class="s2">:</span>
            <span class="s0">del </span><span class="s1">task</span><span class="s2">.</span><span class="s1">_generator</span>
        <span class="s0">return </span><span class="s1">result</span>

    <span class="s0">def </span><span class="s1">_doAnalysisGen</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sessionId</span><span class="s2">):</span>
        <span class="s4"># generator to limit max number of profile loggings per frame</span>
        <span class="s1">p2ap </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_period2aggregateProfile</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_id2task</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">sessionId</span><span class="s2">)</span>
        <span class="s1">session </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id2session</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">sessionId</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">session</span><span class="s2">.</span><span class="s1">profileSucceeded</span><span class="s2">():</span>
            <span class="s4"># always add this profile to the first aggregated profile</span>
            <span class="s1">period </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_logSchedule</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">period </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_period2aggregateProfile</span><span class="s2">:</span>
                <span class="s1">p2ap</span><span class="s2">[</span><span class="s1">period</span><span class="s2">] = </span><span class="s1">session</span><span class="s2">.</span><span class="s1">getReference</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">p2ap</span><span class="s2">[</span><span class="s1">period</span><span class="s2">].</span><span class="s1">aggregate</span><span class="s2">(</span><span class="s1">session</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">'frame profile did not succeed'</span><span class="s2">)</span>

        <span class="s1">session</span><span class="s2">.</span><span class="s1">release</span><span class="s2">()</span>
        <span class="s1">session </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">counter </span><span class="s2">= </span><span class="s5">0</span>

        <span class="s4"># log profiles when it's time, and aggregate them upwards into the</span>
        <span class="s4"># next-longer profile</span>
        <span class="s0">for </span><span class="s1">pi </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_logSchedule</span><span class="s2">)):</span>
            <span class="s1">period </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_logSchedule</span><span class="s2">[</span><span class="s1">pi</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_timeElapsed </span><span class="s2">% </span><span class="s1">period</span><span class="s2">) == </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">period </span><span class="s0">in </span><span class="s1">p2ap</span><span class="s2">:</span>
                    <span class="s4"># delay until the next frame if we've already processed N profiles this frame</span>
                    <span class="s0">if </span><span class="s1">counter </span><span class="s2">&gt;= </span><span class="s5">3</span><span class="s2">:</span>
                        <span class="s1">counter </span><span class="s2">= </span><span class="s5">0</span>
                        <span class="s0">yield </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">'aggregate profile of sampled frames over last %s</span><span class="s0">\n</span><span class="s3">%s' </span><span class="s2">%</span>
                                     <span class="s2">(</span><span class="s1">formatTimeExact</span><span class="s2">(</span><span class="s1">period</span><span class="s2">), </span><span class="s1">p2ap</span><span class="s2">[</span><span class="s1">period</span><span class="s2">].</span><span class="s1">getResults</span><span class="s2">()))</span>
                    <span class="s1">counter </span><span class="s2">+= </span><span class="s5">1</span>
                    <span class="s4"># aggregate this profile into the next larger profile</span>
                    <span class="s1">nextIndex </span><span class="s2">= </span><span class="s1">pi </span><span class="s2">+ </span><span class="s5">1</span>
                    <span class="s0">if </span><span class="s1">nextIndex </span><span class="s2">&gt;= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_logSchedule</span><span class="s2">):</span>
                        <span class="s4"># if we're adding a new period to the end of the log period table,</span>
                        <span class="s4"># set it to double the duration of the current longest period</span>
                        <span class="s1">nextPeriod </span><span class="s2">= </span><span class="s1">period </span><span class="s2">* </span><span class="s5">2</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">_logSchedule</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">nextPeriod</span><span class="s2">)</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">nextPeriod </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_logSchedule</span><span class="s2">[</span><span class="s1">nextIndex</span><span class="s2">]</span>
                    <span class="s0">if </span><span class="s1">nextPeriod </span><span class="s0">not in </span><span class="s1">p2ap</span><span class="s2">:</span>
                        <span class="s1">p2ap</span><span class="s2">[</span><span class="s1">nextPeriod</span><span class="s2">] = </span><span class="s1">p2ap</span><span class="s2">[</span><span class="s1">period</span><span class="s2">].</span><span class="s1">getReference</span><span class="s2">()</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">p2ap</span><span class="s2">[</span><span class="s1">nextPeriod</span><span class="s2">].</span><span class="s1">aggregate</span><span class="s2">(</span><span class="s1">p2ap</span><span class="s2">[</span><span class="s1">period</span><span class="s2">])</span>
                    <span class="s4"># this profile is now represented in the next larger profile</span>
                    <span class="s4"># throw it out</span>
                    <span class="s1">p2ap</span><span class="s2">[</span><span class="s1">period</span><span class="s2">].</span><span class="s1">release</span><span class="s2">()</span>
                    <span class="s0">del </span><span class="s1">p2ap</span><span class="s2">[</span><span class="s1">period</span><span class="s2">]</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s4"># current time is not divisible evenly into selected period, and all higher</span>
                <span class="s4"># periods are multiples of this one</span>
                <span class="s0">break</span>

        <span class="s0">yield </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">done</span>
</pre>
</body>
</html>