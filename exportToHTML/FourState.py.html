<html>
<head>
<title>FourState.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
FourState.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Contains the FourState class.&quot;&quot;&quot;</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">'FourState'</span><span class="s2">]</span>

<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">directnotify </span><span class="s4">import </span><span class="s1">DirectNotifyGlobal</span>
<span class="s5">#import DistributedObject</span>
<span class="s4">from </span><span class="s2">. </span><span class="s4">import </span><span class="s1">ClassicFSM</span>
<span class="s4">from </span><span class="s2">. </span><span class="s4">import </span><span class="s1">State</span>


<span class="s4">class </span><span class="s1">FourState</span><span class="s2">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Generic four state ClassicFSM base class. 
 
    This is a mix-in class that expects that your derived class 
    is a DistributedObject. 
 
    Inherit from FourStateFSM and pass in your states.  Two of 
    the states should be oposites of each other and the other 
    two should be the transition states between the first two. 
    E.g:: 
 
                    +--------+ 
                 --&gt;| closed | -- 
                |   +--------+   | 
                |                | 
                |                v 
          +---------+       +---------+ 
          | closing |&lt;-----&gt;| opening | 
          +---------+       +---------+ 
                ^                | 
                |                | 
                |    +------+    | 
                 ----| open |&lt;--- 
                     +------+ 
 
    There is a fifth off state, but that is an implementation 
    detail (and that's why it's not called a five state ClassicFSM). 
 
    I found that this pattern repeated in several things I was 
    working on, so this base class was created. 
    &quot;&quot;&quot;</span>
    <span class="s1">notify </span><span class="s2">= </span><span class="s1">DirectNotifyGlobal</span><span class="s2">.</span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s3">'FourState'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">names</span><span class="s2">, </span><span class="s1">durations </span><span class="s2">= [</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s4">None</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">]):</span>
        <span class="s0">&quot;&quot;&quot; 
        Names is a list of state names.  Some examples are:: 
 
            ['off', 'opening', 'open', 'closing', 'closed',] 
 
            ['off', 'locking', 'locked', 'unlocking', 'unlocked',] 
 
            ['off', 'deactivating', 'deactive', 'activating', 'activated',] 
 
        durations is a list of time values (floats) or None values. 
 
        Each list must have five entries. 
 
        .. rubric:: More Details 
 
        Here is a diagram showing the where the names from the list 
        are used:: 
 
            +---------+ 
            | 0 (off) |----&gt; (any other state and vice versa). 
            +---------+ 
 
                       +--------+ 
                    --&gt;| 4 (on) |--- 
                   |   +--------+   | 
                   |                | 
                   |                v 
             +---------+       +---------+ 
             | 3 (off) |&lt;-----&gt;| 1 (off) | 
             +---------+       +---------+ 
                   ^                | 
                   |                | 
                   |  +---------+   | 
                    --| 2 (off) |&lt;-- 
                      +---------+ 
 
        Each states also has an associated on or off value.  The only 
        state that is 'on' is state 4.  So, the transition states 
        between off and on (states 1 and 3) are also considered 
        off (and so is state 2 which is oposite of 4 and therefore 
        oposite of 'on'). 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">stateIndex </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__debugPrint</span><span class="s2">(</span><span class="s3">&quot;FourState(names=%s)&quot;</span><span class="s2">%(</span><span class="s1">names</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">track </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">stateTime </span><span class="s2">= </span><span class="s6">0.0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">names </span><span class="s2">= </span><span class="s1">names</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">durations </span><span class="s2">= </span><span class="s1">durations</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">states </span><span class="s2">= {</span>
            <span class="s6">0</span><span class="s2">: </span><span class="s1">State</span><span class="s2">.</span><span class="s1">State</span><span class="s2">(</span><span class="s1">names</span><span class="s2">[</span><span class="s6">0</span><span class="s2">],</span>
                           <span class="s1">self</span><span class="s2">.</span><span class="s1">enterState0</span><span class="s2">,</span>
                           <span class="s1">self</span><span class="s2">.</span><span class="s1">exitState0</span><span class="s2">,</span>
                           <span class="s2">[</span><span class="s1">names</span><span class="s2">[</span><span class="s6">1</span><span class="s2">],</span>
                           <span class="s1">names</span><span class="s2">[</span><span class="s6">2</span><span class="s2">],</span>
                           <span class="s1">names</span><span class="s2">[</span><span class="s6">3</span><span class="s2">],</span>
                           <span class="s1">names</span><span class="s2">[</span><span class="s6">4</span><span class="s2">]]),</span>
            <span class="s6">1</span><span class="s2">: </span><span class="s1">State</span><span class="s2">.</span><span class="s1">State</span><span class="s2">(</span><span class="s1">names</span><span class="s2">[</span><span class="s6">1</span><span class="s2">],</span>
                           <span class="s1">self</span><span class="s2">.</span><span class="s1">enterState1</span><span class="s2">,</span>
                           <span class="s1">self</span><span class="s2">.</span><span class="s1">exitState1</span><span class="s2">,</span>
                           <span class="s2">[</span><span class="s1">names</span><span class="s2">[</span><span class="s6">2</span><span class="s2">], </span><span class="s1">names</span><span class="s2">[</span><span class="s6">3</span><span class="s2">]]),</span>
            <span class="s6">2</span><span class="s2">: </span><span class="s1">State</span><span class="s2">.</span><span class="s1">State</span><span class="s2">(</span><span class="s1">names</span><span class="s2">[</span><span class="s6">2</span><span class="s2">],</span>
                           <span class="s1">self</span><span class="s2">.</span><span class="s1">enterState2</span><span class="s2">,</span>
                           <span class="s1">self</span><span class="s2">.</span><span class="s1">exitState2</span><span class="s2">,</span>
                           <span class="s2">[</span><span class="s1">names</span><span class="s2">[</span><span class="s6">3</span><span class="s2">]]),</span>
            <span class="s6">3</span><span class="s2">: </span><span class="s1">State</span><span class="s2">.</span><span class="s1">State</span><span class="s2">(</span><span class="s1">names</span><span class="s2">[</span><span class="s6">3</span><span class="s2">],</span>
                           <span class="s1">self</span><span class="s2">.</span><span class="s1">enterState3</span><span class="s2">,</span>
                           <span class="s1">self</span><span class="s2">.</span><span class="s1">exitState3</span><span class="s2">,</span>
                           <span class="s2">[</span><span class="s1">names</span><span class="s2">[</span><span class="s6">4</span><span class="s2">], </span><span class="s1">names</span><span class="s2">[</span><span class="s6">1</span><span class="s2">]]),</span>
            <span class="s6">4</span><span class="s2">: </span><span class="s1">State</span><span class="s2">.</span><span class="s1">State</span><span class="s2">(</span><span class="s1">names</span><span class="s2">[</span><span class="s6">4</span><span class="s2">],</span>
                           <span class="s1">self</span><span class="s2">.</span><span class="s1">enterState4</span><span class="s2">,</span>
                           <span class="s1">self</span><span class="s2">.</span><span class="s1">exitState4</span><span class="s2">,</span>
                           <span class="s2">[</span><span class="s1">names</span><span class="s2">[</span><span class="s6">1</span><span class="s2">]]),</span>
            <span class="s2">}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fsm </span><span class="s2">= </span><span class="s1">ClassicFSM</span><span class="s2">.</span><span class="s1">ClassicFSM</span><span class="s2">(</span><span class="s3">'FourState'</span><span class="s2">,</span>
                           <span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">states</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()),</span>
                           <span class="s5"># Initial State</span>
                           <span class="s1">names</span><span class="s2">[</span><span class="s6">0</span><span class="s2">],</span>
                           <span class="s5"># Final State</span>
                           <span class="s1">names</span><span class="s2">[</span><span class="s6">0</span><span class="s2">],</span>
                          <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fsm</span><span class="s2">.</span><span class="s1">enterInitialState</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">setTrack</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">track</span><span class="s2">):</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__debugPrint</span><span class="s2">(</span><span class="s3">&quot;setTrack(track=%s)&quot;</span><span class="s2">%(</span><span class="s1">track</span><span class="s2">,))</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">track </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">track</span><span class="s2">.</span><span class="s1">pause</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">track </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">if </span><span class="s1">track </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">track</span><span class="s2">.</span><span class="s1">start</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">stateTime</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">track </span><span class="s2">= </span><span class="s1">track</span>

    <span class="s4">def </span><span class="s1">enterStateN</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stateIndex</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">stateIndex </span><span class="s2">= </span><span class="s1">stateIndex</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">duration </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">durations</span><span class="s2">[</span><span class="s1">stateIndex</span><span class="s2">] </span><span class="s4">or </span><span class="s6">0.0</span>

    <span class="s5"># The AI is the authority on setting the On value.</span>
    <span class="s5"># If the client wants the state changed it needs to</span>
    <span class="s5"># send a request to the AI.</span>
    <span class="s5">#def setIsOn(self, isOn):</span>
    <span class="s5">#    assert self.__debugPrint(&quot;setIsOn(isOn=%s)&quot;%(isOn,))</span>
    <span class="s5">#    pass</span>

    <span class="s4">def </span><span class="s1">isOn</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__debugPrint</span><span class="s2">(</span><span class="s3">&quot;isOn() returning %s (stateIndex=%s)&quot;</span><span class="s2">%(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">stateIndex</span><span class="s2">==</span><span class="s6">4</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stateIndex</span><span class="s2">))</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stateIndex</span><span class="s2">==</span><span class="s6">4</span>

    <span class="s4">def </span><span class="s1">changedOnState</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">isOn</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Allow derived classes to overide this. 
        &quot;&quot;&quot;</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__debugPrint</span><span class="s2">(</span><span class="s3">&quot;changedOnState(isOn=%s)&quot;</span><span class="s2">%(</span><span class="s1">isOn</span><span class="s2">,))</span>

    <span class="s5">##### state 0 #####</span>

    <span class="s4">def </span><span class="s1">enterState0</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__debugPrint</span><span class="s2">(</span><span class="s3">&quot;enter0()&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">enterStateN</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">exitState0</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__debugPrint</span><span class="s2">(</span><span class="s3">&quot;exit0()&quot;</span><span class="s2">)</span>
        <span class="s5"># It's important for FourStates to broadcast their state</span>
        <span class="s5"># when they are generated on the client. Before I put this in,</span>
        <span class="s5"># if a door was generated and went directly to an 'open' state,</span>
        <span class="s5"># it would not broadcast its state until it closed.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">changedOnState</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>

    <span class="s5">##### state 1 #####</span>

    <span class="s4">def </span><span class="s1">enterState1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__debugPrint</span><span class="s2">(</span><span class="s3">&quot;enterState1()&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">enterStateN</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">exitState1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__debugPrint</span><span class="s2">(</span><span class="s3">&quot;exitState1()&quot;</span><span class="s2">)</span>

    <span class="s5">##### state 2 #####</span>

    <span class="s4">def </span><span class="s1">enterState2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__debugPrint</span><span class="s2">(</span><span class="s3">&quot;enterState2()&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">enterStateN</span><span class="s2">(</span><span class="s6">2</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">exitState2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__debugPrint</span><span class="s2">(</span><span class="s3">&quot;exitState2()&quot;</span><span class="s2">)</span>

    <span class="s5">##### state 3 #####</span>

    <span class="s4">def </span><span class="s1">enterState3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__debugPrint</span><span class="s2">(</span><span class="s3">&quot;enterState3()&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">enterStateN</span><span class="s2">(</span><span class="s6">3</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">exitState3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__debugPrint</span><span class="s2">(</span><span class="s3">&quot;exitState3()&quot;</span><span class="s2">)</span>

    <span class="s5">##### state 4 #####</span>

    <span class="s4">def </span><span class="s1">enterState4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__debugPrint</span><span class="s2">(</span><span class="s3">&quot;enterState4()&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">enterStateN</span><span class="s2">(</span><span class="s6">4</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">changedOnState</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">exitState4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__debugPrint</span><span class="s2">(</span><span class="s3">&quot;exitState4()&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">changedOnState</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>

    <span class="s4">if __debug__</span><span class="s2">:</span>
        <span class="s4">def </span><span class="s1">__debugPrint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">message</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot;for debugging&quot;&quot;&quot;</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;%d (%d) %s&quot;</span><span class="s2">%(</span>
                    <span class="s1">id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stateIndex</span><span class="s2">==</span><span class="s6">4</span><span class="s2">, </span><span class="s1">message</span><span class="s2">))</span>

</pre>
</body>
</html>