<html>
<head>
<title>IntervalManager.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
IntervalManager.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Defines the IntervalManager class as well as the global instance of 
this class, ivalMgr.&quot;&quot;&quot;</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">'IntervalManager'</span><span class="s2">, </span><span class="s3">'ivalMgr'</span><span class="s2">]</span>

<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s2">*</span>
<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">direct </span><span class="s4">import </span><span class="s2">*</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">directnotify</span><span class="s2">.</span><span class="s1">DirectNotifyGlobal </span><span class="s4">import </span><span class="s2">*</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase </span><span class="s4">import </span><span class="s1">EventManager</span>
<span class="s4">import </span><span class="s1">fnmatch</span>

<span class="s4">class </span><span class="s1">IntervalManager</span><span class="s2">(</span><span class="s1">CIntervalManager</span><span class="s2">):</span>

    <span class="s5"># This is a Python-C++ hybrid class.  IntervalManager is a Python</span>
    <span class="s5"># extension of the C++ class CIntervalManager; the main purpose of</span>
    <span class="s5"># the Python extensions is to add support for Python-based</span>
    <span class="s5"># intervals (like MetaIntervals).</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">globalPtr </span><span class="s2">= </span><span class="s6">0</span><span class="s2">):</span>
        <span class="s5"># Pass globalPtr == 1 to the constructor to trick it into</span>
        <span class="s5"># &quot;constructing&quot; a Python wrapper around the global</span>
        <span class="s5"># CIntervalManager object.</span>
        <span class="s4">if </span><span class="s1">globalPtr</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cObj </span><span class="s2">= </span><span class="s1">CIntervalManager</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>
            <span class="s1">Dtool_BorrowThisReference</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cObj</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">dd </span><span class="s2">= </span><span class="s1">self</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">CIntervalManager</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">eventQueue </span><span class="s2">= </span><span class="s1">EventQueue</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">MyEventmanager </span><span class="s2">= </span><span class="s1">EventManager</span><span class="s2">.</span><span class="s1">EventManager</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">eventQueue</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setEventQueue</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">eventQueue</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">removedIvals </span><span class="s2">= {}</span>

    <span class="s4">def </span><span class="s1">addInterval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">interval</span><span class="s2">):</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">addCInterval</span><span class="s2">(</span><span class="s1">interval</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__storeInterval</span><span class="s2">(</span><span class="s1">interval</span><span class="s2">, </span><span class="s1">index</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">removeInterval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">interval</span><span class="s2">):</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">findCInterval</span><span class="s2">(</span><span class="s1">interval</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">())</span>
        <span class="s4">if </span><span class="s1">index </span><span class="s2">&gt;= </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">removeCInterval</span><span class="s2">(</span><span class="s1">index</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">index </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] = </span><span class="s4">None</span>
            <span class="s4">return </span><span class="s6">1</span>
        <span class="s4">return </span><span class="s6">0</span>

    <span class="s4">def </span><span class="s1">getInterval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">findCInterval</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">index </span><span class="s2">&gt;= </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">index </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">) </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">index</span><span class="s2">]:</span>
                <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">index</span><span class="s2">]</span>
            <span class="s5"># It must be a C-only interval.</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getCInterval</span><span class="s2">(</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s4">return None</span>

    <span class="s4">def </span><span class="s1">getIntervalsMatching</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pattern</span><span class="s2">):</span>
        <span class="s1">ivals </span><span class="s2">= []</span>

        <span class="s1">count </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s1">maxIndex </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getMaxIndex</span><span class="s2">()</span>
        <span class="s4">for </span><span class="s1">index </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">maxIndex</span><span class="s2">):</span>
            <span class="s1">ival </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getCInterval</span><span class="s2">(</span><span class="s1">index</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">ival </span><span class="s4">and </span><span class="s1">\</span>
               <span class="s1">fnmatch</span><span class="s2">.</span><span class="s1">fnmatchcase</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">(), </span><span class="s1">pattern</span><span class="s2">):</span>
                <span class="s5"># Finish and remove this interval.  Finishing it</span>
                <span class="s5"># automatically removes it.</span>
                <span class="s1">count </span><span class="s2">+= </span><span class="s6">1</span>
                <span class="s4">if </span><span class="s1">index </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">) </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">index</span><span class="s2">]:</span>
                    <span class="s5"># Get the python version if we have it</span>
                    <span class="s1">ivals</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">index</span><span class="s2">])</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s5"># Otherwise, it's a C-only interval.</span>
                    <span class="s1">ivals</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">)</span>

        <span class="s4">return </span><span class="s1">ivals</span>

    <span class="s4">def </span><span class="s1">finishIntervalsMatching</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pattern</span><span class="s2">):</span>
        <span class="s1">ivals </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getIntervalsMatching</span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">)</span>
        <span class="s4">for </span><span class="s1">ival </span><span class="s4">in </span><span class="s1">ivals</span><span class="s2">:</span>
            <span class="s1">ival</span><span class="s2">.</span><span class="s1">finish</span><span class="s2">()</span>
        <span class="s4">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ivals</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">pauseIntervalsMatching</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pattern</span><span class="s2">):</span>
        <span class="s1">ivals </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getIntervalsMatching</span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">)</span>
        <span class="s4">for </span><span class="s1">ival </span><span class="s4">in </span><span class="s1">ivals</span><span class="s2">:</span>
            <span class="s1">ival</span><span class="s2">.</span><span class="s1">pause</span><span class="s2">()</span>
        <span class="s4">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ivals</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">step</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># This method should be called once per frame to perform all</span>
        <span class="s5"># of the per-frame processing on the active intervals.</span>
        <span class="s5"># Call C++ step, then do the Python stuff.</span>
        <span class="s1">CIntervalManager</span><span class="s2">.</span><span class="s1">step</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__doPythonCallbacks</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">interrupt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># This method should be called during an emergency cleanup</span>
        <span class="s5"># operation, to automatically pause or finish all active</span>
        <span class="s5"># intervals tagged with autoPause or autoFinish set true.</span>
        <span class="s5"># Call C++ interrupt, then do the Python stuff.</span>
        <span class="s1">CIntervalManager</span><span class="s2">.</span><span class="s1">interrupt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__doPythonCallbacks</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">__doPythonCallbacks</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># This method does all of the required Python post-processing</span>
        <span class="s5"># after performing some C++-level action.</span>
        <span class="s5"># It is important to call all of the python callbacks on the</span>
        <span class="s5"># just-removed intervals before we call any of the callbacks</span>
        <span class="s5"># on the still-running intervals.</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getNextRemoval</span><span class="s2">()</span>
        <span class="s4">while </span><span class="s1">index </span><span class="s2">&gt;= </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s5"># We have to clear the interval first before we call</span>
            <span class="s5"># privPostEvent() on it, because the interval might itself</span>
            <span class="s5"># try to add a new interval.</span>
            <span class="s1">ival </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">index</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] = </span><span class="s4">None</span>
            <span class="s1">ival</span><span class="s2">.</span><span class="s1">privPostEvent</span><span class="s2">()</span>
            <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getNextRemoval</span><span class="s2">()</span>

        <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getNextEvent</span><span class="s2">()</span>
        <span class="s4">while </span><span class="s1">index </span><span class="s2">&gt;= </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">index</span><span class="s2">].</span><span class="s1">privPostEvent</span><span class="s2">()</span>
            <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getNextEvent</span><span class="s2">()</span>

        <span class="s5"># Finally, throw all the events on the custom event queue.</span>
        <span class="s5"># These are the done events that may have been generated in</span>
        <span class="s5"># C++.  We use a custom event queue so we can service all of</span>
        <span class="s5"># these immediately, rather than waiting for the global event</span>
        <span class="s5"># queue to be serviced (which might not be till next frame).</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">MyEventmanager</span><span class="s2">.</span><span class="s1">doEvents</span><span class="s2">()</span>


    <span class="s4">def </span><span class="s1">__storeInterval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">interval</span><span class="s2">, </span><span class="s1">index</span><span class="s2">):</span>
        <span class="s4">while </span><span class="s1">index </span><span class="s2">&gt;= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>
        <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] == </span><span class="s4">None or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] == </span><span class="s1">interval</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ivals</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] = </span><span class="s1">interval</span>

<span class="s5">#: The global IntervalManager object.</span>
<span class="s1">ivalMgr </span><span class="s2">= </span><span class="s1">IntervalManager</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
</pre>
</body>
</html>