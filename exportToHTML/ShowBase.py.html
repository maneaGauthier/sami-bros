<html>
<head>
<title>ShowBase.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #cf8e6d;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ShowBase.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; This module contains `.ShowBase`, an application framework responsible 
for opening a graphical display, setting up input devices and creating 
the scene graph. 
 
The simplest way to open a ShowBase instance is to execute this code: 
 
.. code-block:: python 
 
   from direct.showbase.ShowBase import ShowBase 
 
   base = ShowBase() 
   base.run() 
 
A common approach is to create your own subclass inheriting from ShowBase. 
 
Built-in global variables 
------------------------- 
 
Some key variables used in all Panda3D scripts are actually attributes of the 
ShowBase instance.  When creating an instance of this class, it will write many 
of these variables to the built-in scope of the Python interpreter, so that 
they are accessible to any Python module, without the need for extra imports. 
For example, the ShowBase instance itself is accessible anywhere through the 
:data:`~builtins.base` variable. 
 
While these are handy for prototyping, we do not recommend using them in bigger 
projects, as it can make the code confusing to read to other Python developers, 
to whom it may not be obvious where these variables are originating. 
 
Refer to the :mod:`builtins` page for a listing of the variables written to the 
built-in scope. 
 
&quot;&quot;&quot;</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">'ShowBase'</span><span class="s2">, </span><span class="s3">'WindowControls'</span><span class="s2">]</span>

<span class="s4"># This module redefines the builtin import function with one</span>
<span class="s4"># that prints out every import it does in a hierarchical form</span>
<span class="s4"># Annoying and very noisy, but sometimes useful</span>
<span class="s4">#import VerboseImport</span>

<span class="s5">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s5">import </span><span class="s2">*</span>
<span class="s5">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">direct </span><span class="s5">import </span><span class="s1">throw_new_frame</span><span class="s2">, </span><span class="s1">init_app_for_gui</span>
<span class="s5">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">direct </span><span class="s5">import </span><span class="s1">storeAccessibilityShortcutKeys</span><span class="s2">, </span><span class="s1">allowAccessibilityShortcutKeys</span>
<span class="s5">from </span><span class="s2">. </span><span class="s5">import </span><span class="s1">DConfig</span>

<span class="s4"># Register the extension methods for NodePath.</span>
<span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">extensions_native </span><span class="s5">import </span><span class="s1">NodePath_extensions</span>

<span class="s4"># This needs to be available early for DirectGUI imports</span>
<span class="s5">import </span><span class="s1">sys</span>
<span class="s5">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s6">3</span><span class="s2">, </span><span class="s6">0</span><span class="s2">):</span>
    <span class="s5">import </span><span class="s1">builtins</span>
<span class="s5">else</span><span class="s2">:</span>
    <span class="s5">import </span><span class="s1">__builtin__ </span><span class="s5">as </span><span class="s1">builtins</span>
<span class="s1">builtins</span><span class="s2">.</span><span class="s1">config </span><span class="s2">= </span><span class="s1">DConfig</span>

<span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">directnotify</span><span class="s2">.</span><span class="s1">DirectNotifyGlobal </span><span class="s5">import </span><span class="s1">directNotify</span><span class="s2">, </span><span class="s1">giveNotify</span>
<span class="s5">from </span><span class="s2">.</span><span class="s1">MessengerGlobal </span><span class="s5">import </span><span class="s1">messenger</span>
<span class="s5">from </span><span class="s2">.</span><span class="s1">BulletinBoardGlobal </span><span class="s5">import </span><span class="s1">bulletinBoard</span>
<span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">task</span><span class="s2">.</span><span class="s1">TaskManagerGlobal </span><span class="s5">import </span><span class="s1">taskMgr</span>
<span class="s5">from </span><span class="s2">.</span><span class="s1">JobManagerGlobal </span><span class="s5">import </span><span class="s1">jobMgr</span>
<span class="s5">from </span><span class="s2">.</span><span class="s1">EventManagerGlobal </span><span class="s5">import </span><span class="s1">eventMgr</span>
<span class="s4">#from PythonUtil import *</span>
<span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">interval </span><span class="s5">import </span><span class="s1">IntervalManager</span>
<span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase</span><span class="s2">.</span><span class="s1">BufferViewer </span><span class="s5">import </span><span class="s1">BufferViewer</span>
<span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">task </span><span class="s5">import </span><span class="s1">Task</span>
<span class="s5">from </span><span class="s2">. </span><span class="s5">import </span><span class="s1">Loader</span>
<span class="s5">import </span><span class="s1">time</span>
<span class="s5">import </span><span class="s1">atexit</span>
<span class="s5">import </span><span class="s1">importlib</span>
<span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase </span><span class="s5">import </span><span class="s1">ExceptionVarDump</span>
<span class="s5">from </span><span class="s2">. </span><span class="s5">import </span><span class="s1">DirectObject</span>
<span class="s5">from </span><span class="s2">. </span><span class="s5">import </span><span class="s1">SfxPlayer</span>
<span class="s5">if __debug__</span><span class="s2">:</span>
    <span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase </span><span class="s5">import </span><span class="s1">GarbageReport</span>
    <span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">directutil </span><span class="s5">import </span><span class="s1">DeltaProfiler</span>
    <span class="s5">from </span><span class="s2">. </span><span class="s5">import </span><span class="s1">OnScreenDebug</span>
<span class="s5">from </span><span class="s2">. </span><span class="s5">import </span><span class="s1">AppRunnerGlobal</span>

<span class="s2">@</span><span class="s1">atexit</span><span class="s2">.</span><span class="s1">register</span>
<span class="s5">def </span><span class="s1">exitfunc</span><span class="s2">():</span>
    <span class="s5">if </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">builtins</span><span class="s2">, </span><span class="s3">'base'</span><span class="s2">, </span><span class="s5">None</span><span class="s2">) </span><span class="s5">is not None</span><span class="s2">:</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">base</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>

<span class="s4"># Now ShowBase is a DirectObject.  We need this so ShowBase can hang</span>
<span class="s4"># hooks on messages, particularly on window-event.  This doesn't</span>
<span class="s4"># *seem* to cause anyone any problems.</span>
<span class="s5">class </span><span class="s1">ShowBase</span><span class="s2">(</span><span class="s1">DirectObject</span><span class="s2">.</span><span class="s1">DirectObject</span><span class="s2">):</span>

    <span class="s4">#: The deprecated `.DConfig` interface for accessing config variables.</span>
    <span class="s1">config </span><span class="s2">= </span><span class="s1">DConfig</span>
    <span class="s1">notify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s3">&quot;ShowBase&quot;</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fStartDirect</span><span class="s2">=</span><span class="s5">True</span><span class="s2">, </span><span class="s1">windowType</span><span class="s2">=</span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot;Opens a window, sets up a 3-D and several 2-D scene graphs, and 
        everything else needed to render the scene graph to the window. 
 
        To prevent a window from being opened, set windowType to the string 
        'none' (or 'offscreen' to create an offscreen buffer).  If this is not 
        specified, the default value is taken from the 'window-type' 
        configuration variable. 
 
        This constructor will add various things to the Python builtins scope, 
        including this instance itself (under the name ``base``). 
        &quot;&quot;&quot;</span>

        <span class="s4">#: Set if the want-dev Config.prc variable is enabled.  By default, it</span>
        <span class="s4">#: is set to True except when using Python with the -O flag.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__dev__ </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'want-dev'</span><span class="s2">, </span><span class="s5">__debug__</span><span class="s2">)</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">__dev__ </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dev__</span>

        <span class="s1">logStackDump </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'log-stack-dump'</span><span class="s2">, </span><span class="s5">False</span><span class="s2">) </span><span class="s5">or</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'client-log-stack-dump'</span><span class="s2">, </span><span class="s5">False</span><span class="s2">))</span>
        <span class="s1">uploadStackDump </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'upload-stack-dump'</span><span class="s2">, </span><span class="s5">False</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">logStackDump </span><span class="s5">or </span><span class="s1">uploadStackDump</span><span class="s2">:</span>
            <span class="s1">ExceptionVarDump</span><span class="s2">.</span><span class="s1">install</span><span class="s2">(</span><span class="s1">logStackDump</span><span class="s2">, </span><span class="s1">uploadStackDump</span><span class="s2">)</span>

        <span class="s5">if __debug__</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__autoGarbageLogging </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dev__ </span><span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'auto-garbage-logging'</span><span class="s2">, </span><span class="s5">False</span><span class="s2">)</span>

        <span class="s4">#: The directory containing the main Python file of this application.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mainDir </span><span class="s2">= </span><span class="s1">ExecutionEnvironment</span><span class="s2">.</span><span class="s1">getEnvironmentVariable</span><span class="s2">(</span><span class="s3">&quot;MAIN_DIR&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">main_dir </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mainDir</span>

        <span class="s4">#: This contains the global appRunner instance, as imported from</span>
        <span class="s4">#: `.AppRunnerGlobal`.  This will be None if we are not running in the</span>
        <span class="s4">#: runtime environment (ie. from a .p3d file).  Deprecated.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner </span><span class="s2">= </span><span class="s1">AppRunnerGlobal</span><span class="s2">.</span><span class="s1">appRunner</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">app_runner </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner</span>

        <span class="s4">#debug running multiplier</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">debugRunningMultiplier </span><span class="s2">= </span><span class="s6">4</span>

        <span class="s4"># [gjeon] to disable sticky keys</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'disable-sticky-keys'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">):</span>
            <span class="s1">storeAccessibilityShortcutKeys</span><span class="s2">()</span>
            <span class="s1">allowAccessibilityShortcutKeys</span><span class="s2">(</span><span class="s5">False</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">printEnvDebugInfo</span><span class="s2">()</span>
        <span class="s1">vfs </span><span class="s2">= </span><span class="s1">VirtualFileSystem</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">nextWindowIndex </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__directStarted </span><span class="s2">= </span><span class="s5">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__deadInputs </span><span class="s2">= </span><span class="s6">0</span>

        <span class="s4"># Store dconfig variables</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sfxActive </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'audio-sfx-active'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">musicActive </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'audio-music-active'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">wantFog </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'want-fog'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">wantRender2dp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'want-render2dp'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">screenshotExtension </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetString</span><span class="s2">(</span><span class="s3">'screenshot-extension'</span><span class="s2">, </span><span class="s3">'jpg'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">musicManager </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">musicManagerIsValid </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sfxManagerList </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sfxManagerIsValidList </span><span class="s2">= []</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">wantStats </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'want-pstats'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">wantTk </span><span class="s2">= </span><span class="s5">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">wantWx </span><span class="s2">= </span><span class="s5">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">wantDirect </span><span class="s2">= </span><span class="s5">False</span>

        <span class="s4">#: Fill this in with a function to invoke when the user &quot;exits&quot;</span>
        <span class="s4">#: the program by closing the main window.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">exitFunc </span><span class="s2">= </span><span class="s5">None</span>

        <span class="s4">#: Add final-exit callbacks to this list.  These will be called</span>
        <span class="s4">#: when sys.exit() is called, after Panda has unloaded, and</span>
        <span class="s4">#: just before Python is about to shut down.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">finalExitCallbacks </span><span class="s2">= []</span>

        <span class="s4"># Set up the TaskManager to reset the PStats clock back</span>
        <span class="s4"># whenever we resume from a pause.  This callback function is</span>
        <span class="s4"># a little hacky, but we can't call it directly from within</span>
        <span class="s4"># the TaskManager because he doesn't know about PStats (and</span>
        <span class="s4"># has to run before libpanda is even loaded).</span>
        <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">resumeFunc </span><span class="s2">= </span><span class="s1">PStatClient</span><span class="s2">.</span><span class="s1">resumeAfterPause</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dev__</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__setupProfile</span><span class="s2">()</span>

        <span class="s4"># If the aspect ratio is 0 or None, it means to infer the</span>
        <span class="s4"># aspect ratio from the window size.</span>
        <span class="s4"># If you need to know the actual aspect ratio call base.getAspectRatio()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__configAspectRatio </span><span class="s2">= </span><span class="s1">ConfigVariableDouble</span><span class="s2">(</span><span class="s3">'aspect-ratio'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">).</span><span class="s1">getValue</span><span class="s2">()</span>
        <span class="s4"># This variable is used to see if the aspect ratio has changed when</span>
        <span class="s4"># we get a window-event.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__oldAspectRatio </span><span class="s2">= </span><span class="s5">None</span>

        <span class="s4">#: This is set to the value of the window-type config variable, but may</span>
        <span class="s4">#: optionally be overridden in the Showbase constructor.  Should either</span>
        <span class="s4">#: be 'onscreen' (the default), 'offscreen' or 'none'.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">windowType </span><span class="s2">= </span><span class="s1">windowType</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">windowType </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">windowType </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetString</span><span class="s2">(</span><span class="s3">'window-type'</span><span class="s2">, </span><span class="s3">'onscreen'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">requireWindow </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'require-window'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>

        <span class="s4">#: This is the main, or only window; see `winList` for a list of *all* windows.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">win </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">frameRateMeter </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sceneGraphAnalyzerMeter </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s4">#: A list of all windows opened via `openWindow()`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">winList </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">winControls </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mainWinMinimized </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mainWinForeground </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s4">#: Contains the :class:`~panda3d.core.GraphicsPipe` object created by</span>
        <span class="s4">#: `makeDefaultPipe()`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pipe </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s4">#: The full list of :class:`~panda3d.core.GraphicsPipe` objects,</span>
        <span class="s4">#: including any auxiliary pipes.  Filled by `makeAllPipes()`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pipeList </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mouse2cam </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">buttonThrowers </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcher </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s4">#: The :class:`~panda3d.core.MouseWatcher` object, created by</span>
        <span class="s4">#: `setupMouse()`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcherNode </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pointerWatcherNodes </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseInterface </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">drive </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">trackball </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">texmem </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">showVertices </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">deviceButtonThrowers </span><span class="s2">= []</span>

        <span class="s4">#: This is a :class:`~panda3d.core.NodePath` pointing to the</span>
        <span class="s4">#: :class:`~panda3d.core.Camera` object set up for the 3D scene.</span>
        <span class="s4">#: Usually a child of `camera`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cam </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s4">#: Same as `cam`, but for the 2D scene graph.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cam2d </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s4">#: Same as `cam2d`, but for the 2D overlay scene graph.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cam2dp </span><span class="s2">= </span><span class="s5">None</span>

        <span class="s4">#: This is the :class:`~panda3d.core.NodePath` that should be used to</span>
        <span class="s4">#: manipulate the camera.  It points at the node to which the default</span>
        <span class="s4">#: camera (`cam`, `camNode`) is attached.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">camera </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s4">#: Same as `camera`, but for the 2D scene graph.  Parent of `cam2d`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">camera2d </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s4">#: Same as `camera2d`, but for the 2D overlay scene graph.  Parent of</span>
        <span class="s4">#: `cam2dp`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">camera2dp </span><span class="s2">= </span><span class="s5">None</span>

        <span class="s4">#: A list of all cameras created with `makeCamera()`, including `cam`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">camList </span><span class="s2">= []</span>
        <span class="s4">#: Convenience accessor for base.cam.node(), containing a</span>
        <span class="s4">#: :class:`~panda3d.core.Camera` object.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">camNode </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s4">#: Convenience accessor for base.camNode.get_lens(), containing a</span>
        <span class="s4">#: :class:`~panda3d.core.Lens` object.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">camLens </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">camFrustumVis </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">direct </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s4">#: This is used to store the wx.Application object used when want-wx is</span>
        <span class="s4">#: set or `startWx()` is called.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">wxApp </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">wxAppCreated </span><span class="s2">= </span><span class="s5">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tkRoot </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tkRootCreated </span><span class="s2">= </span><span class="s5">False</span>

        <span class="s4"># This is used for syncing multiple PCs in a distributed cluster</span>
        <span class="s5">try</span><span class="s2">:</span>
            <span class="s4"># Has the cluster sync variable been set externally?</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">clusterSyncFlag </span><span class="s2">= </span><span class="s1">clusterSyncFlag</span>
        <span class="s5">except </span><span class="s1">NameError</span><span class="s2">:</span>
            <span class="s4"># Has the clusterSyncFlag been set via a config variable</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">clusterSyncFlag </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'cluster-sync'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>

        <span class="s4"># We've already created aspect2d in ShowBaseGlobal, for the</span>
        <span class="s4"># benefit of creating DirectGui elements before ShowBase.</span>
        <span class="s5">from </span><span class="s2">. </span><span class="s5">import </span><span class="s1">ShowBaseGlobal</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">hidden </span><span class="s2">= </span><span class="s1">ShowBaseGlobal</span><span class="s2">.</span><span class="s1">hidden</span>

        <span class="s4">#: The global :class:`~panda3d.core.GraphicsEngine`, as returned by</span>
        <span class="s4">#: GraphicsEngine.getGlobalPtr()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine </span><span class="s2">= </span><span class="s1">GraphicsEngine</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphics_engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setupRender</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setupRender2d</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setupDataGraph</span><span class="s2">()</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantRender2dp</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">setupRender2dp</span><span class="s2">()</span>

        <span class="s4">#: A placeholder for a :class:`~panda3d.core.CollisionTraverser`.  If</span>
        <span class="s4">#: someone stores a CollisionTraverser pointer here, ShowBase will</span>
        <span class="s4">#: traverse it automatically in the collisionLoop task, so you won't</span>
        <span class="s4">#: need to call :meth:`~panda3d.core.CollisionTraverser.traverse()`</span>
        <span class="s4">#: yourself every frame.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cTrav </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">shadowTrav </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cTravStack </span><span class="s2">= </span><span class="s1">Stack</span><span class="s2">()</span>
        <span class="s4"># Ditto for an AppTraverser.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">appTrav </span><span class="s2">= </span><span class="s6">0</span>

        <span class="s4"># This is the DataGraph traverser, which we might as well</span>
        <span class="s4"># create now.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dgTrav </span><span class="s2">= </span><span class="s1">DataGraphTraverser</span><span class="s2">()</span>

        <span class="s4"># Maybe create a RecorderController to record and/or play back</span>
        <span class="s4"># the user session.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">recorder </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">playbackSession </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetString</span><span class="s2">(</span><span class="s3">'playback-session'</span><span class="s2">, </span><span class="s3">''</span><span class="s2">)</span>
        <span class="s1">recordSession </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetString</span><span class="s2">(</span><span class="s3">'record-session'</span><span class="s2">, </span><span class="s3">''</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">playbackSession</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">recorder </span><span class="s2">= </span><span class="s1">RecorderController</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">recorder</span><span class="s2">.</span><span class="s1">beginPlayback</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">playbackSession</span><span class="s2">))</span>
        <span class="s5">elif </span><span class="s1">recordSession</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">recorder </span><span class="s2">= </span><span class="s1">RecorderController</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">recorder</span><span class="s2">.</span><span class="s1">beginRecord</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">recordSession</span><span class="s2">))</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recorder</span><span class="s2">:</span>
            <span class="s4"># If we're either playing back or recording, pass the</span>
            <span class="s4"># random seed into the system so each session will have</span>
            <span class="s4"># the same random seed.</span>
            <span class="s5">import </span><span class="s1">random </span><span class="s4">#, whrandom</span>

            <span class="s1">seed </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recorder</span><span class="s2">.</span><span class="s1">getRandomSeed</span><span class="s2">()</span>
            <span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>
            <span class="s4">#whrandom.seed(seed &amp; 0xff, (seed &gt;&gt; 8) &amp; 0xff, (seed &gt;&gt; 16) &amp; 0xff)</span>

        <span class="s4"># For some reason, wx needs to be initialized before the graphics window</span>
        <span class="s5">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s3">&quot;darwin&quot;</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">&quot;want-wx&quot;</span><span class="s2">, </span><span class="s6">0</span><span class="s2">):</span>
                <span class="s1">wx </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">'wx'</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">wxApp </span><span class="s2">= </span><span class="s1">wx</span><span class="s2">.</span><span class="s1">App</span><span class="s2">()</span>

            <span class="s4"># Same goes for Tk, which uses a conflicting NSApplication</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">&quot;want-tk&quot;</span><span class="s2">, </span><span class="s6">0</span><span class="s2">):</span>
                <span class="s1">Pmw </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">'Pmw'</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tkRoot </span><span class="s2">= </span><span class="s1">Pmw</span><span class="s2">.</span><span class="s1">initialise</span><span class="s2">()</span>

        <span class="s4"># Open the default rendering window.</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">windowType </span><span class="s2">!= </span><span class="s3">'none'</span><span class="s2">:</span>
            <span class="s1">props </span><span class="s2">= </span><span class="s1">WindowProperties</span><span class="s2">.</span><span class="s1">getDefault</span><span class="s2">()</span>
            <span class="s5">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'read-raw-mice'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)):</span>
                <span class="s1">props</span><span class="s2">.</span><span class="s1">setRawMice</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">openDefaultWindow</span><span class="s2">(</span><span class="s1">startDirect </span><span class="s2">= </span><span class="s5">False</span><span class="s2">, </span><span class="s1">props</span><span class="s2">=</span><span class="s1">props</span><span class="s2">)</span>

        <span class="s4"># The default is trackball mode, which is more convenient for</span>
        <span class="s4"># ad-hoc development in Python using ShowBase.  Applications</span>
        <span class="s4"># can explicitly call base.useDrive() if they prefer a drive</span>
        <span class="s4"># interface.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseInterface </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">trackball</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">useTrackball</span><span class="s2">()</span>

        <span class="s4">#: `.Loader.Loader` object.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loader </span><span class="s2">= </span><span class="s1">Loader</span><span class="s2">.</span><span class="s1">Loader</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">setDefaultLoader</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loader</span><span class="s2">.</span><span class="s1">loader</span><span class="s2">)</span>

        <span class="s4">#: The global event manager, as imported from `.EventManagerGlobal`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">eventMgr </span><span class="s2">= </span><span class="s1">eventMgr</span>
        <span class="s4">#: The global messenger, as imported from `.MessengerGlobal`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">messenger </span><span class="s2">= </span><span class="s1">messenger</span>
        <span class="s4">#: The global bulletin board, as imported from `.BulletinBoardGlobal`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bboard </span><span class="s2">= </span><span class="s1">bulletinBoard</span>
        <span class="s4">#: The global task manager, as imported from `.TaskManagerGlobal`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr </span><span class="s2">= </span><span class="s1">taskMgr</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">task_mgr </span><span class="s2">= </span><span class="s1">taskMgr</span>
        <span class="s4">#: The global job manager, as imported from `.JobManagerGlobal`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">jobMgr </span><span class="s2">= </span><span class="s1">jobMgr</span>

        <span class="s4">#: If `enableParticles()` has been called, this is the particle manager</span>
        <span class="s4">#: as imported from :mod:`direct.particles.ParticleManagerGlobal`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">particleMgr </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">particleMgrEnabled </span><span class="s2">= </span><span class="s6">0</span>

        <span class="s4">#: If `enableParticles()` has been called, this is the physics manager</span>
        <span class="s4">#: as imported from :mod:`direct.showbase.PhysicsManagerGlobal`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">physicsMgr </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">physicsMgrEnabled </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">physicsMgrAngular </span><span class="s2">= </span><span class="s6">0</span>

        <span class="s4">#: This is the global :class:`~panda3d.core.InputDeviceManager`, which</span>
        <span class="s4">#: keeps track of connected input devices.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">devices </span><span class="s2">= </span><span class="s1">InputDeviceManager</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__inputDeviceNodes </span><span class="s2">= {}</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">createStats</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">AppHasAudioFocus </span><span class="s2">= </span><span class="s6">1</span>

        <span class="s4"># Get a pointer to Panda's global ClockObject, used for</span>
        <span class="s4"># synchronizing events between Python and C.</span>
        <span class="s1">clock </span><span class="s2">= </span><span class="s1">ClockObject</span><span class="s2">.</span><span class="s1">getGlobalClock</span><span class="s2">()</span>

        <span class="s4">#: This is the global :class:`~panda3d.core.ClockObject`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">clock </span><span class="s2">= </span><span class="s1">clock</span>

        <span class="s4"># Since we have already started up a TaskManager, and probably</span>
        <span class="s4"># a number of tasks; and since the TaskManager had to use the</span>
        <span class="s4"># TrueClock to tell time until this moment, make sure the</span>
        <span class="s4"># globalClock object is exactly in sync with the TrueClock.</span>
        <span class="s1">trueClock </span><span class="s2">= </span><span class="s1">TrueClock</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>
        <span class="s1">clock</span><span class="s2">.</span><span class="s1">setRealTime</span><span class="s2">(</span><span class="s1">trueClock</span><span class="s2">.</span><span class="s1">getShortTime</span><span class="s2">())</span>
        <span class="s1">clock</span><span class="s2">.</span><span class="s1">tick</span><span class="s2">()</span>

        <span class="s4"># Now we can make the TaskManager start using the new clock.</span>
        <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">globalClock </span><span class="s2">= </span><span class="s1">clock</span>

        <span class="s4"># client CPU affinity is determined by, in order:</span>
        <span class="s4"># - client-cpu-affinity-mask config</span>
        <span class="s4"># - pcalt-# (# is CPU number, 0-based)</span>
        <span class="s4"># - client-cpu-affinity config</span>
        <span class="s4"># - auto-single-cpu-affinity config</span>
        <span class="s1">affinityMask </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetInt</span><span class="s2">(</span><span class="s3">'client-cpu-affinity-mask'</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">affinityMask </span><span class="s2">!= -</span><span class="s6">1</span><span class="s2">:</span>
            <span class="s1">TrueClock</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">().</span><span class="s1">setCpuAffinity</span><span class="s2">(</span><span class="s1">affinityMask</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s4"># this is useful on machines that perform better with each process</span>
            <span class="s4"># assigned to a single CPU</span>
            <span class="s1">autoAffinity </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'auto-single-cpu-affinity'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">affinity </span><span class="s2">= </span><span class="s5">None</span>
            <span class="s5">if </span><span class="s1">autoAffinity </span><span class="s5">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">builtins</span><span class="s2">, </span><span class="s3">'clientIndex'</span><span class="s2">):</span>
                <span class="s1">affinity </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">builtins</span><span class="s2">.</span><span class="s1">clientIndex</span><span class="s2">))</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">affinity </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetInt</span><span class="s2">(</span><span class="s3">'client-cpu-affinity'</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s2">(</span><span class="s1">affinity </span><span class="s5">in </span><span class="s2">(</span><span class="s5">None</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">)) </span><span class="s5">and </span><span class="s1">autoAffinity</span><span class="s2">:</span>
                <span class="s1">affinity </span><span class="s2">= </span><span class="s6">0</span>
            <span class="s5">if </span><span class="s1">affinity </span><span class="s5">not in </span><span class="s2">(</span><span class="s5">None</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">):</span>
                <span class="s4"># Windows XP supports a 32-bit affinity mask</span>
                <span class="s1">TrueClock</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">().</span><span class="s1">setCpuAffinity</span><span class="s2">(</span><span class="s6">1 </span><span class="s2">&lt;&lt; (</span><span class="s1">affinity </span><span class="s2">% </span><span class="s6">32</span><span class="s2">))</span>

        <span class="s4"># Make sure we're not making more than one ShowBase.</span>
        <span class="s5">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">builtins</span><span class="s2">, </span><span class="s3">'base'</span><span class="s2">):</span>
            <span class="s5">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;Attempt to spawn multiple ShowBase instances!&quot;</span><span class="s2">)</span>

        <span class="s4"># DO NOT ADD TO THIS LIST.  We're trying to phase out the use of</span>
        <span class="s4"># built-in variables by ShowBase.  Use a Global module if necessary.</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">base </span><span class="s2">= </span><span class="s1">self</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">render2d </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">render2d</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">aspect2d </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">pixel2d </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pixel2d</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">render </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">render</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">hidden </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hidden</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">camera </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">loader </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loader</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">taskMgr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">jobMgr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">jobMgr</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">eventMgr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">eventMgr</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">messenger </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">messenger</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">bboard </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bboard</span>
        <span class="s4"># Config needs to be defined before ShowBase is constructed</span>
        <span class="s4">#builtins.config = self.config</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">ostream </span><span class="s2">= </span><span class="s1">Notify</span><span class="s2">.</span><span class="s1">out</span><span class="s2">()</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">directNotify </span><span class="s2">= </span><span class="s1">directNotify</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">giveNotify </span><span class="s2">= </span><span class="s1">giveNotify</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">globalClock </span><span class="s2">= </span><span class="s1">clock</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">vfs </span><span class="s2">= </span><span class="s1">vfs</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">cpMgr </span><span class="s2">= </span><span class="s1">ConfigPageManager</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">cvMgr </span><span class="s2">= </span><span class="s1">ConfigVariableManager</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">pandaSystem </span><span class="s2">= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">wantUberdog </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'want-uberdog'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s5">if __debug__</span><span class="s2">:</span>
            <span class="s1">builtins</span><span class="s2">.</span><span class="s1">deltaProfiler </span><span class="s2">= </span><span class="s1">DeltaProfiler</span><span class="s2">.</span><span class="s1">DeltaProfiler</span><span class="s2">(</span><span class="s3">&quot;ShowBase&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">onScreenDebug </span><span class="s2">= </span><span class="s1">OnScreenDebug</span><span class="s2">.</span><span class="s1">OnScreenDebug</span><span class="s2">()</span>
            <span class="s1">builtins</span><span class="s2">.</span><span class="s1">onScreenDebug </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">onScreenDebug</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantRender2dp</span><span class="s2">:</span>
            <span class="s1">builtins</span><span class="s2">.</span><span class="s1">render2dp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">render2dp</span>
            <span class="s1">builtins</span><span class="s2">.</span><span class="s1">aspect2dp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2dp</span>
            <span class="s1">builtins</span><span class="s2">.</span><span class="s1">pixel2dp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pixel2dp</span>

        <span class="s4"># Now add this instance to the ShowBaseGlobal module scope.</span>
        <span class="s5">from </span><span class="s2">. </span><span class="s5">import </span><span class="s1">ShowBaseGlobal</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">run </span><span class="s2">= </span><span class="s1">ShowBaseGlobal</span><span class="s2">.</span><span class="s1">run</span>
        <span class="s1">ShowBaseGlobal</span><span class="s2">.</span><span class="s1">base </span><span class="s2">= </span><span class="s1">self</span>
        <span class="s1">ShowBaseGlobal</span><span class="s2">.</span><span class="s1">__dev__ </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dev__</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dev__</span><span class="s2">:</span>
            <span class="s1">ShowBase</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">'__dev__ == %s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dev__</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">ShowBase</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">'__dev__ == %s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dev__</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">createBaseAudioManagers</span><span class="s2">()</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dev__ </span><span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'track-gui-items'</span><span class="s2">, </span><span class="s5">False</span><span class="s2">):</span>
            <span class="s4"># dict of guiId to gui item, for tracking down leaks</span>
            <span class="s5">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">ShowBase</span><span class="s2">, </span><span class="s3">'guiItems'</span><span class="s2">):</span>
                <span class="s1">ShowBase</span><span class="s2">.</span><span class="s1">guiItems </span><span class="s2">= {}</span>

        <span class="s4"># optionally restore the default gui sounds from 1.7.2 and earlier</span>
        <span class="s5">if </span><span class="s1">ConfigVariableBool</span><span class="s2">(</span><span class="s3">'orig-gui-sounds'</span><span class="s2">, </span><span class="s5">False</span><span class="s2">).</span><span class="s1">getValue</span><span class="s2">():</span>
            <span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">gui </span><span class="s5">import </span><span class="s1">DirectGuiGlobals </span><span class="s5">as </span><span class="s1">DGG</span>
            <span class="s1">DGG</span><span class="s2">.</span><span class="s1">setDefaultClickSound</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loader</span><span class="s2">.</span><span class="s1">loadSfx</span><span class="s2">(</span><span class="s3">&quot;audio/sfx/GUI_click.wav&quot;</span><span class="s2">))</span>
            <span class="s1">DGG</span><span class="s2">.</span><span class="s1">setDefaultRolloverSound</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loader</span><span class="s2">.</span><span class="s1">loadSfx</span><span class="s2">(</span><span class="s3">&quot;audio/sfx/GUI_rollover.wav&quot;</span><span class="s2">))</span>

        <span class="s4"># Now hang a hook on the window-event from Panda.  This allows</span>
        <span class="s4"># us to detect when the user resizes, minimizes, or closes the</span>
        <span class="s4"># main window.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__prevWindowProperties </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">(</span><span class="s3">'window-event'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">windowEvent</span><span class="s2">)</span>

        <span class="s4"># Transition effects (fade, iris, etc)</span>
        <span class="s5">from </span><span class="s2">. </span><span class="s5">import </span><span class="s1">Transitions</span>

        <span class="s4">#: `.Transitions.Transitions` object.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">transitions </span><span class="s2">= </span><span class="s1">Transitions</span><span class="s2">.</span><span class="s1">Transitions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loader</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">:</span>
            <span class="s4"># Setup the window controls - handy for multiwindow applications</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">setupWindowControls</span><span class="s2">()</span>

        <span class="s4"># Client sleep</span>
        <span class="s1">sleepTime </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetFloat</span><span class="s2">(</span><span class="s3">'client-sleep'</span><span class="s2">, </span><span class="s6">0.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">clientSleep </span><span class="s2">= </span><span class="s6">0.0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setSleep</span><span class="s2">(</span><span class="s1">sleepTime</span><span class="s2">)</span>

        <span class="s4"># Extra sleep for running 4+ clients on a single machine</span>
        <span class="s4"># adds a sleep right after the main render in igloop</span>
        <span class="s4"># tends to even out the frame rate and keeps it from going</span>
        <span class="s4"># to zero in the out of focus windows</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'multi-sleep'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">multiClientSleep </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">multiClientSleep </span><span class="s2">= </span><span class="s6">0</span>

        <span class="s4">#: Utility for viewing offscreen buffers, see :mod:`.BufferViewer`.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bufferViewer </span><span class="s2">= </span><span class="s1">BufferViewer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">render2dp </span><span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantRender2dp </span><span class="s5">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">render2d</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">windowType </span><span class="s2">!= </span><span class="s3">'none'</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">fStartDirect</span><span class="s2">: </span><span class="s4"># [gjeon] if this is False let them start direct manually</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__doStartDirect</span><span class="s2">()</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'show-tex-mem'</span><span class="s2">, </span><span class="s5">False</span><span class="s2">):</span>
                <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">texmem </span><span class="s5">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">texmem</span><span class="s2">.</span><span class="s1">cleanedUp</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">toggleTexMem</span><span class="s2">()</span>

        <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">finalInit</span><span class="s2">()</span>

        <span class="s4"># Start IGLOOP</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">restart</span><span class="s2">()</span>

    <span class="s4"># add a collision traverser via pushCTrav and remove it via popCTrav</span>
    <span class="s4"># that way the owner of the new cTrav doesn't need to hold onto the</span>
    <span class="s4"># previous one in order to put it back</span>
    <span class="s5">def </span><span class="s1">pushCTrav</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cTrav</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cTravStack</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cTrav</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cTrav </span><span class="s2">= </span><span class="s1">cTrav</span>
    <span class="s5">def </span><span class="s1">popCTrav</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cTrav </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cTravStack</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">__setupProfile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Sets up the Python profiler, if available, according to 
        some Panda config settings. &quot;&quot;&quot;</span>

        <span class="s5">try</span><span class="s2">:</span>
            <span class="s1">profile </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">'profile'</span><span class="s2">)</span>
            <span class="s1">pstats </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">'pstats'</span><span class="s2">)</span>
        <span class="s5">except </span><span class="s1">ImportError</span><span class="s2">:</span>
            <span class="s5">return</span>

        <span class="s1">profile</span><span class="s2">.</span><span class="s1">Profile</span><span class="s2">.</span><span class="s1">bias </span><span class="s2">= </span><span class="s1">float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetString</span><span class="s2">(</span><span class="s3">&quot;profile-bias&quot;</span><span class="s2">,</span><span class="s3">&quot;0&quot;</span><span class="s2">))</span>

        <span class="s5">def </span><span class="s1">f8</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s5">return </span><span class="s2">(</span><span class="s3">&quot;%&quot; </span><span class="s2">+ </span><span class="s3">&quot;8.%df&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetInt</span><span class="s2">(</span><span class="s3">&quot;profile-decimals&quot;</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)) % </span><span class="s1">x</span>
        <span class="s1">pstats</span><span class="s2">.</span><span class="s1">f8 </span><span class="s2">= </span><span class="s1">f8</span>

    <span class="s4"># temp; see ToonBase.py</span>
    <span class="s5">def </span><span class="s1">getExitErrorCode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">return </span><span class="s6">0</span>

    <span class="s5">def </span><span class="s1">printEnvDebugInfo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot;Print some information about the environment that we are running 
        in.  Stuff like the model paths and other paths.  Feel free to 
        add stuff to this. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'want-env-debug-info'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">):</span>
           <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s5">\n\n</span><span class="s3">Environment Debug Info {&quot;</span><span class="s2">)</span>
           <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;* model path:&quot;</span><span class="s2">)</span>
           <span class="s1">print</span><span class="s2">(</span><span class="s1">getModelPath</span><span class="s2">())</span>
           <span class="s4">#print &quot;* dna path:&quot;</span>
           <span class="s4">#print getDnaPath()</span>
           <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;}&quot;</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Call this function to destroy the ShowBase and stop all 
        its tasks, freeing all of the Panda resources.  Normally, you 
        should not need to call it explicitly, as it is bound to the 
        exitfunc and will be called at application exit time 
        automatically. 
 
        This function is designed to be safe to call multiple times.&quot;&quot;&quot;</span>

        <span class="s5">for </span><span class="s1">cb </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">finalExitCallbacks</span><span class="s2">[:]:</span>
            <span class="s1">cb</span><span class="s2">()</span>

        <span class="s4"># Remove the built-in base reference</span>
        <span class="s5">if </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">builtins</span><span class="s2">, </span><span class="s3">'base'</span><span class="s2">, </span><span class="s5">None</span><span class="s2">) </span><span class="s5">is </span><span class="s1">self</span><span class="s2">:</span>
            <span class="s5">del </span><span class="s1">builtins</span><span class="s2">.</span><span class="s1">run</span>
            <span class="s5">del </span><span class="s1">builtins</span><span class="s2">.</span><span class="s1">base</span>
            <span class="s5">del </span><span class="s1">builtins</span><span class="s2">.</span><span class="s1">loader</span>
            <span class="s5">del </span><span class="s1">builtins</span><span class="s2">.</span><span class="s1">taskMgr</span>
            <span class="s1">ShowBaseGlobal </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'direct.showbase.ShowBaseGlobal'</span><span class="s2">, </span><span class="s5">None</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">ShowBaseGlobal</span><span class="s2">:</span>
                <span class="s5">del </span><span class="s1">ShowBaseGlobal</span><span class="s2">.</span><span class="s1">base</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">removeAllChildren</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render2d</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">removeAllChildren</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">reparent_to</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">render2d</span><span class="s2">)</span>

        <span class="s4"># [gjeon] restore sticky key settings</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'disable-sticky-keys'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">):</span>
            <span class="s1">allowAccessibilityShortcutKeys</span><span class="s2">(</span><span class="s5">True</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreAll</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">shutdown</span><span class="s2">()</span>

        <span class="s5">if </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'musicManager'</span><span class="s2">, </span><span class="s5">None</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">musicManager</span><span class="s2">.</span><span class="s1">shutdown</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">musicManager </span><span class="s2">= </span><span class="s5">None</span>
            <span class="s5">for </span><span class="s1">sfxManager </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sfxManagerList</span><span class="s2">:</span>
                <span class="s1">sfxManager</span><span class="s2">.</span><span class="s1">shutdown</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sfxManagerList </span><span class="s2">= []</span>
        <span class="s5">if </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'loader'</span><span class="s2">, </span><span class="s5">None</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">loader</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">loader </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s5">if </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'graphicsEngine'</span><span class="s2">, </span><span class="s5">None</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">removeAllWindows</span><span class="s2">()</span>

        <span class="s5">try</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">direct</span><span class="s2">.</span><span class="s1">panel</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
        <span class="s5">except</span><span class="s2">:</span>
            <span class="s5">pass</span>

        <span class="s5">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'win'</span><span class="s2">):</span>
            <span class="s5">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span>
            <span class="s5">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">winList</span>
            <span class="s5">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pipe</span>

    <span class="s5">def </span><span class="s1">makeDefaultPipe</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">printPipeTypes </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Creates the default GraphicsPipe, which will be used to make 
        windows unless otherwise specified. 
        &quot;&quot;&quot;</span>
        <span class="s5">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pipe </span><span class="s5">is None</span>

        <span class="s5">if </span><span class="s1">printPipeTypes </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s4"># When the user didn't specify an explicit setting, take the value</span>
            <span class="s4"># from the config variable. We could just omit the parameter, however</span>
            <span class="s4"># this way we can keep backward compatibility.</span>
            <span class="s1">printPipeTypes </span><span class="s2">= </span><span class="s1">ConfigVariableBool</span><span class="s2">(</span><span class="s3">&quot;print-pipe-types&quot;</span><span class="s2">, </span><span class="s5">True</span><span class="s2">)</span>

        <span class="s1">selection </span><span class="s2">= </span><span class="s1">GraphicsPipeSelection</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>
        <span class="s5">if </span><span class="s1">printPipeTypes</span><span class="s2">:</span>
            <span class="s1">selection</span><span class="s2">.</span><span class="s1">printPipeTypes</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pipe </span><span class="s2">= </span><span class="s1">selection</span><span class="s2">.</span><span class="s1">makeDefaultPipe</span><span class="s2">()</span>
        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pipe</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span>
                <span class="s3">&quot;No graphics pipe is available!</span><span class="s5">\n</span><span class="s3">&quot;</span>
                <span class="s3">&quot;Your Config.prc file must name at least one valid panda display</span><span class="s5">\n</span><span class="s3">&quot;</span>
                <span class="s3">&quot;library via load-display or aux-display.&quot;</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Default graphics pipe is %s (%s).&quot; </span><span class="s2">% (</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pipe</span><span class="s2">.</span><span class="s1">getType</span><span class="s2">().</span><span class="s1">getName</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pipe</span><span class="s2">.</span><span class="s1">getInterfaceName</span><span class="s2">()))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pipeList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pipe</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">makeModulePipe</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">moduleName</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Returns a GraphicsPipe from the indicated module, 
        e.g. 'pandagl' or 'pandadx9'.  Does not affect base.pipe or 
        base.pipeList. 
 
        :rtype: panda3d.core.GraphicsPipe 
        &quot;&quot;&quot;</span>

        <span class="s1">selection </span><span class="s2">= </span><span class="s1">GraphicsPipeSelection</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>
        <span class="s5">return </span><span class="s1">selection</span><span class="s2">.</span><span class="s1">makeModulePipe</span><span class="s2">(</span><span class="s1">moduleName</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">makeAllPipes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Creates all GraphicsPipes that the system knows about and fill up 
        `pipeList` with them. 
        &quot;&quot;&quot;</span>
        <span class="s1">selection </span><span class="s2">= </span><span class="s1">GraphicsPipeSelection</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>
        <span class="s1">selection</span><span class="s2">.</span><span class="s1">loadAuxModules</span><span class="s2">()</span>

        <span class="s4"># First, we should make sure the default pipe exists.</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pipe </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">makeDefaultPipe</span><span class="s2">()</span>

        <span class="s4"># Now go through the list of known pipes, and make each one if</span>
        <span class="s4"># we don't have one already.</span>
        <span class="s1">numPipeTypes </span><span class="s2">= </span><span class="s1">selection</span><span class="s2">.</span><span class="s1">getNumPipeTypes</span><span class="s2">()</span>
        <span class="s5">for </span><span class="s1">i </span><span class="s5">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">numPipeTypes</span><span class="s2">):</span>
            <span class="s1">pipeType </span><span class="s2">= </span><span class="s1">selection</span><span class="s2">.</span><span class="s1">getPipeType</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>

            <span class="s4"># Do we already have a pipe of this type on the list?</span>
            <span class="s4"># This operation is n-squared, but presumably there won't</span>
            <span class="s4"># be more than a handful of pipe types, so who cares.</span>
            <span class="s1">already </span><span class="s2">= </span><span class="s6">0</span>
            <span class="s5">for </span><span class="s1">pipe </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pipeList</span><span class="s2">:</span>
                <span class="s5">if </span><span class="s1">pipe</span><span class="s2">.</span><span class="s1">getType</span><span class="s2">() == </span><span class="s1">pipeType</span><span class="s2">:</span>
                    <span class="s1">already </span><span class="s2">= </span><span class="s6">1</span>

            <span class="s5">if not </span><span class="s1">already</span><span class="s2">:</span>
                <span class="s1">pipe </span><span class="s2">= </span><span class="s1">selection</span><span class="s2">.</span><span class="s1">makePipe</span><span class="s2">(</span><span class="s1">pipeType</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">pipe</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Got aux graphics pipe %s (%s).&quot; </span><span class="s2">% (</span>
                        <span class="s1">pipe</span><span class="s2">.</span><span class="s1">getType</span><span class="s2">().</span><span class="s1">getName</span><span class="s2">(), </span><span class="s1">pipe</span><span class="s2">.</span><span class="s1">getInterfaceName</span><span class="s2">()))</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">pipeList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">pipe</span><span class="s2">)</span>
                <span class="s5">else</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Could not make graphics pipe %s.&quot; </span><span class="s2">% (</span>
                        <span class="s1">pipeType</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">()))</span>

    <span class="s5">def </span><span class="s1">openWindow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">fbprops </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">pipe </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">gsg </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                   <span class="s1">host </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">type </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">name </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">size </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                   <span class="s1">aspectRatio </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">makeCamera </span><span class="s2">= </span><span class="s5">True</span><span class="s2">, </span><span class="s1">keepCamera </span><span class="s2">= </span><span class="s5">False</span><span class="s2">,</span>
                   <span class="s1">scene </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">stereo </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">unexposedDraw </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                   <span class="s1">callbackWindowDict </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">requireWindow </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Creates a window and adds it to the list of windows that are 
        to be updated every frame. 
 
        :param props: the :class:`~panda3d.core.WindowProperties` that 
                      describes the window. 
 
        :param fbprops: the :class:`~panda3d.core.FrameBufferProperties` 
                        indicating the requested framebuffer properties. 
 
        :param type: Either 'onscreen', 'offscreen', or 'none'. 
 
        :param keepCamera: If True, the existing base.cam is set up to 
                           render into the new window. 
 
        :param makeCamera: If True (and keepCamera is False), a new camera is 
                           set up to render into the new window. 
 
        :param unexposedDraw: If not None, it specifies the initial value 
                              of :meth:`~panda3d.core.GraphicsWindow.setUnexposedDraw()`. 
 
        :param callbackWindowDict: If not None, a 
                                   :class:`~panda3d.core.CallbackGraphicsWindow` 
                                   is created instead, which allows the caller 
                                   to create the actual window with its own 
                                   OpenGL context, and direct Panda's rendering 
                                   into that window. 
 
        :param requireWindow: If True, the function should raise an exception 
                              if the window fails to open correctly. 
 
        :rtype: panda3d.core.GraphicsWindow 
        &quot;&quot;&quot;</span>

        <span class="s4"># Save this lambda here for convenience; we'll use it to call</span>
        <span class="s4"># down to the underlying _doOpenWindow() with all of the above</span>
        <span class="s4"># parameters.</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s5">lambda </span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_doOpenWindow</span><span class="s2">(</span>
            <span class="s1">props </span><span class="s2">= </span><span class="s1">props</span><span class="s2">, </span><span class="s1">fbprops </span><span class="s2">= </span><span class="s1">fbprops</span><span class="s2">, </span><span class="s1">pipe </span><span class="s2">= </span><span class="s1">pipe</span><span class="s2">, </span><span class="s1">gsg </span><span class="s2">= </span><span class="s1">gsg</span><span class="s2">,</span>
            <span class="s1">host </span><span class="s2">= </span><span class="s1">host</span><span class="s2">, </span><span class="s1">type </span><span class="s2">= </span><span class="s1">type</span><span class="s2">, </span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span><span class="s2">, </span><span class="s1">size </span><span class="s2">= </span><span class="s1">size</span><span class="s2">,</span>
            <span class="s1">aspectRatio </span><span class="s2">= </span><span class="s1">aspectRatio</span><span class="s2">, </span><span class="s1">makeCamera </span><span class="s2">= </span><span class="s1">makeCamera</span><span class="s2">,</span>
            <span class="s1">keepCamera </span><span class="s2">= </span><span class="s1">keepCamera</span><span class="s2">, </span><span class="s1">scene </span><span class="s2">= </span><span class="s1">scene</span><span class="s2">, </span><span class="s1">stereo </span><span class="s2">= </span><span class="s1">stereo</span><span class="s2">,</span>
            <span class="s1">unexposedDraw </span><span class="s2">= </span><span class="s1">unexposedDraw</span><span class="s2">,</span>
            <span class="s1">callbackWindowDict </span><span class="s2">= </span><span class="s1">callbackWindowDict</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">:</span>
            <span class="s4"># If we've already opened a window before, this is just a</span>
            <span class="s4"># pass-through to _doOpenWindow().</span>
            <span class="s1">win </span><span class="s2">= </span><span class="s1">func</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">openWindows</span><span class="s2">()</span>
            <span class="s5">return </span><span class="s1">win</span>

        <span class="s5">if </span><span class="s1">type </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">type </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">windowType</span>
        <span class="s5">if </span><span class="s1">requireWindow </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">requireWindow </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">requireWindow</span>

        <span class="s1">win </span><span class="s2">= </span><span class="s1">func</span><span class="s2">()</span>

        <span class="s4"># Give the window a chance to truly open.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">openWindows</span><span class="s2">()</span>
        <span class="s5">if </span><span class="s1">win </span><span class="s5">is not None and not </span><span class="s1">win</span><span class="s2">.</span><span class="s1">isValid</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Window did not open, removing.&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">closeWindow</span><span class="s2">(</span><span class="s1">win</span><span class="s2">)</span>
            <span class="s1">win </span><span class="s2">= </span><span class="s5">None</span>

        <span class="s5">if </span><span class="s1">win </span><span class="s5">is None and </span><span class="s1">pipe </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s4"># Try a little harder if the window wouldn't open.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">makeAllPipes</span><span class="s2">()</span>
            <span class="s5">try</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">pipeList</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pipe</span><span class="s2">)</span>
            <span class="s5">except </span><span class="s1">ValueError</span><span class="s2">:</span>
                <span class="s5">pass</span>
            <span class="s5">while </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win </span><span class="s5">is None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pipeList</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">pipe </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pipeList</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Trying pipe type %s (%s)&quot; </span><span class="s2">% (</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">pipe</span><span class="s2">.</span><span class="s1">getType</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pipe</span><span class="s2">.</span><span class="s1">getInterfaceName</span><span class="s2">()))</span>
                <span class="s1">win </span><span class="s2">= </span><span class="s1">func</span><span class="s2">()</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">openWindows</span><span class="s2">()</span>
                <span class="s5">if </span><span class="s1">win </span><span class="s5">is not None and not </span><span class="s1">win</span><span class="s2">.</span><span class="s1">isValid</span><span class="s2">():</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Window did not open, removing.&quot;</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">closeWindow</span><span class="s2">(</span><span class="s1">win</span><span class="s2">)</span>
                    <span class="s1">win </span><span class="s2">= </span><span class="s5">None</span>
                <span class="s5">if </span><span class="s1">win </span><span class="s5">is None</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">pipeList</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pipe</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">win </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Unable to open '%s' window.&quot; </span><span class="s2">% (</span><span class="s1">type</span><span class="s2">))</span>
            <span class="s5">if </span><span class="s1">requireWindow</span><span class="s2">:</span>
                <span class="s4"># Unless require-window is set to false, it is an</span>
                <span class="s4"># error not to open a window.</span>
                <span class="s5">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">'Could not open window.'</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Successfully opened window of type %s (%s)&quot; </span><span class="s2">% (</span>
                <span class="s1">win</span><span class="s2">.</span><span class="s1">getType</span><span class="s2">(), </span><span class="s1">win</span><span class="s2">.</span><span class="s1">getPipe</span><span class="s2">().</span><span class="s1">getInterfaceName</span><span class="s2">()))</span>

        <span class="s5">return </span><span class="s1">win</span>

    <span class="s5">def </span><span class="s1">_doOpenWindow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">fbprops </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">pipe </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                      <span class="s1">gsg </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">host </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">type </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">name </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                      <span class="s1">size </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">aspectRatio </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                      <span class="s1">makeCamera </span><span class="s2">= </span><span class="s5">True</span><span class="s2">, </span><span class="s1">keepCamera </span><span class="s2">= </span><span class="s5">False</span><span class="s2">,</span>
                      <span class="s1">scene </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">stereo </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">unexposedDraw </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                      <span class="s1">callbackWindowDict </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s5">if </span><span class="s1">pipe </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">pipe </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pipe</span>

            <span class="s5">if </span><span class="s1">pipe </span><span class="s5">is None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">makeDefaultPipe</span><span class="s2">()</span>
                <span class="s1">pipe </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pipe</span>

            <span class="s5">if </span><span class="s1">pipe </span><span class="s5">is None</span><span class="s2">:</span>
                <span class="s4"># We couldn't get a pipe.</span>
                <span class="s5">return None</span>

        <span class="s5">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">gsg</span><span class="s2">, </span><span class="s1">GraphicsOutput</span><span class="s2">):</span>
            <span class="s4"># If the gsg is a window or buffer, it means to use the</span>
            <span class="s4"># GSG from that buffer.</span>
            <span class="s1">host </span><span class="s2">= </span><span class="s1">gsg</span>
            <span class="s1">gsg </span><span class="s2">= </span><span class="s1">gsg</span><span class="s2">.</span><span class="s1">getGsg</span><span class="s2">()</span>

        <span class="s4"># If we are using DirectX, force a new GSG to be created,</span>
        <span class="s4"># since at the moment DirectX seems to misbehave if we do</span>
        <span class="s4"># not do this.  This will cause a delay while all textures</span>
        <span class="s4"># etc. are reloaded, so we should revisit this later if we</span>
        <span class="s4"># can fix the underlying bug in our DirectX support.</span>
        <span class="s5">if </span><span class="s1">pipe</span><span class="s2">.</span><span class="s1">getType</span><span class="s2">().</span><span class="s1">getName</span><span class="s2">().</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'wdx'</span><span class="s2">):</span>
            <span class="s1">gsg </span><span class="s2">= </span><span class="s5">None</span>

        <span class="s5">if </span><span class="s1">type </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">type </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">windowType</span>

        <span class="s5">if </span><span class="s1">props </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">props </span><span class="s2">= </span><span class="s1">WindowProperties</span><span class="s2">.</span><span class="s1">getDefault</span><span class="s2">()</span>

        <span class="s5">if </span><span class="s1">fbprops </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">fbprops </span><span class="s2">= </span><span class="s1">FrameBufferProperties</span><span class="s2">.</span><span class="s1">getDefault</span><span class="s2">()</span>

        <span class="s5">if </span><span class="s1">size </span><span class="s5">is not None</span><span class="s2">:</span>
            <span class="s4"># If we were given an explicit size, use it; otherwise,</span>
            <span class="s4"># the size from the properties is used.</span>
            <span class="s1">props </span><span class="s2">= </span><span class="s1">WindowProperties</span><span class="s2">(</span><span class="s1">props</span><span class="s2">)</span>
            <span class="s1">props</span><span class="s2">.</span><span class="s1">setSize</span><span class="s2">(</span><span class="s1">size</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">size</span><span class="s2">[</span><span class="s6">1</span><span class="s2">])</span>

        <span class="s5">if </span><span class="s1">name </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s3">'window%s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">nextWindowIndex</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">nextWindowIndex </span><span class="s2">+= </span><span class="s6">1</span>

        <span class="s1">win </span><span class="s2">= </span><span class="s5">None</span>

        <span class="s1">flags </span><span class="s2">= </span><span class="s1">GraphicsPipe</span><span class="s2">.</span><span class="s1">BFFbPropsOptional</span>
        <span class="s5">if </span><span class="s1">type </span><span class="s2">== </span><span class="s3">'onscreen'</span><span class="s2">:</span>
            <span class="s1">flags </span><span class="s2">= </span><span class="s1">flags </span><span class="s2">| </span><span class="s1">GraphicsPipe</span><span class="s2">.</span><span class="s1">BFRequireWindow</span>
        <span class="s5">elif </span><span class="s1">type </span><span class="s2">== </span><span class="s3">'offscreen'</span><span class="s2">:</span>
            <span class="s1">flags </span><span class="s2">= </span><span class="s1">flags </span><span class="s2">| </span><span class="s1">GraphicsPipe</span><span class="s2">.</span><span class="s1">BFRefuseWindow</span>

        <span class="s5">if </span><span class="s1">callbackWindowDict</span><span class="s2">:</span>
            <span class="s1">flags </span><span class="s2">= </span><span class="s1">flags </span><span class="s2">| </span><span class="s1">GraphicsPipe</span><span class="s2">.</span><span class="s1">BFRequireCallbackWindow</span>

        <span class="s5">if </span><span class="s1">host</span><span class="s2">:</span>
            <span class="s5">assert </span><span class="s1">host</span><span class="s2">.</span><span class="s1">isValid</span><span class="s2">()</span>
            <span class="s1">win </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">makeOutput</span><span class="s2">(</span><span class="s1">pipe</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">fbprops</span><span class="s2">,</span>
                                                 <span class="s1">props</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">host</span><span class="s2">.</span><span class="s1">getGsg</span><span class="s2">(), </span><span class="s1">host</span><span class="s2">)</span>
        <span class="s5">elif </span><span class="s1">gsg</span><span class="s2">:</span>
            <span class="s1">win </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">makeOutput</span><span class="s2">(</span><span class="s1">pipe</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">fbprops</span><span class="s2">,</span>
                                                 <span class="s1">props</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">gsg</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">win </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">makeOutput</span><span class="s2">(</span><span class="s1">pipe</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">fbprops</span><span class="s2">,</span>
                                                 <span class="s1">props</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">win </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s4"># Couldn't create a window!</span>
            <span class="s5">return None</span>

        <span class="s5">if </span><span class="s1">unexposedDraw </span><span class="s5">is not None and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">win</span><span class="s2">, </span><span class="s3">'setUnexposedDraw'</span><span class="s2">):</span>
            <span class="s1">win</span><span class="s2">.</span><span class="s1">setUnexposedDraw</span><span class="s2">(</span><span class="s1">unexposedDraw</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">callbackWindowDict</span><span class="s2">:</span>
            <span class="s4"># If we asked for (and received) a CallbackGraphicsWindow,</span>
            <span class="s4"># we now have to assign the callbacks, before we start</span>
            <span class="s4"># trying to do anything with the window.</span>
            <span class="s5">for </span><span class="s1">callbackName </span><span class="s5">in </span><span class="s2">[</span><span class="s3">'Events'</span><span class="s2">, </span><span class="s3">'Properties'</span><span class="s2">, </span><span class="s3">'Render'</span><span class="s2">]:</span>
                <span class="s1">func </span><span class="s2">= </span><span class="s1">callbackWindowDict</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">callbackName</span><span class="s2">, </span><span class="s5">None</span><span class="s2">)</span>
                <span class="s5">if not </span><span class="s1">func</span><span class="s2">:</span>
                    <span class="s5">continue</span>

                <span class="s1">setCallbackName </span><span class="s2">= </span><span class="s3">'set%sCallback' </span><span class="s2">% (</span><span class="s1">callbackName</span><span class="s2">)</span>
                <span class="s1">setCallback </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">win</span><span class="s2">, </span><span class="s1">setCallbackName</span><span class="s2">)</span>
                <span class="s1">setCallback</span><span class="s2">(</span><span class="s1">PythonCallbackObject</span><span class="s2">(</span><span class="s1">func</span><span class="s2">))</span>

            <span class="s4"># We also need to set up the mouse/keyboard objects.</span>
            <span class="s5">for </span><span class="s1">inputName </span><span class="s5">in </span><span class="s1">callbackWindowDict</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'inputDevices'</span><span class="s2">, [</span><span class="s3">'mouse'</span><span class="s2">]):</span>
                <span class="s1">win</span><span class="s2">.</span><span class="s1">createInputDevice</span><span class="s2">(</span><span class="s1">inputName</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">win</span><span class="s2">, </span><span class="s3">&quot;requestProperties&quot;</span><span class="s2">):</span>
            <span class="s1">win</span><span class="s2">.</span><span class="s1">requestProperties</span><span class="s2">(</span><span class="s1">props</span><span class="s2">)</span>

        <span class="s1">mainWindow </span><span class="s2">= </span><span class="s5">False</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">mainWindow </span><span class="s2">= </span><span class="s5">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">win </span><span class="s2">= </span><span class="s1">win</span>
            <span class="s5">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'bufferViewer'</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">bufferViewer</span><span class="s2">.</span><span class="s1">win </span><span class="s2">= </span><span class="s1">win</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">winList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">win</span><span class="s2">)</span>

        <span class="s4"># Set up a 3-d camera for the window by default.</span>
        <span class="s5">if </span><span class="s1">keepCamera</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">makeCamera</span><span class="s2">(</span><span class="s1">win</span><span class="s2">, </span><span class="s1">scene </span><span class="s2">= </span><span class="s1">scene</span><span class="s2">, </span><span class="s1">aspectRatio </span><span class="s2">= </span><span class="s1">aspectRatio</span><span class="s2">,</span>
                            <span class="s1">stereo </span><span class="s2">= </span><span class="s1">stereo</span><span class="s2">, </span><span class="s1">useCamera </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cam</span><span class="s2">)</span>
        <span class="s5">elif </span><span class="s1">makeCamera</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">makeCamera</span><span class="s2">(</span><span class="s1">win</span><span class="s2">, </span><span class="s1">scene </span><span class="s2">= </span><span class="s1">scene</span><span class="s2">, </span><span class="s1">aspectRatio </span><span class="s2">= </span><span class="s1">aspectRatio</span><span class="s2">,</span>
                            <span class="s1">stereo </span><span class="s2">= </span><span class="s1">stereo</span><span class="s2">)</span>

        <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s3">'open_window'</span><span class="s2">, [</span><span class="s1">win</span><span class="s2">, </span><span class="s1">mainWindow</span><span class="s2">])</span>
        <span class="s5">if </span><span class="s1">mainWindow</span><span class="s2">:</span>
            <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s3">'open_main_window'</span><span class="s2">)</span>

        <span class="s5">return </span><span class="s1">win</span>

    <span class="s5">def </span><span class="s1">closeWindow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">win</span><span class="s2">, </span><span class="s1">keepCamera </span><span class="s2">= </span><span class="s5">False</span><span class="s2">, </span><span class="s1">removeWindow </span><span class="s2">= </span><span class="s5">True</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Closes the indicated window and removes it from the list of 
        windows.  If it is the main window, clears the main window 
        pointer to None. 
        &quot;&quot;&quot;</span>
        <span class="s1">win</span><span class="s2">.</span><span class="s1">setActive</span><span class="s2">(</span><span class="s5">False</span><span class="s2">)</span>

        <span class="s4"># First, remove all of the cameras associated with display</span>
        <span class="s4"># regions on the window.</span>
        <span class="s1">numRegions </span><span class="s2">= </span><span class="s1">win</span><span class="s2">.</span><span class="s1">getNumDisplayRegions</span><span class="s2">()</span>
        <span class="s5">for </span><span class="s1">i </span><span class="s5">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">numRegions</span><span class="s2">):</span>
            <span class="s1">dr </span><span class="s2">= </span><span class="s1">win</span><span class="s2">.</span><span class="s1">getDisplayRegion</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
            <span class="s4"># [gjeon] remove drc in base.direct.drList</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">direct </span><span class="s5">is not None</span><span class="s2">:</span>
                <span class="s5">for </span><span class="s1">drc </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">direct</span><span class="s2">.</span><span class="s1">drList</span><span class="s2">:</span>
                    <span class="s5">if </span><span class="s1">drc</span><span class="s2">.</span><span class="s1">cam </span><span class="s2">== </span><span class="s1">dr</span><span class="s2">.</span><span class="s1">getCamera</span><span class="s2">():</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">direct</span><span class="s2">.</span><span class="s1">drList</span><span class="s2">.</span><span class="s1">displayRegionList</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">drc</span><span class="s2">)</span>
                        <span class="s5">break</span>

            <span class="s1">cam </span><span class="s2">= </span><span class="s1">NodePath</span><span class="s2">(</span><span class="s1">dr</span><span class="s2">.</span><span class="s1">getCamera</span><span class="s2">())</span>

            <span class="s1">dr</span><span class="s2">.</span><span class="s1">setCamera</span><span class="s2">(</span><span class="s1">NodePath</span><span class="s2">())</span>

            <span class="s5">if not </span><span class="s1">cam</span><span class="s2">.</span><span class="s1">isEmpty</span><span class="s2">() </span><span class="s5">and </span><span class="s1">\</span>
               <span class="s1">cam</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">getNumDisplayRegions</span><span class="s2">() == </span><span class="s6">0 </span><span class="s5">and </span><span class="s1">\</span>
               <span class="s5">not </span><span class="s1">keepCamera</span><span class="s2">:</span>
                <span class="s4"># If the camera is used by no other DisplayRegions,</span>
                <span class="s4"># remove it.</span>
                <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camList</span><span class="s2">.</span><span class="s1">count</span><span class="s2">(</span><span class="s1">cam</span><span class="s2">) != </span><span class="s6">0</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">camList</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">cam</span><span class="s2">)</span>

                <span class="s4"># Don't throw away self.camera; we want to</span>
                <span class="s4"># preserve it for reopening the window.</span>
                <span class="s5">if </span><span class="s1">cam </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cam</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">cam </span><span class="s2">= </span><span class="s5">None</span>
                <span class="s5">if </span><span class="s1">cam </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cam2d</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">cam2d </span><span class="s2">= </span><span class="s5">None</span>
                <span class="s5">if </span><span class="s1">cam </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cam2dp</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">cam2dp </span><span class="s2">= </span><span class="s5">None</span>
                <span class="s1">cam</span><span class="s2">.</span><span class="s1">removeNode</span><span class="s2">()</span>

        <span class="s4"># [gjeon] remove winControl</span>
        <span class="s5">for </span><span class="s1">winCtrl </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">winControls</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">winCtrl</span><span class="s2">.</span><span class="s1">win </span><span class="s2">== </span><span class="s1">win</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">winControls</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">winCtrl</span><span class="s2">)</span>
                <span class="s5">break</span>
        <span class="s4"># Now we can actually close the window.</span>
        <span class="s5">if </span><span class="s1">removeWindow</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">removeWindow</span><span class="s2">(</span><span class="s1">win</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">winList</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">win</span><span class="s2">)</span>

        <span class="s1">mainWindow </span><span class="s2">= </span><span class="s5">False</span>
        <span class="s5">if </span><span class="s1">win </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">:</span>
            <span class="s1">mainWindow </span><span class="s2">= </span><span class="s5">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">win </span><span class="s2">= </span><span class="s5">None</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">frameRateMeter</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">frameRateMeter</span><span class="s2">.</span><span class="s1">clearWindow</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">frameRateMeter </span><span class="s2">= </span><span class="s5">None</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sceneGraphAnalyzerMeter</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">sceneGraphAnalyzerMeter</span><span class="s2">.</span><span class="s1">clearWindow</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">sceneGraphAnalyzerMeter </span><span class="s2">= </span><span class="s5">None</span>

        <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s3">'close_window'</span><span class="s2">, [</span><span class="s1">win</span><span class="s2">, </span><span class="s1">mainWindow</span><span class="s2">])</span>
        <span class="s5">if </span><span class="s1">mainWindow</span><span class="s2">:</span>
            <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s3">'close_main_window'</span><span class="s2">)</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">winList</span><span class="s2">:</span>
            <span class="s4"># Give the window(s) a chance to actually close before we</span>
            <span class="s4"># continue.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">renderFrame</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">openDefaultWindow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Creates the main window for the first time, without being too 
        particular about the kind of graphics API that is chosen. 
        The suggested window type from the load-display config variable is 
        tried first; if that fails, the first window type that can be 
        successfully opened at all is accepted. 
 
        This is intended to be called only once, at application startup. 
        It is normally called automatically unless window-type is configured 
        to 'none'. 
 
        :returns: True on success, False on failure. 
        &quot;&quot;&quot;</span>

        <span class="s1">startDirect </span><span class="s2">= </span><span class="s1">kw</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'startDirect'</span><span class="s2">, </span><span class="s5">True</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s3">'startDirect' </span><span class="s5">in </span><span class="s1">kw</span><span class="s2">:</span>
            <span class="s5">del </span><span class="s1">kw</span><span class="s2">[</span><span class="s3">'startDirect'</span><span class="s2">]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">openMainWindow</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">startDirect</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__doStartDirect</span><span class="s2">()</span>

        <span class="s5">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win </span><span class="s5">is not None</span>

    <span class="s5">def </span><span class="s1">openMainWindow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Creates the initial, main window for the application, and sets 
        up the mouse and render2d structures appropriately for it.  If 
        this method is called a second time, it will close the 
        previous main window and open a new one, preserving the lens 
        properties in base.camLens. 
 
        :returns: True on success, or False on failure (in which case base.win 
                  may be either None, or the previous, closed window). 
        &quot;&quot;&quot;</span>
        <span class="s1">keepCamera </span><span class="s2">= </span><span class="s1">kw</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'keepCamera'</span><span class="s2">, </span><span class="s5">False</span><span class="s2">)</span>

        <span class="s1">success </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s1">oldWin </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span>
        <span class="s1">oldLens </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camLens</span>
        <span class="s1">oldClearColorActive </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win </span><span class="s5">is not None</span><span class="s2">:</span>
            <span class="s4"># Close the previous window.</span>
            <span class="s1">oldClearColorActive </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">.</span><span class="s1">getClearColorActive</span><span class="s2">()</span>
            <span class="s1">oldClearColor </span><span class="s2">= </span><span class="s1">VBase4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">.</span><span class="s1">getClearColor</span><span class="s2">())</span>
            <span class="s1">oldClearDepthActive </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">.</span><span class="s1">getClearDepthActive</span><span class="s2">()</span>
            <span class="s1">oldClearDepth </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">.</span><span class="s1">getClearDepth</span><span class="s2">()</span>
            <span class="s1">oldClearStencilActive </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">.</span><span class="s1">getClearStencilActive</span><span class="s2">()</span>
            <span class="s1">oldClearStencil </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">.</span><span class="s1">getClearStencil</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">closeWindow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">, </span><span class="s1">keepCamera </span><span class="s2">= </span><span class="s1">keepCamera</span><span class="s2">)</span>

        <span class="s4"># Open a new window.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">openWindow</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">win </span><span class="s2">= </span><span class="s1">oldWin</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">winList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">oldWin</span><span class="s2">)</span>
            <span class="s1">success </span><span class="s2">= </span><span class="s6">0</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win </span><span class="s5">is not None</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">, </span><span class="s1">GraphicsWindow</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">setupMouse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">makeCamera2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantRender2dp</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">makeCamera2dp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">oldLens </span><span class="s5">is not None</span><span class="s2">:</span>
                <span class="s4"># Restore the previous lens properties.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">camNode</span><span class="s2">.</span><span class="s1">setLens</span><span class="s2">(</span><span class="s1">oldLens</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">camLens </span><span class="s2">= </span><span class="s1">oldLens</span>

            <span class="s5">if </span><span class="s1">oldClearColorActive </span><span class="s5">is not None</span><span class="s2">:</span>
                <span class="s4"># Restore the previous clear properties.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">.</span><span class="s1">setClearColorActive</span><span class="s2">(</span><span class="s1">oldClearColorActive</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">.</span><span class="s1">setClearColor</span><span class="s2">(</span><span class="s1">oldClearColor</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">.</span><span class="s1">setClearDepthActive</span><span class="s2">(</span><span class="s1">oldClearDepthActive</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">.</span><span class="s1">setClearDepth</span><span class="s2">(</span><span class="s1">oldClearDepth</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">.</span><span class="s1">setClearStencilActive</span><span class="s2">(</span><span class="s1">oldClearStencilActive</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">.</span><span class="s1">setClearStencil</span><span class="s2">(</span><span class="s1">oldClearStencil</span><span class="s2">)</span>

            <span class="s1">flag </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'show-frame-rate-meter'</span><span class="s2">, </span><span class="s5">False</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner </span><span class="s5">is not None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner</span><span class="s2">.</span><span class="s1">allowPythonDev</span><span class="s2">:</span>
                <span class="s4"># In an allow_python_dev p3d application, we always</span>
                <span class="s4"># start up with the frame rate meter enabled, to</span>
                <span class="s4"># provide a visual reminder that this flag has been</span>
                <span class="s4"># set.</span>
                <span class="s1">flag </span><span class="s2">= </span><span class="s5">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">setFrameRateMeter</span><span class="s2">(</span><span class="s1">flag</span><span class="s2">)</span>
            <span class="s1">flag </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'show-scene-graph-analyzer-meter'</span><span class="s2">, </span><span class="s5">False</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">setSceneGraphAnalyzerMeter</span><span class="s2">(</span><span class="s1">flag</span><span class="s2">)</span>
        <span class="s5">return </span><span class="s1">success</span>

    <span class="s5">def </span><span class="s1">setSleep</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">amount</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Sets up a task that calls python 'sleep' every frame.  This is a simple 
        way to reduce the CPU usage (and frame rate) of a panda program. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">clientSleep </span><span class="s2">== </span><span class="s1">amount</span><span class="s2">):</span>
            <span class="s5">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">clientSleep </span><span class="s2">= </span><span class="s1">amount</span>
        <span class="s5">if </span><span class="s2">(</span><span class="s1">amount </span><span class="s2">== </span><span class="s6">0.0</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">'clientSleep'</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s4"># Spawn it after igloop (at the end of each frame)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">'clientSleep'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__sleepCycleTask</span><span class="s2">, </span><span class="s3">'clientSleep'</span><span class="s2">, </span><span class="s1">sort </span><span class="s2">= </span><span class="s6">55</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">__sleepCycleTask</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">task</span><span class="s2">):</span>
        <span class="s1">Thread</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">clientSleep</span><span class="s2">)</span>
        <span class="s4">#time.sleep(self.clientSleep)</span>
        <span class="s5">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>

    <span class="s5">def </span><span class="s1">setFrameRateMeter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">flag</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Turns on or off (according to flag) a standard frame rate 
        meter in the upper-right corner of the main window. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">flag</span><span class="s2">:</span>
            <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">frameRateMeter</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">frameRateMeter </span><span class="s2">= </span><span class="s1">FrameRateMeter</span><span class="s2">(</span><span class="s3">'frameRateMeter'</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">frameRateMeter</span><span class="s2">.</span><span class="s1">setupWindow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">frameRateMeter</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">frameRateMeter</span><span class="s2">.</span><span class="s1">clearWindow</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">frameRateMeter </span><span class="s2">= </span><span class="s5">None</span>

    <span class="s5">def </span><span class="s1">setSceneGraphAnalyzerMeter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">flag</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Turns on or off (according to flag) a standard frame rate 
        meter in the upper-right corner of the main window. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">flag</span><span class="s2">:</span>
            <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sceneGraphAnalyzerMeter</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">sceneGraphAnalyzerMeter </span><span class="s2">= </span><span class="s1">SceneGraphAnalyzerMeter</span><span class="s2">(</span><span class="s3">'sceneGraphAnalyzerMeter'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">.</span><span class="s1">node</span><span class="s2">())</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">sceneGraphAnalyzerMeter</span><span class="s2">.</span><span class="s1">setupWindow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sceneGraphAnalyzerMeter</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">sceneGraphAnalyzerMeter</span><span class="s2">.</span><span class="s1">clearWindow</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">sceneGraphAnalyzerMeter </span><span class="s2">= </span><span class="s5">None</span>

    <span class="s4"># [gjeon] now you can add more winControls after creating a showbase instance</span>
    <span class="s5">def </span><span class="s1">setupWindowControls</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">winCtrl</span><span class="s2">=</span><span class="s5">None</span><span class="s2">):</span>
        <span class="s5">if </span><span class="s1">winCtrl </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">winCtrl </span><span class="s2">= </span><span class="s1">WindowControls</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">, </span><span class="s1">mouseWatcher</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcher</span><span class="s2">,</span>
                <span class="s1">cam</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera</span><span class="s2">, </span><span class="s1">camNode </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camNode</span><span class="s2">, </span><span class="s1">cam2d</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera2d</span><span class="s2">,</span>
                <span class="s1">mouseKeyboard </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dataRoot</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">&quot;**/*&quot;</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">winControls</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">winCtrl</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">setupRender</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Creates the render scene graph, the primary scene graph for 
        rendering 3-d geometry. 
        &quot;&quot;&quot;</span>
        <span class="s4">#: This is the root of the 3-D scene graph.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render </span><span class="s2">= </span><span class="s1">NodePath</span><span class="s2">(</span><span class="s3">'render'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">.</span><span class="s1">setAttrib</span><span class="s2">(</span><span class="s1">RescaleNormalAttrib</span><span class="s2">.</span><span class="s1">makeDefault</span><span class="s2">())</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">.</span><span class="s1">setTwoSided</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">backfaceCullingEnabled </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">textureEnabled </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">wireframeEnabled </span><span class="s2">= </span><span class="s6">0</span>

    <span class="s5">def </span><span class="s1">setupRender2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Creates the render2d scene graph, the primary scene graph for 
        2-d objects and gui elements that are superimposed over the 
        3-d geometry in the window. 
        &quot;&quot;&quot;</span>
        <span class="s4"># We've already created render2d and aspect2d in ShowBaseGlobal,</span>
        <span class="s4"># for the benefit of creating DirectGui elements before ShowBase.</span>
        <span class="s5">from </span><span class="s2">. </span><span class="s5">import </span><span class="s1">ShowBaseGlobal</span>

        <span class="s4">#: This is the root of the 2-D scene graph.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render2d </span><span class="s2">= </span><span class="s1">ShowBaseGlobal</span><span class="s2">.</span><span class="s1">render2d</span>

        <span class="s4"># Set up some overrides to turn off certain properties which</span>
        <span class="s4"># we probably won't need for 2-d objects.</span>

        <span class="s4"># It's probably important to turn off the depth test, since</span>
        <span class="s4"># many 2-d objects will be drawn over each other without</span>
        <span class="s4"># regard to depth position.</span>

        <span class="s4"># We used to avoid clearing the depth buffer before drawing</span>
        <span class="s4"># render2d, but nowadays we clear it anyway, since we</span>
        <span class="s4"># occasionally want to put 3-d geometry under render2d, and</span>
        <span class="s4"># it's simplest (and seems to be easier on graphics drivers)</span>
        <span class="s4"># if the 2-d scene has been cleared first.</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">render2d</span><span class="s2">.</span><span class="s1">setDepthTest</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render2d</span><span class="s2">.</span><span class="s1">setDepthWrite</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render2d</span><span class="s2">.</span><span class="s1">setMaterialOff</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render2d</span><span class="s2">.</span><span class="s1">setTwoSided</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>

        <span class="s4">#: The normal 2-d DisplayRegion has an aspect ratio that</span>
        <span class="s4">#: matches the window, but its coordinate system is square.</span>
        <span class="s4">#: This means anything we parent to render2d gets stretched.</span>
        <span class="s4">#: For things where that makes a difference, we set up</span>
        <span class="s4">#: aspect2d, which scales things back to the right aspect</span>
        <span class="s4">#: ratio along the X axis (Z is still from -1 to 1)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d </span><span class="s2">= </span><span class="s1">ShowBaseGlobal</span><span class="s2">.</span><span class="s1">aspect2d</span>

        <span class="s1">aspectRatio </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getAspectRatio</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">setScale</span><span class="s2">(</span><span class="s6">1.0 </span><span class="s2">/ </span><span class="s1">aspectRatio</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBackground </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dBackground&quot;</span><span class="s2">)</span>

        <span class="s4">#: The Z position of the top border of the aspect2d screen.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTop </span><span class="s2">= </span><span class="s6">1.0</span>
        <span class="s4">#: The Z position of the bottom border of the aspect2d screen.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottom </span><span class="s2">= -</span><span class="s6">1.0</span>
        <span class="s4">#: The X position of the left border of the aspect2d screen.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeft </span><span class="s2">= -</span><span class="s1">aspectRatio</span>
        <span class="s4">#: The X position of the right border of the aspect2d screen.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRight </span><span class="s2">= </span><span class="s1">aspectRatio</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopCenter </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dTopCenter&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopCenterNs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dTopCenterNS&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomCenter </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dBottomCenter&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomCenterNs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dBottomCenterNS&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeftCenter </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dLeftCenter&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeftCenterNs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dLeftCenterNS&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRightCenter </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dRightCenter&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRightCenterNs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dRightCenterNS&quot;</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopLeft </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dTopLeft&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopLeftNs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dTopLeftNS&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopRight </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dTopRight&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopRightNs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dTopRightNS&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomLeft </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dBottomLeft&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomLeftNs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dBottomLeftNS&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomRight </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dBottomRight&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomRightNs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dBottomRightNS&quot;</span><span class="s2">)</span>

        <span class="s4"># Put the nodes in their places</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopCenter</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTop</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopCenterNs</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTop</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomCenter</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottom</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomCenterNs</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottom</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeftCenter</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeftCenterNs</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRightCenter</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRightCenterNs</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopLeft</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTop</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopLeftNs</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTop</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopRight</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTop</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopRightNs</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTop</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomLeft</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottom</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomLeftNs</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottom</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomRight</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottom</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomRightNs</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottom</span><span class="s2">)</span>

        <span class="s4">#: This special root, pixel2d, uses units in pixels that are relative</span>
        <span class="s4">#: to the window. The upperleft corner of the window is (0, 0),</span>
        <span class="s4">#: the lowerleft corner is (xsize, -ysize), in this coordinate system.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pixel2d </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">render2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">PGTop</span><span class="s2">(</span><span class="s3">&quot;pixel2d&quot;</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pixel2d</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(-</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">xsize</span><span class="s2">, </span><span class="s1">ysize </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getSize</span><span class="s2">()</span>
        <span class="s5">if </span><span class="s1">xsize </span><span class="s2">&gt; </span><span class="s6">0 </span><span class="s5">and </span><span class="s1">ysize </span><span class="s2">&gt; </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pixel2d</span><span class="s2">.</span><span class="s1">setScale</span><span class="s2">(</span><span class="s6">2.0 </span><span class="s2">/ </span><span class="s1">xsize</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">2.0 </span><span class="s2">/ </span><span class="s1">ysize</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">setupRender2dp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Creates a render2d scene graph, the secondary scene graph for 
        2-d objects and gui elements that are superimposed over the 
        2-d and 3-d geometry in the window. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render2dp </span><span class="s2">= </span><span class="s1">NodePath</span><span class="s2">(</span><span class="s3">'render2dp'</span><span class="s2">)</span>

        <span class="s4"># Set up some overrides to turn off certain properties which</span>
        <span class="s4"># we probably won't need for 2-d objects.</span>

        <span class="s4"># It's probably important to turn off the depth test, since</span>
        <span class="s4"># many 2-d objects will be drawn over each other without</span>
        <span class="s4"># regard to depth position.</span>

        <span class="s1">dt </span><span class="s2">= </span><span class="s1">DepthTestAttrib</span><span class="s2">.</span><span class="s1">make</span><span class="s2">(</span><span class="s1">DepthTestAttrib</span><span class="s2">.</span><span class="s1">MNone</span><span class="s2">)</span>
        <span class="s1">dw </span><span class="s2">= </span><span class="s1">DepthWriteAttrib</span><span class="s2">.</span><span class="s1">make</span><span class="s2">(</span><span class="s1">DepthWriteAttrib</span><span class="s2">.</span><span class="s1">MOff</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render2dp</span><span class="s2">.</span><span class="s1">setDepthTest</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render2dp</span><span class="s2">.</span><span class="s1">setDepthWrite</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">render2dp</span><span class="s2">.</span><span class="s1">setMaterialOff</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render2dp</span><span class="s2">.</span><span class="s1">setTwoSided</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>

        <span class="s4">#: The normal 2-d DisplayRegion has an aspect ratio that</span>
        <span class="s4">#: matches the window, but its coordinate system is square.</span>
        <span class="s4">#: This means anything we parent to render2dp gets stretched.</span>
        <span class="s4">#: For things where that makes a difference, we set up</span>
        <span class="s4">#: aspect2dp, which scales things back to the right aspect</span>
        <span class="s4">#: ratio along the X axis (Z is still from -1 to 1)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2dp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">render2dp</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">PGTop</span><span class="s2">(</span><span class="s3">&quot;aspect2dp&quot;</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2dp</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setStartSort</span><span class="s2">(</span><span class="s6">16384</span><span class="s2">)</span>

        <span class="s1">aspectRatio </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getAspectRatio</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2dp</span><span class="s2">.</span><span class="s1">setScale</span><span class="s2">(</span><span class="s6">1.0 </span><span class="s2">/ </span><span class="s1">aspectRatio</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">)</span>

        <span class="s4">#: The Z position of the top border of the aspect2dp screen.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTop </span><span class="s2">= </span><span class="s6">1.0</span>
        <span class="s4">#: The Z position of the bottom border of the aspect2dp screen.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottom </span><span class="s2">= -</span><span class="s6">1.0</span>
        <span class="s4">#: The X position of the left border of the aspect2dp screen.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpLeft </span><span class="s2">= -</span><span class="s1">aspectRatio</span>
        <span class="s4">#: The X position of the right border of the aspect2dp screen.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpRight </span><span class="s2">= </span><span class="s1">aspectRatio</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTopCenter </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2dp</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dpTopCenter&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottomCenter </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2dp</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dpBottomCenter&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpLeftCenter </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2dp</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dpLeftCenter&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpRightCenter </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2dp</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dpRightCenter&quot;</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTopLeft </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2dp</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dpTopLeft&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTopRight </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2dp</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dpTopRight&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottomLeft </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2dp</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dpBottomLeft&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottomRight </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2dp</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">&quot;a2dpBottomRight&quot;</span><span class="s2">)</span>

        <span class="s4"># Put the nodes in their places</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTopCenter</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTop</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottomCenter</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottom</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpLeftCenter</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpRightCenter</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTopLeft</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTop</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTopRight</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTop</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottomLeft</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottom</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottomRight</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottom</span><span class="s2">)</span>

        <span class="s4">#: This special root, pixel2dp, uses units in pixels that are relative</span>
        <span class="s4">#: to the window. The upperleft corner of the window is (0, 0),</span>
        <span class="s4">#: the lowerleft corner is (xsize, -ysize), in this coordinate system.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pixel2dp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">render2dp</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">PGTop</span><span class="s2">(</span><span class="s3">&quot;pixel2dp&quot;</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pixel2dp</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setStartSort</span><span class="s2">(</span><span class="s6">16384</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pixel2dp</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(-</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">xsize</span><span class="s2">, </span><span class="s1">ysize </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getSize</span><span class="s2">()</span>
        <span class="s5">if </span><span class="s1">xsize </span><span class="s2">&gt; </span><span class="s6">0 </span><span class="s5">and </span><span class="s1">ysize </span><span class="s2">&gt; </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pixel2dp</span><span class="s2">.</span><span class="s1">setScale</span><span class="s2">(</span><span class="s6">2.0 </span><span class="s2">/ </span><span class="s1">xsize</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">2.0 </span><span class="s2">/ </span><span class="s1">ysize</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">setAspectRatio</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">aspectRatio</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Sets the global aspect ratio of the main window.  Set it 
        to None to restore automatic scaling. &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__configAspectRatio </span><span class="s2">= </span><span class="s1">aspectRatio</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">adjustWindowAspectRatio</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">getAspectRatio</span><span class="s2">())</span>

    <span class="s5">def </span><span class="s1">getAspectRatio</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">win </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s4"># Returns the actual aspect ratio of the indicated (or main</span>
        <span class="s4"># window), or the default aspect ratio if there is not yet a</span>
        <span class="s4"># main window.</span>

        <span class="s4"># If the config it set, we return that</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__configAspectRatio</span><span class="s2">:</span>
            <span class="s5">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__configAspectRatio</span>

        <span class="s1">aspectRatio </span><span class="s2">= </span><span class="s6">1</span>

        <span class="s5">if </span><span class="s1">win </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">win </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span>

        <span class="s5">if </span><span class="s1">win </span><span class="s5">is not None and </span><span class="s1">win</span><span class="s2">.</span><span class="s1">hasSize</span><span class="s2">() </span><span class="s5">and </span><span class="s1">win</span><span class="s2">.</span><span class="s1">getSbsLeftYSize</span><span class="s2">() != </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">aspectRatio </span><span class="s2">= </span><span class="s1">float</span><span class="s2">(</span><span class="s1">win</span><span class="s2">.</span><span class="s1">getSbsLeftXSize</span><span class="s2">()) / </span><span class="s1">float</span><span class="s2">(</span><span class="s1">win</span><span class="s2">.</span><span class="s1">getSbsLeftYSize</span><span class="s2">())</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">win </span><span class="s5">is None or not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">win</span><span class="s2">, </span><span class="s3">&quot;getRequestedProperties&quot;</span><span class="s2">):</span>
                <span class="s1">props </span><span class="s2">= </span><span class="s1">WindowProperties</span><span class="s2">.</span><span class="s1">getDefault</span><span class="s2">()</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">props </span><span class="s2">= </span><span class="s1">win</span><span class="s2">.</span><span class="s1">getRequestedProperties</span><span class="s2">()</span>
                <span class="s5">if not </span><span class="s1">props</span><span class="s2">.</span><span class="s1">hasSize</span><span class="s2">():</span>
                    <span class="s1">props </span><span class="s2">= </span><span class="s1">WindowProperties</span><span class="s2">.</span><span class="s1">getDefault</span><span class="s2">()</span>

            <span class="s5">if </span><span class="s1">props</span><span class="s2">.</span><span class="s1">hasSize</span><span class="s2">() </span><span class="s5">and </span><span class="s1">props</span><span class="s2">.</span><span class="s1">getYSize</span><span class="s2">() != </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s1">aspectRatio </span><span class="s2">= </span><span class="s1">float</span><span class="s2">(</span><span class="s1">props</span><span class="s2">.</span><span class="s1">getXSize</span><span class="s2">()) / </span><span class="s1">float</span><span class="s2">(</span><span class="s1">props</span><span class="s2">.</span><span class="s1">getYSize</span><span class="s2">())</span>

        <span class="s5">if </span><span class="s1">aspectRatio </span><span class="s2">== </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s5">return </span><span class="s6">1</span>

        <span class="s5">return </span><span class="s1">aspectRatio</span>

    <span class="s5">def </span><span class="s1">getSize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">win </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Returns the actual size of the indicated (or main window), or the 
        default size if there is not yet a main window. 
        &quot;&quot;&quot;</span>

        <span class="s5">if </span><span class="s1">win </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">win </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span>

        <span class="s5">if </span><span class="s1">win </span><span class="s5">is not None and </span><span class="s1">win</span><span class="s2">.</span><span class="s1">hasSize</span><span class="s2">():</span>
            <span class="s5">return </span><span class="s1">win</span><span class="s2">.</span><span class="s1">getXSize</span><span class="s2">(), </span><span class="s1">win</span><span class="s2">.</span><span class="s1">getYSize</span><span class="s2">()</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">win </span><span class="s5">is None or not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">win</span><span class="s2">, </span><span class="s3">&quot;getRequestedProperties&quot;</span><span class="s2">):</span>
                <span class="s1">props </span><span class="s2">= </span><span class="s1">WindowProperties</span><span class="s2">.</span><span class="s1">getDefault</span><span class="s2">()</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">props </span><span class="s2">= </span><span class="s1">win</span><span class="s2">.</span><span class="s1">getRequestedProperties</span><span class="s2">()</span>
                <span class="s5">if not </span><span class="s1">props</span><span class="s2">.</span><span class="s1">hasSize</span><span class="s2">():</span>
                    <span class="s1">props </span><span class="s2">= </span><span class="s1">WindowProperties</span><span class="s2">.</span><span class="s1">getDefault</span><span class="s2">()</span>

            <span class="s5">return </span><span class="s1">props</span><span class="s2">.</span><span class="s1">getXSize</span><span class="s2">(), </span><span class="s1">props</span><span class="s2">.</span><span class="s1">getYSize</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">makeCamera</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">win</span><span class="s2">, </span><span class="s1">sort </span><span class="s2">= </span><span class="s6">0</span><span class="s2">, </span><span class="s1">scene </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                   <span class="s1">displayRegion </span><span class="s2">= (</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">), </span><span class="s1">stereo </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                   <span class="s1">aspectRatio </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">clearDepth </span><span class="s2">= </span><span class="s6">0</span><span class="s2">, </span><span class="s1">clearColor </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                   <span class="s1">lens </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">camName </span><span class="s2">= </span><span class="s3">'cam'</span><span class="s2">, </span><span class="s1">mask </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                   <span class="s1">useCamera </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Makes a new 3-d camera associated with the indicated window, 
        and creates a display region in the indicated subrectangle. 
 
        If stereo is True, then a stereo camera is created, with a 
        pair of DisplayRegions.  If stereo is False, then a standard 
        camera is created.  If stereo is None or omitted, a stereo 
        camera is created if the window says it can render in stereo. 
 
        If useCamera is not None, it is a NodePath to be used as the 
        camera to apply to the window, rather than creating a new 
        camera. 
 
        :rtype: panda3d.core.NodePath 
        &quot;&quot;&quot;</span>
        <span class="s4"># self.camera is the parent node of all cameras: a node that</span>
        <span class="s4"># we can move around to move all cameras as a group.</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s4"># We make it a ModelNode with the PTLocal flag, so that</span>
            <span class="s4"># a wayward flatten operations won't attempt to mangle the</span>
            <span class="s4"># camera.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">camera </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">ModelNode</span><span class="s2">(</span><span class="s3">'camera'</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">camera</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setPreserveTransform</span><span class="s2">(</span><span class="s1">ModelNode</span><span class="s2">.</span><span class="s1">PTLocal</span><span class="s2">)</span>
            <span class="s1">builtins</span><span class="s2">.</span><span class="s1">camera </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">mouse2cam</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setNode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera</span><span class="s2">.</span><span class="s1">node</span><span class="s2">())</span>

        <span class="s5">if </span><span class="s1">useCamera</span><span class="s2">:</span>
            <span class="s4"># Use the existing camera node.</span>
            <span class="s1">cam </span><span class="s2">= </span><span class="s1">useCamera</span>
            <span class="s1">camNode </span><span class="s2">= </span><span class="s1">useCamera</span><span class="s2">.</span><span class="s1">node</span><span class="s2">()</span>
            <span class="s5">assert</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">camNode</span><span class="s2">, </span><span class="s1">Camera</span><span class="s2">))</span>
            <span class="s1">lens </span><span class="s2">= </span><span class="s1">camNode</span><span class="s2">.</span><span class="s1">getLens</span><span class="s2">()</span>
            <span class="s1">cam</span><span class="s2">.</span><span class="s1">reparentTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera</span><span class="s2">)</span>

        <span class="s5">else</span><span class="s2">:</span>
            <span class="s4"># Make a new Camera node.</span>
            <span class="s1">camNode </span><span class="s2">= </span><span class="s1">Camera</span><span class="s2">(</span><span class="s1">camName</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">lens </span><span class="s5">is None</span><span class="s2">:</span>
                <span class="s1">lens </span><span class="s2">= </span><span class="s1">PerspectiveLens</span><span class="s2">()</span>

                <span class="s5">if </span><span class="s1">aspectRatio </span><span class="s5">is None</span><span class="s2">:</span>
                    <span class="s1">aspectRatio </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getAspectRatio</span><span class="s2">(</span><span class="s1">win</span><span class="s2">)</span>
                <span class="s1">lens</span><span class="s2">.</span><span class="s1">setAspectRatio</span><span class="s2">(</span><span class="s1">aspectRatio</span><span class="s2">)</span>

            <span class="s1">cam </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">camNode</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">lens </span><span class="s5">is not None</span><span class="s2">:</span>
            <span class="s1">camNode</span><span class="s2">.</span><span class="s1">setLens</span><span class="s2">(</span><span class="s1">lens</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">scene </span><span class="s5">is not None</span><span class="s2">:</span>
            <span class="s1">camNode</span><span class="s2">.</span><span class="s1">setScene</span><span class="s2">(</span><span class="s1">scene</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">mask </span><span class="s5">is not None</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)):</span>
                <span class="s1">mask </span><span class="s2">= </span><span class="s1">BitMask32</span><span class="s2">(</span><span class="s1">mask</span><span class="s2">)</span>
            <span class="s1">camNode</span><span class="s2">.</span><span class="s1">setCameraMask</span><span class="s2">(</span><span class="s1">mask</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cam </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cam </span><span class="s2">= </span><span class="s1">cam</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">camNode </span><span class="s2">= </span><span class="s1">camNode</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">camLens </span><span class="s2">= </span><span class="s1">lens</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">camList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">cam</span><span class="s2">)</span>

        <span class="s4"># Now, make a DisplayRegion for the camera.</span>
        <span class="s5">if </span><span class="s1">stereo </span><span class="s5">is not None</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">stereo</span><span class="s2">:</span>
                <span class="s1">dr </span><span class="s2">= </span><span class="s1">win</span><span class="s2">.</span><span class="s1">makeStereoDisplayRegion</span><span class="s2">(*</span><span class="s1">displayRegion</span><span class="s2">)</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">dr </span><span class="s2">= </span><span class="s1">win</span><span class="s2">.</span><span class="s1">makeMonoDisplayRegion</span><span class="s2">(*</span><span class="s1">displayRegion</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">dr </span><span class="s2">= </span><span class="s1">win</span><span class="s2">.</span><span class="s1">makeDisplayRegion</span><span class="s2">(*</span><span class="s1">displayRegion</span><span class="s2">)</span>

        <span class="s1">dr</span><span class="s2">.</span><span class="s1">setSort</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">)</span>

        <span class="s4"># By default, we do not clear 3-d display regions (the entire</span>
        <span class="s4"># window will be cleared, which is normally sufficient).  But</span>
        <span class="s4"># we will if clearDepth is specified.</span>
        <span class="s5">if </span><span class="s1">clearDepth</span><span class="s2">:</span>
            <span class="s1">dr</span><span class="s2">.</span><span class="s1">setClearDepthActive</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">clearColor</span><span class="s2">:</span>
            <span class="s1">dr</span><span class="s2">.</span><span class="s1">setClearColorActive</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
            <span class="s1">dr</span><span class="s2">.</span><span class="s1">setClearColor</span><span class="s2">(</span><span class="s1">clearColor</span><span class="s2">)</span>

        <span class="s1">dr</span><span class="s2">.</span><span class="s1">setCamera</span><span class="s2">(</span><span class="s1">cam</span><span class="s2">)</span>

        <span class="s5">return </span><span class="s1">cam</span>

    <span class="s5">def </span><span class="s1">makeCamera2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">win</span><span class="s2">, </span><span class="s1">sort </span><span class="s2">= </span><span class="s6">10</span><span class="s2">,</span>
                     <span class="s1">displayRegion </span><span class="s2">= (</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">), </span><span class="s1">coords </span><span class="s2">= (-</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">),</span>
                     <span class="s1">lens </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">cameraName </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Makes a new camera2d associated with the indicated window, and 
        assigns it to render the indicated subrectangle of render2d. 
 
        :rtype: panda3d.core.NodePath 
        &quot;&quot;&quot;</span>
        <span class="s1">dr </span><span class="s2">= </span><span class="s1">win</span><span class="s2">.</span><span class="s1">makeMonoDisplayRegion</span><span class="s2">(*</span><span class="s1">displayRegion</span><span class="s2">)</span>
        <span class="s1">dr</span><span class="s2">.</span><span class="s1">setSort</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">)</span>

        <span class="s4"># Enable clearing of the depth buffer on this new display</span>
        <span class="s4"># region (see the comment in setupRender2d, above).</span>
        <span class="s1">dr</span><span class="s2">.</span><span class="s1">setClearDepthActive</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>

        <span class="s4"># Make any texture reloads on the gui come up immediately.</span>
        <span class="s1">dr</span><span class="s2">.</span><span class="s1">setIncompleteRender</span><span class="s2">(</span><span class="s5">False</span><span class="s2">)</span>

        <span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">bottom</span><span class="s2">, </span><span class="s1">top </span><span class="s2">= </span><span class="s1">coords</span>

        <span class="s4"># Now make a new Camera node.</span>
        <span class="s5">if </span><span class="s2">(</span><span class="s1">cameraName</span><span class="s2">):</span>
            <span class="s1">cam2dNode </span><span class="s2">= </span><span class="s1">Camera</span><span class="s2">(</span><span class="s3">'cam2d_' </span><span class="s2">+ </span><span class="s1">cameraName</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">cam2dNode </span><span class="s2">= </span><span class="s1">Camera</span><span class="s2">(</span><span class="s3">'cam2d'</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">lens </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">lens </span><span class="s2">= </span><span class="s1">OrthographicLens</span><span class="s2">()</span>
            <span class="s1">lens</span><span class="s2">.</span><span class="s1">setFilmSize</span><span class="s2">(</span><span class="s1">right </span><span class="s2">- </span><span class="s1">left</span><span class="s2">, </span><span class="s1">top </span><span class="s2">- </span><span class="s1">bottom</span><span class="s2">)</span>
            <span class="s1">lens</span><span class="s2">.</span><span class="s1">setFilmOffset</span><span class="s2">((</span><span class="s1">right </span><span class="s2">+ </span><span class="s1">left</span><span class="s2">) * </span><span class="s6">0.5</span><span class="s2">, (</span><span class="s1">top </span><span class="s2">+ </span><span class="s1">bottom</span><span class="s2">) * </span><span class="s6">0.5</span><span class="s2">)</span>
            <span class="s1">lens</span><span class="s2">.</span><span class="s1">setNearFar</span><span class="s2">(-</span><span class="s6">1000</span><span class="s2">, </span><span class="s6">1000</span><span class="s2">)</span>
        <span class="s1">cam2dNode</span><span class="s2">.</span><span class="s1">setLens</span><span class="s2">(</span><span class="s1">lens</span><span class="s2">)</span>

        <span class="s4"># self.camera2d is the analog of self.camera, although it's</span>
        <span class="s4"># not as clear how useful it is.</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera2d </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">camera2d </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">render2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">'camera2d'</span><span class="s2">)</span>

        <span class="s1">camera2d </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">cam2dNode</span><span class="s2">)</span>
        <span class="s1">dr</span><span class="s2">.</span><span class="s1">setCamera</span><span class="s2">(</span><span class="s1">camera2d</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cam2d </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cam2d </span><span class="s2">= </span><span class="s1">camera2d</span>

        <span class="s5">return </span><span class="s1">camera2d</span>

    <span class="s5">def </span><span class="s1">makeCamera2dp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">win</span><span class="s2">, </span><span class="s1">sort </span><span class="s2">= </span><span class="s6">20</span><span class="s2">,</span>
                      <span class="s1">displayRegion </span><span class="s2">= (</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">), </span><span class="s1">coords </span><span class="s2">= (-</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">),</span>
                      <span class="s1">lens </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">cameraName </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Makes a new camera2dp associated with the indicated window, and 
        assigns it to render the indicated subrectangle of render2dp. 
 
        :rtype: panda3d.core.NodePath 
        &quot;&quot;&quot;</span>
        <span class="s1">dr </span><span class="s2">= </span><span class="s1">win</span><span class="s2">.</span><span class="s1">makeMonoDisplayRegion</span><span class="s2">(*</span><span class="s1">displayRegion</span><span class="s2">)</span>
        <span class="s1">dr</span><span class="s2">.</span><span class="s1">setSort</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">)</span>

        <span class="s4"># Unlike render2d, we don't clear the depth buffer for</span>
        <span class="s4"># render2dp.  Caveat emptor.</span>

        <span class="s5">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dr</span><span class="s2">, </span><span class="s3">'setIncompleteRender'</span><span class="s2">):</span>
            <span class="s1">dr</span><span class="s2">.</span><span class="s1">setIncompleteRender</span><span class="s2">(</span><span class="s5">False</span><span class="s2">)</span>

        <span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">bottom</span><span class="s2">, </span><span class="s1">top </span><span class="s2">= </span><span class="s1">coords</span>

        <span class="s4"># Now make a new Camera node.</span>
        <span class="s5">if </span><span class="s2">(</span><span class="s1">cameraName</span><span class="s2">):</span>
            <span class="s1">cam2dNode </span><span class="s2">= </span><span class="s1">Camera</span><span class="s2">(</span><span class="s3">'cam2dp_' </span><span class="s2">+ </span><span class="s1">cameraName</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">cam2dNode </span><span class="s2">= </span><span class="s1">Camera</span><span class="s2">(</span><span class="s3">'cam2dp'</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">lens </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">lens </span><span class="s2">= </span><span class="s1">OrthographicLens</span><span class="s2">()</span>
            <span class="s1">lens</span><span class="s2">.</span><span class="s1">setFilmSize</span><span class="s2">(</span><span class="s1">right </span><span class="s2">- </span><span class="s1">left</span><span class="s2">, </span><span class="s1">top </span><span class="s2">- </span><span class="s1">bottom</span><span class="s2">)</span>
            <span class="s1">lens</span><span class="s2">.</span><span class="s1">setFilmOffset</span><span class="s2">((</span><span class="s1">right </span><span class="s2">+ </span><span class="s1">left</span><span class="s2">) * </span><span class="s6">0.5</span><span class="s2">, (</span><span class="s1">top </span><span class="s2">+ </span><span class="s1">bottom</span><span class="s2">) * </span><span class="s6">0.5</span><span class="s2">)</span>
            <span class="s1">lens</span><span class="s2">.</span><span class="s1">setNearFar</span><span class="s2">(-</span><span class="s6">1000</span><span class="s2">, </span><span class="s6">1000</span><span class="s2">)</span>
        <span class="s1">cam2dNode</span><span class="s2">.</span><span class="s1">setLens</span><span class="s2">(</span><span class="s1">lens</span><span class="s2">)</span>

        <span class="s4"># self.camera2d is the analog of self.camera, although it's</span>
        <span class="s4"># not as clear how useful it is.</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera2dp </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">camera2dp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">render2dp</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">'camera2dp'</span><span class="s2">)</span>

        <span class="s1">camera2dp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera2dp</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">cam2dNode</span><span class="s2">)</span>
        <span class="s1">dr</span><span class="s2">.</span><span class="s1">setCamera</span><span class="s2">(</span><span class="s1">camera2dp</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cam2dp </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cam2dp </span><span class="s2">= </span><span class="s1">camera2dp</span>

        <span class="s5">return </span><span class="s1">camera2dp</span>

    <span class="s5">def </span><span class="s1">setupDataGraph</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Creates the data graph and populates it with the basic input 
        devices. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dataRoot </span><span class="s2">= </span><span class="s1">NodePath</span><span class="s2">(</span><span class="s3">'dataRoot'</span><span class="s2">)</span>
        <span class="s4"># Cache the node so we do not ask for it every frame</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dataRootNode </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dataRoot</span><span class="s2">.</span><span class="s1">node</span><span class="s2">()</span>

        <span class="s4"># Now we have the main trackball &amp; drive interfaces.</span>
        <span class="s4"># useTrackball() and useDrive() switch these in and out; only</span>
        <span class="s4"># one is in use at a given time.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">trackball </span><span class="s2">= </span><span class="s1">NodePath</span><span class="s2">(</span><span class="s1">Trackball</span><span class="s2">(</span><span class="s3">'trackball'</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">drive </span><span class="s2">= </span><span class="s1">NodePath</span><span class="s2">(</span><span class="s1">DriveInterface</span><span class="s2">(</span><span class="s3">'drive'</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mouse2cam </span><span class="s2">= </span><span class="s1">NodePath</span><span class="s2">(</span><span class="s1">Transform2SG</span><span class="s2">(</span><span class="s3">'mouse2cam'</span><span class="s2">))</span>

    <span class="s4"># [gjeon] now you can create multiple mouse watchers to support multiple windows</span>
    <span class="s5">def </span><span class="s1">setupMouse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">win</span><span class="s2">, </span><span class="s1">fMultiWin</span><span class="s2">=</span><span class="s5">False</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Creates the structures necessary to monitor the mouse input, 
        using the indicated window.  If the mouse has already been set 
        up for a different window, those structures are deleted first. 
 
        :param fMultiWin: If True, then the previous mouse structures are not 
                          deleted; instead, multiple windows are allowed to 
                          monitor the mouse input.  However, in this case, the 
                          trackball controls are not set up, and must be set up 
                          by hand if desired. 
 
        :returns: The ButtonThrower NodePath created for this window. 
        &quot;&quot;&quot;</span>
        <span class="s5">if not </span><span class="s1">fMultiWin </span><span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buttonThrowers </span><span class="s5">is not None</span><span class="s2">:</span>
            <span class="s5">for </span><span class="s1">bt </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buttonThrowers</span><span class="s2">:</span>
                <span class="s1">mw </span><span class="s2">= </span><span class="s1">bt</span><span class="s2">.</span><span class="s1">getParent</span><span class="s2">()</span>
                <span class="s1">mk </span><span class="s2">= </span><span class="s1">mw</span><span class="s2">.</span><span class="s1">getParent</span><span class="s2">()</span>
                <span class="s1">bt</span><span class="s2">.</span><span class="s1">removeNode</span><span class="s2">()</span>
                <span class="s1">mw</span><span class="s2">.</span><span class="s1">removeNode</span><span class="s2">()</span>
                <span class="s1">mk</span><span class="s2">.</span><span class="s1">removeNode</span><span class="s2">()</span>

        <span class="s1">bts</span><span class="s2">, </span><span class="s1">pws </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">setupMouseCB</span><span class="s2">(</span><span class="s1">win</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">fMultiWin</span><span class="s2">:</span>
            <span class="s5">return </span><span class="s1">bts</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">buttonThrowers </span><span class="s2">= </span><span class="s1">bts</span><span class="s2">[:]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pointerWatcherNodes </span><span class="s2">= </span><span class="s1">pws</span><span class="s2">[:]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcher </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buttonThrowers</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">getParent</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcherNode </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcher</span><span class="s2">.</span><span class="s1">node</span><span class="s2">()</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseInterface</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseInterface</span><span class="s2">.</span><span class="s1">reparentTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcher</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recorder</span><span class="s2">:</span>
            <span class="s4"># If we have a recorder, the mouseWatcher belongs under a</span>
            <span class="s4"># special MouseRecorder node, which may intercept the</span>
            <span class="s4"># mouse activity.</span>
            <span class="s1">mw </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buttonThrowers</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">getParent</span><span class="s2">()</span>
            <span class="s1">mouseRecorder </span><span class="s2">= </span><span class="s1">MouseRecorder</span><span class="s2">(</span><span class="s3">'mouse'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">recorder</span><span class="s2">.</span><span class="s1">addRecorder</span><span class="s2">(</span><span class="s3">'mouse'</span><span class="s2">, </span><span class="s1">mouseRecorder</span><span class="s2">)</span>
            <span class="s1">np </span><span class="s2">= </span><span class="s1">mw</span><span class="s2">.</span><span class="s1">getParent</span><span class="s2">().</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">mouseRecorder</span><span class="s2">)</span>
            <span class="s1">mw</span><span class="s2">.</span><span class="s1">reparentTo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">)</span>


        <span class="s1">mw </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buttonThrowers</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">getParent</span><span class="s2">()</span>

        <span class="s4">#: A special ButtonThrower to generate keyboard events and</span>
        <span class="s4">#: include the time from the OS.  This is separate only to</span>
        <span class="s4">#: support legacy code that did not expect a time parameter; it</span>
        <span class="s4">#: will eventually be folded into the normal ButtonThrower,</span>
        <span class="s4">#: above.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">timeButtonThrower </span><span class="s2">= </span><span class="s1">mw</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">ButtonThrower</span><span class="s2">(</span><span class="s3">'timeButtons'</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">timeButtonThrower</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setPrefix</span><span class="s2">(</span><span class="s3">'time-'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">timeButtonThrower</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setTimeFlag</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>

        <span class="s4"># Tell the gui system about our new mouse watcher.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setMouseWatcher</span><span class="s2">(</span><span class="s1">mw</span><span class="s2">.</span><span class="s1">node</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pixel2d</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setMouseWatcher</span><span class="s2">(</span><span class="s1">mw</span><span class="s2">.</span><span class="s1">node</span><span class="s2">())</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantRender2dp</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2dp</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setMouseWatcher</span><span class="s2">(</span><span class="s1">mw</span><span class="s2">.</span><span class="s1">node</span><span class="s2">())</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pixel2dp</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setMouseWatcher</span><span class="s2">(</span><span class="s1">mw</span><span class="s2">.</span><span class="s1">node</span><span class="s2">())</span>

        <span class="s1">mw</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">addRegion</span><span class="s2">(</span><span class="s1">PGMouseWatcherBackground</span><span class="s2">())</span>

        <span class="s5">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buttonThrowers</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>

    <span class="s4"># [gjeon] this function is seperated from setupMouse to allow multiple mouse watchers</span>
    <span class="s5">def </span><span class="s1">setupMouseCB</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">win</span><span class="s2">):</span>
        <span class="s4"># For each mouse/keyboard device, we create</span>
        <span class="s4">#  - MouseAndKeyboard</span>
        <span class="s4">#  - MouseWatcher</span>
        <span class="s4">#  - ButtonThrower</span>
        <span class="s4"># The ButtonThrowers are stored in a list, self.buttonThrowers.</span>
        <span class="s4"># Given a ButtonThrower, one can access the MouseWatcher and</span>
        <span class="s4"># MouseAndKeyboard using getParent.</span>
        <span class="s4">#</span>
        <span class="s4"># The MouseAndKeyboard generates mouse events and mouse</span>
        <span class="s4"># button/keyboard events; the MouseWatcher passes them through</span>
        <span class="s4"># unchanged when the mouse is not over a 2-d button, and passes</span>
        <span class="s4"># nothing through when the mouse *is* over a 2-d button.  Therefore,</span>
        <span class="s4"># objects that don't want to get events when the mouse is over a</span>
        <span class="s4"># button, like the driveInterface, should be parented to</span>
        <span class="s4"># MouseWatcher, while objects that want events in all cases, like the</span>
        <span class="s4"># chat interface, should be parented to the MouseAndKeyboard.</span>

        <span class="s1">buttonThrowers </span><span class="s2">= []</span>
        <span class="s1">pointerWatcherNodes </span><span class="s2">= []</span>
        <span class="s5">for </span><span class="s1">i </span><span class="s5">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">win</span><span class="s2">.</span><span class="s1">getNumInputDevices</span><span class="s2">()):</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">win</span><span class="s2">.</span><span class="s1">getInputDeviceName</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
            <span class="s1">mk </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dataRoot</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">MouseAndKeyboard</span><span class="s2">(</span><span class="s1">win</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">name</span><span class="s2">))</span>
            <span class="s1">mw </span><span class="s2">= </span><span class="s1">mk</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">MouseWatcher</span><span class="s2">(</span><span class="s3">&quot;watcher%s&quot; </span><span class="s2">% (</span><span class="s1">i</span><span class="s2">)))</span>

            <span class="s5">if </span><span class="s1">win</span><span class="s2">.</span><span class="s1">getSideBySideStereo</span><span class="s2">():</span>
                <span class="s4"># If the window has side-by-side stereo enabled, then</span>
                <span class="s4"># we should constrain the MouseWatcher to the window's</span>
                <span class="s4"># DisplayRegion.  This will enable the MouseWatcher to</span>
                <span class="s4"># track the left and right halves of the screen</span>
                <span class="s4"># individually.</span>
                <span class="s1">mw</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setDisplayRegion</span><span class="s2">(</span><span class="s1">win</span><span class="s2">.</span><span class="s1">getOverlayDisplayRegion</span><span class="s2">())</span>

            <span class="s1">mb </span><span class="s2">= </span><span class="s1">mw</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">getModifierButtons</span><span class="s2">()</span>
            <span class="s1">mb</span><span class="s2">.</span><span class="s1">addButton</span><span class="s2">(</span><span class="s1">KeyboardButton</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">())</span>
            <span class="s1">mb</span><span class="s2">.</span><span class="s1">addButton</span><span class="s2">(</span><span class="s1">KeyboardButton</span><span class="s2">.</span><span class="s1">control</span><span class="s2">())</span>
            <span class="s1">mb</span><span class="s2">.</span><span class="s1">addButton</span><span class="s2">(</span><span class="s1">KeyboardButton</span><span class="s2">.</span><span class="s1">alt</span><span class="s2">())</span>
            <span class="s1">mb</span><span class="s2">.</span><span class="s1">addButton</span><span class="s2">(</span><span class="s1">KeyboardButton</span><span class="s2">.</span><span class="s1">meta</span><span class="s2">())</span>
            <span class="s1">mw</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setModifierButtons</span><span class="s2">(</span><span class="s1">mb</span><span class="s2">)</span>
            <span class="s1">bt </span><span class="s2">= </span><span class="s1">mw</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">ButtonThrower</span><span class="s2">(</span><span class="s3">&quot;buttons%s&quot; </span><span class="s2">% (</span><span class="s1">i</span><span class="s2">)))</span>
            <span class="s5">if </span><span class="s2">(</span><span class="s1">i </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">):</span>
                <span class="s1">bt</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setPrefix</span><span class="s2">(</span><span class="s3">'mousedev%s-' </span><span class="s2">% (</span><span class="s1">i</span><span class="s2">))</span>
            <span class="s1">mods </span><span class="s2">= </span><span class="s1">ModifierButtons</span><span class="s2">()</span>
            <span class="s1">mods</span><span class="s2">.</span><span class="s1">addButton</span><span class="s2">(</span><span class="s1">KeyboardButton</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">())</span>
            <span class="s1">mods</span><span class="s2">.</span><span class="s1">addButton</span><span class="s2">(</span><span class="s1">KeyboardButton</span><span class="s2">.</span><span class="s1">control</span><span class="s2">())</span>
            <span class="s1">mods</span><span class="s2">.</span><span class="s1">addButton</span><span class="s2">(</span><span class="s1">KeyboardButton</span><span class="s2">.</span><span class="s1">alt</span><span class="s2">())</span>
            <span class="s1">mods</span><span class="s2">.</span><span class="s1">addButton</span><span class="s2">(</span><span class="s1">KeyboardButton</span><span class="s2">.</span><span class="s1">meta</span><span class="s2">())</span>
            <span class="s1">bt</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setModifierButtons</span><span class="s2">(</span><span class="s1">mods</span><span class="s2">)</span>
            <span class="s1">buttonThrowers</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">bt</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s2">(</span><span class="s1">win</span><span class="s2">.</span><span class="s1">hasPointer</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)):</span>
                <span class="s1">pointerWatcherNodes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">mw</span><span class="s2">.</span><span class="s1">node</span><span class="s2">())</span>

        <span class="s5">return </span><span class="s1">buttonThrowers</span><span class="s2">, </span><span class="s1">pointerWatcherNodes</span>

    <span class="s5">def </span><span class="s1">enableSoftwareMousePointer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Creates some geometry and parents it to render2d to show 
        the currently-known mouse position.  Useful if the mouse 
        pointer is invisible for some reason. 
        &quot;&quot;&quot;</span>
        <span class="s1">mouseViz </span><span class="s2">= </span><span class="s1">render2d</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">'mouseViz'</span><span class="s2">)</span>
        <span class="s1">lilsmiley </span><span class="s2">= </span><span class="s1">loader</span><span class="s2">.</span><span class="s1">loadModel</span><span class="s2">(</span><span class="s3">'lilsmiley'</span><span class="s2">)</span>
        <span class="s1">lilsmiley</span><span class="s2">.</span><span class="s1">reparentTo</span><span class="s2">(</span><span class="s1">mouseViz</span><span class="s2">)</span>

        <span class="s1">aspectRatio </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getAspectRatio</span><span class="s2">()</span>
        <span class="s4"># Scale the smiley face to 32x32 pixels.</span>
        <span class="s1">height </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">.</span><span class="s1">getSbsLeftYSize</span><span class="s2">()</span>
        <span class="s1">lilsmiley</span><span class="s2">.</span><span class="s1">setScale</span><span class="s2">(</span>
            <span class="s6">32.0 </span><span class="s2">/ </span><span class="s1">height </span><span class="s2">/ </span><span class="s1">aspectRatio</span><span class="s2">,</span>
            <span class="s6">1.0</span><span class="s2">, </span><span class="s6">32.0 </span><span class="s2">/ </span><span class="s1">height</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcherNode</span><span class="s2">.</span><span class="s1">setGeometry</span><span class="s2">(</span><span class="s1">mouseViz</span><span class="s2">.</span><span class="s1">node</span><span class="s2">())</span>

    <span class="s5">def </span><span class="s1">getAlt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Returns True if the alt key is currently held down. 
        &quot;&quot;&quot;</span>
        <span class="s5">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcherNode</span><span class="s2">.</span><span class="s1">getModifierButtons</span><span class="s2">().</span><span class="s1">isDown</span><span class="s2">(</span>
            <span class="s1">KeyboardButton</span><span class="s2">.</span><span class="s1">alt</span><span class="s2">())</span>

    <span class="s5">def </span><span class="s1">getShift</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Returns True if the shift key is currently held down. 
        &quot;&quot;&quot;</span>
        <span class="s5">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcherNode</span><span class="s2">.</span><span class="s1">getModifierButtons</span><span class="s2">().</span><span class="s1">isDown</span><span class="s2">(</span>
            <span class="s1">KeyboardButton</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">())</span>

    <span class="s5">def </span><span class="s1">getControl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Returns True if the control key is currently held down. 
        &quot;&quot;&quot;</span>
        <span class="s5">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcherNode</span><span class="s2">.</span><span class="s1">getModifierButtons</span><span class="s2">().</span><span class="s1">isDown</span><span class="s2">(</span>
            <span class="s1">KeyboardButton</span><span class="s2">.</span><span class="s1">control</span><span class="s2">())</span>

    <span class="s5">def </span><span class="s1">getMeta</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Returns True if the meta key is currently held down. 
        &quot;&quot;&quot;</span>
        <span class="s5">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcherNode</span><span class="s2">.</span><span class="s1">getModifierButtons</span><span class="s2">().</span><span class="s1">isDown</span><span class="s2">(</span>
            <span class="s1">KeyboardButton</span><span class="s2">.</span><span class="s1">meta</span><span class="s2">())</span>

    <span class="s5">def </span><span class="s1">attachInputDevice</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">device</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s5">None</span><span class="s2">, </span><span class="s1">watch</span><span class="s2">=</span><span class="s5">False</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        This function attaches an input device to the data graph, which will 
        cause the device to be polled and generate events.  If a prefix is 
        given and not None, it is used to prefix events generated by this 
        device, separated by a hyphen. 
 
        The watch argument can be set to True (as of Panda3D 1.10.3) to set up 
        the default MouseWatcher to receive inputs from this device, allowing 
        it to be polled via mouseWatcherNode and control user interfaces. 
        Setting this to True will also make it generate unprefixed events, 
        regardless of the specified prefix. 
 
        If you call this, you should consider calling detachInputDevice when 
        you are done with the device or when it is disconnected. 
        &quot;&quot;&quot;</span>

        <span class="s4"># Protect against the same device being attached multiple times.</span>
        <span class="s5">assert </span><span class="s1">device </span><span class="s5">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__inputDeviceNodes</span>

        <span class="s1">idn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dataRoot</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">InputDeviceNode</span><span class="s2">(</span><span class="s1">device</span><span class="s2">, </span><span class="s1">device</span><span class="s2">.</span><span class="s1">name</span><span class="s2">))</span>

        <span class="s4"># Setup the button thrower to generate events for the device.</span>
        <span class="s5">if </span><span class="s1">prefix </span><span class="s5">is not None or not </span><span class="s1">watch</span><span class="s2">:</span>
            <span class="s1">bt </span><span class="s2">= </span><span class="s1">idn</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">ButtonThrower</span><span class="s2">(</span><span class="s1">device</span><span class="s2">.</span><span class="s1">name</span><span class="s2">))</span>
            <span class="s5">if </span><span class="s1">prefix </span><span class="s5">is not None</span><span class="s2">:</span>
                <span class="s1">bt</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setPrefix</span><span class="s2">(</span><span class="s1">prefix </span><span class="s2">+ </span><span class="s3">'-'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">deviceButtonThrowers</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">bt</span><span class="s2">)</span>

        <span class="s5">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;Attached input device {0} with prefix {1}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">device</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__inputDeviceNodes</span><span class="s2">[</span><span class="s1">device</span><span class="s2">] = </span><span class="s1">idn</span>

        <span class="s5">if </span><span class="s1">watch</span><span class="s2">:</span>
            <span class="s1">idn</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">addChild</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcherNode</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">detachInputDevice</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">device</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        This should be called after attaching an input device using 
        attachInputDevice and the device is disconnected or you no longer wish 
        to keep polling this device for events. 
 
        You do not strictly need to call this if you expect the device to be 
        reconnected (but be careful that you don't reattach it). 
        &quot;&quot;&quot;</span>

        <span class="s5">if </span><span class="s1">device </span><span class="s5">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__inputDeviceNodes</span><span class="s2">:</span>
            <span class="s5">assert </span><span class="s1">device </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__inputDeviceNodes</span>
            <span class="s5">return</span>

        <span class="s5">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;Detached device {0}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">device</span><span class="s2">.</span><span class="s1">name</span><span class="s2">))</span>

        <span class="s4"># Remove the ButtonThrower from the deviceButtonThrowers list.</span>
        <span class="s1">idn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__inputDeviceNodes</span><span class="s2">[</span><span class="s1">device</span><span class="s2">]</span>
        <span class="s5">for </span><span class="s1">bt </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">deviceButtonThrowers</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">idn</span><span class="s2">.</span><span class="s1">isAncestorOf</span><span class="s2">(</span><span class="s1">bt</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">deviceButtonThrowers</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">bt</span><span class="s2">)</span>
                <span class="s5">break</span>

        <span class="s1">idn</span><span class="s2">.</span><span class="s1">removeNode</span><span class="s2">()</span>
        <span class="s5">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__inputDeviceNodes</span><span class="s2">[</span><span class="s1">device</span><span class="s2">]</span>

    <span class="s5">def </span><span class="s1">addAngularIntegrator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Adds a :class:`~panda3d.physics.AngularEulerIntegrator` to the default 
        physics manager.  By default, only a 
        :class:`~panda3d.physics.LinearEulerIntegrator` is attached. 
        &quot;&quot;&quot;</span>
        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">physicsMgrAngular</span><span class="s2">:</span>
            <span class="s1">physics </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">'panda3d.physics'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">physicsMgrAngular </span><span class="s2">= </span><span class="s6">1</span>
            <span class="s1">integrator </span><span class="s2">= </span><span class="s1">physics</span><span class="s2">.</span><span class="s1">AngularEulerIntegrator</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">physicsMgr</span><span class="s2">.</span><span class="s1">attachAngularIntegrator</span><span class="s2">(</span><span class="s1">integrator</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">enableParticles</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Enables the particle and physics managers, which are stored in 
        `particleMgr` and `physicsMgr` members, respectively.  Also starts a 
        task to periodically update these managers. 
 
        By default, only a :class:`~panda3d.physics.LinearEulerIntegrator` is 
        attached to the physics manager.  To attach an angular integrator, 
        follow this up with a call to `addAngularIntegrator()`. 
        &quot;&quot;&quot;</span>
        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">particleMgrEnabled</span><span class="s2">:</span>
            <span class="s4"># Use importlib to prevent this import from being picked up</span>
            <span class="s4"># by modulefinder when packaging an application.</span>

            <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">particleMgr</span><span class="s2">:</span>
                <span class="s1">PMG </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">'direct.particles.ParticleManagerGlobal'</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">particleMgr </span><span class="s2">= </span><span class="s1">PMG</span><span class="s2">.</span><span class="s1">particleMgr</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">particleMgr</span><span class="s2">.</span><span class="s1">setFrameStepping</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>

            <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">physicsMgr</span><span class="s2">:</span>
                <span class="s1">PMG </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">'direct.showbase.PhysicsManagerGlobal'</span><span class="s2">)</span>
                <span class="s1">physics </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">'panda3d.physics'</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">physicsMgr </span><span class="s2">= </span><span class="s1">PMG</span><span class="s2">.</span><span class="s1">physicsMgr</span>
                <span class="s1">integrator </span><span class="s2">= </span><span class="s1">physics</span><span class="s2">.</span><span class="s1">LinearEulerIntegrator</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">physicsMgr</span><span class="s2">.</span><span class="s1">attachLinearIntegrator</span><span class="s2">(</span><span class="s1">integrator</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">particleMgrEnabled </span><span class="s2">= </span><span class="s6">1</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">physicsMgrEnabled </span><span class="s2">= </span><span class="s6">1</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">'manager-update'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">updateManagers</span><span class="s2">, </span><span class="s3">'manager-update'</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">disableParticles</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        The opposite of `enableParticles()`. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">particleMgrEnabled</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">particleMgrEnabled </span><span class="s2">= </span><span class="s6">0</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">physicsMgrEnabled </span><span class="s2">= </span><span class="s6">0</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">'manager-update'</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">toggleParticles</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Calls `enableParticles()` or `disableParticles()` depending on the 
        current state. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">particleMgrEnabled </span><span class="s2">== </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">enableParticles</span><span class="s2">()</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">disableParticles</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">isParticleMgrEnabled</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Returns True if `enableParticles()` has been called. 
        &quot;&quot;&quot;</span>
        <span class="s5">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">particleMgrEnabled</span>

    <span class="s5">def </span><span class="s1">isPhysicsMgrEnabled</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Returns True if `enableParticles()` has been called. 
        &quot;&quot;&quot;</span>
        <span class="s5">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">physicsMgrEnabled</span>

    <span class="s5">def </span><span class="s1">updateManagers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">state</span><span class="s2">):</span>
        <span class="s1">dt </span><span class="s2">= </span><span class="s1">globalClock</span><span class="s2">.</span><span class="s1">getDt</span><span class="s2">()</span>
        <span class="s5">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">particleMgrEnabled </span><span class="s2">== </span><span class="s6">1</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">particleMgr</span><span class="s2">.</span><span class="s1">doParticles</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">physicsMgrEnabled </span><span class="s2">== </span><span class="s6">1</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">physicsMgr</span><span class="s2">.</span><span class="s1">doPhysics</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s5">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>

    <span class="s5">def </span><span class="s1">createStats</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">hostname</span><span class="s2">=</span><span class="s5">None</span><span class="s2">, </span><span class="s1">port</span><span class="s2">=</span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        If want-pstats is set in Config.prc, or the `wantStats` member is 
        otherwise set to True, connects to the PStats server. 
        This is normally called automatically from the ShowBase constructor. 
        &quot;&quot;&quot;</span>
        <span class="s4"># You can specify pstats-host in your Config.prc or use ~pstats/~aipstats</span>
        <span class="s4"># The default is localhost</span>
        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantStats</span><span class="s2">:</span>
            <span class="s5">return False</span>

        <span class="s5">if </span><span class="s1">PStatClient</span><span class="s2">.</span><span class="s1">isConnected</span><span class="s2">():</span>
            <span class="s1">PStatClient</span><span class="s2">.</span><span class="s1">disconnect</span><span class="s2">()</span>
        <span class="s4"># these default values match the C++ default values</span>
        <span class="s5">if </span><span class="s1">hostname </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">hostname </span><span class="s2">= </span><span class="s3">''</span>
        <span class="s5">if </span><span class="s1">port </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">port </span><span class="s2">= -</span><span class="s6">1</span>
        <span class="s1">PStatClient</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">hostname</span><span class="s2">, </span><span class="s1">port</span><span class="s2">)</span>
        <span class="s5">return </span><span class="s1">PStatClient</span><span class="s2">.</span><span class="s1">isConnected</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">addSfxManager</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">extraSfxManager</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Adds an additional SFX audio manager to `sfxManagerList`, the list of 
        managers managed by ShowBase. 
        &quot;&quot;&quot;</span>
        <span class="s4"># keep a list of sfx manager objects to apply settings to,</span>
        <span class="s4"># since there may be others in addition to the one we create here</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sfxManagerList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">extraSfxManager</span><span class="s2">)</span>
        <span class="s1">newSfxManagerIsValid </span><span class="s2">= (</span><span class="s1">extraSfxManager</span><span class="s2">!=</span><span class="s5">None</span><span class="s2">) </span><span class="s5">and </span><span class="s1">extraSfxManager</span><span class="s2">.</span><span class="s1">isValid</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sfxManagerIsValidList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">newSfxManagerIsValid</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">newSfxManagerIsValid</span><span class="s2">:</span>
            <span class="s1">extraSfxManager</span><span class="s2">.</span><span class="s1">setActive</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sfxActive</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">createBaseAudioManagers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Creates the default SFX and music manager.  Called automatically from 
        the ShowBase constructor. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sfxPlayer </span><span class="s2">= </span><span class="s1">SfxPlayer</span><span class="s2">.</span><span class="s1">SfxPlayer</span><span class="s2">()</span>
        <span class="s1">sfxManager </span><span class="s2">= </span><span class="s1">AudioManager</span><span class="s2">.</span><span class="s1">createAudioManager</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">addSfxManager</span><span class="s2">(</span><span class="s1">sfxManager</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">musicManager </span><span class="s2">= </span><span class="s1">AudioManager</span><span class="s2">.</span><span class="s1">createAudioManager</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">musicManagerIsValid </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">musicManager </span><span class="s5">is not None </span><span class="s1">\</span>
            <span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">musicManager</span><span class="s2">.</span><span class="s1">isValid</span><span class="s2">()</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">musicManagerIsValid</span><span class="s2">:</span>
            <span class="s4"># ensure only 1 midi song is playing at a time:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">musicManager</span><span class="s2">.</span><span class="s1">setConcurrentSoundLimit</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">musicManager</span><span class="s2">.</span><span class="s1">setActive</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">musicActive</span><span class="s2">)</span>

    <span class="s4"># enableMusic/enableSoundEffects are meant to be called in response</span>
    <span class="s4"># to a user request so sfxActive/musicActive represent how things</span>
    <span class="s4"># *should* be, regardless of App/OS/HW state</span>
    <span class="s5">def </span><span class="s1">enableMusic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bEnableMusic</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Enables or disables the music manager. 
        &quot;&quot;&quot;</span>
        <span class="s4"># don't setActive(1) if no audiofocus</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">AppHasAudioFocus </span><span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">musicManagerIsValid</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">musicManager</span><span class="s2">.</span><span class="s1">setActive</span><span class="s2">(</span><span class="s1">bEnableMusic</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">musicActive </span><span class="s2">= </span><span class="s1">bEnableMusic</span>
        <span class="s5">if </span><span class="s1">bEnableMusic</span><span class="s2">:</span>
            <span class="s4"># This is useful when we want to play different music</span>
            <span class="s4"># from what the manager has queued</span>
            <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s3">&quot;MusicEnabled&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;Enabling music&quot;</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;Disabling music&quot;</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">SetAllSfxEnables</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bEnabled</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot;Calls ``setActive(bEnabled)`` on all valid SFX managers.&quot;&quot;&quot;</span>
        <span class="s5">for </span><span class="s1">i </span><span class="s5">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sfxManagerList</span><span class="s2">)):</span>
            <span class="s5">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sfxManagerIsValidList</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">sfxManagerList</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">setActive</span><span class="s2">(</span><span class="s1">bEnabled</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">enableSoundEffects</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bEnableSoundEffects</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Enables or disables SFX managers. 
        &quot;&quot;&quot;</span>
        <span class="s4"># don't setActive(1) if no audiofocus</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">AppHasAudioFocus </span><span class="s5">or </span><span class="s2">(</span><span class="s1">bEnableSoundEffects</span><span class="s2">==</span><span class="s6">0</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">SetAllSfxEnables</span><span class="s2">(</span><span class="s1">bEnableSoundEffects</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sfxActive</span><span class="s2">=</span><span class="s1">bEnableSoundEffects</span>
        <span class="s5">if </span><span class="s1">bEnableSoundEffects</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;Enabling sound effects&quot;</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;Disabling sound effects&quot;</span><span class="s2">)</span>

    <span class="s4"># enable/disableAllAudio allow a programmable global override-off</span>
    <span class="s4"># for current audio settings.  they're meant to be called when app</span>
    <span class="s4"># loses audio focus (switched out), so we can turn off sound without</span>
    <span class="s4"># affecting internal sfxActive/musicActive sound settings, so things</span>
    <span class="s4"># come back ok when the app is switched back to</span>

    <span class="s5">def </span><span class="s1">disableAllAudio</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Disables all SFX and music managers, meant to be called when the app 
        loses audio focus. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">AppHasAudioFocus </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">SetAllSfxEnables</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">musicManagerIsValid</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">musicManager</span><span class="s2">.</span><span class="s1">setActive</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;Disabling audio&quot;</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">enableAllAudio</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Reenables the SFX and music managers that were active at the time 
        `disableAllAudio()` was called.  Meant to be called when the app regains 
        audio focus. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">AppHasAudioFocus </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">SetAllSfxEnables</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sfxActive</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">musicManagerIsValid</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">musicManager</span><span class="s2">.</span><span class="s1">setActive</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">musicActive</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;Enabling audio&quot;</span><span class="s2">)</span>

    <span class="s4"># This function should only be in the loader but is here for</span>
    <span class="s4"># backwards compatibility. Please do not add code here, add</span>
    <span class="s4"># it to the loader.</span>
    <span class="s5">def </span><span class="s1">loadSfx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        :deprecated: Use `.Loader.Loader.loadSfx()` instead. 
        &quot;&quot;&quot;</span>
        <span class="s5">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;base.loadSfx is deprecated, use base.loader.loadSfx instead.&quot;</span><span class="s2">)</span>
        <span class="s5">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loader</span><span class="s2">.</span><span class="s1">loadSfx</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s4"># This function should only be in the loader but is here for</span>
    <span class="s4"># backwards compatibility. Please do not add code here, add</span>
    <span class="s4"># it to the loader.</span>
    <span class="s5">def </span><span class="s1">loadMusic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        :deprecated: Use `.Loader.Loader.loadMusic()` instead. 
        &quot;&quot;&quot;</span>
        <span class="s5">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;base.loadMusic is deprecated, use base.loader.loadMusic instead.&quot;</span><span class="s2">)</span>
        <span class="s5">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loader</span><span class="s2">.</span><span class="s1">loadMusic</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">playSfx</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">, </span><span class="s1">sfx</span><span class="s2">, </span><span class="s1">looping </span><span class="s2">= </span><span class="s6">0</span><span class="s2">, </span><span class="s1">interrupt </span><span class="s2">= </span><span class="s6">1</span><span class="s2">, </span><span class="s1">volume </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
            <span class="s1">time </span><span class="s2">= </span><span class="s6">0.0</span><span class="s2">, </span><span class="s1">node </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">listener </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">cutoff </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s4"># This goes through a special player for potential localization</span>
        <span class="s5">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sfxPlayer</span><span class="s2">.</span><span class="s1">playSfx</span><span class="s2">(</span><span class="s1">sfx</span><span class="s2">, </span><span class="s1">looping</span><span class="s2">, </span><span class="s1">interrupt</span><span class="s2">, </span><span class="s1">volume</span><span class="s2">, </span><span class="s1">time</span><span class="s2">, </span><span class="s1">node</span><span class="s2">, </span><span class="s1">listener</span><span class="s2">, </span><span class="s1">cutoff</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">playMusic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">music</span><span class="s2">, </span><span class="s1">looping </span><span class="s2">= </span><span class="s6">0</span><span class="s2">, </span><span class="s1">interrupt </span><span class="s2">= </span><span class="s6">1</span><span class="s2">, </span><span class="s1">volume </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">time </span><span class="s2">= </span><span class="s6">0.0</span><span class="s2">):</span>
        <span class="s5">if </span><span class="s1">music</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">volume </span><span class="s5">is not None</span><span class="s2">:</span>
                <span class="s1">music</span><span class="s2">.</span><span class="s1">setVolume</span><span class="s2">(</span><span class="s1">volume</span><span class="s2">)</span>

            <span class="s4"># if interrupt was set to 0, start over even if it's</span>
            <span class="s4"># already playing</span>
            <span class="s5">if </span><span class="s1">interrupt </span><span class="s5">or </span><span class="s2">(</span><span class="s1">music</span><span class="s2">.</span><span class="s1">status</span><span class="s2">() != </span><span class="s1">AudioSound</span><span class="s2">.</span><span class="s1">PLAYING</span><span class="s2">):</span>
                <span class="s1">music</span><span class="s2">.</span><span class="s1">setTime</span><span class="s2">(</span><span class="s1">time</span><span class="s2">)</span>
                <span class="s1">music</span><span class="s2">.</span><span class="s1">setLoop</span><span class="s2">(</span><span class="s1">looping</span><span class="s2">)</span>
                <span class="s1">music</span><span class="s2">.</span><span class="s1">play</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">__resetPrevTransform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">state</span><span class="s2">):</span>
        <span class="s4"># Clear out the previous velocity deltas now, after we have</span>
        <span class="s4"># rendered (the previous frame).  We do this after the render,</span>
        <span class="s4"># so that we have a chance to draw a representation of spheres</span>
        <span class="s4"># along with their velocities.  At the beginning of the frame</span>
        <span class="s4"># really means after the command prompt, which allows the user</span>
        <span class="s4"># to interactively query these deltas meaningfully.</span>

        <span class="s1">PandaNode</span><span class="s2">.</span><span class="s1">resetAllPrevTransform</span><span class="s2">()</span>
        <span class="s5">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>

    <span class="s5">def </span><span class="s1">__dataLoop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">state</span><span class="s2">):</span>
        <span class="s4"># Check if there were newly connected devices.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">devices</span><span class="s2">.</span><span class="s1">update</span><span class="s2">()</span>

        <span class="s4"># traverse the data graph.  This reads all the control</span>
        <span class="s4"># inputs (from the mouse and keyboard, for instance) and also</span>
        <span class="s4"># directly acts upon them (for instance, to move the avatar).</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dgTrav</span><span class="s2">.</span><span class="s1">traverse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dataRootNode</span><span class="s2">)</span>
        <span class="s5">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>

    <span class="s5">def </span><span class="s1">__ivalLoop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">state</span><span class="s2">):</span>
        <span class="s4"># Execute all intervals in the global ivalMgr.</span>
        <span class="s1">IntervalManager</span><span class="s2">.</span><span class="s1">ivalMgr</span><span class="s2">.</span><span class="s1">step</span><span class="s2">()</span>
        <span class="s5">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>

    <span class="s5">def </span><span class="s1">initShadowTrav</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shadowTrav</span><span class="s2">:</span>
            <span class="s4"># set up the shadow collision traverser</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">shadowTrav </span><span class="s2">= </span><span class="s1">CollisionTraverser</span><span class="s2">(</span><span class="s3">&quot;base.shadowTrav&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">shadowTrav</span><span class="s2">.</span><span class="s1">setRespectPrevTransform</span><span class="s2">(</span><span class="s5">False</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">__shadowCollisionLoop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">state</span><span class="s2">):</span>
        <span class="s4"># run the collision traversal if we have a</span>
        <span class="s4"># CollisionTraverser set.</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shadowTrav</span><span class="s2">:</span>
           <span class="s1">self</span><span class="s2">.</span><span class="s1">shadowTrav</span><span class="s2">.</span><span class="s1">traverse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">)</span>
        <span class="s5">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>

    <span class="s5">def </span><span class="s1">__collisionLoop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">state</span><span class="s2">):</span>
        <span class="s4"># run the collision traversal if we have a</span>
        <span class="s4"># CollisionTraverser set.</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cTrav</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cTrav</span><span class="s2">.</span><span class="s1">traverse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">appTrav</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">appTrav</span><span class="s2">.</span><span class="s1">traverse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shadowTrav</span><span class="s2">:</span>
           <span class="s1">self</span><span class="s2">.</span><span class="s1">shadowTrav</span><span class="s2">.</span><span class="s1">traverse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">)</span>
        <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s3">&quot;collisionLoopFinished&quot;</span><span class="s2">)</span>
        <span class="s5">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>

    <span class="s5">def </span><span class="s1">__audioLoop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">state</span><span class="s2">):</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">musicManager </span><span class="s5">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">musicManager</span><span class="s2">.</span><span class="s1">update</span><span class="s2">()</span>
        <span class="s5">for </span><span class="s1">x </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sfxManagerList</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">.</span><span class="s1">update</span><span class="s2">()</span>
        <span class="s5">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>

    <span class="s5">def </span><span class="s1">__garbageCollectStates</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">state</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This task is started only when we have 
        garbage-collect-states set in the Config.prc file, in which 
        case we're responsible for taking out Panda's garbage from 
        time to time.  This is not to be confused with Python's 
        garbage collection.  &quot;&quot;&quot;</span>

        <span class="s1">TransformState</span><span class="s2">.</span><span class="s1">garbageCollect</span><span class="s2">()</span>
        <span class="s1">RenderState</span><span class="s2">.</span><span class="s1">garbageCollect</span><span class="s2">()</span>
        <span class="s5">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>

    <span class="s5">def </span><span class="s1">__igLoop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">state</span><span class="s2">):</span>
        <span class="s5">if __debug__</span><span class="s2">:</span>
            <span class="s4"># We render the watch variables for the onScreenDebug as soon</span>
            <span class="s4"># as we reasonably can before the renderFrame().</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">onScreenDebug</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recorder</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">recorder</span><span class="s2">.</span><span class="s1">recordFrame</span><span class="s2">()</span>

        <span class="s4"># Finally, render the frame.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">renderFrame</span><span class="s2">()</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">clusterSyncFlag</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">syncFrame</span><span class="s2">()</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiClientSleep</span><span class="s2">:</span>
            <span class="s1">time</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>

        <span class="s5">if __debug__</span><span class="s2">:</span>
            <span class="s4"># We clear the text buffer for the onScreenDebug as soon</span>
            <span class="s4"># as we reasonably can after the renderFrame().</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">onScreenDebug</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recorder</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">recorder</span><span class="s2">.</span><span class="s1">playFrame</span><span class="s2">()</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mainWinMinimized</span><span class="s2">:</span>
            <span class="s4"># If the main window is minimized, slow down the app a bit</span>
            <span class="s4"># by sleeping here in igLoop so we don't use all available</span>
            <span class="s4"># CPU needlessly.</span>

            <span class="s4"># Note: this isn't quite right if multiple windows are</span>
            <span class="s4"># open.  We should base this on whether *all* windows are</span>
            <span class="s4"># minimized, not just the main window.  But it will do for</span>
            <span class="s4"># now until someone complains.</span>
            <span class="s1">time</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s6">0.1</span><span class="s2">)</span>

        <span class="s4"># Lerp stuff needs this event, and it must be generated in</span>
        <span class="s4"># C++, not in Python.</span>
        <span class="s1">throw_new_frame</span><span class="s2">()</span>
        <span class="s5">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>

    <span class="s5">def </span><span class="s1">__igLoopSync</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">state</span><span class="s2">):</span>
        <span class="s5">if __debug__</span><span class="s2">:</span>
            <span class="s4"># We render the watch variables for the onScreenDebug as soon</span>
            <span class="s4"># as we reasonably can before the renderFrame().</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">onScreenDebug</span><span class="s2">.</span><span class="s1">render</span><span class="s2">()</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recorder</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">recorder</span><span class="s2">.</span><span class="s1">recordFrame</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">cluster</span><span class="s2">.</span><span class="s1">collectData</span><span class="s2">()</span>

        <span class="s4"># Finally, render the frame.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">renderFrame</span><span class="s2">()</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">clusterSyncFlag</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">syncFrame</span><span class="s2">()</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiClientSleep</span><span class="s2">:</span>
            <span class="s1">time</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>

        <span class="s5">if __debug__</span><span class="s2">:</span>
            <span class="s4"># We clear the text buffer for the onScreenDebug as soon</span>
            <span class="s4"># as we reasonably can after the renderFrame().</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">onScreenDebug</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recorder</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">recorder</span><span class="s2">.</span><span class="s1">playFrame</span><span class="s2">()</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mainWinMinimized</span><span class="s2">:</span>
            <span class="s4"># If the main window is minimized, slow down the app a bit</span>
            <span class="s4"># by sleeping here in igLoop so we don't use all available</span>
            <span class="s4"># CPU needlessly.</span>

            <span class="s4"># Note: this isn't quite right if multiple windows are</span>
            <span class="s4"># open.  We should base this on whether *all* windows are</span>
            <span class="s4"># minimized, not just the main window.  But it will do for</span>
            <span class="s4"># now until someone complains.</span>
            <span class="s1">time</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s6">0.1</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">readyFlip</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cluster</span><span class="s2">.</span><span class="s1">waitForFlipCommand</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">flipFrame</span><span class="s2">()</span>

        <span class="s4"># Lerp stuff needs this event, and it must be generated in</span>
        <span class="s4"># C++, not in Python.</span>
        <span class="s1">throw_new_frame</span><span class="s2">()</span>
        <span class="s5">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>

    <span class="s5">def </span><span class="s1">restart</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">clusterSync</span><span class="s2">=</span><span class="s5">False</span><span class="s2">, </span><span class="s1">cluster</span><span class="s2">=</span><span class="s5">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">shutdown</span><span class="s2">()</span>
        <span class="s4"># __resetPrevTransform goes at the very beginning of the frame.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__resetPrevTransform</span><span class="s2">, </span><span class="s3">'resetPrevTransform'</span><span class="s2">, </span><span class="s1">sort </span><span class="s2">= -</span><span class="s6">51</span><span class="s2">)</span>
        <span class="s4"># give the dataLoop task a reasonably &quot;early&quot; sort,</span>
        <span class="s4"># so that it will get run before most tasks</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dataLoop</span><span class="s2">, </span><span class="s3">'dataLoop'</span><span class="s2">, </span><span class="s1">sort </span><span class="s2">= -</span><span class="s6">50</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__deadInputs </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s4"># spawn the ivalLoop with a later sort, so that it will</span>
        <span class="s4"># run after most tasks, but before igLoop.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__ivalLoop</span><span class="s2">, </span><span class="s3">'ivalLoop'</span><span class="s2">, </span><span class="s1">sort </span><span class="s2">= </span><span class="s6">20</span><span class="s2">)</span>
        <span class="s4"># make the collisionLoop task run before igLoop,</span>
        <span class="s4"># but leave enough room for the app to insert tasks</span>
        <span class="s4"># between collisionLoop and igLoop</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__collisionLoop</span><span class="s2">, </span><span class="s3">'collisionLoop'</span><span class="s2">, </span><span class="s1">sort </span><span class="s2">= </span><span class="s6">30</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">ConfigVariableBool</span><span class="s2">(</span><span class="s3">'garbage-collect-states'</span><span class="s2">).</span><span class="s1">getValue</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__garbageCollectStates</span><span class="s2">, </span><span class="s3">'garbageCollectStates'</span><span class="s2">, </span><span class="s1">sort </span><span class="s2">= </span><span class="s6">46</span><span class="s2">)</span>
        <span class="s4"># give the igLoop task a reasonably &quot;late&quot; sort,</span>
        <span class="s4"># so that it will get run after most tasks</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cluster </span><span class="s2">= </span><span class="s1">cluster</span>
        <span class="s5">if not </span><span class="s1">clusterSync </span><span class="s5">or </span><span class="s1">cluster </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__igLoop</span><span class="s2">, </span><span class="s3">'igLoop'</span><span class="s2">, </span><span class="s1">sort </span><span class="s2">= </span><span class="s6">50</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__igLoopSync</span><span class="s2">, </span><span class="s3">'igLoop'</span><span class="s2">, </span><span class="s1">sort </span><span class="s2">= </span><span class="s6">50</span><span class="s2">)</span>
        <span class="s4"># the audioLoop updates the positions of 3D sounds.</span>
        <span class="s4"># as such, it needs to run after the cull traversal in the igLoop.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__audioLoop</span><span class="s2">, </span><span class="s3">'audioLoop'</span><span class="s2">, </span><span class="s1">sort </span><span class="s2">= </span><span class="s6">60</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">eventMgr</span><span class="s2">.</span><span class="s1">restart</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">shutdown</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">'audioLoop'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">'igLoop'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">'shadowCollisionLoop'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">'collisionLoop'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">'dataLoop'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">'resetPrevTransform'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">'ivalLoop'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">'garbageCollectStates'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">eventMgr</span><span class="s2">.</span><span class="s1">shutdown</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">getBackgroundColor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">win </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Returns the current window background color.  This assumes 
        the window is set up to clear the color each frame (this is 
        the normal setting). 
 
        :rtype: panda3d.core.VBase4 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">win </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">win </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span>

        <span class="s5">return </span><span class="s1">VBase4</span><span class="s2">(</span><span class="s1">win</span><span class="s2">.</span><span class="s1">getClearColor</span><span class="s2">())</span>

    <span class="s5">def </span><span class="s1">setBackgroundColor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">g </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s6">0.0</span><span class="s2">, </span><span class="s1">win </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Sets the window background color to the indicated value. 
        This assumes the window is set up to clear the color each 
        frame (this is the normal setting). 
 
        The color may be either a VBase3 or a VBase4, or a 3-component 
        tuple, or the individual r, g, b parameters. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">g </span><span class="s5">is not None</span><span class="s2">:</span>
            <span class="s1">color </span><span class="s2">= </span><span class="s1">VBase4</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">g</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">arg </span><span class="s2">= </span><span class="s1">r</span>
            <span class="s5">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">VBase4</span><span class="s2">):</span>
                <span class="s1">color </span><span class="s2">= </span><span class="s1">arg</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">color </span><span class="s2">= </span><span class="s1">VBase4</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">arg</span><span class="s2">[</span><span class="s6">1</span><span class="s2">], </span><span class="s1">arg</span><span class="s2">[</span><span class="s6">2</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">win </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">win </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span>

        <span class="s5">if </span><span class="s1">win</span><span class="s2">:</span>
            <span class="s1">win</span><span class="s2">.</span><span class="s1">setClearColor</span><span class="s2">(</span><span class="s1">color</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">toggleBackface</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Toggles between `backfaceCullingOn()` and `backfaceCullingOff()`. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">backfaceCullingEnabled</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">backfaceCullingOff</span><span class="s2">()</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">backfaceCullingOn</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">backfaceCullingOn</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Disables two-sided rendering on the entire 3D scene graph. 
        &quot;&quot;&quot;</span>
        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">backfaceCullingEnabled</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">.</span><span class="s1">setTwoSided</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">backfaceCullingEnabled </span><span class="s2">= </span><span class="s6">1</span>

    <span class="s5">def </span><span class="s1">backfaceCullingOff</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Enables two-sided rendering on the entire 3D scene graph. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">backfaceCullingEnabled</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">.</span><span class="s1">setTwoSided</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">backfaceCullingEnabled </span><span class="s2">= </span><span class="s6">0</span>

    <span class="s5">def </span><span class="s1">toggleTexture</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Toggles between `textureOn()` and `textureOff()`. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">textureEnabled</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">textureOff</span><span class="s2">()</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">textureOn</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">textureOn</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Undoes the effects of a previous call to `textureOff()`. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">.</span><span class="s1">clearTexture</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">textureEnabled </span><span class="s2">= </span><span class="s6">1</span>

    <span class="s5">def </span><span class="s1">textureOff</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Disables texturing on the entire 3D scene graph. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">.</span><span class="s1">setTextureOff</span><span class="s2">(</span><span class="s6">100</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">textureEnabled </span><span class="s2">= </span><span class="s6">0</span>

    <span class="s5">def </span><span class="s1">toggleWireframe</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Toggles between `wireframeOn()` and `wireframeOff()`. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wireframeEnabled</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">wireframeOff</span><span class="s2">()</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">wireframeOn</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">wireframeOn</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Enables wireframe rendering on the entire 3D scene graph. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">.</span><span class="s1">setRenderModeWireframe</span><span class="s2">(</span><span class="s6">100</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">.</span><span class="s1">setTwoSided</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">wireframeEnabled </span><span class="s2">= </span><span class="s6">1</span>

    <span class="s5">def </span><span class="s1">wireframeOff</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Undoes the effects of a previous call to `wireframeOn()`. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">render</span><span class="s2">.</span><span class="s1">clearRenderMode</span><span class="s2">()</span>
        <span class="s1">render</span><span class="s2">.</span><span class="s1">setTwoSided</span><span class="s2">(</span><span class="s5">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">backfaceCullingEnabled</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">wireframeEnabled </span><span class="s2">= </span><span class="s6">0</span>

    <span class="s5">def </span><span class="s1">disableMouse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Temporarily disable the mouse control of the camera, either 
        via the drive interface or the trackball, whichever is 
        currently in use. 
        &quot;&quot;&quot;</span>
        <span class="s4"># We don't reparent the drive interface or the trackball;</span>
        <span class="s4"># whichever one was there before will remain in the data graph</span>
        <span class="s4"># and active.  This way they won't lose button events while</span>
        <span class="s4"># the mouse is disabled.  However, we do move the mouse2cam</span>
        <span class="s4"># object out of there, so we won't be updating the camera any</span>
        <span class="s4"># more.</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouse2cam</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">mouse2cam</span><span class="s2">.</span><span class="s1">detachNode</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">enableMouse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Reverse the effect of a previous call to `disableMouse()`. 
        `useDrive()` also implicitly enables the mouse. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouse2cam</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">mouse2cam</span><span class="s2">.</span><span class="s1">reparentTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseInterface</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">silenceInput</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        This is a heavy-handed way of temporarily turning off 
        all inputs.  Bring them back with `reviveInput()`. 
        &quot;&quot;&quot;</span>
        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__deadInputs</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__deadInputs </span><span class="s2">= </span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">'dataLoop'</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">reviveInput</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Restores inputs after a previous call to `silenceInput()`. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__deadInputs</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">eventMgr</span><span class="s2">.</span><span class="s1">doEvents</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">dgTrav</span><span class="s2">.</span><span class="s1">traverse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dataRootNode</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">eventMgr</span><span class="s2">.</span><span class="s1">eventQueue</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dataLoop</span><span class="s2">, </span><span class="s3">'dataLoop'</span><span class="s2">, </span><span class="s1">sort </span><span class="s2">= -</span><span class="s6">50</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__deadInputs </span><span class="s2">= </span><span class="s6">0</span>

    <span class="s5">def </span><span class="s1">setMouseOnNode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">newNode</span><span class="s2">):</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouse2cam</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">mouse2cam</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setNode</span><span class="s2">(</span><span class="s1">newNode</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">changeMouseInterface</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">changeTo</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Change the mouse interface used to control the camera. 
        &quot;&quot;&quot;</span>
        <span class="s4"># Get rid of the prior interface:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseInterface</span><span class="s2">.</span><span class="s1">detachNode</span><span class="s2">()</span>
        <span class="s4"># Update the mouseInterface to point to the drive</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseInterface </span><span class="s2">= </span><span class="s1">changeTo</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseInterfaceNode </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseInterface</span><span class="s2">.</span><span class="s1">node</span><span class="s2">()</span>
        <span class="s4"># Hookup the drive to the camera.</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcher</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseInterface</span><span class="s2">.</span><span class="s1">reparentTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcher</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouse2cam</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">mouse2cam</span><span class="s2">.</span><span class="s1">reparentTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseInterface</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">useDrive</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Changes the mouse interface used for camera control to drive mode. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">drive</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">changeMouseInterface</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">drive</span><span class="s2">)</span>
            <span class="s4"># Set the height to a good eyeheight</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseInterfaceNode</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseInterfaceNode</span><span class="s2">.</span><span class="s1">setZ</span><span class="s2">(</span><span class="s6">4.0</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">useTrackball</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Changes the mouse interface used for camera control to trackball mode. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">trackball</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">changeMouseInterface</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">trackball</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">toggleTexMem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Toggles a handy texture memory watcher utility. 
        See :mod:`direct.showutil.TexMemWatcher` for more information. 
        &quot;&quot;&quot;</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">texmem </span><span class="s5">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">texmem</span><span class="s2">.</span><span class="s1">cleanedUp</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">texmem</span><span class="s2">.</span><span class="s1">cleanup</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">texmem </span><span class="s2">= </span><span class="s5">None</span>
            <span class="s5">return</span>

        <span class="s4"># Use importlib to prevent this import from being picked up</span>
        <span class="s4"># by modulefinder when packaging an application.</span>
        <span class="s1">TMW </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">'direct.showutil.TexMemWatcher'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">texmem </span><span class="s2">= </span><span class="s1">TMW</span><span class="s2">.</span><span class="s1">TexMemWatcher</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">toggleShowVertices</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Toggles a mode that visualizes vertex density per screen 
        area. &quot;&quot;&quot;</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">showVertices</span><span class="s2">:</span>
            <span class="s4"># Clean up the old mode.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">showVertices</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setActive</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">dr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">showVertices</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">getDisplayRegion</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">.</span><span class="s1">removeDisplayRegion</span><span class="s2">(</span><span class="s1">dr</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">showVertices</span><span class="s2">.</span><span class="s1">removeNode</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">showVertices </span><span class="s2">= </span><span class="s5">None</span>
            <span class="s5">return</span>

        <span class="s1">dr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">.</span><span class="s1">makeDisplayRegion</span><span class="s2">()</span>
        <span class="s1">dr</span><span class="s2">.</span><span class="s1">setSort</span><span class="s2">(</span><span class="s6">1000</span><span class="s2">)</span>
        <span class="s1">cam </span><span class="s2">= </span><span class="s1">Camera</span><span class="s2">(</span><span class="s3">'showVertices'</span><span class="s2">)</span>
        <span class="s1">cam</span><span class="s2">.</span><span class="s1">setLens</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">camLens</span><span class="s2">)</span>

        <span class="s4"># Set up a funny state to render only vertices.</span>
        <span class="s1">override </span><span class="s2">= </span><span class="s6">100000</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">NodePath</span><span class="s2">(</span><span class="s3">'t'</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setColor</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0.02</span><span class="s2">, </span><span class="s1">override</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setColorScale</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s1">override</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setAttrib</span><span class="s2">(</span><span class="s1">ColorBlendAttrib</span><span class="s2">.</span><span class="s1">make</span><span class="s2">(</span><span class="s1">ColorBlendAttrib</span><span class="s2">.</span><span class="s1">MAdd</span><span class="s2">, </span><span class="s1">ColorBlendAttrib</span><span class="s2">.</span><span class="s1">OIncomingAlpha</span><span class="s2">, </span><span class="s1">ColorBlendAttrib</span><span class="s2">.</span><span class="s1">OOneMinusIncomingAlpha</span><span class="s2">), </span><span class="s1">override</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setAttrib</span><span class="s2">(</span><span class="s1">RenderModeAttrib</span><span class="s2">.</span><span class="s1">make</span><span class="s2">(</span><span class="s1">RenderModeAttrib</span><span class="s2">.</span><span class="s1">MPoint</span><span class="s2">, </span><span class="s6">10</span><span class="s2">), </span><span class="s1">override</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setTwoSided</span><span class="s2">(</span><span class="s5">True</span><span class="s2">, </span><span class="s1">override</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setBin</span><span class="s2">(</span><span class="s3">'fixed'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">override</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setDepthTest</span><span class="s2">(</span><span class="s5">False</span><span class="s2">, </span><span class="s1">override</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setDepthWrite</span><span class="s2">(</span><span class="s5">False</span><span class="s2">, </span><span class="s1">override</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setLightOff</span><span class="s2">(</span><span class="s1">override</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setShaderOff</span><span class="s2">(</span><span class="s1">override</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setFogOff</span><span class="s2">(</span><span class="s1">override</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setAttrib</span><span class="s2">(</span><span class="s1">AntialiasAttrib</span><span class="s2">.</span><span class="s1">make</span><span class="s2">(</span><span class="s1">AntialiasAttrib</span><span class="s2">.</span><span class="s1">MNone</span><span class="s2">), </span><span class="s1">override</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setAttrib</span><span class="s2">(</span><span class="s1">RescaleNormalAttrib</span><span class="s2">.</span><span class="s1">make</span><span class="s2">(</span><span class="s1">RescaleNormalAttrib</span><span class="s2">.</span><span class="s1">MNone</span><span class="s2">), </span><span class="s1">override</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setTextureOff</span><span class="s2">(</span><span class="s1">override</span><span class="s2">)</span>

        <span class="s4"># Make the spots round, so there's less static in the display.</span>
        <span class="s4"># This forces software point generation on many drivers, so</span>
        <span class="s4"># it's not on by default.</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'round-show-vertices'</span><span class="s2">, </span><span class="s5">False</span><span class="s2">):</span>
            <span class="s1">spot </span><span class="s2">= </span><span class="s1">PNMImage</span><span class="s2">(</span><span class="s6">256</span><span class="s2">, </span><span class="s6">256</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
            <span class="s1">spot</span><span class="s2">.</span><span class="s1">renderSpot</span><span class="s2">((</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">), (</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">), </span><span class="s6">0.8</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
            <span class="s1">tex </span><span class="s2">= </span><span class="s1">Texture</span><span class="s2">(</span><span class="s3">'spot'</span><span class="s2">)</span>
            <span class="s1">tex</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">spot</span><span class="s2">)</span>
            <span class="s1">tex</span><span class="s2">.</span><span class="s1">setFormat</span><span class="s2">(</span><span class="s1">tex</span><span class="s2">.</span><span class="s1">FAlpha</span><span class="s2">)</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">setTexture</span><span class="s2">(</span><span class="s1">tex</span><span class="s2">, </span><span class="s1">override</span><span class="s2">)</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">setAttrib</span><span class="s2">(</span><span class="s1">TexGenAttrib</span><span class="s2">.</span><span class="s1">make</span><span class="s2">(</span><span class="s1">TextureStage</span><span class="s2">.</span><span class="s1">getDefault</span><span class="s2">(), </span><span class="s1">TexGenAttrib</span><span class="s2">.</span><span class="s1">MPointSprite</span><span class="s2">), </span><span class="s1">override</span><span class="s2">)</span>

        <span class="s1">cam</span><span class="s2">.</span><span class="s1">setInitialState</span><span class="s2">(</span><span class="s1">t</span><span class="s2">.</span><span class="s1">getState</span><span class="s2">())</span>
        <span class="s1">cam</span><span class="s2">.</span><span class="s1">setCameraMask</span><span class="s2">(~</span><span class="s1">PandaNode</span><span class="s2">.</span><span class="s1">getOverallBit</span><span class="s2">())</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">showVertices </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cam</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">cam</span><span class="s2">)</span>
        <span class="s1">dr</span><span class="s2">.</span><span class="s1">setCamera</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">showVertices</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">oobe</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cam </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Enable a special &quot;out-of-body experience&quot; mouse-interface 
        mode.  This can be used when a &quot;god&quot; camera is needed; it 
        moves the camera node out from under its normal node and sets 
        the world up in trackball state.  Button events are still sent 
        to the normal mouse action node (e.g. the DriveInterface), and 
        mouse events, if needed, may be sent to the normal node by 
        holding down the Control key. 
 
        This is different than `useTrackball()`, which simply changes 
        the existing mouse action to a trackball interface.  In fact, 
        OOBE mode doesn't care whether `useDrive()` or `useTrackball()` is 
        in effect; it just temporarily layers a new trackball 
        interface on top of whatever the basic interface is.  You can 
        even switch between `useDrive()` and `useTrackball()` while OOBE 
        mode is in effect. 
 
        This is a toggle; the second time this function is called, it 
        disables the mode. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">cam </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">cam </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cam</span>

        <span class="s4"># If oobeMode was never set, set it to false and create the</span>
        <span class="s4"># structures we need to implement OOBE.</span>
        <span class="s5">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'oobeMode'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeMode </span><span class="s2">= </span><span class="s6">0</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCamera </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hidden</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">'oobeCamera'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCameraTrackball </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCamera</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s3">'oobeCameraTrackball'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeLens </span><span class="s2">= </span><span class="s1">PerspectiveLens</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeLens</span><span class="s2">.</span><span class="s1">setAspectRatio</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">getAspectRatio</span><span class="s2">())</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeLens</span><span class="s2">.</span><span class="s1">setNearFar</span><span class="s2">(</span><span class="s6">0.1</span><span class="s2">, </span><span class="s6">10000.0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeLens</span><span class="s2">.</span><span class="s1">setMinFov</span><span class="s2">(</span><span class="s6">40</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeTrackball </span><span class="s2">= </span><span class="s1">NodePath</span><span class="s2">(</span><span class="s1">Trackball</span><span class="s2">(</span><span class="s3">'oobeTrackball'</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobe2cam </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">oobeTrackball</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">Transform2SG</span><span class="s2">(</span><span class="s3">'oobe2cam'</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobe2cam</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setNode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCameraTrackball</span><span class="s2">.</span><span class="s1">node</span><span class="s2">())</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeVis </span><span class="s2">= </span><span class="s1">loader</span><span class="s2">.</span><span class="s1">loadModel</span><span class="s2">(</span><span class="s3">'models/misc/camera'</span><span class="s2">, </span><span class="s1">okMissing </span><span class="s2">= </span><span class="s5">True</span><span class="s2">)</span>
            <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">oobeVis</span><span class="s2">:</span>
                <span class="s4"># Sometimes we have default-model-extension set to</span>
                <span class="s4"># egg, but the file might be a bam file.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeVis </span><span class="s2">= </span><span class="s1">loader</span><span class="s2">.</span><span class="s1">loadModel</span><span class="s2">(</span><span class="s3">'models/misc/camera.bam'</span><span class="s2">, </span><span class="s1">okMissing </span><span class="s2">= </span><span class="s5">True</span><span class="s2">)</span>
            <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">oobeVis</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeVis </span><span class="s2">= </span><span class="s1">NodePath</span><span class="s2">(</span><span class="s3">'oobeVis'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeVis</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setFinal</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeVis</span><span class="s2">.</span><span class="s1">setLightOff</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCullFrustum </span><span class="s2">= </span><span class="s5">None</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">(</span><span class="s3">'oobe-down'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__oobeButton</span><span class="s2">, </span><span class="s1">extraArgs </span><span class="s2">= [</span><span class="s3">''</span><span class="s2">])</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">(</span><span class="s3">'oobe-repeat'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__oobeButton</span><span class="s2">, </span><span class="s1">extraArgs </span><span class="s2">= [</span><span class="s3">'-repeat'</span><span class="s2">])</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">(</span><span class="s3">'oobe-up'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__oobeButton</span><span class="s2">, </span><span class="s1">extraArgs </span><span class="s2">= [</span><span class="s3">'-up'</span><span class="s2">])</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">oobeMode</span><span class="s2">:</span>
            <span class="s4"># Disable OOBE mode.</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCullFrustum </span><span class="s5">is not None</span><span class="s2">:</span>
                <span class="s4"># First, disable OOBE cull mode.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCull</span><span class="s2">(</span><span class="s1">cam </span><span class="s2">= </span><span class="s1">cam</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">oobeVis</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeVis</span><span class="s2">.</span><span class="s1">reparentTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">hidden</span><span class="s2">)</span>

            <span class="s4"># Restore the mouse interface node, and remove the oobe</span>
            <span class="s4"># trackball from the data path.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseInterfaceNode</span><span class="s2">.</span><span class="s1">clearButton</span><span class="s2">(</span><span class="s1">KeyboardButton</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">())</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeTrackball</span><span class="s2">.</span><span class="s1">detachNode</span><span class="s2">()</span>

            <span class="s1">bt </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buttonThrowers</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">node</span><span class="s2">()</span>
            <span class="s1">bt</span><span class="s2">.</span><span class="s1">setSpecificFlag</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
            <span class="s1">bt</span><span class="s2">.</span><span class="s1">setButtonDownEvent</span><span class="s2">(</span><span class="s3">''</span><span class="s2">)</span>
            <span class="s1">bt</span><span class="s2">.</span><span class="s1">setButtonRepeatEvent</span><span class="s2">(</span><span class="s3">''</span><span class="s2">)</span>
            <span class="s1">bt</span><span class="s2">.</span><span class="s1">setButtonUpEvent</span><span class="s2">(</span><span class="s3">''</span><span class="s2">)</span>

            <span class="s1">cam</span><span class="s2">.</span><span class="s1">reparentTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera</span><span class="s2">)</span>
            <span class="s4">#if cam == self.cam:</span>
            <span class="s4">#    self.camNode.setLens(self.camLens)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCamera</span><span class="s2">.</span><span class="s1">reparentTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">hidden</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeMode </span><span class="s2">= </span><span class="s6">0</span>
            <span class="s1">bboard</span><span class="s2">.</span><span class="s1">post</span><span class="s2">(</span><span class="s3">'oobeEnabled'</span><span class="s2">, </span><span class="s5">False</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">bboard</span><span class="s2">.</span><span class="s1">post</span><span class="s2">(</span><span class="s3">'oobeEnabled'</span><span class="s2">, </span><span class="s5">True</span><span class="s2">)</span>
            <span class="s5">try</span><span class="s2">:</span>
                <span class="s1">cameraParent </span><span class="s2">= </span><span class="s1">localAvatar</span>
            <span class="s5">except</span><span class="s2">:</span>
                <span class="s4"># Make oobeCamera be a sibling of wherever camera is now.</span>
                <span class="s1">cameraParent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera</span><span class="s2">.</span><span class="s1">getParent</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCamera</span><span class="s2">.</span><span class="s1">reparentTo</span><span class="s2">(</span><span class="s1">cameraParent</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCamera</span><span class="s2">.</span><span class="s1">clearMat</span><span class="s2">()</span>

            <span class="s4"># Make the regular MouseInterface node respond only when</span>
            <span class="s4"># the shift button is pressed.  And the oobe node will</span>
            <span class="s4"># respond only when shift is *not* pressed.</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseInterfaceNode</span><span class="s2">.</span><span class="s1">requireButton</span><span class="s2">(</span><span class="s1">KeyboardButton</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">(), </span><span class="s5">True</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeTrackball</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">requireButton</span><span class="s2">(</span><span class="s1">KeyboardButton</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">(), </span><span class="s5">False</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeTrackball</span><span class="s2">.</span><span class="s1">reparentTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcher</span><span class="s2">)</span>

            <span class="s4"># Set our initial OOB position to be just behind the camera.</span>
            <span class="s1">mat </span><span class="s2">= </span><span class="s1">Mat4</span><span class="s2">.</span><span class="s1">translateMat</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, -</span><span class="s6">10</span><span class="s2">, </span><span class="s6">3</span><span class="s2">) * </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera</span><span class="s2">.</span><span class="s1">getMat</span><span class="s2">(</span><span class="s1">cameraParent</span><span class="s2">)</span>
            <span class="s1">mat</span><span class="s2">.</span><span class="s1">invertInPlace</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeTrackball</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setMat</span><span class="s2">(</span><span class="s1">mat</span><span class="s2">)</span>

            <span class="s1">cam</span><span class="s2">.</span><span class="s1">reparentTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCameraTrackball</span><span class="s2">)</span>

            <span class="s4"># Temporarily disable button events by routing them</span>
            <span class="s4"># through the oobe filters.</span>
            <span class="s1">bt </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buttonThrowers</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">node</span><span class="s2">()</span>
            <span class="s1">bt</span><span class="s2">.</span><span class="s1">setSpecificFlag</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">bt</span><span class="s2">.</span><span class="s1">setButtonDownEvent</span><span class="s2">(</span><span class="s3">'oobe-down'</span><span class="s2">)</span>
            <span class="s1">bt</span><span class="s2">.</span><span class="s1">setButtonRepeatEvent</span><span class="s2">(</span><span class="s3">'oobe-repeat'</span><span class="s2">)</span>
            <span class="s1">bt</span><span class="s2">.</span><span class="s1">setButtonUpEvent</span><span class="s2">(</span><span class="s3">'oobe-up'</span><span class="s2">)</span>

            <span class="s4"># Don't change the camera lens--keep it with the original lens.</span>
            <span class="s4">#if cam == self.cam:</span>
            <span class="s4">#    self.camNode.setLens(self.oobeLens)</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">oobeVis</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeVis</span><span class="s2">.</span><span class="s1">reparentTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeMode </span><span class="s2">= </span><span class="s6">1</span>

    <span class="s5">def </span><span class="s1">__oobeButton</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">suffix</span><span class="s2">, </span><span class="s1">button</span><span class="s2">):</span>
        <span class="s5">if </span><span class="s1">button</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'mouse'</span><span class="s2">):</span>
            <span class="s4"># Eat mouse buttons.</span>
            <span class="s5">return</span>

        <span class="s4"># Transmit other buttons.</span>
        <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">button </span><span class="s2">+ </span><span class="s1">suffix</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">oobeCull</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cam </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        While in OOBE mode (see above), cull the viewing frustum as if 
        it were still attached to our original camera.  This allows us 
        to visualize the effectiveness of our bounding volumes. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">cam </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">cam </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cam</span>

        <span class="s4"># First, make sure OOBE mode is enabled.</span>
        <span class="s5">if not </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'oobeMode'</span><span class="s2">, </span><span class="s5">False</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobe</span><span class="s2">(</span><span class="s1">cam </span><span class="s2">= </span><span class="s1">cam</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCullFrustum </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s4"># Enable OOBE culling.</span>
            <span class="s1">pnode </span><span class="s2">= </span><span class="s1">LensNode</span><span class="s2">(</span><span class="s3">'oobeCull'</span><span class="s2">)</span>
            <span class="s1">pnode</span><span class="s2">.</span><span class="s1">setLens</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">camLens</span><span class="s2">)</span>
            <span class="s1">pnode</span><span class="s2">.</span><span class="s1">showFrustum</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCullFrustum </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">pnode</span><span class="s2">)</span>

            <span class="s4"># Tell the camera to cull from here instead of its own</span>
            <span class="s4"># origin.</span>
            <span class="s5">for </span><span class="s1">c </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camList</span><span class="s2">:</span>
                <span class="s1">c</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setCullCenter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCullFrustum</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">cam</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">isOfType</span><span class="s2">(</span><span class="s1">Camera</span><span class="s2">):</span>
                <span class="s1">cam</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setCullCenter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCullFrustum</span><span class="s2">)</span>
            <span class="s5">for </span><span class="s1">c </span><span class="s5">in </span><span class="s1">cam</span><span class="s2">.</span><span class="s1">findAllMatches</span><span class="s2">(</span><span class="s3">'**/+Camera'</span><span class="s2">):</span>
                <span class="s1">c</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setCullCenter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCullFrustum</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s4"># Disable OOBE culling.</span>

            <span class="s5">for </span><span class="s1">c </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camList</span><span class="s2">:</span>
                <span class="s1">c</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setCullCenter</span><span class="s2">(</span><span class="s1">NodePath</span><span class="s2">())</span>
            <span class="s5">if </span><span class="s1">cam</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">isOfType</span><span class="s2">(</span><span class="s1">Camera</span><span class="s2">):</span>
                <span class="s1">cam</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setCullCenter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCullFrustum</span><span class="s2">)</span>
            <span class="s5">for </span><span class="s1">c </span><span class="s5">in </span><span class="s1">cam</span><span class="s2">.</span><span class="s1">findAllMatches</span><span class="s2">(</span><span class="s3">'**/+Camera'</span><span class="s2">):</span>
                <span class="s1">c</span><span class="s2">.</span><span class="s1">node</span><span class="s2">().</span><span class="s1">setCullCenter</span><span class="s2">(</span><span class="s1">NodePath</span><span class="s2">())</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCullFrustum</span><span class="s2">.</span><span class="s1">removeNode</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">oobeCullFrustum </span><span class="s2">= </span><span class="s5">None</span>

    <span class="s5">def </span><span class="s1">showCameraFrustum</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Create a visible representation of the frustum.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">removeCameraFrustum</span><span class="s2">()</span>
        <span class="s1">geom </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camLens</span><span class="s2">.</span><span class="s1">makeGeometry</span><span class="s2">()</span>
        <span class="s5">if </span><span class="s1">geom </span><span class="s5">is not None</span><span class="s2">:</span>
            <span class="s1">gn </span><span class="s2">= </span><span class="s1">GeomNode</span><span class="s2">(</span><span class="s3">'frustum'</span><span class="s2">)</span>
            <span class="s1">gn</span><span class="s2">.</span><span class="s1">addGeom</span><span class="s2">(</span><span class="s1">geom</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">camFrustumVis </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">gn</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">removeCameraFrustum</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camFrustumVis</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">camFrustumVis</span><span class="s2">.</span><span class="s1">removeNode</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">screenshot</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">namePrefix </span><span class="s2">= </span><span class="s3">'screenshot'</span><span class="s2">,</span>
                   <span class="s1">defaultFilename </span><span class="s2">= </span><span class="s6">1</span><span class="s2">, </span><span class="s1">source </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                   <span class="s1">imageComment</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Captures a screenshot from the main window or from the 
        specified window or Texture and writes it to a filename in the 
        current directory (or to a specified directory). 
 
        If defaultFilename is True, the filename is synthesized by 
        appending namePrefix to a default filename suffix (including 
        the filename extension) specified in the Config variable 
        screenshot-filename.  Otherwise, if defaultFilename is False, 
        the entire namePrefix is taken to be the filename to write, 
        and this string should include a suitable filename extension 
        that will be used to determine the type of image file to 
        write. 
 
        Normally, the source is a GraphicsWindow, GraphicsBuffer or 
        DisplayRegion.  If a Texture is supplied instead, it must have 
        a ram image (that is, if it was generated by 
        makeTextureBuffer() or makeCubeMap(), the parameter toRam 
        should have been set true).  If it is a cube map texture as 
        generated by makeCubeMap(), namePrefix should contain the hash 
        mark ('#') character. 
 
        :returns: The filename if successful, or None if there is a problem. 
        &quot;&quot;&quot;</span>

        <span class="s5">if </span><span class="s1">source </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">source </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span>

        <span class="s5">if </span><span class="s1">defaultFilename</span><span class="s2">:</span>
            <span class="s1">filename </span><span class="s2">= </span><span class="s1">GraphicsOutput</span><span class="s2">.</span><span class="s1">makeScreenshotFilename</span><span class="s2">(</span><span class="s1">namePrefix</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">namePrefix</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s1">Texture</span><span class="s2">):</span>
            <span class="s5">if </span><span class="s1">source</span><span class="s2">.</span><span class="s1">getZSize</span><span class="s2">() &gt; </span><span class="s6">1</span><span class="s2">:</span>
                <span class="s1">saved </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">saved </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">saved </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">saveScreenshot</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">imageComment</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">saved</span><span class="s2">:</span>
            <span class="s4"># Announce to anybody that a screenshot has been taken</span>
            <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s3">'screenshot'</span><span class="s2">, [</span><span class="s1">filename</span><span class="s2">])</span>
            <span class="s5">return </span><span class="s1">filename</span>

        <span class="s5">return None</span>

    <span class="s5">def </span><span class="s1">saveCubeMap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">namePrefix </span><span class="s2">= </span><span class="s3">'cube_map_#.png'</span><span class="s2">,</span>
                    <span class="s1">defaultFilename </span><span class="s2">= </span><span class="s6">0</span><span class="s2">, </span><span class="s1">source </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                    <span class="s1">camera </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">size </span><span class="s2">= </span><span class="s6">128</span><span class="s2">,</span>
                    <span class="s1">cameraMask </span><span class="s2">= </span><span class="s1">PandaNode</span><span class="s2">.</span><span class="s1">getAllCameraMask</span><span class="s2">(),</span>
                    <span class="s1">sourceLens </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>

        <span class="s0">&quot;&quot;&quot; 
        Similar to :meth:`screenshot()`, this sets up a temporary cube 
        map Texture which it uses to take a series of six snapshots of 
        the current scene, one in each of the six cube map directions. 
        This requires rendering a new frame. 
 
        Unlike `screenshot()`, source may only be a GraphicsWindow, 
        GraphicsBuffer, or DisplayRegion; it may not be a Texture. 
 
        camera should be the node to which the cubemap cameras will be 
        parented.  The default is the camera associated with source, 
        if source is a DisplayRegion, or base.camera otherwise. 
 
        :returns: The filename if successful, or None if there is a problem. 
        &quot;&quot;&quot;</span>

        <span class="s5">if </span><span class="s1">source </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">source </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span>

        <span class="s5">if </span><span class="s1">camera </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s3">&quot;getCamera&quot;</span><span class="s2">):</span>
                <span class="s1">camera </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">getCamera</span><span class="s2">()</span>
            <span class="s5">if </span><span class="s1">camera </span><span class="s5">is None</span><span class="s2">:</span>
                <span class="s1">camera </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera</span>

        <span class="s5">if </span><span class="s1">sourceLens </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">sourceLens </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camLens</span>

        <span class="s5">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s3">&quot;getWindow&quot;</span><span class="s2">):</span>
            <span class="s1">source </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">getWindow</span><span class="s2">()</span>

        <span class="s1">rig </span><span class="s2">= </span><span class="s1">NodePath</span><span class="s2">(</span><span class="s1">namePrefix</span><span class="s2">)</span>
        <span class="s1">buffer </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">makeCubeMap</span><span class="s2">(</span><span class="s1">namePrefix</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">rig</span><span class="s2">, </span><span class="s1">cameraMask</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">buffer </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s5">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;Could not make cube map.&quot;</span><span class="s2">)</span>

        <span class="s4"># Set the near and far planes from the default lens.</span>
        <span class="s1">lens </span><span class="s2">= </span><span class="s1">rig</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">'**/+Camera'</span><span class="s2">).</span><span class="s1">node</span><span class="s2">().</span><span class="s1">getLens</span><span class="s2">()</span>

        <span class="s1">lens</span><span class="s2">.</span><span class="s1">setNearFar</span><span class="s2">(</span><span class="s1">sourceLens</span><span class="s2">.</span><span class="s1">getNear</span><span class="s2">(), </span><span class="s1">sourceLens</span><span class="s2">.</span><span class="s1">getFar</span><span class="s2">())</span>

        <span class="s4"># Now render a frame to fill up the texture.</span>
        <span class="s1">rig</span><span class="s2">.</span><span class="s1">reparentTo</span><span class="s2">(</span><span class="s1">camera</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">openWindows</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">renderFrame</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">renderFrame</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">syncFrame</span><span class="s2">()</span>

        <span class="s1">tex </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">getTexture</span><span class="s2">()</span>
        <span class="s1">saved </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">screenshot</span><span class="s2">(</span><span class="s1">namePrefix </span><span class="s2">= </span><span class="s1">namePrefix</span><span class="s2">,</span>
                                <span class="s1">defaultFilename </span><span class="s2">= </span><span class="s1">defaultFilename</span><span class="s2">,</span>
                                <span class="s1">source </span><span class="s2">= </span><span class="s1">tex</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">removeWindow</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">)</span>
        <span class="s1">rig</span><span class="s2">.</span><span class="s1">removeNode</span><span class="s2">()</span>

        <span class="s5">return </span><span class="s1">saved</span>

    <span class="s5">def </span><span class="s1">saveSphereMap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">namePrefix </span><span class="s2">= </span><span class="s3">'spheremap.png'</span><span class="s2">,</span>
                      <span class="s1">defaultFilename </span><span class="s2">= </span><span class="s6">0</span><span class="s2">, </span><span class="s1">source </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                      <span class="s1">camera </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">size </span><span class="s2">= </span><span class="s6">256</span><span class="s2">,</span>
                      <span class="s1">cameraMask </span><span class="s2">= </span><span class="s1">PandaNode</span><span class="s2">.</span><span class="s1">getAllCameraMask</span><span class="s2">(),</span>
                      <span class="s1">numVertices </span><span class="s2">= </span><span class="s6">1000</span><span class="s2">, </span><span class="s1">sourceLens </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        This works much like :meth:`saveCubeMap()`, and uses the 
        graphics API's hardware cube-mapping ability to get a 360-degree 
        view of the world.  But then it converts the six cube map faces 
        into a single fisheye texture, suitable for applying as a static 
        environment map (sphere map). 
 
        For eye-relative static environment maps, sphere maps are often 
        preferable to cube maps because they require only a single 
        texture and because they are supported on a broader range of 
        hardware. 
 
        :returns: The filename if successful, or None if there is a problem. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">source </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">source </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span>

        <span class="s5">if </span><span class="s1">camera </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s3">&quot;getCamera&quot;</span><span class="s2">):</span>
                <span class="s1">camera </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">getCamera</span><span class="s2">()</span>
            <span class="s5">if </span><span class="s1">camera </span><span class="s5">is None</span><span class="s2">:</span>
                <span class="s1">camera </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera</span>

        <span class="s5">if </span><span class="s1">sourceLens </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">sourceLens </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camLens</span>

        <span class="s5">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s3">&quot;getWindow&quot;</span><span class="s2">):</span>
            <span class="s1">source </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">getWindow</span><span class="s2">()</span>

        <span class="s4"># First, make an offscreen buffer to convert the cube map to a</span>
        <span class="s4"># sphere map.  We make it first so we can guarantee the</span>
        <span class="s4"># rendering order for the cube map.</span>
        <span class="s1">toSphere </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">makeTextureBuffer</span><span class="s2">(</span><span class="s1">namePrefix</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">size</span><span class="s2">,</span>
                                            <span class="s1">Texture</span><span class="s2">(), </span><span class="s6">1</span><span class="s2">)</span>

        <span class="s4"># Now make the cube map buffer.</span>
        <span class="s1">rig </span><span class="s2">= </span><span class="s1">NodePath</span><span class="s2">(</span><span class="s1">namePrefix</span><span class="s2">)</span>
        <span class="s1">buffer </span><span class="s2">= </span><span class="s1">toSphere</span><span class="s2">.</span><span class="s1">makeCubeMap</span><span class="s2">(</span><span class="s1">namePrefix</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">rig</span><span class="s2">, </span><span class="s1">cameraMask</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">buffer </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">removeWindow</span><span class="s2">(</span><span class="s1">toSphere</span><span class="s2">)</span>
            <span class="s5">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;Could not make cube map.&quot;</span><span class="s2">)</span>

        <span class="s4"># Set the near and far planes from the default lens.</span>
        <span class="s1">lens </span><span class="s2">= </span><span class="s1">rig</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">'**/+Camera'</span><span class="s2">).</span><span class="s1">node</span><span class="s2">().</span><span class="s1">getLens</span><span class="s2">()</span>
        <span class="s1">lens</span><span class="s2">.</span><span class="s1">setNearFar</span><span class="s2">(</span><span class="s1">sourceLens</span><span class="s2">.</span><span class="s1">getNear</span><span class="s2">(), </span><span class="s1">sourceLens</span><span class="s2">.</span><span class="s1">getFar</span><span class="s2">())</span>

        <span class="s4"># Set up the scene to convert the cube map.  It's just a</span>
        <span class="s4"># simple scene, with only the FisheyeMaker object in it.</span>
        <span class="s1">dr </span><span class="s2">= </span><span class="s1">toSphere</span><span class="s2">.</span><span class="s1">makeMonoDisplayRegion</span><span class="s2">()</span>
        <span class="s1">camNode </span><span class="s2">= </span><span class="s1">Camera</span><span class="s2">(</span><span class="s3">'camNode'</span><span class="s2">)</span>
        <span class="s1">lens </span><span class="s2">= </span><span class="s1">OrthographicLens</span><span class="s2">()</span>
        <span class="s1">lens</span><span class="s2">.</span><span class="s1">setFilmSize</span><span class="s2">(</span><span class="s6">2</span><span class="s2">, </span><span class="s6">2</span><span class="s2">)</span>
        <span class="s1">lens</span><span class="s2">.</span><span class="s1">setNearFar</span><span class="s2">(-</span><span class="s6">1000</span><span class="s2">, </span><span class="s6">1000</span><span class="s2">)</span>
        <span class="s1">camNode</span><span class="s2">.</span><span class="s1">setLens</span><span class="s2">(</span><span class="s1">lens</span><span class="s2">)</span>
        <span class="s1">root </span><span class="s2">= </span><span class="s1">NodePath</span><span class="s2">(</span><span class="s3">'buffer'</span><span class="s2">)</span>
        <span class="s1">cam </span><span class="s2">= </span><span class="s1">root</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">camNode</span><span class="s2">)</span>
        <span class="s1">dr</span><span class="s2">.</span><span class="s1">setCamera</span><span class="s2">(</span><span class="s1">cam</span><span class="s2">)</span>

        <span class="s1">fm </span><span class="s2">= </span><span class="s1">FisheyeMaker</span><span class="s2">(</span><span class="s3">'card'</span><span class="s2">)</span>
        <span class="s1">fm</span><span class="s2">.</span><span class="s1">setNumVertices</span><span class="s2">(</span><span class="s1">numVertices</span><span class="s2">)</span>
        <span class="s1">fm</span><span class="s2">.</span><span class="s1">setSquareInscribed</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1.1</span><span class="s2">)</span>
        <span class="s1">fm</span><span class="s2">.</span><span class="s1">setReflection</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">card </span><span class="s2">= </span><span class="s1">root</span><span class="s2">.</span><span class="s1">attachNewNode</span><span class="s2">(</span><span class="s1">fm</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">())</span>
        <span class="s1">card</span><span class="s2">.</span><span class="s1">setTexture</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">getTexture</span><span class="s2">())</span>

        <span class="s4"># Now render a frame.  This will render out the cube map and</span>
        <span class="s4"># then apply it to the the card in the toSphere buffer.</span>
        <span class="s1">rig</span><span class="s2">.</span><span class="s1">reparentTo</span><span class="s2">(</span><span class="s1">camera</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">openWindows</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">renderFrame</span><span class="s2">()</span>

        <span class="s4"># One more frame for luck.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">renderFrame</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">syncFrame</span><span class="s2">()</span>

        <span class="s1">saved </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">screenshot</span><span class="s2">(</span><span class="s1">namePrefix </span><span class="s2">= </span><span class="s1">namePrefix</span><span class="s2">,</span>
                                <span class="s1">defaultFilename </span><span class="s2">= </span><span class="s1">defaultFilename</span><span class="s2">,</span>
                                <span class="s1">source </span><span class="s2">= </span><span class="s1">toSphere</span><span class="s2">.</span><span class="s1">getTexture</span><span class="s2">())</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">removeWindow</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">graphicsEngine</span><span class="s2">.</span><span class="s1">removeWindow</span><span class="s2">(</span><span class="s1">toSphere</span><span class="s2">)</span>
        <span class="s1">rig</span><span class="s2">.</span><span class="s1">removeNode</span><span class="s2">()</span>

        <span class="s5">return </span><span class="s1">saved</span>

    <span class="s5">def </span><span class="s1">movie</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">namePrefix </span><span class="s2">= </span><span class="s3">'movie'</span><span class="s2">, </span><span class="s1">duration </span><span class="s2">= </span><span class="s6">1.0</span><span class="s2">, </span><span class="s1">fps </span><span class="s2">= </span><span class="s6">30</span><span class="s2">,</span>
              <span class="s1">format </span><span class="s2">= </span><span class="s3">'png'</span><span class="s2">, </span><span class="s1">sd </span><span class="s2">= </span><span class="s6">4</span><span class="s2">, </span><span class="s1">source </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Spawn a task to capture a movie using the screenshot function. 
 
        Args: 
            namePrefix (str): used to form output file names (can 
                include path information (e.g. '/i/beta/frames/myMovie') 
            duration (float): the length of the movie in seconds 
            fps (float): the frame rate of the resulting movie 
            format (str): specifies output file format (e.g. png, bmp) 
            sd (int): specifies number of significant digits for frame 
                count in the output file name (e.g. if sd = 4, the name 
                will be something like movie_0001.png) 
            source: the Window, Buffer, DisplayRegion, or Texture from 
                which to save the resulting images.  The default is the 
                main window. 
 
        Returns: 
            A `~direct.task.Task` that can be awaited. 
        &quot;&quot;&quot;</span>
        <span class="s1">globalClock</span><span class="s2">.</span><span class="s1">setMode</span><span class="s2">(</span><span class="s1">ClockObject</span><span class="s2">.</span><span class="s1">MNonRealTime</span><span class="s2">)</span>
        <span class="s1">globalClock</span><span class="s2">.</span><span class="s1">setDt</span><span class="s2">(</span><span class="s6">1.0</span><span class="s2">/</span><span class="s1">float</span><span class="s2">(</span><span class="s1">fps</span><span class="s2">))</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_movieTask</span><span class="s2">, </span><span class="s1">namePrefix </span><span class="s2">+ </span><span class="s3">'_task'</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">frameIndex </span><span class="s2">= </span><span class="s6">0  </span><span class="s4"># Frame 0 is not captured.</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">numFrames </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">duration </span><span class="s2">* </span><span class="s1">fps</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">source </span><span class="s2">= </span><span class="s1">source</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">outputString </span><span class="s2">= </span><span class="s1">namePrefix </span><span class="s2">+ </span><span class="s3">'_%0' </span><span class="s2">+ </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">sd</span><span class="s2">) + </span><span class="s3">'d.' </span><span class="s2">+ </span><span class="s1">format</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setUponDeath</span><span class="s2">(</span><span class="s5">lambda </span><span class="s1">state</span><span class="s2">: </span><span class="s1">globalClock</span><span class="s2">.</span><span class="s1">setMode</span><span class="s2">(</span><span class="s1">ClockObject</span><span class="s2">.</span><span class="s1">MNormal</span><span class="s2">))</span>
        <span class="s5">return </span><span class="s1">t</span>

    <span class="s5">def </span><span class="s1">_movieTask</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">state</span><span class="s2">):</span>
        <span class="s5">if </span><span class="s1">state</span><span class="s2">.</span><span class="s1">frameIndex </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">frameName </span><span class="s2">= </span><span class="s1">state</span><span class="s2">.</span><span class="s1">outputString </span><span class="s2">% </span><span class="s1">state</span><span class="s2">.</span><span class="s1">frameIndex</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Capturing frame: &quot; </span><span class="s2">+ </span><span class="s1">frameName</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">screenshot</span><span class="s2">(</span><span class="s1">namePrefix </span><span class="s2">= </span><span class="s1">frameName</span><span class="s2">, </span><span class="s1">defaultFilename </span><span class="s2">= </span><span class="s6">0</span><span class="s2">,</span>
                            <span class="s1">source </span><span class="s2">= </span><span class="s1">state</span><span class="s2">.</span><span class="s1">source</span><span class="s2">)</span>

        <span class="s1">state</span><span class="s2">.</span><span class="s1">frameIndex </span><span class="s2">+= </span><span class="s6">1</span>
        <span class="s5">if </span><span class="s1">state</span><span class="s2">.</span><span class="s1">frameIndex </span><span class="s2">&gt; </span><span class="s1">state</span><span class="s2">.</span><span class="s1">numFrames</span><span class="s2">:</span>
            <span class="s5">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">done</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s5">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>

    <span class="s5">def </span><span class="s1">windowEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">win</span><span class="s2">):</span>
        <span class="s5">if </span><span class="s1">win </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">:</span>
            <span class="s4"># This event isn't about our window.</span>
            <span class="s5">return</span>

        <span class="s1">properties </span><span class="s2">= </span><span class="s1">win</span><span class="s2">.</span><span class="s1">getProperties</span><span class="s2">()</span>
        <span class="s5">if </span><span class="s1">properties </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__prevWindowProperties</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__prevWindowProperties </span><span class="s2">= </span><span class="s1">properties</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;Got window event: %s&quot; </span><span class="s2">% (</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">properties</span><span class="s2">)))</span>
            <span class="s5">if not </span><span class="s1">properties</span><span class="s2">.</span><span class="s1">getOpen</span><span class="s2">():</span>
                <span class="s4"># If the user closes the main window, we should exit.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;User closed main window.&quot;</span><span class="s2">)</span>
                <span class="s5">if __debug__</span><span class="s2">:</span>
                    <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__autoGarbageLogging</span><span class="s2">:</span>
                        <span class="s1">GarbageReport</span><span class="s2">.</span><span class="s1">b_checkForGarbageLeaks</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">userExit</span><span class="s2">()</span>

            <span class="s5">if </span><span class="s1">properties</span><span class="s2">.</span><span class="s1">getForeground</span><span class="s2">() </span><span class="s5">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mainWinForeground</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">mainWinForeground </span><span class="s2">= </span><span class="s6">1</span>
            <span class="s5">elif not </span><span class="s1">properties</span><span class="s2">.</span><span class="s1">getForeground</span><span class="s2">() </span><span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mainWinForeground</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">mainWinForeground </span><span class="s2">= </span><span class="s6">0</span>
                <span class="s5">if __debug__</span><span class="s2">:</span>
                    <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__autoGarbageLogging</span><span class="s2">:</span>
                        <span class="s1">GarbageReport</span><span class="s2">.</span><span class="s1">b_checkForGarbageLeaks</span><span class="s2">()</span>

            <span class="s5">if </span><span class="s1">properties</span><span class="s2">.</span><span class="s1">getMinimized</span><span class="s2">() </span><span class="s5">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mainWinMinimized</span><span class="s2">:</span>
                <span class="s4"># If the main window is minimized, throw an event to</span>
                <span class="s4"># stop the music.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">mainWinMinimized </span><span class="s2">= </span><span class="s6">1</span>
                <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s3">'PandaPaused'</span><span class="s2">)</span>
            <span class="s5">elif not </span><span class="s1">properties</span><span class="s2">.</span><span class="s1">getMinimized</span><span class="s2">() </span><span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mainWinMinimized</span><span class="s2">:</span>
                <span class="s4"># If the main window is restored, throw an event to</span>
                <span class="s4"># restart the music.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">mainWinMinimized </span><span class="s2">= </span><span class="s6">0</span>
                <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s3">'PandaRestarted'</span><span class="s2">)</span>

            <span class="s4"># If we have not forced the aspect ratio, let's see if it has</span>
            <span class="s4"># changed and update the camera lenses and aspect2d parameters</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">adjustWindowAspectRatio</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">getAspectRatio</span><span class="s2">())</span>

            <span class="s5">if </span><span class="s1">win</span><span class="s2">.</span><span class="s1">hasSize</span><span class="s2">() </span><span class="s5">and </span><span class="s1">win</span><span class="s2">.</span><span class="s1">getSbsLeftYSize</span><span class="s2">() != </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">pixel2d</span><span class="s2">.</span><span class="s1">setScale</span><span class="s2">(</span><span class="s6">2.0 </span><span class="s2">/ </span><span class="s1">win</span><span class="s2">.</span><span class="s1">getSbsLeftXSize</span><span class="s2">(), </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">2.0 </span><span class="s2">/ </span><span class="s1">win</span><span class="s2">.</span><span class="s1">getSbsLeftYSize</span><span class="s2">())</span>
                <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantRender2dp</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">pixel2dp</span><span class="s2">.</span><span class="s1">setScale</span><span class="s2">(</span><span class="s6">2.0 </span><span class="s2">/ </span><span class="s1">win</span><span class="s2">.</span><span class="s1">getSbsLeftXSize</span><span class="s2">(), </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">2.0 </span><span class="s2">/ </span><span class="s1">win</span><span class="s2">.</span><span class="s1">getSbsLeftYSize</span><span class="s2">())</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">xsize</span><span class="s2">, </span><span class="s1">ysize </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getSize</span><span class="s2">()</span>
                <span class="s5">if </span><span class="s1">xsize </span><span class="s2">&gt; </span><span class="s6">0 </span><span class="s5">and </span><span class="s1">ysize </span><span class="s2">&gt; </span><span class="s6">0</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">pixel2d</span><span class="s2">.</span><span class="s1">setScale</span><span class="s2">(</span><span class="s6">2.0 </span><span class="s2">/ </span><span class="s1">xsize</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">2.0 </span><span class="s2">/ </span><span class="s1">ysize</span><span class="s2">)</span>
                    <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantRender2dp</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">pixel2dp</span><span class="s2">.</span><span class="s1">setScale</span><span class="s2">(</span><span class="s6">2.0 </span><span class="s2">/ </span><span class="s1">xsize</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">2.0 </span><span class="s2">/ </span><span class="s1">ysize</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">adjustWindowAspectRatio</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">aspectRatio</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This function is normally called internally by 
        `windowEvent()`, but it may also be called to explicitly adjust 
        the aspect ratio of the render/render2d DisplayRegion, by a 
        class that has redefined these. &quot;&quot;&quot;</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__configAspectRatio</span><span class="s2">:</span>
            <span class="s1">aspectRatio </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__configAspectRatio</span>

        <span class="s5">if </span><span class="s1">aspectRatio </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__oldAspectRatio</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__oldAspectRatio </span><span class="s2">= </span><span class="s1">aspectRatio</span>
            <span class="s4"># Fix up some anything that depends on the aspectRatio</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">camLens</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">camLens</span><span class="s2">.</span><span class="s1">setAspectRatio</span><span class="s2">(</span><span class="s1">aspectRatio</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">aspectRatio </span><span class="s2">&lt; </span><span class="s6">1</span><span class="s2">:</span>
                <span class="s4"># If the window is TALL, lets expand the top and bottom</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">setScale</span><span class="s2">(</span><span class="s6">1.0</span><span class="s2">, </span><span class="s1">aspectRatio</span><span class="s2">, </span><span class="s1">aspectRatio</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTop </span><span class="s2">= </span><span class="s6">1.0 </span><span class="s2">/ </span><span class="s1">aspectRatio</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottom </span><span class="s2">= - </span><span class="s6">1.0 </span><span class="s2">/ </span><span class="s1">aspectRatio</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeft </span><span class="s2">= -</span><span class="s6">1</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRight </span><span class="s2">= </span><span class="s6">1.0</span>
                <span class="s4"># Don't forget 2dp</span>
                <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantRender2dp</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2dp</span><span class="s2">.</span><span class="s1">setScale</span><span class="s2">(</span><span class="s6">1.0</span><span class="s2">, </span><span class="s1">aspectRatio</span><span class="s2">, </span><span class="s1">aspectRatio</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTop </span><span class="s2">= </span><span class="s6">1.0 </span><span class="s2">/ </span><span class="s1">aspectRatio</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottom </span><span class="s2">= - </span><span class="s6">1.0 </span><span class="s2">/ </span><span class="s1">aspectRatio</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpLeft </span><span class="s2">= -</span><span class="s6">1</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpRight </span><span class="s2">= </span><span class="s6">1.0</span>

            <span class="s5">else</span><span class="s2">:</span>
                <span class="s4"># If the window is WIDE, lets expand the left and right</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2d</span><span class="s2">.</span><span class="s1">setScale</span><span class="s2">(</span><span class="s6">1.0 </span><span class="s2">/ </span><span class="s1">aspectRatio</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTop </span><span class="s2">= </span><span class="s6">1.0</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottom </span><span class="s2">= -</span><span class="s6">1.0</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeft </span><span class="s2">= -</span><span class="s1">aspectRatio</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRight </span><span class="s2">= </span><span class="s1">aspectRatio</span>
                <span class="s4"># Don't forget 2dp</span>
                <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantRender2dp</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">aspect2dp</span><span class="s2">.</span><span class="s1">setScale</span><span class="s2">(</span><span class="s6">1.0 </span><span class="s2">/ </span><span class="s1">aspectRatio</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTop </span><span class="s2">= </span><span class="s6">1.0</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottom </span><span class="s2">= -</span><span class="s6">1.0</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpLeft </span><span class="s2">= -</span><span class="s1">aspectRatio</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpRight </span><span class="s2">= </span><span class="s1">aspectRatio</span>

            <span class="s4"># Reposition the aspect2d marker nodes</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopCenter</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTop</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopCenterNs</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTop</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomCenter</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottom</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomCenterNs</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottom</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeftCenter</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeftCenterNs</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRightCenter</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRightCenterNs</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopLeft</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTop</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopLeftNs</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTop</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopRight</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTop</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTopRightNs</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dTop</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomLeft</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottom</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomLeftNs</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottom</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomRight</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottom</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottomRightNs</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dBottom</span><span class="s2">)</span>

            <span class="s4"># Reposition the aspect2dp marker nodes</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantRender2dp</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTopCenter</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTop</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottomCenter</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottom</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpLeftCenter</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpRightCenter</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTopLeft</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTop</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTopRight</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpTop</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottomLeft</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpLeft</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottom</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottomRight</span><span class="s2">.</span><span class="s1">setPos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpRight</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a2dpBottom</span><span class="s2">)</span>

            <span class="s4"># If anybody needs to update their GUI, put a callback on this event</span>
            <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s3">&quot;aspectRatioChanged&quot;</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">userExit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># The user has requested we exit the program.  Deal with this.</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exitFunc</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">exitFunc</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Exiting ShowBase.&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">finalizeExit</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">finalizeExit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Called by `userExit()` to quit the application.  The default 
        implementation just calls `sys.exit()`. 
        &quot;&quot;&quot;</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">()</span>

    <span class="s4"># [gjeon] start wxPython</span>
    <span class="s5">def </span><span class="s1">startWx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fWantWx </span><span class="s2">= </span><span class="s5">True</span><span class="s2">):</span>
        <span class="s1">fWantWx </span><span class="s2">= </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">fWantWx</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantWx </span><span class="s2">!= </span><span class="s1">fWantWx</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">wantWx </span><span class="s2">= </span><span class="s1">fWantWx</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantWx</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">spawnWxLoop</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">spawnWxLoop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Call this method to hand the main loop over to wxPython. 
        This sets up a wxTimer callback so that Panda still gets 
        updated, but wxPython owns the main loop (which seems to make 
        it happier than the other way around). &quot;&quot;&quot;</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wxAppCreated</span><span class="s2">:</span>
            <span class="s4"># Don't do this twice.</span>
            <span class="s5">return</span>

        <span class="s1">init_app_for_gui</span><span class="s2">()</span>

        <span class="s4"># Use importlib to prevent this import from being picked up</span>
        <span class="s4"># by modulefinder when packaging an application.</span>
        <span class="s1">wx </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">'wx'</span><span class="s2">)</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wxApp</span><span class="s2">:</span>
            <span class="s4"># Create a new base.wxApp.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">wxApp </span><span class="s2">= </span><span class="s1">wx</span><span class="s2">.</span><span class="s1">PySimpleApp</span><span class="s2">(</span><span class="s1">redirect </span><span class="s2">= </span><span class="s5">False</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">ConfigVariableBool</span><span class="s2">(</span><span class="s3">'wx-main-loop'</span><span class="s2">, </span><span class="s5">True</span><span class="s2">):</span>
            <span class="s4"># Put wxPython in charge of the main loop.  It really</span>
            <span class="s4"># seems to like this better; some features of wx don't</span>
            <span class="s4"># work properly unless this is true.</span>

            <span class="s4"># Set a timer to run the Panda frame 60 times per second.</span>
            <span class="s1">wxFrameRate </span><span class="s2">= </span><span class="s1">ConfigVariableDouble</span><span class="s2">(</span><span class="s3">'wx-frame-rate'</span><span class="s2">, </span><span class="s6">60.0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">wxTimer </span><span class="s2">= </span><span class="s1">wx</span><span class="s2">.</span><span class="s1">Timer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">wxApp</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">wxTimer</span><span class="s2">.</span><span class="s1">Start</span><span class="s2">(</span><span class="s6">1000.0 </span><span class="s2">/ </span><span class="s1">wxFrameRate</span><span class="s2">.</span><span class="s1">getValue</span><span class="s2">())</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">wxApp</span><span class="s2">.</span><span class="s1">Bind</span><span class="s2">(</span><span class="s1">wx</span><span class="s2">.</span><span class="s1">EVT_TIMER</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__wxTimerCallback</span><span class="s2">)</span>

            <span class="s4"># wx is now the main loop, not us any more.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">run </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wxRun</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">run </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wxRun</span>
            <span class="s1">builtins</span><span class="s2">.</span><span class="s1">run </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wxRun</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner</span><span class="s2">.</span><span class="s1">run </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wxRun</span>

        <span class="s5">else</span><span class="s2">:</span>
            <span class="s4"># Leave Panda in charge of the main loop.  This is</span>
            <span class="s4"># friendlier for IDE's and interactive editing in general.</span>
            <span class="s5">def </span><span class="s1">wxLoop</span><span class="s2">(</span><span class="s1">task</span><span class="s2">):</span>
                <span class="s4"># First we need to ensure that the OS message queue is</span>
                <span class="s4"># processed.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">wxApp</span><span class="s2">.</span><span class="s1">Yield</span><span class="s2">()</span>

                <span class="s4"># Now do all the wxPython events waiting on this frame.</span>
                <span class="s5">while </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wxApp</span><span class="s2">.</span><span class="s1">Pending</span><span class="s2">():</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">wxApp</span><span class="s2">.</span><span class="s1">Dispatch</span><span class="s2">()</span>

                <span class="s5">return </span><span class="s1">task</span><span class="s2">.</span><span class="s1">again</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">wxLoop</span><span class="s2">, </span><span class="s3">'wxLoop'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">wxAppCreated </span><span class="s2">= </span><span class="s5">True</span>

    <span class="s5">def </span><span class="s1">__wxTimerCallback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">):</span>
        <span class="s5">if </span><span class="s1">Thread</span><span class="s2">.</span><span class="s1">getCurrentThread</span><span class="s2">().</span><span class="s1">getCurrentTask</span><span class="s2">():</span>
            <span class="s4"># This happens when the wxTimer expires while igLoop is</span>
            <span class="s4"># rendering.  Ignore it.</span>
            <span class="s5">return</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">step</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">wxRun</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This method replaces `run()` after we have called `spawnWxLoop()`. 
        Since at this point wxPython now owns the main loop, this method is a 
        call to wxApp.MainLoop(). &quot;&quot;&quot;</span>

        <span class="s5">if </span><span class="s1">Thread</span><span class="s2">.</span><span class="s1">getCurrentThread</span><span class="s2">().</span><span class="s1">getCurrentTask</span><span class="s2">():</span>
            <span class="s4"># This happens in the p3d environment during startup.</span>
            <span class="s4"># Ignore it.</span>
            <span class="s5">return</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">wxApp</span><span class="s2">.</span><span class="s1">MainLoop</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">startTk</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fWantTk </span><span class="s2">= </span><span class="s5">True</span><span class="s2">):</span>
        <span class="s1">fWantTk </span><span class="s2">= </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">fWantTk</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantTk </span><span class="s2">!= </span><span class="s1">fWantTk</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">wantTk </span><span class="s2">= </span><span class="s1">fWantTk</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantTk</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">spawnTkLoop</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">spawnTkLoop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Call this method to hand the main loop over to Tkinter. 
        This sets up a timer callback so that Panda still gets 
        updated, but Tkinter owns the main loop (which seems to make 
        it happier than the other way around). &quot;&quot;&quot;</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tkRootCreated</span><span class="s2">:</span>
            <span class="s4"># Don't do this twice.</span>
            <span class="s5">return</span>

        <span class="s4"># Use importlib to prevent this import from being picked up</span>
        <span class="s4"># by modulefinder when packaging an application.</span>
        <span class="s1">tkinter </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">'_tkinter'</span><span class="s2">)</span>
        <span class="s1">Pmw </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">'Pmw'</span><span class="s2">)</span>

        <span class="s4"># Create a new Tk root.</span>
        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tkRoot</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tkRoot </span><span class="s2">= </span><span class="s1">Pmw</span><span class="s2">.</span><span class="s1">initialise</span><span class="s2">()</span>
        <span class="s1">builtins</span><span class="s2">.</span><span class="s1">tkroot </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tkRoot</span>

        <span class="s1">init_app_for_gui</span><span class="s2">()</span>

        <span class="s4"># Disable the Windows message loop, since Tcl wants to handle this all</span>
        <span class="s4"># on its own.</span>
        <span class="s1">ConfigVariableBool</span><span class="s2">(</span><span class="s3">'disable-message-loop'</span><span class="s2">, </span><span class="s5">False</span><span class="s2">).</span><span class="s1">value </span><span class="s2">= </span><span class="s5">True</span>

        <span class="s5">if </span><span class="s1">ConfigVariableBool</span><span class="s2">(</span><span class="s3">'tk-main-loop'</span><span class="s2">, </span><span class="s5">True</span><span class="s2">):</span>
            <span class="s4"># Put Tkinter in charge of the main loop.  It really</span>
            <span class="s4"># seems to like this better; the GUI otherwise becomes</span>
            <span class="s4"># largely unresponsive on Mac OS X unless this is true.</span>

            <span class="s4"># Set a timer to run the Panda frame 60 times per second.</span>
            <span class="s1">tkFrameRate </span><span class="s2">= </span><span class="s1">ConfigVariableDouble</span><span class="s2">(</span><span class="s3">'tk-frame-rate'</span><span class="s2">, </span><span class="s6">60.0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tkDelay </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s6">1000.0 </span><span class="s2">/ </span><span class="s1">tkFrameRate</span><span class="s2">.</span><span class="s1">getValue</span><span class="s2">())</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tkRoot</span><span class="s2">.</span><span class="s1">after</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tkDelay</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__tkTimerCallback</span><span class="s2">)</span>

            <span class="s4"># wx is now the main loop, not us any more.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">run </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tkRun</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">run </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tkRun</span>
            <span class="s1">builtins</span><span class="s2">.</span><span class="s1">run </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tkRun</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner</span><span class="s2">.</span><span class="s1">run </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tkRun</span>

        <span class="s5">else</span><span class="s2">:</span>
            <span class="s4"># Leave Panda in charge of the main loop.  This is</span>
            <span class="s4"># friendlier for IDE's and interactive editing in general.</span>
            <span class="s5">def </span><span class="s1">tkLoop</span><span class="s2">(</span><span class="s1">task</span><span class="s2">):</span>
                <span class="s4"># Do all the tkinter events waiting on this frame</span>
                <span class="s4"># dooneevent will return 0 if there are no more events</span>
                <span class="s4"># waiting or 1 if there are still more.</span>
                <span class="s4"># DONT_WAIT tells tkinter not to block waiting for events</span>
                <span class="s5">while </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tkRoot</span><span class="s2">.</span><span class="s1">dooneevent</span><span class="s2">(</span><span class="s1">tkinter</span><span class="s2">.</span><span class="s1">ALL_EVENTS </span><span class="s2">| </span><span class="s1">tkinter</span><span class="s2">.</span><span class="s1">DONT_WAIT</span><span class="s2">):</span>
                    <span class="s5">pass</span>

                <span class="s5">return </span><span class="s1">task</span><span class="s2">.</span><span class="s1">again</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">tkLoop</span><span class="s2">, </span><span class="s3">'tkLoop'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tkRootCreated </span><span class="s2">= </span><span class="s5">True</span>

    <span class="s5">def </span><span class="s1">__tkTimerCallback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">if not </span><span class="s1">Thread</span><span class="s2">.</span><span class="s1">getCurrentThread</span><span class="s2">().</span><span class="s1">getCurrentTask</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">step</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">tkRoot</span><span class="s2">.</span><span class="s1">after</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tkDelay</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__tkTimerCallback</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">tkRun</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This method replaces `run()` after we have called `spawnTkLoop()`. 
        Since at this point Tkinter now owns the main loop, this method is a 
        call to tkRoot.mainloop(). &quot;&quot;&quot;</span>

        <span class="s5">if </span><span class="s1">Thread</span><span class="s2">.</span><span class="s1">getCurrentThread</span><span class="s2">().</span><span class="s1">getCurrentTask</span><span class="s2">():</span>
            <span class="s4"># This happens in the p3d environment during startup.</span>
            <span class="s4"># Ignore it.</span>
            <span class="s5">return</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">tkRoot</span><span class="s2">.</span><span class="s1">mainloop</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">startDirect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fWantDirect </span><span class="s2">= </span><span class="s6">1</span><span class="s2">, </span><span class="s1">fWantTk </span><span class="s2">= </span><span class="s6">1</span><span class="s2">, </span><span class="s1">fWantWx </span><span class="s2">= </span><span class="s6">0</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">startTk</span><span class="s2">(</span><span class="s1">fWantTk</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">startWx</span><span class="s2">(</span><span class="s1">fWantWx</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantDirect </span><span class="s2">== </span><span class="s1">fWantDirect</span><span class="s2">:</span>
            <span class="s5">return</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">wantDirect </span><span class="s2">= </span><span class="s1">fWantDirect</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wantDirect</span><span class="s2">:</span>
            <span class="s4"># Use importlib to prevent this import from being picked up</span>
            <span class="s4"># by modulefinder when packaging an application.</span>
            <span class="s1">DirectSession </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">'direct.directtools.DirectSession'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">direct </span><span class="s2">= </span><span class="s1">DirectSession</span><span class="s2">.</span><span class="s1">DirectSession</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">direct</span><span class="s2">.</span><span class="s1">enable</span><span class="s2">()</span>
            <span class="s1">builtins</span><span class="s2">.</span><span class="s1">direct </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">direct</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">builtins</span><span class="s2">.</span><span class="s1">direct </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">direct </span><span class="s2">= </span><span class="s5">None</span>

    <span class="s5">def </span><span class="s1">getRepository</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">return None</span>

    <span class="s5">def </span><span class="s1">getAxes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Loads and returns the ``models/misc/xyzAxis.bam`` model. 
 
        :rtype: panda3d.core.NodePath 
        &quot;&quot;&quot;</span>
        <span class="s5">return </span><span class="s1">loader</span><span class="s2">.</span><span class="s1">loadModel</span><span class="s2">(</span><span class="s3">&quot;models/misc/xyzAxis.bam&quot;</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">__doStartDirect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__directStarted</span><span class="s2">:</span>
            <span class="s5">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__directStarted </span><span class="s2">= </span><span class="s5">False</span>

        <span class="s4"># Start Tk, Wx and DIRECT if specified by Config.prc</span>
        <span class="s1">fTk </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'want-tk'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">fWx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'want-wx'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s4"># Start DIRECT if specified in Config.prc or in cluster mode</span>
        <span class="s1">fDirect </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'want-directtools'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">) </span><span class="s5">or</span>
                   <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetString</span><span class="s2">(</span><span class="s3">&quot;cluster-mode&quot;</span><span class="s2">, </span><span class="s3">''</span><span class="s2">) != </span><span class="s3">''</span><span class="s2">))</span>
        <span class="s4"># Set fWantTk to 0 to avoid starting Tk with this call</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">startDirect</span><span class="s2">(</span><span class="s1">fWantDirect </span><span class="s2">= </span><span class="s1">fDirect</span><span class="s2">, </span><span class="s1">fWantTk </span><span class="s2">= </span><span class="s1">fTk</span><span class="s2">, </span><span class="s1">fWantWx </span><span class="s2">= </span><span class="s1">fWx</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">run</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot;This method runs the :class:`~direct.task.Task.TaskManager` 
        when ``self.appRunner is None``, which is to say, when we are 
        not running from within a p3d file.  When we *are* within a p3d 
        file, the Panda3D runtime has to be responsible for running the 
        main loop, so we can't allow the application to do it. 
        &quot;&quot;&quot;</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner </span><span class="s5">is None or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner</span><span class="s2">.</span><span class="s1">dummy </span><span class="s5">or </span><span class="s1">\</span>
           <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner</span><span class="s2">.</span><span class="s1">interactiveConsole </span><span class="s5">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">appRunner</span><span class="s2">.</span><span class="s1">initialAppImport</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">run</span><span class="s2">()</span>


    <span class="s4"># Snake-case aliases, for people who prefer these.  We're in the process</span>
    <span class="s4"># of migrating everyone to use the snake-case alternatives.</span>
    <span class="s1">make_default_pipe </span><span class="s2">= </span><span class="s1">makeDefaultPipe</span>
    <span class="s1">make_module_pipe </span><span class="s2">= </span><span class="s1">makeModulePipe</span>
    <span class="s1">make_all_pipes </span><span class="s2">= </span><span class="s1">makeAllPipes</span>
    <span class="s1">open_window </span><span class="s2">= </span><span class="s1">openWindow</span>
    <span class="s1">close_window </span><span class="s2">= </span><span class="s1">closeWindow</span>
    <span class="s1">open_default_window </span><span class="s2">= </span><span class="s1">openDefaultWindow</span>
    <span class="s1">open_main_window </span><span class="s2">= </span><span class="s1">openMainWindow</span>
    <span class="s1">set_sleep </span><span class="s2">= </span><span class="s1">setSleep</span>
    <span class="s1">set_frame_rate_meter </span><span class="s2">= </span><span class="s1">setFrameRateMeter</span>
    <span class="s1">set_scene_graph_analyzer_meter </span><span class="s2">= </span><span class="s1">setSceneGraphAnalyzerMeter</span>
    <span class="s1">setup_window_controls </span><span class="s2">= </span><span class="s1">setupWindowControls</span>
    <span class="s1">setup_render </span><span class="s2">= </span><span class="s1">setupRender</span>
    <span class="s1">setup_render2d </span><span class="s2">= </span><span class="s1">setupRender2d</span>
    <span class="s1">setup_render2dp </span><span class="s2">= </span><span class="s1">setupRender2dp</span>
    <span class="s1">set_aspect_ratio </span><span class="s2">= </span><span class="s1">setAspectRatio</span>
    <span class="s1">get_aspect_ratio </span><span class="s2">= </span><span class="s1">getAspectRatio</span>
    <span class="s1">get_size </span><span class="s2">= </span><span class="s1">getSize</span>
    <span class="s1">make_camera </span><span class="s2">= </span><span class="s1">makeCamera</span>
    <span class="s1">make_camera2d </span><span class="s2">= </span><span class="s1">makeCamera2d</span>
    <span class="s1">make_camera2dp </span><span class="s2">= </span><span class="s1">makeCamera2dp</span>
    <span class="s1">setup_data_graph </span><span class="s2">= </span><span class="s1">setupDataGraph</span>
    <span class="s1">setup_mouse </span><span class="s2">= </span><span class="s1">setupMouse</span>
    <span class="s1">setup_mouse_cb </span><span class="s2">= </span><span class="s1">setupMouseCB</span>
    <span class="s1">enable_software_mouse_pointer </span><span class="s2">= </span><span class="s1">enableSoftwareMousePointer</span>
    <span class="s1">detach_input_device </span><span class="s2">= </span><span class="s1">detachInputDevice</span>
    <span class="s1">attach_input_device </span><span class="s2">= </span><span class="s1">attachInputDevice</span>
    <span class="s1">add_angular_integrator </span><span class="s2">= </span><span class="s1">addAngularIntegrator</span>
    <span class="s1">enable_particles </span><span class="s2">= </span><span class="s1">enableParticles</span>
    <span class="s1">disable_particles </span><span class="s2">= </span><span class="s1">disableParticles</span>
    <span class="s1">toggle_particles </span><span class="s2">= </span><span class="s1">toggleParticles</span>
    <span class="s1">create_stats </span><span class="s2">= </span><span class="s1">createStats</span>
    <span class="s1">add_sfx_manager </span><span class="s2">= </span><span class="s1">addSfxManager</span>
    <span class="s1">enable_music </span><span class="s2">= </span><span class="s1">enableMusic</span>
    <span class="s1">enable_sound_effects </span><span class="s2">= </span><span class="s1">enableSoundEffects</span>
    <span class="s1">disable_all_audio </span><span class="s2">= </span><span class="s1">disableAllAudio</span>
    <span class="s1">enable_all_audio </span><span class="s2">= </span><span class="s1">enableAllAudio</span>
    <span class="s1">init_shadow_trav </span><span class="s2">= </span><span class="s1">initShadowTrav</span>
    <span class="s1">get_background_color </span><span class="s2">= </span><span class="s1">getBackgroundColor</span>
    <span class="s1">set_background_color </span><span class="s2">= </span><span class="s1">setBackgroundColor</span>
    <span class="s1">toggle_backface </span><span class="s2">= </span><span class="s1">toggleBackface</span>
    <span class="s1">backface_culling_on </span><span class="s2">= </span><span class="s1">backfaceCullingOn</span>
    <span class="s1">backface_culling_off </span><span class="s2">= </span><span class="s1">backfaceCullingOff</span>
    <span class="s1">toggle_texture </span><span class="s2">= </span><span class="s1">toggleTexture</span>
    <span class="s1">texture_on </span><span class="s2">= </span><span class="s1">textureOn</span>
    <span class="s1">texture_off </span><span class="s2">= </span><span class="s1">textureOff</span>
    <span class="s1">toggle_wireframe </span><span class="s2">= </span><span class="s1">toggleWireframe</span>
    <span class="s1">wireframe_on </span><span class="s2">= </span><span class="s1">wireframeOn</span>
    <span class="s1">wireframe_off </span><span class="s2">= </span><span class="s1">wireframeOff</span>
    <span class="s1">disable_mouse </span><span class="s2">= </span><span class="s1">disableMouse</span>
    <span class="s1">enable_mouse </span><span class="s2">= </span><span class="s1">enableMouse</span>
    <span class="s1">silence_input </span><span class="s2">= </span><span class="s1">silenceInput</span>
    <span class="s1">revive_input </span><span class="s2">= </span><span class="s1">reviveInput</span>
    <span class="s1">set_mouse_on_node </span><span class="s2">= </span><span class="s1">setMouseOnNode</span>
    <span class="s1">change_mouse_interface </span><span class="s2">= </span><span class="s1">changeMouseInterface</span>
    <span class="s1">use_drive </span><span class="s2">= </span><span class="s1">useDrive</span>
    <span class="s1">use_trackball </span><span class="s2">= </span><span class="s1">useTrackball</span>
    <span class="s1">toggle_tex_mem </span><span class="s2">= </span><span class="s1">toggleTexMem</span>
    <span class="s1">toggle_show_vertices </span><span class="s2">= </span><span class="s1">toggleShowVertices</span>
    <span class="s1">oobe_cull </span><span class="s2">= </span><span class="s1">oobeCull</span>
    <span class="s1">show_camera_frustum </span><span class="s2">= </span><span class="s1">showCameraFrustum</span>
    <span class="s1">remove_camera_frustum </span><span class="s2">= </span><span class="s1">removeCameraFrustum</span>
    <span class="s1">save_cube_map </span><span class="s2">= </span><span class="s1">saveCubeMap</span>
    <span class="s1">save_sphere_map </span><span class="s2">= </span><span class="s1">saveSphereMap</span>
    <span class="s1">start_wx </span><span class="s2">= </span><span class="s1">startWx</span>
    <span class="s1">start_tk </span><span class="s2">= </span><span class="s1">startTk</span>
    <span class="s1">start_direct </span><span class="s2">= </span><span class="s1">startDirect</span>


<span class="s4"># A class to encapsulate information necessary for multiwindow support.</span>
<span class="s5">class </span><span class="s1">WindowControls</span><span class="s2">:</span>
    <span class="s5">def </span><span class="s1">__init__</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">, </span><span class="s1">win</span><span class="s2">, </span><span class="s1">cam</span><span class="s2">=</span><span class="s5">None</span><span class="s2">, </span><span class="s1">camNode</span><span class="s2">=</span><span class="s5">None</span><span class="s2">, </span><span class="s1">cam2d</span><span class="s2">=</span><span class="s5">None</span><span class="s2">, </span><span class="s1">mouseWatcher</span><span class="s2">=</span><span class="s5">None</span><span class="s2">,</span>
            <span class="s1">mouseKeyboard</span><span class="s2">=</span><span class="s5">None</span><span class="s2">, </span><span class="s1">closeCmd</span><span class="s2">=</span><span class="s5">lambda</span><span class="s2">: </span><span class="s6">0</span><span class="s2">, </span><span class="s1">grid</span><span class="s2">=</span><span class="s5">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">win </span><span class="s2">= </span><span class="s1">win</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">camera </span><span class="s2">= </span><span class="s1">cam</span>
        <span class="s5">if </span><span class="s1">camNode </span><span class="s5">is None and </span><span class="s1">cam </span><span class="s5">is not None</span><span class="s2">:</span>
            <span class="s1">camNode </span><span class="s2">= </span><span class="s1">cam</span><span class="s2">.</span><span class="s1">node</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">camNode </span><span class="s2">= </span><span class="s1">camNode</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">camera2d </span><span class="s2">= </span><span class="s1">cam2d</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcher </span><span class="s2">= </span><span class="s1">mouseWatcher</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mouseKeyboard </span><span class="s2">= </span><span class="s1">mouseKeyboard</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">closeCommand </span><span class="s2">= </span><span class="s1">closeCmd</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">grid </span><span class="s2">= </span><span class="s1">grid</span>

    <span class="s5">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s3">&quot;window = &quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">win</span><span class="s2">) + </span><span class="s3">&quot;</span><span class="s5">\n</span><span class="s3">&quot;</span>
        <span class="s1">s </span><span class="s2">+= </span><span class="s3">&quot;camera = &quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera</span><span class="s2">) + </span><span class="s3">&quot;</span><span class="s5">\n</span><span class="s3">&quot;</span>
        <span class="s1">s </span><span class="s2">+= </span><span class="s3">&quot;camNode = &quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">camNode</span><span class="s2">) + </span><span class="s3">&quot;</span><span class="s5">\n</span><span class="s3">&quot;</span>
        <span class="s1">s </span><span class="s2">+= </span><span class="s3">&quot;camera2d = &quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">camera2d</span><span class="s2">) + </span><span class="s3">&quot;</span><span class="s5">\n</span><span class="s3">&quot;</span>
        <span class="s1">s </span><span class="s2">+= </span><span class="s3">&quot;mouseWatcher = &quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseWatcher</span><span class="s2">) + </span><span class="s3">&quot;</span><span class="s5">\n</span><span class="s3">&quot;</span>
        <span class="s1">s </span><span class="s2">+= </span><span class="s3">&quot;mouseAndKeyboard = &quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseKeyboard</span><span class="s2">) + </span><span class="s3">&quot;</span><span class="s5">\n</span><span class="s3">&quot;</span>
        <span class="s5">return </span><span class="s1">s</span>
</pre>
</body>
</html>