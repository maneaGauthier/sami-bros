<html>
<head>
<title>make_xpi.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
make_xpi.py</font>
</center></td></tr></table>
<pre><span class="s0">#! /usr/bin/env python</span>

<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">shutil</span>
<span class="s2">import </span><span class="s1">platform</span>
<span class="s2">import </span><span class="s1">tempfile</span>
<span class="s2">import </span><span class="s1">zipfile</span>
<span class="s2">from </span><span class="s1">optparse </span><span class="s2">import </span><span class="s1">OptionParser</span>
<span class="s2">import </span><span class="s1">subprocess</span>

<span class="s2">try</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s1">hashlib </span><span class="s2">import </span><span class="s1">sha1 </span><span class="s2">as </span><span class="s1">sha</span>
<span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s1">sha </span><span class="s2">import </span><span class="s1">sha</span>

<span class="s1">usage </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot; 
This command creates a Firefox XPI installer for the Panda3D Firefox 
plugin.  Also see make_installer.py. 
 
  %prog [opts]&quot;&quot;&quot;</span>

<span class="s1">parser </span><span class="s3">= </span><span class="s1">OptionParser</span><span class="s3">(</span><span class="s1">usage </span><span class="s3">= </span><span class="s1">usage</span><span class="s3">)</span>
<span class="s1">parser</span><span class="s3">.</span><span class="s1">add_option</span><span class="s3">(</span><span class="s4">'-v'</span><span class="s3">, </span><span class="s4">'--version'</span><span class="s3">, </span><span class="s1">dest </span><span class="s3">= </span><span class="s4">'version'</span><span class="s3">,</span>
                  <span class="s1">help </span><span class="s3">= </span><span class="s4">'The product version'</span><span class="s3">,</span>
                  <span class="s1">default </span><span class="s3">= </span><span class="s2">None</span><span class="s3">)</span>
<span class="s1">parser</span><span class="s3">.</span><span class="s1">add_option</span><span class="s3">(</span><span class="s4">'-i'</span><span class="s3">, </span><span class="s4">'--plugin_root'</span><span class="s3">, </span><span class="s1">dest </span><span class="s3">= </span><span class="s4">'plugin_root'</span><span class="s3">,</span>
                  <span class="s1">help </span><span class="s3">= </span><span class="s4">'The root of a directory hierarchy in which the Firefox plugins for various platforms can be found, to build a Firefox xpi file.  This is normally the same as the staging directory populated by the -i parameter to ppackage.  This directory should contain a directory called &quot;plugin&quot;, which contains in turn a number of directories named for the platform, by the Panda plugin convention, e.g. linux_i386, osx_ppc, and so on.  Each platform directory should contain a Firefox plugin, e.g. nppanda3d.so.'</span><span class="s3">)</span>
<span class="s1">parser</span><span class="s3">.</span><span class="s1">add_option</span><span class="s3">(</span><span class="s4">''</span><span class="s3">, </span><span class="s4">'--host_url'</span><span class="s3">, </span><span class="s1">dest </span><span class="s3">= </span><span class="s4">'host_url'</span><span class="s3">,</span>
                  <span class="s1">help </span><span class="s3">= </span><span class="s4">&quot;The URL at which plugin_root will be hosted.  This is used to construct the update URL for the xpi file.  This is required if you specify --plugin_root.&quot;</span><span class="s3">)</span>

<span class="s3">(</span><span class="s1">options</span><span class="s3">, </span><span class="s1">args</span><span class="s3">) = </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">parse_args</span><span class="s3">()</span>

<span class="s1">this_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">argv</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])[</span><span class="s5">0</span><span class="s3">]</span>

<span class="s2">assert </span><span class="s1">options</span><span class="s3">.</span><span class="s1">version</span><span class="s3">, </span><span class="s4">&quot;A version number must be supplied!&quot;</span>
<span class="s2">assert </span><span class="s1">options</span><span class="s3">.</span><span class="s1">plugin_root</span><span class="s3">, </span><span class="s4">&quot;The plugin_root must be supplied!&quot;</span>
<span class="s2">assert </span><span class="s1">options</span><span class="s3">.</span><span class="s1">host_url</span><span class="s3">, </span><span class="s4">&quot;The host_url must be supplied!&quot;</span>

<span class="s0"># A mapping of Panda's platform strings to Firefox's equivalent</span>
<span class="s0"># strings.</span>

<span class="s0"># I'm leaving out the Linux platforms for now.  I think there is too</span>
<span class="s0"># much variance between distro's for this to be reliable; we'll make</span>
<span class="s0"># each Linux user install their distro-specific plugin instead of</span>
<span class="s0"># going through this mechanism.</span>
<span class="s1">FirefoxPlatformMap </span><span class="s3">= {</span>
    <span class="s4">'win32' </span><span class="s3">: </span><span class="s4">'WINNT_x86-msvc'</span><span class="s3">,</span>
    <span class="s4">'win_i386' </span><span class="s3">: </span><span class="s4">'WINNT_x86-msvc'</span><span class="s3">,</span>
    <span class="s4">'win_amd64' </span><span class="s3">: </span><span class="s4">'WINNT_x86_64-msvc'</span><span class="s3">,</span>
<span class="s0">#    'linux_i386' : 'Linux_x86-gcc3',</span>
<span class="s0">#    'linux_amd64' : 'Linux_x86_64-gcc3',</span>
<span class="s0">#    'linux_ppc' : 'Linux_ppc-gcc3',</span>
    <span class="s4">'osx_i386' </span><span class="s3">: </span><span class="s4">'Darwin_x86-gcc3'</span><span class="s3">,</span>
    <span class="s4">'osx_amd64' </span><span class="s3">: </span><span class="s4">'Darwin_x86_64-gcc3'</span><span class="s3">,</span>
    <span class="s4">'osx_ppc' </span><span class="s3">: </span><span class="s4">'Darwin_ppc-gcc3'</span><span class="s3">,</span>
    <span class="s4">'freebsd_i386' </span><span class="s3">: </span><span class="s4">'FreeBSD_x86-gcc3'</span><span class="s3">,</span>
    <span class="s4">'freebsd_amd64' </span><span class="s3">: </span><span class="s4">'FreeBSD_x86_64-gcc3'</span><span class="s3">,</span>
    <span class="s3">}</span>

<span class="s0">##############################################################################</span>
<span class="s0">#</span>
<span class="s0"># This install.rdf file is used when building a Firefox XPI file.</span>
<span class="s0">#</span>
<span class="s0">##############################################################################</span>

<span class="s1">install_rdf </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot;?&gt; 
&lt;RDF xmlns=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; xmlns:em=&quot;http://www.mozilla.org/2004/em-rdf#&quot;&gt; 
  &lt;Description about=&quot;urn:mozilla:install-manifest&quot;&gt; 
    &lt;em:id&gt;%(package_id)s&lt;/em:id&gt; 
    &lt;em:unpack&gt;true&lt;/em:unpack&gt; 
    &lt;em:name&gt;Panda3D Game Engine Plug-In&lt;/em:name&gt; 
    &lt;em:description&gt;Runs 3-D games and interactive applets&lt;/em:description&gt; 
    &lt;em:version&gt;%(version)s&lt;/em:version&gt; 
    &lt;em:targetApplication&gt; 
      &lt;Description&gt; 
        &lt;em:id&gt;{ec8030f7-c20a-464f-9b0e-13a3a9e97384}&lt;/em:id&gt; 
        &lt;em:minVersion&gt;3.0&lt;/em:minVersion&gt; 
        &lt;em:maxVersion&gt;*&lt;/em:maxVersion&gt; 
      &lt;/Description&gt; 
    &lt;/em:targetApplication&gt; 
    &lt;em:homepageURL&gt;http://www.panda3d.org/&lt;/em:homepageURL&gt; 
    &lt;em:updateURL&gt;%(host_url)s/plugin/firefox/update.rdf&lt;/em:updateURL&gt; 
  &lt;/Description&gt; 
&lt;/RDF&gt; 
&quot;&quot;&quot;</span>

<span class="s0">##############################################################################</span>
<span class="s0">#</span>
<span class="s0"># This update.rdf file is used when building a Firefox XPI file.</span>
<span class="s0">#</span>
<span class="s0">##############################################################################</span>

<span class="s1">update_rdf </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot;?&gt; 
&lt;RDF:RDF xmlns:RDF=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; 
         xmlns:em=&quot;http://www.mozilla.org/2004/em-rdf#&quot;&gt; 
 
  &lt;RDF:Description about=&quot;urn:mozilla:extension:%(package_id)s&quot;&gt; 
    &lt;em:updates&gt; 
      &lt;RDF:Seq&gt; 
        &lt;RDF:li&gt; 
          &lt;RDF:Description&gt; 
            &lt;em:version&gt;%(version)s&lt;/em:version&gt; 
            &lt;em:targetApplication&gt; 
              &lt;RDF:Description&gt; 
                &lt;em:id&gt;{ec8030f7-c20a-464f-9b0e-13a3a9e97384}&lt;/em:id&gt; 
                &lt;em:minVersion&gt;3.0&lt;/em:minVersion&gt; 
                &lt;em:maxVersion&gt;*&lt;/em:maxVersion&gt; 
                &lt;em:updateLink&gt;%(host_url)s/plugin/firefox/nppanda3d.xpi&lt;/em:updateLink&gt; 
                &lt;em:updateHash&gt;sha1:%(xpi_hash)s&lt;/em:updateHash&gt; 
              &lt;/RDF:Description&gt; 
            &lt;/em:targetApplication&gt; 
          &lt;/RDF:Description&gt; 
        &lt;/RDF:li&gt; 
      &lt;/RDF:Seq&gt; 
    &lt;/em:updates&gt; 
  &lt;/RDF:Description&gt; 
&lt;/RDF:RDF&gt; 
&quot;&quot;&quot;</span>

<span class="s2">def </span><span class="s1">makeXpiFile</span><span class="s3">():</span>
    <span class="s6">&quot;&quot;&quot; Creates a Firefox XPI file, based on the various platform 
    version files. &quot;&quot;&quot;</span>

    <span class="s2">if not </span><span class="s1">options</span><span class="s3">.</span><span class="s1">host_url</span><span class="s3">:</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;Cannot generate xpi file without --host-url.&quot;</span><span class="s3">)</span>
        <span class="s1">sys</span><span class="s3">.</span><span class="s1">exit</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>

    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;Generating xpi file&quot;</span><span class="s3">)</span>
    <span class="s1">root </span><span class="s3">= </span><span class="s1">options</span><span class="s3">.</span><span class="s1">plugin_root</span>
    <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">root</span><span class="s3">, </span><span class="s4">'plugin'</span><span class="s3">)):</span>
        <span class="s1">root </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">root</span><span class="s3">, </span><span class="s4">'plugin'</span><span class="s3">)</span>

    <span class="s1">xpi </span><span class="s3">= </span><span class="s1">zipfile</span><span class="s3">.</span><span class="s1">ZipFile</span><span class="s3">(</span><span class="s4">'nppanda3d.xpi'</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">)</span>

    <span class="s1">package_id </span><span class="s3">= </span><span class="s4">'runtime@panda3d.org' </span><span class="s0">#TODO: maybe more customizable?</span>

    <span class="s1">tempFile </span><span class="s3">= </span><span class="s1">tempfile</span><span class="s3">.</span><span class="s1">mktemp</span><span class="s3">(</span><span class="s4">'.txt'</span><span class="s3">, </span><span class="s4">'p3d_'</span><span class="s3">)</span>
    <span class="s1">rdf </span><span class="s3">= </span><span class="s1">open</span><span class="s3">(</span><span class="s1">tempFile</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">)</span>
    <span class="s1">rdf</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">install_rdf </span><span class="s3">% {</span>
        <span class="s4">'package_id' </span><span class="s3">: </span><span class="s1">package_id</span><span class="s3">,</span>
        <span class="s4">'version' </span><span class="s3">: </span><span class="s1">options</span><span class="s3">.</span><span class="s1">version</span><span class="s3">,</span>
        <span class="s4">'host_url' </span><span class="s3">: </span><span class="s1">options</span><span class="s3">.</span><span class="s1">host_url</span><span class="s3">,</span>
        <span class="s3">})</span>
    <span class="s1">rdf</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
    <span class="s1">xpi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">tempFile</span><span class="s3">, </span><span class="s4">'install.rdf'</span><span class="s3">)</span>
    <span class="s1">os</span><span class="s3">.</span><span class="s1">unlink</span><span class="s3">(</span><span class="s1">tempFile</span><span class="s3">)</span>

    <span class="s1">subdirs </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s1">root</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">subdir </span><span class="s2">in </span><span class="s1">subdirs</span><span class="s3">:</span>
        <span class="s1">platform </span><span class="s3">= </span><span class="s1">FirefoxPlatformMap</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">subdir</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">root</span><span class="s3">, </span><span class="s1">subdir</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">platform </span><span class="s2">and </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">subdir </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'win32'</span><span class="s3">, </span><span class="s4">'osx_i386'</span><span class="s3">]:</span>
                <span class="s1">pluginsXpiDir </span><span class="s3">= </span><span class="s4">'plugins'</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s0"># Create the XPI directory platform/&lt;platform name&gt;/plugins</span>
                <span class="s1">pluginsXpiDir </span><span class="s3">= </span><span class="s4">'platform/%s/plugins' </span><span class="s3">% (</span><span class="s1">platform</span><span class="s3">)</span>

            <span class="s0"># Copy the Firefox plugin into this directory.</span>
            <span class="s2">if </span><span class="s1">subdir</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'win32'</span><span class="s3">):</span>
                <span class="s1">pluginFilename </span><span class="s3">= </span><span class="s4">'nppanda3d.dll'</span>
            <span class="s2">elif </span><span class="s1">subdir</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'osx'</span><span class="s3">):</span>
                <span class="s1">pluginFilename </span><span class="s3">= </span><span class="s4">'nppanda3d.plugin'</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">pluginFilename </span><span class="s3">= </span><span class="s4">'nppanda3d.so'</span>

            <span class="s1">addZipTree</span><span class="s3">(</span><span class="s1">xpi</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">pluginFilename</span><span class="s3">),</span>
                       <span class="s1">pluginsXpiDir </span><span class="s3">+ </span><span class="s4">'/' </span><span class="s3">+ </span><span class="s1">pluginFilename</span><span class="s3">)</span>
    <span class="s1">xpi</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s0"># Now that we've generated the xpi file, get its hash.</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s1">open</span><span class="s3">(</span><span class="s4">'nppanda3d.xpi'</span><span class="s3">, </span><span class="s4">'rb'</span><span class="s3">).</span><span class="s1">read</span><span class="s3">()</span>
    <span class="s1">xpi_hash </span><span class="s3">= </span><span class="s1">sha</span><span class="s3">(</span><span class="s1">data</span><span class="s3">).</span><span class="s1">hexdigest</span><span class="s3">()</span>

    <span class="s0"># And now we can generate the update.rdf file.</span>
    <span class="s1">update </span><span class="s3">= </span><span class="s1">open</span><span class="s3">(</span><span class="s4">'update.rdf'</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">)</span>
    <span class="s1">update</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">update_rdf </span><span class="s3">% {</span>
        <span class="s4">'package_id' </span><span class="s3">: </span><span class="s1">package_id</span><span class="s3">,</span>
        <span class="s4">'version' </span><span class="s3">: </span><span class="s1">options</span><span class="s3">.</span><span class="s1">version</span><span class="s3">,</span>
        <span class="s4">'host_url' </span><span class="s3">: </span><span class="s1">options</span><span class="s3">.</span><span class="s1">host_url</span><span class="s3">,</span>
        <span class="s4">'xpi_hash' </span><span class="s3">: </span><span class="s1">xpi_hash</span><span class="s3">,</span>
        <span class="s3">})</span>
    <span class="s1">update</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

<span class="s2">def </span><span class="s1">addZipTree</span><span class="s3">(</span><span class="s1">zip</span><span class="s3">, </span><span class="s1">sourceFile</span><span class="s3">, </span><span class="s1">zipName</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot; Adds the sourceFile to the zip archive at the indicated name. 
    If it is a directory, recursively adds all nested files as 
    well. &quot;&quot;&quot;</span>

    <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">sourceFile</span><span class="s3">):</span>
        <span class="s1">subdirs </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s1">sourceFile</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">subdir </span><span class="s2">in </span><span class="s1">subdirs</span><span class="s3">:</span>
            <span class="s1">addZipTree</span><span class="s3">(</span><span class="s1">zip</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">sourceFile</span><span class="s3">, </span><span class="s1">subdir</span><span class="s3">),</span>
                       <span class="s1">zipName </span><span class="s3">+ </span><span class="s4">'/' </span><span class="s3">+ </span><span class="s1">subdir</span><span class="s3">)</span>

    <span class="s2">else</span><span class="s3">:</span>
        <span class="s0"># Not a directory, just add the file.</span>
        <span class="s1">zip</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">sourceFile</span><span class="s3">, </span><span class="s1">zipName</span><span class="s3">)</span>

<span class="s1">makeXpiFile</span><span class="s3">()</span>

</pre>
</body>
</html>