<html>
<head>
<title>JavaScript.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
JavaScript.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; This module defines some simple classes and instances which are 
useful when writing code that integrates with JavaScript, especially 
code that runs in a browser via the web plugin. 
 
.. deprecated:: 1.10.0 
   The browser plug-in is no longer supported. 
&quot;&quot;&quot;</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">&quot;UndefinedObject&quot;</span><span class="s2">, </span><span class="s3">&quot;Undefined&quot;</span><span class="s2">, </span><span class="s3">&quot;ConcreteStruct&quot;</span><span class="s2">, </span><span class="s3">&quot;BrowserObject&quot;</span><span class="s2">, </span><span class="s3">&quot;MethodWrapper&quot;</span><span class="s2">]</span>

<span class="s4">class </span><span class="s1">UndefinedObject</span><span class="s2">:</span>
    <span class="s0">&quot;&quot;&quot; This is a special object that is returned by the browser to 
    represent an &quot;undefined&quot; or &quot;void&quot; value, typically the value for 
    an uninitialized variable or undefined property.  It has no 
    attributes, similar to None, but it is a slightly different 
    concept in JavaScript. &quot;&quot;&quot;</span>

    <span class="s4">def </span><span class="s1">__bool__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return False</span>

    <span class="s1">__nonzero__ </span><span class="s2">= </span><span class="s1">__bool__ </span><span class="s5"># Python 2</span>

    <span class="s4">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s3">&quot;Undefined&quot;</span>

<span class="s5"># In fact, we normally always return this precise instance of the</span>
<span class="s5"># UndefinedObject.</span>
<span class="s1">Undefined </span><span class="s2">= </span><span class="s1">UndefinedObject</span><span class="s2">()</span>

<span class="s4">class </span><span class="s1">ConcreteStruct</span><span class="s2">:</span>
    <span class="s0">&quot;&quot;&quot; Python objects that inherit from this class are passed to 
    JavaScript as a concrete struct: a mapping from string -&gt; value, 
    with no methods, passed by value.  This can be more optimal than 
    traditional Python objects which are passed by reference, 
    especially for small objects which might be repeatedly referenced 
    on the JavaScript side. &quot;&quot;&quot;</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">getConcreteProperties</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Returns a list of 2-tuples of the (key, value) pairs that 
        are to be passed to the concrete instance.  By default, this 
        returns all properties of the object.  You can override this 
        to restrict the set of properties that are uploaded. &quot;&quot;&quot;</span>

        <span class="s4">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>

<span class="s4">class </span><span class="s1">BrowserObject</span><span class="s2">:</span>
    <span class="s0">&quot;&quot;&quot; This class provides the Python wrapper around some object that 
    actually exists in the plugin host's namespace, e.g. a JavaScript 
    or DOM object. &quot;&quot;&quot;</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">runner</span><span class="s2">, </span><span class="s1">objectId</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">[</span><span class="s3">'_BrowserObject__runner'</span><span class="s2">] = </span><span class="s1">runner</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">[</span><span class="s3">'_BrowserObject__objectId'</span><span class="s2">] = </span><span class="s1">objectId</span>

        <span class="s5"># This element is filled in by __getattr__; it connects</span>
        <span class="s5"># the object to its parent.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">[</span><span class="s3">'_BrowserObject__childObject'</span><span class="s2">] = (</span><span class="s4">None</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>

        <span class="s5"># This is a cache of method names to MethodWrapper objects in</span>
        <span class="s5"># the parent object.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">[</span><span class="s3">'_BrowserObject__methods'</span><span class="s2">] = {}</span>

    <span class="s4">def </span><span class="s1">__del__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># When the BrowserObject destructs, tell the parent process it</span>
        <span class="s5"># doesn't need to keep around its corresponding P3D_object any</span>
        <span class="s5"># more.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">dropObject</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__objectId</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__cacheMethod</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">methodName</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Stores a pointer to the named method on this object, so 
        that the next time __getattr__ is called, it can retrieve the 
        method wrapper without having to query the browser.  This 
        cache assumes that callable methods don't generally come and 
        go on and object. 
 
        The return value is the MethodWrapper object. &quot;&quot;&quot;</span>

        <span class="s1">method </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__methods</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">methodName</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">method </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">method </span><span class="s2">= </span><span class="s1">MethodWrapper</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">methodName</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__methods</span><span class="s2">[</span><span class="s1">methodName</span><span class="s2">] = </span><span class="s1">method</span>
        <span class="s4">return </span><span class="s1">method</span>

    <span class="s4">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">toString</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">__bool__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return True</span>

    <span class="s1">__nonzero__ </span><span class="s2">= </span><span class="s1">__bool__ </span><span class="s5"># Python 2</span>

    <span class="s4">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
        <span class="s1">needsResponse </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s4">if </span><span class="s3">'needsResponse' </span><span class="s4">in </span><span class="s1">kw</span><span class="s2">:</span>
            <span class="s1">needsResponse </span><span class="s2">= </span><span class="s1">kw</span><span class="s2">[</span><span class="s3">'needsResponse'</span><span class="s2">]</span>
            <span class="s4">del </span><span class="s1">kw</span><span class="s2">[</span><span class="s3">'needsResponse'</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">kw</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ArgumentError</span><span class="s2">(</span><span class="s3">'Keyword arguments not supported'</span><span class="s2">)</span>

        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">parentObj</span><span class="s2">, </span><span class="s1">attribName </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__childObject</span>
            <span class="s4">if </span><span class="s1">parentObj</span><span class="s2">:</span>
                <span class="s5"># Call it as a method.</span>
                <span class="s4">if </span><span class="s1">parentObj </span><span class="s4">is </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">dom </span><span class="s4">and </span><span class="s1">attribName </span><span class="s2">== </span><span class="s3">'alert'</span><span class="s2">:</span>
                    <span class="s5"># As a special hack, we don't wait for the return</span>
                    <span class="s5"># value from the alert() call, since this is a</span>
                    <span class="s5"># blocking call, and waiting for this could cause</span>
                    <span class="s5"># problems.</span>
                    <span class="s1">needsResponse </span><span class="s2">= </span><span class="s4">False</span>

                <span class="s4">if </span><span class="s1">parentObj </span><span class="s4">is </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">dom </span><span class="s4">and </span><span class="s1">attribName </span><span class="s2">== </span><span class="s3">'eval' </span><span class="s4">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) == </span><span class="s6">1 </span><span class="s4">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">str</span><span class="s2">):</span>
                    <span class="s5"># As another special hack, we make dom.eval() a</span>
                    <span class="s5"># special case, and map it directly into an eval()</span>
                    <span class="s5"># call.  If the string begins with 'void ', we further</span>
                    <span class="s5"># assume we're not waiting for a response.</span>
                    <span class="s4">if </span><span class="s1">args</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'void '</span><span class="s2">):</span>
                        <span class="s1">needsResponse </span><span class="s2">= </span><span class="s4">False</span>
                    <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">scriptRequest</span><span class="s2">(</span><span class="s3">'eval'</span><span class="s2">, </span><span class="s1">parentObj</span><span class="s2">, </span><span class="s1">value </span><span class="s2">= </span><span class="s1">args</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">needsResponse </span><span class="s2">= </span><span class="s1">needsResponse</span><span class="s2">)</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s5"># This is a normal method call.</span>
                    <span class="s4">try</span><span class="s2">:</span>
                        <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">scriptRequest</span><span class="s2">(</span><span class="s3">'call'</span><span class="s2">, </span><span class="s1">parentObj</span><span class="s2">, </span><span class="s1">propertyName </span><span class="s2">= </span><span class="s1">attribName</span><span class="s2">, </span><span class="s1">value </span><span class="s2">= </span><span class="s1">args</span><span class="s2">, </span><span class="s1">needsResponse </span><span class="s2">= </span><span class="s1">needsResponse</span><span class="s2">)</span>
                    <span class="s4">except </span><span class="s1">EnvironmentError</span><span class="s2">:</span>
                        <span class="s5"># Problem on the call.  Maybe no such method?</span>
                        <span class="s4">raise </span><span class="s1">AttributeError</span>

                <span class="s5"># Hey, the method call appears to have succeeded.</span>
                <span class="s5"># Cache the method object on the parent so we won't</span>
                <span class="s5"># have to look up the method wrapper again next time.</span>
                <span class="s1">parentObj</span><span class="s2">.</span><span class="s1">__cacheMethod</span><span class="s2">(</span><span class="s1">attribName</span><span class="s2">)</span>

            <span class="s4">else</span><span class="s2">:</span>
                <span class="s5"># Call it as a plain function.</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">scriptRequest</span><span class="s2">(</span><span class="s3">'call'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">value </span><span class="s2">= </span><span class="s1">args</span><span class="s2">, </span><span class="s1">needsResponse </span><span class="s2">= </span><span class="s1">needsResponse</span><span class="s2">)</span>
        <span class="s4">except </span><span class="s1">EnvironmentError</span><span class="s2">:</span>
            <span class="s5"># Some odd problem on the call.</span>
            <span class="s4">raise </span><span class="s1">TypeError</span>

        <span class="s4">return </span><span class="s1">result</span>

    <span class="s4">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Remaps attempts to query an attribute, as in obj.attr, 
        into the appropriate calls to query the actual browser object 
        under the hood.  &quot;&quot;&quot;</span>

        <span class="s5"># First check to see if there's a cached method wrapper from a</span>
        <span class="s5"># previous call.</span>
        <span class="s1">method </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__methods</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">method</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">method</span>

        <span class="s5"># No cache.  Go query the browser for the desired value.</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">scriptRequest</span><span class="s2">(</span><span class="s3">'get_property'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                                                <span class="s1">propertyName </span><span class="s2">= </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s4">except </span><span class="s1">EnvironmentError</span><span class="s2">:</span>
            <span class="s5"># Failed to retrieve the attribute.  But maybe there's a</span>
            <span class="s5"># method instead?</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">scriptRequest</span><span class="s2">(</span><span class="s3">'has_method'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">propertyName </span><span class="s2">= </span><span class="s1">name</span><span class="s2">):</span>
                <span class="s5"># Yes, so create a method wrapper for it.</span>
                <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__cacheMethod</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

            <span class="s4">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">BrowserObject</span><span class="s2">):</span>
            <span class="s5"># Fill in the parent object association, so __call__ can</span>
            <span class="s5"># properly call a method.  (Javascript needs to know the</span>
            <span class="s5"># method container at the time of the call, and doesn't</span>
            <span class="s5"># store it on the function object.)</span>
            <span class="s1">value</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">[</span><span class="s3">'_BrowserObject__childObject'</span><span class="s2">] = (</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>

        <span class="s4">return </span><span class="s1">value</span>

    <span class="s4">def </span><span class="s1">__setattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">name </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">value</span>
            <span class="s4">return</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">scriptRequest</span><span class="s2">(</span><span class="s3">'set_property'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                                             <span class="s1">propertyName </span><span class="s2">= </span><span class="s1">name</span><span class="s2">,</span>
                                             <span class="s1">value </span><span class="s2">= </span><span class="s1">value</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">result</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__delattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">name </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">:</span>
            <span class="s4">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">[</span><span class="s1">name</span><span class="s2">]</span>
            <span class="s4">return</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">scriptRequest</span><span class="s2">(</span><span class="s3">'del_property'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                                             <span class="s1">propertyName </span><span class="s2">= </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">result</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Remaps attempts to query an attribute, as in obj['attr'], 
        into the appropriate calls to query the actual browser object 
        under the hood.  Following the JavaScript convention, we treat 
        obj['attr'] almost the same as obj.attr. &quot;&quot;&quot;</span>

        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">scriptRequest</span><span class="s2">(</span><span class="s3">'get_property'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                                                <span class="s1">propertyName </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">key</span><span class="s2">))</span>
        <span class="s4">except </span><span class="s1">EnvironmentError</span><span class="s2">:</span>
            <span class="s5"># Failed to retrieve the property.  We return IndexError</span>
            <span class="s5"># for numeric keys so we can properly support Python's</span>
            <span class="s5"># iterators, but we return KeyError for string keys to</span>
            <span class="s5"># emulate mapping objects.</span>
            <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
                <span class="s4">raise </span><span class="s1">KeyError</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s4">raise </span><span class="s1">IndexError</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>

        <span class="s4">return </span><span class="s1">value</span>

    <span class="s4">def </span><span class="s1">__setitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">scriptRequest</span><span class="s2">(</span><span class="s3">'set_property'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                                             <span class="s1">propertyName </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">key</span><span class="s2">),</span>
                                             <span class="s1">value </span><span class="s2">= </span><span class="s1">value</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">result</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
                <span class="s4">raise </span><span class="s1">KeyError</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s4">raise </span><span class="s1">IndexError</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__delitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">scriptRequest</span><span class="s2">(</span><span class="s3">'del_property'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                                             <span class="s1">propertyName </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">key</span><span class="s2">))</span>
        <span class="s4">if not </span><span class="s1">result</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
                <span class="s4">raise </span><span class="s1">KeyError</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s4">raise </span><span class="s1">IndexError</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>

<span class="s4">class </span><span class="s1">MethodWrapper</span><span class="s2">:</span>
    <span class="s0">&quot;&quot;&quot; This is a Python wrapper around a property of a BrowserObject 
    that doesn't appear to be a first-class object in the Python 
    sense, but is nonetheless a callable method. &quot;&quot;&quot;</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">runner</span><span class="s2">, </span><span class="s1">parentObj</span><span class="s2">, </span><span class="s1">objectId</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">[</span><span class="s3">'_MethodWrapper__runner'</span><span class="s2">] = </span><span class="s1">runner</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">[</span><span class="s3">'_MethodWrapper__childObject'</span><span class="s2">] = (</span><span class="s1">parentObj</span><span class="s2">, </span><span class="s1">objectId</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">parentObj</span><span class="s2">, </span><span class="s1">attribName </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__childObject</span>
        <span class="s4">return </span><span class="s3">&quot;%s.%s&quot; </span><span class="s2">% (</span><span class="s1">parentObj</span><span class="s2">, </span><span class="s1">attribName</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__bool__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return True</span>

    <span class="s1">__nonzero__ </span><span class="s2">= </span><span class="s1">__bool__ </span><span class="s5"># Python 2</span>

    <span class="s4">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
        <span class="s1">needsResponse </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s4">if </span><span class="s3">'needsResponse' </span><span class="s4">in </span><span class="s1">kw</span><span class="s2">:</span>
            <span class="s1">needsResponse </span><span class="s2">= </span><span class="s1">kw</span><span class="s2">[</span><span class="s3">'needsResponse'</span><span class="s2">]</span>
            <span class="s4">del </span><span class="s1">kw</span><span class="s2">[</span><span class="s3">'needsResponse'</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">kw</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ArgumentError</span><span class="s2">(</span><span class="s3">'Keyword arguments not supported'</span><span class="s2">)</span>

        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">parentObj</span><span class="s2">, </span><span class="s1">attribName </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__childObject</span>
            <span class="s5"># Call it as a method.</span>
            <span class="s4">if </span><span class="s1">parentObj </span><span class="s4">is </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">dom </span><span class="s4">and </span><span class="s1">attribName </span><span class="s2">== </span><span class="s3">'alert'</span><span class="s2">:</span>
                <span class="s5"># As a special hack, we don't wait for the return</span>
                <span class="s5"># value from the alert() call, since this is a</span>
                <span class="s5"># blocking call, and waiting for this could cause</span>
                <span class="s5"># problems.</span>
                <span class="s1">needsResponse </span><span class="s2">= </span><span class="s4">False</span>

            <span class="s4">if </span><span class="s1">parentObj </span><span class="s4">is </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">dom </span><span class="s4">and </span><span class="s1">attribName </span><span class="s2">== </span><span class="s3">'eval' </span><span class="s4">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) == </span><span class="s6">1 </span><span class="s4">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">str</span><span class="s2">):</span>
                <span class="s5"># As another special hack, we make dom.eval() a</span>
                <span class="s5"># special case, and map it directly into an eval()</span>
                <span class="s5"># call.  If the string begins with 'void ', we further</span>
                <span class="s5"># assume we're not waiting for a response.</span>
                <span class="s4">if </span><span class="s1">args</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'void '</span><span class="s2">):</span>
                    <span class="s1">needsResponse </span><span class="s2">= </span><span class="s4">False</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">scriptRequest</span><span class="s2">(</span><span class="s3">'eval'</span><span class="s2">, </span><span class="s1">parentObj</span><span class="s2">, </span><span class="s1">value </span><span class="s2">= </span><span class="s1">args</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">needsResponse </span><span class="s2">= </span><span class="s1">needsResponse</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s5"># This is a normal method call.</span>
                <span class="s4">try</span><span class="s2">:</span>
                    <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__runner</span><span class="s2">.</span><span class="s1">scriptRequest</span><span class="s2">(</span><span class="s3">'call'</span><span class="s2">, </span><span class="s1">parentObj</span><span class="s2">, </span><span class="s1">propertyName </span><span class="s2">= </span><span class="s1">attribName</span><span class="s2">, </span><span class="s1">value </span><span class="s2">= </span><span class="s1">args</span><span class="s2">, </span><span class="s1">needsResponse </span><span class="s2">= </span><span class="s1">needsResponse</span><span class="s2">)</span>
                <span class="s4">except </span><span class="s1">EnvironmentError</span><span class="s2">:</span>
                    <span class="s5"># Problem on the call.  Maybe no such method?</span>
                    <span class="s4">raise </span><span class="s1">AttributeError</span>

        <span class="s4">except </span><span class="s1">EnvironmentError</span><span class="s2">:</span>
            <span class="s5"># Some odd problem on the call.</span>
            <span class="s4">raise </span><span class="s1">TypeError</span>

        <span class="s4">return </span><span class="s1">result</span>

    <span class="s4">def </span><span class="s1">__setattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; setattr will generally fail on method objects. &quot;&quot;&quot;</span>
        <span class="s4">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__delattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; delattr will generally fail on method objects. &quot;&quot;&quot;</span>
        <span class="s4">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
</pre>
</body>
</html>