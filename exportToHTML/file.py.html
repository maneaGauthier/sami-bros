<html>
<head>
<title>file.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
file.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; This module reimplements Python's file I/O mechanisms using Panda 
constructs.  This enables Python to interface more easily with Panda's 
virtual file system, and it also better-supports Panda's 
SIMPLE_THREADS model, by avoiding blocking all threads while waiting 
for I/O to complete. &quot;&quot;&quot;</span>

<span class="s1">__all__ </span><span class="s2">= [</span>
    <span class="s3">'open'</span><span class="s2">, </span><span class="s3">'listdir'</span><span class="s2">, </span><span class="s3">'walk'</span><span class="s2">, </span><span class="s3">'join'</span><span class="s2">,</span>
    <span class="s3">'isfile'</span><span class="s2">, </span><span class="s3">'isdir'</span><span class="s2">, </span><span class="s3">'exists'</span><span class="s2">, </span><span class="s3">'lexists'</span><span class="s2">, </span><span class="s3">'getmtime'</span><span class="s2">, </span><span class="s3">'getsize'</span><span class="s2">,</span>
    <span class="s3">'execfile'</span><span class="s2">,</span>
    <span class="s2">]</span>

<span class="s4">from </span><span class="s1">panda3d </span><span class="s4">import </span><span class="s1">core</span>
<span class="s4">import </span><span class="s1">sys</span>
<span class="s4">import </span><span class="s1">os</span>
<span class="s4">import </span><span class="s1">io</span>
<span class="s4">import </span><span class="s1">encodings</span>
<span class="s4">from </span><span class="s1">posixpath </span><span class="s4">import </span><span class="s1">join</span>

<span class="s1">_vfs </span><span class="s2">= </span><span class="s1">core</span><span class="s2">.</span><span class="s1">VirtualFileSystem</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>

<span class="s4">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&lt; (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">):</span>
    <span class="s6"># Python 3 defines these subtypes of IOError, but Python 2 doesn't.</span>
    <span class="s1">FileNotFoundError </span><span class="s2">= </span><span class="s1">IOError</span>
    <span class="s1">IsADirectoryError </span><span class="s2">= </span><span class="s1">IOError</span>
    <span class="s1">FileExistsError </span><span class="s2">= </span><span class="s1">IOError</span>
    <span class="s1">PermissionError </span><span class="s2">= </span><span class="s1">IOError</span>

    <span class="s1">unicodeType </span><span class="s2">= </span><span class="s1">unicode</span>
    <span class="s1">strType </span><span class="s2">= </span><span class="s1">str</span>
<span class="s4">else</span><span class="s2">:</span>
    <span class="s1">unicodeType </span><span class="s2">= </span><span class="s1">str</span>
    <span class="s1">strType </span><span class="s2">= ()</span>


<span class="s4">def </span><span class="s1">open</span><span class="s2">(</span><span class="s1">file</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s3">'r'</span><span class="s2">, </span><span class="s1">buffering</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">newline</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">closefd</span><span class="s2">=</span><span class="s4">True</span><span class="s2">):</span>
    <span class="s0">&quot;&quot;&quot;This function emulates the built-in Python open() function, additionally 
    providing support for Panda's virtual file system.  It takes the same 
    arguments as Python's built-in open() function. 
    &quot;&quot;&quot;</span>

    <span class="s4">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">):</span>
        <span class="s6"># Python 3 is much stricter than Python 2, which lets</span>
        <span class="s6"># unknown flags fall through.</span>
        <span class="s4">for </span><span class="s1">ch </span><span class="s4">in </span><span class="s1">mode</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">ch </span><span class="s4">not in </span><span class="s3">'rwxabt+U'</span><span class="s2">:</span>
                <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;invalid mode: '%s'&quot; </span><span class="s2">% (</span><span class="s1">mode</span><span class="s2">))</span>

    <span class="s1">creating </span><span class="s2">= </span><span class="s3">'x' </span><span class="s4">in </span><span class="s1">mode</span>
    <span class="s1">writing </span><span class="s2">= </span><span class="s3">'w' </span><span class="s4">in </span><span class="s1">mode</span>
    <span class="s1">appending </span><span class="s2">= </span><span class="s3">'a' </span><span class="s4">in </span><span class="s1">mode</span>
    <span class="s1">updating </span><span class="s2">= </span><span class="s3">'+' </span><span class="s4">in </span><span class="s1">mode</span>
    <span class="s1">binary </span><span class="s2">= </span><span class="s3">'b' </span><span class="s4">in </span><span class="s1">mode</span>
    <span class="s1">universal </span><span class="s2">= </span><span class="s3">'U' </span><span class="s4">in </span><span class="s1">mode</span>
    <span class="s1">reading </span><span class="s2">= </span><span class="s1">universal </span><span class="s4">or </span><span class="s3">'r' </span><span class="s4">in </span><span class="s1">mode</span>

    <span class="s4">if </span><span class="s1">binary </span><span class="s4">and </span><span class="s3">'t' </span><span class="s4">in </span><span class="s1">mode</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;can't have text and binary mode at once&quot;</span><span class="s2">)</span>

    <span class="s4">if </span><span class="s1">creating </span><span class="s2">+ </span><span class="s1">reading </span><span class="s2">+ </span><span class="s1">writing </span><span class="s2">+ </span><span class="s1">appending </span><span class="s2">&gt; </span><span class="s5">1</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;must have exactly one of create/read/write/append mode&quot;</span><span class="s2">)</span>

    <span class="s4">if </span><span class="s1">binary</span><span class="s2">:</span>
        <span class="s4">if </span><span class="s1">encoding</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;binary mode doesn't take an encoding argument&quot;</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">errors</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;binary mode doesn't take an errors argument&quot;</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">newline</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;binary mode doesn't take a newline argument&quot;</span><span class="s2">)</span>

    <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">file</span><span class="s2">, </span><span class="s1">core</span><span class="s2">.</span><span class="s1">Istream</span><span class="s2">) </span><span class="s4">or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">file</span><span class="s2">, </span><span class="s1">core</span><span class="s2">.</span><span class="s1">Ostream</span><span class="s2">):</span>
        <span class="s6"># If we were given a stream instead of a filename, assign</span>
        <span class="s6"># it directly.</span>
        <span class="s1">raw </span><span class="s2">= </span><span class="s1">StreamIOWrapper</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>
        <span class="s1">raw</span><span class="s2">.</span><span class="s1">mode </span><span class="s2">= </span><span class="s1">mode</span>

    <span class="s4">else</span><span class="s2">:</span>
        <span class="s1">vfile </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">file</span><span class="s2">, </span><span class="s1">core</span><span class="s2">.</span><span class="s1">VirtualFile</span><span class="s2">):</span>
            <span class="s6"># We can also &quot;open&quot; a VirtualFile object for reading.</span>
            <span class="s1">vfile </span><span class="s2">= </span><span class="s1">file</span>
            <span class="s1">filename </span><span class="s2">= </span><span class="s1">vfile</span><span class="s2">.</span><span class="s1">getFilename</span><span class="s2">()</span>
        <span class="s4">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">file</span><span class="s2">, </span><span class="s1">unicodeType</span><span class="s2">):</span>
            <span class="s6"># If a raw string is given, assume it's an os-specific</span>
            <span class="s6"># filename.</span>
            <span class="s1">filename </span><span class="s2">= </span><span class="s1">core</span><span class="s2">.</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecificW</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>
        <span class="s4">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">file</span><span class="s2">, </span><span class="s1">strType</span><span class="s2">):</span>
            <span class="s1">filename </span><span class="s2">= </span><span class="s1">core</span><span class="s2">.</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s6"># It's either a Filename object or an os.PathLike.</span>
            <span class="s6"># If a Filename is given, make a writable copy anyway.</span>
            <span class="s1">filename </span><span class="s2">= </span><span class="s1">core</span><span class="s2">.</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">binary </span><span class="s4">or </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">):</span>
            <span class="s1">filename</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">filename</span><span class="s2">.</span><span class="s1">setText</span><span class="s2">()</span>

        <span class="s4">if not </span><span class="s1">vfile</span><span class="s2">:</span>
            <span class="s1">vfile </span><span class="s2">= </span><span class="s1">_vfs</span><span class="s2">.</span><span class="s1">getFile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>

        <span class="s4">if not </span><span class="s1">vfile</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">reading</span><span class="s2">:</span>
                <span class="s4">raise </span><span class="s1">FileNotFoundError</span><span class="s2">(</span><span class="s3">&quot;No such file or directory: '%s'&quot; </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">))</span>

            <span class="s1">vfile </span><span class="s2">= </span><span class="s1">_vfs</span><span class="s2">.</span><span class="s1">createFile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
            <span class="s4">if not </span><span class="s1">vfile</span><span class="s2">:</span>
                <span class="s4">raise </span><span class="s1">IOError</span><span class="s2">(</span><span class="s3">&quot;Failed to create file: '%s'&quot; </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">))</span>

        <span class="s4">elif </span><span class="s1">creating</span><span class="s2">:</span>
            <span class="s6"># In 'creating' mode, we have to raise FileExistsError</span>
            <span class="s6"># if the file already exists.  Otherwise, it's the same</span>
            <span class="s6"># as 'writing' mode.</span>
            <span class="s4">raise </span><span class="s1">FileExistsError</span><span class="s2">(</span><span class="s3">&quot;File exists: '%s'&quot; </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">))</span>

        <span class="s4">elif </span><span class="s1">vfile</span><span class="s2">.</span><span class="s1">isDirectory</span><span class="s2">():</span>
            <span class="s4">raise </span><span class="s1">IsADirectoryError</span><span class="s2">(</span><span class="s3">&quot;Is a directory: '%s'&quot; </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">))</span>

        <span class="s6"># Actually open the streams.</span>
        <span class="s4">if </span><span class="s1">reading</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">updating</span><span class="s2">:</span>
                <span class="s1">stream </span><span class="s2">= </span><span class="s1">vfile</span><span class="s2">.</span><span class="s1">openReadWriteFile</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">stream </span><span class="s2">= </span><span class="s1">vfile</span><span class="s2">.</span><span class="s1">openReadFile</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>

            <span class="s4">if not </span><span class="s1">stream</span><span class="s2">:</span>
                <span class="s4">raise </span><span class="s1">IOError</span><span class="s2">(</span><span class="s3">&quot;Could not open %s for reading&quot; </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">))</span>

        <span class="s4">elif </span><span class="s1">writing </span><span class="s4">or </span><span class="s1">creating</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">updating</span><span class="s2">:</span>
                <span class="s1">stream </span><span class="s2">= </span><span class="s1">vfile</span><span class="s2">.</span><span class="s1">openReadWriteFile</span><span class="s2">(</span><span class="s4">True</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">stream </span><span class="s2">= </span><span class="s1">vfile</span><span class="s2">.</span><span class="s1">openWriteFile</span><span class="s2">(</span><span class="s4">False</span><span class="s2">, </span><span class="s4">True</span><span class="s2">)</span>

            <span class="s4">if not </span><span class="s1">stream</span><span class="s2">:</span>
                <span class="s4">raise </span><span class="s1">IOError</span><span class="s2">(</span><span class="s3">&quot;Could not open %s for writing&quot; </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">))</span>

        <span class="s4">elif </span><span class="s1">appending</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">updating</span><span class="s2">:</span>
                <span class="s1">stream </span><span class="s2">= </span><span class="s1">vfile</span><span class="s2">.</span><span class="s1">openReadAppendFile</span><span class="s2">()</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">stream </span><span class="s2">= </span><span class="s1">vfile</span><span class="s2">.</span><span class="s1">openAppendFile</span><span class="s2">()</span>

            <span class="s4">if not </span><span class="s1">stream</span><span class="s2">:</span>
                <span class="s4">raise </span><span class="s1">IOError</span><span class="s2">(</span><span class="s3">&quot;Could not open %s for appending&quot; </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">))</span>

        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;Must have exactly one of create/read/write/append mode and at most one plus&quot;</span><span class="s2">)</span>

        <span class="s1">raw </span><span class="s2">= </span><span class="s1">StreamIOWrapper</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">, </span><span class="s1">needsVfsClose</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
        <span class="s1">raw</span><span class="s2">.</span><span class="s1">mode </span><span class="s2">= </span><span class="s1">mode</span>
        <span class="s1">raw</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">vfile</span><span class="s2">.</span><span class="s1">getFilename</span><span class="s2">().</span><span class="s1">toOsSpecific</span><span class="s2">()</span>

    <span class="s6"># If a binary stream was requested, return the stream we've created.</span>
    <span class="s4">if </span><span class="s1">binary</span><span class="s2">:</span>
        <span class="s4">return </span><span class="s1">raw</span>

    <span class="s6"># If we're in Python 2, we don't decode unicode strings by default.</span>
    <span class="s4">if not </span><span class="s1">encoding </span><span class="s4">and </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&lt; (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">raw</span>

    <span class="s1">line_buffering </span><span class="s2">= </span><span class="s4">False</span>
    <span class="s4">if </span><span class="s1">buffering </span><span class="s2">== </span><span class="s5">1</span><span class="s2">:</span>
        <span class="s1">line_buffering </span><span class="s2">= </span><span class="s4">True</span>
    <span class="s4">elif </span><span class="s1">buffering </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;can't have unbuffered text I/O&quot;</span><span class="s2">)</span>

    <span class="s6"># Otherwise, create a TextIOWrapper object to wrap it.</span>
    <span class="s1">wrapper </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">TextIOWrapper</span><span class="s2">(</span><span class="s1">raw</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">, </span><span class="s1">newline</span><span class="s2">, </span><span class="s1">line_buffering</span><span class="s2">)</span>
    <span class="s1">wrapper</span><span class="s2">.</span><span class="s1">mode </span><span class="s2">= </span><span class="s1">mode</span>
    <span class="s4">return </span><span class="s1">wrapper</span>


<span class="s4">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&lt; (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">):</span>
    <span class="s6"># Python 2 had an alias for open() called file().</span>
    <span class="s1">__all__</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'file'</span><span class="s2">)</span>
    <span class="s1">file </span><span class="s2">= </span><span class="s1">open</span>


<span class="s4">class </span><span class="s1">StreamIOWrapper</span><span class="s2">(</span><span class="s1">io</span><span class="s2">.</span><span class="s1">IOBase</span><span class="s2">):</span>
    <span class="s0">&quot;&quot;&quot; This is a file-like object that wraps around a C++ istream and/or 
    ostream object.  It only deals with binary data; to work with text I/O, 
    create an io.TextIOWrapper object around this, or use the open() 
    function that is also provided with this module. &quot;&quot;&quot;</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">, </span><span class="s1">needsVfsClose</span><span class="s2">=</span><span class="s4">False</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__stream </span><span class="s2">= </span><span class="s1">stream</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__needsVfsClose </span><span class="s2">= </span><span class="s1">needsVfsClose</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__reader </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__writer </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__lastWrite </span><span class="s2">= </span><span class="s4">False</span>

        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">, </span><span class="s1">core</span><span class="s2">.</span><span class="s1">Istream</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__reader </span><span class="s2">= </span><span class="s1">core</span><span class="s2">.</span><span class="s1">StreamReader</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">, </span><span class="s4">False</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">, </span><span class="s1">core</span><span class="s2">.</span><span class="s1">Ostream</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__writer </span><span class="s2">= </span><span class="s1">core</span><span class="s2">.</span><span class="s1">StreamWriter</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">, </span><span class="s4">False</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__lastWrite </span><span class="s2">= </span><span class="s4">True</span>
            <span class="s4">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">):</span>
                <span class="s6"># In Python 3, we use appendData, which only accepts bytes.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__write </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__writer</span><span class="s2">.</span><span class="s1">appendData</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s6"># In Python 2.7, we also accept unicode objects, which are</span>
                <span class="s6"># implicitly converted to C++ strings.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__write </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__writer</span><span class="s2">.</span><span class="s1">write</span>

    <span class="s4">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s3">&quot;&lt;direct.stdpy.file.StreamIOWrapper&quot;</span>
        <span class="s4">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'name'</span><span class="s2">):</span>
            <span class="s1">s </span><span class="s2">+= </span><span class="s3">&quot; name='%s'&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'mode'</span><span class="s2">):</span>
            <span class="s1">s </span><span class="s2">+= </span><span class="s3">&quot; mode='%s'&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mode</span><span class="s2">)</span>
        <span class="s1">s </span><span class="s2">+= </span><span class="s3">&quot;&gt;&quot;</span>
        <span class="s4">return </span><span class="s1">s</span>

    <span class="s4">def </span><span class="s1">readable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__reader </span><span class="s4">is not None</span>

    <span class="s4">def </span><span class="s1">writable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__writer </span><span class="s4">is not None</span>

    <span class="s4">def </span><span class="s1">close</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__needsVfsClose</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__reader </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__writer</span><span class="s2">:</span>
                <span class="s1">_vfs</span><span class="s2">.</span><span class="s1">closeReadWriteFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__stream</span><span class="s2">)</span>
            <span class="s4">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__reader</span><span class="s2">:</span>
                <span class="s1">_vfs</span><span class="s2">.</span><span class="s1">closeReadFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__stream</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:  </span><span class="s6"># self.__writer:</span>
                <span class="s1">_vfs</span><span class="s2">.</span><span class="s1">closeWriteFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__stream</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">__needsVfsClose </span><span class="s2">= </span><span class="s4">False</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__stream </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__reader </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__writer </span><span class="s2">= </span><span class="s4">None</span>

    <span class="s4">def </span><span class="s1">flush</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__writer</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__stream</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()  </span><span class="s6"># clear eof flag</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__stream</span><span class="s2">.</span><span class="s1">flush</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__reader</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__writer</span><span class="s2">:</span>
                <span class="s6"># The stream is not even open at all.</span>
                <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;I/O operation on closed file&quot;</span><span class="s2">)</span>

            <span class="s6"># The stream is open only in write mode.</span>
            <span class="s4">raise </span><span class="s1">IOError</span><span class="s2">(</span><span class="s3">&quot;Attempt to read from write-only stream&quot;</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__stream</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()  </span><span class="s6"># clear eof flag</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__lastWrite </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s4">if </span><span class="s1">size </span><span class="s4">is not None and </span><span class="s1">size </span><span class="s2">&gt;= </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__reader</span><span class="s2">.</span><span class="s1">extractBytes</span><span class="s2">(</span><span class="s1">size</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s6"># Read to end-of-file.</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">()</span>
            <span class="s4">while not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__stream</span><span class="s2">.</span><span class="s1">eof</span><span class="s2">():</span>
                <span class="s1">result </span><span class="s2">+= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__reader</span><span class="s2">.</span><span class="s1">extractBytes</span><span class="s2">(</span><span class="s5">4096</span><span class="s2">)</span>
            <span class="s4">return </span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">result</span><span class="s2">)</span>

    <span class="s1">read1 </span><span class="s2">= </span><span class="s1">read</span>

    <span class="s4">def </span><span class="s1">readline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__reader</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__writer</span><span class="s2">:</span>
                <span class="s6"># The stream is not even open at all.</span>
                <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;I/O operation on closed file&quot;</span><span class="s2">)</span>

            <span class="s6"># The stream is open only in write mode.</span>
            <span class="s4">raise </span><span class="s1">IOError</span><span class="s2">(</span><span class="s3">&quot;Attempt to read from write-only stream&quot;</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__stream</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()  </span><span class="s6"># clear eof flag</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__lastWrite </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__reader</span><span class="s2">.</span><span class="s1">readline</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">seek</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">whence </span><span class="s2">= </span><span class="s5">0</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__stream</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__stream</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()  </span><span class="s6"># clear eof flag</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__reader</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__stream</span><span class="s2">.</span><span class="s1">seekg</span><span class="s2">(</span><span class="s1">offset</span><span class="s2">, </span><span class="s1">whence</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__writer</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__stream</span><span class="s2">.</span><span class="s1">seekp</span><span class="s2">(</span><span class="s1">offset</span><span class="s2">, </span><span class="s1">whence</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">tell</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__lastWrite</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__writer</span><span class="s2">:</span>
                <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__stream</span><span class="s2">.</span><span class="s1">tellp</span><span class="s2">()</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__reader</span><span class="s2">:</span>
                <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__stream</span><span class="s2">.</span><span class="s1">tellg</span><span class="s2">()</span>
        <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;I/O operation on closed file&quot;</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__writer</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__reader</span><span class="s2">:</span>
                <span class="s6"># The stream is not even open at all.</span>
                <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;I/O operation on closed file&quot;</span><span class="s2">)</span>

            <span class="s6"># The stream is open only in read mode.</span>
            <span class="s4">raise </span><span class="s1">IOError</span><span class="s2">(</span><span class="s3">&quot;Attempt to write to read-only stream&quot;</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__stream</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()  </span><span class="s6"># clear eof flag</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__write</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__lastWrite </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s4">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">writelines</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lines</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__writer</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__reader</span><span class="s2">:</span>
                <span class="s6"># The stream is not even open at all.</span>
                <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;I/O operation on closed file&quot;</span><span class="s2">)</span>

            <span class="s6"># The stream is open only in read mode.</span>
            <span class="s4">raise </span><span class="s1">IOError</span><span class="s2">(</span><span class="s3">&quot;Attempt to write to read-only stream&quot;</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__stream</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()  </span><span class="s6"># clear eof flag</span>
        <span class="s4">for </span><span class="s1">line </span><span class="s4">in </span><span class="s1">lines</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__write</span><span class="s2">(</span><span class="s1">line</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__lastWrite </span><span class="s2">= </span><span class="s4">True</span>


<span class="s4">def </span><span class="s1">listdir</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
    <span class="s0">&quot;&quot;&quot; Implements os.listdir over vfs. &quot;&quot;&quot;</span>
    <span class="s1">files </span><span class="s2">= []</span>
    <span class="s1">dirlist </span><span class="s2">= </span><span class="s1">_vfs</span><span class="s2">.</span><span class="s1">scanDirectory</span><span class="s2">(</span><span class="s1">core</span><span class="s2">.</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">path</span><span class="s2">))</span>
    <span class="s4">if </span><span class="s1">dirlist </span><span class="s4">is None</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">OSError</span><span class="s2">(</span><span class="s3">&quot;No such file or directory: '%s'&quot; </span><span class="s2">% (</span><span class="s1">path</span><span class="s2">))</span>

    <span class="s4">for </span><span class="s1">file </span><span class="s4">in </span><span class="s1">dirlist</span><span class="s2">:</span>
        <span class="s1">files</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">getFilename</span><span class="s2">().</span><span class="s1">getBasename</span><span class="s2">())</span>
    <span class="s4">return </span><span class="s1">files</span>

<span class="s4">def </span><span class="s1">walk</span><span class="s2">(</span><span class="s1">top</span><span class="s2">, </span><span class="s1">topdown </span><span class="s2">= </span><span class="s4">True</span><span class="s2">, </span><span class="s1">onerror </span><span class="s2">= </span><span class="s4">None</span><span class="s2">, </span><span class="s1">followlinks </span><span class="s2">= </span><span class="s4">True</span><span class="s2">):</span>
    <span class="s0">&quot;&quot;&quot; Implements os.walk over vfs. 
 
    Note: we don't support onerror or followlinks; errors are ignored 
    and links are always followed. &quot;&quot;&quot;</span>

    <span class="s1">dirnames </span><span class="s2">= []</span>
    <span class="s1">filenames </span><span class="s2">= []</span>

    <span class="s1">dirlist </span><span class="s2">= </span><span class="s1">_vfs</span><span class="s2">.</span><span class="s1">scanDirectory</span><span class="s2">(</span><span class="s1">top</span><span class="s2">)</span>
    <span class="s4">if </span><span class="s1">dirlist</span><span class="s2">:</span>
        <span class="s4">for </span><span class="s1">file </span><span class="s4">in </span><span class="s1">dirlist</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">isDirectory</span><span class="s2">():</span>
                <span class="s1">dirnames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">getFilename</span><span class="s2">().</span><span class="s1">getBasename</span><span class="s2">())</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">filenames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">getFilename</span><span class="s2">().</span><span class="s1">getBasename</span><span class="s2">())</span>

    <span class="s4">if </span><span class="s1">topdown</span><span class="s2">:</span>
        <span class="s4">yield </span><span class="s2">(</span><span class="s1">top</span><span class="s2">, </span><span class="s1">dirnames</span><span class="s2">, </span><span class="s1">filenames</span><span class="s2">)</span>

    <span class="s4">for </span><span class="s1">dir </span><span class="s4">in </span><span class="s1">dirnames</span><span class="s2">:</span>
        <span class="s1">next </span><span class="s2">= </span><span class="s1">join</span><span class="s2">(</span><span class="s1">top</span><span class="s2">, </span><span class="s1">dir</span><span class="s2">)</span>
        <span class="s4">for </span><span class="s1">tuple </span><span class="s4">in </span><span class="s1">walk</span><span class="s2">(</span><span class="s1">next</span><span class="s2">, </span><span class="s1">topdown </span><span class="s2">= </span><span class="s1">topdown</span><span class="s2">):</span>
            <span class="s4">yield </span><span class="s1">tuple</span>

    <span class="s4">if not </span><span class="s1">topdown</span><span class="s2">:</span>
        <span class="s4">yield </span><span class="s2">(</span><span class="s1">top</span><span class="s2">, </span><span class="s1">dirnames</span><span class="s2">, </span><span class="s1">filenames</span><span class="s2">)</span>

<span class="s4">def </span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
    <span class="s4">return </span><span class="s1">_vfs</span><span class="s2">.</span><span class="s1">isRegularFile</span><span class="s2">(</span><span class="s1">core</span><span class="s2">.</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">path</span><span class="s2">))</span>

<span class="s4">def </span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
    <span class="s4">return </span><span class="s1">_vfs</span><span class="s2">.</span><span class="s1">isDirectory</span><span class="s2">(</span><span class="s1">core</span><span class="s2">.</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">path</span><span class="s2">))</span>

<span class="s4">def </span><span class="s1">exists</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
    <span class="s4">return </span><span class="s1">_vfs</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">core</span><span class="s2">.</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">path</span><span class="s2">))</span>

<span class="s4">def </span><span class="s1">lexists</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
    <span class="s4">return </span><span class="s1">_vfs</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">core</span><span class="s2">.</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">path</span><span class="s2">))</span>

<span class="s4">def </span><span class="s1">getmtime</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
    <span class="s1">file </span><span class="s2">= </span><span class="s1">_vfs</span><span class="s2">.</span><span class="s1">getFile</span><span class="s2">(</span><span class="s1">core</span><span class="s2">.</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">path</span><span class="s2">), </span><span class="s4">True</span><span class="s2">)</span>
    <span class="s4">if not </span><span class="s1">file</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">os</span><span class="s2">.</span><span class="s1">error</span>
    <span class="s4">return </span><span class="s1">file</span><span class="s2">.</span><span class="s1">getTimestamp</span><span class="s2">()</span>

<span class="s4">def </span><span class="s1">getsize</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
    <span class="s1">file </span><span class="s2">= </span><span class="s1">_vfs</span><span class="s2">.</span><span class="s1">getFile</span><span class="s2">(</span><span class="s1">core</span><span class="s2">.</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">path</span><span class="s2">), </span><span class="s4">True</span><span class="s2">)</span>
    <span class="s4">if not </span><span class="s1">file</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">os</span><span class="s2">.</span><span class="s1">error</span>
    <span class="s4">return </span><span class="s1">file</span><span class="s2">.</span><span class="s1">getFileSize</span><span class="s2">()</span>

<span class="s4">def </span><span class="s1">execfile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">globals</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">locals</span><span class="s2">=</span><span class="s4">None</span><span class="s2">):</span>
    <span class="s1">file </span><span class="s2">= </span><span class="s1">_vfs</span><span class="s2">.</span><span class="s1">getFile</span><span class="s2">(</span><span class="s1">core</span><span class="s2">.</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">path</span><span class="s2">), </span><span class="s4">True</span><span class="s2">)</span>
    <span class="s4">if not </span><span class="s1">file</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">os</span><span class="s2">.</span><span class="s1">error</span>

    <span class="s1">data </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">readFile</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
    <span class="s1">exec</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">globals</span><span class="s2">, </span><span class="s1">locals</span><span class="s2">)</span>
</pre>
</body>
</html>