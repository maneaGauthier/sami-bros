<html>
<head>
<title>commands.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
commands.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Extends setuptools with the ``build_apps`` and ``bdist_apps`` commands. 
 
See the :ref:`distribution` section of the programming manual for information 
on how to use these commands. 
&quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">print_function</span>

<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">plistlib</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">subprocess</span>
<span class="s2">import </span><span class="s1">zipfile</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">shutil</span>
<span class="s2">import </span><span class="s1">stat</span>
<span class="s2">import </span><span class="s1">struct</span>
<span class="s2">import </span><span class="s1">imp</span>
<span class="s2">import </span><span class="s1">string</span>
<span class="s2">import </span><span class="s1">time</span>
<span class="s2">import </span><span class="s1">tempfile</span>

<span class="s2">import </span><span class="s1">setuptools</span>
<span class="s2">import </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">log</span>

<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">FreezeTool</span>
<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">pefile</span>
<span class="s2">from </span><span class="s1">direct</span><span class="s3">.</span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">DeploymentTools </span><span class="s2">import </span><span class="s1">Icon</span>
<span class="s2">import </span><span class="s1">panda3d</span><span class="s3">.</span><span class="s1">core </span><span class="s2">as </span><span class="s1">p3d</span>


<span class="s2">if </span><span class="s4">'basestring' </span><span class="s2">not in </span><span class="s1">globals</span><span class="s3">():</span>
    <span class="s1">basestring </span><span class="s3">= </span><span class="s1">str</span>


<span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&lt; (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">0</span><span class="s3">):</span>
    <span class="s6"># Python 3 defines these subtypes of IOError, but Python 2 doesn't.</span>
    <span class="s1">FileNotFoundError </span><span class="s3">= </span><span class="s1">IOError</span>

    <span class="s6"># Warn the user.  They might be using Python 2 by accident.</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;=================================================================&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;WARNING: You are using Python 2, which has reached the end of its&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;WARNING: life as of January 1, 2020.  Please upgrade to Python 3.&quot;</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;=================================================================&quot;</span><span class="s3">)</span>
    <span class="s1">sys</span><span class="s3">.</span><span class="s1">stdout</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>
    <span class="s1">time</span><span class="s3">.</span><span class="s1">sleep</span><span class="s3">(</span><span class="s5">4.0</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_parse_list</span><span class="s3">(</span><span class="s1">input</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">input</span><span class="s3">, </span><span class="s1">basestring</span><span class="s3">):</span>
        <span class="s1">input </span><span class="s3">= </span><span class="s1">input</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">().</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">','</span><span class="s3">, </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">input</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s3">[</span><span class="s1">item</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">() </span><span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">input</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">) </span><span class="s2">if </span><span class="s1">item</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">()]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s3">[]</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">input</span>


<span class="s2">def </span><span class="s1">_parse_dict</span><span class="s3">(</span><span class="s1">input</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">input</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">input</span>
    <span class="s1">d </span><span class="s3">= {}</span>
    <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">_parse_list</span><span class="s3">(</span><span class="s1">input</span><span class="s3">):</span>
        <span class="s1">key</span><span class="s3">, </span><span class="s1">sep</span><span class="s3">, </span><span class="s1">value </span><span class="s3">= </span><span class="s1">item</span><span class="s3">.</span><span class="s1">partition</span><span class="s3">(</span><span class="s4">'='</span><span class="s3">)</span>
        <span class="s1">d</span><span class="s3">[</span><span class="s1">key</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">()] = </span><span class="s1">value</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">()</span>
    <span class="s2">return </span><span class="s1">d</span>


<span class="s2">def </span><span class="s1">_register_python_loaders</span><span class="s3">():</span>
    <span class="s6"># We need this method so that we don't depend on direct.showbase.Loader.</span>
    <span class="s2">if </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">_register_python_loaders</span><span class="s3">, </span><span class="s4">'done'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">return</span>

    <span class="s1">_register_python_loaders</span><span class="s3">.</span><span class="s1">done </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">import </span><span class="s1">pkg_resources</span>
    <span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
        <span class="s2">return</span>

    <span class="s1">registry </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">LoaderFileTypeRegistry</span><span class="s3">.</span><span class="s1">getGlobalPtr</span><span class="s3">()</span>

    <span class="s2">for </span><span class="s1">entry_point </span><span class="s2">in </span><span class="s1">pkg_resources</span><span class="s3">.</span><span class="s1">iter_entry_points</span><span class="s3">(</span><span class="s4">'panda3d.loaders'</span><span class="s3">):</span>
        <span class="s1">registry</span><span class="s3">.</span><span class="s1">register_deferred_type</span><span class="s3">(</span><span class="s1">entry_point</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_model_to_bam</span><span class="s3">(</span><span class="s1">_build_cmd</span><span class="s3">, </span><span class="s1">srcpath</span><span class="s3">, </span><span class="s1">dstpath</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">dstpath</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.gz'</span><span class="s3">) </span><span class="s2">or </span><span class="s1">dstpath</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.pz'</span><span class="s3">):</span>
        <span class="s1">dstpath </span><span class="s3">= </span><span class="s1">dstpath</span><span class="s3">[:-</span><span class="s5">3</span><span class="s3">]</span>
    <span class="s1">dstpath </span><span class="s3">= </span><span class="s1">dstpath </span><span class="s3">+ </span><span class="s4">'.bam'</span>

    <span class="s1">src_fn </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Filename</span><span class="s3">.</span><span class="s1">from_os_specific</span><span class="s3">(</span><span class="s1">srcpath</span><span class="s3">)</span>
    <span class="s1">dst_fn </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Filename</span><span class="s3">.</span><span class="s1">from_os_specific</span><span class="s3">(</span><span class="s1">dstpath</span><span class="s3">)</span>

    <span class="s1">_register_python_loaders</span><span class="s3">()</span>

    <span class="s1">loader </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Loader</span><span class="s3">.</span><span class="s1">get_global_ptr</span><span class="s3">()</span>
    <span class="s1">options </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">LoaderOptions</span><span class="s3">(</span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">LoaderOptions</span><span class="s3">.</span><span class="s1">LF_report_errors </span><span class="s3">|</span>
                                <span class="s1">p3d</span><span class="s3">.</span><span class="s1">LoaderOptions</span><span class="s3">.</span><span class="s1">LF_no_ram_cache</span><span class="s3">)</span>
    <span class="s1">node </span><span class="s3">= </span><span class="s1">loader</span><span class="s3">.</span><span class="s1">load_sync</span><span class="s3">(</span><span class="s1">src_fn</span><span class="s3">, </span><span class="s1">options</span><span class="s3">)</span>
    <span class="s2">if not </span><span class="s1">node</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">IOError</span><span class="s3">(</span><span class="s4">'Failed to load model: %s' </span><span class="s3">% (</span><span class="s1">srcpath</span><span class="s3">))</span>

    <span class="s2">if not </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">NodePath</span><span class="s3">(</span><span class="s1">node</span><span class="s3">).</span><span class="s1">write_bam_file</span><span class="s3">(</span><span class="s1">dst_fn</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">IOError</span><span class="s3">(</span><span class="s4">'Failed to write .bam file: %s' </span><span class="s3">% (</span><span class="s1">dstpath</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">egg2bam</span><span class="s3">(</span><span class="s1">_build_cmd</span><span class="s3">, </span><span class="s1">srcpath</span><span class="s3">, </span><span class="s1">dstpath</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">dstpath</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.gz'</span><span class="s3">) </span><span class="s2">or </span><span class="s1">dstpath</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.pz'</span><span class="s3">):</span>
        <span class="s1">dstpath </span><span class="s3">= </span><span class="s1">dstpath</span><span class="s3">[:-</span><span class="s5">3</span><span class="s3">]</span>
    <span class="s1">dstpath </span><span class="s3">= </span><span class="s1">dstpath </span><span class="s3">+ </span><span class="s4">'.bam'</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">subprocess</span><span class="s3">.</span><span class="s1">check_call</span><span class="s3">([</span>
            <span class="s4">'egg2bam'</span><span class="s3">,</span>
            <span class="s4">'-o'</span><span class="s3">, </span><span class="s1">dstpath</span><span class="s3">,</span>
            <span class="s4">'-pd'</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">abspath</span><span class="s3">(</span><span class="s1">srcpath</span><span class="s3">)),</span>
            <span class="s4">'-ps'</span><span class="s3">, </span><span class="s4">'rel'</span><span class="s3">,</span>
            <span class="s1">srcpath</span>
        <span class="s3">])</span>
    <span class="s2">except </span><span class="s1">FileNotFoundError</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">RuntimeError</span><span class="s3">(</span><span class="s4">'egg2bam failed: egg2bam was not found in the PATH'</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s3">(</span><span class="s1">subprocess</span><span class="s3">.</span><span class="s1">CalledProcessError</span><span class="s3">, </span><span class="s1">OSError</span><span class="s3">) </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">RuntimeError</span><span class="s3">(</span><span class="s4">'egg2bam failed: {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">err</span><span class="s3">))</span>
    <span class="s2">return </span><span class="s1">dstpath</span>

<span class="s1">macosx_binary_magics </span><span class="s3">= (</span>
    <span class="s7">b'</span><span class="s2">\xFE\xED\xFA\xCE</span><span class="s7">'</span><span class="s3">, </span><span class="s7">b'</span><span class="s2">\xCE\xFA\xED\xFE</span><span class="s7">'</span><span class="s3">,</span>
    <span class="s7">b'</span><span class="s2">\xFE\xED\xFA\xCF</span><span class="s7">'</span><span class="s3">, </span><span class="s7">b'</span><span class="s2">\xCF\xFA\xED\xFE</span><span class="s7">'</span><span class="s3">,</span>
    <span class="s7">b'</span><span class="s2">\xCA\xFE\xBA\xBE</span><span class="s7">'</span><span class="s3">, </span><span class="s7">b'</span><span class="s2">\xBE\xBA\xFE\xCA</span><span class="s7">'</span><span class="s3">,</span>
    <span class="s7">b'</span><span class="s2">\xCA\xFE\xBA\xBF</span><span class="s7">'</span><span class="s3">, </span><span class="s7">b'</span><span class="s2">\xBF\xBA\xFE\xCA</span><span class="s7">'</span><span class="s3">)</span>

<span class="s6"># Some dependencies need data directories to be extracted. This dictionary maps</span>
<span class="s6"># modules with data to extract. The values are lists of tuples of the form</span>
<span class="s6"># (source_pattern, destination_pattern, flags). The flags is a set of strings.</span>

<span class="s1">PACKAGE_DATA_DIRS </span><span class="s3">= {</span>
    <span class="s4">'matplotlib'</span><span class="s3">:  [(</span><span class="s4">'matplotlib/mpl-data/*'</span><span class="s3">, </span><span class="s4">'mpl-data'</span><span class="s3">, {})],</span>
    <span class="s4">'jsonschema'</span><span class="s3">:  [(</span><span class="s4">'jsonschema/schemas/*'</span><span class="s3">, </span><span class="s4">'schemas'</span><span class="s3">, {})],</span>
    <span class="s4">'cefpython3'</span><span class="s3">: [</span>
        <span class="s3">(</span><span class="s4">'cefpython3/*.pak'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">, {}),</span>
        <span class="s3">(</span><span class="s4">'cefpython3/*.dat'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">, {}),</span>
        <span class="s3">(</span><span class="s4">'cefpython3/*.bin'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">, {}),</span>
        <span class="s3">(</span><span class="s4">'cefpython3/*.dll'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">, {}),</span>
        <span class="s3">(</span><span class="s4">'cefpython3/libcef.so'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">, {}),</span>
        <span class="s3">(</span><span class="s4">'cefpython3/LICENSE.txt'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">, {}),</span>
        <span class="s3">(</span><span class="s4">'cefpython3/License'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">, {}),</span>
        <span class="s3">(</span><span class="s4">'cefpython3/subprocess*'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">, {</span><span class="s4">'PKG_DATA_MAKE_EXECUTABLE'</span><span class="s3">}),</span>
        <span class="s3">(</span><span class="s4">'cefpython3/locals/*'</span><span class="s3">, </span><span class="s4">'locals'</span><span class="s3">, {}),</span>
        <span class="s3">(</span><span class="s4">'cefpython3/Chromium Embedded Framework.framework/Resources'</span><span class="s3">, </span><span class="s4">'Chromium Embedded Framework.framework/Resources'</span><span class="s3">, {}),</span>
        <span class="s3">(</span><span class="s4">'cefpython3/Chromium Embedded Framework.framework/Chromium Embedded Framework'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">, {</span><span class="s4">'PKG_DATA_MAKE_EXECUTABLE'</span><span class="s3">}),</span>
    <span class="s3">],</span>
    <span class="s4">'pytz'</span><span class="s3">: [(</span><span class="s4">'pytz/zoneinfo/*'</span><span class="s3">, </span><span class="s4">'zoneinfo'</span><span class="s3">, ())],</span>
    <span class="s4">'certifi'</span><span class="s3">: [(</span><span class="s4">'certifi/cacert.pem'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">, {})],</span>
    <span class="s4">'_tkinter_ext'</span><span class="s3">: [(</span><span class="s4">'_tkinter_ext/tcl/**'</span><span class="s3">, </span><span class="s4">'tcl'</span><span class="s3">, {})],</span>
<span class="s3">}</span>

<span class="s6"># Some dependencies have extra directories that need to be scanned for DLLs.</span>
<span class="s6"># This dictionary maps wheel basenames (ie. the part of the .whl basename</span>
<span class="s6"># before the first hyphen) to a list of tuples, the first value being the</span>
<span class="s6"># directory inside the wheel, the second being which wheel to look in (or</span>
<span class="s6"># None to look in its own wheel).</span>

<span class="s1">PACKAGE_LIB_DIRS </span><span class="s3">= {</span>
    <span class="s4">'scipy'</span><span class="s3">:  [(</span><span class="s4">'scipy/extra-dll'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)],</span>
    <span class="s4">'PyQt5'</span><span class="s3">:  [(</span><span class="s4">'PyQt5/Qt5/bin'</span><span class="s3">, </span><span class="s4">'PyQt5_Qt5'</span><span class="s3">)],</span>
<span class="s3">}</span>

<span class="s6"># site.py for Python 2.</span>
<span class="s1">SITE_PY2 </span><span class="s3">= </span><span class="s4">u&quot;&quot;&quot; 
import sys 
 
sys.frozen = True 
 
# Override __import__ to set __file__ for frozen modules. 
prev_import = __import__ 
def __import__(*args, **kwargs): 
    mod = prev_import(*args, **kwargs) 
    if mod: 
        mod.__file__ = sys.executable 
    return mod 
 
# Add our custom __import__ version to the global scope, as well as a builtin 
# definition for __file__ so that it is available in the module itself. 
import __builtin__ 
__builtin__.__import__ = __import__ 
__builtin__.__file__ = sys.executable 
del __builtin__ 
&quot;&quot;&quot;</span>

<span class="s6"># site.py for Python 3.</span>
<span class="s1">SITE_PY3 </span><span class="s3">= </span><span class="s4">u&quot;&quot;&quot; 
import sys 
from _frozen_importlib import _imp, FrozenImporter 
 
sys.frozen = True 
 
if sys.platform == 'win32' and sys.version_info &lt; (3, 10): 
    # Make sure the preferred encoding is something we actually support. 
    import _bootlocale 
    enc = _bootlocale.getpreferredencoding().lower() 
    if enc != 'utf-8' and not _imp.is_frozen('encodings.%s' % (enc)): 
        def getpreferredencoding(do_setlocale=True): 
            return 'mbcs' 
        _bootlocale.getpreferredencoding = getpreferredencoding 
 
# Alter FrozenImporter to give a __file__ property to frozen modules. 
_find_spec = FrozenImporter.find_spec 
 
def find_spec(fullname, path=None, target=None): 
    spec = _find_spec(fullname, path=path, target=target) 
    if spec: 
        spec.has_location = True 
        spec.origin = sys.executable 
    return spec 
 
def get_data(path): 
    with open(path, 'rb') as fp: 
        return fp.read() 
 
FrozenImporter.find_spec = find_spec 
FrozenImporter.get_data = get_data 
&quot;&quot;&quot;</span>

<span class="s6"># This addendum is only needed for legacy tkinter handling, since the new</span>
<span class="s6"># tkinter package already contains this logic.</span>
<span class="s1">SITE_PY_TKINTER_ADDENDUM </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot; 
# Set the TCL_LIBRARY directory to the location of the Tcl/Tk/Tix files. 
import os 
tcl_dir = os.path.join(os.path.dirname(sys.executable), 'tcl') 
if os.path.isdir(tcl_dir): 
    for dir in os.listdir(tcl_dir): 
        sub_dir = os.path.join(tcl_dir, dir) 
        if os.path.isdir(sub_dir): 
            if dir.startswith('tcl') and os.path.isfile(os.path.join(sub_dir, 'init.tcl')): 
                os.environ['TCL_LIBRARY'] = sub_dir 
            if dir.startswith('tk'): 
                os.environ['TK_LIBRARY'] = sub_dir 
            if dir.startswith('tix'): 
                os.environ['TIX_LIBRARY'] = sub_dir 
del os 
&quot;&quot;&quot;</span>

<span class="s1">SITE_PY </span><span class="s3">= </span><span class="s1">SITE_PY3 </span><span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&gt;= (</span><span class="s5">3</span><span class="s3">,) </span><span class="s2">else </span><span class="s1">SITE_PY2</span>


<span class="s2">class </span><span class="s1">build_apps</span><span class="s3">(</span><span class="s1">setuptools</span><span class="s3">.</span><span class="s1">Command</span><span class="s3">):</span>
    <span class="s1">description </span><span class="s3">= </span><span class="s4">'build Panda3D applications'</span>
    <span class="s1">user_options </span><span class="s3">= [</span>
        <span class="s3">(</span><span class="s4">'build-base='</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s4">'directory to build applications in'</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s4">'requirements-path='</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s4">'path to requirements.txt file for pip'</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s4">'platforms='</span><span class="s3">, </span><span class="s4">'p'</span><span class="s3">, </span><span class="s4">'a list of platforms to build for'</span><span class="s3">),</span>
    <span class="s3">]</span>
    <span class="s1">default_file_handlers </span><span class="s3">= {</span>
        <span class="s4">'.egg'</span><span class="s3">: </span><span class="s1">egg2bam</span><span class="s3">,</span>
    <span class="s3">}</span>

    <span class="s2">def </span><span class="s1">initialize_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">build_base </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">getcwd</span><span class="s3">(), </span><span class="s4">'build'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">gui_apps </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">console_apps </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">macos_main_app </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">rename_paths </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">include_patterns </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">exclude_patterns </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">include_modules </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">exclude_modules </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">icons </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">platforms </span><span class="s3">= [</span>
            <span class="s4">'manylinux1_x86_64'</span><span class="s3">,</span>
            <span class="s4">'macosx_10_6_x86_64'</span><span class="s3">,</span>
            <span class="s4">'win_amd64'</span><span class="s3">,</span>
        <span class="s3">]</span>
        <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&gt;= (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">11</span><span class="s3">):</span>
            <span class="s6"># manylinux2010 is not offered for Python 3.11 anymore</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">platforms</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = </span><span class="s4">'manylinux2014_x86_64'</span>
        <span class="s2">elif </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&gt;= (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">10</span><span class="s3">):</span>
            <span class="s6"># manylinux1 is not offered for Python 3.10 anymore</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">platforms</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = </span><span class="s4">'manylinux2010_x86_64'</span>
        <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&gt;= (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">8</span><span class="s3">):</span>
            <span class="s6"># This version of Python is only available for 10.9+.</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">platforms</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] = </span><span class="s4">'macosx_10_9_x86_64'</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">plugins </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">embed_prc_data </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">extra_prc_files </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">extra_prc_data </span><span class="s3">= </span><span class="s4">''</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">default_prc_dir </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">log_filename </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">log_filename_strftime </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">log_append </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">prefer_discrete_gpu </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">requirements_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">getcwd</span><span class="s3">(), </span><span class="s4">'requirements.txt'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">strip_docstrings </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">use_optimized_wheels </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">optimized_wheel_index </span><span class="s3">= </span><span class="s4">''</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">pypi_extra_indexes </span><span class="s3">= [</span>
            <span class="s4">'https://archive.panda3d.org/thirdparty'</span><span class="s3">,</span>
        <span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">file_handlers </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">bam_model_extensions </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">exclude_dependencies </span><span class="s3">= [</span>
            <span class="s6"># Windows</span>
            <span class="s4">'kernel32.dll'</span><span class="s3">, </span><span class="s4">'user32.dll'</span><span class="s3">, </span><span class="s4">'wsock32.dll'</span><span class="s3">, </span><span class="s4">'ws2_32.dll'</span><span class="s3">,</span>
            <span class="s4">'advapi32.dll'</span><span class="s3">, </span><span class="s4">'opengl32.dll'</span><span class="s3">, </span><span class="s4">'glu32.dll'</span><span class="s3">, </span><span class="s4">'gdi32.dll'</span><span class="s3">,</span>
            <span class="s4">'shell32.dll'</span><span class="s3">, </span><span class="s4">'ntdll.dll'</span><span class="s3">, </span><span class="s4">'ws2help.dll'</span><span class="s3">, </span><span class="s4">'rpcrt4.dll'</span><span class="s3">,</span>
            <span class="s4">'imm32.dll'</span><span class="s3">, </span><span class="s4">'ddraw.dll'</span><span class="s3">, </span><span class="s4">'shlwapi.dll'</span><span class="s3">, </span><span class="s4">'secur32.dll'</span><span class="s3">,</span>
            <span class="s4">'dciman32.dll'</span><span class="s3">, </span><span class="s4">'comdlg32.dll'</span><span class="s3">, </span><span class="s4">'comctl32.dll'</span><span class="s3">, </span><span class="s4">'ole32.dll'</span><span class="s3">,</span>
            <span class="s4">'oleaut32.dll'</span><span class="s3">, </span><span class="s4">'gdiplus.dll'</span><span class="s3">, </span><span class="s4">'winmm.dll'</span><span class="s3">, </span><span class="s4">'iphlpapi.dll'</span><span class="s3">,</span>
            <span class="s4">'msvcrt.dll'</span><span class="s3">, </span><span class="s4">'kernelbase.dll'</span><span class="s3">, </span><span class="s4">'msimg32.dll'</span><span class="s3">, </span><span class="s4">'msacm32.dll'</span><span class="s3">,</span>
            <span class="s4">'setupapi.dll'</span><span class="s3">, </span><span class="s4">'version.dll'</span><span class="s3">, </span><span class="s4">'userenv.dll'</span><span class="s3">, </span><span class="s4">'netapi32.dll'</span><span class="s3">,</span>
            <span class="s4">'crypt32.dll'</span><span class="s3">,</span>

            <span class="s6"># manylinux1/linux</span>
            <span class="s4">'libdl.so.*'</span><span class="s3">, </span><span class="s4">'libstdc++.so.*'</span><span class="s3">, </span><span class="s4">'libm.so.*'</span><span class="s3">, </span><span class="s4">'libgcc_s.so.*'</span><span class="s3">,</span>
            <span class="s4">'libpthread.so.*'</span><span class="s3">, </span><span class="s4">'libc.so.*'</span><span class="s3">, </span><span class="s4">'ld-linux-x86-64.so.*'</span><span class="s3">,</span>
            <span class="s4">'libgl.so.*'</span><span class="s3">, </span><span class="s4">'libx11.so.*'</span><span class="s3">, </span><span class="s4">'libncursesw.so.*'</span><span class="s3">, </span><span class="s4">'libz.so.*'</span><span class="s3">,</span>
            <span class="s4">'librt.so.*'</span><span class="s3">, </span><span class="s4">'libutil.so.*'</span><span class="s3">, </span><span class="s4">'libnsl.so.1'</span><span class="s3">, </span><span class="s4">'libXext.so.6'</span><span class="s3">,</span>
            <span class="s4">'libXrender.so.1'</span><span class="s3">, </span><span class="s4">'libICE.so.6'</span><span class="s3">, </span><span class="s4">'libSM.so.6'</span><span class="s3">, </span><span class="s4">'libEGL.so.1'</span><span class="s3">,</span>
            <span class="s4">'libOpenGL.so.0'</span><span class="s3">, </span><span class="s4">'libGLdispatch.so.0'</span><span class="s3">, </span><span class="s4">'libGLX.so.0'</span><span class="s3">,</span>
            <span class="s4">'libgobject-2.0.so.0'</span><span class="s3">, </span><span class="s4">'libgthread-2.0.so.0'</span><span class="s3">, </span><span class="s4">'libglib-2.0.so.0'</span><span class="s3">,</span>

            <span class="s6"># macOS</span>
            <span class="s4">'/usr/lib/libc++.1.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libstdc++.*.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libz.*.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libobjc.*.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libSystem.*.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libbz2.*.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libedit.*.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libffi.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libauditd.0.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libgermantok.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/liblangid.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libarchive.2.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libipsec.A.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libpanel.5.4.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libiodbc.2.1.18.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libhunspell-1.2.0.0.0.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libsqlite3.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libpam.1.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libtidy.A.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libDHCPServer.A.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libpam.2.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libXplugin.1.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libxslt.1.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libiodbcinst.2.1.18.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libBSDPClient.A.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libsandbox.1.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libform.5.4.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libbsm.0.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libMatch.1.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libresolv.9.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libcharset.1.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libxml2.2.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libiconv.2.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libScreenReader.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libdtrace.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libicucore.A.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libsasl2.2.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libpcap.A.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libexslt.0.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libcurl.4.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libncurses.5.4.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libxar.1.dylib'</span><span class="s3">,</span>
            <span class="s4">'/usr/lib/libmenu.5.4.dylib'</span><span class="s3">,</span>
            <span class="s4">'/System/Library/**'</span><span class="s3">,</span>
        <span class="s3">]</span>

        <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&gt;= (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">):</span>
            <span class="s6"># Python 3.5+ requires at least Windows Vista to run anyway, so we</span>
            <span class="s6"># shouldn't warn about DLLs that are shipped with Vista.</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">exclude_dependencies </span><span class="s3">+= [</span><span class="s4">'bcrypt.dll'</span><span class="s3">]</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">package_data_dirs </span><span class="s3">= {}</span>

        <span class="s6"># We keep track of the zip files we've opened.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_zip_files </span><span class="s3">= {}</span>

    <span class="s2">def </span><span class="s1">_get_zip_file</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">path </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_zip_files</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_zip_files</span><span class="s3">[</span><span class="s1">path</span><span class="s3">]</span>

        <span class="s1">zip </span><span class="s3">= </span><span class="s1">zipfile</span><span class="s3">.</span><span class="s1">ZipFile</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_zip_files</span><span class="s3">[</span><span class="s1">path</span><span class="s3">] = </span><span class="s1">zip</span>
        <span class="s2">return </span><span class="s1">zip</span>

    <span class="s2">def </span><span class="s1">finalize_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># We need to massage the inputs a bit in case they came from a</span>
        <span class="s6"># setup.cfg file.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">gui_apps </span><span class="s3">= </span><span class="s1">_parse_dict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">gui_apps</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">console_apps </span><span class="s3">= </span><span class="s1">_parse_dict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">console_apps</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">rename_paths </span><span class="s3">= </span><span class="s1">_parse_dict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">rename_paths</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">include_patterns </span><span class="s3">= </span><span class="s1">_parse_list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">include_patterns</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">exclude_patterns </span><span class="s3">= </span><span class="s1">_parse_list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">exclude_patterns</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">include_modules </span><span class="s3">= {</span>
            <span class="s1">key</span><span class="s3">: </span><span class="s1">_parse_list</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">_parse_dict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">include_modules</span><span class="s3">).</span><span class="s1">items</span><span class="s3">()</span>
        <span class="s3">}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">exclude_modules </span><span class="s3">= {</span>
            <span class="s1">key</span><span class="s3">: </span><span class="s1">_parse_list</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">_parse_dict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">exclude_modules</span><span class="s3">).</span><span class="s1">items</span><span class="s3">()</span>
        <span class="s3">}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">icons </span><span class="s3">= </span><span class="s1">_parse_dict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">icons</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">platforms </span><span class="s3">= </span><span class="s1">_parse_list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">platforms</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">plugins </span><span class="s3">= </span><span class="s1">_parse_list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">plugins</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">extra_prc_files </span><span class="s3">= </span><span class="s1">_parse_list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">extra_prc_files</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">default_prc_dir </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">default_prc_dir </span><span class="s3">= </span><span class="s4">'&lt;auto&gt;etc' </span><span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">embed_prc_data </span><span class="s2">else </span><span class="s4">''</span>

        <span class="s1">num_gui_apps </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">gui_apps</span><span class="s3">)</span>
        <span class="s1">num_console_apps </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">console_apps</span><span class="s3">)</span>

        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">macos_main_app</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">num_gui_apps </span><span class="s3">&gt; </span><span class="s5">1</span><span class="s3">:</span>
                <span class="s2">assert False</span><span class="s3">, </span><span class="s4">'macos_main_app must be defined if more than one gui_app is defined'</span>
            <span class="s2">elif </span><span class="s1">num_gui_apps </span><span class="s3">== </span><span class="s5">1</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">macos_main_app </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">gui_apps</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">())[</span><span class="s5">0</span><span class="s3">]</span>

        <span class="s1">use_pipenv </span><span class="s3">= (</span>
            <span class="s4">'Pipfile' </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">requirements_path</span><span class="s3">) </span><span class="s2">or</span>
            <span class="s2">not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">requirements_path</span><span class="s3">) </span><span class="s2">and </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s4">'Pipfile'</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">use_pipenv</span><span class="s3">:</span>
            <span class="s1">reqspath </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_base</span><span class="s3">, </span><span class="s4">'requirements.txt'</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">reqspath</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">reqsfile</span><span class="s3">:</span>
                <span class="s1">subprocess</span><span class="s3">.</span><span class="s1">check_call</span><span class="s3">([</span><span class="s4">'pipenv'</span><span class="s3">, </span><span class="s4">'lock'</span><span class="s3">, </span><span class="s4">'--requirements'</span><span class="s3">], </span><span class="s1">stdout</span><span class="s3">=</span><span class="s1">reqsfile</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">requirements_path </span><span class="s3">= </span><span class="s1">reqspath</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">use_optimized_wheels</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">optimized_wheel_index</span><span class="s3">:</span>
                <span class="s6"># Try to find an appropriate wheel index</span>

                <span class="s6"># Start with the release index</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">optimized_wheel_index </span><span class="s3">= </span><span class="s4">'https://archive.panda3d.org/simple/opt'</span>

                <span class="s6"># See if a buildbot build is being used</span>
                <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">requirements_path</span><span class="s3">) </span><span class="s2">as </span><span class="s1">reqsfile</span><span class="s3">:</span>
                    <span class="s1">reqsdata </span><span class="s3">= </span><span class="s1">reqsfile</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
                <span class="s1">matches </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">search</span><span class="s3">(</span><span class="s4">r'--extra-index-url (https*://archive.panda3d.org/.*\b)'</span><span class="s3">, </span><span class="s1">reqsdata</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">matches </span><span class="s2">and </span><span class="s1">matches</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s5">1</span><span class="s3">):</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">optimized_wheel_index </span><span class="s3">= </span><span class="s1">matches</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
                    <span class="s2">if not </span><span class="s1">matches</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s5">1</span><span class="s3">).</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'opt'</span><span class="s3">):</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">optimized_wheel_index </span><span class="s3">+= </span><span class="s4">'/opt'</span>

            <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">optimized_wheel_index</span><span class="s3">, </span><span class="s4">'An index for optimized wheels must be defined if use_optimized_wheels is set'</span>

        <span class="s2">assert </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">requirements_path</span><span class="s3">), </span><span class="s4">'Requirements.txt path does not exist: {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">requirements_path</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">num_gui_apps </span><span class="s3">+ </span><span class="s1">num_console_apps </span><span class="s3">!= </span><span class="s5">0</span><span class="s3">, </span><span class="s4">'Must specify at least one app in either gui_apps or console_apps'</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">exclude_dependencies </span><span class="s3">= [</span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">GlobPattern</span><span class="s3">(</span><span class="s1">i</span><span class="s3">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">exclude_dependencies</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">glob </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">exclude_dependencies</span><span class="s3">:</span>
            <span class="s1">glob</span><span class="s3">.</span><span class="s1">case_sensitive </span><span class="s3">= </span><span class="s2">False</span>

        <span class="s6"># bam_model_extensions registers a 2bam handler for each given extension.</span>
        <span class="s6"># They can override a default handler, but not a custom handler.</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">bam_model_extensions</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">ext </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">bam_model_extensions</span><span class="s3">:</span>
                <span class="s1">ext </span><span class="s3">= </span><span class="s4">'.' </span><span class="s3">+ </span><span class="s1">ext</span><span class="s3">.</span><span class="s1">lstrip</span><span class="s3">(</span><span class="s4">'.'</span><span class="s3">)</span>
                <span class="s2">assert </span><span class="s1">ext </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">file_handlers</span><span class="s3">, </span><span class="s1">\</span>
                    <span class="s4">'Extension {} occurs in both file_handlers and bam_model_extensions!'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">ext</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">file_handlers</span><span class="s3">[</span><span class="s1">ext</span><span class="s3">] = </span><span class="s1">_model_to_bam</span>

        <span class="s1">tmp </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">default_file_handlers</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">tmp</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">file_handlers</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">file_handlers </span><span class="s3">= </span><span class="s1">tmp</span>

        <span class="s1">tmp </span><span class="s3">= </span><span class="s1">PACKAGE_DATA_DIRS</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">tmp</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">package_data_dirs</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">package_data_dirs </span><span class="s3">= </span><span class="s1">tmp</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">icon_objects </span><span class="s3">= {}</span>
        <span class="s2">for </span><span class="s1">app</span><span class="s3">, </span><span class="s1">iconpaths </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">icons</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">iconpaths</span><span class="s3">, </span><span class="s1">list</span><span class="s3">) </span><span class="s2">and not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">iconpaths</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">):</span>
                <span class="s1">iconpaths </span><span class="s3">= (</span><span class="s1">iconpaths</span><span class="s3">,)</span>

            <span class="s1">iconobj </span><span class="s3">= </span><span class="s1">Icon</span><span class="s3">()</span>
            <span class="s2">for </span><span class="s1">iconpath </span><span class="s2">in </span><span class="s1">iconpaths</span><span class="s3">:</span>
                <span class="s1">iconobj</span><span class="s3">.</span><span class="s1">addImage</span><span class="s3">(</span><span class="s1">iconpath</span><span class="s3">)</span>

            <span class="s1">iconobj</span><span class="s3">.</span><span class="s1">generateMissingImages</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">icon_objects</span><span class="s3">[</span><span class="s1">app</span><span class="s3">] = </span><span class="s1">iconobj</span>

    <span class="s2">def </span><span class="s1">run</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'Building platforms: {0}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s4">','</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">platforms</span><span class="s3">)), </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">log</span><span class="s3">.</span><span class="s1">INFO</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">platform </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">platforms</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">build_runtimes</span><span class="s3">(</span><span class="s1">platform</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">download_wheels</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">platform</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Downloads wheels for the given platform using pip. This includes panda3d 
        wheels. These are special wheels that are expected to contain a deploy_libs 
        directory containing the Python runtime libraries, which will be added 
        to sys.path.&quot;&quot;&quot;</span>

        <span class="s2">import </span><span class="s1">pip</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'Gathering wheels for platform: {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">platform</span><span class="s3">), </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">log</span><span class="s3">.</span><span class="s1">INFO</span><span class="s3">)</span>

        <span class="s1">whlcache </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_base</span><span class="s3">, </span><span class="s4">'__whl_cache__'</span><span class="s3">)</span>

        <span class="s1">pip_version </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">pip</span><span class="s3">.</span><span class="s1">__version__</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'.'</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">])</span>
        <span class="s2">if </span><span class="s1">pip_version </span><span class="s3">&lt; </span><span class="s5">9</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">RuntimeError</span><span class="s3">(</span><span class="s4">&quot;pip 9.0 or greater is required, but found {}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">pip</span><span class="s3">.</span><span class="s1">__version__</span><span class="s3">))</span>

        <span class="s1">abi_tag </span><span class="s3">= </span><span class="s4">'cp%d%d' </span><span class="s3">% (</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info</span><span class="s3">[:</span><span class="s5">2</span><span class="s3">])</span>
        <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&lt; (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">8</span><span class="s3">):</span>
            <span class="s1">abi_tag </span><span class="s3">+= </span><span class="s4">'m'</span>

        <span class="s6"># For these distributions, we need to append 'u' on Linux</span>
        <span class="s2">if </span><span class="s1">abi_tag </span><span class="s2">in </span><span class="s3">(</span><span class="s4">'cp26m'</span><span class="s3">, </span><span class="s4">'cp27m'</span><span class="s3">, </span><span class="s4">'cp32m'</span><span class="s3">) </span><span class="s2">and not </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'win'</span><span class="s3">) </span><span class="s2">and not </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'macosx'</span><span class="s3">):</span>
            <span class="s1">abi_tag </span><span class="s3">+= </span><span class="s4">'u'</span>

        <span class="s1">whldir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">whlcache</span><span class="s3">, </span><span class="s4">'_'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">((</span><span class="s1">platform</span><span class="s3">, </span><span class="s1">abi_tag</span><span class="s3">)))</span>
        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">whldir</span><span class="s3">):</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">whldir</span><span class="s3">)</span>

        <span class="s6"># Remove any .zip files. These are built from a VCS and block for an</span>
        <span class="s6"># interactive prompt on subsequent downloads.</span>
        <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">whldir</span><span class="s3">):</span>
            <span class="s2">for </span><span class="s1">whl </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s1">whldir</span><span class="s3">):</span>
                <span class="s2">if </span><span class="s1">whl</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.zip'</span><span class="s3">):</span>
                    <span class="s1">os</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">whldir</span><span class="s3">, </span><span class="s1">whl</span><span class="s3">))</span>

        <span class="s1">pip_args </span><span class="s3">= [</span>
            <span class="s4">'--disable-pip-version-check'</span><span class="s3">,</span>
            <span class="s4">'download'</span><span class="s3">,</span>
            <span class="s4">'-d'</span><span class="s3">, </span><span class="s1">whldir</span><span class="s3">,</span>
            <span class="s4">'-r'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">requirements_path</span><span class="s3">,</span>
            <span class="s4">'--only-binary'</span><span class="s3">, </span><span class="s4">':all:'</span><span class="s3">,</span>
            <span class="s4">'--abi'</span><span class="s3">, </span><span class="s1">abi_tag</span><span class="s3">,</span>
            <span class="s4">'--platform'</span><span class="s3">, </span><span class="s1">platform</span><span class="s3">,</span>
        <span class="s3">]</span>

        <span class="s2">if </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'linux_'</span><span class="s3">):</span>
            <span class="s6"># Also accept manylinux.</span>
            <span class="s1">arch </span><span class="s3">= </span><span class="s1">platform</span><span class="s3">[</span><span class="s5">6</span><span class="s3">:]</span>
            <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&gt;= (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">11</span><span class="s3">):</span>
                <span class="s1">pip_args </span><span class="s3">+= [</span><span class="s4">'--platform'</span><span class="s3">, </span><span class="s4">'manylinux2014_' </span><span class="s3">+ </span><span class="s1">arch</span><span class="s3">]</span>
            <span class="s2">elif </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&gt;= (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">10</span><span class="s3">):</span>
                <span class="s1">pip_args </span><span class="s3">+= [</span><span class="s4">'--platform'</span><span class="s3">, </span><span class="s4">'manylinux2010_' </span><span class="s3">+ </span><span class="s1">arch</span><span class="s3">]</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">pip_args </span><span class="s3">+= [</span><span class="s4">'--platform'</span><span class="s3">, </span><span class="s4">'manylinux1_' </span><span class="s3">+ </span><span class="s1">arch</span><span class="s3">]</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">use_optimized_wheels</span><span class="s3">:</span>
            <span class="s1">pip_args </span><span class="s3">+= [</span>
                <span class="s4">'--extra-index-url'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">optimized_wheel_index</span>
            <span class="s3">]</span>

        <span class="s2">for </span><span class="s1">index </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pypi_extra_indexes</span><span class="s3">:</span>
            <span class="s1">pip_args </span><span class="s3">+= [</span><span class="s4">'--extra-index-url'</span><span class="s3">, </span><span class="s1">index</span><span class="s3">]</span>

        <span class="s1">subprocess</span><span class="s3">.</span><span class="s1">check_call</span><span class="s3">([</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">executable</span><span class="s3">, </span><span class="s4">'-m'</span><span class="s3">, </span><span class="s4">'pip'</span><span class="s3">] + </span><span class="s1">pip_args</span><span class="s3">)</span>

        <span class="s6"># Return a list of paths to the downloaded whls</span>
        <span class="s2">return </span><span class="s3">[</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">whldir</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">filename </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s1">whldir</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">filename</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.whl'</span><span class="s3">)</span>
        <span class="s3">]</span>

    <span class="s2">def </span><span class="s1">update_pe_resources</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">appname</span><span class="s3">, </span><span class="s1">runtime</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Update resources (e.g., icons) in windows PE file&quot;&quot;&quot;</span>

        <span class="s1">icon </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">icon_objects</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span>
            <span class="s1">appname</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">icon_objects</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'*'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
        <span class="s3">)</span>

        <span class="s2">if </span><span class="s1">icon </span><span class="s2">is not None or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">prefer_discrete_gpu</span><span class="s3">:</span>
            <span class="s1">pef </span><span class="s3">= </span><span class="s1">pefile</span><span class="s3">.</span><span class="s1">PEFile</span><span class="s3">()</span>
            <span class="s1">pef</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">runtime</span><span class="s3">, </span><span class="s4">'r+'</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">icon </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">pef</span><span class="s3">.</span><span class="s1">add_icon</span><span class="s3">(</span><span class="s1">icon</span><span class="s3">)</span>
                <span class="s1">pef</span><span class="s3">.</span><span class="s1">add_resource_section</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">prefer_discrete_gpu</span><span class="s3">:</span>
                <span class="s2">if not </span><span class="s1">pef</span><span class="s3">.</span><span class="s1">rename_export</span><span class="s3">(</span><span class="s4">&quot;SymbolPlaceholder___________________&quot;</span><span class="s3">, </span><span class="s4">&quot;AmdPowerXpressRequestHighPerformance&quot;</span><span class="s3">) </span><span class="s2">or </span><span class="s1">\</span>
                   <span class="s2">not </span><span class="s1">pef</span><span class="s3">.</span><span class="s1">rename_export</span><span class="s3">(</span><span class="s4">&quot;SymbolPlaceholder__&quot;</span><span class="s3">, </span><span class="s4">&quot;NvOptimusEnablement&quot;</span><span class="s3">):</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s4">&quot;Failed to apply prefer_discrete_gpu, newer target Panda3D version may be required&quot;</span><span class="s3">)</span>
            <span class="s1">pef</span><span class="s3">.</span><span class="s1">write_changes</span><span class="s3">()</span>
            <span class="s1">pef</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">bundle_macos_app</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">builddir</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Bundle built runtime into a .app for macOS&quot;&quot;&quot;</span>

        <span class="s1">appname </span><span class="s3">= </span><span class="s4">'{}.app'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">macos_main_app</span><span class="s3">)</span>
        <span class="s1">appdir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">builddir</span><span class="s3">, </span><span class="s1">appname</span><span class="s3">)</span>
        <span class="s1">contentsdir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">appdir</span><span class="s3">, </span><span class="s4">'Contents'</span><span class="s3">)</span>
        <span class="s1">macosdir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">contentsdir</span><span class="s3">, </span><span class="s4">'MacOS'</span><span class="s3">)</span>
        <span class="s1">fwdir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">contentsdir</span><span class="s3">, </span><span class="s4">'Frameworks'</span><span class="s3">)</span>
        <span class="s1">resdir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">contentsdir</span><span class="s3">, </span><span class="s4">'Resources'</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'Bundling macOS app into {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">appdir</span><span class="s3">), </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">log</span><span class="s3">.</span><span class="s1">INFO</span><span class="s3">)</span>

        <span class="s6"># Create initial directory structure</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">macosdir</span><span class="s3">)</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">fwdir</span><span class="s3">)</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">resdir</span><span class="s3">)</span>

        <span class="s6"># Move files over</span>
        <span class="s2">for </span><span class="s1">fname </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s1">builddir</span><span class="s3">):</span>
            <span class="s1">src </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">builddir</span><span class="s3">, </span><span class="s1">fname</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">appdir </span><span class="s2">in </span><span class="s1">src</span><span class="s3">:</span>
                <span class="s2">continue</span>

            <span class="s2">if </span><span class="s1">fname </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">gui_apps </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">console_apps</span><span class="s3">:</span>
                <span class="s1">dst </span><span class="s3">= </span><span class="s1">macosdir</span>
            <span class="s2">elif </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">src</span><span class="s3">) </span><span class="s2">and </span><span class="s1">open</span><span class="s3">(</span><span class="s1">src</span><span class="s3">, </span><span class="s4">'rb'</span><span class="s3">).</span><span class="s1">read</span><span class="s3">(</span><span class="s5">4</span><span class="s3">) </span><span class="s2">in </span><span class="s1">macosx_binary_magics</span><span class="s3">:</span>
                <span class="s1">dst </span><span class="s3">= </span><span class="s1">fwdir</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">dst </span><span class="s3">= </span><span class="s1">resdir</span>
            <span class="s1">shutil</span><span class="s3">.</span><span class="s1">move</span><span class="s3">(</span><span class="s1">src</span><span class="s3">, </span><span class="s1">dst</span><span class="s3">)</span>

        <span class="s6"># Write out Info.plist</span>
        <span class="s1">plist </span><span class="s3">= {</span>
            <span class="s4">'CFBundleName'</span><span class="s3">: </span><span class="s1">appname</span><span class="s3">,</span>
            <span class="s4">'CFBundleDisplayName'</span><span class="s3">: </span><span class="s1">appname</span><span class="s3">, </span><span class="s6">#TODO use name from setup.py/cfg</span>
            <span class="s4">'CFBundleIdentifier'</span><span class="s3">: </span><span class="s4">''</span><span class="s3">, </span><span class="s6">#TODO</span>
            <span class="s4">'CFBundleVersion'</span><span class="s3">: </span><span class="s4">'0.0.0'</span><span class="s3">, </span><span class="s6">#TODO get from setup.py</span>
            <span class="s4">'CFBundlePackageType'</span><span class="s3">: </span><span class="s4">'APPL'</span><span class="s3">,</span>
            <span class="s4">'CFBundleSignature'</span><span class="s3">: </span><span class="s4">''</span><span class="s3">, </span><span class="s6">#TODO</span>
            <span class="s4">'CFBundleExecutable'</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">macos_main_app</span><span class="s3">,</span>
        <span class="s3">}</span>

        <span class="s1">icon </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">icon_objects</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">macos_main_app</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">icon_objects</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'*'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">icon </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">plist</span><span class="s3">[</span><span class="s4">'CFBundleIconFile'</span><span class="s3">] = </span><span class="s4">'iconfile'</span>
            <span class="s1">icon</span><span class="s3">.</span><span class="s1">makeICNS</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">resdir</span><span class="s3">, </span><span class="s4">'iconfile.icns'</span><span class="s3">))</span>

        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">contentsdir</span><span class="s3">, </span><span class="s4">'Info.plist'</span><span class="s3">), </span><span class="s4">'wb'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">plistlib</span><span class="s3">, </span><span class="s4">'dump'</span><span class="s3">):</span>
                <span class="s1">plistlib</span><span class="s3">.</span><span class="s1">dump</span><span class="s3">(</span><span class="s1">plist</span><span class="s3">, </span><span class="s1">f</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">plistlib</span><span class="s3">.</span><span class="s1">writePlist</span><span class="s3">(</span><span class="s1">plist</span><span class="s3">, </span><span class="s1">f</span><span class="s3">)</span>


    <span class="s2">def </span><span class="s1">build_runtimes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">platform</span><span class="s3">, </span><span class="s1">use_wheels</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Builds the distributions for the given platform. &quot;&quot;&quot;</span>

        <span class="s1">builddir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_base</span><span class="s3">, </span><span class="s1">platform</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">builddir</span><span class="s3">):</span>
            <span class="s1">shutil</span><span class="s3">.</span><span class="s1">rmtree</span><span class="s3">(</span><span class="s1">builddir</span><span class="s3">)</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">builddir</span><span class="s3">)</span>

        <span class="s1">path </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">path</span><span class="s3">[:]</span>
        <span class="s1">p3dwhl </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">wheelpaths </span><span class="s3">= []</span>
        <span class="s1">has_tkinter_wheel </span><span class="s3">= </span><span class="s2">False</span>

        <span class="s2">if </span><span class="s1">use_wheels</span><span class="s3">:</span>
            <span class="s1">wheelpaths </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">download_wheels</span><span class="s3">(</span><span class="s1">platform</span><span class="s3">)</span>

            <span class="s2">for </span><span class="s1">whl </span><span class="s2">in </span><span class="s1">wheelpaths</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">whl</span><span class="s3">).</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'panda3d-'</span><span class="s3">):</span>
                    <span class="s1">p3dwhlfn </span><span class="s3">= </span><span class="s1">whl</span>
                    <span class="s1">p3dwhl </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_zip_file</span><span class="s3">(</span><span class="s1">p3dwhlfn</span><span class="s3">)</span>
                    <span class="s2">break</span>
                <span class="s2">elif </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">whl</span><span class="s3">).</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'tkinter-'</span><span class="s3">):</span>
                    <span class="s1">has_tkinter_wheel </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">RuntimeError</span><span class="s3">(</span><span class="s4">&quot;Missing panda3d wheel for platform: {}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">platform</span><span class="s3">))</span>

            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">use_optimized_wheels</span><span class="s3">:</span>
                <span class="s6"># Check to see if we have an optimized wheel</span>
                <span class="s1">localtag </span><span class="s3">= </span><span class="s1">p3dwhlfn</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'+'</span><span class="s3">)[</span><span class="s5">1</span><span class="s3">].</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'-'</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">] </span><span class="s2">if </span><span class="s4">'+' </span><span class="s2">in </span><span class="s1">p3dwhlfn </span><span class="s2">else </span><span class="s4">''</span>
                <span class="s2">if not </span><span class="s1">localtag</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'opt'</span><span class="s3">):</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span>
                        <span class="s4">'Could not find an optimized wheel (using index {}) for platform: {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">optimized_wheel_index</span><span class="s3">, </span><span class="s1">platform</span><span class="s3">),</span>
                        <span class="s1">distutils</span><span class="s3">.</span><span class="s1">log</span><span class="s3">.</span><span class="s1">WARN</span>
                    <span class="s3">)</span>

            <span class="s2">for </span><span class="s1">whl </span><span class="s2">in </span><span class="s1">wheelpaths</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">whl</span><span class="s3">).</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'tkinter-'</span><span class="s3">):</span>
                    <span class="s1">has_tkinter_wheel </span><span class="s3">= </span><span class="s2">True</span>
                    <span class="s2">break</span>

            <span class="s6">#whlfiles = {whl: self._get_zip_file(whl) for whl in wheelpaths}</span>

            <span class="s6"># Add whl files to the path so they are picked up by modulefinder</span>
            <span class="s2">for </span><span class="s1">whl </span><span class="s2">in </span><span class="s1">wheelpaths</span><span class="s3">:</span>
                <span class="s1">path</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">whl</span><span class="s3">)</span>

            <span class="s6"># Add deploy_libs from panda3d whl to the path</span>
            <span class="s1">path</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">p3dwhlfn</span><span class="s3">, </span><span class="s4">'deploy_libs'</span><span class="s3">))</span>


        <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'Building runtime for platform: {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">platform</span><span class="s3">), </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">log</span><span class="s3">.</span><span class="s1">INFO</span><span class="s3">)</span>

        <span class="s6"># Gather PRC data</span>
        <span class="s1">prcstring </span><span class="s3">= </span><span class="s4">''</span>
        <span class="s2">if not </span><span class="s1">use_wheels</span><span class="s3">:</span>
            <span class="s1">dtool_fn </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Filename</span><span class="s3">(</span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">ExecutionEnvironment</span><span class="s3">.</span><span class="s1">get_dtool_name</span><span class="s3">())</span>
            <span class="s1">libdir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">dtool_fn</span><span class="s3">.</span><span class="s1">to_os_specific</span><span class="s3">())</span>
            <span class="s1">etcdir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">libdir</span><span class="s3">, </span><span class="s4">'..'</span><span class="s3">, </span><span class="s4">'etc'</span><span class="s3">)</span>

            <span class="s1">etcfiles </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s1">etcdir</span><span class="s3">)</span>
            <span class="s1">etcfiles</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">reverse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">fn </span><span class="s2">in </span><span class="s1">etcfiles</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">fn</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">().</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.prc'</span><span class="s3">):</span>
                    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">etcdir</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">)) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                        <span class="s1">prcstring </span><span class="s3">+= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">etcfiles </span><span class="s3">= [</span><span class="s1">i </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">p3dwhl</span><span class="s3">.</span><span class="s1">namelist</span><span class="s3">() </span><span class="s2">if </span><span class="s1">i</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.prc'</span><span class="s3">)]</span>
            <span class="s1">etcfiles</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">reverse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">fn </span><span class="s2">in </span><span class="s1">etcfiles</span><span class="s3">:</span>
                <span class="s2">with </span><span class="s1">p3dwhl</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                    <span class="s1">prcstring </span><span class="s3">+= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">().</span><span class="s1">decode</span><span class="s3">(</span><span class="s4">'utf8'</span><span class="s3">)</span>

        <span class="s1">user_prcstring </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">extra_prc_data</span>
        <span class="s2">for </span><span class="s1">fn </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">extra_prc_files</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                <span class="s1">user_prcstring </span><span class="s3">+= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>

        <span class="s6"># Clenup PRC data</span>
        <span class="s1">check_plugins </span><span class="s3">= [</span>
            <span class="s6">#TODO find a better way to get this list</span>
            <span class="s4">'pandaegg'</span><span class="s3">,</span>
            <span class="s4">'p3ffmpeg'</span><span class="s3">,</span>
            <span class="s4">'p3ptloader'</span><span class="s3">,</span>
            <span class="s4">'p3assimp'</span><span class="s3">,</span>
        <span class="s3">]</span>
        <span class="s2">def </span><span class="s1">parse_prc</span><span class="s3">(</span><span class="s1">prcstr</span><span class="s3">, </span><span class="s1">warn_on_missing_plugin</span><span class="s3">):</span>
            <span class="s1">out </span><span class="s3">= []</span>
            <span class="s2">for </span><span class="s1">ln </span><span class="s2">in </span><span class="s1">prcstr</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">):</span>
                <span class="s1">ln </span><span class="s3">= </span><span class="s1">ln</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">()</span>
                <span class="s1">useline </span><span class="s3">= </span><span class="s2">True</span>

                <span class="s2">if </span><span class="s1">ln</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'#'</span><span class="s3">) </span><span class="s2">or not </span><span class="s1">ln</span><span class="s3">:</span>
                    <span class="s2">continue</span>

                <span class="s1">words </span><span class="s3">= </span><span class="s1">ln</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
                <span class="s2">if not </span><span class="s1">words</span><span class="s3">:</span>
                    <span class="s2">continue</span>
                <span class="s1">var </span><span class="s3">= </span><span class="s1">words</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
                <span class="s1">value </span><span class="s3">= </span><span class="s1">words</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] </span><span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">words</span><span class="s3">) &gt; </span><span class="s5">1 </span><span class="s2">else </span><span class="s4">''</span>

                <span class="s6"># Strip comment after value.</span>
                <span class="s1">c </span><span class="s3">= </span><span class="s1">value</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s4">' #'</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">c </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">:</span>
                    <span class="s1">value </span><span class="s3">= </span><span class="s1">value</span><span class="s3">[:</span><span class="s1">c</span><span class="s3">].</span><span class="s1">rstrip</span><span class="s3">()</span>

                <span class="s2">if </span><span class="s1">var </span><span class="s3">== </span><span class="s4">'model-cache-dir' </span><span class="s2">and </span><span class="s1">value</span><span class="s3">:</span>
                    <span class="s1">value </span><span class="s3">= </span><span class="s1">value</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'/panda3d'</span><span class="s3">, </span><span class="s4">'/{}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">distribution</span><span class="s3">.</span><span class="s1">get_name</span><span class="s3">()))</span>

                <span class="s2">if </span><span class="s1">var </span><span class="s3">== </span><span class="s4">'audio-library-name'</span><span class="s3">:</span>
                    <span class="s6"># We have the default set to p3fmod_audio on macOS in 1.10,</span>
                    <span class="s6"># but this can be unexpected as other platforms use OpenAL</span>
                    <span class="s6"># by default.  Switch it up if FMOD is not included.</span>
                    <span class="s2">if </span><span class="s1">value </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">plugins </span><span class="s2">and </span><span class="s1">value </span><span class="s3">== </span><span class="s4">'p3fmod_audio' </span><span class="s2">and </span><span class="s4">'p3openal_audio' </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">plugins</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s4">&quot;Missing audio plugin p3fmod_audio referenced in PRC data, replacing with p3openal_audio&quot;</span><span class="s3">)</span>
                        <span class="s1">value </span><span class="s3">= </span><span class="s4">'p3openal_audio'</span>

                <span class="s2">if </span><span class="s1">var </span><span class="s3">== </span><span class="s4">'aux-display'</span><span class="s3">:</span>
                    <span class="s6"># Silently remove aux-display lines for missing plugins.</span>
                    <span class="s2">if </span><span class="s1">value </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">plugins</span><span class="s3">:</span>
                        <span class="s2">continue</span>

                <span class="s2">for </span><span class="s1">plugin </span><span class="s2">in </span><span class="s1">check_plugins</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">plugin </span><span class="s2">in </span><span class="s1">value </span><span class="s2">and </span><span class="s1">plugin </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">plugins</span><span class="s3">:</span>
                        <span class="s1">useline </span><span class="s3">= </span><span class="s2">False</span>
                        <span class="s2">if </span><span class="s1">warn_on_missing_plugin</span><span class="s3">:</span>
                            <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span>
                                <span class="s4">&quot;Missing plugin ({0}) referenced in user PRC data&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">plugin</span><span class="s3">)</span>
                            <span class="s3">)</span>
                        <span class="s2">break</span>
                <span class="s2">if </span><span class="s1">useline</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">value</span><span class="s3">:</span>
                        <span class="s1">out</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">var </span><span class="s3">+ </span><span class="s4">' ' </span><span class="s3">+ </span><span class="s1">value</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">out</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">out</span>
        <span class="s1">prcexport </span><span class="s3">= </span><span class="s1">parse_prc</span><span class="s3">(</span><span class="s1">prcstring</span><span class="s3">, </span><span class="s5">0</span><span class="s3">) + </span><span class="s1">parse_prc</span><span class="s3">(</span><span class="s1">user_prcstring</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

        <span class="s6"># Export PRC data</span>
        <span class="s1">prcexport </span><span class="s3">= </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">prcexport</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">embed_prc_data</span><span class="s3">:</span>
            <span class="s1">prcdir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">default_prc_dir</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'&lt;auto&gt;'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">)</span>
            <span class="s1">prcdir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">builddir</span><span class="s3">, </span><span class="s1">prcdir</span><span class="s3">)</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">prcdir</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">open </span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">prcdir</span><span class="s3">, </span><span class="s4">'00-panda3d.prc'</span><span class="s3">), </span><span class="s4">'w'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">prcexport</span><span class="s3">)</span>

        <span class="s6"># Create runtimes</span>
        <span class="s1">freezer_extras </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s1">freezer_modules </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s1">freezer_modpaths </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s1">ext_suffixes </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>

        <span class="s2">def </span><span class="s1">get_search_path_for</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">):</span>
            <span class="s1">search_path </span><span class="s3">= [</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">)]</span>
            <span class="s2">if </span><span class="s1">use_wheels</span><span class="s3">:</span>
                <span class="s1">search_path</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">p3dwhlfn</span><span class="s3">, </span><span class="s4">'deploy_libs'</span><span class="s3">))</span>

                <span class="s6"># If the .whl containing this file has a .libs directory, add</span>
                <span class="s6"># it to the path.  This is an auditwheel/numpy convention.</span>
                <span class="s2">if </span><span class="s4">'.whl' </span><span class="s3">+ </span><span class="s1">os</span><span class="s3">.</span><span class="s1">sep </span><span class="s2">in </span><span class="s1">source_path</span><span class="s3">:</span>
                    <span class="s1">whl</span><span class="s3">, </span><span class="s1">wf </span><span class="s3">= </span><span class="s1">source_path</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'.whl' </span><span class="s3">+ </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">)</span>
                    <span class="s1">whl </span><span class="s3">+= </span><span class="s4">'.whl'</span>
                    <span class="s1">rootdir </span><span class="s3">= </span><span class="s1">wf</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
                    <span class="s1">search_path</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">whl</span><span class="s3">, </span><span class="s1">rootdir</span><span class="s3">, </span><span class="s4">'.libs'</span><span class="s3">))</span>

                    <span class="s6"># Also look for eg. numpy.libs or Pillow.libs in the root</span>
                    <span class="s1">whl_name </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">whl</span><span class="s3">).</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'-'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
                    <span class="s1">search_path</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">whl</span><span class="s3">, </span><span class="s1">whl_name </span><span class="s3">+ </span><span class="s4">'.libs'</span><span class="s3">))</span>

                    <span class="s6"># Also look for more specific per-package cases, defined in</span>
                    <span class="s6"># PACKAGE_LIB_DIRS at the top of this file.</span>
                    <span class="s1">extra_dirs </span><span class="s3">= </span><span class="s1">PACKAGE_LIB_DIRS</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">whl_name</span><span class="s3">, [])</span>
                    <span class="s2">for </span><span class="s1">extra_dir</span><span class="s3">, </span><span class="s1">search_in </span><span class="s2">in </span><span class="s1">extra_dirs</span><span class="s3">:</span>
                        <span class="s2">if not </span><span class="s1">search_in</span><span class="s3">:</span>
                            <span class="s1">search_path</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">whl</span><span class="s3">, </span><span class="s1">extra_dir</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'/'</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">)))</span>
                        <span class="s2">else</span><span class="s3">:</span>
                            <span class="s2">for </span><span class="s1">whl2 </span><span class="s2">in </span><span class="s1">wheelpaths</span><span class="s3">:</span>
                                <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">whl2</span><span class="s3">).</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">search_in </span><span class="s3">+ </span><span class="s4">'-'</span><span class="s3">):</span>
                                    <span class="s1">search_path</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">whl2</span><span class="s3">, </span><span class="s1">extra_dir</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'/'</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">)))</span>

            <span class="s2">return </span><span class="s1">search_path</span>

        <span class="s2">def </span><span class="s1">create_runtime</span><span class="s3">(</span><span class="s1">appname</span><span class="s3">, </span><span class="s1">mainscript</span><span class="s3">, </span><span class="s1">use_console</span><span class="s3">):</span>
            <span class="s1">site_py </span><span class="s3">= </span><span class="s1">SITE_PY</span>
            <span class="s2">if not </span><span class="s1">has_tkinter_wheel</span><span class="s3">:</span>
                <span class="s6"># Legacy handling for Tcl data files</span>
                <span class="s1">site_py </span><span class="s3">+= </span><span class="s1">SITE_PY_TKINTER_ADDENDUM</span>

            <span class="s1">optimize </span><span class="s3">= </span><span class="s5">2 </span><span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strip_docstrings </span><span class="s2">else </span><span class="s5">1</span>

            <span class="s1">freezer </span><span class="s3">= </span><span class="s1">FreezeTool</span><span class="s3">.</span><span class="s1">Freezer</span><span class="s3">(</span><span class="s1">platform</span><span class="s3">=</span><span class="s1">platform</span><span class="s3">, </span><span class="s1">path</span><span class="s3">=</span><span class="s1">path</span><span class="s3">, </span><span class="s1">optimize</span><span class="s3">=</span><span class="s1">optimize</span><span class="s3">)</span>
            <span class="s1">freezer</span><span class="s3">.</span><span class="s1">addModule</span><span class="s3">(</span><span class="s4">'__main__'</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">=</span><span class="s1">mainscript</span><span class="s3">)</span>
            <span class="s1">freezer</span><span class="s3">.</span><span class="s1">addModule</span><span class="s3">(</span><span class="s4">'site'</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">=</span><span class="s4">'site.py'</span><span class="s3">, </span><span class="s1">text</span><span class="s3">=</span><span class="s1">site_py</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">incmod </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">include_modules</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">appname</span><span class="s3">, []) + </span><span class="s1">self</span><span class="s3">.</span><span class="s1">include_modules</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'*'</span><span class="s3">, []):</span>
                <span class="s1">freezer</span><span class="s3">.</span><span class="s1">addModule</span><span class="s3">(</span><span class="s1">incmod</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">exmod </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">exclude_modules</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">appname</span><span class="s3">, []) + </span><span class="s1">self</span><span class="s3">.</span><span class="s1">exclude_modules</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'*'</span><span class="s3">, []):</span>
                <span class="s1">freezer</span><span class="s3">.</span><span class="s1">excludeModule</span><span class="s3">(</span><span class="s1">exmod</span><span class="s3">)</span>
            <span class="s1">freezer</span><span class="s3">.</span><span class="s1">done</span><span class="s3">(</span><span class="s1">addStartupModules</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

            <span class="s1">target_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">builddir</span><span class="s3">, </span><span class="s1">appname</span><span class="s3">)</span>

            <span class="s1">stub_name </span><span class="s3">= </span><span class="s4">'deploy-stub'</span>
            <span class="s2">if </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'win'</span><span class="s3">) </span><span class="s2">or </span><span class="s4">'macosx' </span><span class="s2">in </span><span class="s1">platform</span><span class="s3">:</span>
                <span class="s2">if not </span><span class="s1">use_console</span><span class="s3">:</span>
                    <span class="s1">stub_name </span><span class="s3">= </span><span class="s4">'deploy-stubw'</span>

            <span class="s2">if </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'win'</span><span class="s3">):</span>
                <span class="s1">stub_name </span><span class="s3">+= </span><span class="s4">'.exe'</span>
                <span class="s1">target_path </span><span class="s3">+= </span><span class="s4">'.exe'</span>

            <span class="s2">if </span><span class="s1">use_wheels</span><span class="s3">:</span>
                <span class="s1">stub_file </span><span class="s3">= </span><span class="s1">p3dwhl</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s4">'panda3d_tools/{0}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">stub_name</span><span class="s3">))</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">dtool_path </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Filename</span><span class="s3">(</span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">ExecutionEnvironment</span><span class="s3">.</span><span class="s1">get_dtool_name</span><span class="s3">()).</span><span class="s1">to_os_specific</span><span class="s3">()</span>
                <span class="s1">stub_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">dtool_path</span><span class="s3">), </span><span class="s4">'..'</span><span class="s3">, </span><span class="s4">'bin'</span><span class="s3">, </span><span class="s1">stub_name</span><span class="s3">)</span>
                <span class="s1">stub_file </span><span class="s3">= </span><span class="s1">open</span><span class="s3">(</span><span class="s1">stub_path</span><span class="s3">, </span><span class="s4">'rb'</span><span class="s3">)</span>

            <span class="s6"># Do we need an icon?  On Windows, we need to add this to the stub</span>
            <span class="s6"># before we add the blob.</span>
            <span class="s2">if </span><span class="s4">'win' </span><span class="s2">in </span><span class="s1">platform</span><span class="s3">:</span>
                <span class="s1">temp_file </span><span class="s3">= </span><span class="s1">tempfile</span><span class="s3">.</span><span class="s1">NamedTemporaryFile</span><span class="s3">(</span><span class="s1">suffix</span><span class="s3">=</span><span class="s4">'-icon.exe'</span><span class="s3">, </span><span class="s1">delete</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
                <span class="s1">temp_file</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">stub_file</span><span class="s3">.</span><span class="s1">read</span><span class="s3">())</span>
                <span class="s1">stub_file</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
                <span class="s1">temp_file</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">update_pe_resources</span><span class="s3">(</span><span class="s1">appname</span><span class="s3">, </span><span class="s1">temp_file</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>
                <span class="s1">stub_file </span><span class="s3">= </span><span class="s1">open</span><span class="s3">(</span><span class="s1">temp_file</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s4">'rb'</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">temp_file </span><span class="s3">= </span><span class="s2">None</span>

            <span class="s1">freezer</span><span class="s3">.</span><span class="s1">generateRuntimeFromStub</span><span class="s3">(</span><span class="s1">target_path</span><span class="s3">, </span><span class="s1">stub_file</span><span class="s3">, </span><span class="s1">use_console</span><span class="s3">, {</span>
                <span class="s4">'prc_data'</span><span class="s3">: </span><span class="s1">prcexport </span><span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">embed_prc_data </span><span class="s2">else None</span><span class="s3">,</span>
                <span class="s4">'default_prc_dir'</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">default_prc_dir</span><span class="s3">,</span>
                <span class="s4">'prc_dir_envvars'</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
                <span class="s4">'prc_path_envvars'</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
                <span class="s4">'prc_patterns'</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
                <span class="s4">'prc_encrypted_patterns'</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
                <span class="s4">'prc_encryption_key'</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
                <span class="s4">'prc_executable_patterns'</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
                <span class="s4">'prc_executable_args_envvar'</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
                <span class="s4">'main_dir'</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
                <span class="s4">'log_filename'</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">expand_path</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">log_filename</span><span class="s3">, </span><span class="s1">platform</span><span class="s3">),</span>
            <span class="s3">}, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">log_append</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">log_filename_strftime</span><span class="s3">)</span>
            <span class="s1">stub_file</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

            <span class="s2">if </span><span class="s1">temp_file</span><span class="s3">:</span>
                <span class="s1">os</span><span class="s3">.</span><span class="s1">unlink</span><span class="s3">(</span><span class="s1">temp_file</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>

            <span class="s6"># Copy the dependencies.</span>
            <span class="s1">search_path </span><span class="s3">= [</span><span class="s1">builddir</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">use_wheels</span><span class="s3">:</span>
                <span class="s1">search_path</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">p3dwhlfn</span><span class="s3">, </span><span class="s4">'deploy_libs'</span><span class="s3">))</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">copy_dependencies</span><span class="s3">(</span><span class="s1">target_path</span><span class="s3">, </span><span class="s1">builddir</span><span class="s3">, </span><span class="s1">search_path</span><span class="s3">, </span><span class="s1">stub_name</span><span class="s3">)</span>

            <span class="s1">freezer_extras</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">freezer</span><span class="s3">.</span><span class="s1">extras</span><span class="s3">)</span>
            <span class="s1">freezer_modules</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">freezer</span><span class="s3">.</span><span class="s1">getAllModuleNames</span><span class="s3">())</span>
            <span class="s1">freezer_modpaths</span><span class="s3">.</span><span class="s1">update</span><span class="s3">({</span>
                <span class="s1">mod</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s1">filename</span><span class="s3">.</span><span class="s1">to_os_specific</span><span class="s3">()</span>
                <span class="s2">for </span><span class="s1">mod </span><span class="s2">in </span><span class="s1">freezer</span><span class="s3">.</span><span class="s1">getModuleDefs</span><span class="s3">() </span><span class="s2">if </span><span class="s1">mod</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s1">filename</span>
            <span class="s3">})</span>
            <span class="s2">for </span><span class="s1">suffix </span><span class="s2">in </span><span class="s1">freezer</span><span class="s3">.</span><span class="s1">moduleSuffixes</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">suffix</span><span class="s3">[</span><span class="s5">2</span><span class="s3">] == </span><span class="s1">imp</span><span class="s3">.</span><span class="s1">C_EXTENSION</span><span class="s3">:</span>
                    <span class="s1">ext_suffixes</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">suffix</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>

        <span class="s2">for </span><span class="s1">appname</span><span class="s3">, </span><span class="s1">scriptname </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">gui_apps</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s1">create_runtime</span><span class="s3">(</span><span class="s1">appname</span><span class="s3">, </span><span class="s1">scriptname</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">appname</span><span class="s3">, </span><span class="s1">scriptname </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">console_apps</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s1">create_runtime</span><span class="s3">(</span><span class="s1">appname</span><span class="s3">, </span><span class="s1">scriptname</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

        <span class="s6"># Warn if tkinter is used but hasn't been added to requirements.txt</span>
        <span class="s2">if not </span><span class="s1">has_tkinter_wheel </span><span class="s2">and </span><span class="s4">'_tkinter' </span><span class="s2">in </span><span class="s1">freezer_modules</span><span class="s3">:</span>
            <span class="s6"># The on-windows-for-windows case is handled as legacy below</span>
            <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">!= </span><span class="s4">&quot;win32&quot; </span><span class="s2">or not </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'win'</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s4">&quot;Detected use of tkinter, but tkinter is not specified in requirements.txt!&quot;</span><span class="s3">)</span>

        <span class="s6"># Copy extension modules</span>
        <span class="s1">whl_modules </span><span class="s3">= []</span>
        <span class="s1">whl_modules_ext </span><span class="s3">= </span><span class="s4">''</span>
        <span class="s2">if </span><span class="s1">use_wheels</span><span class="s3">:</span>
            <span class="s6"># Get the module libs</span>
            <span class="s1">whl_modules </span><span class="s3">= []</span>

            <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">p3dwhl</span><span class="s3">.</span><span class="s1">namelist</span><span class="s3">():</span>
                <span class="s2">if not </span><span class="s1">i</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'deploy_libs/'</span><span class="s3">):</span>
                    <span class="s2">continue</span>

                <span class="s2">if not </span><span class="s1">any</span><span class="s3">(</span><span class="s1">i</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s1">suffix</span><span class="s3">) </span><span class="s2">for </span><span class="s1">suffix </span><span class="s2">in </span><span class="s1">ext_suffixes</span><span class="s3">):</span>
                    <span class="s2">continue</span>

                <span class="s2">if </span><span class="s1">has_tkinter_wheel </span><span class="s2">and </span><span class="s1">i</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'deploy_libs/_tkinter.'</span><span class="s3">):</span>
                    <span class="s6"># Ignore this one, we have a separate tkinter package</span>
                    <span class="s6"># nowadays that contains all the dependencies.</span>
                    <span class="s2">continue</span>

                <span class="s1">base </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">i</span><span class="s3">)</span>
                <span class="s1">module</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">ext </span><span class="s3">= </span><span class="s1">base</span><span class="s3">.</span><span class="s1">partition</span><span class="s3">(</span><span class="s4">'.'</span><span class="s3">)</span>
                <span class="s1">whl_modules</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">module</span><span class="s3">)</span>
                <span class="s1">whl_modules_ext </span><span class="s3">= </span><span class="s1">ext</span>

        <span class="s6"># Make sure to copy any builtins that have shared objects in the</span>
        <span class="s6"># deploy libs, assuming they are not already in freezer_extras.</span>
        <span class="s2">for </span><span class="s1">mod</span><span class="s3">, </span><span class="s1">source_path </span><span class="s2">in </span><span class="s1">freezer_extras</span><span class="s3">:</span>
            <span class="s1">freezer_modules</span><span class="s3">.</span><span class="s1">discard</span><span class="s3">(</span><span class="s1">mod</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">mod </span><span class="s2">in </span><span class="s1">freezer_modules</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">mod </span><span class="s2">in </span><span class="s1">whl_modules</span><span class="s3">:</span>
                <span class="s1">freezer_extras</span><span class="s3">.</span><span class="s1">add</span><span class="s3">((</span><span class="s1">mod</span><span class="s3">, </span><span class="s2">None</span><span class="s3">))</span>

        <span class="s6"># Copy over necessary plugins</span>
        <span class="s1">plugin_list </span><span class="s3">= [</span><span class="s4">'panda3d/lib{}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">i</span><span class="s3">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">plugins</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">lib </span><span class="s2">in </span><span class="s1">p3dwhl</span><span class="s3">.</span><span class="s1">namelist</span><span class="s3">():</span>
            <span class="s1">plugname </span><span class="s3">= </span><span class="s1">lib</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'.'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">plugname </span><span class="s2">in </span><span class="s1">plugin_list</span><span class="s3">:</span>
                <span class="s1">source_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">p3dwhlfn</span><span class="s3">, </span><span class="s1">lib</span><span class="s3">)</span>
                <span class="s1">target_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">builddir</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">lib</span><span class="s3">))</span>
                <span class="s1">search_path </span><span class="s3">= [</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">)]</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">copy_with_dependencies</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">, </span><span class="s1">target_path</span><span class="s3">, </span><span class="s1">search_path</span><span class="s3">)</span>

        <span class="s6"># Copy any shared objects we need</span>
        <span class="s2">for </span><span class="s1">module</span><span class="s3">, </span><span class="s1">source_path </span><span class="s2">in </span><span class="s1">freezer_extras</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">source_path </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s6"># Rename panda3d/core.pyd to panda3d.core.pyd</span>
                <span class="s1">source_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">normpath</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">)</span>
                <span class="s1">basename </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s4">'.' </span><span class="s2">in </span><span class="s1">module</span><span class="s3">:</span>
                    <span class="s1">basename </span><span class="s3">= </span><span class="s1">module</span><span class="s3">.</span><span class="s1">rsplit</span><span class="s3">(</span><span class="s4">'.'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">] + </span><span class="s4">'.' </span><span class="s3">+ </span><span class="s1">basename</span>

                <span class="s6"># Remove python version string</span>
                <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&gt;= (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">0</span><span class="s3">):</span>
                    <span class="s1">parts </span><span class="s3">= </span><span class="s1">basename</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'.'</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">) &gt;= </span><span class="s5">3 </span><span class="s2">and </span><span class="s4">'-' </span><span class="s2">in </span><span class="s1">parts</span><span class="s3">[-</span><span class="s5">2</span><span class="s3">]:</span>
                        <span class="s1">parts </span><span class="s3">= </span><span class="s1">parts</span><span class="s3">[:-</span><span class="s5">2</span><span class="s3">] + </span><span class="s1">parts</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">:]</span>
                        <span class="s1">basename </span><span class="s3">= </span><span class="s4">'.'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">)</span>

                <span class="s6"># Was this not found in a wheel?  Then we may have a problem,</span>
                <span class="s6"># since it may be for the current platform instead of the target</span>
                <span class="s6"># platform.</span>
                <span class="s2">if </span><span class="s1">use_wheels</span><span class="s3">:</span>
                    <span class="s1">found_in_wheel </span><span class="s3">= </span><span class="s2">False</span>
                    <span class="s2">for </span><span class="s1">whl </span><span class="s2">in </span><span class="s1">wheelpaths</span><span class="s3">:</span>
                        <span class="s1">whl </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">normpath</span><span class="s3">(</span><span class="s1">whl</span><span class="s3">)</span>
                        <span class="s2">if </span><span class="s1">source_path</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">().</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">whl</span><span class="s3">, </span><span class="s4">''</span><span class="s3">).</span><span class="s1">lower</span><span class="s3">()):</span>
                            <span class="s1">found_in_wheel </span><span class="s3">= </span><span class="s2">True</span>
                            <span class="s2">break</span>

                    <span class="s2">if not </span><span class="s1">found_in_wheel</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s4">'{} was not found in any downloaded wheel, is a dependency missing from requirements.txt?'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">basename</span><span class="s3">))</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s6"># Builtin module, but might not be builtin in wheel libs, so double check</span>
                <span class="s2">if </span><span class="s1">module </span><span class="s2">in </span><span class="s1">whl_modules</span><span class="s3">:</span>
                    <span class="s1">source_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">p3dwhlfn</span><span class="s3">, </span><span class="s4">'deploy_libs/{}.{}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">module</span><span class="s3">, </span><span class="s1">whl_modules_ext</span><span class="s3">))</span><span class="s6">#'{0}/deploy_libs/{1}.{2}'.format(p3dwhlfn, module, whl_modules_ext)</span>
                    <span class="s1">basename </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">)</span>
                    <span class="s6">#XXX should we remove python version string here too?</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s2">continue</span>

            <span class="s6"># If this is a dynamic library, search for dependencies.</span>
            <span class="s1">target_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">builddir</span><span class="s3">, </span><span class="s1">basename</span><span class="s3">)</span>
            <span class="s1">search_path </span><span class="s3">= </span><span class="s1">get_search_path_for</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">copy_with_dependencies</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">, </span><span class="s1">target_path</span><span class="s3">, </span><span class="s1">search_path</span><span class="s3">)</span>

        <span class="s6"># Copy over the tcl directory.</span>
        <span class="s6"># This is legacy, we nowadays recommend the separate tkinter wheel.</span>
        <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">== </span><span class="s4">&quot;win32&quot; </span><span class="s2">and </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'win'</span><span class="s3">) </span><span class="s2">and not </span><span class="s1">has_tkinter_wheel</span><span class="s3">:</span>
            <span class="s1">tcl_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">prefix</span><span class="s3">, </span><span class="s4">'tcl'</span><span class="s3">)</span>
            <span class="s1">tkinter_name </span><span class="s3">= </span><span class="s4">'tkinter' </span><span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&gt;= (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">0</span><span class="s3">) </span><span class="s2">else </span><span class="s4">'Tkinter'</span>

            <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">tcl_dir</span><span class="s3">) </span><span class="s2">and </span><span class="s1">tkinter_name </span><span class="s2">in </span><span class="s1">freezer_modules</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'Copying Tcl files'</span><span class="s3">, </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">log</span><span class="s3">.</span><span class="s1">INFO</span><span class="s3">)</span>
                <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">builddir</span><span class="s3">, </span><span class="s4">'tcl'</span><span class="s3">))</span>

                <span class="s2">for </span><span class="s1">dir </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s1">tcl_dir</span><span class="s3">):</span>
                    <span class="s1">sub_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">tcl_dir</span><span class="s3">, </span><span class="s1">dir</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">sub_dir</span><span class="s3">):</span>
                        <span class="s1">target_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">builddir</span><span class="s3">, </span><span class="s4">'tcl'</span><span class="s3">, </span><span class="s1">dir</span><span class="s3">)</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'copying {0} -&gt; {1}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">sub_dir</span><span class="s3">, </span><span class="s1">target_dir</span><span class="s3">))</span>
                        <span class="s1">shutil</span><span class="s3">.</span><span class="s1">copytree</span><span class="s3">(</span><span class="s1">sub_dir</span><span class="s3">, </span><span class="s1">target_dir</span><span class="s3">)</span>

        <span class="s6"># Extract any other data files from dependency packages.</span>
        <span class="s2">for </span><span class="s1">module</span><span class="s3">, </span><span class="s1">datadesc </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">package_data_dirs</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s1">module </span><span class="s2">not in </span><span class="s1">freezer_modules</span><span class="s3">:</span>
                <span class="s2">continue</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'Copying data files for module: {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">module</span><span class="s3">), </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">log</span><span class="s3">.</span><span class="s1">INFO</span><span class="s3">)</span>

            <span class="s6"># OK, find out in which .whl this occurs.</span>
            <span class="s2">for </span><span class="s1">whl </span><span class="s2">in </span><span class="s1">wheelpaths</span><span class="s3">:</span>
                <span class="s1">whlfile </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_zip_file</span><span class="s3">(</span><span class="s1">whl</span><span class="s3">)</span>
                <span class="s1">filenames </span><span class="s3">= </span><span class="s1">whlfile</span><span class="s3">.</span><span class="s1">namelist</span><span class="s3">()</span>
                <span class="s2">for </span><span class="s1">source_pattern</span><span class="s3">, </span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">flags </span><span class="s2">in </span><span class="s1">datadesc</span><span class="s3">:</span>
                    <span class="s1">srcglob </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">GlobPattern</span><span class="s3">(</span><span class="s1">source_pattern</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">())</span>
                    <span class="s1">source_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">source_pattern</span><span class="s3">)</span>
                    <span class="s6"># Relocate the target dir to the build directory.</span>
                    <span class="s1">target_dir </span><span class="s3">= </span><span class="s1">target_dir</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'/'</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">)</span>
                    <span class="s1">target_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">builddir</span><span class="s3">, </span><span class="s1">target_dir</span><span class="s3">)</span>

                    <span class="s2">for </span><span class="s1">wf </span><span class="s2">in </span><span class="s1">filenames</span><span class="s3">:</span>
                        <span class="s2">if </span><span class="s1">wf</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'/'</span><span class="s3">):</span>
                            <span class="s6"># Skip directories.</span>
                            <span class="s2">continue</span>

                        <span class="s2">if </span><span class="s1">wf</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">().</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">source_dir</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() + </span><span class="s4">'/'</span><span class="s3">):</span>
                            <span class="s2">if not </span><span class="s1">srcglob</span><span class="s3">.</span><span class="s1">matches</span><span class="s3">(</span><span class="s1">wf</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()):</span>
                                <span class="s2">continue</span>

                            <span class="s1">wf </span><span class="s3">= </span><span class="s1">wf</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'/'</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">)</span>
                            <span class="s1">relpath </span><span class="s3">= </span><span class="s1">wf</span><span class="s3">[</span><span class="s1">len</span><span class="s3">(</span><span class="s1">source_dir</span><span class="s3">) + </span><span class="s5">1</span><span class="s3">:]</span>
                            <span class="s1">source_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">whl</span><span class="s3">, </span><span class="s1">wf</span><span class="s3">)</span>
                            <span class="s1">target_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">relpath</span><span class="s3">)</span>

                            <span class="s2">if </span><span class="s4">'PKG_DATA_MAKE_EXECUTABLE' </span><span class="s2">in </span><span class="s1">flags</span><span class="s3">:</span>
                                <span class="s1">search_path </span><span class="s3">= </span><span class="s1">get_search_path_for</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">)</span>
                                <span class="s1">self</span><span class="s3">.</span><span class="s1">copy_with_dependencies</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">, </span><span class="s1">target_path</span><span class="s3">, </span><span class="s1">search_path</span><span class="s3">)</span>
                                <span class="s1">mode </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">stat</span><span class="s3">(</span><span class="s1">target_path</span><span class="s3">).</span><span class="s1">st_mode</span>
                                <span class="s1">mode </span><span class="s3">|= </span><span class="s1">stat</span><span class="s3">.</span><span class="s1">S_IXUSR </span><span class="s3">| </span><span class="s1">stat</span><span class="s3">.</span><span class="s1">S_IXGRP </span><span class="s3">| </span><span class="s1">stat</span><span class="s3">.</span><span class="s1">S_IXOTH</span>
                                <span class="s1">os</span><span class="s3">.</span><span class="s1">chmod</span><span class="s3">(</span><span class="s1">target_path</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">)</span>
                            <span class="s2">else</span><span class="s3">:</span>
                                <span class="s1">self</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">, </span><span class="s1">target_path</span><span class="s3">)</span>

        <span class="s6"># Copy Game Files</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'Copying game files for platform: {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">platform</span><span class="s3">), </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">log</span><span class="s3">.</span><span class="s1">INFO</span><span class="s3">)</span>
        <span class="s1">ignore_copy_list </span><span class="s3">= [</span>
            <span class="s4">'**/__pycache__/**'</span><span class="s3">,</span>
            <span class="s4">'**/*.pyc'</span><span class="s3">,</span>
            <span class="s4">'{}/**'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_base</span><span class="s3">),</span>
        <span class="s3">]</span>
        <span class="s1">ignore_copy_list </span><span class="s3">+= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">exclude_patterns</span>
        <span class="s1">ignore_copy_list </span><span class="s3">+= </span><span class="s1">freezer_modpaths</span>
        <span class="s1">ignore_copy_list </span><span class="s3">+= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">extra_prc_files</span>
        <span class="s1">ignore_copy_list </span><span class="s3">= [</span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">GlobPattern</span><span class="s3">(</span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Filename</span><span class="s3">.</span><span class="s1">from_os_specific</span><span class="s3">(</span><span class="s1">i</span><span class="s3">).</span><span class="s1">get_fullpath</span><span class="s3">()) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">ignore_copy_list</span><span class="s3">]</span>

        <span class="s1">include_copy_list </span><span class="s3">= [</span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">GlobPattern</span><span class="s3">(</span><span class="s1">i</span><span class="s3">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">include_patterns</span><span class="s3">]</span>

        <span class="s2">def </span><span class="s1">check_pattern</span><span class="s3">(</span><span class="s1">src</span><span class="s3">, </span><span class="s1">pattern_list</span><span class="s3">):</span>
            <span class="s6"># Normalize file paths across platforms</span>
            <span class="s1">fn </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Filename</span><span class="s3">.</span><span class="s1">from_os_specific</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">normpath</span><span class="s3">(</span><span class="s1">src</span><span class="s3">))</span>
            <span class="s1">path </span><span class="s3">= </span><span class="s1">fn</span><span class="s3">.</span><span class="s1">get_fullpath</span><span class="s3">()</span>
            <span class="s1">fn</span><span class="s3">.</span><span class="s1">make_absolute</span><span class="s3">()</span>
            <span class="s1">abspath </span><span class="s3">= </span><span class="s1">fn</span><span class="s3">.</span><span class="s1">get_fullpath</span><span class="s3">()</span>

            <span class="s2">for </span><span class="s1">pattern </span><span class="s2">in </span><span class="s1">pattern_list</span><span class="s3">:</span>
                <span class="s6"># If the pattern is absolute, match against the absolute filename.</span>
                <span class="s2">if </span><span class="s1">pattern</span><span class="s3">.</span><span class="s1">pattern</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s4">'/'</span><span class="s3">:</span>
                    <span class="s6">#print('check ignore: {} {} {}'.format(pattern, src, pattern.matches_file(abspath)))</span>
                    <span class="s2">if </span><span class="s1">pattern</span><span class="s3">.</span><span class="s1">matches_file</span><span class="s3">(</span><span class="s1">abspath</span><span class="s3">):</span>
                        <span class="s2">return True</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s6">#print('check ignore: {} {} {}'.format(pattern, src, pattern.matches_file(path)))</span>
                    <span class="s2">if </span><span class="s1">pattern</span><span class="s3">.</span><span class="s1">matches_file</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
                        <span class="s2">return True</span>
            <span class="s2">return False</span>

        <span class="s2">def </span><span class="s1">check_file</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">check_pattern</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">include_copy_list</span><span class="s3">) </span><span class="s2">and </span><span class="s1">\</span>
                <span class="s2">not </span><span class="s1">check_pattern</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">ignore_copy_list</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">skip_directory</span><span class="s3">(</span><span class="s1">src</span><span class="s3">):</span>
            <span class="s6"># Provides a quick-out for directory checks.  NOT recursive.</span>
            <span class="s1">fn </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Filename</span><span class="s3">.</span><span class="s1">from_os_specific</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">normpath</span><span class="s3">(</span><span class="s1">src</span><span class="s3">))</span>
            <span class="s1">path </span><span class="s3">= </span><span class="s1">fn</span><span class="s3">.</span><span class="s1">get_fullpath</span><span class="s3">()</span>
            <span class="s1">fn</span><span class="s3">.</span><span class="s1">make_absolute</span><span class="s3">()</span>
            <span class="s1">abspath </span><span class="s3">= </span><span class="s1">fn</span><span class="s3">.</span><span class="s1">get_fullpath</span><span class="s3">()</span>

            <span class="s2">for </span><span class="s1">pattern </span><span class="s2">in </span><span class="s1">ignore_copy_list</span><span class="s3">:</span>
                <span class="s2">if not </span><span class="s1">pattern</span><span class="s3">.</span><span class="s1">pattern</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'/*'</span><span class="s3">) </span><span class="s2">and </span><span class="s1">\</span>
                   <span class="s2">not </span><span class="s1">pattern</span><span class="s3">.</span><span class="s1">pattern</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'/**'</span><span class="s3">):</span>
                    <span class="s2">continue</span>

                <span class="s1">pattern_dir </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Filename</span><span class="s3">(</span><span class="s1">pattern</span><span class="s3">.</span><span class="s1">pattern</span><span class="s3">).</span><span class="s1">get_dirname</span><span class="s3">()</span>
                <span class="s2">if </span><span class="s1">abspath</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">pattern_dir </span><span class="s3">+ </span><span class="s4">'/'</span><span class="s3">):</span>
                    <span class="s2">return True</span>

                <span class="s2">if </span><span class="s1">path</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">pattern_dir </span><span class="s3">+ </span><span class="s4">'/'</span><span class="s3">):</span>
                    <span class="s2">return True</span>

            <span class="s2">return False</span>

        <span class="s2">def </span><span class="s1">copy_file</span><span class="s3">(</span><span class="s1">src</span><span class="s3">, </span><span class="s1">dst</span><span class="s3">):</span>
            <span class="s1">src </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">normpath</span><span class="s3">(</span><span class="s1">src</span><span class="s3">)</span>
            <span class="s1">dst </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">normpath</span><span class="s3">(</span><span class="s1">dst</span><span class="s3">)</span>

            <span class="s2">if not </span><span class="s1">check_file</span><span class="s3">(</span><span class="s1">src</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'skipping file {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">src</span><span class="s3">))</span>
                <span class="s2">return</span>

            <span class="s1">dst_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">dst</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">dst_dir</span><span class="s3">):</span>
                <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">dst_dir</span><span class="s3">)</span>

            <span class="s1">ext </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">splitext</span><span class="s3">(</span><span class="s1">src</span><span class="s3">)[</span><span class="s5">1</span><span class="s3">]</span>
            <span class="s6"># If the file ends with .gz/.pz, we strip this off.</span>
            <span class="s2">if </span><span class="s1">ext </span><span class="s2">in </span><span class="s3">(</span><span class="s4">'.gz'</span><span class="s3">, </span><span class="s4">'.pz'</span><span class="s3">):</span>
                <span class="s1">ext </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">splitext</span><span class="s3">(</span><span class="s1">src</span><span class="s3">[:-</span><span class="s5">3</span><span class="s3">])[</span><span class="s5">1</span><span class="s3">]</span>
            <span class="s2">if not </span><span class="s1">ext</span><span class="s3">:</span>
                <span class="s1">ext </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">src</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">ext </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">file_handlers</span><span class="s3">:</span>
                <span class="s1">buildscript </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">file_handlers</span><span class="s3">[</span><span class="s1">ext</span><span class="s3">]</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'running {} on src ({})'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">buildscript</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">, </span><span class="s1">src</span><span class="s3">))</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">dst </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">file_handlers</span><span class="s3">[</span><span class="s1">ext</span><span class="s3">](</span><span class="s1">self</span><span class="s3">, </span><span class="s1">src</span><span class="s3">, </span><span class="s1">dst</span><span class="s3">)</span>
                <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'{}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">err</span><span class="s3">), </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">log</span><span class="s3">.</span><span class="s1">ERROR</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'copying {0} -&gt; {1}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">src</span><span class="s3">, </span><span class="s1">dst</span><span class="s3">))</span>
                <span class="s1">shutil</span><span class="s3">.</span><span class="s1">copyfile</span><span class="s3">(</span><span class="s1">src</span><span class="s3">, </span><span class="s1">dst</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">update_path</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
            <span class="s1">normpath </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Filename</span><span class="s3">.</span><span class="s1">from_os_specific</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">normpath</span><span class="s3">(</span><span class="s1">src</span><span class="s3">)).</span><span class="s1">c_str</span><span class="s3">()</span>
            <span class="s2">for </span><span class="s1">inputpath</span><span class="s3">, </span><span class="s1">outputpath </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rename_paths</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                <span class="s2">if </span><span class="s1">normpath</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">inputpath</span><span class="s3">):</span>
                    <span class="s1">normpath </span><span class="s3">= </span><span class="s1">normpath</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">inputpath</span><span class="s3">, </span><span class="s1">outputpath</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Filename</span><span class="s3">(</span><span class="s1">normpath</span><span class="s3">).</span><span class="s1">to_os_specific</span><span class="s3">()</span>

        <span class="s1">rootdir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">getcwd</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">dirname</span><span class="s3">, </span><span class="s1">subdirlist</span><span class="s3">, </span><span class="s1">filelist </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">walk</span><span class="s3">(</span><span class="s1">rootdir</span><span class="s3">):</span>
            <span class="s1">subdirlist</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">()</span>
            <span class="s1">dirpath </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">relpath</span><span class="s3">(</span><span class="s1">dirname</span><span class="s3">, </span><span class="s1">rootdir</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">skip_directory</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'skipping directory {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">))</span>
                <span class="s2">continue</span>

            <span class="s2">for </span><span class="s1">fname </span><span class="s2">in </span><span class="s1">filelist</span><span class="s3">:</span>
                <span class="s1">src </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">, </span><span class="s1">fname</span><span class="s3">)</span>
                <span class="s1">dst </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">builddir</span><span class="s3">, </span><span class="s1">update_path</span><span class="s3">(</span><span class="s1">src</span><span class="s3">))</span>

                <span class="s1">copy_file</span><span class="s3">(</span><span class="s1">src</span><span class="s3">, </span><span class="s1">dst</span><span class="s3">)</span>

        <span class="s6"># Bundle into an .app on macOS</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">macos_main_app </span><span class="s2">and </span><span class="s4">'macosx' </span><span class="s2">in </span><span class="s1">platform</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">bundle_macos_app</span><span class="s3">(</span><span class="s1">builddir</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">add_dependency</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">search_path</span><span class="s3">, </span><span class="s1">referenced_by</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Searches for the given DLL on the search path.  If it exists, 
        copies it to the target_dir. &quot;&quot;&quot;</span>

        <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)):</span>
            <span class="s6"># We've already added it earlier.</span>
            <span class="s2">return</span>

        <span class="s2">for </span><span class="s1">dep </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">exclude_dependencies</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">dep</span><span class="s3">.</span><span class="s1">matches_file</span><span class="s3">(</span><span class="s1">name</span><span class="s3">):</span>
                <span class="s2">return</span>

        <span class="s2">for </span><span class="s1">dir </span><span class="s2">in </span><span class="s1">search_path</span><span class="s3">:</span>
            <span class="s1">source_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">):</span>
                <span class="s1">target_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">copy_with_dependencies</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">, </span><span class="s1">target_path</span><span class="s3">, </span><span class="s1">search_path</span><span class="s3">)</span>
                <span class="s2">return</span>

            <span class="s2">elif </span><span class="s4">'.whl' </span><span class="s2">in </span><span class="s1">source_path</span><span class="s3">:</span>
                <span class="s6"># Check whether the file exists inside the wheel.</span>
                <span class="s1">whl</span><span class="s3">, </span><span class="s1">wf </span><span class="s3">= </span><span class="s1">source_path</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'.whl' </span><span class="s3">+ </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">)</span>
                <span class="s1">whl </span><span class="s3">+= </span><span class="s4">'.whl'</span>
                <span class="s1">whlfile </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_zip_file</span><span class="s3">(</span><span class="s1">whl</span><span class="s3">)</span>

                <span class="s6"># Normalize the path separator</span>
                <span class="s1">wf </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">normpath</span><span class="s3">(</span><span class="s1">wf</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">, </span><span class="s4">'/'</span><span class="s3">)</span>

                <span class="s6"># Look case-insensitively.</span>
                <span class="s1">namelist </span><span class="s3">= </span><span class="s1">whlfile</span><span class="s3">.</span><span class="s1">namelist</span><span class="s3">()</span>
                <span class="s1">namelist_lower </span><span class="s3">= [</span><span class="s1">file</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() </span><span class="s2">for </span><span class="s1">file </span><span class="s2">in </span><span class="s1">namelist</span><span class="s3">]</span>

                <span class="s2">if </span><span class="s1">wf</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() </span><span class="s2">in </span><span class="s1">namelist_lower</span><span class="s3">:</span>
                    <span class="s6"># We have a match.  Change it to the correct case.</span>
                    <span class="s1">wf </span><span class="s3">= </span><span class="s1">namelist</span><span class="s3">[</span><span class="s1">namelist_lower</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s1">wf</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">())]</span>
                    <span class="s1">source_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">whl</span><span class="s3">, </span><span class="s1">wf</span><span class="s3">)</span>
                    <span class="s1">target_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">wf</span><span class="s3">))</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">copy_with_dependencies</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">, </span><span class="s1">target_path</span><span class="s3">, </span><span class="s1">search_path</span><span class="s3">)</span>
                    <span class="s2">return</span>

        <span class="s6"># If we didn't find it, look again, but case-insensitively.</span>
        <span class="s1">name_lower </span><span class="s3">= </span><span class="s1">name</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()</span>

        <span class="s2">for </span><span class="s1">dir </span><span class="s2">in </span><span class="s1">search_path</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">):</span>
                <span class="s1">files </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">)</span>
                <span class="s1">files_lower </span><span class="s3">= [</span><span class="s1">file</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() </span><span class="s2">for </span><span class="s1">file </span><span class="s2">in </span><span class="s1">files</span><span class="s3">]</span>

                <span class="s2">if </span><span class="s1">name_lower </span><span class="s2">in </span><span class="s1">files_lower</span><span class="s3">:</span>
                    <span class="s1">name </span><span class="s3">= </span><span class="s1">files</span><span class="s3">[</span><span class="s1">files_lower</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s1">name_lower</span><span class="s3">)]</span>
                    <span class="s1">source_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>
                    <span class="s1">target_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">copy_with_dependencies</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">, </span><span class="s1">target_path</span><span class="s3">, </span><span class="s1">search_path</span><span class="s3">)</span>

        <span class="s6"># Warn if we can't find it, but only once.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s4">&quot;could not find dependency {0} (referenced by {1})&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">referenced_by</span><span class="s3">))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">exclude_dependencies</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">GlobPattern</span><span class="s3">(</span><span class="s1">name</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()))</span>

    <span class="s2">def </span><span class="s1">copy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">source_path</span><span class="s3">, </span><span class="s1">target_path</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Copies source_path to target_path. 
 
        source_path may be located inside a .whl file. &quot;&quot;&quot;</span>

        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'copying {0} -&gt; {1}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">relpath</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_base</span><span class="s3">), </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">relpath</span><span class="s3">(</span><span class="s1">target_path</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_base</span><span class="s3">)))</span>
        <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
            <span class="s6"># No relative path (e.g., files on different drives in Windows), just print absolute paths instead</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'copying {0} -&gt; {1}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">, </span><span class="s1">target_path</span><span class="s3">))</span>

        <span class="s6"># Make the directory if it does not yet exist.</span>
        <span class="s1">target_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">target_path</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">):</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">)</span>

        <span class="s6"># Copy the file, and open it for analysis.</span>
        <span class="s2">if </span><span class="s4">'.whl' </span><span class="s2">in </span><span class="s1">source_path</span><span class="s3">:</span>
            <span class="s6"># This was found in a wheel, extract it</span>
            <span class="s1">whl</span><span class="s3">, </span><span class="s1">wf </span><span class="s3">= </span><span class="s1">source_path</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'.whl' </span><span class="s3">+ </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">)</span>
            <span class="s1">whl </span><span class="s3">+= </span><span class="s4">'.whl'</span>
            <span class="s1">whlfile </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_zip_file</span><span class="s3">(</span><span class="s1">whl</span><span class="s3">)</span>
            <span class="s1">data </span><span class="s3">= </span><span class="s1">whlfile</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">wf</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">, </span><span class="s4">'/'</span><span class="s3">))</span>
            <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">target_path</span><span class="s3">, </span><span class="s4">'wb'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s6"># Regular file, copy it</span>
            <span class="s1">shutil</span><span class="s3">.</span><span class="s1">copyfile</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">, </span><span class="s1">target_path</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">copy_with_dependencies</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">source_path</span><span class="s3">, </span><span class="s1">target_path</span><span class="s3">, </span><span class="s1">search_path</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Copies source_path to target_path.  It also scans source_path for 
        any dependencies, which are located along the given search_path and 
        copied to the same directory as target_path. 
 
        source_path may be located inside a .whl file. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">, </span><span class="s1">target_path</span><span class="s3">)</span>

        <span class="s1">source_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">source_path</span><span class="s3">)</span>
        <span class="s1">target_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">target_path</span><span class="s3">)</span>
        <span class="s1">base </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">target_path</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">source_dir </span><span class="s2">not in </span><span class="s1">search_path</span><span class="s3">:</span>
            <span class="s1">search_path </span><span class="s3">= </span><span class="s1">search_path </span><span class="s3">+ [</span><span class="s1">source_dir</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">copy_dependencies</span><span class="s3">(</span><span class="s1">target_path</span><span class="s3">, </span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">search_path</span><span class="s3">, </span><span class="s1">base</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">copy_dependencies</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">target_path</span><span class="s3">, </span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">search_path</span><span class="s3">, </span><span class="s1">referenced_by</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Copies the dependencies of target_path into target_dir. &quot;&quot;&quot;</span>

        <span class="s1">fp </span><span class="s3">= </span><span class="s1">open</span><span class="s3">(</span><span class="s1">target_path</span><span class="s3">, </span><span class="s4">'rb+'</span><span class="s3">)</span>

        <span class="s6"># What kind of magic does the file contain?</span>
        <span class="s1">deps </span><span class="s3">= []</span>
        <span class="s1">magic </span><span class="s3">= </span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s5">4</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">magic</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s7">b'MZ'</span><span class="s3">):</span>
            <span class="s6"># It's a Windows DLL or EXE file.</span>
            <span class="s1">pe </span><span class="s3">= </span><span class="s1">pefile</span><span class="s3">.</span><span class="s1">PEFile</span><span class="s3">()</span>
            <span class="s1">pe</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">lib </span><span class="s2">in </span><span class="s1">pe</span><span class="s3">.</span><span class="s1">imports</span><span class="s3">:</span>
                <span class="s1">deps</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">lib</span><span class="s3">)</span>

        <span class="s2">elif </span><span class="s1">magic </span><span class="s3">== </span><span class="s7">b'</span><span class="s2">\x7F</span><span class="s7">ELF'</span><span class="s3">:</span>
            <span class="s6"># Elf magic.  Used on (among others) Linux and FreeBSD.</span>
            <span class="s1">deps </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_read_dependencies_elf</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">search_path</span><span class="s3">)</span>

        <span class="s2">elif </span><span class="s1">magic </span><span class="s2">in </span><span class="s3">(</span><span class="s7">b'</span><span class="s2">\xCE\xFA\xED\xFE</span><span class="s7">'</span><span class="s3">, </span><span class="s7">b'</span><span class="s2">\xCF\xFA\xED\xFE</span><span class="s7">'</span><span class="s3">):</span>
            <span class="s6"># A Mach-O file, as used on macOS.</span>
            <span class="s1">deps </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_read_dependencies_macho</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s4">'&lt;'</span><span class="s3">, </span><span class="s1">flatten</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s2">elif </span><span class="s1">magic </span><span class="s2">in </span><span class="s3">(</span><span class="s7">b'</span><span class="s2">\xFE\xED\xFA\xCE</span><span class="s7">'</span><span class="s3">, </span><span class="s7">b'</span><span class="s2">\xFE\xED\xFA\xCF</span><span class="s7">'</span><span class="s3">):</span>
            <span class="s1">rel_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">relpath</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">target_path</span><span class="s3">))</span>
            <span class="s1">deps </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_read_dependencies_macho</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s4">'&gt;'</span><span class="s3">, </span><span class="s1">flatten</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s2">elif </span><span class="s1">magic </span><span class="s2">in </span><span class="s3">(</span><span class="s7">b'</span><span class="s2">\xCA\xFE\xBA\xBE</span><span class="s7">'</span><span class="s3">, </span><span class="s7">b'</span><span class="s2">\xBE\xBA\xFE\xCA</span><span class="s7">'</span><span class="s3">):</span>
            <span class="s6"># A fat file, containing multiple Mach-O binaries.  In the future,</span>
            <span class="s6"># we may want to extract the one containing the architecture we</span>
            <span class="s6"># are building for.</span>
            <span class="s1">deps </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_read_dependencies_fat</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s1">flatten</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s2">elif </span><span class="s1">magic </span><span class="s2">in </span><span class="s3">(</span><span class="s7">b'</span><span class="s2">\xCA\xFE\xBA\xBF</span><span class="s7">'</span><span class="s3">, </span><span class="s7">b'</span><span class="s2">\xBF\xBA\xFE\xCA</span><span class="s7">'</span><span class="s3">):</span>
            <span class="s6"># A 64-bit fat file.</span>
            <span class="s1">deps </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_read_dependencies_fat</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s1">flatten</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s6"># If we discovered any dependencies, recursively add those.</span>
        <span class="s2">for </span><span class="s1">dep </span><span class="s2">in </span><span class="s1">deps</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">add_dependency</span><span class="s3">(</span><span class="s1">dep</span><span class="s3">, </span><span class="s1">target_dir</span><span class="s3">, </span><span class="s1">search_path</span><span class="s3">, </span><span class="s1">referenced_by</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_read_dependencies_elf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">elf</span><span class="s3">, </span><span class="s1">origin</span><span class="s3">, </span><span class="s1">search_path</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Having read the first 4 bytes of the ELF file, fetches the 
        dependent libraries and returns those as a list. &quot;&quot;&quot;</span>

        <span class="s1">ident </span><span class="s3">= </span><span class="s1">elf</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s5">12</span><span class="s3">)</span>

        <span class="s6"># Make sure we read in the correct endianness and integer size</span>
        <span class="s1">byte_order </span><span class="s3">= </span><span class="s4">&quot;&lt;&gt;&quot;</span><span class="s3">[</span><span class="s1">ord</span><span class="s3">(</span><span class="s1">ident</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:</span><span class="s5">2</span><span class="s3">]) - </span><span class="s5">1</span><span class="s3">]</span>
        <span class="s1">elf_class </span><span class="s3">= </span><span class="s1">ord</span><span class="s3">(</span><span class="s1">ident</span><span class="s3">[</span><span class="s5">0</span><span class="s3">:</span><span class="s5">1</span><span class="s3">]) - </span><span class="s5">1 </span><span class="s6"># 0 = 32-bits, 1 = 64-bits</span>
        <span class="s1">header_struct </span><span class="s3">= </span><span class="s1">byte_order </span><span class="s3">+ (</span><span class="s4">&quot;HHIIIIIHHHHHH&quot;</span><span class="s3">, </span><span class="s4">&quot;HHIQQQIHHHHHH&quot;</span><span class="s3">)[</span><span class="s1">elf_class</span><span class="s3">]</span>
        <span class="s1">section_struct </span><span class="s3">= </span><span class="s1">byte_order </span><span class="s3">+ (</span><span class="s4">&quot;4xI8xIII8xI&quot;</span><span class="s3">, </span><span class="s4">&quot;4xI16xQQI12xQ&quot;</span><span class="s3">)[</span><span class="s1">elf_class</span><span class="s3">]</span>
        <span class="s1">dynamic_struct </span><span class="s3">= </span><span class="s1">byte_order </span><span class="s3">+ (</span><span class="s4">&quot;iI&quot;</span><span class="s3">, </span><span class="s4">&quot;qQ&quot;</span><span class="s3">)[</span><span class="s1">elf_class</span><span class="s3">]</span>

        <span class="s1">type</span><span class="s3">, </span><span class="s1">machine</span><span class="s3">, </span><span class="s1">version</span><span class="s3">, </span><span class="s1">entry</span><span class="s3">, </span><span class="s1">phoff</span><span class="s3">, </span><span class="s1">shoff</span><span class="s3">, </span><span class="s1">flags</span><span class="s3">, </span><span class="s1">ehsize</span><span class="s3">, </span><span class="s1">phentsize</span><span class="s3">, </span><span class="s1">phnum</span><span class="s3">, </span><span class="s1">shentsize</span><span class="s3">, </span><span class="s1">shnum</span><span class="s3">, </span><span class="s1">shstrndx \</span>
          <span class="s3">= </span><span class="s1">struct</span><span class="s3">.</span><span class="s1">unpack</span><span class="s3">(</span><span class="s1">header_struct</span><span class="s3">, </span><span class="s1">elf</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">struct</span><span class="s3">.</span><span class="s1">calcsize</span><span class="s3">(</span><span class="s1">header_struct</span><span class="s3">)))</span>
        <span class="s1">dynamic_sections </span><span class="s3">= []</span>
        <span class="s1">string_tables </span><span class="s3">= {}</span>

        <span class="s6"># Seek to the section header table and find the .dynamic section.</span>
        <span class="s1">elf</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">shoff</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">shnum</span><span class="s3">):</span>
            <span class="s1">type</span><span class="s3">, </span><span class="s1">offset</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">link</span><span class="s3">, </span><span class="s1">entsize </span><span class="s3">= </span><span class="s1">struct</span><span class="s3">.</span><span class="s1">unpack_from</span><span class="s3">(</span><span class="s1">section_struct</span><span class="s3">, </span><span class="s1">elf</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">shentsize</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">type </span><span class="s3">== </span><span class="s5">6 </span><span class="s2">and </span><span class="s1">link </span><span class="s3">!= </span><span class="s5">0</span><span class="s3">: </span><span class="s6"># DYNAMIC type, links to string table</span>
                <span class="s1">dynamic_sections</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">offset</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">link</span><span class="s3">, </span><span class="s1">entsize</span><span class="s3">))</span>
                <span class="s1">string_tables</span><span class="s3">[</span><span class="s1">link</span><span class="s3">] = </span><span class="s2">None</span>

        <span class="s6"># Read the relevant string tables.</span>
        <span class="s2">for </span><span class="s1">idx </span><span class="s2">in </span><span class="s1">string_tables</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">():</span>
            <span class="s1">elf</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">shoff </span><span class="s3">+ </span><span class="s1">idx </span><span class="s3">* </span><span class="s1">shentsize</span><span class="s3">)</span>
            <span class="s1">type</span><span class="s3">, </span><span class="s1">offset</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">link</span><span class="s3">, </span><span class="s1">entsize </span><span class="s3">= </span><span class="s1">struct</span><span class="s3">.</span><span class="s1">unpack_from</span><span class="s3">(</span><span class="s1">section_struct</span><span class="s3">, </span><span class="s1">elf</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">shentsize</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">type </span><span class="s3">!= </span><span class="s5">3</span><span class="s3">: </span><span class="s2">continue</span>
            <span class="s1">elf</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">offset</span><span class="s3">)</span>
            <span class="s1">string_tables</span><span class="s3">[</span><span class="s1">idx</span><span class="s3">] = </span><span class="s1">elf</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">size</span><span class="s3">)</span>

        <span class="s6"># Loop through the dynamic sections and rewrite it if it has an rpath/runpath.</span>
        <span class="s1">needed </span><span class="s3">= []</span>
        <span class="s1">rpath </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">offset</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">link</span><span class="s3">, </span><span class="s1">entsize </span><span class="s2">in </span><span class="s1">dynamic_sections</span><span class="s3">:</span>
            <span class="s1">elf</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">offset</span><span class="s3">)</span>
            <span class="s1">data </span><span class="s3">= </span><span class="s1">elf</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">entsize</span><span class="s3">)</span>
            <span class="s1">tag</span><span class="s3">, </span><span class="s1">val </span><span class="s3">= </span><span class="s1">struct</span><span class="s3">.</span><span class="s1">unpack_from</span><span class="s3">(</span><span class="s1">dynamic_struct</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>

            <span class="s6"># Read tags until we find a NULL tag.</span>
            <span class="s2">while </span><span class="s1">tag </span><span class="s3">!= </span><span class="s5">0</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">tag </span><span class="s3">== </span><span class="s5">1</span><span class="s3">: </span><span class="s6"># A NEEDED entry.  Read it from the string table.</span>
                    <span class="s1">string </span><span class="s3">= </span><span class="s1">string_tables</span><span class="s3">[</span><span class="s1">link</span><span class="s3">][</span><span class="s1">val </span><span class="s3">: </span><span class="s1">string_tables</span><span class="s3">[</span><span class="s1">link</span><span class="s3">].</span><span class="s1">find</span><span class="s3">(</span><span class="s7">b'</span><span class="s2">\0</span><span class="s7">'</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)]</span>
                    <span class="s1">needed</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">string</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s4">'utf-8'</span><span class="s3">))</span>

                <span class="s2">elif </span><span class="s1">tag </span><span class="s3">== </span><span class="s5">15 </span><span class="s2">or </span><span class="s1">tag </span><span class="s3">== </span><span class="s5">29</span><span class="s3">:</span>
                    <span class="s6"># An RPATH or RUNPATH entry.</span>
                    <span class="s1">string </span><span class="s3">= </span><span class="s1">string_tables</span><span class="s3">[</span><span class="s1">link</span><span class="s3">][</span><span class="s1">val </span><span class="s3">: </span><span class="s1">string_tables</span><span class="s3">[</span><span class="s1">link</span><span class="s3">].</span><span class="s1">find</span><span class="s3">(</span><span class="s7">b'</span><span class="s2">\0</span><span class="s7">'</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)]</span>
                    <span class="s1">rpath </span><span class="s3">+= [</span>
                        <span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">normpath</span><span class="s3">(</span><span class="s1">i</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s4">'utf-8'</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'$ORIGIN'</span><span class="s3">, </span><span class="s1">origin</span><span class="s3">))</span>
                        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">string</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s7">b':'</span><span class="s3">)</span>
                    <span class="s3">]</span>

                <span class="s1">data </span><span class="s3">= </span><span class="s1">elf</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">entsize</span><span class="s3">)</span>
                <span class="s1">tag</span><span class="s3">, </span><span class="s1">val </span><span class="s3">= </span><span class="s1">struct</span><span class="s3">.</span><span class="s1">unpack_from</span><span class="s3">(</span><span class="s1">dynamic_struct</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>
        <span class="s1">elf</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

        <span class="s1">search_path </span><span class="s3">+= </span><span class="s1">rpath</span>
        <span class="s2">return </span><span class="s1">needed</span>

    <span class="s2">def </span><span class="s1">_read_dependencies_macho</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">endian</span><span class="s3">, </span><span class="s1">flatten</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; Having read the first 4 bytes of the Mach-O file, fetches the 
        dependent libraries and returns those as a list. 
 
        If flatten is True, if the dependencies contain paths like 
        @loader_path/../.dylibs/libsomething.dylib, it will rewrite them to 
        instead contain @loader_path/libsomething.dylib if possible. 
        This requires the file pointer to be opened in rb+ mode. &quot;&quot;&quot;</span>

        <span class="s1">cputype</span><span class="s3">, </span><span class="s1">cpusubtype</span><span class="s3">, </span><span class="s1">filetype</span><span class="s3">, </span><span class="s1">ncmds</span><span class="s3">, </span><span class="s1">sizeofcmds</span><span class="s3">, </span><span class="s1">flags </span><span class="s3">= </span><span class="s1">\</span>
            <span class="s1">struct</span><span class="s3">.</span><span class="s1">unpack</span><span class="s3">(</span><span class="s1">endian </span><span class="s3">+ </span><span class="s4">'IIIIII'</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s5">24</span><span class="s3">))</span>

        <span class="s1">is_64bit </span><span class="s3">= (</span><span class="s1">cputype </span><span class="s3">&amp; </span><span class="s5">0x1000000</span><span class="s3">) != </span><span class="s5">0</span>
        <span class="s2">if </span><span class="s1">is_64bit</span><span class="s3">:</span>
            <span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s5">4</span><span class="s3">)</span>

        <span class="s6"># After the header, we get a series of linker commands.  We just</span>
        <span class="s6"># iterate through them and gather up the LC_LOAD_DYLIB commands.</span>
        <span class="s1">load_dylibs </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">ncmds</span><span class="s3">):</span>
            <span class="s1">cmd</span><span class="s3">, </span><span class="s1">cmd_size </span><span class="s3">= </span><span class="s1">struct</span><span class="s3">.</span><span class="s1">unpack</span><span class="s3">(</span><span class="s1">endian </span><span class="s3">+ </span><span class="s4">'II'</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s5">8</span><span class="s3">))</span>
            <span class="s1">cmd_data </span><span class="s3">= </span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">cmd_size </span><span class="s3">- </span><span class="s5">8</span><span class="s3">)</span>
            <span class="s1">cmd </span><span class="s3">&amp;= ~</span><span class="s5">0x80000000</span>

            <span class="s2">if </span><span class="s1">cmd </span><span class="s3">== </span><span class="s5">0x0c</span><span class="s3">: </span><span class="s6"># LC_LOAD_DYLIB</span>
                <span class="s1">dylib </span><span class="s3">= </span><span class="s1">cmd_data</span><span class="s3">[</span><span class="s5">16</span><span class="s3">:].</span><span class="s1">decode</span><span class="s3">(</span><span class="s4">'ascii'</span><span class="s3">).</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\x00</span><span class="s4">'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
                <span class="s1">orig </span><span class="s3">= </span><span class="s1">dylib</span>

                <span class="s2">if </span><span class="s1">dylib</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'@loader_path/../Frameworks/'</span><span class="s3">):</span>
                    <span class="s1">dylib </span><span class="s3">= </span><span class="s1">dylib</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'@loader_path/../Frameworks/'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">)</span>
                <span class="s2">elif </span><span class="s1">dylib</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'@executable_path/../Frameworks/'</span><span class="s3">):</span>
                    <span class="s1">dylib </span><span class="s3">= </span><span class="s1">dylib</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'@executable_path/../Frameworks/'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s2">for </span><span class="s1">prefix </span><span class="s2">in </span><span class="s3">(</span><span class="s4">'@loader_path/'</span><span class="s3">, </span><span class="s4">'@rpath/'</span><span class="s3">):</span>
                        <span class="s2">if </span><span class="s1">dylib</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">):</span>
                            <span class="s1">dylib </span><span class="s3">= </span><span class="s1">dylib</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">, </span><span class="s4">''</span><span class="s3">)</span>

                            <span class="s6"># Do we need to flatten the relative reference?</span>
                            <span class="s2">if </span><span class="s4">'/' </span><span class="s2">in </span><span class="s1">dylib </span><span class="s2">and </span><span class="s1">flatten</span><span class="s3">:</span>
                                <span class="s1">new_dylib </span><span class="s3">= </span><span class="s1">prefix </span><span class="s3">+ </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">dylib</span><span class="s3">)</span>
                                <span class="s1">str_size </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">cmd_data</span><span class="s3">) - </span><span class="s5">16</span>
                                <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">new_dylib</span><span class="s3">) &lt; </span><span class="s1">str_size</span><span class="s3">:</span>
                                    <span class="s1">fp</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(-</span><span class="s1">str_size</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">SEEK_CUR</span><span class="s3">)</span>
                                    <span class="s1">fp</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">new_dylib</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s4">'ascii'</span><span class="s3">).</span><span class="s1">ljust</span><span class="s3">(</span><span class="s1">str_size</span><span class="s3">, </span><span class="s7">b'</span><span class="s2">\0</span><span class="s7">'</span><span class="s3">))</span>
                                <span class="s2">else</span><span class="s3">:</span>
                                    <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s4">'Unable to rewrite dependency {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">orig</span><span class="s3">))</span>

                <span class="s1">load_dylibs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">dylib</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">load_dylibs</span>

    <span class="s2">def </span><span class="s1">_read_dependencies_fat</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">is_64bit</span><span class="s3">, </span><span class="s1">flatten</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">num_fat</span><span class="s3">, = </span><span class="s1">struct</span><span class="s3">.</span><span class="s1">unpack</span><span class="s3">(</span><span class="s4">'&gt;I'</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s5">4</span><span class="s3">))</span>

        <span class="s6"># After the header we get a table of executables in this fat file,</span>
        <span class="s6"># each one with a corresponding offset into the file.</span>
        <span class="s1">offsets </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">num_fat</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">is_64bit</span><span class="s3">:</span>
                <span class="s1">cputype</span><span class="s3">, </span><span class="s1">cpusubtype</span><span class="s3">, </span><span class="s1">offset</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">align </span><span class="s3">= </span><span class="s1">\</span>
                    <span class="s1">struct</span><span class="s3">.</span><span class="s1">unpack</span><span class="s3">(</span><span class="s4">'&gt;QQQQQ'</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s5">40</span><span class="s3">))</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">cputype</span><span class="s3">, </span><span class="s1">cpusubtype</span><span class="s3">, </span><span class="s1">offset</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">align </span><span class="s3">= </span><span class="s1">\</span>
                    <span class="s1">struct</span><span class="s3">.</span><span class="s1">unpack</span><span class="s3">(</span><span class="s4">'&gt;IIIII'</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s5">20</span><span class="s3">))</span>
            <span class="s1">offsets</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">offset</span><span class="s3">)</span>

        <span class="s6"># Go through each of the binaries in the fat file.</span>
        <span class="s1">deps </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">offset </span><span class="s2">in </span><span class="s1">offsets</span><span class="s3">:</span>
            <span class="s6"># Add 4, since it expects we've already read the magic.</span>
            <span class="s1">fp</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">offset</span><span class="s3">)</span>
            <span class="s1">magic </span><span class="s3">= </span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s5">4</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">magic </span><span class="s2">in </span><span class="s3">(</span><span class="s7">b'</span><span class="s2">\xCE\xFA\xED\xFE</span><span class="s7">'</span><span class="s3">, </span><span class="s7">b'</span><span class="s2">\xCF\xFA\xED\xFE</span><span class="s7">'</span><span class="s3">):</span>
                <span class="s1">endian </span><span class="s3">= </span><span class="s4">'&lt;'</span>
            <span class="s2">elif </span><span class="s1">magic </span><span class="s2">in </span><span class="s3">(</span><span class="s7">b'</span><span class="s2">\xFE\xED\xFA\xCE</span><span class="s7">'</span><span class="s3">, </span><span class="s7">b'</span><span class="s2">\xFE\xED\xFA\xCF</span><span class="s7">'</span><span class="s3">):</span>
                <span class="s1">endian </span><span class="s3">= </span><span class="s4">'&gt;'</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s6"># Not a Mach-O file we can read.</span>
                <span class="s2">continue</span>

            <span class="s2">for </span><span class="s1">dep </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_read_dependencies_macho</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">endian</span><span class="s3">, </span><span class="s1">flatten</span><span class="s3">=</span><span class="s1">flatten</span><span class="s3">):</span>
                <span class="s2">if </span><span class="s1">dep </span><span class="s2">not in </span><span class="s1">deps</span><span class="s3">:</span>
                    <span class="s1">deps</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">dep</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">deps</span>

    <span class="s2">def </span><span class="s1">expand_path</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">platform</span><span class="s3">):</span>
        <span class="s0">&quot;Substitutes variables in the given path string.&quot;</span>

        <span class="s2">if </span><span class="s1">path </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">return None</span>

        <span class="s1">t </span><span class="s3">= </span><span class="s1">string</span><span class="s3">.</span><span class="s1">Template</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'win'</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">t</span><span class="s3">.</span><span class="s1">substitute</span><span class="s3">(</span><span class="s1">HOME</span><span class="s3">=</span><span class="s4">'~'</span><span class="s3">, </span><span class="s1">USER_APPDATA</span><span class="s3">=</span><span class="s4">'~/AppData/Local'</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'macosx'</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">t</span><span class="s3">.</span><span class="s1">substitute</span><span class="s3">(</span><span class="s1">HOME</span><span class="s3">=</span><span class="s4">'~'</span><span class="s3">, </span><span class="s1">USER_APPDATA</span><span class="s3">=</span><span class="s4">'~/Documents'</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">t</span><span class="s3">.</span><span class="s1">substitute</span><span class="s3">(</span><span class="s1">HOME</span><span class="s3">=</span><span class="s4">'~'</span><span class="s3">, </span><span class="s1">USER_APPDATA</span><span class="s3">=</span><span class="s4">'~/.local/share'</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">bdist_apps</span><span class="s3">(</span><span class="s1">setuptools</span><span class="s3">.</span><span class="s1">Command</span><span class="s3">):</span>
    <span class="s1">DEFAULT_INSTALLERS </span><span class="s3">= {</span>
        <span class="s4">'manylinux1_x86_64'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux1_i686'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux2010_x86_64'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux2010_i686'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux2014_x86_64'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux2014_i686'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux2014_aarch64'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux2014_armv7l'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux2014_ppc64'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux2014_ppc64le'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux2014_s390x'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux_2_24_x86_64'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux_2_24_i686'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux_2_24_aarch64'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux_2_24_armv7l'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux_2_24_ppc64'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux_2_24_ppc64le'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux_2_24_s390x'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux_2_28_x86_64'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux_2_28_aarch64'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux_2_28_ppc64le'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s4">'manylinux_2_28_s390x'</span><span class="s3">: [</span><span class="s4">'gztar'</span><span class="s3">],</span>
        <span class="s6"># Everything else defaults to ['zip']</span>
    <span class="s3">}</span>

    <span class="s1">description </span><span class="s3">= </span><span class="s4">'bundle built Panda3D applications into distributable forms'</span>
    <span class="s1">user_options </span><span class="s3">= </span><span class="s1">build_apps</span><span class="s3">.</span><span class="s1">user_options </span><span class="s3">+ [</span>
        <span class="s3">(</span><span class="s4">'dist-dir='</span><span class="s3">, </span><span class="s4">'d'</span><span class="s3">, </span><span class="s4">'directory to put final built distributions in'</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s4">'skip-build'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s4">'skip rebuilding everything (for testing/debugging)'</span><span class="s3">),</span>
    <span class="s3">]</span>

    <span class="s2">def </span><span class="s1">_build_apps_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">[</span><span class="s1">opt</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'-'</span><span class="s3">, </span><span class="s4">'_'</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'='</span><span class="s3">, </span><span class="s4">''</span><span class="s3">) </span><span class="s2">for </span><span class="s1">opt </span><span class="s2">in </span><span class="s1">build_apps</span><span class="s3">.</span><span class="s1">user_options</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">initialize_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">installers </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">getcwd</span><span class="s3">(), </span><span class="s4">'dist'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">skip_build </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s2">for </span><span class="s1">opt </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_build_apps_options</span><span class="s3">():</span>
            <span class="s1">setattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">opt</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">finalize_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># We need to massage the inputs a bit in case they came from a</span>
        <span class="s6"># setup.cfg file.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">installers </span><span class="s3">= {</span>
            <span class="s1">key</span><span class="s3">: </span><span class="s1">_parse_list</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">_parse_dict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">installers</span><span class="s3">).</span><span class="s1">items</span><span class="s3">()</span>
        <span class="s3">}</span>

    <span class="s2">def </span><span class="s1">_get_archive_basedir</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">distribution</span><span class="s3">.</span><span class="s1">get_name</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">create_zip</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">basename</span><span class="s3">, </span><span class="s1">build_dir</span><span class="s3">):</span>
        <span class="s2">import </span><span class="s1">zipfile</span>

        <span class="s1">base_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_archive_basedir</span><span class="s3">()</span>

        <span class="s2">with </span><span class="s1">zipfile</span><span class="s3">.</span><span class="s1">ZipFile</span><span class="s3">(</span><span class="s1">basename</span><span class="s3">+</span><span class="s4">'.zip'</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">, </span><span class="s1">compression</span><span class="s3">=</span><span class="s1">zipfile</span><span class="s3">.</span><span class="s1">ZIP_DEFLATED</span><span class="s3">) </span><span class="s2">as </span><span class="s1">zf</span><span class="s3">:</span>
            <span class="s1">zf</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">, </span><span class="s1">base_dir</span><span class="s3">)</span>

            <span class="s2">for </span><span class="s1">dirpath</span><span class="s3">, </span><span class="s1">dirnames</span><span class="s3">, </span><span class="s1">filenames </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">walk</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">):</span>
                <span class="s1">dirnames</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">()</span>
                <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">dirnames</span><span class="s3">:</span>
                    <span class="s1">path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">normpath</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">, </span><span class="s1">name</span><span class="s3">))</span>
                    <span class="s1">zf</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">path</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">, </span><span class="s1">base_dir</span><span class="s3">, </span><span class="s5">1</span><span class="s3">))</span>
                <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">filenames</span><span class="s3">:</span>
                    <span class="s1">path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">normpath</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">, </span><span class="s1">name</span><span class="s3">))</span>
                    <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
                        <span class="s1">zf</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">path</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">, </span><span class="s1">base_dir</span><span class="s3">, </span><span class="s5">1</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">create_tarball</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">basename</span><span class="s3">, </span><span class="s1">build_dir</span><span class="s3">, </span><span class="s1">tar_compression</span><span class="s3">):</span>
        <span class="s2">import </span><span class="s1">tarfile</span>

        <span class="s1">base_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_archive_basedir</span><span class="s3">()</span>
        <span class="s1">build_cmd </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_finalized_command</span><span class="s3">(</span><span class="s4">'build_apps'</span><span class="s3">)</span>
        <span class="s1">binary_names </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">build_cmd</span><span class="s3">.</span><span class="s1">console_apps</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()) + </span><span class="s1">list</span><span class="s3">(</span><span class="s1">build_cmd</span><span class="s3">.</span><span class="s1">gui_apps</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">())</span>

        <span class="s1">source_date </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'SOURCE_DATE_EPOCH'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">).</span><span class="s1">strip</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">source_date</span><span class="s3">:</span>
            <span class="s1">max_mtime </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">source_date</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">max_mtime </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s2">def </span><span class="s1">tarfilter</span><span class="s3">(</span><span class="s1">tarinfo</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">tarinfo</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">() </span><span class="s2">or </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">tarinfo</span><span class="s3">.</span><span class="s1">name</span><span class="s3">) </span><span class="s2">in </span><span class="s1">binary_names</span><span class="s3">:</span>
                <span class="s1">tarinfo</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s5">0o755</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">tarinfo</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s5">0o644</span>

            <span class="s6"># This isn't interesting information to retain for distribution.</span>
            <span class="s1">tarinfo</span><span class="s3">.</span><span class="s1">uid </span><span class="s3">= </span><span class="s5">0</span>
            <span class="s1">tarinfo</span><span class="s3">.</span><span class="s1">gid </span><span class="s3">= </span><span class="s5">0</span>
            <span class="s1">tarinfo</span><span class="s3">.</span><span class="s1">uname </span><span class="s3">= </span><span class="s4">&quot;&quot;</span>
            <span class="s1">tarinfo</span><span class="s3">.</span><span class="s1">gname </span><span class="s3">= </span><span class="s4">&quot;&quot;</span>

            <span class="s2">if </span><span class="s1">max_mtime </span><span class="s2">is not None and </span><span class="s1">tarinfo</span><span class="s3">.</span><span class="s1">mtime </span><span class="s3">&gt;= </span><span class="s1">max_mtime</span><span class="s3">:</span>
                <span class="s1">tarinfo</span><span class="s3">.</span><span class="s1">mtime </span><span class="s3">= </span><span class="s1">max_mtime</span>

            <span class="s2">return </span><span class="s1">tarinfo</span>

        <span class="s1">filename </span><span class="s3">= </span><span class="s4">'{}.tar.{}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">basename</span><span class="s3">, </span><span class="s1">tar_compression</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">tarfile</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s4">'w|{}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">tar_compression</span><span class="s3">)) </span><span class="s2">as </span><span class="s1">tf</span><span class="s3">:</span>
            <span class="s1">tf</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">, </span><span class="s1">base_dir</span><span class="s3">, </span><span class="s1">filter</span><span class="s3">=</span><span class="s1">tarfilter</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">tar_compression </span><span class="s3">== </span><span class="s4">'gz' </span><span class="s2">and </span><span class="s1">max_mtime </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s6"># Python provides no elegant way to overwrite the gzip timestamp.</span>
            <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s4">'r+b'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fp</span><span class="s3">:</span>
                <span class="s1">fp</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s5">4</span><span class="s3">)</span>
                <span class="s1">fp</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">struct</span><span class="s3">.</span><span class="s1">pack</span><span class="s3">(</span><span class="s4">&quot;&lt;L&quot;</span><span class="s3">, </span><span class="s1">max_mtime</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">create_nsis</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">basename</span><span class="s3">, </span><span class="s1">build_dir</span><span class="s3">, </span><span class="s1">is_64bit</span><span class="s3">):</span>
        <span class="s6"># Get a list of build applications</span>
        <span class="s1">build_cmd </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_finalized_command</span><span class="s3">(</span><span class="s4">'build_apps'</span><span class="s3">)</span>
        <span class="s1">apps </span><span class="s3">= </span><span class="s1">build_cmd</span><span class="s3">.</span><span class="s1">gui_apps</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">apps</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">build_cmd</span><span class="s3">.</span><span class="s1">console_apps</span><span class="s3">)</span>
        <span class="s1">apps </span><span class="s3">= [</span>
            <span class="s4">'{}.exe'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">i</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">apps</span>
        <span class="s3">]</span>

        <span class="s1">fullname </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">distribution</span><span class="s3">.</span><span class="s1">get_fullname</span><span class="s3">()</span>
        <span class="s1">shortname </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">distribution</span><span class="s3">.</span><span class="s1">get_name</span><span class="s3">()</span>

        <span class="s6"># Create the .nsi installer script</span>
        <span class="s1">nsifile </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Filename</span><span class="s3">(</span><span class="s1">build_cmd</span><span class="s3">.</span><span class="s1">build_base</span><span class="s3">, </span><span class="s1">shortname </span><span class="s3">+ </span><span class="s4">&quot;.nsi&quot;</span><span class="s3">)</span>
        <span class="s1">nsifile</span><span class="s3">.</span><span class="s1">unlink</span><span class="s3">()</span>
        <span class="s1">nsi </span><span class="s3">= </span><span class="s1">open</span><span class="s3">(</span><span class="s1">nsifile</span><span class="s3">.</span><span class="s1">to_os_specific</span><span class="s3">(), </span><span class="s4">&quot;w&quot;</span><span class="s3">)</span>

        <span class="s6"># Some global info</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'Name &quot;%s&quot;</span><span class="s2">\n</span><span class="s4">' </span><span class="s3">% </span><span class="s1">shortname</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'OutFile &quot;%s&quot;</span><span class="s2">\n</span><span class="s4">' </span><span class="s3">% (</span><span class="s1">fullname</span><span class="s3">+</span><span class="s4">'.exe'</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">is_64bit</span><span class="s3">:</span>
            <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'InstallDir &quot;$PROGRAMFILES64</span><span class="s2">\\</span><span class="s4">%s&quot;</span><span class="s2">\n</span><span class="s4">' </span><span class="s3">% </span><span class="s1">shortname</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'InstallDir &quot;$PROGRAMFILES</span><span class="s2">\\</span><span class="s4">%s&quot;</span><span class="s2">\n</span><span class="s4">' </span><span class="s3">% </span><span class="s1">shortname</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'SetCompress auto</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'SetCompressor lzma</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'ShowInstDetails nevershow</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'ShowUninstDetails nevershow</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'InstType &quot;Typical&quot;</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>

        <span class="s6"># Tell Vista that we require admin rights</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'RequestExecutionLevel admin</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>

        <span class="s6"># TODO offer run and desktop shortcut after we figure out how to deal</span>
        <span class="s6"># with multiple apps</span>

        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'!include &quot;MUI2.nsh&quot;</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'!define MUI_ABORTWARNING</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'Var StartMenuFolder</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'!insertmacro MUI_PAGE_WELCOME</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s6"># TODO license file</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'!insertmacro MUI_PAGE_DIRECTORY</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'!insertmacro MUI_PAGE_STARTMENU Application $StartMenuFolder</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'!insertmacro MUI_PAGE_INSTFILES</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'!insertmacro MUI_PAGE_FINISH</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'!insertmacro MUI_UNPAGE_WELCOME</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'!insertmacro MUI_UNPAGE_CONFIRM</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'!insertmacro MUI_UNPAGE_INSTFILES</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'!insertmacro MUI_UNPAGE_FINISH</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'!insertmacro MUI_LANGUAGE &quot;English&quot;</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>

        <span class="s6"># This section defines the installer.</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'Section &quot;&quot; SecCore</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'  SetOutPath &quot;$INSTDIR&quot;</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">curdir </span><span class="s3">= </span><span class="s4">&quot;&quot;</span>
        <span class="s1">nsi_dir </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Filename</span><span class="s3">.</span><span class="s1">fromOsSpecific</span><span class="s3">(</span><span class="s1">build_cmd</span><span class="s3">.</span><span class="s1">build_base</span><span class="s3">)</span>
        <span class="s1">build_root_dir </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Filename</span><span class="s3">.</span><span class="s1">fromOsSpecific</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">root</span><span class="s3">, </span><span class="s1">dirs</span><span class="s3">, </span><span class="s1">files </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">walk</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">):</span>
            <span class="s1">dirs</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">()</span>
            <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">files</span><span class="s3">:</span>
                <span class="s1">basefile </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Filename</span><span class="s3">.</span><span class="s1">fromOsSpecific</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">root</span><span class="s3">, </span><span class="s1">name</span><span class="s3">))</span>
                <span class="s1">file </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Filename</span><span class="s3">(</span><span class="s1">basefile</span><span class="s3">)</span>
                <span class="s1">file</span><span class="s3">.</span><span class="s1">makeAbsolute</span><span class="s3">()</span>
                <span class="s1">file</span><span class="s3">.</span><span class="s1">makeRelativeTo</span><span class="s3">(</span><span class="s1">nsi_dir</span><span class="s3">)</span>
                <span class="s1">outdir </span><span class="s3">= </span><span class="s1">p3d</span><span class="s3">.</span><span class="s1">Filename</span><span class="s3">(</span><span class="s1">basefile</span><span class="s3">)</span>
                <span class="s1">outdir</span><span class="s3">.</span><span class="s1">makeAbsolute</span><span class="s3">()</span>
                <span class="s1">outdir</span><span class="s3">.</span><span class="s1">makeRelativeTo</span><span class="s3">(</span><span class="s1">build_root_dir</span><span class="s3">)</span>
                <span class="s1">outdir </span><span class="s3">= </span><span class="s1">outdir</span><span class="s3">.</span><span class="s1">getDirname</span><span class="s3">().</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'/'</span><span class="s3">, </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">'</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">curdir </span><span class="s3">!= </span><span class="s1">outdir</span><span class="s3">:</span>
                    <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'  SetOutPath &quot;$INSTDIR</span><span class="s2">\\</span><span class="s4">%s&quot;</span><span class="s2">\n</span><span class="s4">' </span><span class="s3">% </span><span class="s1">outdir</span><span class="s3">)</span>
                    <span class="s1">curdir </span><span class="s3">= </span><span class="s1">outdir</span>
                <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'  File &quot;%s&quot;</span><span class="s2">\n</span><span class="s4">' </span><span class="s3">% (</span><span class="s1">file</span><span class="s3">.</span><span class="s1">toOsSpecific</span><span class="s3">()))</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'  SetOutPath &quot;$INSTDIR&quot;</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'  WriteUninstaller &quot;$INSTDIR</span><span class="s2">\\</span><span class="s4">Uninstall.exe&quot;</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'  ; Start menu items</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'  !insertmacro MUI_STARTMENU_WRITE_BEGIN Application</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'    CreateDirectory &quot;$SMPROGRAMS</span><span class="s2">\\</span><span class="s4">$StartMenuFolder&quot;</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">app </span><span class="s2">in </span><span class="s1">apps</span><span class="s3">:</span>
            <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'    CreateShortCut &quot;$SMPROGRAMS</span><span class="s2">\\</span><span class="s4">$StartMenuFolder</span><span class="s2">\\</span><span class="s4">%s.lnk&quot; &quot;$INSTDIR</span><span class="s2">\\</span><span class="s4">%s&quot;</span><span class="s2">\n</span><span class="s4">' </span><span class="s3">% (</span><span class="s1">shortname</span><span class="s3">, </span><span class="s1">app</span><span class="s3">))</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'    CreateShortCut &quot;$SMPROGRAMS</span><span class="s2">\\</span><span class="s4">$StartMenuFolder</span><span class="s2">\\</span><span class="s4">Uninstall.lnk&quot; &quot;$INSTDIR</span><span class="s2">\\</span><span class="s4">Uninstall.exe&quot;</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'  !insertmacro MUI_STARTMENU_WRITE_END</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'SectionEnd</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>

        <span class="s6"># This section defines the uninstaller.</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'Section Uninstall</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'  RMDir /r &quot;$INSTDIR&quot;</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'  ; Desktop icon</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'  Delete &quot;$DESKTOP</span><span class="s2">\\</span><span class="s4">%s.lnk&quot;</span><span class="s2">\n</span><span class="s4">' </span><span class="s3">% </span><span class="s1">shortname</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'  ; Start menu items</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'  !insertmacro MUI_STARTMENU_GETFOLDER Application $StartMenuFolder</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'  RMDir /r &quot;$SMPROGRAMS</span><span class="s2">\\</span><span class="s4">$StartMenuFolder&quot;</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'SectionEnd</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">nsi</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

        <span class="s1">cmd </span><span class="s3">= [</span><span class="s4">'makensis'</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">flag </span><span class="s2">in </span><span class="s3">[</span><span class="s4">&quot;V2&quot;</span><span class="s3">]:</span>
            <span class="s1">cmd</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
                <span class="s4">'{}{}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s4">'/' </span><span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'win'</span><span class="s3">) </span><span class="s2">else </span><span class="s4">'-'</span><span class="s3">, </span><span class="s1">flag</span><span class="s3">)</span>
            <span class="s3">)</span>
        <span class="s1">cmd</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">nsifile</span><span class="s3">.</span><span class="s1">to_os_specific</span><span class="s3">())</span>
        <span class="s1">subprocess</span><span class="s3">.</span><span class="s1">check_call</span><span class="s3">(</span><span class="s1">cmd</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">run</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">build_cmd </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">distribution</span><span class="s3">.</span><span class="s1">get_command_obj</span><span class="s3">(</span><span class="s4">'build_apps'</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">opt </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_build_apps_options</span><span class="s3">():</span>
            <span class="s1">optval </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">opt</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">optval </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">setattr</span><span class="s3">(</span><span class="s1">build_cmd</span><span class="s3">, </span><span class="s1">opt</span><span class="s3">, </span><span class="s1">optval</span><span class="s3">)</span>
        <span class="s1">build_cmd</span><span class="s3">.</span><span class="s1">finalize_options</span><span class="s3">()</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">skip_build</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">run_command</span><span class="s3">(</span><span class="s4">'build_apps'</span><span class="s3">)</span>

        <span class="s1">platforms </span><span class="s3">= </span><span class="s1">build_cmd</span><span class="s3">.</span><span class="s1">platforms</span>
        <span class="s1">build_base </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">abspath</span><span class="s3">(</span><span class="s1">build_cmd</span><span class="s3">.</span><span class="s1">build_base</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">):</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">)</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">chdir</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">platform </span><span class="s2">in </span><span class="s1">platforms</span><span class="s3">:</span>
            <span class="s1">build_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">build_base</span><span class="s3">, </span><span class="s1">platform</span><span class="s3">)</span>
            <span class="s1">basename </span><span class="s3">= </span><span class="s4">'{}_{}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">distribution</span><span class="s3">.</span><span class="s1">get_fullname</span><span class="s3">(), </span><span class="s1">platform</span><span class="s3">)</span>
            <span class="s1">installers </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">installers</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">platform</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">DEFAULT_INSTALLERS</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">platform</span><span class="s3">, [</span><span class="s4">'zip'</span><span class="s3">]))</span>

            <span class="s2">for </span><span class="s1">installer </span><span class="s2">in </span><span class="s1">installers</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">Building {} for platform: {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">installer</span><span class="s3">, </span><span class="s1">platform</span><span class="s3">), </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">log</span><span class="s3">.</span><span class="s1">INFO</span><span class="s3">)</span>

                <span class="s2">if </span><span class="s1">installer </span><span class="s3">== </span><span class="s4">'zip'</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">create_zip</span><span class="s3">(</span><span class="s1">basename</span><span class="s3">, </span><span class="s1">build_dir</span><span class="s3">)</span>
                <span class="s2">elif </span><span class="s1">installer </span><span class="s2">in </span><span class="s3">(</span><span class="s4">'gztar'</span><span class="s3">, </span><span class="s4">'bztar'</span><span class="s3">, </span><span class="s4">'xztar'</span><span class="s3">):</span>
                    <span class="s1">compress </span><span class="s3">= </span><span class="s1">installer</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'tar'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">compress </span><span class="s3">== </span><span class="s4">'bz'</span><span class="s3">:</span>
                        <span class="s1">compress </span><span class="s3">= </span><span class="s4">'bz2'</span>

                    <span class="s1">self</span><span class="s3">.</span><span class="s1">create_tarball</span><span class="s3">(</span><span class="s1">basename</span><span class="s3">, </span><span class="s1">build_dir</span><span class="s3">, </span><span class="s1">compress</span><span class="s3">)</span>
                <span class="s2">elif </span><span class="s1">installer </span><span class="s3">== </span><span class="s4">'nsis'</span><span class="s3">:</span>
                    <span class="s2">if not </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'win'</span><span class="s3">):</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span>
                            <span class="s4">'</span><span class="s2">\t</span><span class="s4">NSIS installer not supported for platform: {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">platform</span><span class="s3">),</span>
                            <span class="s1">distutils</span><span class="s3">.</span><span class="s1">log</span><span class="s3">.</span><span class="s1">ERROR</span>
                        <span class="s3">)</span>
                        <span class="s2">continue</span>
                    <span class="s2">try</span><span class="s3">:</span>
                        <span class="s1">subprocess</span><span class="s3">.</span><span class="s1">call</span><span class="s3">([</span><span class="s4">'makensis'</span><span class="s3">, </span><span class="s4">'--version'</span><span class="s3">])</span>
                    <span class="s2">except </span><span class="s1">OSError</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span>
                            <span class="s4">'</span><span class="s2">\t</span><span class="s4">Could not find makensis tool that is required to build NSIS installers'</span><span class="s3">,</span>
                            <span class="s1">distutils</span><span class="s3">.</span><span class="s1">log</span><span class="s3">.</span><span class="s1">ERROR</span>
                        <span class="s3">)</span>
                        <span class="s6"># continue</span>
                    <span class="s1">is_64bit </span><span class="s3">= </span><span class="s1">platform </span><span class="s3">== </span><span class="s4">'win_amd64'</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">create_nsis</span><span class="s3">(</span><span class="s1">basename</span><span class="s3">, </span><span class="s1">build_dir</span><span class="s3">, </span><span class="s1">is_64bit</span><span class="s3">)</span>

                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">announce</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\t</span><span class="s4">Unknown installer: {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">installer</span><span class="s3">), </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">log</span><span class="s3">.</span><span class="s1">ERROR</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">finalize_distribution_options</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Entry point for compatibility with setuptools&gt;=61, see #1394.&quot;&quot;&quot;</span>

    <span class="s1">options </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">get_option_dict</span><span class="s3">(</span><span class="s4">'build_apps'</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">options</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'gui_apps'</span><span class="s3">) </span><span class="s2">or </span><span class="s1">options</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'console_apps'</span><span class="s3">):</span>
        <span class="s6"># Make sure this is set to avoid auto-discovery taking place.</span>
        <span class="s2">if </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">metadata</span><span class="s3">, </span><span class="s4">'py_modules'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">) </span><span class="s2">is None and </span><span class="s1">\</span>
           <span class="s1">getattr</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">metadata</span><span class="s3">, </span><span class="s4">'packages'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">) </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">dist</span><span class="s3">.</span><span class="s1">py_modules </span><span class="s3">= []</span>
</pre>
</body>
</html>