<html>
<head>
<title>Packager.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #cf8e6d;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Packager.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; This module is used to build a &quot;Package&quot;, a collection of files 
within a Panda3D Multifile, which can be easily be downloaded and/or 
patched onto a client machine, for the purpose of running a large 
application. 
 
.. deprecated:: 1.10.0 
   The p3d packaging system has been replaced with the new setuptools-based 
   system.  See the :ref:`distribution` manual section. 
&quot;&quot;&quot;</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">&quot;Packager&quot;</span><span class="s2">, </span><span class="s3">&quot;PackagerError&quot;</span><span class="s2">, </span><span class="s3">&quot;OutsideOfPackageError&quot;</span><span class="s2">, </span><span class="s3">&quot;ArgumentError&quot;</span><span class="s2">]</span>

<span class="s4"># Important to import panda3d first, to avoid naming conflicts with</span>
<span class="s4"># Python's &quot;string&quot; and &quot;Loader&quot; names that are imported later.</span>
<span class="s5">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s5">import </span><span class="s2">*</span>
<span class="s5">import </span><span class="s1">sys</span>
<span class="s5">import </span><span class="s1">os</span>
<span class="s5">import </span><span class="s1">glob</span>
<span class="s5">import </span><span class="s1">struct</span>
<span class="s5">import </span><span class="s1">subprocess</span>
<span class="s5">import </span><span class="s1">copy</span>
<span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">p3d</span><span class="s2">.</span><span class="s1">FileSpec </span><span class="s5">import </span><span class="s1">FileSpec</span>
<span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">p3d</span><span class="s2">.</span><span class="s1">SeqValue </span><span class="s5">import </span><span class="s1">SeqValue</span>
<span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">p3d</span><span class="s2">.</span><span class="s1">HostInfo </span><span class="s5">import </span><span class="s1">HostInfo</span>
<span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase </span><span class="s5">import </span><span class="s1">Loader</span>
<span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase </span><span class="s5">import </span><span class="s1">AppRunnerGlobal</span>
<span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">dist </span><span class="s5">import </span><span class="s1">FreezeTool</span>
<span class="s5">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">directnotify</span><span class="s2">.</span><span class="s1">DirectNotifyGlobal </span><span class="s5">import </span><span class="s2">*</span>

<span class="s1">vfs </span><span class="s2">= </span><span class="s1">VirtualFileSystem</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>

<span class="s5">class </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">):</span>
    <span class="s5">pass</span>

<span class="s5">class </span><span class="s1">OutsideOfPackageError</span><span class="s2">(</span><span class="s1">PackagerError</span><span class="s2">):</span>
    <span class="s5">pass</span>

<span class="s5">class </span><span class="s1">ArgumentError</span><span class="s2">(</span><span class="s1">PackagerError</span><span class="s2">):</span>
    <span class="s5">pass</span>

<span class="s5">class </span><span class="s1">Packager</span><span class="s2">:</span>
    <span class="s1">notify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s3">&quot;Packager&quot;</span><span class="s2">)</span>

    <span class="s5">class </span><span class="s1">PackFile</span><span class="s2">:</span>
        <span class="s5">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">package</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">,</span>
                     <span class="s1">newName </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">deleteTemp </span><span class="s2">= </span><span class="s5">False</span><span class="s2">,</span>
                     <span class="s1">explicit </span><span class="s2">= </span><span class="s5">False</span><span class="s2">, </span><span class="s1">compress </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">extract </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                     <span class="s1">text </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">unprocessed </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                     <span class="s1">executable </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">dependencyDir </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                     <span class="s1">platformSpecific </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">required </span><span class="s2">= </span><span class="s5">False</span><span class="s2">):</span>
            <span class="s5">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">Filename</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">newName </span><span class="s2">= </span><span class="s1">newName</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">deleteTemp </span><span class="s2">= </span><span class="s1">deleteTemp</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">explicit </span><span class="s2">= </span><span class="s1">explicit</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">compress </span><span class="s2">= </span><span class="s1">compress</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">extract </span><span class="s2">= </span><span class="s1">extract</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s1">text</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">unprocessed </span><span class="s2">= </span><span class="s1">unprocessed</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">executable </span><span class="s2">= </span><span class="s1">executable</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">dependencyDir </span><span class="s2">= </span><span class="s1">dependencyDir</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">platformSpecific </span><span class="s2">= </span><span class="s1">platformSpecific</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">required </span><span class="s2">= </span><span class="s1">required</span>

            <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">newName </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>

            <span class="s1">ext </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">).</span><span class="s1">getExtension</span><span class="s2">()</span>
            <span class="s5">if </span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'pz' </span><span class="s5">or </span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'gz'</span><span class="s2">:</span>
                <span class="s4"># Strip off a .pz extension; we can compress files</span>
                <span class="s4"># within the Multifile without it.</span>
                <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">)</span>
                <span class="s1">filename</span><span class="s2">.</span><span class="s1">setExtension</span><span class="s2">(</span><span class="s3">''</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">newName </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
                <span class="s1">ext </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">).</span><span class="s1">getExtension</span><span class="s2">()</span>
                <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compress </span><span class="s5">is None</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">compress </span><span class="s2">= </span><span class="s5">True</span>

            <span class="s1">packager </span><span class="s2">= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packager</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compress </span><span class="s5">is None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">compress </span><span class="s2">= (</span><span class="s1">ext </span><span class="s5">not in </span><span class="s1">packager</span><span class="s2">.</span><span class="s1">uncompressibleExtensions </span><span class="s5">and </span><span class="s1">ext </span><span class="s5">not in </span><span class="s1">packager</span><span class="s2">.</span><span class="s1">imageExtensions</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">executable </span><span class="s5">is None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">executable </span><span class="s2">= (</span><span class="s1">ext </span><span class="s5">in </span><span class="s1">packager</span><span class="s2">.</span><span class="s1">executableExtensions</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">executable </span><span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dependencyDir </span><span class="s5">is None</span><span class="s2">:</span>
                <span class="s4"># By default, install executable dependencies in the</span>
                <span class="s4"># root directory, which is the one that's added to PATH.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">dependencyDir </span><span class="s2">= </span><span class="s3">''</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extract </span><span class="s5">is None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">extract </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">executable </span><span class="s5">or </span><span class="s2">(</span><span class="s1">ext </span><span class="s5">in </span><span class="s1">packager</span><span class="s2">.</span><span class="s1">extractExtensions</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platformSpecific </span><span class="s5">is None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">platformSpecific </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">executable </span><span class="s5">or </span><span class="s2">(</span><span class="s1">ext </span><span class="s5">in </span><span class="s1">packager</span><span class="s2">.</span><span class="s1">platformSpecificExtensions</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unprocessed </span><span class="s5">is None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">unprocessed </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">executable </span><span class="s5">or </span><span class="s2">(</span><span class="s1">ext </span><span class="s5">in </span><span class="s1">packager</span><span class="s2">.</span><span class="s1">unprocessedExtensions</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">:</span>
                <span class="s4"># Look up the filename along the system PATH, if necessary.</span>
                <span class="s5">if not </span><span class="s1">packager</span><span class="s2">.</span><span class="s1">resolveLibrary</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">):</span>
                    <span class="s4"># If it wasn't found, try looking it up under its</span>
                    <span class="s4"># basename only.  Sometimes a Mac user will copy</span>
                    <span class="s4"># the library file out of a framework and put that</span>
                    <span class="s4"># along the PATH, instead of the framework itself.</span>
                    <span class="s1">basename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">())</span>
                    <span class="s5">if </span><span class="s1">packager</span><span class="s2">.</span><span class="s1">resolveLibrary</span><span class="s2">(</span><span class="s1">basename</span><span class="s2">):</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">= </span><span class="s1">basename</span>

            <span class="s5">if </span><span class="s1">ext </span><span class="s5">in </span><span class="s1">packager</span><span class="s2">.</span><span class="s1">textExtensions </span><span class="s5">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">setText</span><span class="s2">()</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>

            <span class="s4"># Convert the filename to an unambiguous filename for</span>
            <span class="s4"># searching.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">makeTrueCase</span><span class="s2">()</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">() </span><span class="s5">or not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">isLocal</span><span class="s2">():</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">makeCanonical</span><span class="s2">()</span>

        <span class="s5">def </span><span class="s1">isExcluded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">package</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Returns true if this file should be excluded or 
            skipped, false otherwise. &quot;&quot;&quot;</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s5">in </span><span class="s1">package</span><span class="s2">.</span><span class="s1">skipFilenames</span><span class="s2">:</span>
                <span class="s5">return True</span>

            <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">explicit</span><span class="s2">:</span>
                <span class="s4"># Make sure it's not one of our auto-excluded system</span>
                <span class="s4"># files.  (But only make this check if this file was</span>
                <span class="s4"># not explicitly added.)</span>

                <span class="s1">basename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">).</span><span class="s1">getBasename</span><span class="s2">()</span>
                <span class="s5">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">caseSensitive</span><span class="s2">:</span>
                    <span class="s1">basename </span><span class="s2">= </span><span class="s1">basename</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span>
                <span class="s5">if </span><span class="s1">basename </span><span class="s5">in </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">excludeSystemFiles</span><span class="s2">:</span>
                    <span class="s5">return True</span>
                <span class="s5">for </span><span class="s1">exclude </span><span class="s5">in </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">excludeSystemGlobs</span><span class="s2">:</span>
                    <span class="s5">if </span><span class="s1">exclude</span><span class="s2">.</span><span class="s1">matches</span><span class="s2">(</span><span class="s1">basename</span><span class="s2">):</span>
                        <span class="s5">return True</span>

                <span class="s4"># Also check if it was explicitly excluded.  As above,</span>
                <span class="s4"># omit this check for an explicitly-added file: if you</span>
                <span class="s4"># both include and exclude a file, the file is</span>
                <span class="s4"># included.</span>
                <span class="s5">for </span><span class="s1">exclude </span><span class="s5">in </span><span class="s1">package</span><span class="s2">.</span><span class="s1">excludedFilenames</span><span class="s2">:</span>
                    <span class="s5">if </span><span class="s1">exclude</span><span class="s2">.</span><span class="s1">matches</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">):</span>
                        <span class="s5">return True</span>

                <span class="s4"># A platform-specific file is implicitly excluded from</span>
                <span class="s4"># not-platform-specific packages.</span>
                <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platformSpecific </span><span class="s5">and </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platformSpecificConfig </span><span class="s5">is False</span><span class="s2">:</span>
                    <span class="s5">return True</span>

            <span class="s5">return False</span>

    <span class="s5">class </span><span class="s1">ExcludeFilename</span><span class="s2">:</span>
        <span class="s5">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packager</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">, </span><span class="s1">caseSensitive</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packager </span><span class="s2">= </span><span class="s1">packager</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">localOnly </span><span class="s2">= (</span><span class="s5">not </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getDirname</span><span class="s2">())</span>
            <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">localOnly</span><span class="s2">:</span>
                <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
                <span class="s1">filename</span><span class="s2">.</span><span class="s1">makeCanonical</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">glob </span><span class="s2">= </span><span class="s1">GlobPattern</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">))</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'win'</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">.</span><span class="s1">setCaseSensitive</span><span class="s2">(</span><span class="s5">False</span><span class="s2">)</span>
            <span class="s5">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'osx'</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">.</span><span class="s1">setCaseSensitive</span><span class="s2">(</span><span class="s5">False</span><span class="s2">)</span>

        <span class="s5">def </span><span class="s1">matches</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">):</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">localOnly</span><span class="s2">:</span>
                <span class="s5">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">.</span><span class="s1">matches</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">())</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s5">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">.</span><span class="s1">matches</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">))</span>

    <span class="s5">class </span><span class="s1">PackageEntry</span><span class="s2">:</span>
        <span class="s0">&quot;&quot;&quot; This corresponds to a &lt;package&gt; entry in the contents.xml 
        file. &quot;&quot;&quot;</span>

        <span class="s5">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s4"># The &quot;seq&quot; value increments automatically with each publish.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSeq </span><span class="s2">= </span><span class="s1">SeqValue</span><span class="s2">()</span>

            <span class="s4"># The &quot;set_ver&quot; value is optionally specified in the pdef</span>
            <span class="s4"># file and does not change unless the user says it does.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSetVer </span><span class="s2">= </span><span class="s1">SeqValue</span><span class="s2">()</span>

        <span class="s5">def </span><span class="s1">getKey</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Returns a tuple used for sorting the PackageEntry 
            objects uniquely per package. &quot;&quot;&quot;</span>
            <span class="s5">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s5">or </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s5">or </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>

        <span class="s5">def </span><span class="s1">fromFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">solo</span><span class="s2">, </span><span class="s1">perPlatform</span><span class="s2">,</span>
                     <span class="s1">installDir</span><span class="s2">, </span><span class="s1">descFilename</span><span class="s2">, </span><span class="s1">importDescFilename</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">= </span><span class="s1">packageName</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">= </span><span class="s1">platform</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s1">version</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">solo </span><span class="s2">= </span><span class="s1">solo</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">perPlatform </span><span class="s2">= </span><span class="s1">perPlatform</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">descFile </span><span class="s2">= </span><span class="s1">FileSpec</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">descFile</span><span class="s2">.</span><span class="s1">fromFile</span><span class="s2">(</span><span class="s1">installDir</span><span class="s2">, </span><span class="s1">descFilename</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">importDescFile </span><span class="s2">= </span><span class="s5">None</span>
            <span class="s5">if </span><span class="s1">importDescFilename</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">importDescFile </span><span class="s2">= </span><span class="s1">FileSpec</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">importDescFile</span><span class="s2">.</span><span class="s1">fromFile</span><span class="s2">(</span><span class="s1">installDir</span><span class="s2">, </span><span class="s1">importDescFilename</span><span class="s2">)</span>

        <span class="s5">def </span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xpackage</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'platform'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'version'</span><span class="s2">)</span>
            <span class="s1">solo </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'solo'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">solo </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">solo </span><span class="s5">or </span><span class="s3">'0'</span><span class="s2">)</span>
            <span class="s1">perPlatform </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'per_platform'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">perPlatform </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">perPlatform </span><span class="s5">or </span><span class="s3">'0'</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSeq </span><span class="s2">= </span><span class="s1">SeqValue</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSeq</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">, </span><span class="s3">'seq'</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSetVer </span><span class="s2">= </span><span class="s1">SeqValue</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSetVer</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">, </span><span class="s3">'set_ver'</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">descFile </span><span class="s2">= </span><span class="s1">FileSpec</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">descFile</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">importDescFile </span><span class="s2">= </span><span class="s5">None</span>
            <span class="s1">ximport </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'import'</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">ximport</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">importDescFile </span><span class="s2">= </span><span class="s1">FileSpec</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">importDescFile</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">ximport</span><span class="s2">)</span>


        <span class="s5">def </span><span class="s1">makeXml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Returns a new TiXmlElement. &quot;&quot;&quot;</span>
            <span class="s1">xpackage </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'package'</span><span class="s2">)</span>
            <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'platform'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'version'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">solo</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'solo'</span><span class="s2">, </span><span class="s3">'1'</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">perPlatform</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'per_platform'</span><span class="s2">, </span><span class="s3">'1'</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSeq</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">, </span><span class="s3">'seq'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSetVer</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">, </span><span class="s3">'set_ver'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">descFile</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">importDescFile</span><span class="s2">:</span>
                <span class="s1">ximport </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'import'</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">importDescFile</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">ximport</span><span class="s2">)</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">ximport</span><span class="s2">)</span>

            <span class="s5">return </span><span class="s1">xpackage</span>

    <span class="s5">class </span><span class="s1">HostEntry</span><span class="s2">:</span>
        <span class="s5">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">url </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">downloadUrl </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                     <span class="s1">descriptiveName </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">hostDir </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                     <span class="s1">mirrors </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">url </span><span class="s2">= </span><span class="s1">url</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadUrl </span><span class="s2">= </span><span class="s1">downloadUrl</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">descriptiveName </span><span class="s2">= </span><span class="s1">descriptiveName</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">hostDir </span><span class="s2">= </span><span class="s1">hostDir</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">mirrors </span><span class="s2">= </span><span class="s1">mirrors </span><span class="s5">or </span><span class="s2">[]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">altHosts </span><span class="s2">= {}</span>

        <span class="s5">def </span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xhost</span><span class="s2">, </span><span class="s1">packager</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">url </span><span class="s2">= </span><span class="s1">xhost</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'url'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">downloadUrl </span><span class="s2">= </span><span class="s1">xhost</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'download_url'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">descriptiveName </span><span class="s2">= </span><span class="s1">xhost</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'descriptive_name'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">hostDir </span><span class="s2">= </span><span class="s1">xhost</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'host_dir'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">mirrors </span><span class="s2">= []</span>
            <span class="s1">xmirror </span><span class="s2">= </span><span class="s1">xhost</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'mirror'</span><span class="s2">)</span>
            <span class="s5">while </span><span class="s1">xmirror</span><span class="s2">:</span>
                <span class="s1">url </span><span class="s2">= </span><span class="s1">xmirror</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'url'</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">mirrors</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">url</span><span class="s2">)</span>
                <span class="s1">xmirror </span><span class="s2">= </span><span class="s1">xmirror</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s3">'mirror'</span><span class="s2">)</span>

            <span class="s1">xalthost </span><span class="s2">= </span><span class="s1">xhost</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'alt_host'</span><span class="s2">)</span>
            <span class="s5">while </span><span class="s1">xalthost</span><span class="s2">:</span>
                <span class="s1">url </span><span class="s2">= </span><span class="s1">xalthost</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'url'</span><span class="s2">)</span>
                <span class="s1">he </span><span class="s2">= </span><span class="s1">packager</span><span class="s2">.</span><span class="s1">addHost</span><span class="s2">(</span><span class="s1">url</span><span class="s2">)</span>
                <span class="s1">he</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xalthost</span><span class="s2">, </span><span class="s1">packager</span><span class="s2">)</span>
                <span class="s1">xalthost </span><span class="s2">= </span><span class="s1">xalthost</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s3">'alt_host'</span><span class="s2">)</span>

        <span class="s5">def </span><span class="s1">makeXml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packager </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Returns a new TiXmlElement. &quot;&quot;&quot;</span>
            <span class="s1">xhost </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'host'</span><span class="s2">)</span>
            <span class="s1">xhost</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'url'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">url</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">downloadUrl </span><span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">downloadUrl </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">url</span><span class="s2">:</span>
                <span class="s1">xhost</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'download_url'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">downloadUrl</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">descriptiveName</span><span class="s2">:</span>
                <span class="s1">xhost</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'descriptive_name'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">descriptiveName</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostDir</span><span class="s2">:</span>
                <span class="s1">xhost</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'host_dir'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hostDir</span><span class="s2">)</span>

            <span class="s5">for </span><span class="s1">mirror </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mirrors</span><span class="s2">:</span>
                <span class="s1">xmirror </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'mirror'</span><span class="s2">)</span>
                <span class="s1">xmirror</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'url'</span><span class="s2">, </span><span class="s1">mirror</span><span class="s2">)</span>
                <span class="s1">xhost</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xmirror</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">packager</span><span class="s2">:</span>
                <span class="s1">altHosts </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">altHosts</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
                <span class="s5">for </span><span class="s1">keyword</span><span class="s2">, </span><span class="s1">alt </span><span class="s5">in </span><span class="s1">altHosts</span><span class="s2">:</span>
                    <span class="s1">he </span><span class="s2">= </span><span class="s1">packager</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">alt</span><span class="s2">, </span><span class="s5">None</span><span class="s2">)</span>
                    <span class="s5">if </span><span class="s1">he</span><span class="s2">:</span>
                        <span class="s1">xalthost </span><span class="s2">= </span><span class="s1">he</span><span class="s2">.</span><span class="s1">makeXml</span><span class="s2">()</span>
                        <span class="s1">xalthost</span><span class="s2">.</span><span class="s1">SetValue</span><span class="s2">(</span><span class="s3">'alt_host'</span><span class="s2">)</span>
                        <span class="s1">xalthost</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'keyword'</span><span class="s2">, </span><span class="s1">keyword</span><span class="s2">)</span>
                        <span class="s1">xhost</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xalthost</span><span class="s2">)</span>

            <span class="s5">return </span><span class="s1">xhost</span>


    <span class="s5">class </span><span class="s1">Package</span><span class="s2">:</span>
        <span class="s0">&quot;&quot;&quot; This is the full information on a particular package we 
        are constructing.  Don't confuse it with PackageEntry, above, 
        which contains only the information found in the toplevel 
        contents.xml file.&quot;&quot;&quot;</span>

        <span class="s5">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">packager</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">= </span><span class="s1">packageName</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packager </span><span class="s2">= </span><span class="s1">packager</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify </span><span class="s2">= </span><span class="s1">packager</span><span class="s2">.</span><span class="s1">notify</span>

            <span class="s4"># The platform is initially None until we know the file is</span>
            <span class="s4"># platform-specific.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">= </span><span class="s5">None</span>

            <span class="s4"># This is always true on modern packages.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">perPlatform </span><span class="s2">= </span><span class="s5">True</span>

            <span class="s4"># The arch string, though, is pre-loaded from the system</span>
            <span class="s4"># arch string, so we can sensibly call otool.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">arch </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">arch</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s5">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">host </span><span class="s2">= </span><span class="s5">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dApplication </span><span class="s2">= </span><span class="s5">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">solo </span><span class="s2">= </span><span class="s5">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">compressionLevel </span><span class="s2">= </span><span class="s6">0</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">importedMapsDir </span><span class="s2">= </span><span class="s3">'imported_maps'</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">mainModule </span><span class="s2">= </span><span class="s5">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">signParams </span><span class="s2">= []</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">requires </span><span class="s2">= []</span>

            <span class="s4"># This may be set explicitly in the pdef file to a</span>
            <span class="s4"># particular sequence value.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSetVer </span><span class="s2">= </span><span class="s1">SeqValue</span><span class="s2">()</span>

            <span class="s4"># This is the set of config variables assigned to the</span>
            <span class="s4"># package.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">configs </span><span class="s2">= {}</span>

            <span class="s4"># This is the set of files and modules, already included</span>
            <span class="s4"># by required packages, that we can skip.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">skipFilenames </span><span class="s2">= {}</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">skipModules </span><span class="s2">= {}</span>

            <span class="s4"># This is a list of ExcludeFilename objects, representing</span>
            <span class="s4"># the files that have been explicitly excluded.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">excludedFilenames </span><span class="s2">= []</span>

            <span class="s4"># This is the list of files we will be adding, and a pair</span>
            <span class="s4"># of cross references.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">files </span><span class="s2">= []</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sourceFilenames </span><span class="s2">= {}</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">targetFilenames </span><span class="s2">= {}</span>

            <span class="s4"># This is the set of files and modules that are</span>
            <span class="s4"># required and may not be excluded from the package.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">requiredFilenames </span><span class="s2">= []</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">requiredModules </span><span class="s2">= []</span>

            <span class="s4"># A list of required packages that were missing.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">missingPackages </span><span class="s2">= []</span>

            <span class="s4"># This records the current list of modules we have added so</span>
            <span class="s4"># far.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">freezer </span><span class="s2">= </span><span class="s1">FreezeTool</span><span class="s2">.</span><span class="s1">Freezer</span><span class="s2">(</span><span class="s1">platform </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">storePythonSource </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">storePythonSource</span>

            <span class="s4"># Map of extensions to files to number (ignored by dir)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ignoredDirFiles </span><span class="s2">= {}</span>

        <span class="s5">def </span><span class="s1">close</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Writes out the contents of the current package.  Returns True 
            if the package was constructed successfully, False if one or more 
            required files or modules are missing. &quot;&quot;&quot;</span>

            <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dApplication </span><span class="s5">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">allowPackages</span><span class="s2">:</span>
                <span class="s1">message </span><span class="s2">= </span><span class="s3">'Cannot generate packages without an installDir; use -i'</span>
                <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignoredDirFiles</span><span class="s2">:</span>
                <span class="s1">exts </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignoredDirFiles</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
                <span class="s1">total </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">([</span><span class="s1">x </span><span class="s5">for </span><span class="s1">x </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignoredDirFiles</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()])</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;excluded %s files not marked for inclusion: %s&quot; </span><span class="s1">\</span>
                                    <span class="s2">% (</span><span class="s1">total</span><span class="s2">, </span><span class="s3">&quot;, &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s3">&quot;'&quot; </span><span class="s2">+ </span><span class="s1">ext </span><span class="s2">+ </span><span class="s3">&quot;'&quot; </span><span class="s5">for </span><span class="s1">ext </span><span class="s5">in </span><span class="s1">exts</span><span class="s2">])))</span>

            <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">host </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">host</span>

            <span class="s4"># Check the version config variable.</span>
            <span class="s1">version </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">configs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'version'</span><span class="s2">, </span><span class="s5">None</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">version </span><span class="s5">is not None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s1">version</span>
                <span class="s5">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">configs</span><span class="s2">[</span><span class="s3">'version'</span><span class="s2">]</span>

            <span class="s4"># Check the platform_specific config variable.  This has</span>
            <span class="s4"># only three settings: None (unset), True, or False.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">platformSpecificConfig </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">configs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'platform_specific'</span><span class="s2">, </span><span class="s5">None</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platformSpecificConfig </span><span class="s5">is not None</span><span class="s2">:</span>
                <span class="s4"># First, convert it to an int, in case it's &quot;0&quot; or &quot;1&quot;.</span>
                <span class="s5">try</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">platformSpecificConfig </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">platformSpecificConfig</span><span class="s2">)</span>
                <span class="s5">except </span><span class="s1">ValueError</span><span class="s2">:</span>
                    <span class="s5">pass</span>
                <span class="s4"># Then, make it a bool.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">platformSpecificConfig </span><span class="s2">= </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">platformSpecificConfig</span><span class="s2">)</span>
                <span class="s5">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">configs</span><span class="s2">[</span><span class="s3">'platform_specific'</span><span class="s2">]</span>

            <span class="s4"># A special case when building the &quot;panda3d&quot; package.  We</span>
            <span class="s4"># enforce that the version number matches what we've been</span>
            <span class="s4"># compiled with.</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">== </span><span class="s3">'panda3d'</span><span class="s2">:</span>
                <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s5">is None</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageVersionString</span><span class="s2">()</span>

                <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">!= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageVersionString</span><span class="s2">():</span>
                    <span class="s1">message </span><span class="s2">= </span><span class="s3">'mismatched Panda3D version: requested %s, but Panda3D is built as %s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">, </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageVersionString</span><span class="s2">())</span>
                    <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

                <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host </span><span class="s2">!= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageHostUrl</span><span class="s2">():</span>
                    <span class="s1">message </span><span class="s2">= </span><span class="s3">'mismatched Panda3D host: requested %s, but Panda3D is built as %s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">, </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageHostUrl</span><span class="s2">())</span>
                    <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dApplication</span><span class="s2">:</span>
                <span class="s4"># Default compression level for an app.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">compressionLevel </span><span class="s2">= </span><span class="s6">6</span>

                <span class="s4"># Every p3dapp requires panda3d.</span>
                <span class="s5">if </span><span class="s3">'panda3d' </span><span class="s5">not in </span><span class="s2">[</span><span class="s1">p</span><span class="s2">.</span><span class="s1">packageName </span><span class="s5">for </span><span class="s1">p </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">]:</span>
                    <span class="s5">assert not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">currentPackage</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">currentPackage </span><span class="s2">= </span><span class="s1">self</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">do_require</span><span class="s2">(</span><span class="s3">'panda3d'</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">currentPackage </span><span class="s2">= </span><span class="s5">None</span>

                <span class="s4"># If this flag is set, enable allow_python_dev.</span>
                <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">allowPythonDev</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">configs</span><span class="s2">[</span><span class="s3">'allow_python_dev'</span><span class="s2">] = </span><span class="s5">True</span>

            <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dApplication </span><span class="s5">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">:</span>
                <span class="s4"># If we don't have an implicit version, inherit the</span>
                <span class="s4"># version from the 'panda3d' package on our require</span>
                <span class="s4"># list.</span>
                <span class="s5">for </span><span class="s1">p2 </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">:</span>
                    <span class="s5">if </span><span class="s1">p2</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">== </span><span class="s3">'panda3d' </span><span class="s5">and </span><span class="s1">p2</span><span class="s2">.</span><span class="s1">version</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s1">p2</span><span class="s2">.</span><span class="s1">version</span>
                        <span class="s5">break</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">solo</span><span class="s2">:</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">installSolo</span><span class="s2">()</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">installMultifile</span><span class="s2">()</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dApplication</span><span class="s2">:</span>
                <span class="s1">allowPythonDev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">configs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'allow_python_dev'</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">int</span><span class="s2">(</span><span class="s1">allowPythonDev</span><span class="s2">):</span>
                    <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s5">\n</span><span class="s3">*** Generating %s.p3d with allow_python_dev enabled ***</span><span class="s5">\n</span><span class="s3">&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">))</span>

            <span class="s5">return </span><span class="s1">result</span>


        <span class="s5">def </span><span class="s1">considerPlatform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s4"># Check to see if any of the files are platform-specific,</span>
            <span class="s4"># making the overall package platform-specific.</span>

            <span class="s1">platformSpecific </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platformSpecificConfig</span>
            <span class="s5">for </span><span class="s1">file </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">files</span><span class="s2">:</span>
                <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">isExcluded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                    <span class="s4"># Skip this file.</span>
                    <span class="s5">continue</span>
                <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">platformSpecific</span><span class="s2">:</span>
                    <span class="s1">platformSpecific </span><span class="s2">= </span><span class="s5">True</span>

            <span class="s5">if </span><span class="s1">platformSpecific </span><span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platformSpecificConfig </span><span class="s5">is not False</span><span class="s2">:</span>
                <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">platform</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'osx_'</span><span class="s2">):</span>
                <span class="s4"># Get the OSX &quot;arch&quot; specification.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">arch </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">[</span><span class="s6">4</span><span class="s2">:]</span>


        <span class="s5">def </span><span class="s1">installMultifile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Installs the package, either as a p3d application, or 
            as a true package.  Either is implemented with a 
            Multifile. &quot;&quot;&quot;</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">missingPackages</span><span class="s2">:</span>
                <span class="s1">missing </span><span class="s2">= </span><span class="s3">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s1">name </span><span class="s5">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">version </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">missingPackages</span><span class="s2">])</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Cannot build package %s due to missing dependencies: %s&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">missing</span><span class="s2">))</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cleanup</span><span class="s2">()</span>
                <span class="s5">return False</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile </span><span class="s2">= </span><span class="s1">Multifile</span><span class="s2">()</span>

            <span class="s4"># Write the multifile to a temporary filename until we</span>
            <span class="s4"># know enough to determine the output filename.</span>
            <span class="s1">multifileFilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">+ </span><span class="s3">'.'</span><span class="s2">, </span><span class="s3">'.mf'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">openReadWrite</span><span class="s2">(</span><span class="s1">multifileFilename</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dApplication</span><span class="s2">:</span>
                <span class="s4"># p3d files should be tagged to make them executable.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">setHeaderPrefix</span><span class="s2">(</span><span class="s3">'#! /usr/bin/env panda3d</span><span class="s5">\n</span><span class="s3">'</span><span class="s2">)</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s4"># Package multifiles might be patched, and therefore</span>
                <span class="s4"># don't want to record an internal timestamp, which</span>
                <span class="s4"># would make patching less efficient.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">setRecordTimestamp</span><span class="s2">(</span><span class="s5">False</span><span class="s2">)</span>

            <span class="s4"># Make sure that all required files are present.</span>
            <span class="s1">missing </span><span class="s2">= []</span>
            <span class="s5">for </span><span class="s1">file </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">requiredFilenames</span><span class="s2">:</span>
                <span class="s5">if </span><span class="s1">file </span><span class="s5">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">files </span><span class="s5">or </span><span class="s1">file</span><span class="s2">.</span><span class="s1">isExcluded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                    <span class="s1">missing</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">())</span>
            <span class="s5">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">missing</span><span class="s2">) &gt; </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Cannot build package %s, missing required files: %r&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">missing</span><span class="s2">))</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cleanup</span><span class="s2">()</span>
                <span class="s5">return False</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">extracts </span><span class="s2">= []</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">components </span><span class="s2">= []</span>

            <span class="s4"># Add the explicit py files that were requested by the</span>
            <span class="s4"># pdef file.  These get turned into Python modules.</span>
            <span class="s5">for </span><span class="s1">file </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">files</span><span class="s2">:</span>
                <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">isExcluded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                    <span class="s4"># Skip this file.</span>
                    <span class="s5">continue</span>
                <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">unprocessed</span><span class="s2">:</span>
                    <span class="s4"># Unprocessed files get dealt with below.</span>
                    <span class="s5">continue</span>

                <span class="s1">ext </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">).</span><span class="s1">getExtension</span><span class="s2">()</span>
                <span class="s5">if </span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'dc'</span><span class="s2">:</span>
                    <span class="s4"># Add the modules named implicitly in the dc file.</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">addDcImports</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>

                <span class="s5">elif </span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'py'</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">addPyFile</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>

            <span class="s4"># Add the main module, if any.</span>
            <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mainModule </span><span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dApplication</span><span class="s2">:</span>
                <span class="s1">message </span><span class="s2">= </span><span class="s3">'No main_module specified for application %s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">)</span>
                <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mainModule</span><span class="s2">:</span>
                <span class="s1">moduleName</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mainModule</span>
                <span class="s5">if </span><span class="s1">newName </span><span class="s5">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">addModule</span><span class="s2">(</span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">newName</span><span class="s2">)</span>

            <span class="s4"># Now all module files have been added.  Exclude modules</span>
            <span class="s4"># already imported in a required package, and not</span>
            <span class="s4"># explicitly included by this package.</span>
            <span class="s5">for </span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">mdef </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">skipModules</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s5">if </span><span class="s1">moduleName </span><span class="s5">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">excludeModule</span><span class="s2">(</span>
                        <span class="s1">moduleName</span><span class="s2">, </span><span class="s1">allowChildren </span><span class="s2">= </span><span class="s1">mdef</span><span class="s2">.</span><span class="s1">allowChildren</span><span class="s2">,</span>
                        <span class="s1">forbid </span><span class="s2">= </span><span class="s1">mdef</span><span class="s2">.</span><span class="s1">forbid</span><span class="s2">, </span><span class="s1">fromSource </span><span class="s2">= </span><span class="s3">'skip'</span><span class="s2">)</span>

            <span class="s4"># Pick up any unfrozen Python files.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">done</span><span class="s2">()</span>

            <span class="s4"># But first, make sure that all required modules are present.</span>
            <span class="s1">missing </span><span class="s2">= []</span>
            <span class="s1">moduleDict </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">getModuleDefs</span><span class="s2">())</span>
            <span class="s5">for </span><span class="s1">module </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">requiredModules</span><span class="s2">:</span>
                <span class="s5">if </span><span class="s1">module </span><span class="s5">not in </span><span class="s1">moduleDict</span><span class="s2">:</span>
                    <span class="s1">missing</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">module</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">missing</span><span class="s2">) &gt; </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Cannot build package %s, missing required modules: %r&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">missing</span><span class="s2">))</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cleanup</span><span class="s2">()</span>
                <span class="s5">return False</span>

            <span class="s4"># OK, we can add it.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">addToMultifile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compressionLevel</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">addExtensionModules</span><span class="s2">()</span>

            <span class="s4"># Add known module names.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">moduleNames </span><span class="s2">= {}</span>
            <span class="s1">modules </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
            <span class="s5">for </span><span class="s1">newName</span><span class="s2">, </span><span class="s1">mdef </span><span class="s5">in </span><span class="s1">modules</span><span class="s2">:</span>
                <span class="s5">if </span><span class="s1">mdef</span><span class="s2">.</span><span class="s1">guess</span><span class="s2">:</span>
                    <span class="s4"># Not really a module.</span>
                    <span class="s5">continue</span>

                <span class="s5">if </span><span class="s1">mdef</span><span class="s2">.</span><span class="s1">fromSource </span><span class="s2">== </span><span class="s3">'skip'</span><span class="s2">:</span>
                    <span class="s4"># This record already appeared in a required</span>
                    <span class="s4"># module; don't repeat it now.</span>
                    <span class="s5">continue</span>

                <span class="s5">if </span><span class="s1">mdef</span><span class="s2">.</span><span class="s1">exclude </span><span class="s5">and </span><span class="s1">mdef</span><span class="s2">.</span><span class="s1">implicit</span><span class="s2">:</span>
                    <span class="s4"># Don't bother mentioning implicitly-excluded</span>
                    <span class="s4"># (i.e. missing) modules.</span>
                    <span class="s5">continue</span>

                <span class="s4">#if newName == '__main__':</span>
                <span class="s4">#    # Ignore this special case.</span>
                <span class="s4">#    continue</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">moduleNames</span><span class="s2">[</span><span class="s1">newName</span><span class="s2">] = </span><span class="s1">mdef</span>

                <span class="s1">xmodule </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'module'</span><span class="s2">)</span>
                <span class="s1">xmodule</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">, </span><span class="s1">newName</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">mdef</span><span class="s2">.</span><span class="s1">exclude</span><span class="s2">:</span>
                    <span class="s1">xmodule</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'exclude'</span><span class="s2">, </span><span class="s3">'1'</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">mdef</span><span class="s2">.</span><span class="s1">forbid</span><span class="s2">:</span>
                    <span class="s1">xmodule</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'forbid'</span><span class="s2">, </span><span class="s3">'1'</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">mdef</span><span class="s2">.</span><span class="s1">exclude </span><span class="s5">and </span><span class="s1">mdef</span><span class="s2">.</span><span class="s1">allowChildren</span><span class="s2">:</span>
                    <span class="s1">xmodule</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'allowChildren'</span><span class="s2">, </span><span class="s3">'1'</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">components</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s3">'m'</span><span class="s2">, </span><span class="s1">newName</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">(), </span><span class="s1">xmodule</span><span class="s2">))</span>

            <span class="s4"># Now look for implicit shared-library dependencies.</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'win'</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__addImplicitDependenciesWindows</span><span class="s2">()</span>
            <span class="s5">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'osx'</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__addImplicitDependenciesOSX</span><span class="s2">()</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__addImplicitDependenciesPosix</span><span class="s2">()</span>

            <span class="s4"># Now add all the real, non-Python files (except model</span>
            <span class="s4"># files).  This will include the extension modules we just</span>
            <span class="s4"># discovered above.</span>
            <span class="s5">for </span><span class="s1">file </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">files</span><span class="s2">:</span>
                <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">isExcluded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                    <span class="s4"># Skip this file.</span>
                    <span class="s5">continue</span>
                <span class="s1">ext </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">).</span><span class="s1">getExtension</span><span class="s2">()</span>
                <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">unprocessed</span><span class="s2">:</span>
                    <span class="s4"># Add an unprocessed file verbatim.</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">addComponent</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>
                <span class="s5">elif </span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'py'</span><span class="s2">:</span>
                    <span class="s4"># Already handled, above.</span>
                    <span class="s5">pass</span>
                <span class="s5">elif </span><span class="s1">file</span><span class="s2">.</span><span class="s1">isExcluded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                    <span class="s4"># Skip this file.</span>
                    <span class="s5">pass</span>
                <span class="s5">elif </span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'egg' </span><span class="s5">or </span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'bam'</span><span class="s2">:</span>
                    <span class="s4"># Skip model files this pass.</span>
                    <span class="s5">pass</span>
                <span class="s5">elif </span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'dc'</span><span class="s2">:</span>
                    <span class="s4"># dc files get a special treatment.</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">addDcFile</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>
                <span class="s5">elif </span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'prc'</span><span class="s2">:</span>
                    <span class="s4"># So do prc files.</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">addPrcFile</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>
                <span class="s5">else</span><span class="s2">:</span>
                    <span class="s4"># Any other file.</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">addComponent</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>

            <span class="s4"># Now add the model files.  It's important to add these</span>
            <span class="s4"># after we have added all of the texture files, so we can</span>
            <span class="s4"># determine which textures need to be implicitly pulled</span>
            <span class="s4"># in.</span>

            <span class="s4"># We walk through a copy of the files list, since we might</span>
            <span class="s4"># be adding more files (textures) to this list as we</span>
            <span class="s4"># discover them in model files referenced in this list.</span>
            <span class="s5">for </span><span class="s1">file </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">files</span><span class="s2">[:]:</span>
                <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">isExcluded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                    <span class="s4"># Skip this file.</span>
                    <span class="s5">continue</span>
                <span class="s1">ext </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">).</span><span class="s1">getExtension</span><span class="s2">()</span>
                <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">unprocessed</span><span class="s2">:</span>
                    <span class="s4"># Already handled, above.</span>
                    <span class="s5">pass</span>
                <span class="s5">elif </span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'py'</span><span class="s2">:</span>
                    <span class="s4"># Already handled, above.</span>
                    <span class="s5">pass</span>
                <span class="s5">elif </span><span class="s1">file</span><span class="s2">.</span><span class="s1">isExcluded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                    <span class="s4"># Skip this file.</span>
                    <span class="s5">pass</span>
                <span class="s5">elif </span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'egg'</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">addEggFile</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>
                <span class="s5">elif </span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'bam'</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">addBamFile</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>
                <span class="s5">else</span><span class="s2">:</span>
                    <span class="s4"># Handled above.</span>
                    <span class="s5">pass</span>

            <span class="s4"># Check to see if we should be platform-specific.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">considerPlatform</span><span class="s2">()</span>

            <span class="s4"># Now that we've processed all of the component files,</span>
            <span class="s4"># (and set our platform if necessary), we can generate the</span>
            <span class="s4"># output filename and write the output files.</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageBasename </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span>
            <span class="s1">packageDir </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageBasename </span><span class="s2">+= </span><span class="s3">'.' </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span>
                <span class="s1">packageDir </span><span class="s2">+= </span><span class="s3">'/' </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageBasename </span><span class="s2">+= </span><span class="s3">'.' </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span>
                <span class="s1">packageDir </span><span class="s2">+= </span><span class="s3">'/' </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageDesc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageBasename </span><span class="s2">+ </span><span class="s3">'.xml'</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageImportDesc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageBasename </span><span class="s2">+ </span><span class="s3">'.import.xml'</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dApplication</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageBasename </span><span class="s2">+= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">p3dSuffix</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageBasename </span><span class="s2">+= </span><span class="s3">'.p3d'</span>
                <span class="s1">packageDir </span><span class="s2">= </span><span class="s3">''</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageBasename </span><span class="s2">+= </span><span class="s3">'.mf'</span>
                <span class="s1">packageDir </span><span class="s2">+= </span><span class="s3">'/'</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageDir </span><span class="s2">= </span><span class="s1">packageDir</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageFilename </span><span class="s2">= </span><span class="s1">packageDir </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageBasename</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageDesc </span><span class="s2">= </span><span class="s1">packageDir </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageDesc</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageImportDesc </span><span class="s2">= </span><span class="s1">packageDir </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageImportDesc</span>

            <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Generating %s&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageFilename</span><span class="s2">))</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dApplication</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageFullpath </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">p3dInstallDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageFilename</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageFullpath</span><span class="s2">.</span><span class="s1">makeDir</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">makeP3dInfo</span><span class="s2">()</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageFullpath </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageFilename</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageFullpath</span><span class="s2">.</span><span class="s1">makeDir</span><span class="s2">()</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">repack</span><span class="s2">()</span>

            <span class="s4"># Also sign the multifile before we close it.</span>
            <span class="s5">for </span><span class="s1">certificate</span><span class="s2">, </span><span class="s1">chain</span><span class="s2">, </span><span class="s1">pkey</span><span class="s2">, </span><span class="s1">password </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">signParams</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">addSignature</span><span class="s2">(</span><span class="s1">certificate</span><span class="s2">, </span><span class="s1">chain </span><span class="s5">or </span><span class="s3">''</span><span class="s2">, </span><span class="s1">pkey </span><span class="s5">or </span><span class="s3">''</span><span class="s2">, </span><span class="s1">password </span><span class="s5">or </span><span class="s3">''</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

            <span class="s5">if not </span><span class="s1">multifileFilename</span><span class="s2">.</span><span class="s1">renameTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageFullpath</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Cannot move %s to %s&quot; </span><span class="s2">% (</span><span class="s1">multifileFilename</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageFullpath</span><span class="s2">))</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">p3dApplication</span><span class="s2">:</span>
                <span class="s4"># No patches for an application; just move it into place.</span>
                <span class="s4"># Make the application file executable.</span>
                <span class="s1">os</span><span class="s2">.</span><span class="s1">chmod</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageFullpath</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s6">0o755</span><span class="s2">)</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">readDescFile</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSeq </span><span class="s2">+= </span><span class="s6">1</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">perPlatform </span><span class="s2">= </span><span class="s5">True  </span><span class="s4"># always true on modern packages.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">compressMultifile</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">writeDescFile</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">writeImportDescFile</span><span class="s2">()</span>

                <span class="s4"># Now that we've written out the desc file, we don't</span>
                <span class="s4"># need to keep around the uncompressed archive</span>
                <span class="s4"># anymore.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageFullpath</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>

                <span class="s4"># Replace or add the entry in the contents.</span>
                <span class="s1">pe </span><span class="s2">= </span><span class="s1">Packager</span><span class="s2">.</span><span class="s1">PackageEntry</span><span class="s2">()</span>
                <span class="s1">pe</span><span class="s2">.</span><span class="s1">fromFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">,</span>
                            <span class="s5">False</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">perPlatform</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">,</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageDesc</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageImportDesc</span><span class="s2">)</span>
                <span class="s1">pe</span><span class="s2">.</span><span class="s1">packageSeq </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageSeq</span>
                <span class="s1">pe</span><span class="s2">.</span><span class="s1">packageSetVer </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageSetVer</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">contents</span><span class="s2">[</span><span class="s1">pe</span><span class="s2">.</span><span class="s1">getKey</span><span class="s2">()] = </span><span class="s1">pe</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">contentsChanged </span><span class="s2">= </span><span class="s5">True</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">cleanup</span><span class="s2">()</span>
            <span class="s5">return True</span>

        <span class="s5">def </span><span class="s1">installSolo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Installs the package as a &quot;solo&quot;, which means we 
            simply copy the one file into the install directory.  This 
            is primarily intended for the &quot;coreapi&quot; plugin, which is 
            just a single dll and a jpg file; but it can support other 
            kinds of similar &quot;solo&quot; packages as well. &quot;&quot;&quot;</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">considerPlatform</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">perPlatform </span><span class="s2">= </span><span class="s5">False  </span><span class="s4"># Not true on &quot;solo&quot; packages.</span>

            <span class="s1">packageDir </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">:</span>
                <span class="s1">packageDir </span><span class="s2">+= </span><span class="s3">'/' </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">:</span>
                <span class="s1">packageDir </span><span class="s2">+= </span><span class="s3">'/' </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span>

            <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">allowPackages</span><span class="s2">:</span>
                <span class="s1">message </span><span class="s2">= </span><span class="s3">'Cannot generate packages without an installDir; use -i'</span>
                <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

            <span class="s1">installPath </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">, </span><span class="s1">packageDir</span><span class="s2">)</span>
            <span class="s4"># Remove any files already in the installPath.</span>
            <span class="s1">origFiles </span><span class="s2">= </span><span class="s1">vfs</span><span class="s2">.</span><span class="s1">scanDirectory</span><span class="s2">(</span><span class="s1">installPath</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">origFiles</span><span class="s2">:</span>
                <span class="s5">for </span><span class="s1">origFile </span><span class="s5">in </span><span class="s1">origFiles</span><span class="s2">:</span>
                    <span class="s1">origFile</span><span class="s2">.</span><span class="s1">getFilename</span><span class="s2">().</span><span class="s1">unlink</span><span class="s2">()</span>

            <span class="s1">files </span><span class="s2">= []</span>
            <span class="s5">for </span><span class="s1">file </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">files</span><span class="s2">:</span>
                <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">isExcluded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                    <span class="s4"># Skip this file.</span>
                    <span class="s5">continue</span>
                <span class="s1">files</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>

            <span class="s5">if not </span><span class="s1">files</span><span class="s2">:</span>
                <span class="s4"># No files, never mind.</span>
                <span class="s5">return</span>

            <span class="s5">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">files</span><span class="s2">) != </span><span class="s6">1</span><span class="s2">:</span>
                <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s3">'Multiple files in &quot;solo&quot; package %s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">))</span>

            <span class="s1">Filename</span><span class="s2">(</span><span class="s1">installPath</span><span class="s2">, </span><span class="s3">''</span><span class="s2">).</span><span class="s1">makeDir</span><span class="s2">()</span>

            <span class="s1">file </span><span class="s2">= </span><span class="s1">files</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
            <span class="s1">targetPath </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">installPath</span><span class="s2">, </span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">)</span>
            <span class="s1">targetPath</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>
            <span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>
            <span class="s5">if not </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">copyTo</span><span class="s2">(</span><span class="s1">targetPath</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Could not copy %s to %s&quot; </span><span class="s2">% (</span>
                    <span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">targetPath</span><span class="s2">))</span>

            <span class="s4"># Replace or add the entry in the contents.</span>
            <span class="s1">pe </span><span class="s2">= </span><span class="s1">Packager</span><span class="s2">.</span><span class="s1">PackageEntry</span><span class="s2">()</span>
            <span class="s1">pe</span><span class="s2">.</span><span class="s1">fromFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">,</span>
                        <span class="s5">True</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">perPlatform</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">,</span>
                        <span class="s1">Filename</span><span class="s2">(</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">), </span><span class="s5">None</span><span class="s2">)</span>
            <span class="s1">peOrig </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">contents</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">pe</span><span class="s2">.</span><span class="s1">getKey</span><span class="s2">(), </span><span class="s5">None</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">peOrig</span><span class="s2">:</span>
                <span class="s1">pe</span><span class="s2">.</span><span class="s1">packageSeq </span><span class="s2">= </span><span class="s1">peOrig</span><span class="s2">.</span><span class="s1">packageSeq </span><span class="s2">+ </span><span class="s6">1</span>
                <span class="s1">pe</span><span class="s2">.</span><span class="s1">packageSetVer </span><span class="s2">= </span><span class="s1">peOrig</span><span class="s2">.</span><span class="s1">packageSetVer</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageSetVer</span><span class="s2">:</span>
                <span class="s1">pe</span><span class="s2">.</span><span class="s1">packageSetVer </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageSetVer</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">contents</span><span class="s2">[</span><span class="s1">pe</span><span class="s2">.</span><span class="s1">getKey</span><span class="s2">()] = </span><span class="s1">pe</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">contentsChanged </span><span class="s2">= </span><span class="s5">True</span>

            <span class="s4"># Hack for coreapi package, to preserve backward compatibility</span>
            <span class="s4"># with old versions of the runtime, which still called the</span>
            <span class="s4"># 32-bit Windows platform &quot;win32&quot;.</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">== </span><span class="s3">&quot;coreapi&quot; </span><span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s3">&quot;win_i386&quot;</span><span class="s2">:</span>
                <span class="s1">pe2 </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">pe</span><span class="s2">)</span>
                <span class="s1">pe2</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">= </span><span class="s3">&quot;win32&quot;</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">contents</span><span class="s2">[</span><span class="s1">pe2</span><span class="s2">.</span><span class="s1">getKey</span><span class="s2">()] = </span><span class="s1">pe2</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">cleanup</span><span class="s2">()</span>
            <span class="s5">return True</span>

        <span class="s5">def </span><span class="s1">cleanup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s4"># Now that all the files have been packed, we can delete</span>
            <span class="s4"># the temporary files.</span>
            <span class="s5">for </span><span class="s1">file </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">files</span><span class="s2">:</span>
                <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">deleteTemp</span><span class="s2">:</span>
                    <span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>

        <span class="s5">def </span><span class="s1">addFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Adds the named file to the package.  Returns the file 
            object, or None if it was not added by this call. &quot;&quot;&quot;</span>

            <span class="s1">file </span><span class="s2">= </span><span class="s1">Packager</span><span class="s2">.</span><span class="s1">PackFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sourceFilenames</span><span class="s2">:</span>
                <span class="s4"># Don't bother, it's already here.</span>
                <span class="s5">return None</span>

            <span class="s1">lowerName </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span>
            <span class="s5">if </span><span class="s1">lowerName </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">targetFilenames</span><span class="s2">:</span>
                <span class="s4"># Another file is already in the same place.</span>
                <span class="s1">file2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">targetFilenames</span><span class="s2">[</span><span class="s1">lowerName</span><span class="s2">]</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span>
                    <span class="s3">&quot;%s is shadowing %s&quot; </span><span class="s2">% (</span><span class="s1">file2</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">))</span>
                <span class="s5">return None</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">sourceFilenames</span><span class="s2">[</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">] = </span><span class="s1">file</span>
            <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">required</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">requiredFilenames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">text </span><span class="s5">is None and not </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">():</span>
                <span class="s5">if not </span><span class="s1">file</span><span class="s2">.</span><span class="s1">isExcluded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;No such file: %s&quot; </span><span class="s2">% (</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">))</span>
                <span class="s5">return None</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">files</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">targetFilenames</span><span class="s2">[</span><span class="s1">lowerName</span><span class="s2">] = </span><span class="s1">file</span>

            <span class="s5">return </span><span class="s1">file</span>

        <span class="s5">def </span><span class="s1">excludeFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Excludes the named file (or glob pattern) from the 
            package. &quot;&quot;&quot;</span>
            <span class="s1">xfile </span><span class="s2">= </span><span class="s1">Packager</span><span class="s2">.</span><span class="s1">ExcludeFilename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">caseSensitive</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">excludedFilenames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">xfile</span><span class="s2">)</span>

        <span class="s5">def </span><span class="s1">__addImplicitDependenciesWindows</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Walks through the list of files, looking for dll's and 
            exe's that might include implicit dependencies on other 
            dll's and assembly manifests.  Tries to determine those 
            dependencies, and adds them back into the filelist. &quot;&quot;&quot;</span>

            <span class="s4"># We walk through the list as we modify it.  That's OK,</span>
            <span class="s4"># because we want to follow the transitive closure of</span>
            <span class="s4"># dependencies anyway.</span>
            <span class="s5">for </span><span class="s1">file </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">files</span><span class="s2">:</span>
                <span class="s5">if not </span><span class="s1">file</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">:</span>
                    <span class="s5">continue</span>

                <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">isExcluded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                    <span class="s4"># Skip this file.</span>
                    <span class="s5">continue</span>

                <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getExtension</span><span class="s2">().</span><span class="s1">lower</span><span class="s2">() == </span><span class="s3">&quot;manifest&quot;</span><span class="s2">:</span>
                    <span class="s1">filenames </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__parseManifest</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>
                    <span class="s5">if </span><span class="s1">filenames </span><span class="s5">is None</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Unable to determine dependent assemblies from %s&quot; </span><span class="s2">% (</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">))</span>
                        <span class="s5">continue</span>

                <span class="s5">else</span><span class="s2">:</span>
                    <span class="s1">tempFile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s3">'p3d_'</span><span class="s2">, </span><span class="s3">'.txt'</span><span class="s2">)</span>
                    <span class="s1">command </span><span class="s2">= </span><span class="s3">'dumpbin /dependents &quot;%s&quot; &gt;&quot;%s&quot;' </span><span class="s2">% (</span>
                        <span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(),</span>
                        <span class="s1">tempFile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
                    <span class="s5">try</span><span class="s2">:</span>
                        <span class="s1">os</span><span class="s2">.</span><span class="s1">system</span><span class="s2">(</span><span class="s1">command</span><span class="s2">)</span>
                    <span class="s5">except</span><span class="s2">:</span>
                        <span class="s5">pass</span>
                    <span class="s1">filenames </span><span class="s2">= </span><span class="s5">None</span>

                    <span class="s5">if </span><span class="s1">tempFile</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">():</span>
                        <span class="s1">filenames </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__parseDependenciesWindows</span><span class="s2">(</span><span class="s1">tempFile</span><span class="s2">)</span>
                        <span class="s1">tempFile</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>
                    <span class="s5">if </span><span class="s1">filenames </span><span class="s5">is None</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Unable to determine dependencies from %s&quot; </span><span class="s2">% (</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">))</span>
                        <span class="s1">filenames </span><span class="s2">= []</span>

                    <span class="s4"># Extract the manifest file so we can figure out</span>
                    <span class="s4"># the dependent assemblies.</span>
                    <span class="s1">tempFile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s3">'p3d_'</span><span class="s2">, </span><span class="s3">'.manifest'</span><span class="s2">)</span>
                    <span class="s1">resindex </span><span class="s2">= </span><span class="s6">2</span>
                    <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getExtension</span><span class="s2">().</span><span class="s1">lower</span><span class="s2">() == </span><span class="s3">&quot;exe&quot;</span><span class="s2">:</span>
                        <span class="s1">resindex </span><span class="s2">= </span><span class="s6">1</span>
                    <span class="s1">command </span><span class="s2">= </span><span class="s3">'mt -inputresource:&quot;%s&quot;;#%d -out:&quot;%s&quot; &gt; nul' </span><span class="s2">% (</span>
                        <span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(),</span>
                        <span class="s1">resindex</span><span class="s2">, </span><span class="s1">tempFile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
                    <span class="s5">try</span><span class="s2">:</span>
                        <span class="s1">out </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">system</span><span class="s2">(</span><span class="s1">command</span><span class="s2">)</span>
                    <span class="s5">except</span><span class="s2">:</span>
                        <span class="s5">pass</span>
                    <span class="s1">afilenames </span><span class="s2">= </span><span class="s5">None</span>

                    <span class="s5">if </span><span class="s1">tempFile</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">():</span>
                        <span class="s1">afilenames </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__parseManifest</span><span class="s2">(</span><span class="s1">tempFile</span><span class="s2">)</span>
                        <span class="s1">tempFile</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>

                    <span class="s4"># Also check for an explicit private-assembly</span>
                    <span class="s4"># manifest file on disk.</span>
                    <span class="s1">mfile </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">+ </span><span class="s3">'.manifest'</span>
                    <span class="s5">if </span><span class="s1">mfile</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">():</span>
                        <span class="s5">if </span><span class="s1">afilenames </span><span class="s5">is None</span><span class="s2">:</span>
                            <span class="s1">afilenames </span><span class="s2">= []</span>
                        <span class="s1">afilenames </span><span class="s2">+= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__parseManifest</span><span class="s2">(</span><span class="s1">mfile</span><span class="s2">)</span>
                        <span class="s4"># Since it's an explicit manifest file, it</span>
                        <span class="s4"># means we should include the manifest</span>
                        <span class="s4"># file itself in the package.</span>
                        <span class="s1">newName </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">dependencyDir</span><span class="s2">, </span><span class="s1">mfile</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">())</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">addFile</span><span class="s2">(</span><span class="s1">mfile</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">newName</span><span class="s2">),</span>
                                     <span class="s1">explicit </span><span class="s2">= </span><span class="s5">False</span><span class="s2">, </span><span class="s1">executable </span><span class="s2">= </span><span class="s5">True</span><span class="s2">)</span>

                    <span class="s5">if </span><span class="s1">afilenames </span><span class="s5">is None and </span><span class="s1">out </span><span class="s2">!= </span><span class="s6">31</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Unable to determine dependent assemblies from %s&quot; </span><span class="s2">% (</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">))</span>

                    <span class="s5">if </span><span class="s1">afilenames </span><span class="s5">is not None</span><span class="s2">:</span>
                        <span class="s1">filenames </span><span class="s2">+= </span><span class="s1">afilenames</span>

                <span class="s4"># Attempt to resolve the dependent filename relative</span>
                <span class="s4"># to the original filename, before we resolve it along</span>
                <span class="s4"># the PATH.</span>
                <span class="s1">path </span><span class="s2">= </span><span class="s1">DSearchPath</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getDirname</span><span class="s2">()))</span>

                <span class="s5">for </span><span class="s1">filename </span><span class="s5">in </span><span class="s1">filenames</span><span class="s2">:</span>
                    <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
                    <span class="s1">filename</span><span class="s2">.</span><span class="s1">resolveFilename</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
                    <span class="s1">filename</span><span class="s2">.</span><span class="s1">makeTrueCase</span><span class="s2">()</span>

                    <span class="s1">newName </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">dependencyDir</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">())</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">addFile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">newName</span><span class="s2">),</span>
                                 <span class="s1">explicit </span><span class="s2">= </span><span class="s5">False</span><span class="s2">, </span><span class="s1">executable </span><span class="s2">= </span><span class="s5">True</span><span class="s2">)</span>

        <span class="s5">def </span><span class="s1">__parseDependenciesWindows</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tempFile</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Reads the indicated temporary file, the output from 
            dumpbin /dependents, to determine the list of dll's this 
            executable file depends on. &quot;&quot;&quot;</span>

            <span class="s1">lines </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">tempFile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">'rU'</span><span class="s2">).</span><span class="s1">readlines</span><span class="s2">()</span>
            <span class="s1">li </span><span class="s2">= </span><span class="s6">0</span>
            <span class="s5">while </span><span class="s1">li </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">):</span>
                <span class="s1">line </span><span class="s2">= </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">li</span><span class="s2">]</span>
                <span class="s1">li </span><span class="s2">+= </span><span class="s6">1</span>
                <span class="s5">if </span><span class="s1">line</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">' has the following dependencies'</span><span class="s2">) != -</span><span class="s6">1</span><span class="s2">:</span>
                    <span class="s5">break</span>

            <span class="s5">if </span><span class="s1">li </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">):</span>
                <span class="s1">line </span><span class="s2">= </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">li</span><span class="s2">]</span>
                <span class="s5">if </span><span class="s1">line</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">() == </span><span class="s3">''</span><span class="s2">:</span>
                    <span class="s4"># Skip a blank line.</span>
                    <span class="s1">li </span><span class="s2">+= </span><span class="s6">1</span>

            <span class="s4"># Now we're finding filenames, until the next blank line.</span>
            <span class="s1">filenames </span><span class="s2">= []</span>
            <span class="s5">while </span><span class="s1">li </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">):</span>
                <span class="s1">line </span><span class="s2">= </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">li</span><span class="s2">]</span>
                <span class="s1">li </span><span class="s2">+= </span><span class="s6">1</span>
                <span class="s1">line </span><span class="s2">= </span><span class="s1">line</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>
                <span class="s5">if </span><span class="s1">line </span><span class="s2">== </span><span class="s3">''</span><span class="s2">:</span>
                    <span class="s4"># We're done.</span>
                    <span class="s5">return </span><span class="s1">filenames</span>
                <span class="s1">filenames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">line</span><span class="s2">)</span>

            <span class="s4"># Hmm, we ran out of data.  Oh well.</span>
            <span class="s5">if not </span><span class="s1">filenames</span><span class="s2">:</span>
                <span class="s4"># Some parse error.</span>
                <span class="s5">return None</span>

            <span class="s4"># At least we got some data.</span>
            <span class="s5">return </span><span class="s1">filenames</span>

        <span class="s5">def </span><span class="s1">__parseManifest</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tempFile</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Reads the indicated application manifest file, to 
            determine the list of dependent assemblies this 
            executable file depends on. &quot;&quot;&quot;</span>

            <span class="s1">doc </span><span class="s2">= </span><span class="s1">TiXmlDocument</span><span class="s2">(</span><span class="s1">tempFile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
            <span class="s5">if not </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">LoadFile</span><span class="s2">():</span>
                <span class="s5">return None</span>

            <span class="s1">assembly </span><span class="s2">= </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">&quot;assembly&quot;</span><span class="s2">)</span>
            <span class="s5">if not </span><span class="s1">assembly</span><span class="s2">:</span>
                <span class="s5">return None</span>

            <span class="s4"># Pick up assemblies that it depends on</span>
            <span class="s1">filenames </span><span class="s2">= []</span>
            <span class="s1">dependency </span><span class="s2">= </span><span class="s1">assembly</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">&quot;dependency&quot;</span><span class="s2">)</span>
            <span class="s5">while </span><span class="s1">dependency</span><span class="s2">:</span>
                <span class="s1">depassembly </span><span class="s2">= </span><span class="s1">dependency</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">&quot;dependentAssembly&quot;</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">depassembly</span><span class="s2">:</span>
                    <span class="s1">ident </span><span class="s2">= </span><span class="s1">depassembly</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">&quot;assemblyIdentity&quot;</span><span class="s2">)</span>
                    <span class="s5">if </span><span class="s1">ident</span><span class="s2">:</span>
                        <span class="s1">name </span><span class="s2">= </span><span class="s1">ident</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">&quot;name&quot;</span><span class="s2">)</span>
                        <span class="s5">if </span><span class="s1">name</span><span class="s2">:</span>
                            <span class="s1">filenames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;.manifest&quot;</span><span class="s2">)</span>

                <span class="s1">dependency </span><span class="s2">= </span><span class="s1">dependency</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s3">&quot;dependency&quot;</span><span class="s2">)</span>

            <span class="s4"># Pick up direct dll dependencies that it lists</span>
            <span class="s1">dfile </span><span class="s2">= </span><span class="s1">assembly</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">&quot;file&quot;</span><span class="s2">)</span>
            <span class="s5">while </span><span class="s1">dfile</span><span class="s2">:</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">dfile</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">&quot;name&quot;</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">name</span><span class="s2">:</span>
                    <span class="s1">filenames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">dfile </span><span class="s2">= </span><span class="s1">dfile</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s3">&quot;file&quot;</span><span class="s2">)</span>

            <span class="s5">return </span><span class="s1">filenames</span>

        <span class="s5">def </span><span class="s1">__locateFrameworkLibrary</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">library</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Locates the given library inside its framework on the 
            default framework paths, and returns its location as Filename. &quot;&quot;&quot;</span>

            <span class="s4"># If it's already a full existing path, we</span>
            <span class="s4"># don't search for it anymore, of course.</span>
            <span class="s5">if </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">library</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">():</span>
                <span class="s5">return </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">library</span><span class="s2">)</span>

            <span class="s4"># DSearchPath appears not to work for directories.</span>
            <span class="s1">fpath </span><span class="s2">= []</span>
            <span class="s1">fpath</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s3">&quot;/Library/Frameworks&quot;</span><span class="s2">))</span>
            <span class="s1">fpath</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s3">&quot;/System/Library/Frameworks&quot;</span><span class="s2">))</span>
            <span class="s1">fpath</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s3">&quot;/Developer/Library/Frameworks&quot;</span><span class="s2">))</span>
            <span class="s1">fpath</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">expanduser</span><span class="s2">(</span><span class="s3">&quot;~&quot;</span><span class="s2">), </span><span class="s3">&quot;Library/Frameworks&quot;</span><span class="s2">))</span>
            <span class="s5">if </span><span class="s3">&quot;HOME&quot; </span><span class="s5">in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">:</span>
                <span class="s1">fpath</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">[</span><span class="s3">&quot;HOME&quot;</span><span class="s2">], </span><span class="s3">&quot;Library/Frameworks&quot;</span><span class="s2">))</span>
            <span class="s1">ffilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">library</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'.framework/'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">)[-</span><span class="s6">1</span><span class="s2">] + </span><span class="s3">'.framework'</span><span class="s2">)</span>
            <span class="s1">ffilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">ffilename</span><span class="s2">, </span><span class="s1">library</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'.framework/'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)[-</span><span class="s6">1</span><span class="s2">])</span>

            <span class="s4"># Look under the system root first, if supplied.</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">systemRoot</span><span class="s2">:</span>
                <span class="s5">for </span><span class="s1">i </span><span class="s5">in </span><span class="s1">fpath</span><span class="s2">:</span>
                    <span class="s1">fw </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">systemRoot</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
                    <span class="s5">if </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">fw</span><span class="s2">, </span><span class="s1">ffilename</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">():</span>
                        <span class="s5">return </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">fw</span><span class="s2">, </span><span class="s1">ffilename</span><span class="s2">)</span>

            <span class="s5">for </span><span class="s1">i </span><span class="s5">in </span><span class="s1">fpath</span><span class="s2">:</span>
                <span class="s5">if </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">ffilename</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">():</span>
                    <span class="s5">return </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">ffilename</span><span class="s2">)</span>

            <span class="s4"># Not found? Well, let's just return the framework + file</span>
            <span class="s4"># path, the user will be presented with a warning later.</span>
            <span class="s5">return </span><span class="s1">ffilename</span>

        <span class="s5">def </span><span class="s1">__alterFrameworkDependencies</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">, </span><span class="s1">framework_deps</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Copies the given library file to a temporary directory, 
            and alters the dependencies so that it doesn't contain absolute 
            framework dependencies. &quot;&quot;&quot;</span>

            <span class="s5">if not </span><span class="s1">file</span><span class="s2">.</span><span class="s1">deleteTemp</span><span class="s2">:</span>
                <span class="s4"># Copy the file to a temporary location because we</span>
                <span class="s4"># don't want to modify the original (there's a big</span>
                <span class="s4"># chance that we break it).</span>

                <span class="s4"># Copy it every time, because the source file might</span>
                <span class="s4"># have changed since last time we ran.</span>
                <span class="s5">assert </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(), </span><span class="s3">&quot;File doesn't exist: %s&quot; </span><span class="s2">% </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span>
                <span class="s1">tmpfile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s3">&quot;p3d_&quot; </span><span class="s2">+ </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">())</span>
                <span class="s1">tmpfile</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>
                <span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">copyTo</span><span class="s2">(</span><span class="s1">tmpfile</span><span class="s2">)</span>
                <span class="s1">file</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">= </span><span class="s1">tmpfile</span>
                <span class="s1">file</span><span class="s2">.</span><span class="s1">deleteTemp </span><span class="s2">= </span><span class="s5">True</span>

            <span class="s4"># Alter the dependencies to have a relative path rather than absolute</span>
            <span class="s5">for </span><span class="s1">filename </span><span class="s5">in </span><span class="s1">framework_deps</span><span class="s2">:</span>
                <span class="s1">loc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__locateFrameworkLibrary</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>

                <span class="s5">if </span><span class="s1">loc </span><span class="s2">== </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">:</span>
                    <span class="s1">os</span><span class="s2">.</span><span class="s1">system</span><span class="s2">(</span><span class="s3">'install_name_tool -id &quot;%s&quot; &quot;%s&quot;' </span><span class="s2">% (</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()))</span>
                <span class="s5">elif </span><span class="s3">&quot;/System/&quot; </span><span class="s5">in </span><span class="s1">loc</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">():</span>
                    <span class="s4"># Let's keep references to system frameworks absolute</span>
                    <span class="s1">os</span><span class="s2">.</span><span class="s1">system</span><span class="s2">(</span><span class="s3">'install_name_tool -change &quot;%s&quot; &quot;%s&quot; &quot;%s&quot;' </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()))</span>
                <span class="s5">else</span><span class="s2">:</span>
                    <span class="s1">os</span><span class="s2">.</span><span class="s1">system</span><span class="s2">(</span><span class="s3">'install_name_tool -change &quot;%s&quot; &quot;%s&quot; &quot;%s&quot;' </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()))</span>

        <span class="s5">def </span><span class="s1">__addImplicitDependenciesOSX</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Walks through the list of files, looking for dylib's 
            and executables that might include implicit dependencies 
            on other dylib's.  Tries to determine those dependencies, 
            and adds them back into the filelist. &quot;&quot;&quot;</span>

            <span class="s4"># We walk through the list as we modify it.  That's OK,</span>
            <span class="s4"># because we want to follow the transitive closure of</span>
            <span class="s4"># dependencies anyway.</span>
            <span class="s5">for </span><span class="s1">file </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">files</span><span class="s2">:</span>
                <span class="s5">if not </span><span class="s1">file</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">:</span>
                    <span class="s5">continue</span>

                <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">isExcluded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                    <span class="s4"># Skip this file.</span>
                    <span class="s5">continue</span>

                <span class="s1">origFilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>

                <span class="s1">tempFile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s3">'p3d_'</span><span class="s2">, </span><span class="s3">'.txt'</span><span class="s2">)</span>
                <span class="s1">command </span><span class="s2">= </span><span class="s3">'/usr/bin/otool -arch all -L &quot;%s&quot; &gt;&quot;%s&quot;' </span><span class="s2">% (</span>
                    <span class="s1">origFilename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(),</span>
                    <span class="s1">tempFile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
                <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arch</span><span class="s2">:</span>
                    <span class="s1">arch </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arch</span>
                    <span class="s5">if </span><span class="s1">arch </span><span class="s2">== </span><span class="s3">&quot;amd64&quot;</span><span class="s2">:</span>
                        <span class="s1">arch </span><span class="s2">= </span><span class="s3">&quot;x86_64&quot;</span>
                    <span class="s1">command </span><span class="s2">= </span><span class="s3">'/usr/bin/otool -arch %s -L &quot;%s&quot; &gt;&quot;%s&quot;' </span><span class="s2">% (</span>
                        <span class="s1">arch</span><span class="s2">,</span>
                        <span class="s1">origFilename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(),</span>
                        <span class="s1">tempFile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
                <span class="s1">exitStatus </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">system</span><span class="s2">(</span><span class="s1">command</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">exitStatus </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">'Command failed: %s' </span><span class="s2">% (</span><span class="s1">command</span><span class="s2">))</span>
                <span class="s1">filenames </span><span class="s2">= </span><span class="s5">None</span>

                <span class="s5">if </span><span class="s1">tempFile</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">():</span>
                    <span class="s1">filenames </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__parseDependenciesOSX</span><span class="s2">(</span><span class="s1">tempFile</span><span class="s2">)</span>
                    <span class="s1">tempFile</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>
                <span class="s5">if </span><span class="s1">filenames </span><span class="s5">is None</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Unable to determine dependencies from %s&quot; </span><span class="s2">% (</span><span class="s1">origFilename</span><span class="s2">))</span>
                    <span class="s5">continue</span>

                <span class="s4"># Attempt to resolve the dependent filename relative</span>
                <span class="s4"># to the original filename, before we resolve it along</span>
                <span class="s4"># the PATH.</span>
                <span class="s1">path </span><span class="s2">= </span><span class="s1">DSearchPath</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">origFilename</span><span class="s2">.</span><span class="s1">getDirname</span><span class="s2">()))</span>

                <span class="s4"># Find the dependencies that are referencing a framework</span>
                <span class="s1">framework_deps </span><span class="s2">= []</span>
                <span class="s5">for </span><span class="s1">filename </span><span class="s5">in </span><span class="s1">filenames</span><span class="s2">:</span>
                    <span class="s5">if </span><span class="s3">'.framework/' </span><span class="s5">in </span><span class="s1">filename</span><span class="s2">:</span>
                        <span class="s1">framework_deps</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>

                <span class="s5">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">framework_deps</span><span class="s2">) &gt; </span><span class="s6">0</span><span class="s2">:</span>
                    <span class="s4"># Fixes dependencies like @executable_path/../Library/Frameworks/Cg.framework/Cg</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">__alterFrameworkDependencies</span><span class="s2">(</span><span class="s1">file</span><span class="s2">, </span><span class="s1">framework_deps</span><span class="s2">)</span>

                <span class="s5">for </span><span class="s1">filename </span><span class="s5">in </span><span class="s1">filenames</span><span class="s2">:</span>
                    <span class="s5">if </span><span class="s3">'@loader_path' </span><span class="s5">in </span><span class="s1">filename</span><span class="s2">:</span>
                        <span class="s1">filename </span><span class="s2">= </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">'@loader_path'</span><span class="s2">, </span><span class="s1">origFilename</span><span class="s2">.</span><span class="s1">getDirname</span><span class="s2">())</span>

                    <span class="s5">if False and </span><span class="s3">'.framework/' </span><span class="s5">in </span><span class="s1">filename</span><span class="s2">:</span>
                        <span class="s4"># It references a framework, and besides the fact</span>
                        <span class="s4"># that those often contain absolute paths, they</span>
                        <span class="s4"># aren't commonly on the library path either.</span>
                        <span class="s1">filename </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__locateFrameworkLibrary</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
                        <span class="s1">filename</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>
                    <span class="s5">else</span><span class="s2">:</span>
                        <span class="s4"># It's just a normal library - find it on the path.</span>
                        <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
                        <span class="s1">filename</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>

                        <span class="s5">if </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">isLocal</span><span class="s2">():</span>
                            <span class="s1">filename</span><span class="s2">.</span><span class="s1">resolveFilename</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
                        <span class="s5">else</span><span class="s2">:</span>
                            <span class="s4"># It's a fully-specified filename; look</span>
                            <span class="s4"># for it under the system root first.</span>
                            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">systemRoot</span><span class="s2">:</span>
                                <span class="s1">f2 </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">systemRoot</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">)</span>
                                <span class="s5">if </span><span class="s1">f2</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">():</span>
                                    <span class="s1">filename </span><span class="s2">= </span><span class="s1">f2</span>

                    <span class="s4"># Skip libraries and frameworks in system directory</span>
                    <span class="s5">if </span><span class="s3">&quot;/System/&quot; </span><span class="s5">in </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">():</span>
                        <span class="s5">continue</span>

                    <span class="s1">newName </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">dependencyDir</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">())</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">addFile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">newName</span><span class="s2">),</span>
                                 <span class="s1">explicit </span><span class="s2">= </span><span class="s5">False</span><span class="s2">, </span><span class="s1">executable </span><span class="s2">= </span><span class="s5">True</span><span class="s2">)</span>

        <span class="s5">def </span><span class="s1">__parseDependenciesOSX</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tempFile</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Reads the indicated temporary file, the output from 
            otool -L, to determine the list of dylibs this 
            executable file depends on. &quot;&quot;&quot;</span>

            <span class="s1">lines </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">tempFile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">'rU'</span><span class="s2">).</span><span class="s1">readlines</span><span class="s2">()</span>

            <span class="s1">filenames </span><span class="s2">= []</span>
            <span class="s5">for </span><span class="s1">line </span><span class="s5">in </span><span class="s1">lines</span><span class="s2">:</span>
                <span class="s5">if not </span><span class="s1">line</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">isspace</span><span class="s2">():</span>
                    <span class="s5">continue</span>
                <span class="s1">line </span><span class="s2">= </span><span class="s1">line</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>
                <span class="s1">s </span><span class="s2">= </span><span class="s1">line</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">' (compatibility'</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">s </span><span class="s2">!= -</span><span class="s6">1</span><span class="s2">:</span>
                    <span class="s1">line </span><span class="s2">= </span><span class="s1">line</span><span class="s2">[:</span><span class="s1">s</span><span class="s2">]</span>
                <span class="s5">else</span><span class="s2">:</span>
                    <span class="s1">s </span><span class="s2">= </span><span class="s1">line</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">'.dylib'</span><span class="s2">)</span>
                    <span class="s5">if </span><span class="s1">s </span><span class="s2">!= -</span><span class="s6">1</span><span class="s2">:</span>
                        <span class="s1">line </span><span class="s2">= </span><span class="s1">line</span><span class="s2">[:</span><span class="s1">s </span><span class="s2">+ </span><span class="s6">6</span><span class="s2">]</span>
                    <span class="s5">else</span><span class="s2">:</span>
                        <span class="s5">continue</span>
                <span class="s1">filenames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">line</span><span class="s2">)</span>

            <span class="s5">return </span><span class="s1">filenames</span>

        <span class="s5">def </span><span class="s1">__readAndStripELF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Reads the indicated ELF binary, and returns a list with 
            dependencies.  If it contains data that should be stripped, 
            it writes the stripped library to a temporary file.  Returns 
            None if the file failed to read (e.g. not an ELF file). &quot;&quot;&quot;</span>

            <span class="s4"># Read the first 16 bytes, which identify the ELF file.</span>
            <span class="s1">elf </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">'rb'</span><span class="s2">)</span>
            <span class="s5">try</span><span class="s2">:</span>
                <span class="s1">ident </span><span class="s2">= </span><span class="s1">elf</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s6">16</span><span class="s2">)</span>
            <span class="s5">except </span><span class="s1">IOError</span><span class="s2">:</span>
                <span class="s1">elf</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
                <span class="s5">return None</span>

            <span class="s5">if not </span><span class="s1">ident</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s5">\177</span><span class="s7">ELF&quot;</span><span class="s2">):</span>
                <span class="s4"># No elf magic!  Beware of orcs.</span>
                <span class="s5">return None</span>

            <span class="s4"># Make sure we read in the correct endianness and integer size</span>
            <span class="s1">byteOrder </span><span class="s2">= </span><span class="s3">&quot;&lt;&gt;&quot;</span><span class="s2">[</span><span class="s1">ord</span><span class="s2">(</span><span class="s1">ident</span><span class="s2">[</span><span class="s6">5</span><span class="s2">:</span><span class="s6">6</span><span class="s2">]) - </span><span class="s6">1</span><span class="s2">]</span>
            <span class="s1">elfClass </span><span class="s2">= </span><span class="s1">ord</span><span class="s2">(</span><span class="s1">ident</span><span class="s2">[</span><span class="s6">4</span><span class="s2">:</span><span class="s6">5</span><span class="s2">]) - </span><span class="s6">1 </span><span class="s4"># 0 = 32-bits, 1 = 64-bits</span>
            <span class="s1">headerStruct </span><span class="s2">= </span><span class="s1">byteOrder </span><span class="s2">+ (</span><span class="s3">&quot;HHIIIIIHHHHHH&quot;</span><span class="s2">, </span><span class="s3">&quot;HHIQQQIHHHHHH&quot;</span><span class="s2">)[</span><span class="s1">elfClass</span><span class="s2">]</span>
            <span class="s1">sectionStruct </span><span class="s2">= </span><span class="s1">byteOrder </span><span class="s2">+ (</span><span class="s3">&quot;4xI8xIII8xI&quot;</span><span class="s2">, </span><span class="s3">&quot;4xI16xQQI12xQ&quot;</span><span class="s2">)[</span><span class="s1">elfClass</span><span class="s2">]</span>
            <span class="s1">dynamicStruct </span><span class="s2">= </span><span class="s1">byteOrder </span><span class="s2">+ (</span><span class="s3">&quot;iI&quot;</span><span class="s2">, </span><span class="s3">&quot;qQ&quot;</span><span class="s2">)[</span><span class="s1">elfClass</span><span class="s2">]</span>

            <span class="s1">type</span><span class="s2">, </span><span class="s1">machine</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">, </span><span class="s1">phoff</span><span class="s2">, </span><span class="s1">shoff</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">ehsize</span><span class="s2">, </span><span class="s1">phentsize</span><span class="s2">, </span><span class="s1">phnum</span><span class="s2">, </span><span class="s1">shentsize</span><span class="s2">, </span><span class="s1">shnum</span><span class="s2">, </span><span class="s1">shstrndx \</span>
              <span class="s2">= </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s1">headerStruct</span><span class="s2">, </span><span class="s1">elf</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">calcsize</span><span class="s2">(</span><span class="s1">headerStruct</span><span class="s2">)))</span>
            <span class="s1">dynamicSections </span><span class="s2">= []</span>
            <span class="s1">stringTables </span><span class="s2">= {}</span>

            <span class="s4"># Seek to the section header table and find the .dynamic section.</span>
            <span class="s1">elf</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">shoff</span><span class="s2">)</span>
            <span class="s5">for </span><span class="s1">i </span><span class="s5">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">shnum</span><span class="s2">):</span>
                <span class="s1">type</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">link</span><span class="s2">, </span><span class="s1">entsize </span><span class="s2">= </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack_from</span><span class="s2">(</span><span class="s1">sectionStruct</span><span class="s2">, </span><span class="s1">elf</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">shentsize</span><span class="s2">))</span>
                <span class="s5">if </span><span class="s1">type </span><span class="s2">== </span><span class="s6">6 </span><span class="s5">and </span><span class="s1">link </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">: </span><span class="s4"># DYNAMIC type, links to string table</span>
                    <span class="s1">dynamicSections</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">offset</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">link</span><span class="s2">, </span><span class="s1">entsize</span><span class="s2">))</span>
                    <span class="s1">stringTables</span><span class="s2">[</span><span class="s1">link</span><span class="s2">] = </span><span class="s5">None</span>

            <span class="s4"># Read the relevant string tables.</span>
            <span class="s5">for </span><span class="s1">idx </span><span class="s5">in </span><span class="s1">stringTables</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">():</span>
                <span class="s1">elf</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">shoff </span><span class="s2">+ </span><span class="s1">idx </span><span class="s2">* </span><span class="s1">shentsize</span><span class="s2">)</span>
                <span class="s1">type</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">link</span><span class="s2">, </span><span class="s1">entsize </span><span class="s2">= </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack_from</span><span class="s2">(</span><span class="s1">sectionStruct</span><span class="s2">, </span><span class="s1">elf</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">shentsize</span><span class="s2">))</span>
                <span class="s5">if </span><span class="s1">type </span><span class="s2">!= </span><span class="s6">3</span><span class="s2">: </span><span class="s5">continue</span>
                <span class="s1">elf</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">offset</span><span class="s2">)</span>
                <span class="s1">stringTables</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">] = </span><span class="s1">elf</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">size</span><span class="s2">)</span>

            <span class="s4"># Loop through the dynamic sections and rewrite it if it has an rpath/runpath.</span>
            <span class="s1">rewriteSections </span><span class="s2">= []</span>
            <span class="s1">filenames </span><span class="s2">= []</span>
            <span class="s1">rpath </span><span class="s2">= []</span>
            <span class="s5">for </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">link</span><span class="s2">, </span><span class="s1">entsize </span><span class="s5">in </span><span class="s1">dynamicSections</span><span class="s2">:</span>
                <span class="s1">elf</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">offset</span><span class="s2">)</span>
                <span class="s1">data </span><span class="s2">= </span><span class="s1">elf</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">entsize</span><span class="s2">)</span>
                <span class="s1">tag</span><span class="s2">, </span><span class="s1">val </span><span class="s2">= </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack_from</span><span class="s2">(</span><span class="s1">dynamicStruct</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>
                <span class="s1">newSectionData </span><span class="s2">= </span><span class="s7">b&quot;&quot;</span>
                <span class="s1">startReplace </span><span class="s2">= </span><span class="s5">None</span>
                <span class="s1">pad </span><span class="s2">= </span><span class="s6">0</span>

                <span class="s4"># Read tags until we find a NULL tag.</span>
                <span class="s5">while </span><span class="s1">tag </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">:</span>
                    <span class="s5">if </span><span class="s1">tag </span><span class="s2">== </span><span class="s6">1</span><span class="s2">: </span><span class="s4"># A NEEDED entry.  Read it from the string table.</span>
                        <span class="s1">filenames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stringTables</span><span class="s2">[</span><span class="s1">link</span><span class="s2">][</span><span class="s1">val </span><span class="s2">: </span><span class="s1">stringTables</span><span class="s2">[</span><span class="s1">link</span><span class="s2">].</span><span class="s1">find</span><span class="s2">(</span><span class="s7">b'</span><span class="s5">\0</span><span class="s7">'</span><span class="s2">, </span><span class="s1">val</span><span class="s2">)])</span>

                    <span class="s5">elif </span><span class="s1">tag </span><span class="s2">== </span><span class="s6">15 </span><span class="s5">or </span><span class="s1">tag </span><span class="s2">== </span><span class="s6">29</span><span class="s2">:</span>
                        <span class="s1">rpath </span><span class="s2">+= </span><span class="s1">stringTables</span><span class="s2">[</span><span class="s1">link</span><span class="s2">][</span><span class="s1">val </span><span class="s2">: </span><span class="s1">stringTables</span><span class="s2">[</span><span class="s1">link</span><span class="s2">].</span><span class="s1">find</span><span class="s2">(</span><span class="s7">b'</span><span class="s5">\0</span><span class="s7">'</span><span class="s2">, </span><span class="s1">val</span><span class="s2">)].</span><span class="s1">split</span><span class="s2">(</span><span class="s7">b':'</span><span class="s2">)</span>
                        <span class="s4"># An RPATH or RUNPATH entry.</span>
                        <span class="s5">if not </span><span class="s1">startReplace</span><span class="s2">:</span>
                            <span class="s1">startReplace </span><span class="s2">= </span><span class="s1">elf</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">() - </span><span class="s1">entsize</span>
                        <span class="s5">if </span><span class="s1">startReplace</span><span class="s2">:</span>
                            <span class="s1">pad </span><span class="s2">+= </span><span class="s1">entsize</span>

                    <span class="s5">elif </span><span class="s1">startReplace </span><span class="s5">is not None</span><span class="s2">:</span>
                        <span class="s1">newSectionData </span><span class="s2">+= </span><span class="s1">data</span>

                    <span class="s1">data </span><span class="s2">= </span><span class="s1">elf</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">entsize</span><span class="s2">)</span>
                    <span class="s1">tag</span><span class="s2">, </span><span class="s1">val </span><span class="s2">= </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack_from</span><span class="s2">(</span><span class="s1">dynamicStruct</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>

                <span class="s5">if </span><span class="s1">startReplace </span><span class="s5">is not None</span><span class="s2">:</span>
                    <span class="s1">newSectionData </span><span class="s2">+= </span><span class="s1">data </span><span class="s2">+ (</span><span class="s7">b&quot;</span><span class="s5">\0</span><span class="s7">&quot; </span><span class="s2">* </span><span class="s1">pad</span><span class="s2">)</span>
                    <span class="s1">rewriteSections</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">startReplace</span><span class="s2">, </span><span class="s1">newSectionData</span><span class="s2">))</span>
            <span class="s1">elf</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

            <span class="s4"># No rpaths/runpaths found, so nothing to do any more.</span>
            <span class="s5">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">rewriteSections</span><span class="s2">) == </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s5">return </span><span class="s1">filenames</span>

            <span class="s4"># Attempt to resolve any of the directly</span>
            <span class="s4"># dependent filenames along the RPATH.</span>
            <span class="s5">for </span><span class="s1">f </span><span class="s5">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">filenames</span><span class="s2">)):</span>
                <span class="s1">filename </span><span class="s2">= </span><span class="s1">filenames</span><span class="s2">[</span><span class="s1">f</span><span class="s2">]</span>
                <span class="s5">for </span><span class="s1">rdir </span><span class="s5">in </span><span class="s1">rpath</span><span class="s2">:</span>
                    <span class="s5">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">rdir</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">)):</span>
                        <span class="s1">filenames</span><span class="s2">[</span><span class="s1">f</span><span class="s2">] = </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">rdir</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">)</span>
                        <span class="s5">break</span>

            <span class="s5">if not </span><span class="s1">file</span><span class="s2">.</span><span class="s1">deleteTemp</span><span class="s2">:</span>
                <span class="s4"># Copy the file to a temporary location because we</span>
                <span class="s4"># don't want to modify the original (there's a big</span>
                <span class="s4"># chance that we break it).</span>

                <span class="s1">tmpfile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s3">&quot;p3d_&quot; </span><span class="s2">+ </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">())</span>
                <span class="s1">tmpfile</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>
                <span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">copyTo</span><span class="s2">(</span><span class="s1">tmpfile</span><span class="s2">)</span>
                <span class="s1">file</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">= </span><span class="s1">tmpfile</span>
                <span class="s1">file</span><span class="s2">.</span><span class="s1">deleteTemp </span><span class="s2">= </span><span class="s5">True</span>

            <span class="s4"># Open the temporary file and rewrite the dynamic sections.</span>
            <span class="s1">elf </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">'r+b'</span><span class="s2">)</span>
            <span class="s5">for </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">data </span><span class="s5">in </span><span class="s1">rewriteSections</span><span class="s2">:</span>
                <span class="s1">elf</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">offset</span><span class="s2">)</span>
                <span class="s1">elf</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
            <span class="s1">elf</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s5">\0</span><span class="s7">&quot; </span><span class="s2">* </span><span class="s1">pad</span><span class="s2">)</span>
            <span class="s1">elf</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
            <span class="s5">return </span><span class="s1">filenames</span>

        <span class="s5">def </span><span class="s1">__addImplicitDependenciesPosix</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Walks through the list of files, looking for so's 
            and executables that might include implicit dependencies 
            on other so's.  Tries to determine those dependencies, 
            and adds them back into the filelist. &quot;&quot;&quot;</span>

            <span class="s4"># We walk through the list as we modify it.  That's OK,</span>
            <span class="s4"># because we want to follow the transitive closure of</span>
            <span class="s4"># dependencies anyway.</span>
            <span class="s5">for </span><span class="s1">file </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">files</span><span class="s2">:</span>
                <span class="s5">if not </span><span class="s1">file</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">:</span>
                    <span class="s5">continue</span>

                <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">isExcluded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                    <span class="s4"># Skip this file.</span>
                    <span class="s5">continue</span>

                <span class="s4"># Check if this is an ELF binary.</span>
                <span class="s1">filenames </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__readAndStripELF</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>

                <span class="s4"># If that failed, perhaps ldd will help us.</span>
                <span class="s5">if </span><span class="s1">filenames </span><span class="s5">is None</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Reading ELF library %s failed, using ldd instead&quot; </span><span class="s2">% (</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">))</span>
                    <span class="s1">tempFile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s3">'p3d_'</span><span class="s2">, </span><span class="s3">'.txt'</span><span class="s2">)</span>
                    <span class="s1">command </span><span class="s2">= </span><span class="s3">'ldd &quot;%s&quot; &gt;&quot;%s&quot;' </span><span class="s2">% (</span>
                        <span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(),</span>
                        <span class="s1">tempFile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
                    <span class="s5">try</span><span class="s2">:</span>
                        <span class="s1">os</span><span class="s2">.</span><span class="s1">system</span><span class="s2">(</span><span class="s1">command</span><span class="s2">)</span>
                    <span class="s5">except</span><span class="s2">:</span>
                        <span class="s5">pass</span>

                    <span class="s5">if </span><span class="s1">tempFile</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">():</span>
                        <span class="s1">filenames </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__parseDependenciesPosix</span><span class="s2">(</span><span class="s1">tempFile</span><span class="s2">)</span>
                        <span class="s1">tempFile</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>

                <span class="s5">if </span><span class="s1">filenames </span><span class="s5">is None</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Unable to determine dependencies from %s&quot; </span><span class="s2">% (</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">))</span>
                    <span class="s5">continue</span>

                <span class="s4"># Attempt to resolve the dependent filename relative</span>
                <span class="s4"># to the original filename, before we resolve it along</span>
                <span class="s4"># the PATH.</span>
                <span class="s1">path </span><span class="s2">= </span><span class="s1">DSearchPath</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getDirname</span><span class="s2">()))</span>

                <span class="s5">for </span><span class="s1">filename </span><span class="s5">in </span><span class="s1">filenames</span><span class="s2">:</span>
                    <span class="s4"># These vDSO's provided by Linux aren't</span>
                    <span class="s4"># supposed to be anywhere on the system.</span>
                    <span class="s5">if </span><span class="s1">filename </span><span class="s5">in </span><span class="s2">[</span><span class="s3">&quot;linux-gate.so.1&quot;</span><span class="s2">, </span><span class="s3">&quot;linux-vdso.so.1&quot;</span><span class="s2">]:</span>
                        <span class="s5">continue</span>

                    <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
                    <span class="s1">filename</span><span class="s2">.</span><span class="s1">resolveFilename</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
                    <span class="s1">filename</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>

                    <span class="s1">newName </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">dependencyDir</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">())</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">addFile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">newName</span><span class="s2">),</span>
                                 <span class="s1">explicit </span><span class="s2">= </span><span class="s5">False</span><span class="s2">, </span><span class="s1">executable </span><span class="s2">= </span><span class="s5">True</span><span class="s2">)</span>

        <span class="s5">def </span><span class="s1">__parseDependenciesPosix</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tempFile</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Reads the indicated temporary file, the output from 
            ldd, to determine the list of so's this executable file 
            depends on. &quot;&quot;&quot;</span>

            <span class="s1">lines </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">tempFile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">'rU'</span><span class="s2">).</span><span class="s1">readlines</span><span class="s2">()</span>

            <span class="s1">filenames </span><span class="s2">= []</span>
            <span class="s5">for </span><span class="s1">line </span><span class="s5">in </span><span class="s1">lines</span><span class="s2">:</span>
                <span class="s1">line </span><span class="s2">= </span><span class="s1">line</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>
                <span class="s1">s </span><span class="s2">= </span><span class="s1">line</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">' =&gt; '</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">s </span><span class="s2">== -</span><span class="s6">1</span><span class="s2">:</span>
                    <span class="s5">continue</span>

                <span class="s1">line </span><span class="s2">= </span><span class="s1">line</span><span class="s2">[:</span><span class="s1">s</span><span class="s2">].</span><span class="s1">strip</span><span class="s2">()</span>
                <span class="s1">filenames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">line</span><span class="s2">)</span>

            <span class="s5">return </span><span class="s1">filenames</span>

        <span class="s5">def </span><span class="s1">addExtensionModules</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Adds the extension modules detected by the freezer to 
            the current list of files. &quot;&quot;&quot;</span>

            <span class="s1">freezer </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span>
            <span class="s5">for </span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">filename </span><span class="s5">in </span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">extras</span><span class="s2">:</span>
                <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
                <span class="s1">newName </span><span class="s2">= </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">()</span>
                <span class="s5">if </span><span class="s3">'.' </span><span class="s5">in </span><span class="s1">moduleName</span><span class="s2">:</span>
                    <span class="s1">newName </span><span class="s2">= </span><span class="s3">'/'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">moduleName</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">)[:-</span><span class="s6">1</span><span class="s2">])</span>
                    <span class="s1">newName </span><span class="s2">+= </span><span class="s3">'/' </span><span class="s2">+ </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">()</span>
                <span class="s4"># Sometimes the PYTHONPATH has the wrong case in it.</span>
                <span class="s1">filename</span><span class="s2">.</span><span class="s1">makeTrueCase</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">addFile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">newName</span><span class="s2">,</span>
                             <span class="s1">explicit </span><span class="s2">= </span><span class="s5">False</span><span class="s2">, </span><span class="s1">extract </span><span class="s2">= </span><span class="s5">True</span><span class="s2">,</span>
                             <span class="s1">executable </span><span class="s2">= </span><span class="s5">True</span><span class="s2">,</span>
                             <span class="s1">platformSpecific </span><span class="s2">= </span><span class="s5">True</span><span class="s2">)</span>
            <span class="s1">freezer</span><span class="s2">.</span><span class="s1">extras </span><span class="s2">= []</span>


        <span class="s5">def </span><span class="s1">makeP3dInfo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Makes the p3d_info.xml file that defines the 
            application startup parameters and such. &quot;&quot;&quot;</span>

            <span class="s1">doc </span><span class="s2">= </span><span class="s1">TiXmlDocument</span><span class="s2">()</span>
            <span class="s1">decl </span><span class="s2">= </span><span class="s1">TiXmlDeclaration</span><span class="s2">(</span><span class="s3">&quot;1.0&quot;</span><span class="s2">, </span><span class="s3">&quot;utf-8&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
            <span class="s1">doc</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">decl</span><span class="s2">)</span>

            <span class="s1">xpackage </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'package'</span><span class="s2">)</span>
            <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'platform'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'version'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>

            <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'main_module'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mainModule</span><span class="s2">[</span><span class="s6">1</span><span class="s2">])</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">__addConfigs</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">)</span>

            <span class="s1">requireHosts </span><span class="s2">= {}</span>
            <span class="s5">for </span><span class="s1">package </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">:</span>
                <span class="s1">xrequires </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'requires'</span><span class="s2">)</span>
                <span class="s1">xrequires</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">version</span><span class="s2">:</span>
                    <span class="s1">xrequires</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'version'</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>
                <span class="s1">xrequires</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'host'</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">host</span><span class="s2">)</span>
                <span class="s1">package</span><span class="s2">.</span><span class="s1">packageSeq</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xrequires</span><span class="s2">, </span><span class="s3">'seq'</span><span class="s2">)</span>
                <span class="s1">package</span><span class="s2">.</span><span class="s1">packageSetVer</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xrequires</span><span class="s2">, </span><span class="s3">'set_ver'</span><span class="s2">)</span>
                <span class="s1">requireHosts</span><span class="s2">[</span><span class="s1">package</span><span class="s2">.</span><span class="s1">host</span><span class="s2">] = </span><span class="s5">True</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xrequires</span><span class="s2">)</span>

            <span class="s5">for </span><span class="s1">host </span><span class="s5">in </span><span class="s1">requireHosts</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">():</span>
                <span class="s1">he </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">host</span><span class="s2">, </span><span class="s5">None</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">he</span><span class="s2">:</span>
                    <span class="s1">xhost </span><span class="s2">= </span><span class="s1">he</span><span class="s2">.</span><span class="s1">makeXml</span><span class="s2">(</span><span class="s1">packager </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">)</span>
                    <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xhost</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">extracts</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">()</span>
            <span class="s5">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">xextract </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extracts</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xextract</span><span class="s2">)</span>

            <span class="s1">doc</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">)</span>

            <span class="s4"># Write the xml file to a temporary file on disk, so we</span>
            <span class="s4"># can add it to the multifile.</span>
            <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s3">'p3d_'</span><span class="s2">, </span><span class="s3">'.xml'</span><span class="s2">)</span>

            <span class="s4"># This should really be setText() for an xml file, but it</span>
            <span class="s4"># doesn't really matter that much since tinyxml can read</span>
            <span class="s4"># it either way; and if we use setBinary() it will remain</span>
            <span class="s4"># compatible with older versions of the core API that</span>
            <span class="s4"># didn't understand the SF_text flag.</span>
            <span class="s1">filename</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>

            <span class="s1">doc</span><span class="s2">.</span><span class="s1">SaveFile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>

            <span class="s4"># It's important not to compress this file: the core API</span>
            <span class="s4"># runtime can't decode compressed subfiles.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">addSubfile</span><span class="s2">(</span><span class="s3">'p3d_info.xml'</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">flush</span><span class="s2">()</span>
            <span class="s1">filename</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>


        <span class="s5">def </span><span class="s1">compressMultifile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Compresses the .mf file into an .mf.pz file. &quot;&quot;&quot;</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">oldCompressedBasename</span><span class="s2">:</span>
                <span class="s4"># Remove the previous compressed file first.</span>
                <span class="s1">compressedPath </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">, </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">oldCompressedBasename</span><span class="s2">))</span>
                <span class="s1">compressedPath</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>

            <span class="s1">newCompressedFilename </span><span class="s2">= </span><span class="s3">'%s.pz' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageFilename</span><span class="s2">)</span>

            <span class="s4"># Now build the new version.</span>
            <span class="s1">compressedPath </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">, </span><span class="s1">newCompressedFilename</span><span class="s2">)</span>
            <span class="s5">if not </span><span class="s1">compressFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageFullpath</span><span class="s2">, </span><span class="s1">compressedPath</span><span class="s2">, </span><span class="s6">6</span><span class="s2">):</span>
                <span class="s1">message </span><span class="s2">= </span><span class="s3">'Unable to write %s' </span><span class="s2">% (</span><span class="s1">compressedPath</span><span class="s2">)</span>
                <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

        <span class="s5">def </span><span class="s1">readDescFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Reads the existing package.xml file before rewriting 
            it.  We need this to preserve the list of patches, and 
            similar historic data, between sessions. &quot;&quot;&quot;</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSeq </span><span class="s2">= </span><span class="s1">SeqValue</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSetVer </span><span class="s2">= </span><span class="s1">SeqValue</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">patchVersion </span><span class="s2">= </span><span class="s5">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">patches </span><span class="s2">= []</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">oldCompressedBasename </span><span class="s2">= </span><span class="s5">None</span>

            <span class="s1">packageDescFullpath </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageDesc</span><span class="s2">)</span>
            <span class="s1">doc </span><span class="s2">= </span><span class="s1">TiXmlDocument</span><span class="s2">(</span><span class="s1">packageDescFullpath</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
            <span class="s5">if not </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">LoadFile</span><span class="s2">():</span>
                <span class="s5">return</span>

            <span class="s1">xpackage </span><span class="s2">= </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'package'</span><span class="s2">)</span>
            <span class="s5">if not </span><span class="s1">xpackage</span><span class="s2">:</span>
                <span class="s5">return</span>

            <span class="s1">perPlatform </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'per_platform'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">perPlatform </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">perPlatform </span><span class="s5">or </span><span class="s3">'0'</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSeq</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">, </span><span class="s3">'seq'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSetVer</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">, </span><span class="s3">'set_ver'</span><span class="s2">)</span>

            <span class="s1">xcompressed </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'compressed_archive'</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">xcompressed</span><span class="s2">:</span>
                <span class="s1">compressedFilename </span><span class="s2">= </span><span class="s1">xcompressed</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'filename'</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">compressedFilename</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">oldCompressedBasename </span><span class="s2">= </span><span class="s1">compressedFilename</span>

            <span class="s1">patchVersion </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'patch_version'</span><span class="s2">)</span>
            <span class="s5">if not </span><span class="s1">patchVersion</span><span class="s2">:</span>
                <span class="s1">patchVersion </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'last_patch_version'</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">patchVersion</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">patchVersion </span><span class="s2">= </span><span class="s1">patchVersion</span>

            <span class="s4"># Extract the base_version, top_version, and patch</span>
            <span class="s4"># entries, if any, and preserve these entries verbatim for</span>
            <span class="s4"># the next version.</span>
            <span class="s1">xbase </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'base_version'</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">xbase</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">xbase</span><span class="s2">.</span><span class="s1">Clone</span><span class="s2">())</span>
            <span class="s1">xtop </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'top_version'</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">xtop</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">xtop</span><span class="s2">.</span><span class="s1">Clone</span><span class="s2">())</span>

            <span class="s1">xpatch </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'patch'</span><span class="s2">)</span>
            <span class="s5">while </span><span class="s1">xpatch</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">xpatch</span><span class="s2">.</span><span class="s1">Clone</span><span class="s2">())</span>
                <span class="s1">xpatch </span><span class="s2">= </span><span class="s1">xpatch</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s3">'patch'</span><span class="s2">)</span>

        <span class="s5">def </span><span class="s1">writeDescFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Makes the package.xml file that describes the package 
            and its contents, for download. &quot;&quot;&quot;</span>

            <span class="s1">packageDescFullpath </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageDesc</span><span class="s2">)</span>
            <span class="s1">doc </span><span class="s2">= </span><span class="s1">TiXmlDocument</span><span class="s2">(</span><span class="s1">packageDescFullpath</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
            <span class="s1">decl </span><span class="s2">= </span><span class="s1">TiXmlDeclaration</span><span class="s2">(</span><span class="s3">&quot;1.0&quot;</span><span class="s2">, </span><span class="s3">&quot;utf-8&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
            <span class="s1">doc</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">decl</span><span class="s2">)</span>

            <span class="s1">xpackage </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'package'</span><span class="s2">)</span>
            <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'platform'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'version'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">perPlatform</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'per_platform'</span><span class="s2">, </span><span class="s3">'1'</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">patchVersion</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'last_patch_version'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">patchVersion</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSeq</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">, </span><span class="s3">'seq'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSetVer</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">, </span><span class="s3">'set_ver'</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">__addConfigs</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">)</span>

            <span class="s5">for </span><span class="s1">package </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">:</span>
                <span class="s1">xrequires </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'requires'</span><span class="s2">)</span>
                <span class="s1">xrequires</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s5">and </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">:</span>
                    <span class="s1">xrequires</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'platform'</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">version</span><span class="s2">:</span>
                    <span class="s1">xrequires</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'version'</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>
                <span class="s1">package</span><span class="s2">.</span><span class="s1">packageSeq</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xrequires</span><span class="s2">, </span><span class="s3">'seq'</span><span class="s2">)</span>
                <span class="s1">package</span><span class="s2">.</span><span class="s1">packageSetVer</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xrequires</span><span class="s2">, </span><span class="s3">'set_ver'</span><span class="s2">)</span>
                <span class="s1">xrequires</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'host'</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">host</span><span class="s2">)</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xrequires</span><span class="s2">)</span>

            <span class="s1">xuncompressedArchive </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getFileSpec</span><span class="s2">(</span>
                <span class="s3">'uncompressed_archive'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageFullpath</span><span class="s2">,</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageBasename</span><span class="s2">)</span>
            <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xuncompressedArchive</span><span class="s2">)</span>

            <span class="s1">xcompressedArchive </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getFileSpec</span><span class="s2">(</span>
                <span class="s3">'compressed_archive'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageFullpath </span><span class="s2">+ </span><span class="s3">'.pz'</span><span class="s2">,</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">packageBasename </span><span class="s2">+ </span><span class="s3">'.pz'</span><span class="s2">)</span>
            <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xcompressedArchive</span><span class="s2">)</span>

            <span class="s4"># Copy in the patch entries read from the previous version</span>
            <span class="s4"># of the desc file.</span>
            <span class="s5">for </span><span class="s1">xpatch </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">patches</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xpatch</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">extracts</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">()</span>
            <span class="s5">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">xextract </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extracts</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xextract</span><span class="s2">)</span>

            <span class="s1">doc</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">)</span>
            <span class="s1">doc</span><span class="s2">.</span><span class="s1">SaveFile</span><span class="s2">()</span>

        <span class="s5">def </span><span class="s1">__addConfigs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xpackage</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Adds the XML config values defined in self.configs to 
            the indicated XML element. &quot;&quot;&quot;</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">configs</span><span class="s2">:</span>
                <span class="s1">xconfig </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'config'</span><span class="s2">)</span>

                <span class="s5">for </span><span class="s1">variable</span><span class="s2">, </span><span class="s1">value </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">configs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                    <span class="s5">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&lt; (</span><span class="s6">3</span><span class="s2">, </span><span class="s6">0</span><span class="s2">) </span><span class="s5">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">unicode</span><span class="s2">):</span>
                        <span class="s1">xconfig</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s1">variable</span><span class="s2">, </span><span class="s1">value</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">'utf-8'</span><span class="s2">))</span>
                    <span class="s5">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">bool</span><span class="s2">):</span>
                        <span class="s4"># True or False must be encoded as 1 or 0.</span>
                        <span class="s1">xconfig</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s1">variable</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)))</span>
                    <span class="s5">else</span><span class="s2">:</span>
                        <span class="s1">xconfig</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s1">variable</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">value</span><span class="s2">))</span>

                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xconfig</span><span class="s2">)</span>

        <span class="s5">def </span><span class="s1">writeImportDescFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Makes the package.import.xml file that describes the 
            package and its contents, for other packages and 
            applications that may wish to &quot;require&quot; this one. &quot;&quot;&quot;</span>

            <span class="s1">packageImportDescFullpath </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageImportDesc</span><span class="s2">)</span>
            <span class="s1">doc </span><span class="s2">= </span><span class="s1">TiXmlDocument</span><span class="s2">(</span><span class="s1">packageImportDescFullpath</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
            <span class="s1">decl </span><span class="s2">= </span><span class="s1">TiXmlDeclaration</span><span class="s2">(</span><span class="s3">&quot;1.0&quot;</span><span class="s2">, </span><span class="s3">&quot;utf-8&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
            <span class="s1">doc</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">decl</span><span class="s2">)</span>

            <span class="s1">xpackage </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'package'</span><span class="s2">)</span>
            <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'platform'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'version'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'host'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSeq</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">, </span><span class="s3">'seq'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSetVer</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">, </span><span class="s3">'set_ver'</span><span class="s2">)</span>

            <span class="s1">requireHosts </span><span class="s2">= {}</span>
            <span class="s1">requireHosts</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">] = </span><span class="s5">True</span>

            <span class="s5">for </span><span class="s1">package </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">:</span>
                <span class="s1">xrequires </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'requires'</span><span class="s2">)</span>
                <span class="s1">xrequires</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s5">and </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">:</span>
                    <span class="s1">xrequires</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'platform'</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">version</span><span class="s2">:</span>
                    <span class="s1">xrequires</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'version'</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>
                <span class="s1">xrequires</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'host'</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">host</span><span class="s2">)</span>
                <span class="s1">package</span><span class="s2">.</span><span class="s1">packageSeq</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xrequires</span><span class="s2">, </span><span class="s3">'seq'</span><span class="s2">)</span>
                <span class="s1">package</span><span class="s2">.</span><span class="s1">packageSetVer</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xrequires</span><span class="s2">, </span><span class="s3">'set_ver'</span><span class="s2">)</span>
                <span class="s1">requireHosts</span><span class="s2">[</span><span class="s1">package</span><span class="s2">.</span><span class="s1">host</span><span class="s2">] = </span><span class="s5">True</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xrequires</span><span class="s2">)</span>

            <span class="s4"># Make sure we also write the full host descriptions for</span>
            <span class="s4"># any hosts we reference, so we can find these guys later.</span>
            <span class="s5">for </span><span class="s1">host </span><span class="s5">in </span><span class="s1">requireHosts</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">():</span>
                <span class="s1">he </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">host</span><span class="s2">, </span><span class="s5">None</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">he</span><span class="s2">:</span>
                    <span class="s1">xhost </span><span class="s2">= </span><span class="s1">he</span><span class="s2">.</span><span class="s1">makeXml</span><span class="s2">(</span><span class="s1">packager </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">)</span>
                    <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xhost</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">components</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">()</span>
            <span class="s5">for </span><span class="s1">type</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">xcomponent </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">components</span><span class="s2">:</span>
                <span class="s1">xpackage</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xcomponent</span><span class="s2">)</span>

            <span class="s1">doc</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">)</span>
            <span class="s1">doc</span><span class="s2">.</span><span class="s1">SaveFile</span><span class="s2">()</span>

        <span class="s5">def </span><span class="s1">readImportDescFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Reads the import desc file.  Returns True on success, 
            False on failure. &quot;&quot;&quot;</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSeq </span><span class="s2">= </span><span class="s1">SeqValue</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSetVer </span><span class="s2">= </span><span class="s1">SeqValue</span><span class="s2">()</span>

            <span class="s1">doc </span><span class="s2">= </span><span class="s1">TiXmlDocument</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
            <span class="s5">if not </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">LoadFile</span><span class="s2">():</span>
                <span class="s5">return False</span>
            <span class="s1">xpackage </span><span class="s2">= </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'package'</span><span class="s2">)</span>
            <span class="s5">if not </span><span class="s1">xpackage</span><span class="s2">:</span>
                <span class="s5">return False</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'platform'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'version'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">host </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'host'</span><span class="s2">)</span>

            <span class="s4"># Get any new host descriptors.</span>
            <span class="s1">xhost </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'host'</span><span class="s2">)</span>
            <span class="s5">while </span><span class="s1">xhost</span><span class="s2">:</span>
                <span class="s1">he </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">HostEntry</span><span class="s2">()</span>
                <span class="s1">he</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xhost</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">he</span><span class="s2">.</span><span class="s1">url </span><span class="s5">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">[</span><span class="s1">he</span><span class="s2">.</span><span class="s1">url</span><span class="s2">] = </span><span class="s1">he</span>
                <span class="s1">xhost </span><span class="s2">= </span><span class="s1">xhost</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s3">'host'</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSeq</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">, </span><span class="s3">'seq'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packageSetVer</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">, </span><span class="s3">'set_ver'</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">requires </span><span class="s2">= []</span>
            <span class="s1">xrequires </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'requires'</span><span class="s2">)</span>
            <span class="s5">while </span><span class="s1">xrequires</span><span class="s2">:</span>
                <span class="s1">packageName </span><span class="s2">= </span><span class="s1">xrequires</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">)</span>
                <span class="s1">platform </span><span class="s2">= </span><span class="s1">xrequires</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'platform'</span><span class="s2">)</span>
                <span class="s1">version </span><span class="s2">= </span><span class="s1">xrequires</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'version'</span><span class="s2">)</span>
                <span class="s1">host </span><span class="s2">= </span><span class="s1">xrequires</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'host'</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">packageName</span><span class="s2">:</span>
                    <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">findPackage</span><span class="s2">(</span>
                        <span class="s1">packageName</span><span class="s2">, </span><span class="s1">platform </span><span class="s2">= </span><span class="s1">platform</span><span class="s2">, </span><span class="s1">version </span><span class="s2">= </span><span class="s1">version</span><span class="s2">,</span>
                        <span class="s1">host </span><span class="s2">= </span><span class="s1">host</span><span class="s2">, </span><span class="s1">requires </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">)</span>
                    <span class="s5">if </span><span class="s1">package</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">package</span><span class="s2">)</span>
                <span class="s1">xrequires </span><span class="s2">= </span><span class="s1">xrequires</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s3">'requires'</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">targetFilenames </span><span class="s2">= {}</span>
            <span class="s1">xcomponent </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'component'</span><span class="s2">)</span>
            <span class="s5">while </span><span class="s1">xcomponent</span><span class="s2">:</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">xcomponent</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'filename'</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">name</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">targetFilenames</span><span class="s2">[</span><span class="s1">name</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()] = </span><span class="s5">True</span>
                <span class="s1">xcomponent </span><span class="s2">= </span><span class="s1">xcomponent</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s3">'component'</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">moduleNames </span><span class="s2">= {}</span>
            <span class="s1">xmodule </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'module'</span><span class="s2">)</span>
            <span class="s5">while </span><span class="s1">xmodule</span><span class="s2">:</span>
                <span class="s1">moduleName </span><span class="s2">= </span><span class="s1">xmodule</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">)</span>
                <span class="s1">exclude </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">xmodule</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'exclude'</span><span class="s2">) </span><span class="s5">or </span><span class="s6">0</span><span class="s2">)</span>
                <span class="s1">forbid </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">xmodule</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'forbid'</span><span class="s2">) </span><span class="s5">or </span><span class="s6">0</span><span class="s2">)</span>
                <span class="s1">allowChildren </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">xmodule</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'allowChildren'</span><span class="s2">) </span><span class="s5">or </span><span class="s6">0</span><span class="s2">)</span>

                <span class="s5">if </span><span class="s1">moduleName</span><span class="s2">:</span>
                    <span class="s1">mdef </span><span class="s2">= </span><span class="s1">FreezeTool</span><span class="s2">.</span><span class="s1">Freezer</span><span class="s2">.</span><span class="s1">ModuleDef</span><span class="s2">(</span>
                        <span class="s1">moduleName</span><span class="s2">, </span><span class="s1">exclude </span><span class="s2">= </span><span class="s1">exclude</span><span class="s2">, </span><span class="s1">forbid </span><span class="s2">= </span><span class="s1">forbid</span><span class="s2">,</span>
                        <span class="s1">allowChildren </span><span class="s2">= </span><span class="s1">allowChildren</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">moduleNames</span><span class="s2">[</span><span class="s1">moduleName</span><span class="s2">] = </span><span class="s1">mdef</span>
                <span class="s1">xmodule </span><span class="s2">= </span><span class="s1">xmodule</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s3">'module'</span><span class="s2">)</span>

            <span class="s5">return True</span>

        <span class="s5">def </span><span class="s1">getFileSpec</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">element</span><span class="s2">, </span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">newName</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Returns an xcomponent or similar element with the file 
            information for the indicated file. &quot;&quot;&quot;</span>

            <span class="s1">xspec </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s1">element</span><span class="s2">)</span>

            <span class="s1">size </span><span class="s2">= </span><span class="s1">pathname</span><span class="s2">.</span><span class="s1">getFileSize</span><span class="s2">()</span>
            <span class="s1">timestamp </span><span class="s2">= </span><span class="s1">pathname</span><span class="s2">.</span><span class="s1">getTimestamp</span><span class="s2">()</span>

            <span class="s1">hv </span><span class="s2">= </span><span class="s1">HashVal</span><span class="s2">()</span>
            <span class="s1">hv</span><span class="s2">.</span><span class="s1">hashFile</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">)</span>
            <span class="s1">hash </span><span class="s2">= </span><span class="s1">hv</span><span class="s2">.</span><span class="s1">asHex</span><span class="s2">()</span>

            <span class="s1">xspec</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'filename'</span><span class="s2">, </span><span class="s1">newName</span><span class="s2">)</span>
            <span class="s1">xspec</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'size'</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">size</span><span class="s2">))</span>
            <span class="s1">xspec</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'timestamp'</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">timestamp</span><span class="s2">))</span>
            <span class="s1">xspec</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'hash'</span><span class="s2">, </span><span class="s1">hash</span><span class="s2">)</span>

            <span class="s5">return </span><span class="s1">xspec</span>

        <span class="s5">def </span><span class="s1">addPyFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Adds the indicated python file, identified by filename 
            instead of by module name, to the package. &quot;&quot;&quot;</span>

            <span class="s4"># Convert the raw filename back to a module name, so we</span>
            <span class="s4"># can see if we've already loaded this file.  We assume</span>
            <span class="s4"># that all Python files within the package will be rooted</span>
            <span class="s4"># at the top of the package.</span>

            <span class="s1">filename </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">.</span><span class="s1">rsplit</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)[</span><span class="s6">0</span><span class="s2">]</span>
            <span class="s1">moduleName </span><span class="s2">= </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">&quot;/&quot;</span><span class="s2">, </span><span class="s3">&quot;.&quot;</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">moduleName</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">'.__init__'</span><span class="s2">):</span>
                <span class="s1">moduleName </span><span class="s2">= </span><span class="s1">moduleName</span><span class="s2">.</span><span class="s1">rsplit</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)[</span><span class="s6">0</span><span class="s2">]</span>

            <span class="s5">if </span><span class="s1">moduleName </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">:</span>
                <span class="s4"># This Python file is already known.  We don't have to</span>
                <span class="s4"># deal with it again.</span>
                <span class="s5">return</span>

            <span class="s4"># Make sure that it is actually in a package.</span>
            <span class="s1">parentName </span><span class="s2">= </span><span class="s1">moduleName</span>
            <span class="s5">while </span><span class="s3">'.' </span><span class="s5">in </span><span class="s1">parentName</span><span class="s2">:</span>
                <span class="s1">parentName </span><span class="s2">= </span><span class="s1">parentName</span><span class="s2">.</span><span class="s1">rsplit</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)[</span><span class="s6">0</span><span class="s2">]</span>
                <span class="s5">if </span><span class="s1">parentName </span><span class="s5">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">:</span>
                    <span class="s1">message </span><span class="s2">= </span><span class="s3">'Cannot add Python file %s; not in package' </span><span class="s2">% (</span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">)</span>
                    <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">required </span><span class="s5">or </span><span class="s1">file</span><span class="s2">.</span><span class="s1">explicit</span><span class="s2">:</span>
                        <span class="s5">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>
                    <span class="s5">else</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>
                    <span class="s5">return</span>

            <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">text</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">addModule</span><span class="s2">(</span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">filename </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">text </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">text</span><span class="s2">)</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">addModule</span><span class="s2">(</span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">filename </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>

        <span class="s5">def </span><span class="s1">addEggFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">):</span>
            <span class="s4"># Precompile egg files to bam's.</span>
            <span class="s1">np </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">loader</span><span class="s2">.</span><span class="s1">loadModel</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">loaderOptions</span><span class="s2">)</span>
            <span class="s5">if not </span><span class="s1">np</span><span class="s2">:</span>
                <span class="s5">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">'Could not read egg file %s' </span><span class="s2">% (</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">))</span>

            <span class="s1">bamName </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">)</span>
            <span class="s1">bamName</span><span class="s2">.</span><span class="s1">setExtension</span><span class="s2">(</span><span class="s3">'bam'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">addNode</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">node</span><span class="s2">(), </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">bamName</span><span class="s2">))</span>

        <span class="s5">def </span><span class="s1">addBamFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">):</span>
            <span class="s4"># Load the bam file so we can massage its textures.</span>
            <span class="s1">bamFile </span><span class="s2">= </span><span class="s1">BamFile</span><span class="s2">()</span>
            <span class="s5">if not </span><span class="s1">bamFile</span><span class="s2">.</span><span class="s1">openRead</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">):</span>
                <span class="s5">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">'Could not read bam file %s' </span><span class="s2">% (</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">))</span>

            <span class="s1">bamFile</span><span class="s2">.</span><span class="s1">getReader</span><span class="s2">().</span><span class="s1">setLoaderOptions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">loaderOptions</span><span class="s2">)</span>

            <span class="s5">if not </span><span class="s1">bamFile</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">():</span>
                <span class="s5">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">'Could not resolve bam file %s' </span><span class="s2">% (</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">))</span>

            <span class="s1">node </span><span class="s2">= </span><span class="s1">bamFile</span><span class="s2">.</span><span class="s1">readNode</span><span class="s2">()</span>
            <span class="s5">if not </span><span class="s1">node</span><span class="s2">:</span>
                <span class="s5">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">'Not a model file: %s' </span><span class="s2">% (</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">))</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">addNode</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">)</span>

        <span class="s5">def </span><span class="s1">addNode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">, </span><span class="s1">newName</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Converts the indicated node to a bam stream, and adds the 
            bam file to the multifile under the indicated newName. &quot;&quot;&quot;</span>

            <span class="s4"># If the Multifile already has a file by this name, don't</span>
            <span class="s4"># bother adding it again.</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">findSubfile</span><span class="s2">(</span><span class="s1">newName</span><span class="s2">) &gt;= </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s5">return</span>

            <span class="s4"># Be sure to import all of the referenced textures, and tell</span>
            <span class="s4"># them their new location within the multifile.</span>

            <span class="s5">for </span><span class="s1">tex </span><span class="s5">in </span><span class="s1">NodePath</span><span class="s2">(</span><span class="s1">node</span><span class="s2">).</span><span class="s1">findAllTextures</span><span class="s2">():</span>
                <span class="s5">if not </span><span class="s1">tex</span><span class="s2">.</span><span class="s1">hasFullpath</span><span class="s2">() </span><span class="s5">and </span><span class="s1">tex</span><span class="s2">.</span><span class="s1">hasRamImage</span><span class="s2">():</span>
                    <span class="s4"># We need to store this texture as a raw-data image.</span>
                    <span class="s4"># Clear the newName so this will happen</span>
                    <span class="s4"># automatically.</span>
                    <span class="s1">tex</span><span class="s2">.</span><span class="s1">clearFilename</span><span class="s2">()</span>
                    <span class="s1">tex</span><span class="s2">.</span><span class="s1">clearAlphaFilename</span><span class="s2">()</span>

                <span class="s5">else</span><span class="s2">:</span>
                    <span class="s4"># We can store this texture as a file reference to its</span>
                    <span class="s4"># image.  Copy the file into our multifile, and rename</span>
                    <span class="s4"># its reference in the texture.</span>
                    <span class="s5">if </span><span class="s1">tex</span><span class="s2">.</span><span class="s1">hasFilename</span><span class="s2">():</span>
                        <span class="s1">tex</span><span class="s2">.</span><span class="s1">setFilename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">addFoundTexture</span><span class="s2">(</span><span class="s1">tex</span><span class="s2">.</span><span class="s1">getFullpath</span><span class="s2">()))</span>
                    <span class="s5">if </span><span class="s1">tex</span><span class="s2">.</span><span class="s1">hasAlphaFilename</span><span class="s2">():</span>
                        <span class="s1">tex</span><span class="s2">.</span><span class="s1">setAlphaFilename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">addFoundTexture</span><span class="s2">(</span><span class="s1">tex</span><span class="s2">.</span><span class="s1">getAlphaFullpath</span><span class="s2">()))</span>

            <span class="s4"># Now generate an in-memory bam file.  Tell the bam writer to</span>
            <span class="s4"># keep the textures referenced by their in-multifile path.</span>
            <span class="s1">bamFile </span><span class="s2">= </span><span class="s1">BamFile</span><span class="s2">()</span>
            <span class="s1">stream </span><span class="s2">= </span><span class="s1">StringStream</span><span class="s2">()</span>
            <span class="s1">bamFile</span><span class="s2">.</span><span class="s1">openWrite</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">)</span>
            <span class="s1">bamFile</span><span class="s2">.</span><span class="s1">getWriter</span><span class="s2">().</span><span class="s1">setFileTextureMode</span><span class="s2">(</span><span class="s1">bamFile</span><span class="s2">.</span><span class="s1">BTMUnchanged</span><span class="s2">)</span>
            <span class="s1">bamFile</span><span class="s2">.</span><span class="s1">writeObject</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span>
            <span class="s1">bamFile</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

            <span class="s4"># Clean the node out of memory.</span>
            <span class="s1">node</span><span class="s2">.</span><span class="s1">removeAllChildren</span><span class="s2">()</span>

            <span class="s4"># Now we have an in-memory bam file.</span>
            <span class="s1">stream</span><span class="s2">.</span><span class="s1">seekg</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">addSubfile</span><span class="s2">(</span><span class="s1">newName</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compressionLevel</span><span class="s2">)</span>

            <span class="s4"># Flush it so the data gets written to disk immediately, so we</span>
            <span class="s4"># don't have to keep it around in ram.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">flush</span><span class="s2">()</span>

            <span class="s1">xcomponent </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'component'</span><span class="s2">)</span>
            <span class="s1">xcomponent</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'filename'</span><span class="s2">, </span><span class="s1">newName</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">components</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s3">'c'</span><span class="s2">, </span><span class="s1">newName</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">(), </span><span class="s1">xcomponent</span><span class="s2">))</span>

        <span class="s5">def </span><span class="s1">addFoundTexture</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Adds the newly-discovered texture to the output, if it has 
            not already been included.  Returns the new name within the 
            package tree. &quot;&quot;&quot;</span>

            <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
            <span class="s1">filename</span><span class="s2">.</span><span class="s1">makeCanonical</span><span class="s2">()</span>

            <span class="s1">file </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sourceFilenames</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s5">None</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">file</span><span class="s2">:</span>
                <span class="s4"># Never mind, it's already on the list.</span>
                <span class="s5">return </span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span>

            <span class="s4"># We have to copy the image into the plugin tree somewhere.</span>
            <span class="s1">newName </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">importedMapsDir </span><span class="s2">+ </span><span class="s3">'/' </span><span class="s2">+ </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">()</span>
            <span class="s1">uniqueId </span><span class="s2">= </span><span class="s6">0</span>
            <span class="s5">while </span><span class="s1">newName</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">targetFilenames</span><span class="s2">:</span>
                <span class="s1">uniqueId </span><span class="s2">+= </span><span class="s6">1</span>
                <span class="s1">newName </span><span class="s2">= </span><span class="s3">'%s/%s_%s.%s' </span><span class="s2">% (</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">importedMapsDir</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getBasenameWoExtension</span><span class="s2">(),</span>
                    <span class="s1">uniqueId</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getExtension</span><span class="s2">())</span>

            <span class="s1">file </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">addFile</span><span class="s2">(</span>
                <span class="s1">filename</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">newName</span><span class="s2">, </span><span class="s1">explicit </span><span class="s2">= </span><span class="s5">False</span><span class="s2">,</span>
                <span class="s1">compress </span><span class="s2">= </span><span class="s5">False</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">file</span><span class="s2">:</span>
                <span class="s4"># If we added the file in this pass, then also</span>
                <span class="s4"># immediately add it to the multifile (because we</span>
                <span class="s4"># won't be visiting the files list again).</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">addComponent</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>

            <span class="s5">return </span><span class="s1">newName</span>

        <span class="s5">def </span><span class="s1">addDcFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Adds a dc file to the archive.  A dc file gets its 
            internal comments and parameter names stripped out of the 
            final result automatically.  This is as close as we can 
            come to &quot;compiling&quot; a dc file, since all of the remaining 
            symbols are meaningful at runtime. &quot;&quot;&quot;</span>

            <span class="s4"># First, read in the dc file</span>
            <span class="s5">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">direct </span><span class="s5">import </span><span class="s1">DCFile</span>
            <span class="s1">dcFile </span><span class="s2">= </span><span class="s1">DCFile</span><span class="s2">()</span>
            <span class="s5">if not </span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Unable to parse %s.&quot; </span><span class="s2">% (</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">))</span>

            <span class="s4"># And then write it out without the comments and such.</span>
            <span class="s1">stream </span><span class="s2">= </span><span class="s1">StringStream</span><span class="s2">()</span>
            <span class="s5">if not </span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">, </span><span class="s5">True</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Unable to write %s.&quot; </span><span class="s2">% (</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">))</span>

            <span class="s1">file</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s1">stream</span><span class="s2">.</span><span class="s1">getData</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">addComponent</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>

        <span class="s5">def </span><span class="s1">addDcImports</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Adds the Python modules named by the indicated dc 
            file. &quot;&quot;&quot;</span>

            <span class="s5">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">direct </span><span class="s5">import </span><span class="s1">DCFile</span>
            <span class="s1">dcFile </span><span class="s2">= </span><span class="s1">DCFile</span><span class="s2">()</span>
            <span class="s5">if not </span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Unable to parse %s.&quot; </span><span class="s2">% (</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">))</span>

            <span class="s5">for </span><span class="s1">n </span><span class="s5">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getNumImportModules</span><span class="s2">()):</span>
                <span class="s1">moduleName </span><span class="s2">= </span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getImportModule</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
                <span class="s1">moduleSuffixes </span><span class="s2">= []</span>
                <span class="s5">if </span><span class="s3">'/' </span><span class="s5">in </span><span class="s1">moduleName</span><span class="s2">:</span>
                    <span class="s1">moduleName</span><span class="s2">, </span><span class="s1">suffixes </span><span class="s2">= </span><span class="s1">moduleName</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
                    <span class="s1">moduleSuffixes </span><span class="s2">= </span><span class="s1">suffixes</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">addModule</span><span class="s2">(</span><span class="s1">moduleName</span><span class="s2">)</span>

                <span class="s5">for </span><span class="s1">suffix </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">dcClientSuffixes</span><span class="s2">:</span>
                    <span class="s5">if </span><span class="s1">suffix </span><span class="s5">in </span><span class="s1">moduleSuffixes</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">addModule</span><span class="s2">(</span><span class="s1">moduleName </span><span class="s2">+ </span><span class="s1">suffix</span><span class="s2">)</span>

                <span class="s5">for </span><span class="s1">i </span><span class="s5">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getNumImportSymbols</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)):</span>
                    <span class="s1">symbolName </span><span class="s2">= </span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getImportSymbol</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
                    <span class="s1">symbolSuffixes </span><span class="s2">= []</span>
                    <span class="s5">if </span><span class="s3">'/' </span><span class="s5">in </span><span class="s1">symbolName</span><span class="s2">:</span>
                        <span class="s1">symbolName</span><span class="s2">, </span><span class="s1">suffixes </span><span class="s2">= </span><span class="s1">symbolName</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
                        <span class="s1">symbolSuffixes </span><span class="s2">= </span><span class="s1">suffixes</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">)</span>

                    <span class="s4"># &quot;from moduleName import symbolName&quot;.</span>

                    <span class="s4"># Maybe this symbol is itself a module; if that's</span>
                    <span class="s4"># the case, we need to add it to the list also.</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">addModule</span><span class="s2">(</span><span class="s3">'%s.%s' </span><span class="s2">% (</span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">symbolName</span><span class="s2">),</span>
                                           <span class="s1">implicit </span><span class="s2">= </span><span class="s5">True</span><span class="s2">)</span>
                    <span class="s5">for </span><span class="s1">suffix </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">dcClientSuffixes</span><span class="s2">:</span>
                        <span class="s5">if </span><span class="s1">suffix </span><span class="s5">in </span><span class="s1">symbolSuffixes</span><span class="s2">:</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">addModule</span><span class="s2">(</span><span class="s3">'%s.%s%s' </span><span class="s2">% (</span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">symbolName</span><span class="s2">, </span><span class="s1">suffix</span><span class="s2">),</span>
                                                   <span class="s1">implicit </span><span class="s2">= </span><span class="s5">True</span><span class="s2">)</span>


        <span class="s5">def </span><span class="s1">addPrcFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Adds a prc file to the archive.  Like the dc file, 
            this strips comments and such before adding.  It's also 
            possible to set prcEncryptionKey and/or prcSignCommand to 
            further manipulate prc files during processing. &quot;&quot;&quot;</span>

            <span class="s4"># First, read it in.</span>
            <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">text</span><span class="s2">:</span>
                <span class="s1">textLines </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">text</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'</span><span class="s5">\n</span><span class="s3">'</span><span class="s2">)</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">textLines </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">'rU'</span><span class="s2">).</span><span class="s1">readlines</span><span class="s2">()</span>

            <span class="s4"># Then write it out again, without the comments.</span>
            <span class="s1">tempFilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s3">'p3d_'</span><span class="s2">, </span><span class="s3">'.prc'</span><span class="s2">)</span>
            <span class="s1">tempFilename</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()  </span><span class="s4"># Binary is more reliable for signing.</span>
            <span class="s1">temp </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">tempFilename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">'w'</span><span class="s2">)</span>
            <span class="s5">for </span><span class="s1">line </span><span class="s5">in </span><span class="s1">textLines</span><span class="s2">:</span>
                <span class="s1">line </span><span class="s2">= </span><span class="s1">line</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>
                <span class="s5">if </span><span class="s1">line </span><span class="s5">and </span><span class="s1">line</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] != </span><span class="s3">'#'</span><span class="s2">:</span>
                    <span class="s4"># Write the line out only if it's not a comment.</span>
                    <span class="s1">temp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">line </span><span class="s2">+ </span><span class="s3">'</span><span class="s5">\n</span><span class="s3">'</span><span class="s2">)</span>
            <span class="s1">temp</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">prcSignCommand</span><span class="s2">:</span>
                <span class="s4"># Now sign the file.</span>
                <span class="s1">command </span><span class="s2">= </span><span class="s3">'%s -n &quot;%s&quot;' </span><span class="s2">% (</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">prcSignCommand</span><span class="s2">, </span><span class="s1">tempFilename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s1">command</span><span class="s2">)</span>
                <span class="s1">exitStatus </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">system</span><span class="s2">(</span><span class="s1">command</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">exitStatus </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">'Command failed: %s' </span><span class="s2">% (</span><span class="s1">command</span><span class="s2">))</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">prcEncryptionKey</span><span class="s2">:</span>
                <span class="s4"># And now encrypt it.</span>
                <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">'.prc'</span><span class="s2">):</span>
                    <span class="s4"># Change .prc -&gt; .pre</span>
                    <span class="s1">file</span><span class="s2">.</span><span class="s1">newName </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">[:-</span><span class="s6">1</span><span class="s2">] + </span><span class="s3">'e'</span>

                <span class="s1">preFilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s3">'p3d_'</span><span class="s2">, </span><span class="s3">'.pre'</span><span class="s2">)</span>
                <span class="s1">preFilename</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>
                <span class="s1">tempFilename</span><span class="s2">.</span><span class="s1">setText</span><span class="s2">()</span>
                <span class="s1">encryptFile</span><span class="s2">(</span><span class="s1">tempFilename</span><span class="s2">, </span><span class="s1">preFilename</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">prcEncryptionKey</span><span class="s2">)</span>
                <span class="s1">tempFilename</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>
                <span class="s1">tempFilename </span><span class="s2">= </span><span class="s1">preFilename</span>

            <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">deleteTemp</span><span class="s2">:</span>
                <span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>

            <span class="s1">file</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">= </span><span class="s1">tempFilename</span>
            <span class="s1">file</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s5">None</span>
            <span class="s1">file</span><span class="s2">.</span><span class="s1">deleteTemp </span><span class="s2">= </span><span class="s5">True</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">addComponent</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>

        <span class="s5">def </span><span class="s1">addComponent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">):</span>
            <span class="s1">compressionLevel </span><span class="s2">= </span><span class="s6">0</span>
            <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">compress</span><span class="s2">:</span>
                <span class="s1">compressionLevel </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compressionLevel</span>

            <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">text</span><span class="s2">:</span>
                <span class="s1">stream </span><span class="s2">= </span><span class="s1">StringStream</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">text</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">addSubfile</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">, </span><span class="s1">compressionLevel</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">flush</span><span class="s2">()</span>

            <span class="s5">elif </span><span class="s1">file</span><span class="s2">.</span><span class="s1">executable </span><span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arch</span><span class="s2">:</span>
                <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__addOsxExecutable</span><span class="s2">(</span><span class="s1">file</span><span class="s2">):</span>
                    <span class="s5">return</span>

            <span class="s5">else</span><span class="s2">:</span>
                <span class="s4"># Copy an ordinary file into the multifile.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">addSubfile</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">, </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">compressionLevel</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">extract</span><span class="s2">:</span>
                <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">text</span><span class="s2">:</span>
                    <span class="s4"># Better write it to a temporary file, so we can</span>
                    <span class="s4"># get its hash.</span>
                    <span class="s1">tfile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s3">'p3d_'</span><span class="s2">)</span>
                    <span class="s1">open</span><span class="s2">(</span><span class="s1">tfile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">'wb'</span><span class="s2">).</span><span class="s1">write</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">text</span><span class="s2">)</span>
                    <span class="s1">xextract </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getFileSpec</span><span class="s2">(</span><span class="s3">'extract'</span><span class="s2">, </span><span class="s1">tfile</span><span class="s2">, </span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">)</span>
                    <span class="s1">tfile</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>

                <span class="s5">else</span><span class="s2">:</span>
                    <span class="s4"># The file data exists on disk already.</span>
                    <span class="s1">xextract </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getFileSpec</span><span class="s2">(</span><span class="s3">'extract'</span><span class="s2">, </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">extracts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">(), </span><span class="s1">xextract</span><span class="s2">))</span>

            <span class="s1">xcomponent </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'component'</span><span class="s2">)</span>
            <span class="s1">xcomponent</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'filename'</span><span class="s2">, </span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">components</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s3">'c'</span><span class="s2">, </span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">(), </span><span class="s1">xcomponent</span><span class="s2">))</span>

        <span class="s5">def </span><span class="s1">__addOsxExecutable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Adds an executable or shared library to the multifile, 
            with respect to OSX's fat-binary features.  Returns true 
            on success, false on failure. &quot;&quot;&quot;</span>

            <span class="s1">compressionLevel </span><span class="s2">= </span><span class="s6">0</span>
            <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">compress</span><span class="s2">:</span>
                <span class="s1">compressionLevel </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compressionLevel</span>

            <span class="s4"># If we're on OSX and adding only files for a</span>
            <span class="s4"># particular architecture, use lipo to strip out the</span>
            <span class="s4"># part of the file for that architecture.</span>

            <span class="s1">arch </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arch</span>
            <span class="s5">if </span><span class="s1">arch </span><span class="s2">== </span><span class="s3">&quot;amd64&quot;</span><span class="s2">:</span>
                <span class="s1">arch </span><span class="s2">= </span><span class="s3">&quot;x86_64&quot;</span>

            <span class="s4"># First, we need to verify that it is in fact a</span>
            <span class="s4"># universal binary.</span>
            <span class="s1">tfile </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s3">'p3d_'</span><span class="s2">)</span>
            <span class="s1">tfile</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>
            <span class="s1">command </span><span class="s2">= </span><span class="s3">'/usr/bin/lipo -info &quot;%s&quot; &gt;&quot;%s&quot;' </span><span class="s2">% (</span>
                <span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(),</span>
                <span class="s1">tfile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
            <span class="s1">exitStatus </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">system</span><span class="s2">(</span><span class="s1">command</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">exitStatus </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Not an executable file: %s&quot; </span><span class="s2">% (</span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">))</span>
                <span class="s4"># Just add it anyway.</span>
                <span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">addSubfile</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">, </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">compressionLevel</span><span class="s2">)</span>
                <span class="s5">return True</span>

            <span class="s4"># The lipo command succeeded, so it really is an</span>
            <span class="s4"># executable file.  Parse the lipo output to figure out</span>
            <span class="s4"># which architectures the file supports.</span>
            <span class="s1">arches </span><span class="s2">= []</span>
            <span class="s1">lipoData </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">tfile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">'r'</span><span class="s2">).</span><span class="s1">read</span><span class="s2">()</span>
            <span class="s1">tfile</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>
            <span class="s5">if </span><span class="s3">':' </span><span class="s5">in </span><span class="s1">lipoData</span><span class="s2">:</span>
                <span class="s1">arches </span><span class="s2">= </span><span class="s1">lipoData</span><span class="s2">.</span><span class="s1">rsplit</span><span class="s2">(</span><span class="s3">':'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)[</span><span class="s6">1</span><span class="s2">]</span>
                <span class="s1">arches </span><span class="s2">= </span><span class="s1">arches</span><span class="s2">.</span><span class="s1">split</span><span class="s2">()</span>

            <span class="s5">if </span><span class="s1">arches </span><span class="s2">== [</span><span class="s1">arch</span><span class="s2">]:</span>
                <span class="s4"># The file only contains the one architecture that</span>
                <span class="s4"># we want anyway.</span>
                <span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">addSubfile</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">, </span><span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">compressionLevel</span><span class="s2">)</span>
                <span class="s5">return True</span>

            <span class="s5">if </span><span class="s1">arch </span><span class="s5">not in </span><span class="s1">arches</span><span class="s2">:</span>
                <span class="s4"># The file doesn't support the architecture that we</span>
                <span class="s4"># want at all.  Omit the file.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;%s doesn't support architecture %s&quot; </span><span class="s2">% (</span>
                    <span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arch</span><span class="s2">))</span>
                <span class="s5">return False</span>

            <span class="s4"># The file contains multiple architectures.  Get</span>
            <span class="s4"># out just the one we want.</span>
            <span class="s1">command </span><span class="s2">= </span><span class="s3">'/usr/bin/lipo -thin %s -output &quot;%s&quot; &quot;%s&quot;' </span><span class="s2">% (</span>
                <span class="s1">arch</span><span class="s2">, </span><span class="s1">tfile</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(),</span>
                <span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
            <span class="s1">exitStatus </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">system</span><span class="s2">(</span><span class="s1">command</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">exitStatus </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">'Command failed: %s' </span><span class="s2">% (</span><span class="s1">command</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">multifile</span><span class="s2">.</span><span class="s1">addSubfile</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">newName</span><span class="s2">, </span><span class="s1">tfile</span><span class="s2">, </span><span class="s1">compressionLevel</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">deleteTemp</span><span class="s2">:</span>
                <span class="s1">file</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>
            <span class="s1">file</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">= </span><span class="s1">tfile</span>
            <span class="s1">file</span><span class="s2">.</span><span class="s1">deleteTemp </span><span class="s2">= </span><span class="s5">True</span>
            <span class="s5">return True</span>


        <span class="s5">def </span><span class="s1">requirePackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">package</span><span class="s2">):</span>
            <span class="s0">&quot;&quot;&quot; Indicates a dependency on the given package.  This 
            also implicitly requires all of the package's requirements 
            as well (though this transitive requirement happens at 
            runtime, not here at build time). &quot;&quot;&quot;</span>

            <span class="s5">if </span><span class="s1">package </span><span class="s5">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">package</span><span class="s2">)</span>
                <span class="s5">for </span><span class="s1">lowerName </span><span class="s5">in </span><span class="s1">package</span><span class="s2">.</span><span class="s1">targetFilenames</span><span class="s2">:</span>
                    <span class="s1">ext </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">lowerName</span><span class="s2">).</span><span class="s1">getExtension</span><span class="s2">()</span>
                    <span class="s5">if </span><span class="s1">ext </span><span class="s5">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packager</span><span class="s2">.</span><span class="s1">nonuniqueExtensions</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">skipFilenames</span><span class="s2">[</span><span class="s1">lowerName</span><span class="s2">] = </span><span class="s5">True</span>

                <span class="s5">for </span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">mdef </span><span class="s5">in </span><span class="s1">package</span><span class="s2">.</span><span class="s1">moduleNames</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                    <span class="s5">if not </span><span class="s1">mdef</span><span class="s2">.</span><span class="s1">exclude</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">skipModules</span><span class="s2">[</span><span class="s1">moduleName</span><span class="s2">] = </span><span class="s1">mdef</span>

    <span class="s4"># Packager constructor</span>
    <span class="s5">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">platform </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>

        <span class="s4"># The following are config settings that the caller may adjust</span>
        <span class="s4"># before calling any of the command methods.</span>

        <span class="s4"># The platform string.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setPlatform</span><span class="s2">(</span><span class="s1">platform</span><span class="s2">)</span>

        <span class="s4"># This should be set to a Filename.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">installDir </span><span class="s2">= </span><span class="s5">None</span>

        <span class="s4"># If specified, this is a directory to search first for any</span>
        <span class="s4"># library references, before searching the system.</span>
        <span class="s4"># Particularly useful on OSX to reference the universal SDK.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">systemRoot </span><span class="s2">= </span><span class="s5">None</span>

        <span class="s4"># Set this true to treat setHost() the same as addHost(), thus</span>
        <span class="s4"># ignoring any request to specify a particular download host,</span>
        <span class="s4"># e.g. for testing and development.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreSetHost </span><span class="s2">= </span><span class="s5">False</span>

        <span class="s4"># Set this to true to verbosely log files ignored by dir().</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">verbosePrint </span><span class="s2">= </span><span class="s5">False</span>

        <span class="s4"># This will be appended to the basename of any .p3d package,</span>
        <span class="s4"># before the .p3d extension.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dSuffix </span><span class="s2">= </span><span class="s3">''</span>

        <span class="s4"># The download URL at which these packages will eventually be</span>
        <span class="s4"># hosted.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">hosts </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">host </span><span class="s2">= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageHostUrl</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">addHost</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">)</span>

        <span class="s4"># This will be used when we're not compiling in the packaged</span>
        <span class="s4"># environment.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__hostInfos </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">http </span><span class="s2">= </span><span class="s1">HTTPClient</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>

        <span class="s4"># The maximum amount of time a client should cache the</span>
        <span class="s4"># contents.xml before re-querying the server, in seconds.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">maxAge </span><span class="s2">= </span><span class="s6">0</span>

        <span class="s4"># The contents seq: a tuple of integers, representing the</span>
        <span class="s4"># current seq value.  The contents seq generally increments</span>
        <span class="s4"># with each modification to the contents.xml file.  There is</span>
        <span class="s4"># also a package seq for each package, which generally</span>
        <span class="s4"># increments with each modification to the package.</span>

        <span class="s4"># The contents seq and package seq are used primarily for</span>
        <span class="s4"># documentation purposes, to note when a new version is</span>
        <span class="s4"># released.  The package seq value can also be used to verify</span>
        <span class="s4"># that the contents.xml, desc.xml, and desc.import.xml files</span>
        <span class="s4"># were all built at the same time.</span>

        <span class="s4"># Although the package seqs are used at runtime to verify that</span>
        <span class="s4"># the latest contents.xml file has been downloaded, they are</span>
        <span class="s4"># not otherwise used at runtime, and they are not binding on</span>
        <span class="s4"># the download version.  The md5 hash, not the package seq, is</span>
        <span class="s4"># actually used to differentiate different download versions.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">contentsSeq </span><span class="s2">= </span><span class="s1">SeqValue</span><span class="s2">()</span>

        <span class="s4"># A search list for previously-built local packages.</span>

        <span class="s4"># We use a bit of caution to read the Filenames out of the</span>
        <span class="s4"># config variable.  Since cvar.getDirectories() returns a list</span>
        <span class="s4"># of references to Filename objects stored within the config</span>
        <span class="s4"># variable itself, we have to make a copy of each Filename</span>
        <span class="s4"># returned, so they will persist beyond the lifespan of the</span>
        <span class="s4"># config variable.</span>
        <span class="s1">cvar </span><span class="s2">= </span><span class="s1">ConfigVariableSearchPath</span><span class="s2">(</span><span class="s3">'pdef-path'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">installSearch </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">, </span><span class="s1">cvar</span><span class="s2">.</span><span class="s1">getDirectories</span><span class="s2">()))</span>

        <span class="s4"># This is where we cache the location of libraries.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">libraryCache </span><span class="s2">= {}</span>

        <span class="s4"># The system PATH, for searching dll's and exe's.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">executablePath </span><span class="s2">= </span><span class="s1">DSearchPath</span><span class="s2">()</span>

        <span class="s4"># By convention, we include sys.path at the front of</span>
        <span class="s4"># self.executablePath, mainly to aid makepanda when building</span>
        <span class="s4"># an rtdist build.</span>
        <span class="s5">for </span><span class="s1">dirname </span><span class="s5">in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">executablePath</span><span class="s2">.</span><span class="s1">appendDirectory</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">))</span>

        <span class="s4"># Now add the actual system search path.</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'win'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">addWindowsSearchPath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">executablePath</span><span class="s2">, </span><span class="s3">&quot;PATH&quot;</span><span class="s2">)</span>

        <span class="s5">else</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'osx'</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">addPosixSearchPath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">executablePath</span><span class="s2">, </span><span class="s3">&quot;DYLD_LIBRARY_PATH&quot;</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">addPosixSearchPath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">executablePath</span><span class="s2">, </span><span class="s3">&quot;LD_LIBRARY_PATH&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">addPosixSearchPath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">executablePath</span><span class="s2">, </span><span class="s3">&quot;PATH&quot;</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'linux'</span><span class="s2">):</span>
                <span class="s4"># It used to be okay to just add some common paths on Linux.</span>
                <span class="s4"># But nowadays, each distribution has their own convention for</span>
                <span class="s4"># where they put their libraries.  Instead, we query the ldconfig</span>
                <span class="s4"># cache, which contains the location of all libraries.</span>

                <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadLdconfigCache</span><span class="s2">():</span>
                    <span class="s4"># Ugh, failure.  All that remains is to guess.  This should</span>
                    <span class="s4"># work for the most common Debian configurations.</span>
                    <span class="s1">multiarchDir </span><span class="s2">= </span><span class="s3">&quot;/lib/%s-linux-gnu&quot; </span><span class="s2">% (</span><span class="s1">os</span><span class="s2">.</span><span class="s1">uname</span><span class="s2">()[</span><span class="s6">4</span><span class="s2">])</span>
                    <span class="s5">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">multiarchDir</span><span class="s2">):</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">executablePath</span><span class="s2">.</span><span class="s1">appendDirectory</span><span class="s2">(</span><span class="s1">multiarchDir</span><span class="s2">)</span>
                    <span class="s5">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">(</span><span class="s3">&quot;/usr/&quot; </span><span class="s2">+ </span><span class="s1">multiarchDir</span><span class="s2">):</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">executablePath</span><span class="s2">.</span><span class="s1">appendDirectory</span><span class="s2">(</span><span class="s3">&quot;/usr/&quot; </span><span class="s2">+ </span><span class="s1">multiarchDir</span><span class="s2">)</span>

            <span class="s5">else</span><span class="s2">:</span>
                <span class="s4"># FreeBSD, or some other system that still makes sense.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">executablePath</span><span class="s2">.</span><span class="s1">appendDirectory</span><span class="s2">(</span><span class="s3">'/lib'</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">executablePath</span><span class="s2">.</span><span class="s1">appendDirectory</span><span class="s2">(</span><span class="s3">'/usr/lib'</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">executablePath</span><span class="s2">.</span><span class="s1">appendDirectory</span><span class="s2">(</span><span class="s3">'/usr/local/lib'</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'freebsd'</span><span class="s2">) </span><span class="s5">and </span><span class="s1">os</span><span class="s2">.</span><span class="s1">uname</span><span class="s2">()[</span><span class="s6">1</span><span class="s2">] == </span><span class="s3">&quot;pcbsd&quot;</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">executablePath</span><span class="s2">.</span><span class="s1">appendDirectory</span><span class="s2">(</span><span class="s3">'/usr/PCBSD/local/lib'</span><span class="s2">)</span>

        <span class="s4"># Set this flag true to automatically add allow_python_dev to</span>
        <span class="s4"># any applications.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">allowPythonDev </span><span class="s2">= </span><span class="s5">False</span>

        <span class="s4"># Set this flag to store the original Python source files,</span>
        <span class="s4"># without compiling them to .pyc or .pyo.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">storePythonSource </span><span class="s2">= </span><span class="s5">False</span>

        <span class="s4"># Fill this with a list of (certificate, chain, pkey,</span>
        <span class="s4"># password) tuples to automatically sign each p3d file</span>
        <span class="s4"># generated.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">signParams </span><span class="s2">= []</span>

        <span class="s4"># Optional signing and encrypting features.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">encryptionKey </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">prcEncryptionKey </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">prcSignCommand </span><span class="s2">= </span><span class="s5">None</span>

        <span class="s4"># This is a list of filename extensions and/or basenames that</span>
        <span class="s4"># indicate files that should be encrypted within the</span>
        <span class="s4"># multifile.  This provides obfuscation only, not real</span>
        <span class="s4"># security, since the decryption key must be part of the</span>
        <span class="s4"># client and is therefore readily available to any hacker.</span>
        <span class="s4"># Not only is this feature useless, but using it also</span>
        <span class="s4"># increases the size of your patchfiles, since encrypted files</span>
        <span class="s4"># can't really be patched.  But it's here if you really want</span>
        <span class="s4"># it. ** Note: Actually, this isn't implemented yet.</span>
        <span class="s4">#self.encryptExtensions = []</span>
        <span class="s4">#self.encryptFiles = []</span>

        <span class="s4"># This is the list of DC import suffixes that should be</span>
        <span class="s4"># available to the client.  Other suffixes, like AI and UD,</span>
        <span class="s4"># are server-side only and should be ignored by the Scrubber.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dcClientSuffixes </span><span class="s2">= [</span><span class="s3">'OV'</span><span class="s2">]</span>

        <span class="s4"># Is this file system case-sensitive?</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">caseSensitive </span><span class="s2">= </span><span class="s5">True</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'win'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">caseSensitive </span><span class="s2">= </span><span class="s5">False</span>
        <span class="s5">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'osx'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">caseSensitive </span><span class="s2">= </span><span class="s5">False</span>

        <span class="s4"># Get the list of filename extensions that are recognized as</span>
        <span class="s4"># image files.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">imageExtensions </span><span class="s2">= []</span>
        <span class="s5">for </span><span class="s1">type </span><span class="s5">in </span><span class="s1">PNMFileTypeRegistry</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">().</span><span class="s1">getTypes</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">imageExtensions </span><span class="s2">+= </span><span class="s1">type</span><span class="s2">.</span><span class="s1">getExtensions</span><span class="s2">()</span>

        <span class="s4"># Other useful extensions.  The .pz extension is implicitly</span>
        <span class="s4"># stripped.</span>

        <span class="s4"># Model files.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">modelExtensions </span><span class="s2">= [ </span><span class="s3">'egg'</span><span class="s2">, </span><span class="s3">'bam' </span><span class="s2">]</span>

        <span class="s4"># Text files that are copied (and compressed) to the package</span>
        <span class="s4"># with end-of-line conversion.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">textExtensions </span><span class="s2">= [ </span><span class="s3">'prc'</span><span class="s2">, </span><span class="s3">'ptf'</span><span class="s2">, </span><span class="s3">'txt'</span><span class="s2">, </span><span class="s3">'cg'</span><span class="s2">, </span><span class="s3">'sha'</span><span class="s2">, </span><span class="s3">'dc'</span><span class="s2">, </span><span class="s3">'xml' </span><span class="s2">]</span>

        <span class="s4"># Binary files that are copied (and compressed) without</span>
        <span class="s4"># processing.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binaryExtensions </span><span class="s2">= [ </span><span class="s3">'ttf'</span><span class="s2">, </span><span class="s3">'TTF'</span><span class="s2">, </span><span class="s3">'mid'</span><span class="s2">, </span><span class="s3">'ico'</span><span class="s2">, </span><span class="s3">'cur' </span><span class="s2">]</span>

        <span class="s4"># Files that can have an existence in multiple different</span>
        <span class="s4"># packages simultaneously without conflict.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">nonuniqueExtensions </span><span class="s2">= [ </span><span class="s3">'prc' </span><span class="s2">]</span>

        <span class="s4"># Files that represent an executable or shared library.</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'win'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">executableExtensions </span><span class="s2">= [ </span><span class="s3">'dll'</span><span class="s2">, </span><span class="s3">'pyd'</span><span class="s2">, </span><span class="s3">'exe' </span><span class="s2">]</span>
        <span class="s5">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'osx'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">executableExtensions </span><span class="s2">= [ </span><span class="s3">'so'</span><span class="s2">, </span><span class="s3">'dylib' </span><span class="s2">]</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">executableExtensions </span><span class="s2">= [ </span><span class="s3">'so' </span><span class="s2">]</span>

        <span class="s4"># Files that represent a Windows &quot;manifest&quot; file.  These files</span>
        <span class="s4"># must be explicitly extracted to disk so the OS can find</span>
        <span class="s4"># them.</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'win'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">manifestExtensions </span><span class="s2">= [ </span><span class="s3">'manifest' </span><span class="s2">]</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">manifestExtensions </span><span class="s2">= [ ]</span>

        <span class="s4"># Extensions that are automatically remapped by convention.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">remapExtensions </span><span class="s2">= {}</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'win'</span><span class="s2">):</span>
            <span class="s5">pass</span>
        <span class="s5">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'osx'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">remapExtensions </span><span class="s2">= {</span>
                <span class="s3">'dll' </span><span class="s2">: </span><span class="s3">'dylib'</span><span class="s2">,</span>
                <span class="s3">'pyd' </span><span class="s2">: </span><span class="s3">'so'</span><span class="s2">,</span>
                <span class="s3">'exe' </span><span class="s2">: </span><span class="s3">''</span>
                <span class="s2">}</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">remapExtensions </span><span class="s2">= {</span>
                <span class="s3">'dll' </span><span class="s2">: </span><span class="s3">'so'</span><span class="s2">,</span>
                <span class="s3">'pyd' </span><span class="s2">: </span><span class="s3">'so'</span><span class="s2">,</span>
                <span class="s3">'exe' </span><span class="s2">: </span><span class="s3">''</span>
                <span class="s2">}</span>

        <span class="s4"># Files that should be extracted to disk.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">extractExtensions </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">executableExtensions</span><span class="s2">[:] + </span><span class="s1">self</span><span class="s2">.</span><span class="s1">manifestExtensions</span><span class="s2">[:] + [ </span><span class="s3">'ico'</span><span class="s2">, </span><span class="s3">'cur' </span><span class="s2">]</span>

        <span class="s4"># Files that indicate a platform dependency.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">platformSpecificExtensions </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">executableExtensions</span><span class="s2">[:]</span>

        <span class="s4"># Binary files that are considered uncompressible, and are</span>
        <span class="s4"># copied without compression.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">uncompressibleExtensions </span><span class="s2">= [ </span><span class="s3">'mp3'</span><span class="s2">, </span><span class="s3">'ogg'</span><span class="s2">, </span><span class="s3">'ogv'</span><span class="s2">, </span><span class="s3">'wav'</span><span class="s2">, </span><span class="s3">'rml'</span><span class="s2">, </span><span class="s3">'rcss'</span><span class="s2">, </span><span class="s3">'otf' </span><span class="s2">]</span>
        <span class="s4"># wav files are compressible, but p3openal_audio won't load</span>
        <span class="s4"># them compressed.</span>
        <span class="s4"># rml, rcss and otf files must be added here because</span>
        <span class="s4"># libRocket wants to be able to seek in these files.</span>

        <span class="s4"># Files which are not to be processed further, but which</span>
        <span class="s4"># should be added exactly byte-for-byte as they are.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">unprocessedExtensions </span><span class="s2">= []</span>

        <span class="s4"># Files for which warnings should be suppressed when they are</span>
        <span class="s4"># not handled by dir()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">suppressWarningForExtensions </span><span class="s2">= [</span><span class="s3">''</span><span class="s2">, </span><span class="s3">'pyc'</span><span class="s2">, </span><span class="s3">'pyo'</span><span class="s2">,</span>
                                             <span class="s3">'p3d'</span><span class="s2">, </span><span class="s3">'pdef'</span><span class="s2">,</span>
                                             <span class="s3">'c'</span><span class="s2">, </span><span class="s3">'C'</span><span class="s2">, </span><span class="s3">'cxx'</span><span class="s2">, </span><span class="s3">'cpp'</span><span class="s2">, </span><span class="s3">'h'</span><span class="s2">, </span><span class="s3">'H'</span><span class="s2">,</span>
                                             <span class="s3">'hpp'</span><span class="s2">, </span><span class="s3">'pp'</span><span class="s2">, </span><span class="s3">'I'</span><span class="s2">, </span><span class="s3">'pem'</span><span class="s2">, </span><span class="s3">'p12'</span><span class="s2">, </span><span class="s3">'crt'</span><span class="s2">,</span>
                                             <span class="s3">'o'</span><span class="s2">, </span><span class="s3">'obj'</span><span class="s2">, </span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'lib'</span><span class="s2">, </span><span class="s3">'bc'</span><span class="s2">, </span><span class="s3">'ll'</span><span class="s2">]</span>

        <span class="s4"># System files that should never be packaged.  For</span>
        <span class="s4"># case-insensitive filesystems (like Windows and OSX), put the</span>
        <span class="s4"># lowercase filename here.  Case-sensitive filesystems should</span>
        <span class="s4"># use the correct case.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">excludeSystemFiles </span><span class="s2">= [</span>
            <span class="s3">'kernel32.dll'</span><span class="s2">, </span><span class="s3">'user32.dll'</span><span class="s2">, </span><span class="s3">'wsock32.dll'</span><span class="s2">, </span><span class="s3">'ws2_32.dll'</span><span class="s2">,</span>
            <span class="s3">'advapi32.dll'</span><span class="s2">, </span><span class="s3">'opengl32.dll'</span><span class="s2">, </span><span class="s3">'glu32.dll'</span><span class="s2">, </span><span class="s3">'gdi32.dll'</span><span class="s2">,</span>
            <span class="s3">'shell32.dll'</span><span class="s2">, </span><span class="s3">'ntdll.dll'</span><span class="s2">, </span><span class="s3">'ws2help.dll'</span><span class="s2">, </span><span class="s3">'rpcrt4.dll'</span><span class="s2">,</span>
            <span class="s3">'imm32.dll'</span><span class="s2">, </span><span class="s3">'ddraw.dll'</span><span class="s2">, </span><span class="s3">'shlwapi.dll'</span><span class="s2">, </span><span class="s3">'secur32.dll'</span><span class="s2">,</span>
            <span class="s3">'dciman32.dll'</span><span class="s2">, </span><span class="s3">'comdlg32.dll'</span><span class="s2">, </span><span class="s3">'comctl32.dll'</span><span class="s2">, </span><span class="s3">'ole32.dll'</span><span class="s2">,</span>
            <span class="s3">'oleaut32.dll'</span><span class="s2">, </span><span class="s3">'gdiplus.dll'</span><span class="s2">, </span><span class="s3">'winmm.dll'</span><span class="s2">, </span><span class="s3">'iphlpapi.dll'</span><span class="s2">,</span>
            <span class="s3">'msvcrt.dll'</span><span class="s2">, </span><span class="s3">'kernelbase.dll'</span><span class="s2">, </span><span class="s3">'msimg32.dll'</span><span class="s2">, </span><span class="s3">'msacm32.dll'</span><span class="s2">,</span>

            <span class="s3">'libsystem.b.dylib'</span><span class="s2">, </span><span class="s3">'libmathcommon.a.dylib'</span><span class="s2">, </span><span class="s3">'libmx.a.dylib'</span><span class="s2">,</span>
            <span class="s3">'libstdc++.6.dylib'</span><span class="s2">, </span><span class="s3">'libobjc.a.dylib'</span><span class="s2">, </span><span class="s3">'libauto.dylib'</span><span class="s2">,</span>
            <span class="s2">]</span>

        <span class="s4"># As above, but with filename globbing to catch a range of</span>
        <span class="s4"># filenames.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">excludeSystemGlobs </span><span class="s2">= [</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'d3dx9_*.dll'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'api-ms-win-*.dll'</span><span class="s2">),</span>

            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'libGL.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'libGLU.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'libGLcore.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'libGLES*.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'libEGL.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'libX11.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'libXau.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'libXdmcp.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'libxcb*.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'libc.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'libgcc_s.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'libdl.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'libm.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'libnvidia*.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'libpthread.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'libthr.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'ld-linux.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'ld-linux-*.so*'</span><span class="s2">),</span>
            <span class="s1">GlobPattern</span><span class="s2">(</span><span class="s3">'librt.so*'</span><span class="s2">),</span>
            <span class="s2">]</span>

        <span class="s4"># A Loader for loading models.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loader </span><span class="s2">= </span><span class="s1">Loader</span><span class="s2">.</span><span class="s1">Loader</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sfxManagerList </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">musicManager </span><span class="s2">= </span><span class="s5">None</span>

        <span class="s4"># These options will be used when loading models and textures.  By</span>
        <span class="s4"># default we don't load textures beyond the header and don't store</span>
        <span class="s4"># models in the RAM cache in order to conserve on memory usage.</span>
        <span class="s1">opts </span><span class="s2">= </span><span class="s1">LoaderOptions</span><span class="s2">()</span>
        <span class="s1">opts</span><span class="s2">.</span><span class="s1">setFlags</span><span class="s2">(</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">getFlags</span><span class="s2">() | </span><span class="s1">LoaderOptions</span><span class="s2">.</span><span class="s1">LFNoRamCache</span><span class="s2">)</span>
        <span class="s1">opts</span><span class="s2">.</span><span class="s1">setTextureFlags</span><span class="s2">(</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">getTextureFlags</span><span class="s2">() &amp; ~</span><span class="s1">LoaderOptions</span><span class="s2">.</span><span class="s1">TFPreload</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loaderOptions </span><span class="s2">= </span><span class="s1">opts</span>

        <span class="s4"># This is filled in during readPackageDef().</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">packageList </span><span class="s2">= []</span>

        <span class="s4"># A table of all known packages by name.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">packages </span><span class="s2">= {}</span>

        <span class="s4"># A list of PackageEntry objects read from the contents.xml</span>
        <span class="s4"># file.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">contents </span><span class="s2">= {}</span>

    <span class="s5">def </span><span class="s1">loadLdconfigCache</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; On GNU/Linux, runs ldconfig -p to find out where all the 
        libraries on the system are located.  Assumes that the platform 
        has already been set. &quot;&quot;&quot;</span>

        <span class="s5">if not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s3">'/sbin/ldconfig'</span><span class="s2">):</span>
            <span class="s5">return False</span>

        <span class="s1">handle </span><span class="s2">= </span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">Popen</span><span class="s2">([</span><span class="s3">'/sbin/ldconfig'</span><span class="s2">, </span><span class="s3">'-p'</span><span class="s2">], </span><span class="s1">stdout</span><span class="s2">=</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">PIPE</span><span class="s2">, </span><span class="s1">universal_newlines</span><span class="s2">=</span><span class="s5">True</span><span class="s2">)</span>
        <span class="s1">out</span><span class="s2">, </span><span class="s1">err </span><span class="s2">= </span><span class="s1">handle</span><span class="s2">.</span><span class="s1">communicate</span><span class="s2">()</span>

        <span class="s5">if </span><span class="s1">handle</span><span class="s2">.</span><span class="s1">returncode </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;/sbin/ldconfig -p returned code %d&quot; </span><span class="s2">%(</span><span class="s1">handle</span><span class="s2">.</span><span class="s1">returncode</span><span class="s2">))</span>
            <span class="s5">return False</span>

        <span class="s5">for </span><span class="s1">line </span><span class="s5">in </span><span class="s1">out</span><span class="s2">.</span><span class="s1">splitlines</span><span class="s2">():</span>
            <span class="s5">if </span><span class="s3">'=&gt;' </span><span class="s5">not in </span><span class="s1">line</span><span class="s2">:</span>
                <span class="s5">continue</span>

            <span class="s1">prefix</span><span class="s2">, </span><span class="s1">location </span><span class="s2">= </span><span class="s1">line</span><span class="s2">.</span><span class="s1">rsplit</span><span class="s2">(</span><span class="s3">'=&gt;'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
            <span class="s1">prefix </span><span class="s2">= </span><span class="s1">prefix</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>
            <span class="s1">location </span><span class="s2">= </span><span class="s1">location</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>

            <span class="s5">if not </span><span class="s1">location </span><span class="s5">or not </span><span class="s1">prefix </span><span class="s5">or </span><span class="s3">' ' </span><span class="s5">not in </span><span class="s1">prefix</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Ignoring malformed ldconfig -p line: &quot; </span><span class="s2">+ </span><span class="s1">line</span><span class="s2">)</span>
                <span class="s5">continue</span>

            <span class="s1">lib</span><span class="s2">, </span><span class="s1">opts </span><span class="s2">= </span><span class="s1">prefix</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s2">(</span><span class="s3">'x86-64' </span><span class="s5">in </span><span class="s1">opts</span><span class="s2">) != </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">'_amd64'</span><span class="s2">):</span>
                <span class="s4"># This entry isn't meant for our architecture.  I think</span>
                <span class="s4"># x86-64 is the only platform where ldconfig supplies</span>
                <span class="s4"># this extra arch string.</span>
                <span class="s5">continue</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">libraryCache</span><span class="s2">[</span><span class="s1">lib</span><span class="s2">] = </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">location</span><span class="s2">)</span>

        <span class="s5">return True</span>

    <span class="s5">def </span><span class="s1">resolveLibrary</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Resolves the given shared library filename along the executable path, 
        or by cross-referencing it with the library cache. &quot;&quot;&quot;</span>

        <span class="s1">path </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">path </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">libraryCache</span><span class="s2">:</span>
            <span class="s1">filename</span><span class="s2">.</span><span class="s1">setFullpath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">libraryCache</span><span class="s2">[</span><span class="s1">path</span><span class="s2">].</span><span class="s1">getFullpath</span><span class="s2">())</span>
            <span class="s5">return True</span>

        <span class="s5">if </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">resolveFilename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">executablePath</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">libraryCache</span><span class="s2">[</span><span class="s1">path</span><span class="s2">] = </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
            <span class="s5">return True</span>

        <span class="s5">return False</span>

    <span class="s5">def </span><span class="s1">setPlatform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">platform </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Sets the platform that this Packager will compute for.  On 
        OSX, this can be used to specify the particular architecture 
        we are building; on other platforms, it is probably a mistake 
        to set this. 
 
        You should call this before doing anything else with the 
        Packager.  It's even better to pass the platform string to the 
        constructor.  &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">= </span><span class="s1">platform </span><span class="s5">or </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPlatform</span><span class="s2">()</span>

        <span class="s4"># OSX uses this &quot;arch&quot; string for the otool and lipo commands.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">arch </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'osx_'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">arch </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">[</span><span class="s6">4</span><span class="s2">:]</span>


    <span class="s5">def </span><span class="s1">setHost</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">host</span><span class="s2">, </span><span class="s1">downloadUrl </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                <span class="s1">descriptiveName </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">hostDir </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                <span class="s1">mirrors </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Specifies the URL that will ultimately host these 
        contents. &quot;&quot;&quot;</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreSetHost</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">host </span><span class="s2">= </span><span class="s1">host</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">addHost</span><span class="s2">(</span><span class="s1">host</span><span class="s2">, </span><span class="s1">downloadUrl </span><span class="s2">= </span><span class="s1">downloadUrl</span><span class="s2">,</span>
                     <span class="s1">descriptiveName </span><span class="s2">= </span><span class="s1">descriptiveName</span><span class="s2">, </span><span class="s1">hostDir </span><span class="s2">= </span><span class="s1">hostDir</span><span class="s2">,</span>
                     <span class="s1">mirrors </span><span class="s2">= </span><span class="s1">mirrors</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">addHost</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">host</span><span class="s2">, </span><span class="s1">downloadUrl </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">descriptiveName </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                <span class="s1">hostDir </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">mirrors </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Adds a host to the list of known download hosts.  This 
        information will be written into any p3d files that reference 
        this host; this can be used to pre-define the possible mirrors 
        for a given host, for instance.  Returns the newly-created 
        HostEntry object.&quot;&quot;&quot;</span>

        <span class="s1">scheme </span><span class="s2">= </span><span class="s1">URLSpec</span><span class="s2">(</span><span class="s1">host</span><span class="s2">).</span><span class="s1">getScheme</span><span class="s2">()</span>
        <span class="s5">if </span><span class="s1">scheme </span><span class="s2">== </span><span class="s3">'https' </span><span class="s5">and </span><span class="s1">downloadUrl </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s4"># If we specified an SSL-protected host URL, but no</span>
            <span class="s4"># explicit download URL, then assume the download URL is</span>
            <span class="s4"># the same, over cleartext.</span>
            <span class="s1">url </span><span class="s2">= </span><span class="s1">URLSpec</span><span class="s2">(</span><span class="s1">host</span><span class="s2">)</span>
            <span class="s1">url</span><span class="s2">.</span><span class="s1">setScheme</span><span class="s2">(</span><span class="s3">'http'</span><span class="s2">)</span>
            <span class="s1">downloadUrl </span><span class="s2">= </span><span class="s1">url</span><span class="s2">.</span><span class="s1">getUrl</span><span class="s2">()</span>

        <span class="s1">he </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">host</span><span class="s2">, </span><span class="s5">None</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">he </span><span class="s5">is None</span><span class="s2">:</span>
            <span class="s4"># Define a new host entry</span>
            <span class="s1">he </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">HostEntry</span><span class="s2">(</span><span class="s1">host</span><span class="s2">, </span><span class="s1">downloadUrl </span><span class="s2">= </span><span class="s1">downloadUrl</span><span class="s2">,</span>
                                <span class="s1">descriptiveName </span><span class="s2">= </span><span class="s1">descriptiveName</span><span class="s2">,</span>
                                <span class="s1">hostDir </span><span class="s2">= </span><span class="s1">hostDir</span><span class="s2">, </span><span class="s1">mirrors </span><span class="s2">= </span><span class="s1">mirrors</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">[</span><span class="s1">host</span><span class="s2">] = </span><span class="s1">he</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s4"># Update an existing host entry</span>
            <span class="s5">if </span><span class="s1">downloadUrl </span><span class="s5">is not None</span><span class="s2">:</span>
                <span class="s1">he</span><span class="s2">.</span><span class="s1">downloadUrl </span><span class="s2">= </span><span class="s1">downloadUrl</span>
            <span class="s5">if </span><span class="s1">descriptiveName </span><span class="s5">is not None</span><span class="s2">:</span>
                <span class="s1">he</span><span class="s2">.</span><span class="s1">descriptiveName </span><span class="s2">= </span><span class="s1">descriptiveName</span>
            <span class="s5">if </span><span class="s1">hostDir </span><span class="s5">is not None</span><span class="s2">:</span>
                <span class="s1">he</span><span class="s2">.</span><span class="s1">hostDir </span><span class="s2">= </span><span class="s1">hostDir</span>
            <span class="s5">if </span><span class="s1">mirrors </span><span class="s5">is not None</span><span class="s2">:</span>
                <span class="s1">he</span><span class="s2">.</span><span class="s1">mirrors </span><span class="s2">= </span><span class="s1">mirrors</span>

        <span class="s5">return </span><span class="s1">he</span>

    <span class="s5">def </span><span class="s1">addAltHost</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">keyword</span><span class="s2">, </span><span class="s1">altHost</span><span class="s2">, </span><span class="s1">origHost </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                   <span class="s1">downloadUrl </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">descriptiveName </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                   <span class="s1">hostDir </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">mirrors </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Adds an alternate host to any already-known host.  This 
        defines an alternate server that may be contacted, if 
        specified on the HTML page, which hosts a different version of 
        the server's contents.  (This is different from a mirror, 
        which hosts an identical version of the server's contents.) 
        &quot;&quot;&quot;</span>

        <span class="s5">if not </span><span class="s1">origHost</span><span class="s2">:</span>
            <span class="s1">origHost </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">addHost</span><span class="s2">(</span><span class="s1">altHost</span><span class="s2">, </span><span class="s1">downloadUrl </span><span class="s2">= </span><span class="s1">downloadUrl</span><span class="s2">,</span>
                     <span class="s1">descriptiveName </span><span class="s2">= </span><span class="s1">descriptiveName</span><span class="s2">, </span><span class="s1">hostDir </span><span class="s2">= </span><span class="s1">hostDir</span><span class="s2">,</span>
                     <span class="s1">mirrors </span><span class="s2">= </span><span class="s1">mirrors</span><span class="s2">)</span>
        <span class="s1">he </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">addHost</span><span class="s2">(</span><span class="s1">origHost</span><span class="s2">)</span>
        <span class="s1">he</span><span class="s2">.</span><span class="s1">altHosts</span><span class="s2">[</span><span class="s1">keyword</span><span class="s2">] = </span><span class="s1">altHost</span>

    <span class="s5">def </span><span class="s1">addWindowsSearchPath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">searchPath</span><span class="s2">, </span><span class="s1">varname</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Expands $varname, interpreting as a Windows-style search 
        path, and adds its contents to the indicated DSearchPath. &quot;&quot;&quot;</span>

        <span class="s1">path </span><span class="s2">= </span><span class="s1">ExecutionEnvironment</span><span class="s2">.</span><span class="s1">getEnvironmentVariable</span><span class="s2">(</span><span class="s1">varname</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) == </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">varname </span><span class="s5">not in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">:</span>
                <span class="s5">return</span>
            <span class="s1">path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">[</span><span class="s1">varname</span><span class="s2">]</span>
        <span class="s5">for </span><span class="s1">dirname </span><span class="s5">in </span><span class="s1">path</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">';'</span><span class="s2">):</span>
            <span class="s1">dirname </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">dirname</span><span class="s2">.</span><span class="s1">makeTrueCase</span><span class="s2">():</span>
                <span class="s1">searchPath</span><span class="s2">.</span><span class="s1">appendDirectory</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">addPosixSearchPath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">searchPath</span><span class="s2">, </span><span class="s1">varname</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Expands $varname, interpreting as a Posix-style search 
        path, and adds its contents to the indicated DSearchPath. &quot;&quot;&quot;</span>

        <span class="s1">path </span><span class="s2">= </span><span class="s1">ExecutionEnvironment</span><span class="s2">.</span><span class="s1">getEnvironmentVariable</span><span class="s2">(</span><span class="s1">varname</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) == </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">varname </span><span class="s5">not in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">:</span>
                <span class="s5">return</span>
            <span class="s1">path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">[</span><span class="s1">varname</span><span class="s2">]</span>
        <span class="s5">for </span><span class="s1">dirname </span><span class="s5">in </span><span class="s1">path</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">':'</span><span class="s2">):</span>
            <span class="s1">dirname </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">dirname</span><span class="s2">.</span><span class="s1">makeTrueCase</span><span class="s2">():</span>
                <span class="s1">searchPath</span><span class="s2">.</span><span class="s1">appendDirectory</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">_ensureExtensions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">knownExtensions </span><span class="s2">= </span><span class="s1">\</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">imageExtensions </span><span class="s2">+ </span><span class="s1">\</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">modelExtensions </span><span class="s2">+ </span><span class="s1">\</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">textExtensions </span><span class="s2">+ </span><span class="s1">\</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">binaryExtensions </span><span class="s2">+ </span><span class="s1">\</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">uncompressibleExtensions </span><span class="s2">+ </span><span class="s1">\</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">unprocessedExtensions</span>

    <span class="s5">def </span><span class="s1">setup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Call this method to initialize the class after filling in 
        some of the values in the constructor. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_ensureExtensions</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage </span><span class="s2">= </span><span class="s5">None</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">:</span>
            <span class="s4"># If we were given an install directory, we can build</span>
            <span class="s4"># packages as well as plain p3d files, and it all goes</span>
            <span class="s4"># into the specified directory.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dInstallDir </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">installDir</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">allowPackages </span><span class="s2">= </span><span class="s5">True</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s4"># If we don't have an actual install directory, we can</span>
            <span class="s4"># only build p3d files, and we drop them into the current</span>
            <span class="s4"># directory.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">p3dInstallDir </span><span class="s2">= </span><span class="s3">'.'</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">allowPackages </span><span class="s2">= </span><span class="s5">False</span>

        <span class="s5">if not </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageVersionString</span><span class="s2">() </span><span class="s5">or not </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageHostUrl</span><span class="s2">():</span>
            <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s3">'This script must be run using a version of Panda3D that has been built</span><span class="s5">\n</span><span class="s3">for distribution.  Try using ppackage.p3d or packp3d.p3d instead.</span><span class="s5">\n</span><span class="s3">If you are running this script for development purposes, you may also</span><span class="s5">\n</span><span class="s3">set the Config variable panda-package-host-url to the URL you expect</span><span class="s5">\n</span><span class="s3">to download these contents from (for instance, a file:// URL).'</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">readContentsFile</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">close</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Called after reading all of the package def files, this 
        performs any final cleanup appropriate. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">writeContentsFile</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">buildPatches</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packages</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Call this after calling close(), to build patches for the 
        indicated packages. &quot;&quot;&quot;</span>

        <span class="s4"># We quietly ignore any p3d applications or solo packages</span>
        <span class="s4"># passed in the packages list; we only build patches for</span>
        <span class="s4"># actual Multifile-based packages.</span>
        <span class="s1">packageNames </span><span class="s2">= []</span>
        <span class="s5">for </span><span class="s1">package </span><span class="s5">in </span><span class="s1">packages</span><span class="s2">:</span>
            <span class="s5">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">p3dApplication </span><span class="s5">and not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">solo</span><span class="s2">:</span>
                <span class="s1">packageNames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">packageNames</span><span class="s2">:</span>
            <span class="s5">from </span><span class="s2">.</span><span class="s1">PatchMaker </span><span class="s5">import </span><span class="s1">PatchMaker</span>
            <span class="s1">pm </span><span class="s2">= </span><span class="s1">PatchMaker</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">)</span>
            <span class="s1">pm</span><span class="s2">.</span><span class="s1">buildPatches</span><span class="s2">(</span><span class="s1">packageNames </span><span class="s2">= </span><span class="s1">packageNames</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">readPackageDef</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageDef</span><span class="s2">, </span><span class="s1">packageNames </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Reads the named .pdef file and constructs the named 
        packages, or all packages if packageNames is None.  Raises an 
        exception if the pdef file is invalid.  Returns the list of 
        packages constructed. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">'Reading %s' </span><span class="s2">% (</span><span class="s1">packageDef</span><span class="s2">))</span>

        <span class="s4"># We use exec to &quot;read&quot; the .pdef file.  This has the nice</span>
        <span class="s4"># side-effect that the user can put arbitrary Python code in</span>
        <span class="s4"># there to control conditional execution, and such.</span>

        <span class="s4"># Set up the namespace dictionary for exec.</span>
        <span class="s1">globals </span><span class="s2">= {}</span>
        <span class="s1">globals</span><span class="s2">[</span><span class="s3">'__name__'</span><span class="s2">] = </span><span class="s1">packageDef</span><span class="s2">.</span><span class="s1">getBasenameWoExtension</span><span class="s2">()</span>
        <span class="s1">globals</span><span class="s2">[</span><span class="s3">'__dir__'</span><span class="s2">] = </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">packageDef</span><span class="s2">.</span><span class="s1">getDirname</span><span class="s2">()).</span><span class="s1">toOsSpecific</span><span class="s2">()</span>
        <span class="s1">globals</span><span class="s2">[</span><span class="s3">'__file__'</span><span class="s2">] = </span><span class="s1">packageDef</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()</span>
        <span class="s1">globals</span><span class="s2">[</span><span class="s3">'packageDef'</span><span class="s2">] = </span><span class="s1">packageDef</span>

        <span class="s1">globals</span><span class="s2">[</span><span class="s3">'platform'</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span>
        <span class="s1">globals</span><span class="s2">[</span><span class="s3">'packager'</span><span class="s2">] = </span><span class="s1">self</span>

        <span class="s4"># We'll stuff all of the predefined functions, and the</span>
        <span class="s4"># predefined classes, in the global dictionary, so the pdef</span>
        <span class="s4"># file can reference them.</span>

        <span class="s4"># By convention, the existence of a method of this class named</span>
        <span class="s4"># do_foo(self) is sufficient to define a pdef method call</span>
        <span class="s4"># foo().</span>
        <span class="s5">for </span><span class="s1">methodName </span><span class="s5">in </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()):</span>
            <span class="s5">if </span><span class="s1">methodName</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'do_'</span><span class="s2">):</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">methodName</span><span class="s2">[</span><span class="s6">3</span><span class="s2">:]</span>
                <span class="s1">c </span><span class="s2">= </span><span class="s1">func_closure</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">globals</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">c</span><span class="s2">.</span><span class="s1">generic_func</span>

        <span class="s1">globals</span><span class="s2">[</span><span class="s3">'p3d'</span><span class="s2">] = </span><span class="s1">class_p3d</span>
        <span class="s1">globals</span><span class="s2">[</span><span class="s3">'package'</span><span class="s2">] = </span><span class="s1">class_package</span>
        <span class="s1">globals</span><span class="s2">[</span><span class="s3">'solo'</span><span class="s2">] = </span><span class="s1">class_solo</span>

        <span class="s4"># Now exec the pdef file.  Assuming there are no syntax</span>
        <span class="s4"># errors, and that the pdef file doesn't contain any really</span>
        <span class="s4"># crazy Python code, all this will do is fill in the</span>
        <span class="s4"># '__statements' list in the module scope.</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">packageDef</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>
        <span class="s1">code </span><span class="s2">= </span><span class="s1">compile</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(), </span><span class="s1">fn</span><span class="s2">, </span><span class="s3">'exec'</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s4"># It appears that having a separate globals and locals</span>
        <span class="s4"># dictionary causes problems with resolving symbols within a</span>
        <span class="s4"># class scope.  So, we just use one dictionary, the globals.</span>
        <span class="s1">exec</span><span class="s2">(</span><span class="s1">code</span><span class="s2">, </span><span class="s1">globals</span><span class="s2">)</span>

        <span class="s1">packages </span><span class="s2">= []</span>

        <span class="s4"># Now iterate through the statements and operate on them.</span>
        <span class="s1">statements </span><span class="s2">= </span><span class="s1">globals</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'__statements'</span><span class="s2">, [])</span>
        <span class="s5">if not </span><span class="s1">statements</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;No packages defined.&quot;</span><span class="s2">)</span>

        <span class="s5">try</span><span class="s2">:</span>
            <span class="s5">for </span><span class="s2">(</span><span class="s1">lineno</span><span class="s2">, </span><span class="s1">stype</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kw</span><span class="s2">) </span><span class="s5">in </span><span class="s1">statements</span><span class="s2">:</span>
                <span class="s5">if </span><span class="s1">stype </span><span class="s2">== </span><span class="s3">'class'</span><span class="s2">:</span>
                    <span class="s5">if </span><span class="s1">packageNames </span><span class="s5">is None or </span><span class="s1">name </span><span class="s5">in </span><span class="s1">packageNames</span><span class="s2">:</span>
                        <span class="s1">classDef </span><span class="s2">= </span><span class="s1">globals</span><span class="s2">[</span><span class="s1">name</span><span class="s2">]</span>
                        <span class="s1">p3dApplication </span><span class="s2">= (</span><span class="s1">class_p3d </span><span class="s5">in </span><span class="s1">classDef</span><span class="s2">.</span><span class="s1">__bases__</span><span class="s2">)</span>
                        <span class="s1">solo </span><span class="s2">= (</span><span class="s1">class_solo </span><span class="s5">in </span><span class="s1">classDef</span><span class="s2">.</span><span class="s1">__bases__</span><span class="s2">)</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">beginPackage</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">p3dApplication </span><span class="s2">= </span><span class="s1">p3dApplication</span><span class="s2">,</span>
                                          <span class="s1">solo </span><span class="s2">= </span><span class="s1">solo</span><span class="s2">)</span>
                        <span class="s1">statements </span><span class="s2">= </span><span class="s1">classDef</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'__statements'</span><span class="s2">, [])</span>
                        <span class="s5">if not </span><span class="s1">statements</span><span class="s2">:</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;No files added to %s&quot; </span><span class="s2">% (</span><span class="s1">name</span><span class="s2">))</span>
                        <span class="s5">for </span><span class="s2">(</span><span class="s1">lineno</span><span class="s2">, </span><span class="s1">stype</span><span class="s2">, </span><span class="s1">sname</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kw</span><span class="s2">) </span><span class="s5">in </span><span class="s1">statements</span><span class="s2">:</span>
                            <span class="s5">if </span><span class="s1">stype </span><span class="s2">== </span><span class="s3">'class'</span><span class="s2">:</span>
                                <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s3">'Nested classes not allowed'</span><span class="s2">)</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">__evalFunc</span><span class="s2">(</span><span class="s1">sname</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kw</span><span class="s2">)</span>
                        <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">endPackage</span><span class="s2">()</span>
                        <span class="s5">if </span><span class="s1">package </span><span class="s5">is not None</span><span class="s2">:</span>
                            <span class="s1">packages</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">package</span><span class="s2">)</span>
                        <span class="s5">elif </span><span class="s1">packageNames </span><span class="s5">is not None</span><span class="s2">:</span>
                            <span class="s4"># If the name is explicitly specified, this means</span>
                            <span class="s4"># we should abort if the package faild to construct.</span>
                            <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s3">'Failed to construct %s' </span><span class="s2">% </span><span class="s1">name</span><span class="s2">)</span>
                <span class="s5">else</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">__evalFunc</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kw</span><span class="s2">)</span>
        <span class="s5">except </span><span class="s1">PackagerError</span><span class="s2">:</span>
            <span class="s4"># Append the line number and file name to the exception</span>
            <span class="s4"># error message.</span>
            <span class="s1">inst </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">exc_info</span><span class="s2">()[</span><span class="s6">1</span><span class="s2">]</span>
            <span class="s5">if not </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">args</span><span class="s2">:</span>
                <span class="s1">inst</span><span class="s2">.</span><span class="s1">args </span><span class="s2">= (</span><span class="s3">'Error'</span><span class="s2">,)</span>

            <span class="s1">inst</span><span class="s2">.</span><span class="s1">args </span><span class="s2">= (</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] + </span><span class="s3">' on line %s of %s' </span><span class="s2">% (</span><span class="s1">lineno</span><span class="s2">, </span><span class="s1">packageDef</span><span class="s2">),)</span>
            <span class="s5">raise</span>

        <span class="s5">return </span><span class="s1">packages</span>

    <span class="s5">def </span><span class="s1">__evalFunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kw</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This is called from readPackageDef(), above, to call the 
        function do_name(*args, **kw), as extracted from the pdef 
        file. &quot;&quot;&quot;</span>

        <span class="s1">funcname </span><span class="s2">= </span><span class="s3">'do_%s' </span><span class="s2">% (</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">funcname</span><span class="s2">)</span>
        <span class="s5">try</span><span class="s2">:</span>
            <span class="s1">func</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">)</span>
        <span class="s5">except </span><span class="s1">OutsideOfPackageError</span><span class="s2">:</span>
            <span class="s1">message </span><span class="s2">= </span><span class="s3">'%s encountered outside of package definition' </span><span class="s2">% (</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s5">raise </span><span class="s1">OutsideOfPackageError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">__expandTabs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">line</span><span class="s2">, </span><span class="s1">tabWidth </span><span class="s2">= </span><span class="s6">8</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Expands tab characters in the line to 8 spaces. &quot;&quot;&quot;</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s5">while </span><span class="s1">p </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">line</span><span class="s2">):</span>
            <span class="s5">if </span><span class="s1">line</span><span class="s2">[</span><span class="s1">p</span><span class="s2">] == </span><span class="s3">'</span><span class="s5">\t</span><span class="s3">'</span><span class="s2">:</span>
                <span class="s4"># Expand a tab.</span>
                <span class="s1">nextStop </span><span class="s2">= ((</span><span class="s1">p </span><span class="s2">+ </span><span class="s1">tabWidth</span><span class="s2">) / </span><span class="s1">tabWidth</span><span class="s2">) * </span><span class="s1">tabWidth</span>
                <span class="s1">numSpaces </span><span class="s2">= </span><span class="s1">nextStop </span><span class="s2">- </span><span class="s1">p</span>
                <span class="s1">line </span><span class="s2">= </span><span class="s1">line</span><span class="s2">[:</span><span class="s1">p</span><span class="s2">] + </span><span class="s3">' ' </span><span class="s2">* </span><span class="s1">numSpaces </span><span class="s2">+ </span><span class="s1">line</span><span class="s2">[</span><span class="s1">p </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">:]</span>
                <span class="s1">p </span><span class="s2">= </span><span class="s1">nextStop</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">p </span><span class="s2">+= </span><span class="s6">1</span>

        <span class="s5">return </span><span class="s1">line</span>

    <span class="s5">def </span><span class="s1">__countLeadingWhitespace</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">line</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Returns the number of leading whitespace characters in the 
        line. &quot;&quot;&quot;</span>

        <span class="s1">line </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__expandTabs</span><span class="s2">(</span><span class="s1">line</span><span class="s2">)</span>
        <span class="s5">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">line</span><span class="s2">) - </span><span class="s1">len</span><span class="s2">(</span><span class="s1">line</span><span class="s2">.</span><span class="s1">lstrip</span><span class="s2">())</span>

    <span class="s5">def </span><span class="s1">__stripLeadingWhitespace</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">line</span><span class="s2">, </span><span class="s1">whitespaceCount</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Removes the indicated number of whitespace characters, but 
        no more. &quot;&quot;&quot;</span>

        <span class="s1">line </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__expandTabs</span><span class="s2">(</span><span class="s1">line</span><span class="s2">)</span>
        <span class="s1">line </span><span class="s2">= </span><span class="s1">line</span><span class="s2">[:</span><span class="s1">whitespaceCount</span><span class="s2">].</span><span class="s1">lstrip</span><span class="s2">() + </span><span class="s1">line</span><span class="s2">[</span><span class="s1">whitespaceCount</span><span class="s2">:]</span>
        <span class="s5">return </span><span class="s1">line</span>

    <span class="s5">def </span><span class="s1">__parseArgs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">words</span><span class="s2">, </span><span class="s1">argList</span><span class="s2">):</span>
        <span class="s1">args </span><span class="s2">= {}</span>

        <span class="s5">while </span><span class="s1">len</span><span class="s2">(</span><span class="s1">words</span><span class="s2">) &gt; </span><span class="s6">1</span><span class="s2">:</span>
            <span class="s1">arg </span><span class="s2">= </span><span class="s1">words</span><span class="s2">[-</span><span class="s6">1</span><span class="s2">]</span>
            <span class="s5">if </span><span class="s3">'=' </span><span class="s5">not in </span><span class="s1">arg</span><span class="s2">:</span>
                <span class="s5">return </span><span class="s1">args</span>

            <span class="s1">parameter</span><span class="s2">, </span><span class="s1">value </span><span class="s2">= </span><span class="s1">arg</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'='</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
            <span class="s1">parameter </span><span class="s2">= </span><span class="s1">parameter</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>
            <span class="s5">if </span><span class="s1">parameter </span><span class="s5">not in </span><span class="s1">argList</span><span class="s2">:</span>
                <span class="s1">message </span><span class="s2">= </span><span class="s3">'Unknown parameter %s' </span><span class="s2">% (</span><span class="s1">parameter</span><span class="s2">)</span>
                <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">parameter </span><span class="s5">in </span><span class="s1">args</span><span class="s2">:</span>
                <span class="s1">message </span><span class="s2">= </span><span class="s3">'Duplicate parameter %s' </span><span class="s2">% (</span><span class="s1">parameter</span><span class="s2">)</span>
                <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

            <span class="s1">args</span><span class="s2">[</span><span class="s1">parameter</span><span class="s2">] = </span><span class="s1">value</span>

            <span class="s5">del </span><span class="s1">words</span><span class="s2">[-</span><span class="s6">1</span><span class="s2">]</span>


    <span class="s5">def </span><span class="s1">beginPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">p3dApplication </span><span class="s2">= </span><span class="s5">False</span><span class="s2">,</span>
                     <span class="s1">solo </span><span class="s2">= </span><span class="s5">False</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Begins a new package specification.  packageName is the 
        basename of the package.  Follow this with a number of calls 
        to file() etc., and close the package with endPackage(). &quot;&quot;&quot;</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">:</span>
            <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s3">'unclosed endPackage %s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">))</span>

        <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">Package</span><span class="s2">(</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage </span><span class="s2">= </span><span class="s1">package</span>

        <span class="s1">package</span><span class="s2">.</span><span class="s1">p3dApplication </span><span class="s2">= </span><span class="s1">p3dApplication</span>
        <span class="s1">package</span><span class="s2">.</span><span class="s1">solo </span><span class="s2">= </span><span class="s1">solo</span>

        <span class="s5">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">p3dApplication </span><span class="s5">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">allowPackages</span><span class="s2">:</span>
            <span class="s1">message </span><span class="s2">= </span><span class="s3">'Cannot generate packages without an installDir; use -i'</span>
            <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>


    <span class="s5">def </span><span class="s1">endPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Closes the current package specification.  This actually 
        generates the package file.  Returns the finished package, 
        or None if the package failed to close (e.g. missing files). &quot;&quot;&quot;</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">:</span>
            <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s3">'unmatched endPackage'</span><span class="s2">)</span>

        <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span>
        <span class="s1">package</span><span class="s2">.</span><span class="s1">signParams </span><span class="s2">+= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">signParams</span><span class="s2">[:]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s5">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">close</span><span class="s2">():</span>
            <span class="s5">return None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">packageList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">package</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">[(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)] = </span><span class="s1">package</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage </span><span class="s2">= </span><span class="s5">None</span>

        <span class="s5">return </span><span class="s1">package</span>

    <span class="s5">def </span><span class="s1">findPackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">platform </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">version </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                    <span class="s1">host </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">requires </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Searches for the named package from a previous publish 
        operation along the install search path. 
 
        If requires is not None, it is a list of Package objects that 
        are already required.  The new Package object must be 
        compatible with the existing Packages, or an error is 
        returned.  This is also useful for determining the appropriate 
        package version to choose when a version is not specified. 
 
        Returns the Package object, or None if the package cannot be 
        located. &quot;&quot;&quot;</span>

        <span class="s4"># Is it a package we already have resident?</span>
        <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">.</span><span class="s1">get</span><span class="s2">((</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">platform </span><span class="s5">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">host</span><span class="s2">), </span><span class="s5">None</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">package</span><span class="s2">:</span>
            <span class="s5">return </span><span class="s1">package</span>

        <span class="s4"># Look on the searchlist.</span>
        <span class="s5">for </span><span class="s1">dirname </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">installSearch</span><span class="s2">:</span>
            <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__scanPackageDir</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">, </span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">platform </span><span class="s5">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">host</span><span class="s2">, </span><span class="s1">requires </span><span class="s2">= </span><span class="s1">requires</span><span class="s2">)</span>
            <span class="s5">if not </span><span class="s1">package</span><span class="s2">:</span>
                <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__scanPackageDir</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">, </span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">host</span><span class="s2">, </span><span class="s1">requires </span><span class="s2">= </span><span class="s1">requires</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">package </span><span class="s5">and </span><span class="s1">host </span><span class="s5">and </span><span class="s1">package</span><span class="s2">.</span><span class="s1">host </span><span class="s2">!= </span><span class="s1">host</span><span class="s2">:</span>
                <span class="s4"># Wrong host.</span>
                <span class="s1">package </span><span class="s2">= </span><span class="s5">None</span>

            <span class="s5">if </span><span class="s1">package</span><span class="s2">:</span>
                <span class="s5">break</span>

        <span class="s5">if not </span><span class="s1">package</span><span class="s2">:</span>
            <span class="s4"># Query the indicated host.</span>
            <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__findPackageOnHost</span><span class="s2">(</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">platform </span><span class="s5">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">, </span><span class="s1">version </span><span class="s5">or None</span><span class="s2">, </span><span class="s1">host</span><span class="s2">, </span><span class="s1">requires </span><span class="s2">= </span><span class="s1">requires</span><span class="s2">)</span>
            <span class="s5">if not </span><span class="s1">package</span><span class="s2">:</span>
                <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__findPackageOnHost</span><span class="s2">(</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">host</span><span class="s2">, </span><span class="s1">requires </span><span class="s2">= </span><span class="s1">requires</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">package</span><span class="s2">:</span>
            <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">((</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">version</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">host</span><span class="s2">), </span><span class="s1">package</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">[(</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">platform </span><span class="s5">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">host</span><span class="s2">)] = </span><span class="s1">package</span>
            <span class="s5">return </span><span class="s1">package</span>

        <span class="s5">return None</span>

    <span class="s5">def </span><span class="s1">__scanPackageDir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rootDir</span><span class="s2">, </span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">, </span><span class="s1">version</span><span class="s2">,</span>
                         <span class="s1">host</span><span class="s2">, </span><span class="s1">requires </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Scans a directory on disk, looking for *.import.xml files 
        that match the indicated packageName and optional version.  If a 
        suitable xml file is found, reads it and returns the assocated 
        Package definition. 
 
        If a version is not specified, and multiple versions are 
        available, the highest-numbered version that matches will be 
        selected. 
        &quot;&quot;&quot;</span>

        <span class="s1">packages </span><span class="s2">= []</span>

        <span class="s5">if </span><span class="s1">version</span><span class="s2">:</span>
            <span class="s4"># A specific version package.</span>
            <span class="s1">versionList </span><span class="s2">= [</span><span class="s1">version</span><span class="s2">]</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s4"># An unversioned package, or any old version.</span>
            <span class="s1">versionList </span><span class="s2">= [</span><span class="s5">None</span><span class="s2">, </span><span class="s3">'*'</span><span class="s2">]</span>

        <span class="s5">for </span><span class="s1">version </span><span class="s5">in </span><span class="s1">versionList</span><span class="s2">:</span>
            <span class="s1">packageDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">rootDir</span><span class="s2">, </span><span class="s1">packageName</span><span class="s2">)</span>
            <span class="s1">basename </span><span class="s2">= </span><span class="s1">packageName</span>

            <span class="s5">if </span><span class="s1">version</span><span class="s2">:</span>
                <span class="s4"># A specific or nonspecific version package.</span>
                <span class="s1">packageDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">version</span><span class="s2">)</span>
                <span class="s1">basename </span><span class="s2">+= </span><span class="s3">'.%s' </span><span class="s2">% (</span><span class="s1">version</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">platform</span><span class="s2">:</span>
                <span class="s1">packageDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">)</span>
                <span class="s1">basename </span><span class="s2">+= </span><span class="s3">'.%s' </span><span class="s2">% (</span><span class="s1">platform</span><span class="s2">)</span>

            <span class="s4"># Actually, the host means little for this search, since we're</span>
            <span class="s4"># only looking in a local directory at this point.</span>

            <span class="s1">basename </span><span class="s2">+= </span><span class="s3">'.import.xml'</span>
            <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">packageDir</span><span class="s2">, </span><span class="s1">basename</span><span class="s2">)</span>
            <span class="s1">filelist </span><span class="s2">= </span><span class="s1">glob</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
            <span class="s5">if not </span><span class="s1">filelist</span><span class="s2">:</span>
                <span class="s4"># It doesn't exist in the nested directory; try the root</span>
                <span class="s4"># directory.</span>
                <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">rootDir</span><span class="s2">, </span><span class="s1">basename</span><span class="s2">)</span>
                <span class="s1">filelist </span><span class="s2">= </span><span class="s1">glob</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>

            <span class="s5">for </span><span class="s1">file </span><span class="s5">in </span><span class="s1">filelist</span><span class="s2">:</span>
                <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__readPackageImportDescFile</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">file</span><span class="s2">))</span>
                <span class="s1">packages</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">package</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">__sortImportPackages</span><span class="s2">(</span><span class="s1">packages</span><span class="s2">)</span>
        <span class="s5">for </span><span class="s1">package </span><span class="s5">in </span><span class="s1">packages</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">package </span><span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__packageIsValid</span><span class="s2">(</span><span class="s1">package</span><span class="s2">, </span><span class="s1">requires</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">):</span>
                <span class="s5">return </span><span class="s1">package</span>

        <span class="s5">return None</span>

    <span class="s5">def </span><span class="s1">__findPackageOnHost</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s1">requires </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s1">appRunner </span><span class="s2">= </span><span class="s1">AppRunnerGlobal</span><span class="s2">.</span><span class="s1">appRunner</span>

        <span class="s4"># Make sure we have a fresh version of the contents file.</span>
        <span class="s1">host </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__getHostInfo</span><span class="s2">(</span><span class="s1">hostUrl</span><span class="s2">)</span>
        <span class="s5">if not </span><span class="s1">host</span><span class="s2">.</span><span class="s1">downloadContentsFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">):</span>
            <span class="s5">return None</span>

        <span class="s1">packageInfos </span><span class="s2">= []</span>
        <span class="s1">packageInfo </span><span class="s2">= </span><span class="s1">host</span><span class="s2">.</span><span class="s1">getPackage</span><span class="s2">(</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">platform </span><span class="s2">= </span><span class="s1">platform</span><span class="s2">)</span>
        <span class="s5">if not </span><span class="s1">packageInfo </span><span class="s5">and not </span><span class="s1">version</span><span class="s2">:</span>
            <span class="s4"># No explicit version is specified, first fallback: look</span>
            <span class="s4"># for the compiled-in version.</span>
            <span class="s1">packageInfo </span><span class="s2">= </span><span class="s1">host</span><span class="s2">.</span><span class="s1">getPackage</span><span class="s2">(</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageVersionString</span><span class="s2">(), </span><span class="s1">platform </span><span class="s2">= </span><span class="s1">platform</span><span class="s2">)</span>

        <span class="s5">if not </span><span class="s1">packageInfo </span><span class="s5">and not </span><span class="s1">version</span><span class="s2">:</span>
            <span class="s4"># No explicit version is specified, second fallback: get</span>
            <span class="s4"># the highest-numbered version available.</span>
            <span class="s1">packageInfos </span><span class="s2">= </span><span class="s1">host</span><span class="s2">.</span><span class="s1">getPackages</span><span class="s2">(</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">platform </span><span class="s2">= </span><span class="s1">platform</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__sortPackageInfos</span><span class="s2">(</span><span class="s1">packageInfos</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">packageInfo </span><span class="s5">and not </span><span class="s1">packageInfos</span><span class="s2">:</span>
            <span class="s1">packageInfos </span><span class="s2">= [</span><span class="s1">packageInfo</span><span class="s2">]</span>

        <span class="s5">for </span><span class="s1">packageInfo </span><span class="s5">in </span><span class="s1">packageInfos</span><span class="s2">:</span>
            <span class="s5">if not </span><span class="s1">packageInfo </span><span class="s5">or not </span><span class="s1">packageInfo</span><span class="s2">.</span><span class="s1">importDescFile</span><span class="s2">:</span>
                <span class="s5">continue</span>

            <span class="s4"># Now we've retrieved a PackageInfo.  Get the import desc file</span>
            <span class="s4"># from it.</span>
            <span class="s5">if </span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostDir</span><span class="s2">:</span>
                <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostDir</span><span class="s2">, </span><span class="s3">'imports/' </span><span class="s2">+ </span><span class="s1">packageInfo</span><span class="s2">.</span><span class="s1">importDescFile</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">)</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s4"># We're not running in the packaged environment, so download</span>
                <span class="s4"># to a temporary file instead of the host directory.</span>
                <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s3">'import_' </span><span class="s2">+ </span><span class="s1">packageInfo</span><span class="s2">.</span><span class="s1">importDescFile</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">, </span><span class="s3">'.xml'</span><span class="s2">)</span>

            <span class="s5">if not </span><span class="s1">host</span><span class="s2">.</span><span class="s1">freshenFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">, </span><span class="s1">packageInfo</span><span class="s2">.</span><span class="s1">importDescFile</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Couldn't download import file.&quot;</span><span class="s2">)</span>
                <span class="s5">continue</span>

            <span class="s4"># Now that we have the import desc file, use it to load one of</span>
            <span class="s4"># our Package objects.</span>
            <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">Package</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>
            <span class="s1">success </span><span class="s2">= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">readImportDescFile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>

            <span class="s5">if not </span><span class="s1">host</span><span class="s2">.</span><span class="s1">hostDir</span><span class="s2">:</span>
                <span class="s4"># Don't forget to delete the temporary file we created.</span>
                <span class="s1">filename</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">()</span>

            <span class="s5">if </span><span class="s1">success </span><span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__packageIsValid</span><span class="s2">(</span><span class="s1">package</span><span class="s2">, </span><span class="s1">requires</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">):</span>
                <span class="s5">return </span><span class="s1">package</span>

        <span class="s4"># Couldn't find a suitable package.</span>
        <span class="s5">return None</span>

    <span class="s5">def </span><span class="s1">__getHostInfo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">hostUrl </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This shadows appRunner.getHost(), for the purpose of running 
        outside the packaged environment. &quot;&quot;&quot;</span>

        <span class="s5">if not </span><span class="s1">hostUrl</span><span class="s2">:</span>
            <span class="s1">hostUrl </span><span class="s2">= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageHostUrl</span><span class="s2">()</span>

        <span class="s5">if </span><span class="s1">AppRunnerGlobal</span><span class="s2">.</span><span class="s1">appRunner</span><span class="s2">:</span>
            <span class="s5">return </span><span class="s1">AppRunnerGlobal</span><span class="s2">.</span><span class="s1">appRunner</span><span class="s2">.</span><span class="s1">getHost</span><span class="s2">(</span><span class="s1">hostUrl</span><span class="s2">)</span>

        <span class="s1">host </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__hostInfos</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">hostUrl</span><span class="s2">, </span><span class="s5">None</span><span class="s2">)</span>
        <span class="s5">if not </span><span class="s1">host</span><span class="s2">:</span>
            <span class="s1">host </span><span class="s2">= </span><span class="s1">HostInfo</span><span class="s2">(</span><span class="s1">hostUrl</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__hostInfos</span><span class="s2">[</span><span class="s1">hostUrl</span><span class="s2">] = </span><span class="s1">host</span>
        <span class="s5">return </span><span class="s1">host</span>

    <span class="s5">def </span><span class="s1">__sortImportPackages</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packages</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Given a list of Packages read from *.import.xml filenames, 
        sorts them in reverse order by version, so that the 
        highest-numbered versions appear first in the list. &quot;&quot;&quot;</span>

        <span class="s1">tuples </span><span class="s2">= []</span>
        <span class="s5">for </span><span class="s1">package </span><span class="s5">in </span><span class="s1">packages</span><span class="s2">:</span>
            <span class="s1">version </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__makeVersionTuple</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s1">tuples</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">version</span><span class="s2">, </span><span class="s1">package</span><span class="s2">))</span>
        <span class="s1">tuples</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">reverse </span><span class="s2">= </span><span class="s5">True</span><span class="s2">)</span>

        <span class="s5">return </span><span class="s2">[</span><span class="s1">t</span><span class="s2">[</span><span class="s6">1</span><span class="s2">] </span><span class="s5">for </span><span class="s1">t </span><span class="s5">in </span><span class="s1">tuples</span><span class="s2">]</span>

    <span class="s5">def </span><span class="s1">__sortPackageInfos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packages</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Given a list of PackageInfos retrieved from a Host, sorts 
        them in reverse order by version, so that the highest-numbered 
        versions appear first in the list. &quot;&quot;&quot;</span>

        <span class="s1">tuples </span><span class="s2">= []</span>
        <span class="s5">for </span><span class="s1">package </span><span class="s5">in </span><span class="s1">packages</span><span class="s2">:</span>
            <span class="s1">version </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__makeVersionTuple</span><span class="s2">(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageVersion</span><span class="s2">)</span>
            <span class="s1">tuples</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">version</span><span class="s2">, </span><span class="s1">package</span><span class="s2">))</span>
        <span class="s1">tuples</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">reverse </span><span class="s2">= </span><span class="s5">True</span><span class="s2">)</span>

        <span class="s5">return </span><span class="s2">[</span><span class="s1">t</span><span class="s2">[</span><span class="s6">1</span><span class="s2">] </span><span class="s5">for </span><span class="s1">t </span><span class="s5">in </span><span class="s1">tuples</span><span class="s2">]</span>

    <span class="s5">def </span><span class="s1">__makeVersionTuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Converts a version string into a tuple for sorting, by 
        separating out numbers into separate numeric fields, so that 
        version numbers sort numerically where appropriate. &quot;&quot;&quot;</span>

        <span class="s5">if not </span><span class="s1">version</span><span class="s2">:</span>
            <span class="s5">return </span><span class="s2">(</span><span class="s3">''</span><span class="s2">,)</span>

        <span class="s1">words </span><span class="s2">= []</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s5">while </span><span class="s1">p </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">version</span><span class="s2">):</span>
            <span class="s4"># Scan to the first digit.</span>
            <span class="s1">w </span><span class="s2">= </span><span class="s3">''</span>
            <span class="s5">while </span><span class="s1">p </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">version</span><span class="s2">) </span><span class="s5">and not </span><span class="s1">version</span><span class="s2">[</span><span class="s1">p</span><span class="s2">].</span><span class="s1">isdigit</span><span class="s2">():</span>
                <span class="s1">w </span><span class="s2">+= </span><span class="s1">version</span><span class="s2">[</span><span class="s1">p</span><span class="s2">]</span>
                <span class="s1">p </span><span class="s2">+= </span><span class="s6">1</span>
            <span class="s1">words</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">w</span><span class="s2">)</span>

            <span class="s4"># Scan to the end of the string of digits.</span>
            <span class="s1">w </span><span class="s2">= </span><span class="s3">''</span>
            <span class="s5">while </span><span class="s1">p </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">version</span><span class="s2">) </span><span class="s5">and </span><span class="s1">version</span><span class="s2">[</span><span class="s1">p</span><span class="s2">].</span><span class="s1">isdigit</span><span class="s2">():</span>
                <span class="s1">w </span><span class="s2">+= </span><span class="s1">version</span><span class="s2">[</span><span class="s1">p</span><span class="s2">]</span>
                <span class="s1">p </span><span class="s2">+= </span><span class="s6">1</span>
            <span class="s5">if </span><span class="s1">w</span><span class="s2">:</span>
                <span class="s1">words</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">w</span><span class="s2">))</span>

        <span class="s5">return </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">words</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">__packageIsValid</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">package</span><span class="s2">, </span><span class="s1">requires</span><span class="s2">, </span><span class="s1">platform</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Returns true if the package is valid, meaning it can be 
        imported without conflicts with existing packages already 
        required (such as different versions of panda3d). &quot;&quot;&quot;</span>

        <span class="s5">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform </span><span class="s5">and </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">!= </span><span class="s1">platform</span><span class="s2">:</span>
            <span class="s4"># Incorrect platform.</span>
            <span class="s5">return False</span>

        <span class="s5">if not </span><span class="s1">requires</span><span class="s2">:</span>
            <span class="s4"># No other restrictions.</span>
            <span class="s5">return True</span>

        <span class="s4"># Really, we only check the panda3d package.  The other</span>
        <span class="s4"># packages will list this as a dependency, and this is all</span>
        <span class="s4"># that matters.</span>

        <span class="s1">panda1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__findPackageInRequires</span><span class="s2">(</span><span class="s3">'panda3d'</span><span class="s2">, [</span><span class="s1">package</span><span class="s2">] + </span><span class="s1">package</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">)</span>
        <span class="s1">panda2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__findPackageInRequires</span><span class="s2">(</span><span class="s3">'panda3d'</span><span class="s2">, </span><span class="s1">requires</span><span class="s2">)</span>

        <span class="s5">if not </span><span class="s1">panda1 </span><span class="s5">or not </span><span class="s1">panda2</span><span class="s2">:</span>
            <span class="s5">return True</span>

        <span class="s5">if </span><span class="s1">panda1</span><span class="s2">.</span><span class="s1">version </span><span class="s2">== </span><span class="s1">panda2</span><span class="s2">.</span><span class="s1">version</span><span class="s2">:</span>
            <span class="s5">return True</span>

        <span class="s1">print</span><span class="s2">(</span><span class="s3">'Rejecting package %s, version &quot;%s&quot;: depends on %s, version &quot;%s&quot; instead of version &quot;%s&quot;' </span><span class="s2">% (</span>
            <span class="s1">package</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">version</span><span class="s2">,</span>
            <span class="s1">panda1</span><span class="s2">.</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">panda1</span><span class="s2">.</span><span class="s1">version</span><span class="s2">, </span><span class="s1">panda2</span><span class="s2">.</span><span class="s1">version</span><span class="s2">))</span>
        <span class="s5">return False</span>

    <span class="s5">def </span><span class="s1">__findPackageInRequires</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">list</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Returns the first package with the indicated name in the 
        list of packages, or in the list of packages required by the 
        packages in the list. &quot;&quot;&quot;</span>

        <span class="s5">for </span><span class="s1">package </span><span class="s5">in </span><span class="s1">list</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">== </span><span class="s1">packageName</span><span class="s2">:</span>
                <span class="s5">return </span><span class="s1">package</span>
            <span class="s1">p2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__findPackageInRequires</span><span class="s2">(</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">package</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">p2</span><span class="s2">:</span>
                <span class="s5">return </span><span class="s1">p2</span>

        <span class="s5">return None</span>

    <span class="s5">def </span><span class="s1">__readPackageImportDescFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Reads the named xml file as a Package, and returns it if 
        valid, or None otherwise. &quot;&quot;&quot;</span>

        <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">Package</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">readImportDescFile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">):</span>
            <span class="s5">return </span><span class="s1">package</span>

        <span class="s5">return None</span>

    <span class="s5">def </span><span class="s1">do_setVer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Sets an explicit set_ver number for the package, as a tuple 
        of integers, or as a string of dot-separated integers. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">packageSetVer </span><span class="s2">= </span><span class="s1">SeqValue</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">do_config</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Called with any number of keyword parameters.  For each 
        keyword parameter, sets the corresponding p3d config variable 
        to the given value.  This will be written into the 
        p3d_info.xml file at the top of the application, or to the 
        package desc file for a package file. &quot;&quot;&quot;</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">:</span>
            <span class="s5">raise </span><span class="s1">OutsideOfPackageError</span>

        <span class="s5">for </span><span class="s1">keyword</span><span class="s2">, </span><span class="s1">value </span><span class="s5">in </span><span class="s1">list</span><span class="s2">(</span><span class="s1">kw</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">configs</span><span class="s2">[</span><span class="s1">keyword</span><span class="s2">] = </span><span class="s1">value</span>

    <span class="s5">def </span><span class="s1">do_require</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Indicates a dependency on the named package(s), supplied 
        as a name. 
 
        Attempts to install this package will implicitly install the 
        named package also.  Files already included in the named 
        package will be omitted from this one when building it. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">requirePackagesNamed</span><span class="s2">(</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">requirePackagesNamed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">names</span><span class="s2">, </span><span class="s1">version </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">host </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Indicates a dependency on the named package(s), supplied 
        as a name. 
 
        Attempts to install this package will implicitly install the 
        named package also.  Files already included in the named 
        package will be omitted from this one when building it. &quot;&quot;&quot;</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">:</span>
            <span class="s5">raise </span><span class="s1">OutsideOfPackageError</span>

        <span class="s5">for </span><span class="s1">packageName </span><span class="s5">in </span><span class="s1">names</span><span class="s2">:</span>
            <span class="s4"># A special case when requiring the &quot;panda3d&quot; package.  We</span>
            <span class="s4"># supply the version number which we've been compiled with</span>
            <span class="s4"># as a default.</span>
            <span class="s1">pversion </span><span class="s2">= </span><span class="s1">version</span>
            <span class="s1">phost </span><span class="s2">= </span><span class="s1">host</span>
            <span class="s5">if </span><span class="s1">packageName </span><span class="s2">== </span><span class="s3">'panda3d'</span><span class="s2">:</span>
                <span class="s5">if not </span><span class="s1">pversion</span><span class="s2">:</span>
                    <span class="s1">pversion </span><span class="s2">= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageVersionString</span><span class="s2">()</span>
                <span class="s5">if not </span><span class="s1">phost</span><span class="s2">:</span>
                    <span class="s1">phost </span><span class="s2">= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageHostUrl</span><span class="s2">()</span>

            <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">findPackage</span><span class="s2">(</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">version </span><span class="s2">= </span><span class="s1">pversion</span><span class="s2">, </span><span class="s1">host </span><span class="s2">= </span><span class="s1">phost</span><span class="s2">,</span>
                                       <span class="s1">requires </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">)</span>
            <span class="s5">if not </span><span class="s1">package</span><span class="s2">:</span>
                <span class="s1">message </span><span class="s2">= </span><span class="s3">'Unknown package %s, version &quot;%s&quot;' </span><span class="s2">% (</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">version</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">missingPackages</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">packageName</span><span class="s2">, </span><span class="s1">pversion</span><span class="s2">))</span>
                <span class="s5">continue</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">requirePackage</span><span class="s2">(</span><span class="s1">package</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">requirePackage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">package</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Indicates a dependency on the indicated package, supplied 
        as a Package object. 
 
        Attempts to install this package will implicitly install the 
        named package also.  Files already included in the named 
        package will be omitted from this one. &quot;&quot;&quot;</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">:</span>
            <span class="s5">raise </span><span class="s1">OutsideOfPackageError</span>

        <span class="s4"># A special case when requiring the &quot;panda3d&quot; package.  We</span>
        <span class="s4"># complain if the version number doesn't match what we've been</span>
        <span class="s4"># compiled with.</span>
        <span class="s5">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">packageName </span><span class="s2">== </span><span class="s3">'panda3d'</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">version </span><span class="s2">!= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageVersionString</span><span class="s2">():</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Requiring panda3d version %s, which does not match the current build of Panda, which is version %s.&quot; </span><span class="s2">% (</span><span class="s1">package</span><span class="s2">.</span><span class="s1">version</span><span class="s2">, </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageVersionString</span><span class="s2">()))</span>
            <span class="s5">elif </span><span class="s1">package</span><span class="s2">.</span><span class="s1">host </span><span class="s2">!= </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageHostUrl</span><span class="s2">():</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Requiring panda3d host %s, which does not match the current build of Panda, which is host %s.&quot; </span><span class="s2">% (</span><span class="s1">package</span><span class="s2">.</span><span class="s1">host</span><span class="s2">, </span><span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageHostUrl</span><span class="s2">()))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">requirePackage</span><span class="s2">(</span><span class="s1">package</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">do_module</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Adds the indicated Python module(s) to the current package. &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">addModule</span><span class="s2">(</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">addModule</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">moduleNames</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">filename </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">required </span><span class="s2">= </span><span class="s5">False</span><span class="s2">):</span>
        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">:</span>
            <span class="s5">raise </span><span class="s1">OutsideOfPackageError</span>

        <span class="s5">if </span><span class="s2">(</span><span class="s1">newName </span><span class="s5">or </span><span class="s1">filename</span><span class="s2">) </span><span class="s5">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">moduleNames</span><span class="s2">) != </span><span class="s6">1</span><span class="s2">:</span>
            <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s3">'Cannot specify newName with multiple modules'</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">required</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">requiredModules </span><span class="s2">+= </span><span class="s1">moduleNames</span>

        <span class="s5">for </span><span class="s1">moduleName </span><span class="s5">in </span><span class="s1">moduleNames</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">addModule</span><span class="s2">(</span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">newName</span><span class="s2">, </span><span class="s1">filename </span><span class="s2">= </span><span class="s1">filename</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">do_excludeModule</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Marks the indicated Python module as not to be included. &quot;&quot;&quot;</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">:</span>
            <span class="s5">raise </span><span class="s1">OutsideOfPackageError</span>

        <span class="s5">for </span><span class="s1">moduleName </span><span class="s5">in </span><span class="s1">args</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">excludeModule</span><span class="s2">(</span><span class="s1">moduleName</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">do_main</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Includes the indicated file as __main__ module of the application. 
        Also updates mainModule to point to this module. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">addModule</span><span class="s2">([</span><span class="s3">'__main__'</span><span class="s2">], </span><span class="s3">'__main__'</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">, </span><span class="s1">required </span><span class="s2">= </span><span class="s5">True</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">mainModule </span><span class="s2">= (</span><span class="s3">'__main__'</span><span class="s2">, </span><span class="s3">'__main__'</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">do_mainModule</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">filename </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Names the indicated module as the &quot;main&quot; module of the 
        application or exe.  In most cases, you will want to use main() 
        instead. &quot;&quot;&quot;</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">:</span>
            <span class="s5">raise </span><span class="s1">OutsideOfPackageError</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">mainModule </span><span class="s5">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">mainModule</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] != </span><span class="s1">moduleName</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Replacing mainModule %s with %s&quot; </span><span class="s2">% (</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">mainModule</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">moduleName</span><span class="s2">))</span>

        <span class="s5">if not </span><span class="s1">newName</span><span class="s2">:</span>
            <span class="s1">newName </span><span class="s2">= </span><span class="s1">moduleName</span>

        <span class="s5">if </span><span class="s1">filename</span><span class="s2">:</span>
            <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
            <span class="s1">newFilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">moduleName</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">)))</span>
            <span class="s1">newFilename</span><span class="s2">.</span><span class="s1">setExtension</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getExtension</span><span class="s2">())</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">addFile</span><span class="s2">(</span>
                <span class="s1">filename</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">newFilename</span><span class="s2">),</span>
                <span class="s1">explicit </span><span class="s2">= </span><span class="s5">True</span><span class="s2">, </span><span class="s1">extract </span><span class="s2">= </span><span class="s5">True</span><span class="s2">, </span><span class="s1">required </span><span class="s2">= </span><span class="s5">True</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">mainModule </span><span class="s2">= (</span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">newName</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">do_sign</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">certificate</span><span class="s2">, </span><span class="s1">chain </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">pkey </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">password </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Signs the resulting p3d file (or package multifile) with 
        the indicated certificate.  If needed, the chain file should 
        contain the list of additional certificate authorities needed 
        to validate the signing certificate.  The pkey file should 
        contain the private key. 
 
        It is also legal for the certificate file to contain the chain 
        and private key embedded within it. 
 
        If the private key is encrypted, the password should be 
        supplied. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">signParams</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">certificate</span><span class="s2">, </span><span class="s1">chain</span><span class="s2">, </span><span class="s1">pkey</span><span class="s2">, </span><span class="s1">password</span><span class="s2">))</span>

    <span class="s5">def </span><span class="s1">do_setupPanda3D</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">p3dpythonName</span><span class="s2">=</span><span class="s5">None</span><span class="s2">, </span><span class="s1">p3dpythonwName</span><span class="s2">=</span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; A special convenience command that adds the minimum 
        startup modules for a panda3d package, intended for developers 
        producing their own custom panda3d for download.  Should be 
        called before any other Python modules are named. &quot;&quot;&quot;</span>

        <span class="s4"># This module and all its dependencies come frozen into p3dpython.</span>
        <span class="s4"># We should mark them as having already been added so that we don't</span>
        <span class="s4"># add them again to the Multifile.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">do_module</span><span class="s2">(</span><span class="s3">'direct.showbase.VFSImporter'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">done</span><span class="s2">(</span><span class="s1">addStartupModules</span><span class="s2">=</span><span class="s5">True</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">writeCode</span><span class="s2">(</span><span class="s5">None</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">addExtensionModules</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">do_file</span><span class="s2">(</span><span class="s3">'panda3d/core.pyd'</span><span class="s2">, </span><span class="s1">newDir</span><span class="s2">=</span><span class="s3">'panda3d'</span><span class="s2">)</span>

        <span class="s4"># This is the key Python module that is imported at runtime to</span>
        <span class="s4"># start an application running.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">do_module</span><span class="s2">(</span><span class="s3">'direct.p3d.AppRunner'</span><span class="s2">)</span>

        <span class="s4"># This is the main program that drives the runtime Python.  It</span>
        <span class="s4"># is responsible for importing direct.p3d.AppRunner to start an</span>
        <span class="s4"># application running.  The program comes in two parts: an</span>
        <span class="s4"># executable, and an associated dynamic library.  Note that the</span>
        <span class="s4"># .exe and .dll extensions are automatically replaced with the</span>
        <span class="s4"># appropriate platform-specific extensions.</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'osx'</span><span class="s2">):</span>
            <span class="s4"># On Mac, we package up a P3DPython.app bundle.  This</span>
            <span class="s4"># includes specifications in the plist file to avoid</span>
            <span class="s4"># creating a dock icon and stuff.</span>

            <span class="s1">resources </span><span class="s2">= []</span>

            <span class="s4"># Find p3dpython.plist in the direct source tree.</span>
            <span class="s5">import </span><span class="s1">direct</span>
            <span class="s1">plist </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">direct</span><span class="s2">.</span><span class="s1">__path__</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s3">'plugin/p3dpython.plist'</span><span class="s2">)</span>

<span class="s4">##             # Find panda3d.icns in the models tree.</span>
<span class="s4">##             filename = Filename('plugin_images/panda3d.icns')</span>
<span class="s4">##             found = filename.resolveFilename(getModelPath().getValue())</span>
<span class="s4">##             if not found:</span>
<span class="s4">##                 found = filename.resolveFilename(&quot;models&quot;)</span>
<span class="s4">##             if found:</span>
<span class="s4">##                 resources.append(filename)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">do_makeBundle</span><span class="s2">(</span><span class="s3">'P3DPython.app'</span><span class="s2">, </span><span class="s1">plist</span><span class="s2">, </span><span class="s1">executable </span><span class="s2">= </span><span class="s3">'p3dpython'</span><span class="s2">,</span>
                               <span class="s1">resources </span><span class="s2">= </span><span class="s1">resources</span><span class="s2">, </span><span class="s1">dependencyDir </span><span class="s2">= </span><span class="s3">''</span><span class="s2">)</span>

        <span class="s5">else</span><span class="s2">:</span>
            <span class="s4"># Anywhere else, we just ship the executable file p3dpython.exe.</span>
            <span class="s5">if </span><span class="s1">p3dpythonName </span><span class="s5">is None</span><span class="s2">:</span>
                <span class="s1">p3dpythonName </span><span class="s2">= </span><span class="s3">'p3dpython'</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">do_config</span><span class="s2">(</span><span class="s1">p3dpython_name</span><span class="s2">=</span><span class="s1">p3dpythonName</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'win'</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">do_file</span><span class="s2">(</span><span class="s3">'p3dpython.exe'</span><span class="s2">, </span><span class="s1">newName</span><span class="s2">=</span><span class="s1">p3dpythonName</span><span class="s2">+</span><span class="s3">'.exe'</span><span class="s2">)</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">do_file</span><span class="s2">(</span><span class="s3">'p3dpython.exe'</span><span class="s2">, </span><span class="s1">newName</span><span class="s2">=</span><span class="s1">p3dpythonName</span><span class="s2">)</span>

            <span class="s4"># The &quot;Windows&quot; executable appends a 'w' to whatever name is used</span>
            <span class="s4"># above, unless an override name is explicitly specified.</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'win'</span><span class="s2">):</span>
                <span class="s5">if </span><span class="s1">p3dpythonwName </span><span class="s5">is None</span><span class="s2">:</span>
                    <span class="s1">p3dpythonwName </span><span class="s2">= </span><span class="s1">p3dpythonName</span><span class="s2">+</span><span class="s3">'w'</span>
                <span class="s5">else</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">do_config</span><span class="s2">(</span><span class="s1">p3dpythonw_name</span><span class="s2">=</span><span class="s1">p3dpythonwName</span><span class="s2">)</span>

                <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'win'</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">do_file</span><span class="s2">(</span><span class="s3">'p3dpythonw.exe'</span><span class="s2">, </span><span class="s1">newName</span><span class="s2">=</span><span class="s1">p3dpythonwName</span><span class="s2">+</span><span class="s3">'.exe'</span><span class="s2">)</span>
                <span class="s5">else</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">do_file</span><span class="s2">(</span><span class="s3">'p3dpythonw.exe'</span><span class="s2">, </span><span class="s1">newName</span><span class="s2">=</span><span class="s1">p3dpythonwName</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">do_file</span><span class="s2">(</span><span class="s3">'libp3dpython.dll'</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">do_freeze</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">, </span><span class="s1">compileToExe </span><span class="s2">= </span><span class="s5">False</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Freezes all of the current Python code into either an 
        executable (if compileToExe is true) or a dynamic library (if 
        it is false).  The resulting compiled binary is added to the 
        current package under the indicated filename.  The filename 
        should not include an extension; that will be added. &quot;&quot;&quot;</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">:</span>
            <span class="s5">raise </span><span class="s1">OutsideOfPackageError</span>

        <span class="s1">package </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span>
        <span class="s1">freezer </span><span class="s2">= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">freezer</span>

        <span class="s5">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">mainModule </span><span class="s5">and not </span><span class="s1">compileToExe</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Ignoring main_module for dll %s&quot; </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">))</span>
            <span class="s1">package</span><span class="s2">.</span><span class="s1">mainModule </span><span class="s2">= </span><span class="s5">None</span>
        <span class="s5">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">mainModule </span><span class="s5">and </span><span class="s1">compileToExe</span><span class="s2">:</span>
            <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;No main_module specified for exe %s&quot; </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">)</span>
            <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">package</span><span class="s2">.</span><span class="s1">mainModule</span><span class="s2">:</span>
            <span class="s1">moduleName</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">package</span><span class="s2">.</span><span class="s1">mainModule</span>
            <span class="s5">if </span><span class="s1">compileToExe</span><span class="s2">:</span>
                <span class="s4"># If we're producing an exe, the main module must</span>
                <span class="s4"># be called &quot;__main__&quot;.</span>
                <span class="s1">newName </span><span class="s2">= </span><span class="s3">'__main__'</span>
                <span class="s1">package</span><span class="s2">.</span><span class="s1">mainModule </span><span class="s2">= (</span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">newName</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">newName </span><span class="s5">not in </span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">:</span>
                <span class="s1">freezer</span><span class="s2">.</span><span class="s1">addModule</span><span class="s2">(</span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">newName</span><span class="s2">)</span>
            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">freezer</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s1">newName</span><span class="s2">] = </span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s1">moduleName</span><span class="s2">]</span>
        <span class="s1">freezer</span><span class="s2">.</span><span class="s1">done</span><span class="s2">(</span><span class="s1">addStartupModules </span><span class="s2">= </span><span class="s1">compileToExe</span><span class="s2">)</span>

        <span class="s1">dirname </span><span class="s2">= </span><span class="s3">''</span>
        <span class="s1">basename </span><span class="s2">= </span><span class="s1">filename</span>
        <span class="s5">if </span><span class="s3">'/' </span><span class="s5">in </span><span class="s1">basename</span><span class="s2">:</span>
            <span class="s1">dirname</span><span class="s2">, </span><span class="s1">basename </span><span class="s2">= </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">rsplit</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
            <span class="s1">dirname </span><span class="s2">+= </span><span class="s3">'/'</span>

        <span class="s1">basename </span><span class="s2">= </span><span class="s1">freezer</span><span class="s2">.</span><span class="s1">generateCode</span><span class="s2">(</span><span class="s1">basename</span><span class="s2">, </span><span class="s1">compileToExe </span><span class="s2">= </span><span class="s1">compileToExe</span><span class="s2">)</span>

        <span class="s1">package</span><span class="s2">.</span><span class="s1">addFile</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">basename</span><span class="s2">), </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">dirname </span><span class="s2">+ </span><span class="s1">basename</span><span class="s2">,</span>
                        <span class="s1">deleteTemp </span><span class="s2">= </span><span class="s5">True</span><span class="s2">, </span><span class="s1">explicit </span><span class="s2">= </span><span class="s5">True</span><span class="s2">, </span><span class="s1">extract </span><span class="s2">= </span><span class="s5">True</span><span class="s2">)</span>
        <span class="s1">package</span><span class="s2">.</span><span class="s1">addExtensionModules</span><span class="s2">()</span>
        <span class="s5">if not </span><span class="s1">package</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">:</span>
            <span class="s1">package</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">platform</span>

        <span class="s4"># Reset the freezer for more Python files.</span>
        <span class="s1">freezer</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
        <span class="s1">package</span><span class="s2">.</span><span class="s1">mainModule </span><span class="s2">= </span><span class="s5">None</span>

    <span class="s5">def </span><span class="s1">do_makeBundle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bundleName</span><span class="s2">, </span><span class="s1">plist</span><span class="s2">, </span><span class="s1">executable </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                      <span class="s1">resources </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">dependencyDir </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Constructs a minimal OSX &quot;bundle&quot; consisting of an 
        executable and a plist file, with optional resource files 
        (such as icons), and adds it to the package under the given 
        name. &quot;&quot;&quot;</span>

        <span class="s1">contents </span><span class="s2">= </span><span class="s1">bundleName </span><span class="s2">+ </span><span class="s3">'/Contents'</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">addFiles</span><span class="s2">([</span><span class="s1">plist</span><span class="s2">], </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">contents </span><span class="s2">+ </span><span class="s3">'/Info.plist'</span><span class="s2">,</span>
                      <span class="s1">extract </span><span class="s2">= </span><span class="s5">True</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">executable</span><span class="s2">:</span>
            <span class="s1">basename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">executable</span><span class="s2">).</span><span class="s1">getBasename</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">addFiles</span><span class="s2">([</span><span class="s1">executable</span><span class="s2">], </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">contents </span><span class="s2">+ </span><span class="s3">'/MacOS/' </span><span class="s2">+ </span><span class="s1">basename</span><span class="s2">,</span>
                          <span class="s1">extract </span><span class="s2">= </span><span class="s5">True</span><span class="s2">, </span><span class="s1">executable </span><span class="s2">= </span><span class="s5">True</span><span class="s2">, </span><span class="s1">dependencyDir </span><span class="s2">= </span><span class="s1">dependencyDir</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">resources</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">addFiles</span><span class="s2">(</span><span class="s1">resources</span><span class="s2">, </span><span class="s1">newDir </span><span class="s2">= </span><span class="s1">contents </span><span class="s2">+ </span><span class="s3">'/Resources'</span><span class="s2">,</span>
                          <span class="s1">extract </span><span class="s2">= </span><span class="s5">True</span><span class="s2">, </span><span class="s1">dependencyDir </span><span class="s2">= </span><span class="s1">dependencyDir</span><span class="s2">)</span>



    <span class="s5">def </span><span class="s1">do_file</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Adds the indicated file or files to the current package. 
        See addFiles(). &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">addFiles</span><span class="s2">(</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">addFiles</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filenames</span><span class="s2">, </span><span class="s1">text </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                 <span class="s1">newDir </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">extract </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">executable </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                 <span class="s1">deleteTemp </span><span class="s2">= </span><span class="s5">False</span><span class="s2">, </span><span class="s1">literal </span><span class="s2">= </span><span class="s5">False</span><span class="s2">,</span>
                 <span class="s1">dependencyDir </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">required </span><span class="s2">= </span><span class="s5">False</span><span class="s2">):</span>

        <span class="s0">&quot;&quot;&quot; Adds the indicated arbitrary files to the current package. 
 
        filenames is a list of Filename or string objects, and each 
        may include shell globbing characters. 
 
        Each file is placed in the named directory, or the toplevel 
        directory if no directory is specified. 
 
        Certain special behavior is invoked based on the filename 
        extension.  For instance, .py files may be automatically 
        compiled and stored as Python modules. 
 
        If newDir is not None, it specifies the directory in which the 
        file should be placed.  In this case, all files matched by the 
        filename expression are placed in the named directory. 
 
        If newName is not None, it specifies a new filename.  In this 
        case, newDir is ignored, and the filename expression must 
        match only one file. 
 
        If newName and newDir are both None, the file is placed in the 
        toplevel directory, regardless of its source directory. 
 
        If text is nonempty, it contains the text of the file.  In 
        this case, the filename is not read, but the supplied text is 
        used instead. 
 
        If extract is true, the file is explicitly extracted at 
        runtime. 
 
        If executable is true, the file is marked as an executable 
        filename, for special treatment. 
 
        If deleteTemp is true, the file is a temporary file and will 
        be deleted after its contents are copied to the package. 
 
        If literal is true, then the file extension will be respected 
        exactly as it appears, and glob characters will not be 
        expanded.  If this is false, then .dll or .exe files will be 
        renamed to .dylib and no extension on OSX (or .so on Linux); 
        and glob characters will be expanded. 
 
        If required is true, then the file is marked a vital part of 
        the package.  The package will not be built if this file 
        somehow cannot be added to the package. 
 
        &quot;&quot;&quot;</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">:</span>
            <span class="s5">raise </span><span class="s1">OutsideOfPackageError</span>

        <span class="s1">files </span><span class="s2">= []</span>
        <span class="s1">explicit </span><span class="s2">= </span><span class="s5">True</span>

        <span class="s5">for </span><span class="s1">filename </span><span class="s5">in </span><span class="s1">filenames</span><span class="s2">:</span>
            <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>

            <span class="s5">if </span><span class="s1">literal</span><span class="s2">:</span>
                <span class="s1">thisFiles </span><span class="s2">= [</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()]</span>

            <span class="s5">else</span><span class="s2">:</span>
                <span class="s1">ext </span><span class="s2">= </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getExtension</span><span class="s2">()</span>

                <span class="s4"># A special case, since OSX and Linux don't have a</span>
                <span class="s4"># standard extension for program files.</span>
                <span class="s5">if </span><span class="s1">executable </span><span class="s5">is None and </span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'exe'</span><span class="s2">:</span>
                    <span class="s1">executable </span><span class="s2">= </span><span class="s5">True</span>

                <span class="s1">newExt </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">remapExtensions</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">ext</span><span class="s2">, </span><span class="s5">None</span><span class="s2">)</span>
                <span class="s5">if </span><span class="s1">newExt </span><span class="s5">is not None</span><span class="s2">:</span>
                    <span class="s1">filename</span><span class="s2">.</span><span class="s1">setExtension</span><span class="s2">(</span><span class="s1">newExt</span><span class="s2">)</span>

                <span class="s1">thisFiles </span><span class="s2">= </span><span class="s1">glob</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
                <span class="s5">if not </span><span class="s1">thisFiles</span><span class="s2">:</span>
                    <span class="s1">thisFiles </span><span class="s2">= [</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()]</span>

                <span class="s5">if </span><span class="s1">newExt </span><span class="s2">== </span><span class="s3">'dll' </span><span class="s5">or </span><span class="s2">(</span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'dll' </span><span class="s5">and </span><span class="s1">newExt </span><span class="s5">is None</span><span class="s2">):</span>
                    <span class="s4"># Go through the dsoFilename interface on Windows,</span>
                    <span class="s4"># to insert a _d if we are running on a debug</span>
                    <span class="s4"># build.</span>
                    <span class="s1">dllFilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
                    <span class="s1">dllFilename</span><span class="s2">.</span><span class="s1">setExtension</span><span class="s2">(</span><span class="s3">'so'</span><span class="s2">)</span>
                    <span class="s1">dllFilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">dsoFilename</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">dllFilename</span><span class="s2">))</span>
                    <span class="s5">if </span><span class="s1">dllFilename </span><span class="s2">!= </span><span class="s1">filename</span><span class="s2">:</span>
                        <span class="s1">thisFiles </span><span class="s2">= </span><span class="s1">glob</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
                        <span class="s5">if not </span><span class="s1">thisFiles</span><span class="s2">:</span>
                            <span class="s4"># We have to resolve this filename to</span>
                            <span class="s4"># determine if it's a _d or not.</span>
                            <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">resolveLibrary</span><span class="s2">(</span><span class="s1">dllFilename</span><span class="s2">):</span>
                                <span class="s1">thisFiles </span><span class="s2">= [</span><span class="s1">dllFilename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()]</span>
                            <span class="s5">else</span><span class="s2">:</span>
                                <span class="s1">thisFiles </span><span class="s2">= [</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">()]</span>

            <span class="s5">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">thisFiles</span><span class="s2">) &gt; </span><span class="s6">1</span><span class="s2">:</span>
                <span class="s1">explicit </span><span class="s2">= </span><span class="s5">False</span>
            <span class="s1">files </span><span class="s2">+= </span><span class="s1">thisFiles</span>

        <span class="s1">prefix </span><span class="s2">= </span><span class="s3">''</span>
        <span class="s5">if </span><span class="s1">newDir </span><span class="s5">is not None</span><span class="s2">:</span>
            <span class="s1">prefix </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">newDir</span><span class="s2">))</span>
            <span class="s5">if </span><span class="s1">prefix </span><span class="s5">and </span><span class="s1">prefix</span><span class="s2">[-</span><span class="s6">1</span><span class="s2">] != </span><span class="s3">'/'</span><span class="s2">:</span>
                <span class="s1">prefix </span><span class="s2">+= </span><span class="s3">'/'</span>

        <span class="s5">if </span><span class="s1">newName</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">files</span><span class="s2">) != </span><span class="s6">1</span><span class="s2">:</span>
                <span class="s1">message </span><span class="s2">= </span><span class="s3">'Cannot install multiple files on target filename %s' </span><span class="s2">% (</span><span class="s1">newName</span><span class="s2">)</span>
                <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">text</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">files</span><span class="s2">) != </span><span class="s6">1</span><span class="s2">:</span>
                <span class="s1">message </span><span class="s2">= </span><span class="s3">'Cannot install text to multiple files'</span>
                <span class="s5">raise </span><span class="s1">PackagerError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>
            <span class="s5">if not </span><span class="s1">newName</span><span class="s2">:</span>
                <span class="s1">newName </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">filenames</span><span class="s2">[</span><span class="s6">0</span><span class="s2">])</span>

        <span class="s5">for </span><span class="s1">filename </span><span class="s5">in </span><span class="s1">files</span><span class="s2">:</span>
            <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
            <span class="s1">basename </span><span class="s2">= </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">()</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">newName</span>
            <span class="s5">if not </span><span class="s1">name</span><span class="s2">:</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">prefix </span><span class="s2">+ </span><span class="s1">basename</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">addFile</span><span class="s2">(</span>
                <span class="s1">filename</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">name</span><span class="s2">, </span><span class="s1">extract </span><span class="s2">= </span><span class="s1">extract</span><span class="s2">,</span>
                <span class="s1">explicit </span><span class="s2">= </span><span class="s1">explicit</span><span class="s2">, </span><span class="s1">executable </span><span class="s2">= </span><span class="s1">executable</span><span class="s2">,</span>
                <span class="s1">text </span><span class="s2">= </span><span class="s1">text</span><span class="s2">, </span><span class="s1">deleteTemp </span><span class="s2">= </span><span class="s1">deleteTemp</span><span class="s2">,</span>
                <span class="s1">dependencyDir </span><span class="s2">= </span><span class="s1">dependencyDir</span><span class="s2">, </span><span class="s1">required </span><span class="s2">= </span><span class="s1">required</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">do_exclude</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Marks the indicated filename as not to be included.  The 
        filename may include shell globbing characters, and may or may 
        not include a dirname.  (If it does not include a dirname, it 
        refers to any file with the given basename from any 
        directory.)&quot;&quot;&quot;</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">:</span>
            <span class="s5">raise </span><span class="s1">OutsideOfPackageError</span>

        <span class="s1">filename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">excludeFile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>


    <span class="s5">def </span><span class="s1">do_includeExtensions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">executableExtensions </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">extractExtensions </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                         <span class="s1">imageExtensions </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">textExtensions </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                         <span class="s1">uncompressibleExtensions </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">unprocessedExtensions </span><span class="s2">= </span><span class="s5">None</span><span class="s2">,</span>
                         <span class="s1">suppressWarningForExtensions </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Ensure that dir() will include files with the given extensions. 
        The extensions should not have '.' prefixes. 
 
        All except 'suppressWarningForExtensions' allow the given kinds of files 
        to be packaged with their respective semantics (read the source). 
 
        'suppressWarningForExtensions' lists extensions *expected* to be ignored, 
        so no warnings will be emitted for them. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">executableExtensions</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">executableExtensions </span><span class="s2">+= </span><span class="s1">executableExtensions</span>

        <span class="s5">if </span><span class="s1">extractExtensions</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">extractExtensions </span><span class="s2">+= </span><span class="s1">extractExtensions</span>

        <span class="s5">if </span><span class="s1">imageExtensions</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">imageExtensions </span><span class="s2">+= </span><span class="s1">imageExtensions</span>

        <span class="s5">if </span><span class="s1">textExtensions</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">textExtensions </span><span class="s2">+= </span><span class="s1">textExtensions</span>

        <span class="s5">if </span><span class="s1">uncompressibleExtensions</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">uncompressibleExtensions </span><span class="s2">+= </span><span class="s1">uncompressibleExtensions</span>

        <span class="s5">if </span><span class="s1">unprocessedExtensions</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">unprocessedExtensions </span><span class="s2">+= </span><span class="s1">unprocessedExtensions</span>

        <span class="s5">if </span><span class="s1">suppressWarningForExtensions</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">suppressWarningForExtensions </span><span class="s2">+= </span><span class="s1">suppressWarningForExtensions</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_ensureExtensions</span><span class="s2">()</span>

    <span class="s5">def </span><span class="s1">do_dir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dirname</span><span class="s2">, </span><span class="s1">newDir </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">unprocessed </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>

        <span class="s0">&quot;&quot;&quot; Adds the indicated directory hierarchy to the current 
        package.  The directory hierarchy is walked recursively, and 
        all files that match a known extension are added to the package. 
 
        newDir specifies the directory name within the package which 
        the contents of the named directory should be installed to. 
        If it is omitted, the contents of the named directory are 
        installed to the root of the package. 
 
        If unprocessed is false (the default), bam files are loaded and 
        scanned for textures, and these texture paths within the bam 
        files are manipulated to point to the new paths within the 
        package.  If unprocessed is true, this operation is bypassed, 
        and bam files are packed exactly as they are. 
        &quot;&quot;&quot;</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">:</span>
            <span class="s5">raise </span><span class="s1">OutsideOfPackageError</span>

        <span class="s1">dirname </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">)</span>
        <span class="s5">if not </span><span class="s1">newDir</span><span class="s2">:</span>
            <span class="s1">newDir </span><span class="s2">= </span><span class="s3">''</span>

        <span class="s4"># Adding the directory to sys.path is a cheesy way to help the</span>
        <span class="s4"># modulefinder find it.</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__recurseDir</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">, </span><span class="s1">newDir</span><span class="s2">, </span><span class="s1">unprocessed </span><span class="s2">= </span><span class="s1">unprocessed</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">__recurseDir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">, </span><span class="s1">newName</span><span class="s2">, </span><span class="s1">unprocessed </span><span class="s2">= </span><span class="s5">None</span><span class="s2">, </span><span class="s1">packageTree </span><span class="s2">= </span><span class="s5">None</span><span class="s2">):</span>
        <span class="s5">if </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">isDirectory</span><span class="s2">():</span>
            <span class="s4"># It's a directory name.  Recurse.</span>
            <span class="s1">prefix </span><span class="s2">= </span><span class="s1">newName</span>
            <span class="s5">if </span><span class="s1">prefix </span><span class="s5">and </span><span class="s1">prefix</span><span class="s2">[-</span><span class="s6">1</span><span class="s2">] != </span><span class="s3">'/'</span><span class="s2">:</span>
                <span class="s1">prefix </span><span class="s2">+= </span><span class="s3">'/'</span>

            <span class="s4"># First check if this is a Python package tree.  If so, add it</span>
            <span class="s4"># implicitly as a module.</span>
            <span class="s1">dirList </span><span class="s2">= </span><span class="s1">vfs</span><span class="s2">.</span><span class="s1">scanDirectory</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
            <span class="s5">for </span><span class="s1">subfile </span><span class="s5">in </span><span class="s1">dirList</span><span class="s2">:</span>
                <span class="s1">filename </span><span class="s2">= </span><span class="s1">subfile</span><span class="s2">.</span><span class="s1">getFilename</span><span class="s2">()</span>
                <span class="s5">if </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">() == </span><span class="s3">'__init__.py'</span><span class="s2">:</span>
                    <span class="s1">moduleName </span><span class="s2">= </span><span class="s1">newName</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">&quot;/&quot;</span><span class="s2">, </span><span class="s3">&quot;.&quot;</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">addModule</span><span class="s2">([</span><span class="s1">moduleName</span><span class="s2">], </span><span class="s1">filename</span><span class="s2">=</span><span class="s1">filename</span><span class="s2">)</span>

            <span class="s5">for </span><span class="s1">subfile </span><span class="s5">in </span><span class="s1">dirList</span><span class="s2">:</span>
                <span class="s1">filename </span><span class="s2">= </span><span class="s1">subfile</span><span class="s2">.</span><span class="s1">getFilename</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__recurseDir</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">prefix </span><span class="s2">+ </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getBasename</span><span class="s2">(),</span>
                                  <span class="s1">unprocessed </span><span class="s2">= </span><span class="s1">unprocessed</span><span class="s2">)</span>
            <span class="s5">return</span>
        <span class="s5">elif not </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">():</span>
            <span class="s4"># It doesn't exist.  Perhaps it's a virtual file.  Ignore it.</span>
            <span class="s5">return</span>

        <span class="s4"># It's a file name.  Add it.</span>
        <span class="s1">ext </span><span class="s2">= </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">getExtension</span><span class="s2">()</span>
        <span class="s5">if </span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'py'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">addFile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">newName</span><span class="s2">,</span>
                                        <span class="s1">explicit </span><span class="s2">= </span><span class="s5">False</span><span class="s2">, </span><span class="s1">unprocessed </span><span class="s2">= </span><span class="s1">unprocessed</span><span class="s2">)</span>
        <span class="s5">else</span><span class="s2">:</span>
            <span class="s5">if </span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'pz' </span><span class="s5">or </span><span class="s1">ext </span><span class="s2">== </span><span class="s3">'gz'</span><span class="s2">:</span>
                <span class="s4"># Strip off an implicit .pz extension.</span>
                <span class="s1">newFilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
                <span class="s1">newFilename</span><span class="s2">.</span><span class="s1">setExtension</span><span class="s2">(</span><span class="s3">''</span><span class="s2">)</span>
                <span class="s1">newFilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">newFilename</span><span class="s2">))</span>
                <span class="s1">ext </span><span class="s2">= </span><span class="s1">newFilename</span><span class="s2">.</span><span class="s1">getExtension</span><span class="s2">()</span>

            <span class="s5">if </span><span class="s1">ext </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">knownExtensions</span><span class="s2">:</span>
                <span class="s5">if </span><span class="s1">ext </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">textExtensions</span><span class="s2">:</span>
                    <span class="s1">filename</span><span class="s2">.</span><span class="s1">setText</span><span class="s2">()</span>
                <span class="s5">else</span><span class="s2">:</span>
                    <span class="s1">filename</span><span class="s2">.</span><span class="s1">setBinary</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">addFile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">newName </span><span class="s2">= </span><span class="s1">newName</span><span class="s2">,</span>
                                            <span class="s1">explicit </span><span class="s2">= </span><span class="s5">False</span><span class="s2">, </span><span class="s1">unprocessed </span><span class="s2">= </span><span class="s1">unprocessed</span><span class="s2">)</span>
            <span class="s5">elif not </span><span class="s1">ext </span><span class="s5">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">suppressWarningForExtensions</span><span class="s2">:</span>
                <span class="s1">newCount </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">ignoredDirFiles</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">ext</span><span class="s2">, </span><span class="s6">0</span><span class="s2">) + </span><span class="s6">1</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">currentPackage</span><span class="s2">.</span><span class="s1">ignoredDirFiles</span><span class="s2">[</span><span class="s1">ext</span><span class="s2">] = </span><span class="s1">newCount</span>

                <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">verbosePrint</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;ignoring file %s&quot; </span><span class="s2">% </span><span class="s1">filename</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">readContentsFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Reads the contents.xml file at the beginning of 
        processing. &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">hosts </span><span class="s2">= {}</span>
        <span class="s4"># Since we've blown away the self.hosts map, we have to make</span>
        <span class="s4"># sure that our own host at least is added to the map.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">addHost</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">maxAge </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">contentsSeq </span><span class="s2">= </span><span class="s1">SeqValue</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">contents </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">contentsChanged </span><span class="s2">= </span><span class="s5">False</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">allowPackages</span><span class="s2">:</span>
            <span class="s4"># Don't bother.</span>
            <span class="s5">return</span>

        <span class="s1">contentsFilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">, </span><span class="s3">'contents.xml'</span><span class="s2">)</span>
        <span class="s1">doc </span><span class="s2">= </span><span class="s1">TiXmlDocument</span><span class="s2">(</span><span class="s1">contentsFilename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s5">if not </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">LoadFile</span><span class="s2">():</span>
            <span class="s4"># Couldn't read file.</span>
            <span class="s5">return</span>

        <span class="s1">xcontents </span><span class="s2">= </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'contents'</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">xcontents</span><span class="s2">:</span>
            <span class="s1">maxAge </span><span class="s2">= </span><span class="s1">xcontents</span><span class="s2">.</span><span class="s1">Attribute</span><span class="s2">(</span><span class="s3">'max_age'</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">maxAge</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">maxAge </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">maxAge</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">contentsSeq</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xcontents</span><span class="s2">)</span>

            <span class="s1">xhost </span><span class="s2">= </span><span class="s1">xcontents</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'host'</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">xhost</span><span class="s2">:</span>
                <span class="s1">he </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">HostEntry</span><span class="s2">()</span>
                <span class="s1">he</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xhost</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">[</span><span class="s1">he</span><span class="s2">.</span><span class="s1">url</span><span class="s2">] = </span><span class="s1">he</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">host </span><span class="s2">= </span><span class="s1">he</span><span class="s2">.</span><span class="s1">url</span>

            <span class="s1">xpackage </span><span class="s2">= </span><span class="s1">xcontents</span><span class="s2">.</span><span class="s1">FirstChildElement</span><span class="s2">(</span><span class="s3">'package'</span><span class="s2">)</span>
            <span class="s5">while </span><span class="s1">xpackage</span><span class="s2">:</span>
                <span class="s1">pe </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">PackageEntry</span><span class="s2">()</span>
                <span class="s1">pe</span><span class="s2">.</span><span class="s1">loadXml</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">contents</span><span class="s2">[</span><span class="s1">pe</span><span class="s2">.</span><span class="s1">getKey</span><span class="s2">()] = </span><span class="s1">pe</span>
                <span class="s1">xpackage </span><span class="s2">= </span><span class="s1">xpackage</span><span class="s2">.</span><span class="s1">NextSiblingElement</span><span class="s2">(</span><span class="s3">'package'</span><span class="s2">)</span>

    <span class="s5">def </span><span class="s1">writeContentsFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; Rewrites the contents.xml file at the end of 
        processing. &quot;&quot;&quot;</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">contentsChanged</span><span class="s2">:</span>
            <span class="s4"># No need to rewrite.</span>
            <span class="s5">return</span>

        <span class="s1">contentsFilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">installDir</span><span class="s2">, </span><span class="s3">'contents.xml'</span><span class="s2">)</span>
        <span class="s1">doc </span><span class="s2">= </span><span class="s1">TiXmlDocument</span><span class="s2">(</span><span class="s1">contentsFilename</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">())</span>
        <span class="s1">decl </span><span class="s2">= </span><span class="s1">TiXmlDeclaration</span><span class="s2">(</span><span class="s3">&quot;1.0&quot;</span><span class="s2">, </span><span class="s3">&quot;utf-8&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
        <span class="s1">doc</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">decl</span><span class="s2">)</span>

        <span class="s1">xcontents </span><span class="s2">= </span><span class="s1">TiXmlElement</span><span class="s2">(</span><span class="s3">'contents'</span><span class="s2">)</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">maxAge</span><span class="s2">:</span>
            <span class="s1">xcontents</span><span class="s2">.</span><span class="s1">SetAttribute</span><span class="s2">(</span><span class="s3">'max_age'</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">maxAge</span><span class="s2">))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">contentsSeq </span><span class="s2">+= </span><span class="s6">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">contentsSeq</span><span class="s2">.</span><span class="s1">storeXml</span><span class="s2">(</span><span class="s1">xcontents</span><span class="s2">)</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">:</span>
            <span class="s1">he </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hosts</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s2">, </span><span class="s5">None</span><span class="s2">)</span>
            <span class="s5">if </span><span class="s1">he</span><span class="s2">:</span>
                <span class="s1">xhost </span><span class="s2">= </span><span class="s1">he</span><span class="s2">.</span><span class="s1">makeXml</span><span class="s2">(</span><span class="s1">packager </span><span class="s2">= </span><span class="s1">self</span><span class="s2">)</span>
                <span class="s1">xcontents</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xhost</span><span class="s2">)</span>

        <span class="s1">contents </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">contents</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
        <span class="s5">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">pe </span><span class="s5">in </span><span class="s1">contents</span><span class="s2">:</span>
            <span class="s1">xpackage </span><span class="s2">= </span><span class="s1">pe</span><span class="s2">.</span><span class="s1">makeXml</span><span class="s2">()</span>
            <span class="s1">xcontents</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xpackage</span><span class="s2">)</span>

        <span class="s1">doc</span><span class="s2">.</span><span class="s1">InsertEndChild</span><span class="s2">(</span><span class="s1">xcontents</span><span class="s2">)</span>
        <span class="s1">doc</span><span class="s2">.</span><span class="s1">SaveFile</span><span class="s2">()</span>


<span class="s4"># The following class and function definitions represent a few sneaky</span>
<span class="s4"># Python tricks to allow the pdef syntax to contain the pseudo-Python</span>
<span class="s4"># code they do.  These tricks bind the function and class definitions</span>
<span class="s4"># into a bit table as they are parsed from the pdef file, so we can</span>
<span class="s4"># walk through that table later and perform the operations requested</span>
<span class="s4"># in order.</span>

<span class="s5">class </span><span class="s1">metaclass_def</span><span class="s2">(</span><span class="s1">type</span><span class="s2">):</span>
    <span class="s0">&quot;&quot;&quot; A metaclass is invoked by Python when the class definition is 
    read, for instance to define a child class.  By defining a 
    metaclass for class_p3d and class_package, we can get a callback 
    when we encounter &quot;class foo(p3d)&quot; in the pdef file.  The callback 
    actually happens after all of the code within the class scope has 
    been parsed first. &quot;&quot;&quot;</span>

    <span class="s5">def </span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">bases</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">):</span>

        <span class="s4"># At the point of the callback, now, &quot;name&quot; is the name of the</span>
        <span class="s4"># class we are instantiating, &quot;bases&quot; is the list of parent</span>
        <span class="s4"># classes, and &quot;dict&quot; is the class dictionary we have just</span>
        <span class="s4"># parsed.</span>

        <span class="s4"># If &quot;dict&quot; contains __metaclass__, then we must be parsing</span>
        <span class="s4"># class_p3d or class_ppackage, below--skip it.  But if it</span>
        <span class="s4"># doesn't contain __metaclass__, then we must be parsing</span>
        <span class="s4"># &quot;class foo(p3d)&quot; (or whatever) from the pdef file.</span>

        <span class="s5">if </span><span class="s3">'__metaclass__' </span><span class="s5">not in </span><span class="s1">dict</span><span class="s2">:</span>
            <span class="s4"># Get the context in which this class was created</span>
            <span class="s4"># (presumably, the module scope) out of the stack frame.</span>
            <span class="s1">frame </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">_getframe</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
            <span class="s1">mdict </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">f_locals</span>
            <span class="s1">lineno </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">f_lineno</span>

            <span class="s4"># Store the class name on a statements list in that</span>
            <span class="s4"># context, so we can later resolve the class names in</span>
            <span class="s4"># the order they appeared in the file.</span>
            <span class="s1">mdict</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s3">'__statements'</span><span class="s2">, []).</span><span class="s1">append</span><span class="s2">((</span><span class="s1">lineno</span><span class="s2">, </span><span class="s3">'class'</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s5">None</span><span class="s2">, </span><span class="s5">None</span><span class="s2">))</span>

        <span class="s5">return </span><span class="s1">type</span><span class="s2">.</span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">bases</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">)</span>


<span class="s4"># Define these dynamically to stay compatible with Python 2 and 3.</span>
<span class="s1">class_p3d </span><span class="s2">= </span><span class="s1">metaclass_def</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s3">'class_p3d'</span><span class="s2">), (), {})</span>
<span class="s1">class_package </span><span class="s2">= </span><span class="s1">metaclass_def</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s3">'class_package'</span><span class="s2">), (), {})</span>
<span class="s1">class_solo </span><span class="s2">= </span><span class="s1">metaclass_def</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s3">'class_solo'</span><span class="s2">), (), {})</span>


<span class="s5">class </span><span class="s1">func_closure</span><span class="s2">:</span>
    <span class="s0">&quot;&quot;&quot; This class is used to create a closure on the function name, 
    and also allows the ``*args, **kw`` syntax.  In Python, the lambda 
    syntax, used with default parameters, is used more often to create 
    a closure (that is, a binding of one or more variables into a 
    callable object), but that syntax doesn't work with ``**kw``. 
    Fortunately, a class method is also a form of a closure, because 
    it binds self; and this doesn't have any syntax problems with 
    ``**kw``. &quot;&quot;&quot;</span>

    <span class="s5">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>

    <span class="s5">def </span><span class="s1">generic_func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
        <span class="s0">&quot;&quot;&quot; This method is bound to all the functions that might be 
        called from the pdef file.  It's a special function; when it is 
        called, it does nothing but store its name and arguments in the 
        caller's local scope, where they can be pulled out later. &quot;&quot;&quot;</span>

        <span class="s4"># Get the context in which this function was called (presumably,</span>
        <span class="s4"># the class dictionary) out of the stack frame.</span>
        <span class="s1">frame </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">_getframe</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">cldict </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">f_locals</span>
        <span class="s1">lineno </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">f_lineno</span>

        <span class="s4"># Store the function on a statements list in that context, so we</span>
        <span class="s4"># can later walk through the function calls for each class.</span>
        <span class="s1">cldict</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s3">'__statements'</span><span class="s2">, []).</span><span class="s1">append</span><span class="s2">((</span><span class="s1">lineno</span><span class="s2">, </span><span class="s3">'func'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kw</span><span class="s2">))</span>
</pre>
</body>
</html>