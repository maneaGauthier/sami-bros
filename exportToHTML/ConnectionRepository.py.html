<html>
<head>
<title>ConnectionRepository.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ConnectionRepository.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s0">import </span><span class="s2">*</span>
<span class="s0">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">direct </span><span class="s0">import </span><span class="s2">*</span>
<span class="s0">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">task </span><span class="s0">import </span><span class="s1">Task</span>
<span class="s0">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">directnotify</span><span class="s2">.</span><span class="s1">DirectNotifyGlobal </span><span class="s0">import </span><span class="s1">directNotify</span>
<span class="s0">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">distributed</span><span class="s2">.</span><span class="s1">DoInterestManager </span><span class="s0">import </span><span class="s1">DoInterestManager</span>
<span class="s0">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">distributed</span><span class="s2">.</span><span class="s1">DoCollectionManager </span><span class="s0">import </span><span class="s1">DoCollectionManager</span>
<span class="s0">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">showbase </span><span class="s0">import </span><span class="s1">GarbageReport</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">PyDatagramIterator </span><span class="s0">import </span><span class="s1">PyDatagramIterator</span>

<span class="s0">import </span><span class="s1">gc</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">&quot;ConnectionRepository&quot;</span><span class="s2">, </span><span class="s3">&quot;GCTrigger&quot;</span><span class="s2">]</span>

<span class="s0">class </span><span class="s1">ConnectionRepository</span><span class="s2">(</span>
        <span class="s1">DoInterestManager</span><span class="s2">, </span><span class="s1">DoCollectionManager</span><span class="s2">, </span><span class="s1">CConnectionRepository</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    This is a base class for things that know how to establish a 
    connection (and exchange datagrams) with a gameserver.  This 
    includes ClientRepository and AIRepository. 
    &quot;&quot;&quot;</span>
    <span class="s1">notify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s3">&quot;ConnectionRepository&quot;</span><span class="s2">)</span>
    <span class="s1">taskPriority </span><span class="s2">= -</span><span class="s5">30</span>
    <span class="s1">taskChain </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s1">CM_HTTP</span><span class="s2">=</span><span class="s5">0</span>
    <span class="s1">CM_NET</span><span class="s2">=</span><span class="s5">1</span>
    <span class="s1">CM_NATIVE</span><span class="s2">=</span><span class="s5">2</span>

    <span class="s1">gcNotify </span><span class="s2">= </span><span class="s1">directNotify</span><span class="s2">.</span><span class="s1">newCategory</span><span class="s2">(</span><span class="s3">&quot;GarbageCollect&quot;</span><span class="s2">)</span>

    <span class="s1">GarbageCollectTaskName </span><span class="s2">= </span><span class="s3">&quot;allowGarbageCollect&quot;</span>
    <span class="s1">GarbageThresholdTaskName </span><span class="s2">= </span><span class="s3">&quot;adjustGarbageCollectThreshold&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">connectMethod</span><span class="s2">, </span><span class="s1">config</span><span class="s2">, </span><span class="s1">hasOwnerView </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
                 <span class="s1">threadedNet </span><span class="s2">= </span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debugCall</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">threadedNet </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s6"># Default value.</span>
            <span class="s1">threadedNet </span><span class="s2">= </span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'threaded-net'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

        <span class="s6"># let the C connection repository know whether we're supporting</span>
        <span class="s6"># 'owner' views of distributed objects (i.e. 'receives ownrecv',</span>
        <span class="s6"># 'I own this object and have a separate view of it regardless of</span>
        <span class="s6"># where it currently is located')</span>
        <span class="s1">CConnectionRepository</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">hasOwnerView</span><span class="s2">, </span><span class="s1">threadedNet</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setWantMessageBundling</span><span class="s2">(</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'want-message-bundling'</span><span class="s2">, </span><span class="s5">1</span><span class="s2">))</span>
        <span class="s6"># DoInterestManager.__init__ relies on CConnectionRepository being</span>
        <span class="s6"># initialized</span>
        <span class="s1">DoInterestManager</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">DoCollectionManager</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setPythonRepository</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

        <span class="s6"># Create a unique ID number for each ConnectionRepository in</span>
        <span class="s6"># the world, helpful for sending messages specific to each one.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">uniqueId </span><span class="s2">= </span><span class="s1">hash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

        <span class="s6"># Accept this hook so that we can respond to lost-connection</span>
        <span class="s6"># events in the main thread, instead of within the network</span>
        <span class="s6"># thread (if there is one).</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_getLostConnectionEvent</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lostConnection</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">config </span><span class="s2">= </span><span class="s1">config</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'verbose-repository'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">setVerbose</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>

        <span class="s6"># Set this to 'http' to establish a connection to the server</span>
        <span class="s6"># using the HTTPClient interface, which ultimately uses the</span>
        <span class="s6"># OpenSSL socket library (even though SSL is not involved).</span>
        <span class="s6"># This is not as robust a socket library as NET's, but the</span>
        <span class="s6"># HTTPClient interface does a good job of negotiating the</span>
        <span class="s6"># connection over an HTTP proxy if one is in use.</span>
        <span class="s6">#</span>
        <span class="s6"># Set it to 'net' to use Panda's net interface</span>
        <span class="s6"># (e.g. QueuedConnectionManager, etc.) to establish the</span>
        <span class="s6"># connection.  This is a higher-level layer build on top of</span>
        <span class="s6"># the low-level &quot;native net&quot; library.  There is no support for</span>
        <span class="s6"># proxies.  This is a good, general choice.</span>
        <span class="s6">#</span>
        <span class="s6"># Set it to 'native' to use Panda's low-level native net</span>
        <span class="s6"># interface directly.  This is much faster than either http or</span>
        <span class="s6"># net for high-bandwidth (e.g. server) applications, but it</span>
        <span class="s6"># doesn't support the simulated delay via the start_delay()</span>
        <span class="s6"># call.</span>
        <span class="s6">#</span>
        <span class="s6"># Set it to 'default' to use an appropriate interface</span>
        <span class="s6"># according to the type of ConnectionRepository we are</span>
        <span class="s6"># creating.</span>
        <span class="s1">userConnectMethod </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetString</span><span class="s2">(</span><span class="s3">'connect-method'</span><span class="s2">, </span><span class="s3">'default'</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">userConnectMethod </span><span class="s2">== </span><span class="s3">'http'</span><span class="s2">:</span>
            <span class="s1">connectMethod </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">CM_HTTP</span>
        <span class="s0">elif </span><span class="s1">userConnectMethod </span><span class="s2">== </span><span class="s3">'net'</span><span class="s2">:</span>
            <span class="s1">connectMethod </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">CM_NET</span>
        <span class="s0">elif </span><span class="s1">userConnectMethod </span><span class="s2">== </span><span class="s3">'native'</span><span class="s2">:</span>
            <span class="s1">connectMethod </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">CM_NATIVE</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">connectMethod </span><span class="s2">= </span><span class="s1">connectMethod</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">connectMethod </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">CM_HTTP</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Using connect method 'http'&quot;</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">connectMethod </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">CM_NET</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Using connect method 'net'&quot;</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">connectMethod </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">CM_NATIVE</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Using connect method 'native'&quot;</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">connectHttp </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">http </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s6"># This DatagramIterator is constructed once, and then re-used</span>
        <span class="s6"># each time we read a datagram.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">private__di </span><span class="s2">= </span><span class="s1">PyDatagramIterator</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">recorder </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">readerPollTaskObj </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s6"># This is the string that is appended to symbols read from the</span>
        <span class="s6"># DC file.  The AIRepository will redefine this to 'AI'.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dcSuffix </span><span class="s2">= </span><span class="s3">''</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_serverAddress </span><span class="s2">= </span><span class="s3">''</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'gc-save-all'</span><span class="s2">, </span><span class="s5">1</span><span class="s2">):</span>
            <span class="s6"># set gc to preserve every object involved in a cycle, even ones that</span>
            <span class="s6"># would normally be freed automatically during garbage collect</span>
            <span class="s6"># allows us to find and fix these cycles, reducing or eliminating the</span>
            <span class="s6"># need to run garbage collects</span>
            <span class="s6"># garbage collection CPU usage is O(n), n = number of Python objects</span>
            <span class="s1">gc</span><span class="s2">.</span><span class="s1">set_debug</span><span class="s2">(</span><span class="s1">gc</span><span class="s2">.</span><span class="s1">DEBUG_SAVEALL</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetBool</span><span class="s2">(</span><span class="s3">'want-garbage-collect-task'</span><span class="s2">, </span><span class="s5">1</span><span class="s2">):</span>
            <span class="s6"># manual garbage-collect task</span>
            <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_garbageCollect</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">GarbageCollectTaskName</span><span class="s2">, </span><span class="s5">200</span><span class="s2">)</span>
            <span class="s6"># periodically increase gc threshold if there is no garbage</span>
            <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">doMethodLater</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">GetFloat</span><span class="s2">(</span><span class="s3">'garbage-threshold-adjust-delay'</span><span class="s2">, </span><span class="s5">5 </span><span class="s2">* </span><span class="s5">60.</span><span class="s2">),</span>
                                  <span class="s1">self</span><span class="s2">.</span><span class="s1">_adjustGcThreshold</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">GarbageThresholdTaskName</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_gcDefaultThreshold </span><span class="s2">= </span><span class="s1">gc</span><span class="s2">.</span><span class="s1">get_threshold</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_getLostConnectionEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">uniqueName</span><span class="s2">(</span><span class="s3">'lostConnection'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_garbageCollect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">task</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6"># allow a collect</span>
        <span class="s6"># enable automatic garbage collection</span>
        <span class="s1">gc</span><span class="s2">.</span><span class="s1">enable</span><span class="s2">()</span>
        <span class="s6"># creating an object with gc enabled causes garbage collection to trigger if appropriate</span>
        <span class="s1">gct </span><span class="s2">= </span><span class="s1">GCTrigger</span><span class="s2">()</span>
        <span class="s6"># disable the automatic garbage collect during the rest of the frame</span>
        <span class="s1">gc</span><span class="s2">.</span><span class="s1">disable</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>

    <span class="s0">def </span><span class="s1">_adjustGcThreshold</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">task</span><span class="s2">):</span>
        <span class="s6"># do an unconditional collect to make sure gc.garbage has a chance to be</span>
        <span class="s6"># populated before we start increasing the auto-collect threshold</span>
        <span class="s6"># don't distribute the leak check from the client to the AI, they both</span>
        <span class="s6"># do these garbage checks independently over time</span>
        <span class="s1">numGarbage </span><span class="s2">= </span><span class="s1">GarbageReport</span><span class="s2">.</span><span class="s1">checkForGarbageLeaks</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">numGarbage </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">gcNotify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">'no garbage found, doubling gc threshold'</span><span class="s2">)</span>
            <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c </span><span class="s2">= </span><span class="s1">gc</span><span class="s2">.</span><span class="s1">get_threshold</span><span class="s2">()</span>
            <span class="s1">gc</span><span class="s2">.</span><span class="s1">set_threshold</span><span class="s2">(</span><span class="s1">min</span><span class="s2">(</span><span class="s1">a </span><span class="s2">* </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1 </span><span class="s2">&lt;&lt; </span><span class="s5">30</span><span class="s2">), </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>

            <span class="s1">task</span><span class="s2">.</span><span class="s1">delayTime </span><span class="s2">= </span><span class="s1">task</span><span class="s2">.</span><span class="s1">delayTime </span><span class="s2">* </span><span class="s5">2</span>
            <span class="s1">retVal </span><span class="s2">= </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">again</span>

        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">gcNotify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">'garbage found, reverting gc threshold'</span><span class="s2">)</span>
            <span class="s6"># the process is producing garbage, stick to the default collection threshold</span>
            <span class="s1">gc</span><span class="s2">.</span><span class="s1">set_threshold</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_gcDefaultThreshold</span><span class="s2">)</span>
            <span class="s1">retVal </span><span class="s2">= </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">done</span>

        <span class="s0">return </span><span class="s1">retVal</span>

    <span class="s0">def </span><span class="s1">generateGlobalObject</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">doId</span><span class="s2">, </span><span class="s1">dcname</span><span class="s2">, </span><span class="s1">values</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">applyFieldValues</span><span class="s2">(</span><span class="s1">distObj</span><span class="s2">, </span><span class="s1">dclass</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">dclass</span><span class="s2">.</span><span class="s1">getNumInheritedFields</span><span class="s2">()):</span>
                <span class="s1">field </span><span class="s2">= </span><span class="s1">dclass</span><span class="s2">.</span><span class="s1">getInheritedField</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">field</span><span class="s2">.</span><span class="s1">asMolecularField</span><span class="s2">() == </span><span class="s0">None</span><span class="s2">:</span>
                    <span class="s1">value </span><span class="s2">= </span><span class="s1">values</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">(), </span><span class="s0">None</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">value </span><span class="s0">is None and </span><span class="s1">field</span><span class="s2">.</span><span class="s1">isRequired</span><span class="s2">():</span>
                        <span class="s6"># Gee, this could be better.  What would really be</span>
                        <span class="s6"># nicer is to get value from field.getDefaultValue</span>
                        <span class="s6"># or similar, but that returns a binary string, not</span>
                        <span class="s6"># a python tuple, like the following does.  If you</span>
                        <span class="s6"># want to change something better, please go ahead.</span>
                        <span class="s1">packer </span><span class="s2">= </span><span class="s1">DCPacker</span><span class="s2">()</span>
                        <span class="s1">packer</span><span class="s2">.</span><span class="s1">beginPack</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)</span>
                        <span class="s1">packer</span><span class="s2">.</span><span class="s1">packDefaultValue</span><span class="s2">()</span>
                        <span class="s1">packer</span><span class="s2">.</span><span class="s1">endPack</span><span class="s2">()</span>

                        <span class="s1">unpacker </span><span class="s2">= </span><span class="s1">DCPacker</span><span class="s2">()</span>
                        <span class="s1">unpacker</span><span class="s2">.</span><span class="s1">setUnpackData</span><span class="s2">(</span><span class="s1">packer</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">())</span>
                        <span class="s1">unpacker</span><span class="s2">.</span><span class="s1">beginUnpack</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)</span>
                        <span class="s1">value </span><span class="s2">= </span><span class="s1">unpacker</span><span class="s2">.</span><span class="s1">unpackObject</span><span class="s2">()</span>
                        <span class="s1">unpacker</span><span class="s2">.</span><span class="s1">endUnpack</span><span class="s2">()</span>
                    <span class="s0">if </span><span class="s1">value </span><span class="s0">is not None</span><span class="s2">:</span>
                        <span class="s1">function </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">distObj</span><span class="s2">, </span><span class="s1">field</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">())</span>
                        <span class="s0">if </span><span class="s1">function </span><span class="s0">is not None</span><span class="s2">:</span>
                            <span class="s1">function</span><span class="s2">(*</span><span class="s1">value</span><span class="s2">)</span>
                        <span class="s0">else</span><span class="s2">:</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n\n\n</span><span class="s3">Not able to find %s.%s&quot;</span><span class="s2">%(</span>
                                <span class="s1">distObj</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s1">field</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">()))</span>

        <span class="s6"># Look up the dclass</span>
        <span class="s1">dclass </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dclassesByName</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">dcname</span><span class="s2">+</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dcSuffix</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">dclass </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s6">#print &quot;\n\n\nNeed to define&quot;, dcname+self.dcSuffix</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Need to define %s&quot; </span><span class="s2">% (</span><span class="s1">dcname</span><span class="s2">+</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dcSuffix</span><span class="s2">))</span>
            <span class="s1">dclass </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dclassesByName</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">dcname</span><span class="s2">+</span><span class="s3">'AI'</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">dclass </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">dclass </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dclassesByName</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">dcname</span><span class="s2">)</span>
        <span class="s6"># Create a new distributed object, and put it in the dictionary</span>
        <span class="s6">#distObj = self.generateWithRequiredFields(dclass, doId, di)</span>

        <span class="s6"># Construct a new one</span>
        <span class="s1">classDef </span><span class="s2">= </span><span class="s1">dclass</span><span class="s2">.</span><span class="s1">getClassDef</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">classDef </span><span class="s2">== </span><span class="s0">None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Could not create an undefined %s object.&quot;</span><span class="s2">%(</span>
                <span class="s1">dclass</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">()))</span>
        <span class="s1">distObj </span><span class="s2">= </span><span class="s1">classDef</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">distObj</span><span class="s2">.</span><span class="s1">dclass </span><span class="s2">= </span><span class="s1">dclass</span>
        <span class="s6"># Assign it an Id</span>
        <span class="s1">distObj</span><span class="s2">.</span><span class="s1">doId </span><span class="s2">= </span><span class="s1">doId</span>
        <span class="s6"># Put the new do in the dictionary</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">doId2do</span><span class="s2">[</span><span class="s1">doId</span><span class="s2">] = </span><span class="s1">distObj</span>
        <span class="s6"># Update the required fields</span>
        <span class="s1">distObj</span><span class="s2">.</span><span class="s1">generateInit</span><span class="s2">()  </span><span class="s6"># Only called when constructed</span>
        <span class="s1">distObj</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">values </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">applyFieldValues</span><span class="s2">(</span><span class="s1">distObj</span><span class="s2">, </span><span class="s1">dclass</span><span class="s2">, </span><span class="s1">values</span><span class="s2">)</span>
        <span class="s1">distObj</span><span class="s2">.</span><span class="s1">announceGenerate</span><span class="s2">()</span>
        <span class="s1">distObj</span><span class="s2">.</span><span class="s1">parentId </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">distObj</span><span class="s2">.</span><span class="s1">zoneId </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s6"># updateRequiredFields calls announceGenerate</span>
        <span class="s0">return  </span><span class="s1">distObj</span>

    <span class="s0">def </span><span class="s1">readDCFile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dcFileNames </span><span class="s2">= </span><span class="s0">None</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Reads in the dc files listed in dcFileNames, or if 
        dcFileNames is None, reads in all of the dc files listed in 
        the Config.prc file. 
        &quot;&quot;&quot;</span>

        <span class="s1">dcFile </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getDcFile</span><span class="s2">()</span>
        <span class="s1">dcFile</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dclassesByName </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dclassesByNumber </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">hashVal </span><span class="s2">= </span><span class="s5">0</span>

        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">dcFileNames</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s6"># If we were given a single string, make it a list.</span>
            <span class="s1">dcFileNames </span><span class="s2">= [</span><span class="s1">dcFileNames</span><span class="s2">]</span>

        <span class="s1">dcImports </span><span class="s2">= {}</span>
        <span class="s0">if </span><span class="s1">dcFileNames </span><span class="s2">== </span><span class="s0">None</span><span class="s2">:</span>
            <span class="s1">readResult </span><span class="s2">= </span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">readAll</span><span class="s2">()</span>
            <span class="s0">if not </span><span class="s1">readResult</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Could not read dc file.&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">searchPath </span><span class="s2">= </span><span class="s1">getModelPath</span><span class="s2">().</span><span class="s1">getValue</span><span class="s2">()</span>
            <span class="s0">for </span><span class="s1">dcFileName </span><span class="s0">in </span><span class="s1">dcFileNames</span><span class="s2">:</span>
                <span class="s1">pathname </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">dcFileName</span><span class="s2">)</span>
                <span class="s1">vfs </span><span class="s2">= </span><span class="s1">VirtualFileSystem</span><span class="s2">.</span><span class="s1">getGlobalPtr</span><span class="s2">()</span>
                <span class="s1">vfs</span><span class="s2">.</span><span class="s1">resolveFilename</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">, </span><span class="s1">searchPath</span><span class="s2">)</span>
                <span class="s1">readResult </span><span class="s2">= </span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">pathname</span><span class="s2">)</span>
                <span class="s0">if not </span><span class="s1">readResult</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Could not read dc file: %s&quot; </span><span class="s2">% (</span><span class="s1">pathname</span><span class="s2">))</span>

        <span class="s6">#if not dcFile.allObjectsValid():</span>
        <span class="s6">#    names = []</span>
        <span class="s6">#    for i in range(dcFile.getNumTypedefs()):</span>
        <span class="s6">#        td = dcFile.getTypedef(i)</span>
        <span class="s6">#        if td.isBogusTypedef():</span>
        <span class="s6">#            names.append(td.getName())</span>
        <span class="s6">#    nameList = ', '.join(names)</span>
        <span class="s6">#    self.notify.error(&quot;Undefined types in DC file: &quot; + nameList)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">hashVal </span><span class="s2">= </span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getHash</span><span class="s2">()</span>

        <span class="s6"># Now import all of the modules required by the DC file.</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getNumImportModules</span><span class="s2">()):</span>
            <span class="s1">moduleName </span><span class="s2">= </span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getImportModule</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)[:]</span>

            <span class="s6"># Maybe the module name is represented as &quot;moduleName/AI&quot;.</span>
            <span class="s1">suffix </span><span class="s2">= </span><span class="s1">moduleName</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">)</span>
            <span class="s1">moduleName </span><span class="s2">= </span><span class="s1">suffix</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
            <span class="s1">suffix</span><span class="s2">=</span><span class="s1">suffix</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:]</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dcSuffix </span><span class="s0">in </span><span class="s1">suffix</span><span class="s2">:</span>
                <span class="s1">moduleName </span><span class="s2">+= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dcSuffix</span>
            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dcSuffix </span><span class="s2">== </span><span class="s3">'UD' </span><span class="s0">and </span><span class="s3">'AI' </span><span class="s0">in </span><span class="s1">suffix</span><span class="s2">: </span><span class="s6">#HACK:</span>
                <span class="s1">moduleName </span><span class="s2">+= </span><span class="s3">'AI'</span>

            <span class="s1">importSymbols </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getNumImportSymbols</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)):</span>
                <span class="s1">symbolName </span><span class="s2">= </span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getImportSymbol</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>

                <span class="s6"># Maybe the symbol name is represented as &quot;symbolName/AI&quot;.</span>
                <span class="s1">suffix </span><span class="s2">= </span><span class="s1">symbolName</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">)</span>
                <span class="s1">symbolName </span><span class="s2">= </span><span class="s1">suffix</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
                <span class="s1">suffix</span><span class="s2">=</span><span class="s1">suffix</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:]</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dcSuffix </span><span class="s0">in </span><span class="s1">suffix</span><span class="s2">:</span>
                    <span class="s1">symbolName </span><span class="s2">+= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dcSuffix</span>
                <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dcSuffix </span><span class="s2">== </span><span class="s3">'UD' </span><span class="s0">and </span><span class="s3">'AI' </span><span class="s0">in </span><span class="s1">suffix</span><span class="s2">: </span><span class="s6">#HACK:</span>
                    <span class="s1">symbolName </span><span class="s2">+= </span><span class="s3">'AI'</span>

                <span class="s1">importSymbols</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">symbolName</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">importModule</span><span class="s2">(</span><span class="s1">dcImports</span><span class="s2">, </span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">importSymbols</span><span class="s2">)</span>

        <span class="s6"># Now get the class definition for the classes named in the DC</span>
        <span class="s6"># file.</span>
        <span class="s0">import </span><span class="s1">inspect</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getNumClasses</span><span class="s2">()):</span>
            <span class="s1">dclass </span><span class="s2">= </span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getClass</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
            <span class="s1">number </span><span class="s2">= </span><span class="s1">dclass</span><span class="s2">.</span><span class="s1">getNumber</span><span class="s2">()</span>
            <span class="s1">className </span><span class="s2">= </span><span class="s1">dclass</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">() + </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dcSuffix</span>

            <span class="s6"># Does the class have a definition defined in the newly</span>
            <span class="s6"># imported namespace?</span>
            <span class="s1">classDef </span><span class="s2">= </span><span class="s1">dcImports</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">className</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">classDef </span><span class="s0">is None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dcSuffix </span><span class="s2">== </span><span class="s3">'UD'</span><span class="s2">: </span><span class="s6">#HACK:</span>
                <span class="s1">className </span><span class="s2">= </span><span class="s1">dclass</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">() + </span><span class="s3">'AI'</span>
                <span class="s1">classDef </span><span class="s2">= </span><span class="s1">dcImports</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">className</span><span class="s2">)</span>

            <span class="s6"># Also try it without the dcSuffix.</span>
            <span class="s0">if </span><span class="s1">classDef </span><span class="s2">== </span><span class="s0">None</span><span class="s2">:</span>
                <span class="s1">className </span><span class="s2">= </span><span class="s1">dclass</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">()</span>
                <span class="s1">classDef </span><span class="s2">= </span><span class="s1">dcImports</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">className</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">classDef </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">&quot;No class definition for %s.&quot; </span><span class="s2">% (</span><span class="s1">className</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">inspect</span><span class="s2">.</span><span class="s1">ismodule</span><span class="s2">(</span><span class="s1">classDef</span><span class="s2">):</span>
                    <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">classDef</span><span class="s2">, </span><span class="s1">className</span><span class="s2">):</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Module %s does not define class %s.&quot; </span><span class="s2">% (</span><span class="s1">className</span><span class="s2">, </span><span class="s1">className</span><span class="s2">))</span>
                        <span class="s0">continue</span>
                    <span class="s1">classDef </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">classDef</span><span class="s2">, </span><span class="s1">className</span><span class="s2">)</span>

                <span class="s0">if not </span><span class="s1">inspect</span><span class="s2">.</span><span class="s1">isclass</span><span class="s2">(</span><span class="s1">classDef</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Symbol %s is not a class name.&quot; </span><span class="s2">% (</span><span class="s1">className</span><span class="s2">))</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">dclass</span><span class="s2">.</span><span class="s1">setClassDef</span><span class="s2">(</span><span class="s1">classDef</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">dclassesByName</span><span class="s2">[</span><span class="s1">className</span><span class="s2">] = </span><span class="s1">dclass</span>
            <span class="s0">if </span><span class="s1">number </span><span class="s2">&gt;= </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">dclassesByNumber</span><span class="s2">[</span><span class="s1">number</span><span class="s2">] = </span><span class="s1">dclass</span>

        <span class="s6"># Owner Views</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hasOwnerView</span><span class="s2">():</span>
            <span class="s1">ownerDcSuffix </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dcSuffix </span><span class="s2">+ </span><span class="s3">'OV'</span>
            <span class="s6"># dict of class names (without 'OV') that have owner views</span>
            <span class="s1">ownerImportSymbols </span><span class="s2">= {}</span>

            <span class="s6"># Now import all of the modules required by the DC file.</span>
            <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getNumImportModules</span><span class="s2">()):</span>
                <span class="s1">moduleName </span><span class="s2">= </span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getImportModule</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>

                <span class="s6"># Maybe the module name is represented as &quot;moduleName/AI&quot;.</span>
                <span class="s1">suffix </span><span class="s2">= </span><span class="s1">moduleName</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">)</span>
                <span class="s1">moduleName </span><span class="s2">= </span><span class="s1">suffix</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
                <span class="s1">suffix</span><span class="s2">=</span><span class="s1">suffix</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:]</span>
                <span class="s0">if </span><span class="s1">ownerDcSuffix </span><span class="s0">in </span><span class="s1">suffix</span><span class="s2">:</span>
                    <span class="s1">moduleName </span><span class="s2">= </span><span class="s1">moduleName </span><span class="s2">+ </span><span class="s1">ownerDcSuffix</span>

                <span class="s1">importSymbols </span><span class="s2">= []</span>
                <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getNumImportSymbols</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)):</span>
                    <span class="s1">symbolName </span><span class="s2">= </span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getImportSymbol</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>

                    <span class="s6"># Check for the OV suffix</span>
                    <span class="s1">suffix </span><span class="s2">= </span><span class="s1">symbolName</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">)</span>
                    <span class="s1">symbolName </span><span class="s2">= </span><span class="s1">suffix</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
                    <span class="s1">suffix</span><span class="s2">=</span><span class="s1">suffix</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:]</span>
                    <span class="s0">if </span><span class="s1">ownerDcSuffix </span><span class="s0">in </span><span class="s1">suffix</span><span class="s2">:</span>
                        <span class="s1">symbolName </span><span class="s2">+= </span><span class="s1">ownerDcSuffix</span>
                    <span class="s1">importSymbols</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">symbolName</span><span class="s2">)</span>
                    <span class="s1">ownerImportSymbols</span><span class="s2">[</span><span class="s1">symbolName</span><span class="s2">] = </span><span class="s0">None</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">importModule</span><span class="s2">(</span><span class="s1">dcImports</span><span class="s2">, </span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">importSymbols</span><span class="s2">)</span>

            <span class="s6"># Now get the class definition for the owner classes named</span>
            <span class="s6"># in the DC file.</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getNumClasses</span><span class="s2">()):</span>
                <span class="s1">dclass </span><span class="s2">= </span><span class="s1">dcFile</span><span class="s2">.</span><span class="s1">getClass</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s2">((</span><span class="s1">dclass</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">()+</span><span class="s1">ownerDcSuffix</span><span class="s2">) </span><span class="s0">in </span><span class="s1">ownerImportSymbols</span><span class="s2">):</span>
                    <span class="s1">number </span><span class="s2">= </span><span class="s1">dclass</span><span class="s2">.</span><span class="s1">getNumber</span><span class="s2">()</span>
                    <span class="s1">className </span><span class="s2">= </span><span class="s1">dclass</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">() + </span><span class="s1">ownerDcSuffix</span>

                    <span class="s6"># Does the class have a definition defined in the newly</span>
                    <span class="s6"># imported namespace?</span>
                    <span class="s1">classDef </span><span class="s2">= </span><span class="s1">dcImports</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">className</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">classDef </span><span class="s0">is None</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;No class definition for %s.&quot; </span><span class="s2">% </span><span class="s1">className</span><span class="s2">)</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s0">if </span><span class="s1">inspect</span><span class="s2">.</span><span class="s1">ismodule</span><span class="s2">(</span><span class="s1">classDef</span><span class="s2">):</span>
                            <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">classDef</span><span class="s2">, </span><span class="s1">className</span><span class="s2">):</span>
                                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Module %s does not define class %s.&quot; </span><span class="s2">% (</span><span class="s1">className</span><span class="s2">, </span><span class="s1">className</span><span class="s2">))</span>
                            <span class="s1">classDef </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">classDef</span><span class="s2">, </span><span class="s1">className</span><span class="s2">)</span>
                        <span class="s1">dclass</span><span class="s2">.</span><span class="s1">setOwnerClassDef</span><span class="s2">(</span><span class="s1">classDef</span><span class="s2">)</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">dclassesByName</span><span class="s2">[</span><span class="s1">className</span><span class="s2">] = </span><span class="s1">dclass</span>

    <span class="s0">def </span><span class="s1">importModule</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dcImports</span><span class="s2">, </span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">importSymbols</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Imports the indicated moduleName and all of its symbols 
        into the current namespace.  This more-or-less reimplements 
        the Python import command. 
        &quot;&quot;&quot;</span>
        <span class="s1">module </span><span class="s2">= </span><span class="s1">__import__</span><span class="s2">(</span><span class="s1">moduleName</span><span class="s2">, </span><span class="s1">globals</span><span class="s2">(), </span><span class="s1">locals</span><span class="s2">(), </span><span class="s1">importSymbols</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">importSymbols</span><span class="s2">:</span>
            <span class="s6"># &quot;from moduleName import symbolName, symbolName, ...&quot;</span>
            <span class="s6"># Copy just the named symbols into the dictionary.</span>
            <span class="s0">if </span><span class="s1">importSymbols </span><span class="s2">== [</span><span class="s3">'*'</span><span class="s2">]:</span>
                <span class="s6"># &quot;from moduleName import *&quot;</span>
                <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">module</span><span class="s2">, </span><span class="s3">&quot;__all__&quot;</span><span class="s2">):</span>
                    <span class="s1">importSymbols </span><span class="s2">= </span><span class="s1">module</span><span class="s2">.</span><span class="s1">__all__</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">importSymbols </span><span class="s2">= </span><span class="s1">module</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()</span>

            <span class="s0">for </span><span class="s1">symbolName </span><span class="s0">in </span><span class="s1">importSymbols</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">module</span><span class="s2">, </span><span class="s1">symbolName</span><span class="s2">):</span>
                    <span class="s1">dcImports</span><span class="s2">[</span><span class="s1">symbolName</span><span class="s2">] = </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">module</span><span class="s2">, </span><span class="s1">symbolName</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">'Symbol %s not defined in module %s.' </span><span class="s2">% (</span><span class="s1">symbolName</span><span class="s2">, </span><span class="s1">moduleName</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s6"># &quot;import moduleName&quot;</span>

            <span class="s6"># Copy the root module name into the dictionary.</span>

            <span class="s6"># Follow the dotted chain down to the actual module.</span>
            <span class="s1">components </span><span class="s2">= </span><span class="s1">moduleName</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">)</span>
            <span class="s1">dcImports</span><span class="s2">[</span><span class="s1">components</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]] = </span><span class="s1">module</span>

    <span class="s0">def </span><span class="s1">getServerAddress</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_serverAddress</span>

    <span class="s0">def </span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">serverList</span><span class="s2">,</span>
                <span class="s1">successCallback </span><span class="s2">= </span><span class="s0">None</span><span class="s2">, </span><span class="s1">successArgs </span><span class="s2">= [],</span>
                <span class="s1">failureCallback </span><span class="s2">= </span><span class="s0">None</span><span class="s2">, </span><span class="s1">failureArgs </span><span class="s2">= []):</span>
        <span class="s4">&quot;&quot;&quot; 
        Attempts to establish a connection to the server.  May return 
        before the connection is established.  The two callbacks 
        represent the two functions to call (and their arguments) on 
        success or failure, respectively.  The failure callback also 
        gets one additional parameter, which will be passed in first: 
        the return status code giving reason for failure, if it is 
        known. 
        &quot;&quot;&quot;</span>

        <span class="s6">## if self.recorder and self.recorder.isPlaying():</span>

        <span class="s6">##     # If we have a recorder and it's already in playback mode,</span>
        <span class="s6">##     # don't actually attempt to connect to a gameserver since</span>
        <span class="s6">##     # we don't need to.  Just let it play back the data.</span>
        <span class="s6">##     self.notify.info(&quot;Not connecting to gameserver; using playback data instead.&quot;)</span>

        <span class="s6">##     self.connectHttp = 1</span>
        <span class="s6">##     self.tcpConn = SocketStreamRecorder()</span>
        <span class="s6">##     self.recorder.addRecorder('gameserver', self.tcpConn)</span>

        <span class="s6">##     self.startReaderPollTask()</span>
        <span class="s6">##     if successCallback:</span>
        <span class="s6">##         successCallback(*successArgs)</span>
        <span class="s6">##     return</span>

        <span class="s1">hasProxy </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">checkHttp</span><span class="s2">():</span>
            <span class="s1">proxies </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">.</span><span class="s1">getProxiesForUrl</span><span class="s2">(</span><span class="s1">serverList</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
            <span class="s1">hasProxy </span><span class="s2">= (</span><span class="s1">proxies </span><span class="s2">!= </span><span class="s3">'DIRECT'</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">hasProxy</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Connecting to gameserver via proxy list: %s&quot; </span><span class="s2">% (</span><span class="s1">proxies</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Connecting to gameserver directly (no proxy).&quot;</span><span class="s2">)</span>

        <span class="s6">#Redefine the connection to http or net in the default case</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">bootedIndex </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bootedText </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">connectMethod </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">CM_HTTP</span><span class="s2">:</span>
            <span class="s6"># In the HTTP case, we can't just iterate through the list</span>
            <span class="s6"># of servers, because each server attempt requires</span>
            <span class="s6"># spawning a request and then coming back later to check</span>
            <span class="s6"># the success or failure.  Instead, we start the ball</span>
            <span class="s6"># rolling by calling the connect callback, which will call</span>
            <span class="s6"># itself repeatedly until we establish a connection (or</span>
            <span class="s6"># run out of servers).</span>

            <span class="s1">ch </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span><span class="s2">.</span><span class="s1">makeChannel</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">httpConnectCallback</span><span class="s2">(</span>
                    <span class="s1">ch</span><span class="s2">, </span><span class="s1">serverList</span><span class="s2">, </span><span class="s5">0</span><span class="s2">,</span>
                    <span class="s1">successCallback</span><span class="s2">, </span><span class="s1">successArgs</span><span class="s2">,</span>
                    <span class="s1">failureCallback</span><span class="s2">, </span><span class="s1">failureArgs</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">connectMethod </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">CM_NET </span><span class="s0">or </span><span class="s2">(</span><span class="s0">not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">,</span><span class="s3">&quot;connectNative&quot;</span><span class="s2">)):</span>
            <span class="s6"># Try each of the servers in turn.</span>
            <span class="s0">for </span><span class="s1">url </span><span class="s0">in </span><span class="s1">serverList</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Connecting to %s via NET interface.&quot; </span><span class="s2">% (</span><span class="s1">url</span><span class="s2">))</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tryConnectNet</span><span class="s2">(</span><span class="s1">url</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">startReaderPollTask</span><span class="s2">()</span>
                    <span class="s0">if </span><span class="s1">successCallback</span><span class="s2">:</span>
                        <span class="s1">successCallback</span><span class="s2">(*</span><span class="s1">successArgs</span><span class="s2">)</span>
                    <span class="s0">return</span>

            <span class="s6"># Failed to connect.</span>
            <span class="s0">if </span><span class="s1">failureCallback</span><span class="s2">:</span>
                <span class="s1">failureCallback</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s3">''</span><span class="s2">, *</span><span class="s1">failureArgs</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">connectMethod </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">CM_NATIVE</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">url </span><span class="s0">in </span><span class="s1">serverList</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Connecting to %s via Native interface.&quot; </span><span class="s2">% (</span><span class="s1">url</span><span class="s2">))</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">connectNative</span><span class="s2">(</span><span class="s1">url</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">startReaderPollTask</span><span class="s2">()</span>
                    <span class="s0">if </span><span class="s1">successCallback</span><span class="s2">:</span>
                        <span class="s1">successCallback</span><span class="s2">(*</span><span class="s1">successArgs</span><span class="s2">)</span>
                    <span class="s0">return</span>

            <span class="s6"># Failed to connect.</span>
            <span class="s0">if </span><span class="s1">failureCallback</span><span class="s2">:</span>
                <span class="s1">failureCallback</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s3">''</span><span class="s2">, *</span><span class="s1">failureArgs</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;uh oh, we aren't using one of the tri-state CM variables&quot;</span><span class="s2">)</span>
            <span class="s1">failureCallback</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s3">''</span><span class="s2">, *</span><span class="s1">failureArgs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">disconnect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Closes the previously-established connection. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Closing connection to server.&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_serverAddress </span><span class="s2">= </span><span class="s3">''</span>
        <span class="s1">CConnectionRepository</span><span class="s2">.</span><span class="s1">disconnect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">stopReaderPollTask</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">shutdown</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreAll</span><span class="s2">()</span>
        <span class="s1">CConnectionRepository</span><span class="s2">.</span><span class="s1">shutdown</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">httpConnectCallback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ch</span><span class="s2">, </span><span class="s1">serverList</span><span class="s2">, </span><span class="s1">serverIndex</span><span class="s2">,</span>
                            <span class="s1">successCallback</span><span class="s2">, </span><span class="s1">successArgs</span><span class="s2">,</span>
                            <span class="s1">failureCallback</span><span class="s2">, </span><span class="s1">failureArgs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">ch</span><span class="s2">.</span><span class="s1">isConnectionReady</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">setConnectionHttp</span><span class="s2">(</span><span class="s1">ch</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_serverAddress </span><span class="s2">= </span><span class="s1">serverList</span><span class="s2">[</span><span class="s1">serverIndex</span><span class="s2">-</span><span class="s5">1</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Successfully connected to %s.&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_serverAddress</span><span class="s2">))</span>

            <span class="s6">## if self.recorder:</span>
            <span class="s6">##     # If we have a recorder, we wrap the connect inside a</span>
            <span class="s6">##     # SocketStreamRecorder, which will trap incoming data</span>
            <span class="s6">##     # when the recorder is set to record mode.  (It will</span>
            <span class="s6">##     # also play back data when the recorder is in playback</span>
            <span class="s6">##     # mode, but in that case we never get this far in the</span>
            <span class="s6">##     # code, since we just create an empty</span>
            <span class="s6">##     # SocketStreamRecorder without actually connecting to</span>
            <span class="s6">##     # the gameserver.)</span>
            <span class="s6">##     stream = SocketStreamRecorder(self.tcpConn, 1)</span>
            <span class="s6">##     self.recorder.addRecorder('gameserver', stream)</span>

            <span class="s6">##     # In this case, we pass ownership of the original</span>
            <span class="s6">##     # connection to the SocketStreamRecorder object.</span>
            <span class="s6">##     self.tcpConn.userManagesMemory = 0</span>
            <span class="s6">##     self.tcpConn = stream</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">startReaderPollTask</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">successCallback</span><span class="s2">:</span>
                <span class="s1">successCallback</span><span class="s2">(*</span><span class="s1">successArgs</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">serverIndex </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">serverList</span><span class="s2">):</span>
            <span class="s6"># No connection yet, but keep trying.</span>

            <span class="s1">url </span><span class="s2">= </span><span class="s1">serverList</span><span class="s2">[</span><span class="s1">serverIndex</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Connecting to %s via HTTP interface.&quot; </span><span class="s2">% (</span><span class="s1">url</span><span class="s2">))</span>
            <span class="s1">ch</span><span class="s2">.</span><span class="s1">preserveStatus</span><span class="s2">()</span>

            <span class="s1">ch</span><span class="s2">.</span><span class="s1">beginConnectTo</span><span class="s2">(</span><span class="s1">DocumentSpec</span><span class="s2">(</span><span class="s1">url</span><span class="s2">))</span>
            <span class="s1">ch</span><span class="s2">.</span><span class="s1">spawnTask</span><span class="s2">(</span><span class="s1">name </span><span class="s2">= </span><span class="s3">'connect-to-server'</span><span class="s2">,</span>
                         <span class="s1">callback </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">httpConnectCallback</span><span class="s2">,</span>
                         <span class="s1">extraArgs </span><span class="s2">= [</span><span class="s1">ch</span><span class="s2">, </span><span class="s1">serverList</span><span class="s2">, </span><span class="s1">serverIndex </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">,</span>
                                      <span class="s1">successCallback</span><span class="s2">, </span><span class="s1">successArgs</span><span class="s2">,</span>
                                      <span class="s1">failureCallback</span><span class="s2">, </span><span class="s1">failureArgs</span><span class="s2">])</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s6"># No more servers to try; we have to give up now.</span>
            <span class="s0">if </span><span class="s1">failureCallback</span><span class="s2">:</span>
                <span class="s1">failureCallback</span><span class="s2">(</span><span class="s1">ch</span><span class="s2">.</span><span class="s1">getStatusCode</span><span class="s2">(), </span><span class="s1">ch</span><span class="s2">.</span><span class="s1">getStatusString</span><span class="s2">(),</span>
                                <span class="s2">*</span><span class="s1">failureArgs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">checkHttp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Creates an HTTPClient, if possible, if we don't have one</span>
        <span class="s6"># already.  This might fail if the OpenSSL library isn't</span>
        <span class="s6"># available.  Returns the HTTPClient (also self.http), or None</span>
        <span class="s6"># if not set.</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">http </span><span class="s2">== </span><span class="s0">None</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">http </span><span class="s2">= </span><span class="s1">HTTPClient</span><span class="s2">()</span>
            <span class="s0">except</span><span class="s2">:</span>
                <span class="s0">pass</span>

        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">http</span>

    <span class="s0">def </span><span class="s1">startReaderPollTask</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Stop any tasks we are running now</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">stopReaderPollTask</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">(</span><span class="s1">CConnectionRepository</span><span class="s2">.</span><span class="s1">getOverflowEventName</span><span class="s2">(),</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">handleReaderOverflow</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">readerPollTaskObj </span><span class="s2">= </span><span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">readerPollUntilEmpty</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">uniqueName</span><span class="s2">(</span><span class="s3">&quot;readerPollTask&quot;</span><span class="s2">),</span>
            <span class="s1">priority </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">taskPriority</span><span class="s2">, </span><span class="s1">taskChain </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">taskChain</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">stopReaderPollTask</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">readerPollTaskObj</span><span class="s2">:</span>
            <span class="s1">taskMgr</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">readerPollTaskObj</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">readerPollTaskObj </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ignore</span><span class="s2">(</span><span class="s1">CConnectionRepository</span><span class="s2">.</span><span class="s1">getOverflowEventName</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">readerPollUntilEmpty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">task</span><span class="s2">):</span>
        <span class="s0">while </span><span class="s1">self</span><span class="s2">.</span><span class="s1">readerPollOnce</span><span class="s2">():</span>
            <span class="s0">pass</span>
        <span class="s0">return </span><span class="s1">Task</span><span class="s2">.</span><span class="s1">cont</span>

    <span class="s0">def </span><span class="s1">readerPollOnce</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">checkDatagram</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">getDatagramIterator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">private__di</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">handleDatagram</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">private__di</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s5">1</span>

        <span class="s6"># Unable to receive a datagram: did we lose the connection?</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">isConnected</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">stopReaderPollTask</span><span class="s2">()</span>
            <span class="s1">messenger</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">uniqueName</span><span class="s2">(</span><span class="s3">'lostConnection'</span><span class="s2">), </span><span class="s1">taskChain </span><span class="s2">= </span><span class="s3">'default'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s5">0</span>

    <span class="s0">def </span><span class="s1">handleReaderOverflow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># this is called if the incoming-datagram queue overflowed and</span>
        <span class="s6"># we lost some data. Override and handle if desired.</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">lostConnection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># This should be overrided by a derived class to handle an</span>
        <span class="s6"># unexpectedly lost connection to the gameserver.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;Lost connection to gameserver.&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">handleDatagram</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">di</span><span class="s2">):</span>
        <span class="s6"># This class is meant to be pure virtual, and any classes that</span>
        <span class="s6"># inherit from it need to make their own handleDatagram method</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">send</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datagram</span><span class="s2">):</span>
        <span class="s6"># Zero-length datagrams might freak out the server.  No point</span>
        <span class="s6"># in sending them, anyway.</span>
        <span class="s0">if </span><span class="s1">datagram</span><span class="s2">.</span><span class="s1">getLength</span><span class="s2">() &gt; </span><span class="s5">0</span><span class="s2">:</span>
<span class="s6">##             if self.notify.getDebug():</span>
<span class="s6">##                 print &quot;ConnectionRepository sending datagram:&quot;</span>
<span class="s6">##                 datagram.dumpHex(ostream)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">sendDatagram</span><span class="s2">(</span><span class="s1">datagram</span><span class="s2">)</span>

    <span class="s6"># debugging funcs for simulating a network-plug-pull</span>
    <span class="s0">def </span><span class="s1">pullNetworkPlug</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">'*** SIMULATING A NETWORK-PLUG-PULL ***'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setSimulatedDisconnect</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">networkPlugPulled</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getSimulatedDisconnect</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">restoreNetworkPlug</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">networkPlugPulled</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">notify</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">'*** RESTORING SIMULATED PULLED-NETWORK-PLUG ***'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">setSimulatedDisconnect</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">uniqueName</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">idString</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s3">&quot;%s-%s&quot; </span><span class="s2">% (</span><span class="s1">idString</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">uniqueId</span><span class="s2">))</span>

<span class="s0">class </span><span class="s1">GCTrigger</span><span class="s2">:</span>
    <span class="s6"># used to trigger garbage collection</span>
    <span class="s0">pass</span>
</pre>
</body>
</html>