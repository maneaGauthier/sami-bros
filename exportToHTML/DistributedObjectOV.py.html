<html>
<head>
<title>DistributedObjectOV.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #bcbec4;}
.s1 { color: #cf8e6d;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
DistributedObjectOV.py</font>
</center></td></tr></table>
<pre>
<span class="s1">from </span><span class="s0">direct</span><span class="s2">.</span><span class="s0">directnotify</span><span class="s2">.</span><span class="s0">DirectNotifyGlobal </span><span class="s1">import </span><span class="s0">directNotify</span>
<span class="s1">from </span><span class="s0">direct</span><span class="s2">.</span><span class="s0">distributed</span><span class="s2">.</span><span class="s0">DistributedObjectBase </span><span class="s1">import </span><span class="s0">DistributedObjectBase</span>

<span class="s3">#from PyDatagram import PyDatagram</span>
<span class="s3">#from PyDatagramIterator import PyDatagramIterator</span>

<span class="s3"># Values for DistributedObjectOV.activeState</span>
<span class="s3"># these should match DistributedObject.ES*</span>

<span class="s0">ESNew          </span><span class="s2">= </span><span class="s4">1</span>
<span class="s0">ESDeleted      </span><span class="s2">= </span><span class="s4">2</span>
<span class="s0">ESDisabling    </span><span class="s2">= </span><span class="s4">3</span>
<span class="s0">ESDisabled     </span><span class="s2">= </span><span class="s4">4  </span><span class="s3"># values here and lower are considered &quot;disabled&quot;</span>
<span class="s0">ESGenerating   </span><span class="s2">= </span><span class="s4">5  </span><span class="s3"># values here and greater are considered &quot;generated&quot;</span>
<span class="s0">ESGenerated    </span><span class="s2">= </span><span class="s4">6</span>

<span class="s1">class </span><span class="s0">DistributedObjectOV</span><span class="s2">(</span><span class="s0">DistributedObjectBase</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Implementation of the 'owner view' (OV) of a distributed object; 
    &quot;&quot;&quot;</span>
    <span class="s0">notify </span><span class="s2">= </span><span class="s0">directNotify</span><span class="s2">.</span><span class="s0">newCategory</span><span class="s2">(</span><span class="s6">&quot;DistributedObjectOV&quot;</span><span class="s2">)</span>

    <span class="s1">def </span><span class="s0">__init__</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">cr</span><span class="s2">):</span>
        <span class="s1">assert </span><span class="s0">self</span><span class="s2">.</span><span class="s0">notify</span><span class="s2">.</span><span class="s0">debugStateCall</span><span class="s2">(</span><span class="s0">self</span><span class="s2">)</span>
        <span class="s1">try</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">DistributedObjectOV_initialized</span>
        <span class="s1">except</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">DistributedObjectOV_initialized </span><span class="s2">= </span><span class="s4">1</span>
            <span class="s0">DistributedObjectBase</span><span class="s2">.</span><span class="s0">__init__</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">cr</span><span class="s2">)</span>

            <span class="s3"># Keep track of our state as a distributed object.  This</span>
            <span class="s3"># is only trustworthy if the inheriting class properly</span>
            <span class="s3"># calls up the chain for disable() and generate().</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">activeState </span><span class="s2">= </span><span class="s0">ESNew</span>

    <span class="s1">if __debug__</span><span class="s2">:</span>
        <span class="s1">def </span><span class="s0">status</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">indent</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
            <span class="s5">&quot;&quot;&quot; 
            print out &quot;doId(parentId, zoneId) className&quot; 
                and conditionally show generated, disabled 
            &quot;&quot;&quot;</span>
            <span class="s0">spaces </span><span class="s2">= </span><span class="s6">' ' </span><span class="s2">* (</span><span class="s0">indent </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">)</span>
            <span class="s1">try</span><span class="s2">:</span>
                <span class="s0">print</span><span class="s2">(</span><span class="s6">&quot;%s%s:&quot; </span><span class="s2">% (</span><span class="s6">' ' </span><span class="s2">* </span><span class="s0">indent</span><span class="s2">, </span><span class="s0">self</span><span class="s2">.</span><span class="s0">__class__</span><span class="s2">.</span><span class="s0">__name__</span><span class="s2">))</span>

                <span class="s0">flags </span><span class="s2">= []</span>
                <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">activeState </span><span class="s2">== </span><span class="s0">ESGenerated</span><span class="s2">:</span>
                    <span class="s0">flags</span><span class="s2">.</span><span class="s0">append</span><span class="s2">(</span><span class="s6">&quot;generated&quot;</span><span class="s2">)</span>
                <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">activeState </span><span class="s2">&lt; </span><span class="s0">ESGenerating</span><span class="s2">:</span>
                    <span class="s0">flags</span><span class="s2">.</span><span class="s0">append</span><span class="s2">(</span><span class="s6">&quot;disabled&quot;</span><span class="s2">)</span>

                <span class="s0">flagStr </span><span class="s2">= </span><span class="s6">&quot;&quot;</span>
                <span class="s1">if </span><span class="s0">len</span><span class="s2">(</span><span class="s0">flags</span><span class="s2">):</span>
                    <span class="s0">flagStr </span><span class="s2">= </span><span class="s6">&quot; (%s)&quot; </span><span class="s2">% (</span><span class="s6">&quot; &quot;</span><span class="s2">.</span><span class="s0">join</span><span class="s2">(</span><span class="s0">flags</span><span class="s2">))</span>

                <span class="s0">print</span><span class="s2">(</span><span class="s6">&quot;%sfrom DistributedObjectOV doId:%s, parent:%s, zone:%s%s&quot; </span><span class="s2">% (</span>
                    <span class="s0">spaces</span><span class="s2">, </span><span class="s0">self</span><span class="s2">.</span><span class="s0">doId</span><span class="s2">, </span><span class="s0">self</span><span class="s2">.</span><span class="s0">parentId</span><span class="s2">, </span><span class="s0">self</span><span class="s2">.</span><span class="s0">zoneId</span><span class="s2">, </span><span class="s0">flagStr</span><span class="s2">))</span>
            <span class="s1">except </span><span class="s0">Exception </span><span class="s1">as </span><span class="s0">e</span><span class="s2">:</span>
                <span class="s0">print</span><span class="s2">(</span><span class="s6">&quot;%serror printing status %s&quot; </span><span class="s2">% (</span><span class="s0">spaces</span><span class="s2">, </span><span class="s0">e</span><span class="s2">))</span>


    <span class="s1">def </span><span class="s0">getDelayDeleteCount</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s3"># OV objects cannot be delayDeleted</span>
        <span class="s1">return </span><span class="s4">0</span>

    <span class="s1">def </span><span class="s0">deleteOrDelay</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">disableAnnounceAndDelete</span><span class="s2">()</span>

    <span class="s1">def </span><span class="s0">disableAnnounceAndDelete</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">disableAndAnnounce</span><span class="s2">()</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">delete</span><span class="s2">()</span>

    <span class="s1">def </span><span class="s0">disableAndAnnounce</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s3"># We must send the disable announce message *before* we</span>
        <span class="s3"># actually disable the object.  That way, the various cleanup</span>
        <span class="s3"># tasks can run first and take care of restoring the object to</span>
        <span class="s3"># a normal, nondisabled state; and *then* the disable function</span>
        <span class="s3"># can properly disable it (for instance, by parenting it to</span>
        <span class="s3"># hidden).</span>
        <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">activeState </span><span class="s2">!= </span><span class="s0">ESDisabled</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">activeState </span><span class="s2">= </span><span class="s0">ESDisabling</span>
            <span class="s0">messenger</span><span class="s2">.</span><span class="s0">send</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">uniqueName</span><span class="s2">(</span><span class="s6">&quot;disable&quot;</span><span class="s2">))</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">disable</span><span class="s2">()</span>

    <span class="s1">def </span><span class="s0">announceGenerate</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Sends a message to the world after the object has been 
        generated and all of its required fields filled in. 
        &quot;&quot;&quot;</span>
        <span class="s1">assert </span><span class="s0">self</span><span class="s2">.</span><span class="s0">notify</span><span class="s2">.</span><span class="s0">debug</span><span class="s2">(</span><span class="s6">'announceGenerate(): %s' </span><span class="s2">% (</span><span class="s0">self</span><span class="s2">.</span><span class="s0">doId</span><span class="s2">))</span>

    <span class="s1">def </span><span class="s0">disable</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Inheritors should redefine this to take appropriate action on disable 
        &quot;&quot;&quot;</span>
        <span class="s1">assert </span><span class="s0">self</span><span class="s2">.</span><span class="s0">notify</span><span class="s2">.</span><span class="s0">debug</span><span class="s2">(</span><span class="s6">'disable(): %s' </span><span class="s2">% (</span><span class="s0">self</span><span class="s2">.</span><span class="s0">doId</span><span class="s2">))</span>
        <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">activeState </span><span class="s2">!= </span><span class="s0">ESDisabled</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">activeState </span><span class="s2">= </span><span class="s0">ESDisabled</span>

    <span class="s1">def </span><span class="s0">isDisabled</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Returns true if the object has been disabled and/or deleted, 
        or if it is brand new and hasn't yet been generated. 
        &quot;&quot;&quot;</span>
        <span class="s1">return </span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">activeState </span><span class="s2">&lt; </span><span class="s0">ESGenerating</span><span class="s2">)</span>

    <span class="s1">def </span><span class="s0">isGenerated</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Returns true if the object has been fully generated by now, 
        and not yet disabled. 
        &quot;&quot;&quot;</span>
        <span class="s1">assert </span><span class="s0">self</span><span class="s2">.</span><span class="s0">notify</span><span class="s2">.</span><span class="s0">debugStateCall</span><span class="s2">(</span><span class="s0">self</span><span class="s2">)</span>
        <span class="s1">return </span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">activeState </span><span class="s2">== </span><span class="s0">ESGenerated</span><span class="s2">)</span>

    <span class="s1">def </span><span class="s0">delete</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Inheritors should redefine this to take appropriate action on delete 
        &quot;&quot;&quot;</span>
        <span class="s1">assert </span><span class="s0">self</span><span class="s2">.</span><span class="s0">notify</span><span class="s2">.</span><span class="s0">debug</span><span class="s2">(</span><span class="s6">'delete(): %s' </span><span class="s2">% (</span><span class="s0">self</span><span class="s2">.</span><span class="s0">doId</span><span class="s2">))</span>
        <span class="s1">try</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">DistributedObjectOV_deleted</span>
        <span class="s1">except</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">DistributedObjectOV_deleted </span><span class="s2">= </span><span class="s4">1</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">cr </span><span class="s2">= </span><span class="s1">None</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">dclass </span><span class="s2">= </span><span class="s1">None</span>

    <span class="s1">def </span><span class="s0">generate</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Inheritors should redefine this to take appropriate action on generate 
        &quot;&quot;&quot;</span>
        <span class="s1">assert </span><span class="s0">self</span><span class="s2">.</span><span class="s0">notify</span><span class="s2">.</span><span class="s0">debugStateCall</span><span class="s2">(</span><span class="s0">self</span><span class="s2">)</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">activeState </span><span class="s2">= </span><span class="s0">ESGenerating</span>
        <span class="s3"># this has already been set at this point</span>
        <span class="s3">#self.cr.storeObjectLocation(self, self.parentId, self.zoneId)</span>

    <span class="s1">def </span><span class="s0">generateInit</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        This method is called when the DistributedObjectOV is first introduced 
        to the world... Not when it is pulled from the cache. 
        &quot;&quot;&quot;</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">activeState </span><span class="s2">= </span><span class="s0">ESGenerating</span>

    <span class="s1">def </span><span class="s0">getDoId</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Return the distributed object id 
        &quot;&quot;&quot;</span>
        <span class="s1">return </span><span class="s0">self</span><span class="s2">.</span><span class="s0">doId</span>

    <span class="s1">def </span><span class="s0">postGenerateMessage</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">activeState </span><span class="s2">!= </span><span class="s0">ESGenerated</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">activeState </span><span class="s2">= </span><span class="s0">ESGenerated</span>
            <span class="s0">messenger</span><span class="s2">.</span><span class="s0">send</span><span class="s2">(</span><span class="s0">self</span><span class="s2">.</span><span class="s0">uniqueName</span><span class="s2">(</span><span class="s6">&quot;generate&quot;</span><span class="s2">), [</span><span class="s0">self</span><span class="s2">])</span>


    <span class="s1">def </span><span class="s0">updateRequiredFields</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">dclass</span><span class="s2">, </span><span class="s0">di</span><span class="s2">):</span>
        <span class="s0">dclass</span><span class="s2">.</span><span class="s0">receiveUpdateBroadcastRequired</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">di</span><span class="s2">)</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">announceGenerate</span><span class="s2">()</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">postGenerateMessage</span><span class="s2">()</span>

    <span class="s1">def </span><span class="s0">updateAllRequiredFields</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">dclass</span><span class="s2">, </span><span class="s0">di</span><span class="s2">):</span>
        <span class="s0">dclass</span><span class="s2">.</span><span class="s0">receiveUpdateAllRequired</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">di</span><span class="s2">)</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">announceGenerate</span><span class="s2">()</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">postGenerateMessage</span><span class="s2">()</span>

    <span class="s1">def </span><span class="s0">updateRequiredOtherFields</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">dclass</span><span class="s2">, </span><span class="s0">di</span><span class="s2">):</span>
        <span class="s3"># First, update the required fields</span>
        <span class="s0">dclass</span><span class="s2">.</span><span class="s0">receiveUpdateBroadcastRequiredOwner</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">di</span><span class="s2">)</span>

        <span class="s3"># Announce generate after updating all the required fields,</span>
        <span class="s3"># but before we update the non-required fields.</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">announceGenerate</span><span class="s2">()</span>
        <span class="s0">self</span><span class="s2">.</span><span class="s0">postGenerateMessage</span><span class="s2">()</span>

        <span class="s0">dclass</span><span class="s2">.</span><span class="s0">receiveUpdateOther</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">di</span><span class="s2">)</span>

    <span class="s1">def </span><span class="s0">getCacheable</span><span class="s2">(</span><span class="s0">self</span><span class="s2">):</span>
        <span class="s1">return False</span>

    <span class="s1">def </span><span class="s0">sendUpdate</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">fieldName</span><span class="s2">, </span><span class="s0">args </span><span class="s2">= [], </span><span class="s0">sendToId </span><span class="s2">= </span><span class="s1">None</span><span class="s2">):</span>
        <span class="s1">if </span><span class="s0">self</span><span class="s2">.</span><span class="s0">cr</span><span class="s2">:</span>
            <span class="s0">dg </span><span class="s2">= </span><span class="s0">self</span><span class="s2">.</span><span class="s0">dclass</span><span class="s2">.</span><span class="s0">clientFormatUpdate</span><span class="s2">(</span>
                <span class="s0">fieldName</span><span class="s2">, </span><span class="s0">sendToId </span><span class="s1">or </span><span class="s0">self</span><span class="s2">.</span><span class="s0">doId</span><span class="s2">, </span><span class="s0">args</span><span class="s2">)</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">cr</span><span class="s2">.</span><span class="s0">send</span><span class="s2">(</span><span class="s0">dg</span><span class="s2">)</span>
        <span class="s1">else</span><span class="s2">:</span>
            <span class="s0">self</span><span class="s2">.</span><span class="s0">notify</span><span class="s2">.</span><span class="s0">warning</span><span class="s2">(</span><span class="s6">&quot;sendUpdate failed, because self.cr is not set&quot;</span><span class="s2">)</span>

    <span class="s1">def </span><span class="s0">taskName</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">taskString</span><span class="s2">):</span>
        <span class="s1">return </span><span class="s2">(</span><span class="s6">'%s-%s-OV' </span><span class="s2">% (</span><span class="s0">taskString</span><span class="s2">, </span><span class="s0">self</span><span class="s2">.</span><span class="s0">getDoId</span><span class="s2">()))</span>

    <span class="s1">def </span><span class="s0">uniqueName</span><span class="s2">(</span><span class="s0">self</span><span class="s2">, </span><span class="s0">idString</span><span class="s2">):</span>
        <span class="s1">return </span><span class="s2">(</span><span class="s6">'%s-%s-OV' </span><span class="s2">% (</span><span class="s0">idString</span><span class="s2">, </span><span class="s0">self</span><span class="s2">.</span><span class="s0">getDoId</span><span class="s2">()))</span>
</pre>
</body>
</html>