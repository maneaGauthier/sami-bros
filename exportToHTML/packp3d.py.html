<html>
<head>
<title>packp3d.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
packp3d.py</font>
</center></td></tr></table>
<pre><span class="s0">#! /usr/bin/env python</span>

<span class="s1">usageText </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
 
This command will pack a Panda application, consisting of a directory 
tree of .py files and models, into a p3d file for convenient 
distribution.  The resulting p3d file can be run by the Panda3D 
runtime executable, or by the Panda3D web browser plugin. 
 
This command will build p3d files that reference Panda3D %s, 
from host %s . 
 
Also see ppackage, a more powerful (but more complex) tool that can 
also be used to build p3d applications, using a pdef description file. 
 
Usage: 
 
  %s [opts] -o app.p3d 
 
Options: 
 
  -o app.p3d 
     Specify the name of the p3d file to generate.  This is required. 
 
  -d application_root 
     Specify the root directory of the application source; this is a 
     directory tree that contains all of your .py files and models. 
     If this is omitted, the default is the current directory. 
 
  -m main.py 
     Names the Python file that begins the application.  This should 
     be a file within the root directory. If this is omitted, the 
     default is a file named &quot;main.py&quot;, or if there is only one Python 
     file present, it is used.  If this file contains a function 
     called main(), that function will be called after importing it 
     (this is preferable to having the module start itself immediately 
     upon importing). 
 
  -S file.crt[,chain.crt[,file.key[,</span><span class="s4">\&quot;</span><span class="s3">password</span><span class="s4">\&quot;</span><span class="s3">]]] 
     Signs the resulting p3d with the indicated certificate.  You may 
     specify the signing certificate, the optional authorization 
     chain, and the private key in three different files, or they may 
     all be combined in the first file.  If the private key is 
     encrypted, the password will be required to decrypt it. 
 
  -e ext 
     Adds a new extension to be processed as a generic, compressible 
     file type.  Do not include the leading dot.  Files matching this 
     extension found within the root directory will be automatically 
     added to the p3d file, in compressed form.  This option may be 
     repeated as necessary. 
 
  -n ext 
     Adds a new extension to be processed as a noncompressible file 
     type.  Files matching this extension will be added to the p3d 
     file, in their original, uncompressed form.  You should use this 
     instead of -e for files that are uncompressible by their nature 
     (e.g. mpg files).  This option may be repeated as necessary. 
 
  -x ext 
     Marks files with the given extensions of needing to be physically 
     extracted to disk before they can be loaded.  This is used for 
     file types that cannot be loaded via the virtual file system, 
     such as .ico files on Windows. 
     This option is currently only implemented when deploying the 
     application with pdeploy. 
 
  -p python_lib_dir 
     Adds a directory to search for additional Python modules.  You 
     can use this to add your system's Python path, to allow packp3d 
     to find any system modules not included in the standard Panda3D 
     release, but your version of Python must match this one (%s). 
     This option may be repeated to add multiple directories. 
 
  -c config=value 
     Sets the indicated config flag in the application.  This option 
     may be repeated as necessary. 
 
  -r package[,version[,hostURL]] 
     Names an additional package that this application requires at 
     startup time.  The default package is 'panda3d'; you may repeat 
     this option to indicate dependencies on additional packages. 
 
  -s search_dir 
     Additional directories to search for previously-built packages. 
     This option may be repeated as necessary.  These directories may 
     also be specified with the pdef-path Config.prc variable. 
 
  -D 
     Sets the allow_python_dev flag in the application.  This enables 
     additional runtime debug operations, particularly the -i option 
     to the panda3d command, which enables a live Python prompt within 
     the application's environment.  Setting this flag may be useful 
     to develop an application initially, but should not be set on an 
     application intended for deployment. 
 
&quot;&quot;&quot;</span>

<span class="s4">import </span><span class="s1">sys</span>
<span class="s4">import </span><span class="s1">os</span>
<span class="s4">import </span><span class="s1">getopt</span>
<span class="s4">import </span><span class="s1">glob</span>
<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">p3d </span><span class="s4">import </span><span class="s1">Packager</span>
<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s2">*</span>

<span class="s0"># Temp hack for debugging.</span>
<span class="s0">#from direct.p3d.AppRunner import dummyAppRunner; dummyAppRunner()</span>

<span class="s4">class </span><span class="s1">ArgumentError</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">):</span>
    <span class="s4">pass</span>

<span class="s4">def </span><span class="s1">makePackedApp</span><span class="s2">(</span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">opts</span><span class="s2">, </span><span class="s1">args </span><span class="s2">= </span><span class="s1">getopt</span><span class="s2">.</span><span class="s1">getopt</span><span class="s2">(</span><span class="s1">args</span><span class="s2">, </span><span class="s3">'o:d:m:S:e:n:x:p:c:r:s:Dh'</span><span class="s2">)</span>

    <span class="s1">packager </span><span class="s2">= </span><span class="s1">Packager</span><span class="s2">.</span><span class="s1">Packager</span><span class="s2">()</span>

    <span class="s1">appFilename </span><span class="s2">= </span><span class="s4">None</span>
    <span class="s1">root </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">)</span>
    <span class="s1">main </span><span class="s2">= </span><span class="s4">None</span>
    <span class="s1">configFlags </span><span class="s2">= []</span>
    <span class="s1">requires </span><span class="s2">= []</span>
    <span class="s1">allowPythonDev </span><span class="s2">= </span><span class="s4">False</span>

    <span class="s4">for </span><span class="s1">option</span><span class="s2">, </span><span class="s1">value </span><span class="s4">in </span><span class="s1">opts</span><span class="s2">:</span>
        <span class="s4">if </span><span class="s1">option </span><span class="s2">== </span><span class="s3">'-o'</span><span class="s2">:</span>
            <span class="s1">appFilename </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s4">elif </span><span class="s1">option </span><span class="s2">== </span><span class="s3">'-d'</span><span class="s2">:</span>
            <span class="s1">root </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s4">elif </span><span class="s1">option </span><span class="s2">== </span><span class="s3">'-m'</span><span class="s2">:</span>
            <span class="s1">main </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s4">elif </span><span class="s1">option </span><span class="s2">== </span><span class="s3">'-S'</span><span class="s2">:</span>
            <span class="s1">tokens </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">','</span><span class="s2">)</span>
            <span class="s4">while </span><span class="s1">len</span><span class="s2">(</span><span class="s1">tokens</span><span class="s2">) &lt; </span><span class="s5">4</span><span class="s2">:</span>
                <span class="s1">tokens</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">''</span><span class="s2">)</span>
            <span class="s1">certificate</span><span class="s2">, </span><span class="s1">chain</span><span class="s2">, </span><span class="s1">pkey</span><span class="s2">, </span><span class="s1">password </span><span class="s2">= </span><span class="s1">tokens</span><span class="s2">[:</span><span class="s5">4</span><span class="s2">]</span>
            <span class="s1">packager</span><span class="s2">.</span><span class="s1">signParams</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">certificate</span><span class="s2">),</span>
                                        <span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">chain</span><span class="s2">),</span>
                                        <span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">pkey</span><span class="s2">),</span>
                                        <span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">password</span><span class="s2">)))</span>
        <span class="s4">elif </span><span class="s1">option </span><span class="s2">== </span><span class="s3">'-e'</span><span class="s2">:</span>
            <span class="s1">packager</span><span class="s2">.</span><span class="s1">binaryExtensions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s4">elif </span><span class="s1">option </span><span class="s2">== </span><span class="s3">'-n'</span><span class="s2">:</span>
            <span class="s1">packager</span><span class="s2">.</span><span class="s1">uncompressibleExtensions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s4">elif </span><span class="s1">option </span><span class="s2">== </span><span class="s3">'-x'</span><span class="s2">:</span>
            <span class="s1">packager</span><span class="s2">.</span><span class="s1">extractExtensions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s4">elif </span><span class="s1">option </span><span class="s2">== </span><span class="s3">'-p'</span><span class="s2">:</span>
            <span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s4">elif </span><span class="s1">option </span><span class="s2">== </span><span class="s3">'-c'</span><span class="s2">:</span>
            <span class="s1">configFlags</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'='</span><span class="s2">, </span><span class="s5">1</span><span class="s2">))</span>
        <span class="s4">elif </span><span class="s1">option </span><span class="s2">== </span><span class="s3">'-r'</span><span class="s2">:</span>
            <span class="s1">tokens </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">','</span><span class="s2">)</span>
            <span class="s4">while </span><span class="s1">len</span><span class="s2">(</span><span class="s1">tokens</span><span class="s2">) &lt; </span><span class="s5">3</span><span class="s2">:</span>
                <span class="s1">tokens</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">''</span><span class="s2">)</span>
            <span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">host </span><span class="s2">= </span><span class="s1">tokens</span><span class="s2">[:</span><span class="s5">3</span><span class="s2">]</span>
            <span class="s1">requires</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">host</span><span class="s2">))</span>
        <span class="s4">elif </span><span class="s1">option </span><span class="s2">== </span><span class="s3">'-s'</span><span class="s2">:</span>
            <span class="s1">packager</span><span class="s2">.</span><span class="s1">installSearch</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">value</span><span class="s2">))</span>
        <span class="s4">elif </span><span class="s1">option </span><span class="s2">== </span><span class="s3">'-D'</span><span class="s2">:</span>
            <span class="s1">allowPythonDev </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s4">elif </span><span class="s1">option </span><span class="s2">== </span><span class="s3">'-h'</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s1">usageText </span><span class="s2">% (</span>
                <span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageVersionString</span><span class="s2">(),</span>
                <span class="s1">PandaSystem</span><span class="s2">.</span><span class="s1">getPackageHostUrl</span><span class="s2">(),</span>
                <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])[</span><span class="s5">1</span><span class="s2">],</span>
                <span class="s3">'%s.%s' </span><span class="s2">% (</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])))</span>
            <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>

    <span class="s4">if not </span><span class="s1">appFilename</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">ArgumentError</span><span class="s2">(</span><span class="s3">&quot;No target app specified.  Use:</span><span class="s4">\n  </span><span class="s3">%s -o app.p3d</span><span class="s4">\n</span><span class="s3">Use -h to get more usage information.&quot; </span><span class="s2">% (</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])[</span><span class="s5">1</span><span class="s2">]))</span>

    <span class="s4">if </span><span class="s1">args</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">ArgumentError</span><span class="s2">(</span><span class="s3">&quot;Extra arguments on command line.&quot;</span><span class="s2">)</span>

    <span class="s4">if </span><span class="s1">appFilename</span><span class="s2">.</span><span class="s1">getExtension</span><span class="s2">() != </span><span class="s3">'p3d'</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">ArgumentError</span><span class="s2">(</span><span class="s3">'Application filename must end in &quot;.p3d&quot;.'</span><span class="s2">)</span>

    <span class="s1">appDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">appFilename</span><span class="s2">.</span><span class="s1">getDirname</span><span class="s2">())</span>
    <span class="s4">if not </span><span class="s1">appDir</span><span class="s2">:</span>
      <span class="s1">appDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">)</span>
    <span class="s1">appBase </span><span class="s2">= </span><span class="s1">appFilename</span><span class="s2">.</span><span class="s1">getBasenameWoExtension</span><span class="s2">()</span>

    <span class="s4">if </span><span class="s1">main</span><span class="s2">:</span>
        <span class="s1">main </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">main</span><span class="s2">)</span>
        <span class="s1">main</span><span class="s2">.</span><span class="s1">makeAbsolute</span><span class="s2">(</span><span class="s1">root</span><span class="s2">)</span>
    <span class="s4">else</span><span class="s2">:</span>
        <span class="s1">main </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s1">root</span><span class="s2">, </span><span class="s3">'main.py'</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">main</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">():</span>
            <span class="s1">main </span><span class="s2">= </span><span class="s1">glob</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">root</span><span class="s2">.</span><span class="s1">toOsSpecific</span><span class="s2">(), </span><span class="s3">'*.py'</span><span class="s2">))</span>
            <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">main</span><span class="s2">) == </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s4">raise </span><span class="s1">ArgumentError</span><span class="s2">(</span><span class="s3">'No Python files in root directory.'</span><span class="s2">)</span>
            <span class="s4">elif </span><span class="s1">len</span><span class="s2">(</span><span class="s1">main</span><span class="s2">) &gt; </span><span class="s5">1</span><span class="s2">:</span>
                <span class="s4">raise </span><span class="s1">ArgumentError</span><span class="s2">(</span><span class="s3">'Multiple Python files in root directory; specify the main application with -m &quot;main&quot;.'</span><span class="s2">)</span>

            <span class="s1">main </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">main</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])[</span><span class="s5">1</span><span class="s2">])</span>
            <span class="s1">main</span><span class="s2">.</span><span class="s1">makeAbsolute</span><span class="s2">(</span><span class="s1">root</span><span class="s2">)</span>

    <span class="s1">packager</span><span class="s2">.</span><span class="s1">installDir </span><span class="s2">= </span><span class="s1">appDir</span>
    <span class="s1">packager</span><span class="s2">.</span><span class="s1">allowPythonDev </span><span class="s2">= </span><span class="s1">allowPythonDev</span>

    <span class="s0"># Put the root directory on the front of the model-path, so that</span>
    <span class="s0"># any texture references in egg or bam files that reference</span>
    <span class="s0"># textures from the top of the root directory will be properly</span>
    <span class="s0"># resolved.</span>
    <span class="s1">getModelPath</span><span class="s2">().</span><span class="s1">prependDirectory</span><span class="s2">(</span><span class="s1">root</span><span class="s2">)</span>

    <span class="s4">try</span><span class="s2">:</span>
        <span class="s1">packager</span><span class="s2">.</span><span class="s1">setup</span><span class="s2">()</span>
        <span class="s1">packager</span><span class="s2">.</span><span class="s1">beginPackage</span><span class="s2">(</span><span class="s1">appBase</span><span class="s2">, </span><span class="s1">p3dApplication </span><span class="s2">= </span><span class="s4">True</span><span class="s2">)</span>

        <span class="s0"># Pre-require panda3d, to give a less-confusing error message</span>
        <span class="s0"># if one of our requirements pulls in a wrong version of</span>
        <span class="s0"># panda3d.</span>
        <span class="s4">if </span><span class="s3">'panda3d' </span><span class="s4">not in </span><span class="s2">[</span><span class="s1">t</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s4">for </span><span class="s1">t </span><span class="s4">in </span><span class="s1">requires</span><span class="s2">]:</span>
            <span class="s1">packager</span><span class="s2">.</span><span class="s1">do_require</span><span class="s2">(</span><span class="s3">'panda3d'</span><span class="s2">)</span>

        <span class="s4">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">host </span><span class="s4">in </span><span class="s1">requires</span><span class="s2">:</span>
            <span class="s1">packager</span><span class="s2">.</span><span class="s1">do_require</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">version </span><span class="s2">= </span><span class="s1">version</span><span class="s2">, </span><span class="s1">host </span><span class="s2">= </span><span class="s1">host</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">configFlags</span><span class="s2">:</span>
            <span class="s1">packager</span><span class="s2">.</span><span class="s1">do_config</span><span class="s2">(**</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">configFlags</span><span class="s2">))</span>

        <span class="s1">packager</span><span class="s2">.</span><span class="s1">do_dir</span><span class="s2">(</span><span class="s1">root</span><span class="s2">)</span>
        <span class="s1">packager</span><span class="s2">.</span><span class="s1">do_main</span><span class="s2">(</span><span class="s1">main</span><span class="s2">)</span>
        <span class="s1">packager</span><span class="s2">.</span><span class="s1">endPackage</span><span class="s2">()</span>
        <span class="s1">packager</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s4">except </span><span class="s1">Packager</span><span class="s2">.</span><span class="s1">PackagerError</span><span class="s2">:</span>
        <span class="s0"># Just print the error message and exit gracefully.</span>
        <span class="s1">inst </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">exc_info</span><span class="s2">()[</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>

<span class="s4">try</span><span class="s2">:</span>
    <span class="s1">makePackedApp</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:])</span>
<span class="s4">except </span><span class="s1">ArgumentError </span><span class="s4">as </span><span class="s1">e</span><span class="s2">:</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>

<span class="s0"># An explicit call to exit() is required to exit the program, when</span>
<span class="s0"># this module is packaged in a p3d file.</span>
<span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
</pre>
</body>
</html>