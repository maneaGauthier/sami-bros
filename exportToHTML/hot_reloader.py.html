<html>
<head>
<title>hot_reloader.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
hot_reloader.py</font>
</center></td></tr></table>
<pre><span class="s0"># this will clear the scene and try to execute the main.py code without</span>
<span class="s0"># restarting the program</span>

<span class="s2">from </span><span class="s1">ursina </span><span class="s2">import </span><span class="s1">Entity</span><span class="s3">, </span><span class="s1">camera</span><span class="s3">, </span><span class="s1">texture_importer</span><span class="s3">, </span><span class="s1">mesh_importer</span><span class="s3">, </span><span class="s1">scene</span><span class="s3">, </span><span class="s1">application</span><span class="s3">, </span><span class="s1">print_on_screen</span>
<span class="s2">from </span><span class="s1">pathlib </span><span class="s2">import </span><span class="s1">Path</span>
<span class="s2">import </span><span class="s1">time</span>
<span class="s2">import </span><span class="s1">ast</span>


<span class="s2">def </span><span class="s1">is_valid_python</span><span class="s3">(</span><span class="s1">code</span><span class="s3">):</span>
   <span class="s2">try</span><span class="s3">:</span>
       <span class="s1">ast</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">(</span><span class="s1">code</span><span class="s3">)</span>
   <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
       <span class="s2">return False</span><span class="s3">, </span><span class="s1">e</span>

   <span class="s2">return True</span>


<span class="s2">def </span><span class="s1">make_code_reload_safe</span><span class="s3">(</span><span class="s1">code</span><span class="s3">):</span>
    <span class="s1">newtext </span><span class="s3">= </span><span class="s4">''</span>
    <span class="s1">dedent_next </span><span class="s3">= </span><span class="s2">False</span>

    <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">code</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s4">'Ursina(' </span><span class="s2">in </span><span class="s1">line </span><span class="s2">or </span><span class="s1">line</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">().</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'app.run()'</span><span class="s3">) </span><span class="s2">or </span><span class="s1">line</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">().</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'HotReloader()'</span><span class="s3">):</span>
            <span class="s2">continue</span>
        <span class="s2">if </span><span class="s4">'eternal=True' </span><span class="s2">in </span><span class="s1">line</span><span class="s3">:</span>
            <span class="s2">continue</span>
        <span class="s2">if </span><span class="s1">line</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'''if __name__ == '__main__':'''</span><span class="s3">):</span>
            <span class="s1">dedent_next </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s2">continue</span>
        <span class="s2">if </span><span class="s1">line </span><span class="s2">and </span><span class="s1">line</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] != </span><span class="s4">' '</span><span class="s3">:</span>
            <span class="s1">dedent_next </span><span class="s3">= </span><span class="s2">False</span>

        <span class="s2">if </span><span class="s1">line</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">().</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'#'</span><span class="s3">):</span>
            <span class="s1">newtext </span><span class="s3">+= </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span>
            <span class="s2">continue</span>
        <span class="s0"># if line.strip().startswith('EditorCamera(') and not 'eternal=False' in line: # EditorCamera is eternal, so don't create multiple ones</span>
        <span class="s0">#     newtext += '\n'</span>
        <span class="s0">#     continue</span>

        <span class="s2">if </span><span class="s1">dedent_next</span><span class="s3">:</span>
            <span class="s1">newtext </span><span class="s3">+= </span><span class="s1">line</span><span class="s3">[</span><span class="s5">4</span><span class="s3">:] + </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">newtext </span><span class="s3">+= </span><span class="s1">line </span><span class="s3">+ </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span>

    <span class="s2">return </span><span class="s1">newtext</span>



<span class="s2">class </span><span class="s1">HotReloader</span><span class="s3">(</span><span class="s1">Entity</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">=</span><span class="s1">__file__</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">parent</span><span class="s3">=</span><span class="s1">camera</span><span class="s3">.</span><span class="s1">ui</span><span class="s3">, </span><span class="s1">eternal</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">ignore_paused</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">path </span><span class="s3">= </span><span class="s1">path</span>

        <span class="s2">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">kwargs</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s1">setattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">path </span><span class="s3">= </span><span class="s1">Path</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">hotreload </span><span class="s3">= </span><span class="s2">False   </span><span class="s0"># toggle with f9</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_original_source_code_content </span><span class="s3">= </span><span class="s4">''</span>
        <span class="s0"># self.text_editor = InGameTextEditor(path=self.path, enabled=False)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_i </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">hotkeys </span><span class="s3">= {</span>
            <span class="s4">'ctrl+r' </span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">reload_code</span><span class="s3">,</span>
            <span class="s4">'f5'     </span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">reload_code</span><span class="s3">,</span>
            <span class="s4">'f6'     </span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">reload_textures</span><span class="s3">,</span>
            <span class="s4">'f7'     </span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">reload_models</span><span class="s3">,</span>
            <span class="s4">'f8'     </span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">reload_shaders</span><span class="s3">,</span>
            <span class="s4">'f9'     </span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">toggle_hotreloading</span><span class="s3">,</span>
            <span class="s3">}</span>


    <span class="s2">def </span><span class="s1">input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">key </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">hotkeys</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">hotkeys</span><span class="s3">[</span><span class="s1">key</span><span class="s3">]()</span>

        <span class="s0"># if key == '|':</span>
        <span class="s0">#     if not self.text_editor.enabled:</span>
        <span class="s0">#         invoke(setattr, self.text_editor, 'enabled', not self.text_editor.enabled, delay=.1)</span>
        <span class="s0">#     else:</span>
        <span class="s0">#         self.text_editor.enabled = not self.text_editor.enabled</span>

    <span class="s2">def </span><span class="s1">update</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">hotreload</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_i </span><span class="s3">+= </span><span class="s1">time</span><span class="s3">.</span><span class="s1">dt</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_i </span><span class="s3">&gt; </span><span class="s5">.2</span><span class="s3">:</span>
                <span class="s1">current_source_code </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_source_code</span><span class="s3">()</span>

                <span class="s2">if </span><span class="s1">current_source_code </span><span class="s3">!= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_original_source_code_content</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">reload_code</span><span class="s3">()</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_original_source_code_content </span><span class="s3">= </span><span class="s1">current_source_code</span>

                <span class="s1">self</span><span class="s3">.</span><span class="s1">_i </span><span class="s3">= </span><span class="s5">0</span>

    <span class="s2">def </span><span class="s1">get_source_code</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">'utf8'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">file</span><span class="s3">:</span>
            <span class="s1">text </span><span class="s3">= </span><span class="s1">file</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">text</span>


    <span class="s2">def </span><span class="s1">toggle_hotreloading</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">hotreload </span><span class="s3">= </span><span class="s2">not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">hotreload</span>
        <span class="s1">print_on_screen</span><span class="s3">(</span><span class="s4">f'&lt;azure&gt;hotreloading: </span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">hotreload</span><span class="s2">}</span><span class="s4">'</span><span class="s3">)</span>



    <span class="s2">def </span><span class="s1">reload_code</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">reset_camera</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">'trying to reload, but path does not exist:'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">)</span>
            <span class="s2">return</span>


        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">'utf8'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">file</span><span class="s3">:</span>
            <span class="s1">text </span><span class="s3">= </span><span class="s1">file</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
            <span class="s1">text </span><span class="s3">= </span><span class="s1">make_code_reload_safe</span><span class="s3">(</span><span class="s1">text</span><span class="s3">)</span>


        <span class="s2">if not </span><span class="s1">is_valid_python</span><span class="s3">(</span><span class="s1">text</span><span class="s3">):</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">'invalid python code'</span><span class="s3">)</span>
            <span class="s2">return</span>

        <span class="s1">scene</span><span class="s3">.</span><span class="s1">clear</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">reset_camera</span><span class="s3">:</span>
            <span class="s1">camera</span><span class="s3">.</span><span class="s1">position </span><span class="s3">= (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, -</span><span class="s5">20</span><span class="s3">)</span>

        <span class="s1">t </span><span class="s3">= </span><span class="s1">time</span><span class="s3">.</span><span class="s1">time</span><span class="s3">()</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">d </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">locals</span><span class="s3">(), **</span><span class="s1">globals</span><span class="s3">())</span>
            <span class="s1">application</span><span class="s3">.</span><span class="s1">paused </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s1">exec</span><span class="s3">(</span><span class="s1">text</span><span class="s3">, </span><span class="s1">d</span><span class="s3">, </span><span class="s1">d</span><span class="s3">)</span>

            <span class="s2">import </span><span class="s1">__main__</span>
            <span class="s2">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">d</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                <span class="s2">if </span><span class="s1">key </span><span class="s2">in </span><span class="s1">dir</span><span class="s3">(</span><span class="s1">__main__</span><span class="s3">) </span><span class="s2">or </span><span class="s1">key </span><span class="s2">in </span><span class="s3">(</span><span class="s4">'update'</span><span class="s3">, </span><span class="s4">'input'</span><span class="s3">):</span>
                    <span class="s1">setattr</span><span class="s3">(</span><span class="s1">__main__</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value</span><span class="s3">)</span>

            <span class="s1">application</span><span class="s3">.</span><span class="s1">paused </span><span class="s3">= </span><span class="s2">False</span>

        <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span>

        <span class="s1">print</span><span class="s3">(</span><span class="s4">'reloaded in:'</span><span class="s3">, </span><span class="s1">time</span><span class="s3">.</span><span class="s1">time</span><span class="s3">() - </span><span class="s1">t</span><span class="s3">)</span>


    <span class="s2">def </span><span class="s1">reload_textures</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">textured_entities </span><span class="s3">= [</span><span class="s1">e </span><span class="s2">for </span><span class="s1">e </span><span class="s2">in </span><span class="s1">scene</span><span class="s3">.</span><span class="s1">entities </span><span class="s2">if </span><span class="s1">e</span><span class="s3">.</span><span class="s1">texture</span><span class="s3">]</span>
        <span class="s1">reloaded_textures </span><span class="s3">= </span><span class="s1">list</span><span class="s3">()</span>

        <span class="s2">for </span><span class="s1">e </span><span class="s2">in </span><span class="s1">textured_entities</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">e</span><span class="s3">.</span><span class="s1">texture</span><span class="s3">.</span><span class="s1">name </span><span class="s2">in </span><span class="s1">reloaded_textures </span><span class="s2">or not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">e</span><span class="s3">.</span><span class="s1">texture</span><span class="s3">, </span><span class="s4">'path'</span><span class="s3">) </span><span class="s2">or not </span><span class="s1">e</span><span class="s3">.</span><span class="s1">texture</span><span class="s3">.</span><span class="s1">path</span><span class="s3">:</span>
                <span class="s2">continue</span>

            <span class="s2">if </span><span class="s1">e</span><span class="s3">.</span><span class="s1">texture</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">parent</span><span class="s3">.</span><span class="s1">name </span><span class="s3">== </span><span class="s1">application</span><span class="s3">.</span><span class="s1">compressed_textures_folder</span><span class="s3">.</span><span class="s1">name</span><span class="s3">:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">'texture is made from .psd file'</span><span class="s3">, </span><span class="s1">e</span><span class="s3">.</span><span class="s1">texture</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">stem </span><span class="s3">+ </span><span class="s4">'.psd'</span><span class="s3">)</span>
                <span class="s1">texture_importer</span><span class="s3">.</span><span class="s1">compress_textures</span><span class="s3">(</span><span class="s1">e</span><span class="s3">.</span><span class="s1">texture</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">stem</span><span class="s3">)</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">'reloaded texture:'</span><span class="s3">, </span><span class="s1">e</span><span class="s3">.</span><span class="s1">texture</span><span class="s3">.</span><span class="s1">path</span><span class="s3">)</span>
            <span class="s1">e</span><span class="s3">.</span><span class="s1">texture</span><span class="s3">.</span><span class="s1">_texture</span><span class="s3">.</span><span class="s1">reload</span><span class="s3">()</span>
            <span class="s1">reloaded_textures</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">e</span><span class="s3">.</span><span class="s1">texture</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">reloaded_textures</span>


    <span class="s2">def </span><span class="s1">reload_models</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">entities </span><span class="s3">= [</span><span class="s1">e </span><span class="s2">for </span><span class="s1">e </span><span class="s2">in </span><span class="s1">scene</span><span class="s3">.</span><span class="s1">entities </span><span class="s2">if </span><span class="s1">e</span><span class="s3">.</span><span class="s1">model</span><span class="s3">]</span>
        <span class="s1">unique_names </span><span class="s3">= </span><span class="s1">list</span><span class="s3">({</span><span class="s1">e</span><span class="s3">.</span><span class="s1">model</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'.'</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">] </span><span class="s2">for </span><span class="s1">e </span><span class="s2">in </span><span class="s1">entities</span><span class="s3">})</span>
        <span class="s0"># print(unique_names)</span>
        <span class="s1">changed_models </span><span class="s3">= </span><span class="s1">list</span><span class="s3">()</span>

        <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">unique_names</span><span class="s3">:</span>
            <span class="s1">matches </span><span class="s3">= [</span><span class="s1">e </span><span class="s2">for </span><span class="s1">e </span><span class="s2">in </span><span class="s1">application</span><span class="s3">.</span><span class="s1">asset_folder</span><span class="s3">.</span><span class="s1">glob</span><span class="s3">(</span><span class="s4">f'**/</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s4">.blend'</span><span class="s3">)]</span>
            <span class="s2">if not </span><span class="s1">matches</span><span class="s3">:</span>
                <span class="s2">continue</span>

            <span class="s1">blend_path </span><span class="s3">= </span><span class="s1">matches</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
            <span class="s0"># ignore internal models</span>
            <span class="s2">if </span><span class="s1">blend_path</span><span class="s3">.</span><span class="s1">parent </span><span class="s3">== </span><span class="s1">application</span><span class="s3">.</span><span class="s1">internal_models_folder </span><span class="s2">or </span><span class="s4">'/build/' </span><span class="s2">in </span><span class="s1">str</span><span class="s3">(</span><span class="s1">blend_path</span><span class="s3">):</span>
                <span class="s2">continue</span>

            <span class="s2">if </span><span class="s1">name </span><span class="s2">in </span><span class="s1">mesh_importer</span><span class="s3">.</span><span class="s1">imported_meshes</span><span class="s3">:</span>
                <span class="s1">mesh_importer</span><span class="s3">.</span><span class="s1">imported_meshes</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>

            <span class="s0"># print('model is made from .blend file:', blend_path)</span>
            <span class="s1">mesh_importer</span><span class="s3">.</span><span class="s1">compress_models</span><span class="s3">(</span><span class="s1">path</span><span class="s3">=</span><span class="s1">blend_path</span><span class="s3">.</span><span class="s1">parent</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s1">name</span><span class="s3">)</span>
            <span class="s0"># print(f'compressed {name}.blend sucessfully')</span>
            <span class="s1">changed_models</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>


        <span class="s2">for </span><span class="s1">e </span><span class="s2">in </span><span class="s1">entities</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">e</span><span class="s3">.</span><span class="s1">model</span><span class="s3">:</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">e</span><span class="s3">.</span><span class="s1">model</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'.'</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">changed_models</span><span class="s3">, </span><span class="s1">name </span><span class="s2">in </span><span class="s1">changed_models</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">name </span><span class="s2">in </span><span class="s1">changed_models</span><span class="s3">:</span>
                    <span class="s1">e</span><span class="s3">.</span><span class="s1">model </span><span class="s3">= </span><span class="s2">None</span>
                    <span class="s1">e</span><span class="s3">.</span><span class="s1">model </span><span class="s3">= </span><span class="s1">name</span>
                    <span class="s1">e</span><span class="s3">.</span><span class="s1">origin </span><span class="s3">= </span><span class="s1">e</span><span class="s3">.</span><span class="s1">origin</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">'reloaded model:'</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">e</span><span class="s3">.</span><span class="s1">model</span><span class="s3">)</span>


    <span class="s2">def </span><span class="s1">reload_shaders</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">import </span><span class="s1">ursina</span>

        <span class="s2">for </span><span class="s1">shader </span><span class="s2">in </span><span class="s1">ursina</span><span class="s3">.</span><span class="s1">shader</span><span class="s3">.</span><span class="s1">imported_shaders</span><span class="s3">.</span><span class="s1">values</span><span class="s3">():</span>
            <span class="s0"># print(shader, shader.path)</span>
            <span class="s0"># TODO: check if file has changed</span>

            <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">shader</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">'utf8'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">'trying to reload:'</span><span class="s3">, </span><span class="s1">shader</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>
                    <span class="s1">text </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>

                    <span class="s1">geom </span><span class="s3">= </span><span class="s4">''</span>
                    <span class="s2">if </span><span class="s4">r&quot;geometry='''&quot; </span><span class="s2">in </span><span class="s1">text</span><span class="s3">:</span>
                        <span class="s1">geom </span><span class="s3">= </span><span class="s1">text</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">r&quot;geometry='''&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)[</span><span class="s5">1</span><span class="s3">].</span><span class="s1">split</span><span class="s3">(</span><span class="s4">&quot;'''&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
                        <span class="s1">print</span><span class="s3">(</span><span class="s4">'geommmmmmmmmmmmmmm'</span><span class="s3">, </span><span class="s1">geom</span><span class="s3">)</span>

                    <span class="s1">vert </span><span class="s3">= </span><span class="s4">''</span>
                    <span class="s2">if </span><span class="s4">r&quot;verte ='''&quot; </span><span class="s2">in </span><span class="s1">text</span><span class="s3">:</span>
                        <span class="s1">vert </span><span class="s3">= </span><span class="s1">text</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">r&quot;vertex='''&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)[</span><span class="s5">1</span><span class="s3">].</span><span class="s1">split</span><span class="s3">(</span><span class="s4">&quot;'''&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>

                    <span class="s1">frag </span><span class="s3">= </span><span class="s1">text</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">r&quot;fragment='''&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)[</span><span class="s5">1</span><span class="s3">].</span><span class="s1">split</span><span class="s3">(</span><span class="s4">&quot;'''&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>

                    <span class="s2">if </span><span class="s1">geom</span><span class="s3">:</span>
                        <span class="s1">shader</span><span class="s3">.</span><span class="s1">geometry </span><span class="s3">= </span><span class="s1">geom</span>
                    <span class="s2">if </span><span class="s1">vert</span><span class="s3">:</span>
                        <span class="s1">shader</span><span class="s3">.</span><span class="s1">vertex </span><span class="s3">= </span><span class="s1">vert</span>
                    <span class="s1">shader</span><span class="s3">.</span><span class="s1">fragment </span><span class="s3">= </span><span class="s1">frag</span>

                    <span class="s1">shader</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">()</span>

                    <span class="s2">for </span><span class="s1">e </span><span class="s2">in </span><span class="s1">scene</span><span class="s3">.</span><span class="s1">entities</span><span class="s3">:</span>
                        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s4">'_shader'</span><span class="s3">) </span><span class="s2">and </span><span class="s1">e</span><span class="s3">.</span><span class="s1">shader </span><span class="s3">== </span><span class="s1">shader</span><span class="s3">:</span>
                            <span class="s1">e</span><span class="s3">.</span><span class="s1">clearShader</span><span class="s3">()</span>
                            <span class="s1">e</span><span class="s3">.</span><span class="s1">shader </span><span class="s3">= </span><span class="s1">e</span><span class="s3">.</span><span class="s1">shader</span>

                    <span class="s1">print</span><span class="s3">(</span><span class="s4">'reloaded shader:'</span><span class="s3">, </span><span class="s1">shader</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>
                <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">'failed to reload shader:'</span><span class="s3">, </span><span class="s1">shader</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s4">'error:'</span><span class="s3">, </span><span class="s1">e</span><span class="s3">)</span>
                    <span class="s2">pass</span>

<span class="s0"># class InGameTextEditor(Entity):</span>
<span class="s0">#     def __init__(self, path, **kwargs):</span>
<span class="s0">#         super().__init__(parent=camera.ui, z=-10)</span>
<span class="s0">#         self.file_path = path</span>
<span class="s0">#</span>
<span class="s0">#         self.add_script(Scrollable(min=0, max=10))</span>
<span class="s0">#         self.bg = Entity(parent=self, model='quad', scale_x=camera.aspect_ratio, color=color.color(0,0,0,.9), z=1, collider='box', origin_y=.5, y=.5, scale_y=10, eternal=True)</span>
<span class="s0">#         self.header = Text(parent=self, x=-.5, y=.475, text=self.file_path.name)</span>
<span class="s0">#         self.text_editor = TextField(parent=self, font_size=14, max_lines=50)</span>
<span class="s0">#         self.text_editor.text_entity.text_colors['default'] = color.color(219, .0, .95)</span>
<span class="s0">#         self.text_editor.text_entity.text_colors['class_color'] = color.color(40, .61, .9)</span>
<span class="s0">#         self.text_editor.text_entity.text_colors['kw_color'] = color.color(210, .59, .94)</span>
<span class="s0">#         self.text_editor.text_entity.text_colors['func_color'] = color.color(250, .46, .87)</span>
<span class="s0">#         self.text_editor.text_entity.text_colors['param_clor'] = color.color(30, .71, .92)</span>
<span class="s0">#         self.text_editor.text_entity.text_colors['string_color'] = color.color(90, .48, .86)</span>
<span class="s0">#</span>
<span class="s0">#</span>
<span class="s0">#         self.text_editor.replacements = {</span>
<span class="s0">#</span>
<span class="s0">#             'from ':    f'☾kw_color☽from ☾default☽',</span>
<span class="s0">#             'import ':  f'☾kw_color☽import ☾default☽',</span>
<span class="s0">#             'def ':     f'☾kw_color☽def ☾default☽',</span>
<span class="s0">#             'for ':     f'☾kw_color☽for ☾default☽',</span>
<span class="s0">#             'if ':      f'☾kw_color☽if ☾default☽',</span>
<span class="s0">#             ' in ':     f'☾kw_color☽ in ☾default☽',</span>
<span class="s0">#</span>
<span class="s0">#             'print(':   f'☾func_color☽print☾default☽(',</span>
<span class="s0">#             'range(':   f'☾func_color☽range☾default☽(',</span>
<span class="s0">#             '__init__': f'☾func_color☽__init__☾default☽',</span>
<span class="s0">#             'super':    f'☾func_color☽super☾default☽',</span>
<span class="s0">#</span>
<span class="s0">#             'class ':   f'☾class_color☽class ☾default☽',</span>
<span class="s0">#             'Entity':   f'☾lime☽Entity☾default☽',</span>
<span class="s0">#             'self.':    f'☾class_color☽self☾default☽.',</span>
<span class="s0">#             '(self)':   f'(☾class_color☽self☾default☽)',</span>
<span class="s0">#             'self,':    f'☾class_color☽self☾default☽,',</span>
<span class="s0">#</span>
<span class="s0">#             'highlight_color = ':    f'☾param_clor☽highlight_color☾default☽ = ',</span>
<span class="s0">#</span>
<span class="s0">#             '\',':    f'\',☾default☽',   # end quote</span>
<span class="s0">#             '\':':    f'\':☾default☽',   # end quote</span>
<span class="s0">#             '\')':    f'\')☾default☽',   # end quote</span>
<span class="s0">#             '\'':    f'☾string_color☽\'', # start quote</span>
<span class="s0">#             }</span>
<span class="s0">#</span>
<span class="s0">#         self.eternal = True</span>
<span class="s0">#         self.ignore_paused = True</span>
<span class="s0">#</span>
<span class="s0">#         with self.file_path.open() as f:</span>
<span class="s0">#             self.text_editor.text = f.read()</span>
<span class="s0">#             self.text_editor.render()</span>
<span class="s0">#</span>
<span class="s0">#</span>
<span class="s0">#         for key, value in kwargs.items():</span>
<span class="s0">#             setattr(self, key, value)</span>
<span class="s0">#</span>
<span class="s0">#</span>
<span class="s0">#     def on_enable(self):</span>
<span class="s0">#         application.pause()</span>
<span class="s0">#         self.ignore_input = False</span>
<span class="s0">#</span>
<span class="s0">#</span>
<span class="s0">#     def on_disable(self):</span>
<span class="s0">#         application.resume()</span>
<span class="s0">#         self.ignore_input = True</span>
<span class="s0">#</span>
<span class="s0">#</span>
<span class="s0">#     def input(self, key):</span>
<span class="s0">#         if held_keys['control'] and key == 'enter':</span>
<span class="s0">#             if self.reload_code():</span>
<span class="s0">#                 if held_keys['shift']:</span>
<span class="s0">#                     self.enabled = False</span>
<span class="s0">#</span>
<span class="s0">#</span>
<span class="s0">#     def reload(self):</span>
<span class="s0">#         cleaned_text = make_code_reload_safe(self.text_editor.text)</span>
<span class="s0">#</span>
<span class="s0">#         try:</span>
<span class="s0">#             scene.clear()</span>
<span class="s0">#             exec(cleaned_text)</span>
<span class="s0">#             print('...............')</span>
<span class="s0">#             print(cleaned_text)</span>
<span class="s0">#             print('...............')</span>
<span class="s0">#             return True</span>
<span class="s0">#         except Exception as e:</span>
<span class="s0">#             # exception = is_valid_python(cleaned_text)</span>
<span class="s0">#             if type(e) == SyntaxError:</span>
<span class="s0">#                 print('Error on line:', e)</span>
<span class="s0">#             else:</span>
<span class="s0">#                 import traceback</span>
<span class="s0">#                 error_message = traceback.format_exc()</span>
<span class="s0">#                 print(error_message)</span>
<span class="s0">#</span>
<span class="s0">#             return False</span>
<span class="s0">#</span>


<span class="s2">if </span><span class="s1">__name__ </span><span class="s3">== </span><span class="s4">'__main__'</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s1">ursina </span><span class="s2">import </span><span class="s3">*</span>
    <span class="s1">app </span><span class="s3">= </span><span class="s1">Ursina</span><span class="s3">()</span>
    <span class="s0"># hot_reloader = HotReloader()</span>
    <span class="s1">application</span><span class="s3">.</span><span class="s1">hot_reloader</span><span class="s3">.</span><span class="s1">path </span><span class="s3">= </span><span class="s1">application</span><span class="s3">.</span><span class="s1">asset_folder</span><span class="s3">.</span><span class="s1">parent</span><span class="s3">.</span><span class="s1">parent </span><span class="s3">/ </span><span class="s4">'samples' </span><span class="s3">/ </span><span class="s4">'platformer.py'</span>
    <span class="s0"># Sky()</span>

    <span class="s4">''' 
    By default you can press F5 to reload the starting script, F6 to reimport textures and F7 to reload models. 
    '''</span>
    <span class="s0"># window.size *= .5</span>
    <span class="s0"># window.position += Vec2(100,300)</span>
    <span class="s0"># bg = Sprite('shore')</span>
    <span class="s0">#</span>
    <span class="s0"># button = Button(text='test button', scale=.75, model=Circle(32), color=color.red)</span>

    <span class="s0"># test</span>
    <span class="s2">from </span><span class="s1">ursina</span><span class="s3">.</span><span class="s1">shaders </span><span class="s2">import </span><span class="s1">lit_with_shadows_shader</span>
    <span class="s2">from </span><span class="s1">ursina</span><span class="s3">.</span><span class="s1">prefabs</span><span class="s3">.</span><span class="s1">primitives </span><span class="s2">import </span><span class="s3">*</span>

    <span class="s1">shader </span><span class="s3">= </span><span class="s1">lit_with_shadows_shader</span>

    <span class="s1">a </span><span class="s3">= </span><span class="s1">AzureCube</span><span class="s3">(</span><span class="s1">shader</span><span class="s3">=</span><span class="s1">shader</span><span class="s3">, </span><span class="s1">texture</span><span class="s3">=</span><span class="s4">'shore'</span><span class="s3">)</span>
    <span class="s1">b </span><span class="s3">= </span><span class="s1">WhiteSphere</span><span class="s3">(</span><span class="s1">shader</span><span class="s3">=</span><span class="s1">shader</span><span class="s3">, </span><span class="s1">rotation_y</span><span class="s3">=</span><span class="s5">180</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s5">3</span><span class="s3">, </span><span class="s1">texture</span><span class="s3">=</span><span class="s4">'brick'</span><span class="s3">)</span>
    <span class="s1">b</span><span class="s3">.</span><span class="s1">texture</span><span class="s3">.</span><span class="s1">filtering </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s1">GrayPlane</span><span class="s3">(</span><span class="s1">scale</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=-</span><span class="s5">2</span><span class="s3">, </span><span class="s1">texture</span><span class="s3">=</span><span class="s4">'shore'</span><span class="s3">, </span><span class="s1">shader</span><span class="s3">=</span><span class="s1">shader</span><span class="s3">)</span>


    <span class="s0"># Enable shadows; we need to set a frustum for that.</span>
    <span class="s2">from </span><span class="s1">ursina</span><span class="s3">.</span><span class="s1">lights </span><span class="s2">import </span><span class="s1">DirectionalLight</span>
    <span class="s1">sun </span><span class="s3">= </span><span class="s1">DirectionalLight</span><span class="s3">(</span><span class="s1">y</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">rotation</span><span class="s3">=(</span><span class="s5">90</span><span class="s3">+</span><span class="s5">30</span><span class="s3">,</span><span class="s5">90</span><span class="s3">,</span><span class="s5">0</span><span class="s3">))</span>
    <span class="s1">sun</span><span class="s3">.</span><span class="s1">_light</span><span class="s3">.</span><span class="s1">show_frustum</span><span class="s3">()</span>


    <span class="s1">Sky</span><span class="s3">(</span><span class="s1">color</span><span class="s3">=</span><span class="s1">color</span><span class="s3">.</span><span class="s1">light_gray</span><span class="s3">)</span>
    <span class="s1">EditorCamera</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">update</span><span class="s3">():</span>
        <span class="s1">a</span><span class="s3">.</span><span class="s1">x </span><span class="s3">+= (</span><span class="s1">held_keys</span><span class="s3">[</span><span class="s4">'d'</span><span class="s3">] - </span><span class="s1">held_keys</span><span class="s3">[</span><span class="s4">'a'</span><span class="s3">]) * </span><span class="s1">time</span><span class="s3">.</span><span class="s1">dt </span><span class="s3">* </span><span class="s5">5</span>
        <span class="s1">a</span><span class="s3">.</span><span class="s1">y </span><span class="s3">+= (</span><span class="s1">held_keys</span><span class="s3">[</span><span class="s4">'e'</span><span class="s3">] - </span><span class="s1">held_keys</span><span class="s3">[</span><span class="s4">'q'</span><span class="s3">]) * </span><span class="s1">time</span><span class="s3">.</span><span class="s1">dt </span><span class="s3">* </span><span class="s5">5</span>
        <span class="s1">a</span><span class="s3">.</span><span class="s1">z </span><span class="s3">+= (</span><span class="s1">held_keys</span><span class="s3">[</span><span class="s4">'w'</span><span class="s3">] - </span><span class="s1">held_keys</span><span class="s3">[</span><span class="s4">'s'</span><span class="s3">]) * </span><span class="s1">time</span><span class="s3">.</span><span class="s1">dt </span><span class="s3">* </span><span class="s5">5</span>


    <span class="s1">app</span><span class="s3">.</span><span class="s1">run</span><span class="s3">()</span>
</pre>
</body>
</html>