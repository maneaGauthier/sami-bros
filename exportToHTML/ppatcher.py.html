<html>
<head>
<title>ppatcher.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ppatcher.py</font>
</center></td></tr></table>
<pre><span class="s0">#! /usr/bin/env python</span>

<span class="s1">usageText </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
 
This script generates the patches required to support incremental 
download of Panda3D packages.  It can be run as a post-process on a 
directory hierarchy created by ppackage; it will examine the directory 
hierarchy, and create any patches that appear to be missing. 
 
You may run ppackage on the same directory hierarchy as many times as 
you like, without creating patches.  You may then download and test 
the resulting files--users connecting to the tree without fresh 
patches will be forced to download the entire file, instead of making 
an incremental download, but the entire process will work otherwise. 
When you are satisfied that all of the files are ready to be released, 
you may run ppackage on the directory hierarchy to generate the 
required patches. 
 
Generating the patches just before final release is a good idea to 
limit the number of trivially small patches that are created.  Each 
time this script is run, a patch is created from the previous version, 
and these patches daisy-chain together to define a complete update 
sequence.  If you run this script on internal releases, you will 
generate a long chain of small patches that your users must download; 
this is pointless if there is no possibility of anyone having 
downloaded one of the intervening versions. 
 
You can also generate patches with the -p option to ppackage, but that 
only generates patches for the specific packages built by that 
invocation of ppackage.  If you use the ppatcher script instead, it 
will generate patches for all packages (or the set of packages that 
you name specifically). 
 
This script is actually a wrapper around Panda's PatchMaker.py. 
 
Usage: 
 
  %(prog)s [opts] [packageName1 .. packageNameN] 
 
Parameters: 
 
  packageName1 .. packageNameN 
    Specify the names of the package(s) you wish to generate patches 
    for.  This allows you to build patches for only a subset of the 
    packages found in the tree.  If you omit these parameters, patches 
    are built for all packages that require them. 
 
Options: 
 
  -i install_dir 
     The full path to the install directory.  This should be the same 
     directory named by the -i parameter to ppackage. 
 
  -h 
     Display this help 
 
&quot;&quot;&quot;</span>

<span class="s4">import </span><span class="s1">sys</span>
<span class="s4">import </span><span class="s1">getopt</span>
<span class="s4">import </span><span class="s1">os</span>

<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">p3d</span><span class="s2">.</span><span class="s1">PatchMaker </span><span class="s4">import </span><span class="s1">PatchMaker</span>
<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s1">Filename</span>

<span class="s4">def </span><span class="s1">usage</span><span class="s2">(</span><span class="s1">code</span><span class="s2">, </span><span class="s1">msg </span><span class="s2">= </span><span class="s3">''</span><span class="s2">):</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">stderr</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">usageText </span><span class="s2">% {</span><span class="s3">'prog' </span><span class="s2">: </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])[</span><span class="s5">1</span><span class="s2">]})</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">stderr</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">msg </span><span class="s2">+ </span><span class="s3">'</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s1">code</span><span class="s2">)</span>

<span class="s4">try</span><span class="s2">:</span>
    <span class="s1">opts</span><span class="s2">, </span><span class="s1">args </span><span class="s2">= </span><span class="s1">getopt</span><span class="s2">.</span><span class="s1">getopt</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s3">'i:h'</span><span class="s2">)</span>
<span class="s4">except </span><span class="s1">getopt</span><span class="s2">.</span><span class="s1">error </span><span class="s4">as </span><span class="s1">msg</span><span class="s2">:</span>
    <span class="s1">usage</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>

<span class="s1">installDir </span><span class="s2">= </span><span class="s4">None</span>
<span class="s4">for </span><span class="s1">opt</span><span class="s2">, </span><span class="s1">arg </span><span class="s4">in </span><span class="s1">opts</span><span class="s2">:</span>
    <span class="s4">if </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-i'</span><span class="s2">:</span>
        <span class="s1">installDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">)</span>

    <span class="s4">elif </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-h'</span><span class="s2">:</span>
        <span class="s1">usage</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s4">else</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">'illegal option: ' </span><span class="s2">+ </span><span class="s1">arg</span><span class="s2">)</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>

<span class="s1">packageNames </span><span class="s2">= </span><span class="s1">args</span>

<span class="s4">if not </span><span class="s1">installDir</span><span class="s2">:</span>
    <span class="s1">installDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">(</span><span class="s3">'install'</span><span class="s2">)</span>

<span class="s4">if not </span><span class="s1">packageNames</span><span class="s2">:</span>
    <span class="s0"># &quot;None&quot; means all packages.</span>
    <span class="s1">packageNames </span><span class="s2">= </span><span class="s4">None</span>

<span class="s1">pm </span><span class="s2">= </span><span class="s1">PatchMaker</span><span class="s2">(</span><span class="s1">installDir</span><span class="s2">)</span>
<span class="s1">pm</span><span class="s2">.</span><span class="s1">buildPatches</span><span class="s2">(</span><span class="s1">packageNames </span><span class="s2">= </span><span class="s1">packageNames</span><span class="s2">)</span>

<span class="s0"># An explicit call to exit() is required to exit the program, when</span>
<span class="s0"># this module is packaged in a p3d file.</span>
<span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
</pre>
</body>
</html>