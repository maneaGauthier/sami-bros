<html>
<head>
<title>pmerge.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
pmerge.py</font>
</center></td></tr></table>
<pre><span class="s0">#! /usr/bin/env python</span>

<span class="s1">usageText </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
 
This script can be used to merge together the contents of two or more 
separately-built stage directories, built independently via ppackage, 
or via Packager.py.  This script also verifies the hash, file size, 
and timestamp values in the stage directory as it runs, so it can be 
run on a single standalone directory just to perform this validation. 
 
This script is actually a wrapper around Panda's PackageMerger.py. 
 
Usage: 
 
  %(prog)s [opts] [inputdir1 .. inputdirN] 
 
Parameters: 
 
  inputdir1 .. inputdirN 
    Specify the full path to the input directories you wish to merge. 
    These are the directories specified by -i on the previous 
    invocations of ppackage.  The order is mostly unimportant. 
 
Options: 
 
  -i install_dir 
     The full path to the final install directory.  This may also 
     contain some pre-existing contents; if so, it is merged with all 
     of the input directories as well.  The contents of this directory 
     are checked for self-consistency with regards to hashes and 
     timestamps. 
 
  -p packageName[,packageName...] 
     Specifies one or more particular packages by name that are to be 
     included from the input directories.  Any packages not in this 
     list are left unchanged in the install directory, even if there 
     is a newer version in one of the input directories.  If no 
     packages are named, all packages are involved.  This option may 
     be repeated. 
 
  -h 
     Display this help 
 
&quot;&quot;&quot;</span>

<span class="s4">import </span><span class="s1">sys</span>
<span class="s4">import </span><span class="s1">getopt</span>
<span class="s4">import </span><span class="s1">os</span>

<span class="s4">from </span><span class="s1">direct</span><span class="s2">.</span><span class="s1">p3d </span><span class="s4">import </span><span class="s1">PackageMerger</span>
<span class="s4">from </span><span class="s1">panda3d</span><span class="s2">.</span><span class="s1">core </span><span class="s4">import </span><span class="s1">Filename</span>

<span class="s4">def </span><span class="s1">usage</span><span class="s2">(</span><span class="s1">code</span><span class="s2">, </span><span class="s1">msg </span><span class="s2">= </span><span class="s3">''</span><span class="s2">):</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">stderr</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">usageText </span><span class="s2">% {</span><span class="s3">'prog' </span><span class="s2">: </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])[</span><span class="s5">1</span><span class="s2">]})</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">stderr</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">msg </span><span class="s2">+ </span><span class="s3">'</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">)</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s1">code</span><span class="s2">)</span>

<span class="s4">try</span><span class="s2">:</span>
    <span class="s1">opts</span><span class="s2">, </span><span class="s1">args </span><span class="s2">= </span><span class="s1">getopt</span><span class="s2">.</span><span class="s1">getopt</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s3">'i:p:h'</span><span class="s2">)</span>
<span class="s4">except </span><span class="s1">getopt</span><span class="s2">.</span><span class="s1">error </span><span class="s4">as </span><span class="s1">msg</span><span class="s2">:</span>
    <span class="s1">usage</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>

<span class="s1">installDir </span><span class="s2">= </span><span class="s4">None</span>
<span class="s1">packageNames </span><span class="s2">= []</span>
<span class="s4">for </span><span class="s1">opt</span><span class="s2">, </span><span class="s1">arg </span><span class="s4">in </span><span class="s1">opts</span><span class="s2">:</span>
    <span class="s4">if </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-i'</span><span class="s2">:</span>
        <span class="s1">installDir </span><span class="s2">= </span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-p'</span><span class="s2">:</span>
        <span class="s1">packageNames </span><span class="s2">+= </span><span class="s1">arg</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">','</span><span class="s2">)</span>

    <span class="s4">elif </span><span class="s1">opt </span><span class="s2">== </span><span class="s3">'-h'</span><span class="s2">:</span>
        <span class="s1">usage</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s4">else</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">'illegal option: ' </span><span class="s2">+ </span><span class="s1">arg</span><span class="s2">)</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>

<span class="s4">if not </span><span class="s1">packageNames</span><span class="s2">:</span>
    <span class="s0"># No package names means allow all packages.</span>
    <span class="s1">packageNames </span><span class="s2">= </span><span class="s4">None</span>

<span class="s1">inputDirs </span><span class="s2">= []</span>
<span class="s4">for </span><span class="s1">arg </span><span class="s4">in </span><span class="s1">args</span><span class="s2">:</span>
    <span class="s1">inputDirs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">Filename</span><span class="s2">.</span><span class="s1">fromOsSpecific</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">))</span>

<span class="s0"># It's now legal to have no input files if you only want to verify</span>
<span class="s0"># timestamps and hashes.</span>
<span class="s0">## if not inputDirs:</span>
<span class="s0">##     print &quot;no input directories specified.&quot;</span>
<span class="s0">##     sys.exit(1)</span>

<span class="s4">try</span><span class="s2">:</span>
    <span class="s1">pm </span><span class="s2">= </span><span class="s1">PackageMerger</span><span class="s2">.</span><span class="s1">PackageMerger</span><span class="s2">(</span><span class="s1">installDir</span><span class="s2">)</span>
    <span class="s4">for </span><span class="s1">dir </span><span class="s4">in </span><span class="s1">inputDirs</span><span class="s2">:</span>
        <span class="s1">pm</span><span class="s2">.</span><span class="s1">merge</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s1">packageNames </span><span class="s2">= </span><span class="s1">packageNames</span><span class="s2">)</span>
    <span class="s1">pm</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

<span class="s4">except </span><span class="s1">PackageMerger</span><span class="s2">.</span><span class="s1">PackageMergerError</span><span class="s2">:</span>
    <span class="s0"># Just print the error message and exit gracefully.</span>
    <span class="s1">inst </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">exc_info</span><span class="s2">()[</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>


<span class="s0"># An explicit call to exit() is required to exit the program, when</span>
<span class="s0"># this module is packaged in a p3d file.</span>
<span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
</pre>
</body>
</html>